{% extends "base.html" %}
{% block content %}

<div class="bg-white border border-slate-200 rounded-2xl p-5">

  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <div>
      <h1 class="text-xl font-semibold text-slate-800">1.3 Quản lý thông báo</h1>
      <p class="text-sm text-slate-500 mt-1">
        Danh sách thông báo hiển thị ở trang khách hàng (Service C). Mỗi mục click sẽ mở tab mới.
      </p>
    </div>

    <div class="flex items-center gap-2">
      <button id="btnNew"
              class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">
        <i class="ri-add-line mr-1"></i> Thêm thông báo
      </button>
    </div>
  </div>

  <!-- Filters -->
  <div class="mt-4 grid grid-cols-1 md:grid-cols-12 gap-3">
    <div class="md:col-span-6">
      <div class="flex items-center gap-2">
        <div class="relative flex-1">
          <i class="ri-search-line absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
          <input id="q"
                 type="text"
                 class="w-full pl-9 pr-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                 placeholder="Tìm theo tiêu đề / mô tả..."
                 value="{{ init_q or '' }}">
        </div>
        <button id="btnSearch"
                class="px-4 py-2 rounded-xl border border-slate-200 hover:bg-slate-50">
          Tìm
        </button>
      </div>
    </div>

    <div class="md:col-span-3">
      <select id="status"
              class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-200">
        {% set st = (init_status or "ALL")|upper %}
        <option value="ALL" {% if st == "ALL" %}selected{% endif %}>Tất cả trạng thái</option>
        <option value="PUBLISHED" {% if st == "PUBLISHED" %}selected{% endif %}>Đang hiển thị</option>
        <option value="DRAFT" {% if st == "DRAFT" %}selected{% endif %}>Nháp</option>
        <option value="ARCHIVED" {% if st == "ARCHIVED" %}selected{% endif %}>Đã ẩn</option>
      </select>
    </div>

    <div class="md:col-span-3 flex items-center justify-between gap-2">
      <div class="text-sm text-slate-500">
        <span id="totalText">—</span>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnPrev"
                class="px-3 py-2 rounded-xl border border-slate-200 hover:bg-slate-50">
          <i class="ri-arrow-left-s-line"></i>
        </button>
        <div class="text-sm text-slate-600">
          Trang <span id="pageText">1</span>
        </div>
        <button id="btnNext"
                class="px-3 py-2 rounded-xl border border-slate-200 hover:bg-slate-50">
          <i class="ri-arrow-right-s-line"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="mt-4 overflow-x-auto border border-slate-200 rounded-2xl">
    <table class="min-w-full text-sm">
      <thead class="bg-slate-50 text-slate-600">
        <tr>
          <th class="text-left px-4 py-3 w-[44%]">Tiêu đề</th>
          <th class="text-left px-4 py-3 w-[18%]">Ngày</th>
          <th class="text-left px-4 py-3 w-[14%]">Trạng thái</th>
          <th class="text-left px-4 py-3 w-[10%]">Ghim</th>
          <th class="text-right px-4 py-3 w-[14%]">Thao tác</th>
        </tr>
      </thead>
      <tbody id="tbody" class="divide-y divide-slate-100">
        <tr>
          <td colspan="5" class="px-4 py-6 text-center text-slate-400">
            Đang tải dữ liệu…
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ===== Modal: Create/Update ===== -->
<div id="modal" class="hidden fixed inset-0 z-[90]">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl">
      <div class="px-6 py-4 border-b border-slate-100 flex items-center justify-between">
        <h3 id="modalTitle" class="text-lg font-semibold text-slate-800">Thêm thông báo</h3>
        <button id="btnCloseModal" class="text-slate-500 hover:text-slate-700">
          <i class="ri-close-line text-2xl"></i>
        </button>
      </div>

      <div class="px-6 py-5">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-3">

          <div class="md:col-span-12">
            <label class="text-sm text-slate-600">Tiêu đề</label>
            <input id="f_title" type="text"
                   class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                   placeholder="Thông báo đấu giá: ...">
          </div>

          <div class="md:col-span-12">
            <label class="text-sm text-slate-600">Mô tả ngắn</label>
            <textarea id="f_summary" rows="3"
                      class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                      placeholder="Tóm tắt 1–2 dòng (tuỳ chọn)"></textarea>
          </div>

          <div class="md:col-span-6">
            <label class="text-sm text-slate-600">Ngày hiển thị</label>
            <input id="f_publish_date" type="date"
                   class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-200">
          </div>

          <div class="md:col-span-6">
            <label class="text-sm text-slate-600">Trạng thái</label>
            <select id="f_status"
                    class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-200">
              <option value="PUBLISHED">Đang hiển thị</option>
              <option value="DRAFT">Nháp</option>
              <option value="ARCHIVED">Ẩn</option>
            </select>
          </div>

          <div class="md:col-span-12">
            <label class="text-sm text-slate-600">Link (mở tab mới)</label>
            <input id="f_link_url" type="url"
                   class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                   placeholder="https://...">
            <div class="text-xs text-slate-500 mt-1">
              Khi khách hàng click “Xem chi tiết” sẽ mở link này ở tab mới.
            </div>
          </div>

          <div class="md:col-span-6">
            <label class="text-sm text-slate-600">Phân loại</label>
            <input id="f_category" type="text"
                   class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                   placeholder="Đấu giá quyền sử dụng đất (tuỳ chọn)">
          </div>

          <div class="md:col-span-3">
            <label class="text-sm text-slate-600">Ưu tiên</label>
            <input id="f_sort_order" type="number"
                   class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                   value="0">
            <div class="text-xs text-slate-500 mt-1">Số nhỏ lên trước</div>
          </div>

          <div class="md:col-span-3 flex items-end">
            <label class="inline-flex items-center gap-2 mt-2 select-none">
              <input id="f_pinned" type="checkbox" class="rounded border-slate-300">
              <span class="text-sm text-slate-700">Ghim</span>
            </label>
          </div>
        </div>

        <div id="errBox" class="hidden mt-4 p-3 rounded-xl bg-rose-50 text-rose-700 text-sm border border-rose-100"></div>
      </div>

      <div class="px-6 py-4 border-t border-slate-100 flex justify-end gap-3">
        <button id="btnCancel"
                class="px-4 py-2 rounded-xl border border-slate-200 hover:bg-slate-50">
          Huỷ
        </button>
        <button id="btnSave"
                class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">
          Lưu
        </button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // ---- state ----
  let page = parseInt("{{ init_page or 1 }}", 10) || 1;
  let size = parseInt("{{ init_size or 20 }}", 10) || 20;
  if (size > 20) size = 20;

  let total = 0;
  let rows = [];
  let editingId = null;

  // ---- els ----
  const tbody = document.getElementById("tbody");
  const qEl = document.getElementById("q");
  const statusEl = document.getElementById("status");
  const totalText = document.getElementById("totalText");
  const pageText = document.getElementById("pageText");
  const btnPrev = document.getElementById("btnPrev");
  const btnNext = document.getElementById("btnNext");
  const btnSearch = document.getElementById("btnSearch");
  const btnNew = document.getElementById("btnNew");

  // modal els
  const modal = document.getElementById("modal");
  const modalTitle = document.getElementById("modalTitle");
  const btnCloseModal = document.getElementById("btnCloseModal");
  const btnCancel = document.getElementById("btnCancel");
  const btnSave = document.getElementById("btnSave");
  const errBox = document.getElementById("errBox");

  const f_title = document.getElementById("f_title");
  const f_summary = document.getElementById("f_summary");
  const f_publish_date = document.getElementById("f_publish_date");
  const f_status = document.getElementById("f_status");
  const f_link_url = document.getElementById("f_link_url");
  const f_category = document.getElementById("f_category");
  const f_sort_order = document.getElementById("f_sort_order");
  const f_pinned = document.getElementById("f_pinned");

  function escHtml(s){
    return (s || "").replace(/[&<>"']/g, function(c){
      return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]);
    });
  }

  function badge(status){
    const st = (status || "").toUpperCase();
    if (st === "PUBLISHED") return '<span class="px-2 py-1 text-xs rounded-lg bg-emerald-50 text-emerald-700 border border-emerald-100">Hiển thị</span>';
    if (st === "DRAFT") return '<span class="px-2 py-1 text-xs rounded-lg bg-slate-50 text-slate-700 border border-slate-100">Nháp</span>';
    if (st === "ARCHIVED") return '<span class="px-2 py-1 text-xs rounded-lg bg-amber-50 text-amber-700 border border-amber-100">Ẩn</span>';
    return '<span class="px-2 py-1 text-xs rounded-lg bg-slate-50 text-slate-700 border border-slate-100">'+escHtml(st||'—')+'</span>';
  }

  function setError(msg){
    if (!msg) { errBox.classList.add("hidden"); errBox.textContent = ""; return; }
    errBox.textContent = msg;
    errBox.classList.remove("hidden");
  }

  function openModalCreate(){
    editingId = null;
    modalTitle.textContent = "Thêm thông báo";
    f_title.value = "";
    f_summary.value = "";
    f_publish_date.value = "";
    f_status.value = "PUBLISHED";
    f_link_url.value = "";
    f_category.value = "";
    f_sort_order.value = "0";
    f_pinned.checked = false;
    setError("");
    modal.classList.remove("hidden");
  }

  function openModalEdit(item){
    editingId = item.id;
    modalTitle.textContent = "Sửa thông báo";
    f_title.value = item.title || "";
    f_summary.value = item.summary || "";
    f_publish_date.value = item.publish_date || "";
    f_status.value = (item.status || "PUBLISHED").toUpperCase();
    f_link_url.value = item.link_url || "";
    f_category.value = item.category || "";
    f_sort_order.value = (item.sort_order != null ? String(item.sort_order) : "0");
    f_pinned.checked = !!item.pinned;
    setError("");
    modal.classList.remove("hidden");
  }

  function closeModal(){
    modal.classList.add("hidden");
  }

  async function load(){
    const q = (qEl.value || "").trim();
    const st = (statusEl.value || "ALL").trim();

    const url = new URL(window.location.origin + "/announcements/data");
    url.searchParams.set("page", String(page));
    url.searchParams.set("size", String(size));
    if (q) url.searchParams.set("q", q);
    if (st) url.searchParams.set("status", st);

    tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-slate-400">Đang tải dữ liệu…</td></tr>';

    const res = await fetch(url.toString(), { headers: {"Accept":"application/json"} });
    if (res.status === 401) {
      window.location.href = "/login?next=%2Fannouncements";
      return;
    }
    const data = await res.json();
    rows = data.data || [];
    total = data.total || 0;

    pageText.textContent = String(page);
    totalText.textContent = `Tổng: ${total}`;

    render();
    updatePager();
  }

  function updatePager(){
    const maxPage = Math.max(1, Math.ceil((total || 0) / size));
    btnPrev.disabled = page <= 1;
    btnNext.disabled = page >= maxPage;
    btnPrev.classList.toggle("opacity-50", btnPrev.disabled);
    btnNext.classList.toggle("opacity-50", btnNext.disabled);
  }

  function render(){
    if (!rows.length){
      tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-slate-400">Chưa có thông báo nào.</td></tr>';
      return;
    }

    tbody.innerHTML = rows.map(function(it){
      const title = escHtml(it.title || "");
      const summary = escHtml(it.summary || "");
      const link = it.link_url || "";
      const date = escHtml(it.publish_date || it.created_at || "—");
      const pin = it.pinned ? '<span class="text-indigo-600 font-semibold">Có</span>' : '<span class="text-slate-400">—</span>';

      const linkHtml = link
        ? `<a class="text-indigo-600 hover:underline break-all" href="${escHtml(link)}" target="_blank" rel="noopener noreferrer">Mở</a>`
        : `<span class="text-slate-400">—</span>`;

      return `
        <tr class="hover:bg-slate-50">
          <td class="px-4 py-3 align-top">
            <div class="font-medium text-slate-800">${title}</div>
            ${summary ? `<div class="text-slate-500 text-xs mt-1 line-clamp-2">${summary}</div>` : ``}
            <div class="text-xs mt-1">${linkHtml}</div>
          </td>
          <td class="px-4 py-3 align-top text-slate-700">${date}</td>
          <td class="px-4 py-3 align-top">${badge(it.status)}</td>
          <td class="px-4 py-3 align-top">${pin}</td>
          <td class="px-4 py-3 align-top text-right">
            <button class="px-3 py-2 rounded-xl border border-slate-200 hover:bg-white"
                    data-act="edit" data-id="${it.id}">
              <i class="ri-edit-2-line"></i>
            </button>
            <button class="ml-2 px-3 py-2 rounded-xl border border-rose-200 text-rose-600 hover:bg-rose-50"
                    data-act="del" data-id="${it.id}">
              <i class="ri-delete-bin-6-line"></i>
            </button>
          </td>
        </tr>
      `;
    }).join("");

    tbody.querySelectorAll("[data-act]").forEach(function(btn){
      btn.addEventListener("click", async function(){
        const act = btn.getAttribute("data-act");
        const id = parseInt(btn.getAttribute("data-id") || "0", 10);
        const item = rows.find(x => x.id === id);
        if (!item) return;

        if (act === "edit"){
          openModalEdit(item);
          return;
        }
        if (act === "del"){
          const ok = await window.confirmModal({
            title: "Xác nhận xoá",
            message: "Bạn có chắc chắn muốn xoá (ẩn) thông báo này?"
          });
          if (!ok) return;
          await doDelete(id);
        }
      });
    });
  }

  async function doDelete(id){
    const res = await fetch(`/announcements/${id}/delete`, {
      method: "POST",
      headers: {"Accept":"application/json"}
    });
    if (res.status === 401){
      window.location.href = "/login?next=%2Fannouncements";
      return;
    }
    if (!res.ok){
      let msg = "Xoá thất bại.";
      try { msg = (await res.json()).detail || msg; } catch(e){}
      alert(msg);
      return;
    }
    await load();
  }

  async function doSave(){
    const payload = {
      title: (f_title.value || "").trim(),
      summary: (f_summary.value || "").trim() || null,
      publish_date: (f_publish_date.value || "").trim() || null,
      status: (f_status.value || "PUBLISHED").trim().toUpperCase(),
      link_url: (f_link_url.value || "").trim() || null,
      category: (f_category.value || "").trim() || null,
      sort_order: parseInt(f_sort_order.value || "0", 10) || 0,
      pinned: !!f_pinned.checked,
    };

    if (!payload.title){
      setError("Vui lòng nhập tiêu đề.");
      return;
    }
    if (payload.link_url && !/^https?:\/\//i.test(payload.link_url)){
      setError("Link phải bắt đầu bằng http:// hoặc https://");
      return;
    }

    const url = editingId ? `/announcements/${editingId}/update` : `/announcements/create`;

    const res = await fetch(url, {
      method: "POST",
      headers: {"Content-Type":"application/json", "Accept":"application/json"},
      body: JSON.stringify(payload)
    });

    if (res.status === 401){
      window.location.href = "/login?next=%2Fannouncements";
      return;
    }

    if (!res.ok){
      let msg = "Lưu thất bại.";
      try {
        const body = await res.json();
        msg = body.detail || body.message || msg;
      } catch(e) {}
      setError(msg);
      return;
    }

    closeModal();
    await load();
  }

  // ---- events ----
  btnNew.addEventListener("click", openModalCreate);
  btnCloseModal.addEventListener("click", closeModal);
  btnCancel.addEventListener("click", closeModal);
  modal.addEventListener("click", function(e){
    if (e.target === modal) closeModal();
  });

  btnSearch.addEventListener("click", function(){
    page = 1;
    load();
  });

  qEl.addEventListener("keydown", function(e){
    if (e.key === "Enter"){
      e.preventDefault();
      page = 1;
      load();
    }
  });

  statusEl.addEventListener("change", function(){
    page = 1;
    load();
  });

  btnPrev.addEventListener("click", function(){
    if (page > 1) { page -= 1; load(); }
  });
  btnNext.addEventListener("click", function(){
    page += 1;
    load();
  });

  btnSave.addEventListener("click", doSave);

  // init
  load();
})();
</script>

{% endblock %}
