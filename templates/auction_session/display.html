{# templates/pages/auction_session/display.html #}
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{{ title or "Tr√¨nh chi·∫øu ki·ªÉm phi·∫øu (Realtime)" }}</title>

  <!-- Technical font -->
  <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0A1022;

      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.09);

      --bd: rgba(148,163,184,.18);
      --bd2: rgba(148,163,184,.28);

      --txt: rgba(226,232,240,1);
      --muted: rgba(148,163,184,1);
      --muted2: rgba(148,163,184,.75);

      --pri:#22d3ee;
      --pri2:#60a5fa;

      --ok:#34d399;    /* TR√öNG */
      --warn:#fbbf24;  /* V√íNG SAU */
      --bad:#fb7185;   /* KH√îNG H·ª¢P L·ªÜ / CH∆ØA C√ì */

      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --glow: 0 0 22px rgba(34,211,238,.25);
      --glow2: 0 0 34px rgba(96,165,250,.18);

      --radius: 18px;
      --font: "Oxanium", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;

      /* 16:9 safe sizing */
      --pad: 16px;
      --gap: 14px;

      /* speed */
      --scan-speed: 7s;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--font);
      color: var(--txt);
      background:
        radial-gradient(1200px 520px at 50% 0%, rgba(96,165,250,.22), transparent 60%),
        radial-gradient(900px 420px at 0% 40%, rgba(34,211,238,.18), transparent 60%),
        radial-gradient(900px 420px at 100% 40%, rgba(52,211,153,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      letter-spacing: .03em;
      overflow:hidden;
    }

    /* subtle grid */
    .gridbg::before{
      content:"";
      position:absolute; inset:0;
      background-image:
        linear-gradient(to right, rgba(148,163,184,.06) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(148,163,184,.05) 1px, transparent 1px);
      background-size: 48px 48px;
      mask-image: radial-gradient(circle at 50% 30%, rgba(0,0,0,1), rgba(0,0,0,0) 70%);
      pointer-events:none;
      opacity:.55;
    }

    /* scan line */
    .scan::after{
      content:"";
      position:absolute; inset:-30% 0 auto 0;
      height: 140px;
      background: linear-gradient(180deg, transparent, rgba(34,211,238,.12), transparent);
      filter: blur(0.2px);
      animation: scan var(--scan-speed) linear infinite;
      pointer-events:none;
      opacity:.7;
    }
    @keyframes scan{
      0%{ transform: translateY(-160px); }
      100%{ transform: translateY(calc(100vh + 260px)); }
    }

    /* 16:9 stage */
    .stage{
      position:relative;
      width:100vw;
      height:100vh;
      padding: var(--pad);
      display:flex;
      flex-direction:column;
      gap: var(--gap);
    }

    /* top bar: 3 columns to avoid overlap */
    .topbar{
      display:grid;
      grid-template-columns: minmax(320px, 1fr) minmax(360px, 1.15fr) minmax(420px, 1.15fr);
      align-items:center;
      gap: 12px;
      padding: 10px 12px;
      border: 1px solid var(--bd);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .top-left{
      min-width: 0;
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    .brand-row{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
      flex-wrap:wrap;
    }
    .brand-row .pill{
      padding: 6px 10px;
      border:1px solid var(--bd2);
      border-radius: 999px;
      background: rgba(34,211,238,.10);
      box-shadow: var(--glow);
      font-weight:800;
      letter-spacing:.06em;
      color: rgba(226,232,240,1);
      white-space:nowrap;
      max-width: 100%;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pill.soft{
      background: rgba(255,255,255,.04);
      box-shadow:none;
    }
    .pill.blue{ background: rgba(96,165,250,.10); }
    .brand-title{
      font-weight:900;
      letter-spacing:.12em;
      font-size: 11px;
      text-transform:uppercase;
      color: var(--muted2);
    }

    .top-mid{
      min-width:0;
      text-align:center;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .top-mid .wrap{
      min-width:0;
      max-width: 100%;
    }
    .project-name{
      font-weight:900;
      font-size: 18px;
      letter-spacing:.08em;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .subline{
      font-weight:800;
      font-size: 12px;
      color: var(--muted);
      margin-top: 3px;
      letter-spacing:.08em;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .top-right{
      min-width:0;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:flex-end;
      overflow:hidden;
    }

    .kpis{
      display:flex;
      gap:10px;
      align-items:stretch;
      justify-content:flex-end;
      min-width:0;
      flex: 1;
      overflow:hidden;
    }
    .kpi{
      min-width: 104px;
      padding: 8px 10px;
      border:1px solid var(--bd);
      border-radius: 14px;
      background: rgba(255,255,255,.05);
      display:flex;
      flex-direction:column;
      gap: 3px;
      box-shadow: var(--shadow);
      flex: 0 0 auto;
    }
    .kpi .label{
      font-size:11px;
      color: var(--muted2);
      font-weight:800;
      letter-spacing:.10em;
      text-transform:uppercase;
      white-space:nowrap;
    }
    .kpi .val{
      font-size:18px;
      font-weight:900;
      letter-spacing:.04em;
    }
    .kpi.ok .val{ color: var(--ok); text-shadow: 0 0 16px rgba(52,211,153,.22); }
    .kpi.pri .val{ color: var(--pri); text-shadow: 0 0 16px rgba(34,211,238,.25); }
    .kpi.warn .val{ color: var(--warn); text-shadow: 0 0 16px rgba(251,191,36,.20); }
    .kpi.bad .val{ color: var(--bad); text-shadow: 0 0 16px rgba(251,113,133,.18); }

    .btn{
      border:1px solid rgba(148,163,184,.22);
      background: rgba(0,0,0,.20);
      color: rgba(226,232,240,.95);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight:900;
      letter-spacing:.10em;
      text-transform:uppercase;
      cursor:pointer;
      display:inline-flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
      box-shadow: var(--shadow);
      user-select:none;
    }
    .btn:hover{ border-color: rgba(34,211,238,.35); box-shadow: var(--shadow), var(--glow); }
    .btn:active{ transform: translateY(1px); }
    .btn .ico{ width:10px;height:10px;border-radius:999px;background:var(--pri); box-shadow:0 0 16px rgba(34,211,238,.45); }
    .btn.ok .ico{ background: var(--ok); box-shadow:0 0 16px rgba(52,211,153,.45); }

    /* main 3 columns */
    .main{
      flex:1;
      display:grid;
      grid-template-columns: 1.05fr 1.9fr 1.15fr;
      gap: var(--gap);
      min-height: 0;
    }

    .panel{
      border: 1px solid var(--bd);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      min-height:0;
      overflow:hidden;
      position:relative;
    }
    .panel .head{
      padding: 12px 12px 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid rgba(148,163,184,.15);
      background: rgba(0,0,0,.10);
    }
    .h-title{
      font-weight:900;
      letter-spacing:.12em;
      font-size: 12px;
      text-transform:uppercase;
      color: rgba(226,232,240,.92);
      display:flex;
      align-items:center;
      gap: 8px;
      white-space:nowrap;
    }
    .h-badge{
      font-weight:900;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--bd2);
      background: rgba(96,165,250,.12);
      color: rgba(226,232,240,.95);
      letter-spacing:.10em;
      white-space:nowrap;
    }

    /* LEFT: customer lists */
    .left-body{
      padding: 10px 10px 12px 10px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      height: 100%;
      min-height:0;
    }
    .box{
      border: 1px solid rgba(148,163,184,.16);
      border-radius: 16px;
      background: rgba(0,0,0,.12);
      overflow:hidden;
      min-height:0;
      display:flex;
      flex-direction:column;
      flex: 1;
    }
    .box.won{ border-color: rgba(52,211,153,.22); }
    .box.next{ border-color: rgba(251,191,36,.22); }

    .box .box-head{
      padding: 10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid rgba(148,163,184,.14);
      background: rgba(0,0,0,.10);
      flex: 0 0 auto;
    }
    .box .box-head .t{
      font-weight:900;
      letter-spacing:.10em;
      text-transform:uppercase;
      font-size: 12px;
      display:flex;
      align-items:center;
      gap: 8px;
      white-space:nowrap;
    }
    .tag{
      font-size: 11px;
      font-weight:900;
      padding: 3px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      white-space:nowrap;
    }
    .tag.ok{ color: rgba(226,232,240,.95); border-color: rgba(52,211,153,.25); background: rgba(52,211,153,.10); }
    .tag.warn{ color: rgba(226,232,240,.95); border-color: rgba(251,191,36,.25); background: rgba(251,191,36,.10); }

    .box .box-body{
      position:relative;
      padding: 8px 8px 10px 8px;
      min-height:0;
      flex:1 1 auto;
      overflow:hidden;
    }

    /* ticker */
    .ticker-viewport{
      position:absolute; inset: 8px 8px 10px 8px;
      overflow:hidden;
    }
    .ticker-inner{
      position:absolute; left:0; top:0; right:0;
      will-change: transform;
    }

    /* item rows */
    .crow{
      padding: 8px 10px;
      border: 1px solid rgba(148,163,184,.12);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      margin-bottom: 8px;
    }
    .crow.won{ border-color: rgba(52,211,153,.18); background: rgba(52,211,153,.06); }
    .crow.next{ border-color: rgba(251,191,36,.18); background: rgba(251,191,36,.06); }

    .crow .r1{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .crow .name{
      font-weight:900;
      font-size: 14px;
      letter-spacing:.05em;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 74%;
    }
    .crow .stt{
      font-weight:900;
      font-size: 12px;
      letter-spacing:.14em;
      white-space:nowrap;
    }
    .crow.won .stt{ color: var(--ok); }
    .crow.next .stt{ color: var(--warn); }

    .crow .r2{
      margin-top: 6px;
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
    }
    .chip{
      font-size: 11px;
      font-weight:900;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(96,165,250,.10);
      color: rgba(226,232,240,.9);
      letter-spacing:.06em;
      text-transform:uppercase;
      white-space:nowrap;
    }
    .chip.ok{ background: rgba(52,211,153,.10); border-color: rgba(52,211,153,.25); }
    .chip.warn{ background: rgba(251,191,36,.10); border-color: rgba(251,191,36,.25); }

    /* CENTER: hero + recent strip */
    .center{
      display:flex;
      flex-direction:column;
      gap: var(--gap);
      min-height:0;
    }

    .hero{
      flex: 1.05;
      border: 1px solid rgba(148,163,184,.18);
      border-radius: var(--radius);
      background:
        radial-gradient(800px 360px at 50% 0%, rgba(34,211,238,.18), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
      min-height:0;
    }
    .hero-inner{
      position:absolute; inset: 14px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      min-height:0;
    }

    .hero-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      min-height:0;
    }

    .hero-status{
      display:flex;
      flex-direction:column;
      gap: 6px;
      min-width: 220px;
    }

    .status-pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.20);
      background: rgba(0,0,0,.22);
      font-weight:900;
      letter-spacing:.12em;
      text-transform:uppercase;
      font-size: 12px;
      width: fit-content;
      white-space:nowrap;
    }
    .status-pill .s-dot{
      width:10px;height:10px;border-radius:99px;
      background: var(--pri);
      box-shadow: 0 0 16px rgba(34,211,238,.42);
    }
    .status-pill.ok{ border-color: rgba(52,211,153,.25); }
    .status-pill.ok .s-dot{ background: var(--ok); box-shadow: 0 0 16px rgba(52,211,153,.45); }
    .status-pill.warn{ border-color: rgba(251,191,36,.25); }
    .status-pill.warn .s-dot{ background: var(--warn); box-shadow: 0 0 16px rgba(251,191,36,.45); }
    .status-pill.bad{ border-color: rgba(251,113,133,.25); }
    .status-pill.bad .s-dot{ background: var(--bad); box-shadow: 0 0 16px rgba(251,113,133,.45); }

    .status-sub{
      color: var(--muted);
      font-size: 12px;
      font-weight:800;
      letter-spacing:.06em;
      line-height:1.35;
    }

    .hero-lot{
      flex:1;
      display:flex;
      flex-direction:column;
      gap: 6px;
      text-align:center;
      min-width:0;
    }

    /* Ensure lot code ALWAYS 1 line and readable for at least 6 chars */
    .lot-code{
      font-size: clamp(48px, 5.5vw, 64px);
      font-weight: 900;
      letter-spacing: .06em;   /* reduced to avoid 'L-1' wrap visual */
      text-transform: uppercase;
      text-shadow: var(--glow), var(--glow2);
      line-height: 1;
      white-space:nowrap;
      word-break:keep-all;
      display:inline-block;
      max-width: 100%;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .lot-name{
      font-size: 15px;
      color: rgba(226,232,240,.9);
      font-weight:900;
      letter-spacing:.06em;
      text-transform:uppercase;
      opacity:.95;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .lot-desc{
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
      letter-spacing:.05em;
      line-height:1.35;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }

    .hero-meta{
      min-width: 280px;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap: 10px;
    }
    .meta-row{
      display:flex; gap: 8px; align-items:center; justify-content:flex-end;
      flex-wrap:wrap;
      max-width: 100%;
    }
    .pill{
      padding: 6px 10px;
      border:1px solid rgba(148,163,184,.20);
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      font-size: 11px;
      font-weight: 900;
      letter-spacing:.08em;
      text-transform:uppercase;
      color: rgba(226,232,240,.92);
      white-space:nowrap;
      max-width: 100%;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pill.pri{ background: rgba(34,211,238,.10); border-color: rgba(34,211,238,.22); }
    .pill.ok{ background: rgba(52,211,153,.10); border-color: rgba(52,211,153,.22); }
    .pill.warn{ background: rgba(251,191,36,.10); border-color: rgba(251,191,36,.22); }
    .pill.bad{ background: rgba(251,113,133,.10); border-color: rgba(251,113,133,.22); }

    /* Price big */
    .price-wrap{
      margin-top: 8px;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(0,0,0,.22);
      padding: 14px 14px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.15);
    }
    .price-label{
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: rgba(226,232,240,.85);
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom: 6px;
      white-space:nowrap;
      gap:10px;
    }
    .price-val{
      font-size: 44px;
      font-weight: 900;
      letter-spacing:.08em;
      text-transform:uppercase;
      line-height: 1.05;
      text-shadow: 0 0 22px rgba(34,211,238,.18);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Mask / Reveal */
    .masked{
      filter: blur(10px);
      opacity: .22;
      transform: translateZ(0);
    }
    .reveal{
      filter: blur(0);
      opacity: 1;
      transition: filter .6s ease, opacity .6s ease;
    }

    .winner-wrap{
      margin-top: 8px;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(0,0,0,.18);
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      min-height: 66px;
    }
    .winner-wrap.ok{ border-color: rgba(52,211,153,.25); background: rgba(52,211,153,.06); }
    .winner-wrap.warn{ border-color: rgba(251,191,36,.25); background: rgba(251,191,36,.06); }
    .winner-wrap.bad{ border-color: rgba(251,113,133,.25); background: rgba(251,113,133,.05); }

    .winner-label{
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: rgba(226,232,240,.85);
      white-space:nowrap;
    }
    .winner-name{
      flex:1;
      text-align:right;
      font-size: 20px;
      font-weight: 900;
      letter-spacing:.08em;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-shadow: 0 0 18px rgba(96,165,250,.15);
    }
    .caret{
      display:inline-block;
      width:10px;
      animation: caretblink .8s infinite;
      opacity:.85;
    }
    @keyframes caretblink{ 50%{ opacity:.15; } }

    /* hero next list (marquee) */
    .next-wrap{
      margin-top: 10px;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(0,0,0,.14);
      padding: 10px 12px;
      overflow:hidden;
    }
    .next-wrap.warn{ border-color: rgba(251,191,36,.22); background: rgba(251,191,36,.05); }

    .next-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 8px;
    }
    .next-title{
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: rgba(226,232,240,.86);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 75%;
    }
    .next-count{
      font-size: 11px;
      font-weight: 900;
      letter-spacing:.12em;
      text-transform:uppercase;
      padding: 4px 8px;
      border-radius:999px;
      border: 1px solid rgba(251,191,36,.25);
      background: rgba(251,191,36,.10);
      color: rgba(226,232,240,.9);
      white-space:nowrap;
      flex: 0 0 auto;
    }
    .marquee{
      position:relative;
      overflow:hidden;
      white-space:nowrap;
    }
    .marquee .track{
      display:inline-block;
      will-change: transform;
    }
    .marquee-item{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      margin-right: 26px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(255,255,255,.04);
      font-weight: 900;
      font-size: 12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      white-space:nowrap;
    }
    .marquee-item .m-stt{ color: var(--warn); letter-spacing:.14em; }
    .marquee-item .m-name{ color: rgba(226,232,240,.92); }

    /* recent strip */
    .recent{
      flex: .65;
      border: 1px solid rgba(148,163,184,.16);
      border-radius: var(--radius);
      background: rgba(255,255,255,.04);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height:0;
      position:relative;
    }
    .recent .head{
      padding: 12px 12px 10px 12px;
      border-bottom: 1px solid rgba(148,163,184,.15);
      display:flex; align-items:center; justify-content:space-between;
      background: rgba(0,0,0,.10);
    }
    .recent-body{
      padding: 10px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      height: 100%;
      min-height: 0;
    }

    .rslot{
      border: 1px solid rgba(148,163,184,.16);
      border-radius: 16px;
      background: rgba(0,0,0,.14);
      padding: 10px 10px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      gap: 8px;
      position:relative;
      min-height:0;
    }
    .rslot.win{ border-color: rgba(52,211,153,.22); background: rgba(52,211,153,.05); }
    .rslot.next{ border-color: rgba(251,191,36,.22); background: rgba(251,191,36,.05); }
    .rslot.no{ border-color: rgba(251,113,133,.20); background: rgba(251,113,133,.045); }

    .rslot .lc{
      font-size: 20px;
      font-weight: 900;
      letter-spacing:.10em;
      text-transform:uppercase;
      text-shadow: 0 0 18px rgba(34,211,238,.16);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .rslot .rt{
      font-size: 11px;
      font-weight: 900;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: var(--muted);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      white-space:nowrap;
    }
    .rslot .rv{
      margin-top:auto;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 10px;
    }
    .rslot .price{
      font-weight: 900;
      letter-spacing:.06em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 64%;
      font-size: 13px;
    }
    .rslot .who{
      font-weight: 900;
      font-size: 12px;
      letter-spacing:.10em;
      text-transform:uppercase;
      color: rgba(226,232,240,.92);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 40%;
      text-align:right;
    }
    .badge-rt{
      position:absolute;
      top:10px; right:10px;
      font-size: 10px;
      font-weight: 900;
      letter-spacing:.12em;
      text-transform:uppercase;
      padding: 4px 8px;
      border-radius:999px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(255,255,255,.04);
      white-space:nowrap;
    }
    .badge-rt.win{ background: rgba(52,211,153,.12); border-color: rgba(52,211,153,.25); }
    .badge-rt.next{ background: rgba(251,191,36,.12); border-color: rgba(251,191,36,.25); }
    .badge-rt.no{ background: rgba(251,113,133,.10); border-color: rgba(251,113,133,.22); }

    .minirow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size: 11px;
      font-weight: 900;
      letter-spacing:.10em;
      text-transform:uppercase;
      color: rgba(226,232,240,.86);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .minirow .mini-badge{
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(255,255,255,.04);
      color: rgba(226,232,240,.92);
      flex: 0 0 auto;
    }
    .minirow .mini-badge.win{ border-color: rgba(52,211,153,.25); background: rgba(52,211,153,.10); }
    .minirow .mini-badge.next{ border-color: rgba(251,191,36,.25); background: rgba(251,191,36,.10); }
    .minirow .mini-badge.no{ border-color: rgba(251,113,133,.25); background: rgba(251,113,133,.08); }

    .tease-overlay{
      position:absolute; inset:0;
      background: radial-gradient(600px 260px at 50% 0%, rgba(34,211,238,.18), rgba(0,0,0,.55));
      display:none;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 12px;
    }
    .tease-overlay.show{ display:flex; }
    .tease-overlay .t1{
      font-weight: 900;
      letter-spacing:.14em;
      text-transform:uppercase;
      font-size: 12px;
      color: rgba(226,232,240,.9);
    }
    .tease-overlay .t2{
      margin-top: 8px;
      font-weight: 900;
      font-size: 16px;
      letter-spacing:.10em;
      text-transform:uppercase;
      color: var(--pri);
      text-shadow: var(--glow);
    }

    /* RIGHT: next lots cards ticker */
    .right-body{
      padding: 10px;
      height: 100%;
      min-height:0;
    }
    .cards-viewport{
      position:relative;
      height:100%;
      overflow:hidden;
    }
    .cards-inner{
      position:absolute;
      left:0; right:0; top:0;
      will-change: transform;
    }
    .lotcard{
      padding: 10px;
      border: 1px solid rgba(148,163,184,.16);
      border-radius: 16px;
      background: rgba(0,0,0,.14);
      margin-bottom: 10px;
      overflow:hidden;
    }
    .lotcard.next{ border-color: rgba(251,191,36,.22); background: rgba(251,191,36,.05); }
    .lotcard .top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom: 8px;
    }
    .lotcard .code{
      font-weight: 900;
      font-size: 18px;
      letter-spacing:.12em;
      text-transform:uppercase;
      text-shadow: 0 0 18px rgba(34,211,238,.14);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 70%;
    }
    .lotcard .flag{
      font-weight: 900;
      font-size: 10px;
      letter-spacing:.14em;
      text-transform:uppercase;
      padding: 4px 8px;
      border-radius:999px;
      border: 1px solid rgba(251,191,36,.25);
      background: rgba(251,191,36,.10);
      white-space:nowrap;
      flex:0 0 auto;
    }
    .lotcard .price{
      font-weight: 900;
      letter-spacing:.06em;
      font-size: 14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .lotcard .mini{
      color: var(--muted);
      font-size: 11px;
      font-weight: 800;
      letter-spacing:.06em;
      margin-bottom: 8px;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .lotcard .plist{
      position:relative;
      border-radius: 14px;
      border: 1px solid rgba(251,191,36,.18);
      background: rgba(255,255,255,.03);
      padding: 8px;
      overflow:hidden;
      height: 120px;
    }
    .plist .p-viewport{
      position:absolute; inset:8px;
      overflow:hidden;
    }
    .plist .p-inner{
      position:absolute; left:0; right:0; top:0;
      will-change: transform;
    }
    .prow{
      padding: 8px 10px;
      border: 1px solid rgba(148,163,184,.12);
      background: rgba(0,0,0,.16);
      border-radius: 12px;
      margin-bottom: 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .prow .pname{
      font-weight: 900;
      font-size: 12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 72%;
    }
    .prow .pstt{
      font-weight: 900;
      font-size: 11px;
      letter-spacing:.12em;
      color: var(--warn);
      white-space:nowrap;
    }

    /* overlay for round change / errors / toast */
    .overlay{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 20px;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      z-index: 50;
    }
    .overlay.show{ display:flex; }
    .overlay-card{
      width:min(860px, 92vw);
      border-radius: 22px;
      border: 1px solid rgba(148,163,184,.22);
      background:
        radial-gradient(800px 320px at 50% 0%, rgba(34,211,238,.22), rgba(0,0,0,.55)),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      padding: 18px 18px;
      text-align:center;
    }
    .overlay-card .t{
      font-weight: 900;
      letter-spacing:.16em;
      text-transform:uppercase;
      font-size: 14px;
      color: rgba(226,232,240,.9);
    }
    .overlay-card .big{
      margin-top: 10px;
      font-weight: 900;
      font-size: 34px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color: var(--pri);
      text-shadow: var(--glow), var(--glow2);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .overlay-card .sub{
      margin-top: 10px;
      color: rgba(226,232,240,.90);
      font-weight: 800;
      letter-spacing:.06em;
      font-size: 13px;
      line-height: 1.35;
    }

    /* footer marquee */
    .footer{
      border: 1px solid rgba(148,163,184,.16);
      border-radius: var(--radius);
      background: rgba(0,0,0,.18);
      box-shadow: var(--shadow);
      overflow:hidden;
      padding: 8px 10px;
    }
    .footer .marquee{
      overflow:hidden;
      white-space:nowrap;
    }
    .footer .track{
      display:inline-block;
      will-change: transform;
      font-weight: 900;
      letter-spacing:.10em;
      text-transform:uppercase;
      color: rgba(226,232,240,.88);
    }
    .footer .item{
      display:inline-block;
      padding: 6px 10px;
      margin-right: 18px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.16);
      background: rgba(255,255,255,.04);
    }

    /* responsive safety */
    @media (max-width: 1200px){
      .topbar{ grid-template-columns: 1fr; gap:10px; }
      .top-right{ justify-content:space-between; }
      .kpis{ flex-wrap:wrap; justify-content:flex-start; }
      .main{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="stage gridbg scan">

    <!-- TOP BAR -->
    <div class="topbar">
      <!-- LEFT -->
      <div class="top-left">
        <div class="brand-title">ƒê∆†N V·ªä ‚Ä¢ D·ª∞ √ÅN</div>
        <div class="brand-row">
          <span class="pill" id="companyName" title="">‚Äî</span>
          <span class="pill blue" id="projectCode" title="">‚Äî</span>
          <span class="pill soft" id="projectName" title="">‚Äî</span>
        </div>
      </div>

      <!-- MID -->
      <div class="top-mid">
        <div class="wrap">
          <div class="project-name" id="centerTitle">TR√åNH CHI·∫æU KI·ªÇM PHI·∫æU</div>
          <div class="subline" id="roundLine">V√íNG ‚Äî ‚Ä¢ TR·∫†NG TH√ÅI ‚Äî</div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="top-right">
        <button class="btn" id="btnFullscreen" type="button" title="To√†n m√†n h√¨nh">
          <span class="ico"></span><span id="fsText">TO√ÄN M√ÄN H√åNH</span>
        </button>

        <div class="kpis">
          <div class="kpi pri">
            <div class="label">T·ªïng l√¥</div>
            <div class="val" id="kpiTotalLots">0</div>
          </div>
          <div class="kpi pri">
            <div class="label">T·ªïng kh√°ch</div>
            <div class="val" id="kpiTotalCustomers">0</div>
          </div>
          <div class="kpi ok">
            <div class="label">ƒê√£ tr√∫ng</div>
            <div class="val" id="kpiWon">0</div>
          </div>
          <div class="kpi warn">
            <div class="label">V√≤ng sau</div>
            <div class="val" id="kpiNext">0</div>
          </div>
          <div class="kpi bad">
            <div class="label">Ch∆∞a ki·ªÉm</div>
            <div class="val" id="kpiPending">0</div>
          </div>
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main">

      <!-- LEFT COLUMN -->
      <div class="panel">
        <div class="head">
          <div class="h-title">üë• THEO KH√ÅCH</div>
          <div class="h-badge">STT ‚Üë</div>
        </div>

        <div class="left-body">
          <!-- Winners -->
          <div class="box won">
            <div class="box-head">
              <div class="t">üèÜ KH√ÅCH TR√öNG</div>
              <div class="tag ok" id="winnersCount">0</div>
            </div>
            <div class="box-body">
              <div class="ticker-viewport" id="winnersViewport">
                <div class="ticker-inner" id="winnersInner"></div>
              </div>
            </div>
          </div>

          <!-- Next round customers -->
          <div class="box next">
            <div class="box-head">
              <div class="t">üîÅ V√ÄO V√íNG SAU</div>
              <div class="tag warn" id="nextCustCount">0</div>
            </div>
            <div class="box-body">
              <div class="ticker-viewport" id="nextCustViewport">
                <div class="ticker-inner" id="nextCustInner"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- CENTER COLUMN -->
      <div class="center">
        <!-- HERO -->
        <div class="hero">
          <div class="hero-inner">
            <div class="hero-top">
              <div class="hero-status">
                <div class="status-pill" id="heroStatusPill">
                  <span class="s-dot" id="heroDot"></span>
                  <span id="heroStatusText">ƒêANG KI·ªÇM PHI·∫æU</span>
                </div>
                <div class="status-sub" id="heroStatusSub">Ch·ªù k·∫øt qu·∫£ m·ªõi nh·∫•t‚Ä¶</div>
              </div>

              <div class="hero-lot">
                <div class="lot-code" id="heroLotCode">‚Äî</div>
                <div class="lot-name" id="heroLotName">‚Äî</div>
                <div class="lot-desc" id="heroLotDesc">‚Äî</div>
              </div>

              <div class="hero-meta">
                <div class="meta-row">
                  <span class="pill pri" id="heroResultType">‚Äî</span>
                  <span class="pill" id="heroArea">‚Äî</span>
                  <span class="pill" id="heroStart">Kh·ªüi ƒëi·ªÉm: ‚Äî</span>
                </div>
                <div class="meta-row">
                  <span class="pill" id="heroCheckedAt">‚Äî</span>
                </div>
              </div>
            </div>

            <div class="price-wrap">
              <div class="price-label">
                <span>GI√Å (VND)</span>
                <span id="heroPriceHint" style="color:var(--muted); font-weight:900; letter-spacing:.12em; text-transform:uppercase;">‚Äî</span>
              </div>
              <div class="price-val masked" id="heroPrice">‚Äî</div>
            </div>

            <div class="winner-wrap" id="heroWinnerWrap">
              <div class="winner-label" id="heroWinnerLabel">NG∆Ø·ªúI TR√öNG</div>
              <div class="winner-name masked" id="heroWinnerName">‚Äî</div>
            </div>

            <div class="next-wrap warn" id="heroNextWrap" style="display:none;">
              <div class="next-head">
                <div class="next-title">üîÅ DANH S√ÅCH V√ÄO V√íNG SAU</div>
                <div class="next-count" id="heroNextCount">0 KH√ÅCH</div>
              </div>
              <div class="marquee" id="heroMarquee">
                <div class="track" id="heroMarqueeTrack"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- RECENT STRIP -->
        <div class="recent">
          <div class="head">
            <div class="h-title">üî• 3 L√î G·∫¶N NH·∫§T</div>
            <div class="h-badge">T·ª∞ ƒê·ªòNG ‚Ä¢ 5S</div>
          </div>
          <div class="recent-body">
            <div class="rslot" id="rs0Card">
              <div class="badge-rt" id="rs0Badge">‚Äî</div>
              <div class="lc" id="rs0Lot">‚Äî</div>
              <div class="minirow">
                <span id="rs0Type">‚Äî</span>
                <span class="mini-badge" id="rs0Extra">‚Äî</span>
              </div>
              <div class="rv">
                <div class="price" id="rs0Price">‚Äî</div>
                <div class="who" id="rs0Who">‚Äî</div>
              </div>
              <div class="tease-overlay" id="rs0Tease">
                <div>
                  <div class="t1">‚è≥ S·∫ÆP C√ì K·∫æT QU·∫¢</div>
                  <div class="t2" id="rs0TeaseLot">‚Äî</div>
                </div>
              </div>
            </div>

            <div class="rslot" id="rs1Card">
              <div class="badge-rt" id="rs1Badge">‚Äî</div>
              <div class="lc" id="rs1Lot">‚Äî</div>
              <div class="minirow">
                <span id="rs1Type">‚Äî</span>
                <span class="mini-badge" id="rs1Extra">‚Äî</span>
              </div>
              <div class="rv">
                <div class="price" id="rs1Price">‚Äî</div>
                <div class="who" id="rs1Who">‚Äî</div>
              </div>
            </div>

            <div class="rslot" id="rs2Card">
              <div class="badge-rt" id="rs2Badge">‚Äî</div>
              <div class="lc" id="rs2Lot">‚Äî</div>
              <div class="minirow">
                <span id="rs2Type">‚Äî</span>
                <span class="mini-badge" id="rs2Extra">‚Äî</span>
              </div>
              <div class="rv">
                <div class="price" id="rs2Price">‚Äî</div>
                <div class="who" id="rs2Who">‚Äî</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN -->
      <div class="panel">
        <div class="head">
          <div class="h-title">üîÅ THEO L√î V√íNG SAU</div>
          <div class="h-badge">L√î ‚Üë ‚Ä¢ STT ‚Üë</div>
        </div>

        <div class="right-body">
          <div class="cards-viewport" id="nextLotsViewport">
            <div class="cards-inner" id="nextLotsInner"></div>
          </div>
        </div>
      </div>

    </div>

    <!-- FOOTER -->
    <div class="footer">
      <div class="marquee" id="footerMarquee">
        <div class="track" id="footerTrack"></div>
      </div>
    </div>

  </div>

  <!-- overlays -->
  <div class="overlay" id="overlay">
    <div class="overlay-card">
      <div class="t" id="overlayTop">TH√îNG B√ÅO</div>
      <div class="big" id="overlayBig">‚Äî</div>
      <div class="sub" id="overlaySub">‚Äî</div>
    </div>
  </div>

  <script>
    (function(){
      "use strict";

      const SESSION_ID = {{ session_id|int }};
      const POLL_MS = Math.max(5000, Number({{ poll_ms|default(5000)|int }} || 5000)); // ∆∞u ti√™n 5s theo y√™u c·∫ßu

      const ROUND_NO = Number({{ (round_no or 1)|int }});  // m·∫∑c ƒë·ªãnh 1
      const API_URL = `/auction/sessions/api/display/sessions/${SESSION_ID}?round_no=${ROUND_NO}`;

      // ---------- formatting ----------
      function safeText(s){ return (s===null || s===undefined) ? "" : String(s); }

      function fmtMoney(n){
        try{
          const x = Number(n||0);
          return x.toLocaleString("vi-VN") + " ƒë";
        }catch(_){ return (n||0) + " ƒë"; }
      }
      function fmtNum(n){
        try{ return Number(n||0).toLocaleString("vi-VN"); }catch(_){ return String(n||0); }
      }
      function fmtArea(a){
        const x = Number(a||0);
        if(!x || x<=0) return "‚Äî";
        return (x.toLocaleString("vi-VN", {maximumFractionDigits:2})) + " m¬≤";
      }
      function fmtISOToFull(iso){
        try{
          const d = new Date(iso);
          if(isNaN(d.getTime())) return "‚Äî";
          return d.toLocaleString("vi-VN", {hour12:false});
        }catch(_){ return "‚Äî"; }
      }

      // ---------- DOM refs ----------
      const el = (id)=>document.getElementById(id);

      const companyName = el("companyName");
      const projectCode = el("projectCode");
      const projectName = el("projectName");
      const roundLine = el("roundLine");

      const kpiTotalLots = el("kpiTotalLots");
      const kpiTotalCustomers = el("kpiTotalCustomers");
      const kpiWon = el("kpiWon");
      const kpiNext = el("kpiNext");
      const kpiPending = el("kpiPending");

      // left lists
      const winnersInner = el("winnersInner");
      const winnersCount = el("winnersCount");

      const nextCustInner = el("nextCustInner");
      const nextCustCount = el("nextCustCount");

      // right cards
      const nextLotsInner = el("nextLotsInner");

      // hero
      const heroStatusPill = el("heroStatusPill");
      const heroStatusText = el("heroStatusText");
      const heroStatusSub = el("heroStatusSub");
      const heroLotCode = el("heroLotCode");
      const heroLotName = el("heroLotName");
      const heroLotDesc = el("heroLotDesc");
      const heroResultType = el("heroResultType");
      const heroArea = el("heroArea");
      const heroStart = el("heroStart");
      const heroCheckedAt = el("heroCheckedAt");

      const heroPrice = el("heroPrice");
      const heroPriceHint = el("heroPriceHint");
      const heroWinnerWrap = el("heroWinnerWrap");
      const heroWinnerLabel = el("heroWinnerLabel");
      const heroWinnerName = el("heroWinnerName");

      const heroNextWrap = el("heroNextWrap");
      const heroNextCount = el("heroNextCount");
      const heroMarqueeTrack = el("heroMarqueeTrack");

      // recent
      const rs = [
        { card: el("rs0Card"), badge: el("rs0Badge"), lot: el("rs0Lot"), type: el("rs0Type"), extra: el("rs0Extra"), price: el("rs0Price"), who: el("rs0Who"), tease: el("rs0Tease"), teaseLot: el("rs0TeaseLot") },
        { card: el("rs1Card"), badge: el("rs1Badge"), lot: el("rs1Lot"), type: el("rs1Type"), extra: el("rs1Extra"), price: el("rs1Price"), who: el("rs1Who") },
        { card: el("rs2Card"), badge: el("rs2Badge"), lot: el("rs2Lot"), type: el("rs2Type"), extra: el("rs2Extra"), price: el("rs2Price"), who: el("rs2Who") },
      ];

      // overlay
      const overlay = el("overlay");
      const overlayTop = el("overlayTop");
      const overlayBig = el("overlayBig");
      const overlaySub = el("overlaySub");

      // fullscreen
      const btnFullscreen = el("btnFullscreen");
      const fsText = el("fsText");

      // footer
      const footerMarquee = el("footerMarquee");
      const footerTrack = el("footerTrack");

      function showOverlay(top, big, sub, ms=2600){
        overlayTop.textContent = safeText(top||"TH√îNG B√ÅO");
        overlayBig.textContent = safeText(big||"‚Äî");
        overlaySub.textContent = safeText(sub||"");
        overlay.classList.add("show");
        setTimeout(()=>overlay.classList.remove("show"), ms);
      }

      // ---------- fullscreen ----------
      function isFs(){
        return !!(document.fullscreenElement || document.webkitFullscreenElement);
      }
      async function toggleFs(){
        try{
          if(!isFs()){
            const root = document.documentElement;
            if(root.requestFullscreen) await root.requestFullscreen();
            else if(root.webkitRequestFullscreen) await root.webkitRequestFullscreen();
          }else{
            if(document.exitFullscreen) await document.exitFullscreen();
            else if(document.webkitExitFullscreen) await document.webkitExitFullscreen();
          }
        }catch(e){
          console.error(e);
        }finally{
          updateFsLabel();
        }
      }
      function updateFsLabel(){
        fsText.textContent = isFs() ? "THO√ÅT TO√ÄN M√ÄN H√åNH" : "TO√ÄN M√ÄN H√åNH";
      }
      btnFullscreen?.addEventListener("click", toggleFs);
      document.addEventListener("fullscreenchange", updateFsLabel);
      document.addEventListener("webkitfullscreenchange", updateFsLabel);
      updateFsLabel();

      // ---------- state / animation control ----------
      let lastRoundId = null;

      // ‚Äúseen‚Äù result ids to detect new checked lots
      const seenRoundLotIds = new Set();
      const queue = [];

      // hero state machine
      let heroMode = "IDLE"; // IDLE | TEASE | REVEAL_PRICE | TYPE_NAME | CONGRATS
      let heroCurrent = null;
      let heroTimer = null;
      let heroTypingTimer = null;

      function clearTimers(){
        if(heroTimer){ clearTimeout(heroTimer); heroTimer=null; }
        if(heroTypingTimer){ clearInterval(heroTypingTimer); heroTypingTimer=null; }
      }

      // ---------- utils ----------
      function escapeHtml(s){
        s = safeText(s);
        return s.replace(/[&<>"']/g, (m)=>({
          "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
        }[m]));
      }

      function vnResultLabel(rt){
        if(rt === "WINNER") return "TR√öNG";
        if(rt === "NEXT_ROUND") return "V√íNG SAU";
        if(rt === "NO_VALID") return "KH√îNG H·ª¢P L·ªÜ";
        if(rt === "PENDING") return "CH∆ØA KI·ªÇM";
        return safeText(rt||"‚Äî");
      }

      function applyHeroResultPills(rt){
        heroResultType.textContent = vnResultLabel(rt);

        // reset
        heroResultType.className = "pill pri";
        heroStatusPill.className = "status-pill";

        if(rt === "WINNER"){
          heroResultType.className = "pill ok";
          heroStatusPill.classList.add("ok");
        }else if(rt === "NEXT_ROUND"){
          heroResultType.className = "pill warn";
          heroStatusPill.classList.add("warn");
        }else if(rt === "NO_VALID"){
          heroResultType.className = "pill bad";
          heroStatusPill.classList.add("bad");
        }else{
          heroResultType.className = "pill pri";
        }

        // winner box color
        heroWinnerWrap.classList.remove("ok","warn","bad");
        if(rt === "WINNER") heroWinnerWrap.classList.add("ok");
        else if(rt === "NEXT_ROUND") heroWinnerWrap.classList.add("warn");
        else if(rt === "NO_VALID") heroWinnerWrap.classList.add("bad");
      }


      function setHeroBase(item){
        const lot = item?.lot || {};
        heroLotCode.textContent = (safeText(lot.lot_code) || "‚Äî").toUpperCase();
        heroLotName.textContent = safeText(lot.lot_name || "");
        heroLotDesc.textContent = safeText(lot.lot_description || "");

        const rt = safeText(item?.result_type || "‚Äî");
        applyHeroResultPills(rt);

        heroArea.textContent = "Di·ªán t√≠ch: " + fmtArea(lot.area_m2);
        heroStart.textContent = "Kh·ªüi ƒëi·ªÉm: " + fmtMoney(lot.start_price_vnd || 0);
        heroCheckedAt.textContent = "C·∫≠p nh·∫≠t: " + fmtISOToFull(item?.checked_at || item?.checkedAt || item?.checked_at);

        // reset reveal fields
        heroPrice.textContent = item?.price_vnd ? fmtNum(item.price_vnd) : "‚Äî";
        heroWinnerName.textContent = "‚Äî";

        heroNextWrap.style.display = "none";
        heroMarqueeTrack.innerHTML = "";
        heroNextCount.textContent = "0 KH√ÅCH";

        // status text / hint
        if(rt === "WINNER"){
          heroStatusText.textContent = "C√îNG B·ªê K·∫æT QU·∫¢";
          heroStatusSub.textContent = "ƒêang x√°c nh·∫≠n tr√∫ng ƒë·∫•u gi√°‚Ä¶";
          heroPriceHint.textContent = "GI√Å TR√öNG";
          heroWinnerLabel.textContent = "NG∆Ø·ªúI TR√öNG";
        }else if(rt === "NEXT_ROUND"){
          heroStatusText.textContent = "C√îNG B·ªê V√íNG SAU";
          heroStatusSub.textContent = "ƒê·ªìng gi√° ‚Ä¢ ch·ªçn kh√°ch v√†o v√≤ng trong‚Ä¶";
          heroPriceHint.textContent = "M·ª®C GI√Å";
          heroWinnerLabel.textContent = "K·∫æT QU·∫¢";
        }else if(rt === "NO_VALID"){
          heroStatusText.textContent = "K·∫æT QU·∫¢ KH√îNG H·ª¢P L·ªÜ";
          heroStatusSub.textContent = "Kh√¥ng c√≥ phi·∫øu h·ª£p l·ªá‚Ä¶";
          heroPriceHint.textContent = "‚Äî";
          heroWinnerLabel.textContent = "K·∫æT QU·∫¢";
        }else{
          heroStatusText.textContent = "ƒêANG KI·ªÇM PHI·∫æU";
          heroStatusSub.textContent = "Ch·ªù k·∫øt qu·∫£ m·ªõi nh·∫•t‚Ä¶";
          heroPriceHint.textContent = "‚Äî";
          heroWinnerLabel.textContent = "TR·∫†NG TH√ÅI";
        }
      }

      function maskHero(){
        // lot NEVER masked. Only price + winner fields.
        heroPrice.classList.remove("reveal");
        heroWinnerName.classList.remove("reveal");
        heroPrice.classList.add("masked");
        heroWinnerName.classList.add("masked");
      }
      function revealHeroPrice(){
        heroPrice.classList.remove("masked");
        heroPrice.classList.add("reveal");
      }
      function revealHeroWinner(){
        heroWinnerName.classList.remove("masked");
        heroWinnerName.classList.add("reveal");
      }

      function setHeroNextList(item){
        const rt = safeText(item?.result_type || "");
        if(rt !== "NEXT_ROUND") return;

        const list = Array.isArray(item?.next_customers) ? item.next_customers : [];
        heroNextWrap.style.display = "block";
        heroNextCount.textContent = `${list.length} KH√ÅCH`;

        // Build track items (mask name -> show STT only in marquee? (still ok to show name here, but you didn't ask to mask in hero marquee)
        // We'll show: STT + t√™n r√∫t g·ªçn (kh√¥ng nh·∫°y c·∫£m). N·∫øu mu·ªën ·∫©n, ƒë·ªïi name = "KH√ÅCH".
        const chips = list.map(c=>{
          const stt = Number(c.stt||0);
          const name = safeText(c.name||"").toUpperCase();
          return `<span class="marquee-item"><span class="m-stt">STT ${stt||"‚Äî"}</span><span class="m-name">${escapeHtml(name)}</span></span>`;
        }).join("");

        // duplicate only when overflow (measured later)
        heroMarqueeTrack.innerHTML = chips;

        // start marquee after layout
        setTimeout(()=>{
          startMarqueeConditional(el("heroMarquee"), heroMarqueeTrack, 42);
        }, 0);
      }

      function setHeroWinnerTextTyping(finalText){
        let i=0;
        heroWinnerName.innerHTML = `<span id="typingText"></span><span class="caret">‚ñç</span>`;
        const t = document.getElementById("typingText");
        if(!t) return;

        if(heroTypingTimer) clearInterval(heroTypingTimer);

        heroTypingTimer = setInterval(()=>{
          i++;
          t.textContent = finalText.slice(0, i);
          if(i >= finalText.length){
            clearInterval(heroTypingTimer);
            heroTypingTimer = null;
            setTimeout(()=>{ heroWinnerName.textContent = finalText; }, 600);
          }
        }, 45);
      }

      function animatePriceReveal(target, ms, done){
        const t = Number(target||0);
        if(!t || t<=0){
          heroPrice.textContent = "‚Äî";
          if(done) done();
          return;
        }
        const start = Math.floor(t * 0.75);
        const st = performance.now();
        const dur = Math.max(800, ms||1200);

        function step(now){
          const p = Math.min(1, (now - st)/dur);
          const e = 1 - Math.pow(1-p, 3); // easeOutCubic
          const v = Math.floor(start + (t-start)*e);
          heroPrice.textContent = fmtNum(v);
          if(p<1) requestAnimationFrame(step);
          else { heroPrice.textContent = fmtNum(t); if(done) done(); }
        }
        requestAnimationFrame(step);
      }

      function startHeroReveal(item){
        clearTimers();
        heroCurrent = item;
        heroMode = "TEASE";

        setHeroBase(item);
        maskHero();

        // TEASE
        heroStatusSub.textContent = "‚è≥ S·∫ÆP C√ì K·∫æT QU·∫¢ M·ªöI NH·∫§T‚Ä¶";

        heroTimer = setTimeout(()=>{
          heroMode = "REVEAL_PRICE";

          animatePriceReveal(item?.price_vnd || 0, 1300, ()=>{
            revealHeroPrice();

            heroTimer = setTimeout(()=>{
              const rt = safeText(item?.result_type || "");

              if(rt === "NEXT_ROUND"){
                setHeroNextList(item);
                heroWinnerLabel.textContent = "K·∫æT QU·∫¢";
                heroWinnerName.textContent = `V√ÄO V√íNG SAU ‚Ä¢ ${Number(item?.next_count||0)} KH√ÅCH`;
                revealHeroWinner();

                heroMode = "CONGRATS";
                heroTimer = setTimeout(()=>{
                  heroMode = "IDLE";
                  heroStatusSub.textContent = "Ti·∫øp t·ª•c ki·ªÉm phi·∫øu‚Ä¶";
                }, 1500);
                return;
              }

              if(rt === "NO_VALID"){
                heroWinnerLabel.textContent = "K·∫æT QU·∫¢";
                heroWinnerName.textContent = "KH√îNG C√ì PHI·∫æU H·ª¢P L·ªÜ";
                revealHeroWinner();

                heroMode = "CONGRATS";
                heroTimer = setTimeout(()=>{
                  heroMode = "IDLE";
                  heroStatusSub.textContent = "Ti·∫øp t·ª•c ki·ªÉm phi·∫øu‚Ä¶";
                }, 1500);
                return;
              }

              // WINNER
              heroMode = "TYPE_NAME";
              const win = item?.winner || {};
              const stt = Number(win.stt||0);
              const nm = safeText(win.name||"").toUpperCase();
              const finalText = (stt>0 ? `STT ${stt} ‚Äî ${nm}` : nm) || "‚Äî";

              heroWinnerName.classList.remove("masked");
              heroWinnerName.classList.add("reveal");
              setHeroWinnerTextTyping(finalText);

              heroTimer = setTimeout(()=>{
                heroMode = "CONGRATS";
                heroStatusText.textContent = "üéâ CH√öC M·ª™NG";
                heroStatusSub.textContent = "Tr√∫ng ƒë·∫•u gi√°!";

                const lotCode = safeText(item?.lot?.lot_code||item?.lot_code||"‚Äî").toUpperCase();
                // Toast (overlay) longer + contains "Xin ch√∫c m·ª´ng" + name + lot code
                showOverlay(
                  "üéâ XIN CH√öC M·ª™NG",
                  `TR√öNG L√î ${lotCode}`,
                  `${nm ? nm : "KH√ÅCH H√ÄNG"}${nm ? "" : ""}`,
                  3400
                );

                heroTimer = setTimeout(()=>{
                  heroMode = "IDLE";
                  heroStatusText.textContent = "ƒêANG KI·ªÇM PHI·∫æU";
                  heroStatusSub.textContent = "Ch·ªù k·∫øt qu·∫£ m·ªõi nh·∫•t‚Ä¶";
                }, 1600);
              }, 2400);
            }, 650);
          });

        }, 3200);
      }

      // ---------- hero idle ----------
      function setHeroIdleFromPayload(payload){
        if(heroMode !== "IDLE") return;

        const recent = Array.isArray(payload?.recent_checked_lots) ? payload.recent_checked_lots : [];
        const newest = recent[0] || null;

        if(newest){
          heroCurrent = newest;
          setHeroBase(newest);

          // show in idle (no masking)
          heroPrice.classList.remove("masked");
          heroPrice.classList.add("reveal");
          heroWinnerName.classList.remove("masked");
          heroWinnerName.classList.add("reveal");

          const rt = safeText(newest?.result_type || "");
          if(rt === "WINNER"){
            const w = newest.winner || {};
            const stt = Number(w.stt||0);
            const nm = safeText(w.name||"").toUpperCase();
            heroWinnerLabel.textContent = "NG∆Ø·ªúI TR√öNG";
            heroWinnerName.textContent = (stt>0 && nm) ? `STT ${stt} ‚Äî ${nm}` : (nm || "‚Äî");
          }else if(rt === "NEXT_ROUND"){
            heroWinnerLabel.textContent = "K·∫æT QU·∫¢";
            heroWinnerName.textContent = `V√ÄO V√íNG SAU ‚Ä¢ ${Number(newest.next_count||0)} KH√ÅCH`;
            setHeroNextList(newest);
          }else if(rt === "NO_VALID"){
            heroWinnerLabel.textContent = "K·∫æT QU·∫¢";
            heroWinnerName.textContent = "KH√îNG C√ì PHI·∫æU H·ª¢P L·ªÜ";
          }else{
            heroWinnerLabel.textContent = "TR·∫†NG TH√ÅI";
            heroWinnerName.textContent = "ƒêANG KI·ªÇM PHI·∫æU‚Ä¶";
          }
        }else{
          heroLotCode.textContent = "‚Äî";
          heroLotName.textContent = "‚Äî";
          heroLotDesc.textContent = "‚Äî";
          heroResultType.textContent = "‚Äî";
          heroArea.textContent = "‚Äî";
          heroStart.textContent = "Kh·ªüi ƒëi·ªÉm: ‚Äî";
          heroCheckedAt.textContent = "‚Äî";
          heroPrice.textContent = "‚Äî";
          heroWinnerName.textContent = "‚Äî";
          heroStatusText.textContent = "ƒêANG KI·ªÇM PHI·∫æU";
          heroStatusSub.textContent = "Ch·ªù k·∫øt qu·∫£ m·ªõi nh·∫•t‚Ä¶";
          heroNextWrap.style.display = "none";
        }
      }

      // ---------- queue: new checked lots ----------
      function enqueueNewCheckedLots(payload){
        const recent = Array.isArray(payload?.recent_checked_lots) ? payload.recent_checked_lots : [];
        for(const item of recent){
          const id = Number(item.round_lot_id||0);
          if(!id) continue;
          if(seenRoundLotIds.has(id)) continue;
          seenRoundLotIds.add(id);
          queue.push(item);
        }
      }

      function maybeStartNextReveal(payload){
        if(heroMode !== "IDLE") return;

        if(queue.length > 0){
          const item = queue.shift();
          startHeroReveal(item);
          return;
        }
        setHeroIdleFromPayload(payload);
      }

      // ---------- recent strip rendering ----------
      function setRecentSlots(recentList){
        const list = Array.isArray(recentList) ? recentList.slice(0,3) : [];

        const newest = list[0];
        const isAnimatingNewest = newest && heroCurrent && (Number(newest.round_lot_id) === Number(heroCurrent.round_lot_id)) && (heroMode !== "IDLE");

        if(isAnimatingNewest){
          const slot0 = rs[0];
          slot0.lot.textContent = safeText(newest.lot?.lot_code||newest.lot_code||"‚Äî").toUpperCase();
          slot0.type.textContent = "‚Äî";
          slot0.extra.textContent = "‚Äî";
          slot0.price.textContent = "‚Äî";
          slot0.who.textContent = "‚Äî";
          slot0.badge.textContent = "S·∫ÆP C√ì";
          slot0.badge.className = "badge-rt next";
          slot0.card.className = "rslot next";
          slot0.teaseLot.textContent = safeText(newest.lot?.lot_code||newest.lot_code||"‚Äî").toUpperCase();
          slot0.tease.classList.add("show");

          fillRecentSlot(rs[1], list[1] || null);
          fillRecentSlot(rs[2], list[2] || null);
          return;
        }

        rs[0].tease?.classList?.remove("show");
        fillRecentSlot(rs[0], list[0] || null);
        fillRecentSlot(rs[1], list[1] || null);
        fillRecentSlot(rs[2], list[2] || null);
      }

      function fillRecentSlot(slot, item){
        if(!slot) return;
        if(!item){
          slot.card.className = "rslot";
          slot.badge.textContent = "‚Äî";
          slot.badge.className = "badge-rt";
          slot.lot.textContent = "‚Äî";
          slot.type.textContent = "‚Äî";
          slot.extra.textContent = "‚Äî";
          slot.extra.className = "mini-badge";
          slot.price.textContent = "‚Äî";
          slot.who.textContent = "‚Äî";
          if(slot.tease) slot.tease.classList.remove("show");
          return;
        }
        if(slot.tease) slot.tease.classList.remove("show");

        const rt = safeText(item.result_type || "‚Äî");
        const lotCode = safeText(item.lot?.lot_code || item.lot_code || "‚Äî").toUpperCase();

        slot.lot.textContent = lotCode;

        // REQUIRED 4 things:
        // 1) Tr·∫°ng th√°i (m√†u)
        // 2) Gi√° tr√∫ng / gi√° cao nh·∫•t
        // 3) Ng∆∞·ªùi tr√∫ng: MASK = STT
        // 4) N·∫øu v√†o v√≤ng sau: s·ªë l∆∞·ª£ng kh√°ch v√†o v√≤ng sau

        const label = vnResultLabel(rt);
        slot.type.textContent = label;

        slot.badge.textContent = label;

        if(rt === "WINNER"){
          slot.card.className = "rslot win";
          slot.badge.className = "badge-rt win";
          slot.extra.className = "mini-badge win";
          slot.extra.textContent = "TR√öNG";
          slot.price.textContent = item.price_vnd ? fmtMoney(item.price_vnd) : "‚Äî";

          const w = item.winner || {};
          const stt = Number(w.stt||0);
          slot.who.textContent = stt ? `STT ${stt}` : "STT ‚Äî";
        }else if(rt === "NEXT_ROUND"){
          slot.card.className = "rslot next";
          slot.badge.className = "badge-rt next";
          slot.extra.className = "mini-badge next";
          const cnt = Number(item.next_count||0);
          slot.extra.textContent = `${cnt} KH√ÅCH`;
          slot.price.textContent = item.price_vnd ? fmtMoney(item.price_vnd) : "‚Äî";
          slot.who.textContent = cnt ? `${cnt} KH√ÅCH` : "‚Äî";
        }else if(rt === "NO_VALID"){
          slot.card.className = "rslot no";
          slot.badge.className = "badge-rt no";
          slot.extra.className = "mini-badge no";
          slot.extra.textContent = "KH√îNG H·ª¢P L·ªÜ";
          slot.price.textContent = "‚Äî";
          slot.who.textContent = "‚Äî";
        }else{
          slot.card.className = "rslot";
          slot.badge.className = "badge-rt";
          slot.extra.className = "mini-badge";
          slot.extra.textContent = "CH∆ØA KI·ªÇM";
          slot.price.textContent = item.price_vnd ? fmtMoney(item.price_vnd) : "‚Äî";
          slot.who.textContent = "‚Äî";
        }
      }

      // ---------- build customer lists ----------
      function buildCustomerLists(byCustomer){
        const arr = Array.isArray(byCustomer) ? byCustomer : [];

        const winners = arr.filter(x => (x?.won_lots||[]).length > 0);
        const nexts = arr.filter(x => (x?.next_lots||[]).length > 0);

        winnersCount.textContent = String(winners.length);
        nextCustCount.textContent = String(nexts.length);

        const winnersHtml = winners.map(x=>{
          const c = x.customer || {};
          const stt = Number(c.stt||0);
          const name = safeText(c.name||"").toUpperCase();
          const lots = (x.won_lots||[]).map(l => `<span class="chip ok">${escapeHtml(safeText(l.lot_code||""))}</span>`).join("");
          return `
            <div class="crow won">
              <div class="r1">
                <div class="name">${escapeHtml(name || "‚Äî")}</div>
                <div class="stt">STT ${stt||"‚Äî"}</div>
              </div>
              <div class="r2">
                <span class="chip ok">TR√öNG ${(x.won_lots||[]).length} L√î</span>
                ${lots}
              </div>
            </div>
          `;
        }).join("") || `<div class="crow won"><div class="r1"><div class="name">CH∆ØA C√ì K·∫æT QU·∫¢</div><div class="stt">‚Äî</div></div></div>`;

        const nextsHtml = nexts.map(x=>{
          const c = x.customer || {};
          const stt = Number(c.stt||0);
          const name = safeText(c.name||"").toUpperCase();
          const lots = (x.next_lots||[]).map(l => `<span class="chip warn">${escapeHtml(safeText(l.lot_code||""))}</span>`).join("");
          return `
            <div class="crow next">
              <div class="r1">
                <div class="name">${escapeHtml(name || "‚Äî")}</div>
                <div class="stt">STT ${stt||"‚Äî"}</div>
              </div>
              <div class="r2">
                <span class="chip warn">V√íNG SAU ${(x.next_lots||[]).length} L√î</span>
                ${lots}
              </div>
            </div>
          `;
        }).join("") || `<div class="crow next"><div class="r1"><div class="name">CH∆ØA C√ì DS V√ÄO V√íNG SAU</div><div class="stt">‚Äî</div></div></div>`;

        winnersInner.innerHTML = winnersHtml;
        nextCustInner.innerHTML = nextsHtml;

        // Smooth tickers:
        // - If overflow => duplicate xN then scroll
        // - If not overflow => no duplication, no scroll
        makeVerticalTickerConditional(el("winnersViewport"), winnersInner, 22, 10);
        makeVerticalTickerConditional(el("nextCustViewport"), nextCustInner, 22, 10);
      }

      // ---------- build right cards from by_status.next_this_round ----------
      function buildNextLotCards(byStatus){
        const nextLots = (byStatus && Array.isArray(byStatus.next_this_round)) ? byStatus.next_this_round : [];
        nextLotsInner.innerHTML = nextLots.map(x=>{
          const lot = x.lot || {};
          const code = safeText(lot.lot_code||"‚Äî").toUpperCase();
          const desc = safeText(lot.lot_description||"");
          const price = x.price_vnd ? fmtMoney(x.price_vnd) : "‚Äî";
          const list = Array.isArray(x.next_customers) ? x.next_customers : [];
          const plistId = "plist_" + Number(x.round_lot_id||0);

          // rows (show full name here OK; requirement to mask applies to "3 l√¥ g·∫ßn nh·∫•t" cards)
          const rows = list.map(c=>{
            const stt = Number(c.stt||0);
            const nm = safeText(c.name||"").toUpperCase();
            return `
              <div class="prow">
                <div class="pname">${escapeHtml(nm||"‚Äî")}</div>
                <div class="pstt">STT ${stt||"‚Äî"}</div>
              </div>
            `;
          }).join("") || `<div class="prow"><div class="pname">CH∆ØA C√ì DS</div><div class="pstt">‚Äî</div></div>`;

          return `
            <div class="lotcard next">
              <div class="top">
                <div class="code">${escapeHtml(code)}</div>
                <div class="flag">V√íNG SAU</div>
              </div>
              <div class="price">${escapeHtml(price)}</div>
              <div class="mini">${escapeHtml(desc || "")}</div>

              <div class="plist" id="${plistId}">
                <div class="p-viewport">
                  <div class="p-inner">${rows}</div>
                </div>
              </div>
            </div>
          `;
        }).join("") || `<div class="lotcard next"><div class="top"><div class="code">‚Äî</div><div class="flag">V√íNG SAU</div></div><div class="price">CH∆ØA C√ì L√î V√ÄO V√íNG SAU</div></div>`;

        // outer cards: conditional duplicate + scroll
        makeCardsTickerConditional(el("nextLotsViewport"), nextLotsInner, 16, 8);

        // inner tickers for each card participant list (conditional)
        setTimeout(()=>{
          nextLots.forEach(x=>{
            const id = "plist_" + Number(x.round_lot_id||0);
            const box = document.getElementById(id);
            if(!box) return;
            const viewport = box.querySelector(".p-viewport");
            const inner = box.querySelector(".p-inner");
            if(!viewport || !inner) return;
            makeSimpleTickerConditional(viewport, inner, 24, 8);
          });
        }, 50);
      }

      // ---------- tickers (conditional duplicate) ----------
      function shouldScrollY(viewport, inner){
        if(!viewport || !inner) return false;
        return inner.scrollHeight > viewport.clientHeight + 2;
      }

      function duplicateInnerHtml(inner, times){
        if(!inner) return;
        const base = inner.getAttribute("data-base-html");
        if(base === null){
          inner.setAttribute("data-base-html", inner.innerHTML || "");
        }
        const html = inner.getAttribute("data-base-html") || "";
        const t = Math.max(1, Number(times||1));
        let out = "";
        for(let i=0;i<t;i++) out += html;
        inner.innerHTML = out;
      }

      function resetInnerBase(inner){
        if(!inner) return;
        const base = inner.getAttribute("data-base-html");
        if(base !== null){
          inner.innerHTML = base;
        }
      }

      function makeVerticalTickerConditional(viewport, inner, speedPxPerSec, dupTimes){
        if(!viewport || !inner) return;

        // restore base first
        resetInnerBase(inner);

        // if overflow -> duplicate & scroll; else stop
        const overflow = shouldScrollY(viewport, inner);
        if(!overflow){
          inner.style.transform = "translateY(0px)";
          return;
        }

        duplicateInnerHtml(inner, dupTimes || 10);
        makeVerticalTickerSeamless(viewport, inner, speedPxPerSec || 22);
      }

      function makeSimpleTickerConditional(viewport, inner, speedPxPerSec, dupTimes){
        if(!viewport || !inner) return;

        resetInnerBase(inner);
        const overflow = shouldScrollY(viewport, inner);
        if(!overflow){
          inner.style.transform = "translateY(0px)";
          return;
        }

        duplicateInnerHtml(inner, dupTimes || 8);
        makeVerticalTickerSeamless(viewport, inner, speedPxPerSec || 24);
      }

      function makeCardsTickerConditional(viewport, inner, speedPxPerSec, dupTimes){
        if(!viewport || !inner) return;

        resetInnerBase(inner);
        const overflow = shouldScrollY(viewport, inner);
        if(!overflow){
          inner.style.transform = "translateY(0px)";
          return;
        }

        duplicateInnerHtml(inner, dupTimes || 8);
        makeVerticalTickerSeamless(viewport, inner, speedPxPerSec || 16);
      }

      // Seamless loop: duplicate content (already done) then translate continuously with modulo
      function makeVerticalTickerSeamless(viewport, inner, speedPxPerSec){
        inner.style.transform = "translateY(0px)";
        const totalH = inner.scrollHeight;
        const vh = viewport.clientHeight;
        if(totalH <= vh + 2) return;

        // because duplicated N times, we can loop over 1/N of height if we want.
        // We'll loop over 1/2 height (safe) by using "base height" derived from stored base content.
        const baseHtml = inner.getAttribute("data-base-html") || "";
        let baseH = null;

        // measure base height by temporary swap (fast, once)
        try{
          const tmp = document.createElement("div");
          tmp.style.position = "absolute";
          tmp.style.visibility = "hidden";
          tmp.style.pointerEvents = "none";
          tmp.style.left = "-99999px";
          tmp.style.top = "0";
          tmp.style.width = viewport.clientWidth + "px";
          tmp.innerHTML = baseHtml;
          document.body.appendChild(tmp);
          baseH = tmp.scrollHeight || null;
          document.body.removeChild(tmp);
        }catch(_){ baseH = null; }

        const loopDist = Math.max(10, (baseH && baseH > vh) ? baseH : (totalH - vh + 20));
        const pxPerMs = Math.max(10, speedPxPerSec||22) / 1000;

        let last = performance.now();
        let offset = 0;

        function step(now){
          const dt = now - last;
          last = now;
          offset += dt * pxPerMs;

          // loop modulo
          if(offset >= loopDist) offset = offset % loopDist;

          inner.style.transform = `translateY(${-Math.floor(offset)}px)`;
          requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
      }

      // ---------- marquee (conditional duplicate) ----------
      function startMarqueeConditional(container, track, speedPxPerSec){
        if(!container || !track) return;

        // restore base
        const base = track.getAttribute("data-base-html");
        if(base === null){
          track.setAttribute("data-base-html", track.innerHTML || "");
        }else{
          track.innerHTML = base;
        }

        const cW = container.clientWidth;
        const tW = track.scrollWidth;

        if(tW <= cW + 10){
          track.style.transform = "translateX(0px)";
          return; // no overflow => no duplication, no scroll
        }

        // duplicate to make it long (seamless)
        const baseHtml = track.getAttribute("data-base-html") || track.innerHTML || "";
        track.innerHTML = baseHtml + baseHtml + baseHtml; // x3 enough for smooth

        startMarquee(container, track, speedPxPerSec || 42);
      }

      function startMarquee(container, track, speedPxPerSec){
        if(!container || !track) return;
        const cW = container.clientWidth;
        const tW = track.scrollWidth;
        if(tW <= cW + 10) return;

        // loop over 1/3 width (since duplicated x3) or half width safely
        const dist = Math.floor(tW / 3);
        const duration = (dist / Math.max(10, speedPxPerSec||42)) * 1000;
        let start = null;

        function step(ts){
          if(start === null) start = ts;
          const t = ts - start;
          const p = (t % duration) / duration;
          const x = -Math.floor(dist * p);
          track.style.transform = `translateX(${x}px)`;
          requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
      }

      // ---------- apply context ----------
      function applyContext(ctx){
        // truncation: keep title attr full
        const cn = safeText(ctx.company_name || ctx.company_code || "‚Äî");
        const pc = safeText(ctx.project_code || "‚Äî");
        const pn = safeText(ctx.project_name || "‚Äî");

        companyName.textContent = cn;
        companyName.title = cn;

        projectCode.textContent = pc;
        projectCode.title = pc;

        projectName.textContent = pn;
        projectName.title = pn;

        const rn = Number(ctx.round_no||0);
        const st = safeText(ctx.round_status||"‚Äî");
        roundLine.textContent = `V√íNG ${rn || "‚Äî"} ‚Ä¢ TR·∫†NG TH√ÅI ${st}`;

        const stats = ctx.stats || {};
        kpiTotalLots.textContent = fmtNum(stats.total_lots||0);
        kpiTotalCustomers.textContent = fmtNum(stats.total_customers||0);
        kpiWon.textContent = fmtNum(stats.won_lots||0);
        kpiNext.textContent = fmtNum(stats.next_lots||0);
        kpiPending.textContent = fmtNum(stats.pending_lots||0);

        if(lastRoundId !== null && Number(ctx.round_id||0) !== Number(lastRoundId||0)){
          showOverlay("üîÑ CHUY·ªÇN V√íNG", `V√íNG ${Number(ctx.round_no||0)}`, "ƒêang t·∫£i d·ªØ li·ªáu v√≤ng m·ªõi‚Ä¶", 2200);
          seenRoundLotIds.clear();
          queue.length = 0;
          heroMode = "IDLE";
          heroCurrent = null;
          clearTimers();
        }
        lastRoundId = Number(ctx.round_id||0);
      }

      // ---------- fetch loop ----------
      async function fetchPayload(){
        const r = await fetch(API_URL, {headers:{ "Accept":"application/json" }});
        if(!r.ok){
          const txt = await r.text().catch(()=>null);
          throw new Error(`HTTP ${r.status} ${txt||""}`.trim());
        }
        return await r.json();
      }

      let inFlight = false;
      async function poll(){
        if(inFlight) return;
        inFlight = true;
        try{
          const payload = await fetchPayload();

          applyContext(payload.context || {});

          buildCustomerLists(payload.by_customer || []);
          buildNextLotCards(payload.by_status || {});

          enqueueNewCheckedLots(payload);

          setRecentSlots(payload.recent_checked_lots || []);
          maybeStartNextReveal(payload);

        }catch(err){
          console.error(err);
          showOverlay("‚ö†Ô∏è L·ªñI K·∫æT N·ªêI", "KH√îNG L·∫§Y ƒê∆Ø·ª¢C D·ªÆ LI·ªÜU", "S·∫Ω t·ª± th·ª≠ l·∫°i‚Ä¶", 2000);
        }finally{
          inFlight = false;
        }
      }

      // ---------- footer marquee init ----------
      function initFooter(){
        const msg = "ƒê∆°n v·ªã ph·∫ßn m·ªÅm: VNTECHX ‚Äì N·ªÅn t·∫£ng v·∫≠n h√†nh ƒë·∫•u gi√° ƒë·∫•t (t·ª± ƒë·ªông ho√° & minh b·∫°ch).";
        footerTrack.innerHTML = `
          <span class="item">${escapeHtml(msg.toUpperCase())}</span>
          <span class="item">${escapeHtml(msg.toUpperCase())}</span>
          <span class="item">${escapeHtml(msg.toUpperCase())}</span>
        `;
        // always scroll footer (it is intended), but still seamless
        startMarquee(footerMarquee, footerTrack, 32);
      }

      // ---------- init ----------
      initFooter();
      poll();
      setInterval(poll, POLL_MS);

    })();
  </script>
</body>
</html>
