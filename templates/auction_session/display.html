{# templates/pages/auction_session/display.html #}
<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>{{ title or "Trình chiếu kiểm phiếu (Realtime)" }}</title>
    <!-- Technical font -->
    <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
      :root{
      --hero-big: clamp(32px, 3.2vw, 52px); /* ✅ size chung cho GIÁ + TÊN */
      --bg0:#070A12;
      --bg1:#0A1022;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.09);
      --bd: rgba(148,163,184,.18);
      --bd2: rgba(148,163,184,.28);
      --txt: rgba(226,232,240,1);
      --muted: rgba(148,163,184,1);
      --muted2: rgba(148,163,184,.75);
      --pri:#22d3ee;
      --pri2:#60a5fa;
      --ok:#34d399;    /* TRÚNG */
      --warn:#fbbf24;  /* VÒNG SAU */
      --bad:#fb7185;   /* KHÔNG HỢP LỆ / CHƯA CÓ */
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --glow: 0 0 22px rgba(34,211,238,.25);
      --glow2: 0 0 34px rgba(96,165,250,.18);
      --radius: 18px;
      --font: "Oxanium", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      /* 16:9 safe sizing */
      --pad: 16px;
      --gap: 14px;
      /* speed */
      --scan-speed: 7s;
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{
      margin:0;
      font-family: var(--font);
      color: var(--txt);
      background:
      radial-gradient(1200px 520px at 50% 0%, rgba(96,165,250,.22), transparent 60%),
      radial-gradient(900px 420px at 0% 40%, rgba(34,211,238,.18), transparent 60%),
      radial-gradient(900px 420px at 100% 40%, rgba(52,211,153,.12), transparent 55%),
      linear-gradient(180deg, var(--bg0), var(--bg1));
      letter-spacing: .03em;
      overflow:hidden;
      }
      /* subtle grid */
      .gridbg::before{
      content:"";
      position:absolute; inset:0;
      background-image:
      linear-gradient(to right, rgba(148,163,184,.06) 1px, transparent 1px),
      linear-gradient(to bottom, rgba(148,163,184,.05) 1px, transparent 1px);
      background-size: 48px 48px;
      mask-image: radial-gradient(circle at 50% 30%, rgba(0,0,0,1), rgba(0,0,0,0) 70%);
      pointer-events:none;
      opacity:.55;
      }
      /* scan line */
      .scan::after{
      content:"";
      position:absolute; inset:-30% 0 auto 0;
      height: 140px;
      background: linear-gradient(180deg, transparent, rgba(34,211,238,.12), transparent);
      filter: blur(0.2px);
      animation: scan var(--scan-speed) linear infinite;
      pointer-events:none;
      opacity:.7;
      }
      @keyframes scan{
      0%{ transform: translateY(-160px); }
      100%{ transform: translateY(calc(100vh + 260px)); }
      }
      /* 16:9 stage */
      .stage{
      position:relative;
      width:100vw;
      height:100vh;
      padding: var(--pad);
      display:flex;
      flex-direction:column;
      gap: var(--gap);
      }
      /* top bar: 3 columns to avoid overlap */
      .topbar{
      display:grid;
      grid-template-columns: minmax(320px, 1fr) minmax(340px, 1.05fr) minmax(520px, 1.35fr);
      align-items:center;
      gap: 12px;
      padding: 10px 12px;
      border: 1px solid var(--bd);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      box-shadow: var(--shadow);
      overflow: visible;
      }
      .top-left{
      min-width: 0;
      display:flex;
      flex-direction:column;
      gap: 8px;
      }
      .brand-row{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
      flex-wrap:wrap;
      }
      .brand-row .pill{
      padding: 6px 10px;
      border:1px solid var(--bd2);
      border-radius: 999px;
      background: rgba(34,211,238,.10);
      box-shadow: var(--glow);
      font-weight:800;
      letter-spacing:.06em;
      color: rgba(226,232,240,1);
      white-space:nowrap;
      max-width: 100%;
      overflow:hidden;
      text-overflow:ellipsis;
      }
      .pill.soft{ background: rgba(255,255,255,.04); box-shadow:none; }
      .pill.blue{ background: rgba(96,165,250,.10); }
      .brand-title{
      font-weight:900;
      letter-spacing:.12em;
      font-size: 11px;
      text-transform:uppercase;
      color: var(--muted2);
      }
      .top-mid{
      min-width:0;
      text-align:center;
      display:flex;
      align-items:center;
      justify-content:center;
      }
      .top-mid .wrap{ min-width:0; max-width: 100%; }
      .project-name{
      font-weight:900;
      font-size: 18px;
      letter-spacing:.08em;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      }
      .subline{
      font-weight:800;
      font-size: 12px;
      color: var(--muted);
      margin-top: 3px;
      letter-spacing:.08em;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      }
      .top-right{
      min-width:0;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:flex-end;
      overflow: visible;
      }
      .kpis{
      display:flex;
      gap:10px;
      align-items:stretch;
      justify-content:flex-end;
      min-width:0;
      flex: 1;
      overflow: visible;
      flex-wrap: nowrap;
      }
      .kpi{
      min-width: 104px;
      padding: 8px 10px;
      border:1px solid var(--bd);
      border-radius: 14px;
      background: rgba(255,255,255,.05);
      display:flex;
      flex-direction:column;
      gap: 3px;
      box-shadow: var(--shadow);
      flex: 0 0 auto;
      }
      .kpi .label{
      font-size:11px;
      color: var(--muted2);
      font-weight:800;
      letter-spacing:.10em;
      text-transform:uppercase;
      white-space:nowrap;
      }
      .kpi .val{
      font-size:18px;
      font-weight:900;
      letter-spacing:.04em;
      }
      .kpi.ok .val{ color: var(--ok); text-shadow: 0 0 16px rgba(52,211,153,.22); }
      .kpi.pri .val{ color: var(--pri); text-shadow: 0 0 16px rgba(34,211,238,.25); }
      .kpi.warn .val{ color: var(--warn); text-shadow: 0 0 16px rgba(251,191,36,.20); }
      .kpi.bad .val{ color: var(--bad); text-shadow: 0 0 16px rgba(251,113,133,.18); }
      .fsbtn{
      width: 38px;
      height: 38px;
      border-radius: 14px;
      border:1px solid rgba(148,163,184,.22);
      background: rgba(0,0,0,.20);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      box-shadow: var(--shadow);
      user-select:none;
      flex: 0 0 auto;
      }
      .fsbtn:hover{ border-color: rgba(34,211,238,.35); box-shadow: var(--shadow), var(--glow); }
      .fsbtn:active{ transform: translateY(1px); }
      .fsbtn svg{ width:18px; height:18px; opacity:.92; }
      .sr-only{
      position:absolute !important;
      width:1px;height:1px;
      padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);
      white-space:nowrap;border:0;
      }
      /* ===== SOUND TOGGLE (tiny, top-left) ===== */
      .soundbtn{
      position: fixed;
      left: 12px;
      top: 12px;
      z-index: 60;
      width: 34px;
      height: 34px;
      border-radius: 14px;
      border:1px solid rgba(148,163,184,.22);
      background: rgba(0,0,0,.25);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      box-shadow: var(--shadow);
      user-select:none;
      }
      .soundbtn:hover{
      border-color: rgba(34,211,238,.35);
      box-shadow: var(--shadow), var(--glow);
      }
      .soundbtn:active{ transform: translateY(1px); }
      .soundbtn .ico{
      font-size: 16px;
      line-height: 1;
      opacity: .95;
      }
      .soundbtn.off{
      opacity: .55;
      border-color: rgba(251,113,133,.25);
      box-shadow: var(--shadow);
      }
      /* main 3 columns */
      .main{
      flex:1;
      display:grid;
      grid-template-columns: 1.05fr 1.9fr 1.15fr;
      gap: var(--gap);
      min-height: 0;
      }
      .panel{
      border: 1px solid var(--bd);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      min-height:0;
      overflow:hidden;
      position:relative;
      }
      .panel .head{
      padding: 12px 12px 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid rgba(148,163,184,.15);
      background: rgba(0,0,0,.10);
      }
      .h-title{
      font-weight:900;
      letter-spacing:.12em;
      font-size: 12px;
      text-transform:uppercase;
      color: rgba(226,232,240,.92);
      display:flex;
      align-items:center;
      gap: 8px;
      white-space:nowrap;
      }
      .h-badge{
      font-weight:900;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--bd2);
      background: rgba(96,165,250,.12);
      color: rgba(226,232,240,.95);
      letter-spacing:.10em;
      white-space:nowrap;
      }
      /* LEFT: customer lists */
      .left-body{
      padding: 10px 10px 12px 10px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      height: 100%;
      min-height:0;
      }
      .box{
      border: 1px solid rgba(148,163,184,.16);
      border-radius: 16px;
      background: rgba(0,0,0,.12);
      overflow:hidden;
      min-height:0;
      display:flex;
      flex-direction:column;
      flex: 1;
      }
      .box.won{ border-color: rgba(52,211,153,.22); }
      .box.next{ border-color: rgba(251,191,36,.22); }
      .box .box-head{
      padding: 10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid rgba(148,163,184,.14);
      background: rgba(0,0,0,.10);
      flex: 0 0 auto;
      }
      .box .box-head .t{
      font-weight:900;
      letter-spacing:.10em;
      text-transform:uppercase;
      font-size: 12px;
      display:flex;
      align-items:center;
      gap: 8px;
      white-space:nowrap;
      }
      .tag{
      font-size: 11px;
      font-weight:900;
      padding: 3px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      white-space:nowrap;
      }
      .tag.ok{ color: rgba(226,232,240,.95); border-color: rgba(52,211,153,.25); background: rgba(52,211,153,.10); }
      .tag.warn{ color: rgba(226,232,240,.95); border-color: rgba(251,191,36,.25); background: rgba(251,191,36,.10); }
      .box .box-body{
      position:relative;
      padding: 8px 8px 10px 8px;
      min-height:0;
      flex:1 1 auto;
      overflow:hidden;
      }
      /* ticker */
      .ticker-viewport{
      position:absolute; inset: 8px 8px 10px 8px;
      overflow:hidden;
      }
      .ticker-inner{
      position:absolute; left:0; top:0; right:0;
      will-change: transform;
      }
      /* item rows */
      .crow{
      padding: 8px 10px;
      border: 1px solid rgba(148,163,184,.12);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      margin-bottom: 8px;
      }
      .crow.won{ border-color: rgba(52,211,153,.18); background: rgba(52,211,153,.06); }
      .crow.next{ border-color: rgba(251,191,36,.18); background: rgba(251,191,36,.06); }
      .crow .r1{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      }
      .crow .name{
      font-weight:900;
      font-size: 14px;
      letter-spacing:.05em;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 74%;
      }
      .crow .stt{
      font-weight:900;
      font-size: 12px;
      letter-spacing:.14em;
      white-space:nowrap;
      }
      .crow.won .stt{ color: var(--ok); }
      .crow.next .stt{ color: var(--warn); }
      .crow .r2{
      margin-top: 6px;
      display:flex;
      gap: 8px;
      flex-wrap: nowrap;     /* ✅ chỉ 1 dòng */
      overflow: hidden;      /* ✅ dư thì ẩn */
      white-space: nowrap;
      }
      .chip{
      font-size: 11px;
      font-weight:900;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(96,165,250,.10);
      color: rgba(226,232,240,.9);
      letter-spacing:.06em;
      text-transform:uppercase;
      white-space:nowrap;
      }
      .chip.ok{ background: rgba(52,211,153,.10); border-color: rgba(52,211,153,.25); }
      .chip.warn{ background: rgba(251,191,36,.10); border-color: rgba(251,191,36,.25); }
      /* CENTER: hero + recent strip  (FIX: HERO không kéo full màn hình) */
      .center{
      display:grid;
      grid-template-rows: minmax(260px, 0.62fr) minmax(220px, 0.38fr);
      gap: var(--gap);
      min-height: 0;
      }
      /* === HERO RE-LAYOUT: status full width, then 2-column main === */
      /* NOTE: block này để HERO KHÔNG PHÌNH và KHÔNG ẢNH HƯỞNG RECENT */
      .hero{
      position: relative;
      height: 100%;
      min-height: 0;

      overflow: hidden; /* ✅ chặn mọi thứ tràn ra ngoài bo góc hero */


      border-radius: 22px;

      /* ✅ viền rõ hơn 1 chút */
      border: 1px solid rgba(148,163,184,.22);

      /* ✅ nền sâu hơn nhẹ */
      background:
      radial-gradient(900px 420px at 50% 0%, rgba(96,165,250,.10), transparent 60%),
      linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.16));

      /* ✅ tăng “độ sâu” */
      box-shadow:
      0 18px 70px rgba(0,0,0,.55),
      inset 0 0 0 1px rgba(0,0,0,.35);
      }


      .hero-inner{
      position:absolute;
      inset: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
      min-height: 0;

      /* ✅ cho tràn ngang */
      overflow-x: visible;
      overflow-y: hidden;
      }

      .hero-top{
      display:flex;
      flex-direction:column;
      gap: 12px;
      min-height: 0;
      flex: 1 1 auto;

      /* ✅ cho tràn ngang */
      overflow-x: visible;
      overflow-y: hidden;
      }

      /* ===== STATUS BAR ===== */
      .hero-status{
      flex: 0 0 auto;
      display:flex;
      flex-direction:column;
      gap: 8px;
      min-width: 0;
      }
      .hero-status.hero-statusbar{
      width:100%;
      padding: 2px 2px 0 2px;
      }
      /* Hero nổi hơn khi đang kiểm */
      .hero:has(.status-pill.pri){
      box-shadow:
      inset 0 0 0 1px rgba(34,211,238,.22),
      0 0 32px rgba(34,211,238,.10);
      }
      /* ✅ HERO nổi hơn khi TRÚNG */
      .hero:has(.status-pill.ok){
      box-shadow:
      0 22px 80px rgba(0,0,0,.60),
      inset 0 0 0 1px rgba(52,211,153,.22),
      0 0 44px rgba(52,211,153,.14);
      border-color: rgba(52,211,153,.24);
      }

      /* ✅ HERO nổi hơn khi VÒNG SAU */
      .hero:has(.status-pill.warn){
      box-shadow:
      0 22px 80px rgba(0,0,0,.60),
      inset 0 0 0 1px rgba(251,191,36,.22),
      0 0 44px rgba(251,191,36,.12);
      border-color: rgba(251,191,36,.24);
      }

      .status-pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.20);
      background: rgba(0,0,0,.22);
      font-weight:900;
      letter-spacing:.12em;
      text-transform:uppercase;
      font-size: 12px;
      width: fit-content;
      white-space:nowrap;
      }
      .status-pill .s-dot{
      width:10px;height:10px;border-radius:99px;
      background: var(--pri);
      box-shadow: 0 0 16px rgba(34,211,238,.42);
      }
      .status-pill.ok{ border-color: rgba(52,211,153,.25); }
      .status-pill.ok .s-dot{ background: var(--ok); box-shadow: 0 0 16px rgba(52,211,153,.45); }
      .status-pill.warn{ border-color: rgba(251,191,36,.25); }
      .status-pill.warn .s-dot{ background: var(--warn); box-shadow: 0 0 16px rgba(251,191,36,.45); }
      .status-pill.bad{ border-color: rgba(251,113,133,.25); }
      .status-pill.bad .s-dot{ background: var(--bad); box-shadow: 0 0 16px rgba(251,113,133,.45); }
      .status-sub{
      color: var(--muted);
      font-size: 12px;
      font-weight:800;
      letter-spacing:.06em;
      line-height:1.35;
      min-width: 0;
      }
      /* ===== MAIN GRID (PHẢI CO ĐƯỢC) ===== */
      .hero-main{
      flex: 1 1 auto;
      min-height: 0;
      overflow: visible;
      display:grid;

      /* ✅ CHỐT CỨNG 30% */
      grid-template-columns: 30% 70%;

      gap: 12px;
      align-items: stretch;
      }



      /* ✅ TRÚNG: cột MÃ LÔ nhỏ lại để nhường chỗ cho GIÁ + TÊN */
      .hero.mode-win .hero-main{
      /* chọn 1 trong 2 cách dưới (mình khuyên cách A) */

      /* (A) CHỐT THEO % — đúng ý “cố định theo hero” */
      grid-template-columns: 24% 76%;

      /* (B) CHỐT THEO PX NHƯNG KHÔNG BAO GIỜ LẤY NỬA HERO */
      /* grid-template-columns: clamp(180px, 16vw, 240px) 1fr; */

      gap: 12px;
      }


      /* LEFT: LOT */
      .hero-lot{
      min-width:0;
      min-height:0;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      justify-content:flex-start;
      gap: 10px;
      padding: 14px 14px 10px 16px;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,.16);
      background: rgba(0,0,0,.14);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.15);
      container-type: inline-size; /* ✅ cho phép dùng cqw nếu browser hỗ trợ */

      }

      /* ✅ TRÚNG: MÃ LÔ vẫn to rõ nhưng giảm “chiếm chỗ” */
      .hero.mode-win .hero-lot{
      padding: 14px 14px 12px 16px;
      }

      .lot-kicker{
      font-size: 11px;
      font-weight: 900;
      letter-spacing:.14em;
      text-transform:uppercase;
      color: rgba(226,232,240,.82);
      opacity:.9;
      white-space:nowrap;
      }

      .lot-code{
      font-weight: 900;
      letter-spacing: .06em;
      text-transform: uppercase;

      /* ✅ cho phép xuống dòng tối đa 2 dòng */
      white-space: normal;
      word-break: break-word;
      overflow-wrap: anywhere;

      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;

      overflow: hidden;
      line-height: 0.92;

      /* ✅ fallback font (sẽ bị JS override theo ký tự + width) */
      font-size: clamp(44px, 9cqw, 92px);
      }


      /* ✅ TRÚNG: giảm thêm 1 nấc để chắc chắn đủ 6 ký tự */
      .hero.mode-win .lot-code{
      font-size: clamp(44px, 5.2vw, 68px);
      }


      .lot-name{ display:none !important; }
      .lot-desc{ display:block !important; }

      /* RIGHT: stack dọc */
      .hero-right{
      min-width:0;
      min-height:0;
      overflow:visible;
      display:flex;
      flex-direction:column;
      gap: 10px;
      }

      .hero-meta{
      flex: 0 0 auto;
      min-width:0;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap: 10px;
      align-items:stretch;
      }
      .hero-meta-tight{ gap: 10px; }

      .meta-row{
      display:flex; gap: 8px; align-items:center; justify-content:flex-end;
      flex-wrap:wrap;
      max-width: 100%;
      overflow: hidden;           /* ✅ không cho tràn ngang */


      }
      .meta-row{ justify-content:flex-start; }

      .pill{
      padding: 6px 10px;
      border:1px solid rgba(148,163,184,.20);
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      font-size: 11px;
      font-weight: 900;
      letter-spacing:.08em;
      text-transform:uppercase;
      color: rgba(226,232,240,.92);
      white-space:nowrap;
      max-width: 100%;
      overflow:hidden;
      text-overflow:ellipsis;
      }
      .pill.pri{ background: rgba(34,211,238,.10); border-color: rgba(34,211,238,.22); }
      .pill.ok{ background: rgba(52,211,153,.10); border-color: rgba(52,211,153,.22); }
      .pill.warn{ background: rgba(251,191,36,.10); border-color: rgba(251,191,36,.22); }
      .pill.bad{ background: rgba(251,113,133,.10); border-color: rgba(251,113,133,.22); }

      /* Price */
      .price-wrap{
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(0,0,0,.24);
      padding: 14px 14px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.15);
      overflow:visible;
      }
      .price-wrap-big{ padding: 16px 16px; }

      .price-label{
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: rgba(226,232,240,.85);
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom: 6px;
      white-space:nowrap;
      gap:10px;
      }
      .price-val{
      font-size: 46px;
      font-weight: 900;
      letter-spacing: .06em;
      text-transform: uppercase;
      line-height: 1.05;
      text-shadow: 0 0 22px rgba(34,211,238,.18);
      white-space: nowrap;
      text-align: right;
      overflow: visible;
      text-overflow: clip;
      display: block;
      position: relative;
      }
      .price-val-big{
      font-size: 46px;      /* ✅ GIÁ = 36 */
      line-height: 1.05;
      font-weight: 900;
      letter-spacing: .06em;
      white-space: nowrap;
      }



      /* ===== WINNER PANEL (TRÚNG: ưu tiên full name + STT cùng hàng) ===== */
      .winner-wrap{
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(0,0,0,.20);
      padding: 12px 14px;
      display:flex;
      flex-direction:column;
      gap: 8px;
      min-height: 110px;
      overflow:hidden;
      }
      .winner-wrap-compact{ min-height: 92px; padding: 12px 14px; }

      .winner-wrap.ok{ border-color: rgba(52,211,153,.25); background: rgba(52,211,153,.06); }
      .winner-wrap.warn{ border-color: rgba(251,191,36,.25); background: rgba(251,191,36,.06); }
      .winner-wrap.bad{ border-color: rgba(251,113,133,.25); background: rgba(251,113,133,.05); }

      /* ✅ Tên + STT xếp dọc để tên có đất */
      .winner-maincol{
      display:flex;
      flex-direction:column;
      gap: 10px;
      min-width:0;
      }

      .winner-sttrow{
      display:flex;
      justify-content:flex-end; /* STT nằm góc phải như trước nhưng xuống dòng */
      min-width:0;
      }

      .winner-topline{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      }
      .winner-label{
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: rgba(226,232,240,.85);
      white-space:nowrap;
      }
      .winner-badge{
      font-size: 10px;
      font-weight: 900;
      letter-spacing:.14em;
      text-transform:uppercase;
      padding: 4px 8px;
      border-radius:999px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(255,255,255,.04);
      white-space:nowrap;
      }
      .winner-badge.ok{ border-color: rgba(52,211,153,.26); background: rgba(52,211,153,.12); }
      .winner-badge.warn{ border-color: rgba(251,191,36,.26); background: rgba(251,191,36,.12); }
      .winner-badge.bad{ border-color: rgba(251,113,133,.26); background: rgba(251,113,133,.10); }

      /* ✅ hàng chính: TÊN (trái) + STT (phải) */
      .winner-mainrow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      min-width:0;
      }

      /* TÊN: ưu tiên hiển thị đủ hơn (cho 2 dòng khi cần) */
      .winner-name{
      position: relative;
      font-size: 40px;
      font-weight: 900;
      letter-spacing:.06em;
      text-transform: uppercase;

      /* ✅ 1 dòng, thiếu thì ... */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;

      min-width: 0;
      flex: 1 1 auto;
      }



      /* ===== HERO WINNER: attention pulse (không phụ thuộc poll) ===== */
      @keyframes heroAttnPulse{
      0%   { opacity: 1;   transform: translateZ(0) scale(1);    filter: saturate(1); }
      50%  { opacity: .82; transform: translateZ(0) scale(1.01); filter: saturate(1.12); }
      100% { opacity: 1;   transform: translateZ(0) scale(1);    filter: saturate(1); }
      }
      @keyframes heroShineSweep{
      0%   { transform: translateX(-120%) skewX(-18deg); opacity: 0; }
      10%  { opacity: .85; }
      50%  { opacity: .95; }
      90%  { opacity: .70; }
      100% { transform: translateX(140%) skewX(-18deg); opacity: 0; }
      }
      .winner-name::after{
      content:"";
      position:absolute;
      top:-35%;
      bottom:-35%;
      left:-40%;
      width: 55%;
      pointer-events:none;
      background: linear-gradient(
      90deg,
      rgba(255,255,255,0) 0%,
      rgba(255,255,255,.10) 28%,
      rgba(255,255,255,.52) 50%,
      rgba(255,255,255,.12) 72%,
      rgba(255,255,255,0) 100%
      );
      filter: blur(.2px);
      mix-blend-mode: screen;
      opacity: 0;
      transform: translateX(-120%) skewX(-18deg);
      animation: heroShineSweep 2.6s ease-in-out infinite;
      animation-delay: .25s;
      }
      .hero-attn{ animation: heroAttnPulse 1.8s ease-in-out infinite; }

      .winner-wrap.ok .winner-name{
      text-shadow:
      0 0 18px rgba(52,211,153,.28),
      0 0 44px rgba(52,211,153,.16),
      0 0 26px rgba(34,211,238,.14);
      }
      .winner-wrap.ok .winner-name::after{
      background: linear-gradient(
      90deg,
      rgba(255,255,255,0) 0%,
      rgba(52,211,153,.10) 26%,
      rgba(255,255,255,.62) 50%,
      rgba(34,211,238,.18) 72%,
      rgba(255,255,255,0) 100%
      );
      opacity: .95;
      }

      /* ===== STT: đổi thành “pill” nhỏ nằm cạnh tên (chỉ hiện khi TRÚNG) ===== */
      .winner-sttbox{
      display:none;                 /* default ẩn */
      flex: 0 0 auto;
      border-radius: 999px;
      border: 1px solid rgba(52,211,153,.28);
      background: rgba(52,211,153,.10);
      padding: 10px 14px;
      overflow:hidden;
      box-shadow: 0 0 18px rgba(52,211,153,.16);
      }
      .winner-sttbox .sttline{
      display:flex;
      align-items:baseline;
      gap: 10px;
      white-space:nowrap;
      }
      .winner-sttbox .stt-lbl{
      font-size: 10px;
      font-weight: 900;
      letter-spacing:.16em;
      text-transform:uppercase;
      color: rgba(148,163,184,.78);
      }
      .winner-sttbox .stt-val{
      font-size: clamp(24px, 2.4vw, 34px);
      font-weight: 900;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: rgba(226,232,240,.98);
      text-shadow:
      0 0 14px rgba(52,211,153,.22),
      0 0 26px rgba(52,211,153,.12);
      white-space: nowrap;
      }

      /* STT box cũng pulse nhẹ */
      .winner-wrap.ok .winner-sttbox.hero-attn{
      box-shadow: 0 0 22px rgba(52,211,153,.14);
      }

      /* responsive: nhỏ thì stack 1 cột */
      @media (max-width: 1220px){
      .center{ grid-template-rows: minmax(260px, 0.60fr) minmax(220px, 0.40fr); }
      .hero-main{ grid-template-columns: 1fr; }
      .price-val-big{ font-size: 48px; }
      .winner-mainrow{ align-items:flex-start; }
      .winner-sttbox{ padding: 10px 12px; }
      }

      /* Mask / Reveal */
      .masked{ filter: blur(11px); opacity: .18; transform: translateZ(0); }
      .reveal{ filter: blur(0); opacity: 1; transition: filter .6s ease, opacity .6s ease; }
      .caret{
      display:inline-block;
      width:10px;
      animation: caretblink .8s infinite;
      opacity:.85;
      margin-left:2px;
      }
      @keyframes caretblink{ 50%{ opacity:.15; } }
      /* ===== HERO NEXT: FULL WIDTH (only show when NEXT_ROUND) ===== */
      #heroNextWrap{
      width:100%;
      margin-top:10px;

      /* ⬆️ tăng chiều cao tổng box */
      padding: 14px 16px;

      border-radius: 18px;
      border: 1px solid rgba(251,191,36,.20);
      background: rgba(251,191,36,.06);
      overflow:hidden;

      display:flex;
      align-items:center;   /* ✅ ticker nằm giữa dọc */
      }

      /* đảm bảo track chạy ngang mượt */
      #heroNextWrap .marquee{
      overflow:hidden;
      white-space:nowrap;
      }
      #heroNextWrap .track{
      display:inline-block;
      will-change: transform;
      }
      .marquee{ position:relative; overflow:hidden; white-space:nowrap; }
      .marquee .track{ display:inline-block; will-change: transform; }
      .marquee-item{
      display:inline-flex;
      align-items:center;
      gap: 12px;

      margin-right: 22px;

      /* ⬆️ CHIP TO HƠN */
      padding: 12px 18px;
      height: 44px;

      border-radius: 999px;
      border: 1px solid rgba(251,191,36,.35);
      background: rgba(251,191,36,.12);

      font-weight: 900;
      font-size: 16px;          /* ⬅ TO RÕ */
      letter-spacing:.10em;
      text-transform:uppercase;
      white-space:nowrap;

      box-shadow: 0 0 14px rgba(251,191,36,.22);
      }

      .marquee-item .m-stt{
      color: var(--warn);
      font-size: 14px;
      letter-spacing:.16em;
      }

      .marquee-item .m-name{
      color: rgba(226,232,240,.95);
      font-size: 16px;
      }

      .marquee-item .m-idx{
      font-weight: 700;                  /* nhẹ hơn STT */
      font-size: 13px;
      letter-spacing: .08em;

      padding: 0;                        /* ❌ không pill */
      border: none;
      background: transparent;           /* ❌ không nền */
      box-shadow: none;

      color: rgba(148,163,184,.70);      /* xám nhạt – không tranh spotlight */
      white-space: nowrap;
      flex: 0 0 auto;
      }



      /* recent strip */
      .recent{
      height: 100%;
      min-height: 0;
      overflow: hidden;
      display: flex;            /* ✅ */
      flex-direction: column;   /* ✅ */
      }
      /* ===== RECENT HEADER – gọn & cao cấp ===== */
      .recent .head{
      padding: 8px 12px 6px 12px;   /* thấp lại */
      border-bottom: 1px solid rgba(148,163,184,.12);
      display:flex;
      align-items:center;
      justify-content:flex-start;  /* không cần space-between */
      background: transparent;     /* bỏ nền tối */
      }
      .recent .head .h-title{
      font-size: 12px;
      font-weight: 900;
      letter-spacing: .16em;
      text-transform: uppercase;
      color: rgba(226,232,240,.9);
      }
      .recent-body{
      padding: 10px;
      padding-bottom: 14px;
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      flex: 1 1 auto;   /* ✅ */
      min-height: 0;    /* ✅ */
      height: auto;     /* ✅ thay vì height:100% */
      }
      /* Recent cards: show lot + price + winner name clearly */
      .rslot{
      border: 1px solid rgba(148,163,184,.16);
      border-radius: 16px;
      background: rgba(0,0,0,.14);
      padding: 10px 10px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      gap: 8px;
      position:relative;
      min-height:0;
      }
      .rslot.win{ border-color: rgba(52,211,153,.22); background: rgba(52,211,153,.05); }
      .rslot.next{ border-color: rgba(251,191,36,.22); background: rgba(251,191,36,.05); }
      .rslot.no{ border-color: rgba(251,113,133,.20); background: rgba(251,113,133,.045); }
      /* ===== RECENT: LOT CODE PHẢI LÀ MINI-HERO ===== */
      .rslot .lc{
      font-size: 34px;              /* ⬅ TO HƠN RÕ RỆT */
      font-weight: 900;
      letter-spacing: .14em;
      line-height: 1.05;
      margin-bottom: 6px;           /* kéo nội dung lên */
      text-shadow: 0 0 22px rgba(34,211,238,.22);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      }
      .badge-rt{
      position:absolute;
      top:10px; right:10px;
      font-size: 10px;
      font-weight: 900;
      letter-spacing:.12em;
      text-transform:uppercase;
      padding: 4px 8px;
      border-radius:999px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(255,255,255,.04);
      white-space:nowrap;
      }
      .badge-rt.win{ background: rgba(52,211,153,.12); border-color: rgba(52,211,153,.25); }
      .badge-rt.next{ background: rgba(251,191,36,.12); border-color: rgba(251,191,36,.25); }
      .badge-rt.no{ background: rgba(251,113,133,.10); border-color: rgba(251,113,133,.22); }
      .minirow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size: 11px;
      font-weight: 900;
      letter-spacing:.10em;
      text-transform:uppercase;
      color: rgba(226,232,240,.86);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      }
      .minirow .mini-badge{
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(255,255,255,.04);
      color: rgba(226,232,240,.92);
      flex: 0 0 auto;
      max-width: 65%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      }
      .minirow .mini-badge.win{ border-color: rgba(52,211,153,.25); background: rgba(52,211,153,.10); }
      .minirow .mini-badge.next{ border-color: rgba(251,191,36,.25); background: rgba(251,191,36,.10); }
      .minirow .mini-badge.no{ border-color: rgba(251,113,133,.25); background: rgba(251,113,133,.08); }
      .rslot .rv{
      margin-top:auto;
      display:flex;
      flex-direction:column;
      gap: 6px;
      align-items:center;
      justify-content:flex-end;
      text-align:center;
      padding-top: 4px;
      }
      .rslot .price{
      font-weight: 900;
      letter-spacing:.05em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 100%;
      font-size: 28px;
      line-height: 1.05;
      text-shadow: 0 0 22px rgba(34,211,238,.18);
      }
      .rslot .who{
      font-weight: 900;
      font-size: 14px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color: rgba(226,232,240,.92);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 100%;
      }
      .rslot .who .stt{
      color: rgba(226,232,240,.88);
      opacity:.95;
      }
      /* ===== RECENT: winner line đẹp như mẫu (STT pill + Tên) ===== */
      .rslot .who-line{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width:0;
      }
      .rslot .stt-pill{
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid rgba(52,211,153,.35);
      background: rgba(52,211,153,.14);
      font-weight: 900;
      font-size: 12px;
      letter-spacing: .12em;
      text-transform: uppercase;
      white-space: nowrap;
      box-shadow: 0 0 14px rgba(52,211,153,.25);
      flex: 0 0 auto;
      }
      .rslot .winner-name{
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .08em;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width:0;
      }
      /* Giá to hơn trong card recent */
      .rslot .price-big{
      margin-top:auto;
      font-weight: 900;
      letter-spacing:.06em;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-size: 34px;
      line-height: 1.05;
      text-shadow: 0 0 22px rgba(34,211,238,.18);
      }
      /* NEXT: pill số khách */
      .rslot .next-pill{
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(251,191,36,.30);
      background: rgba(251,191,36,.12);
      font-weight: 900;
      font-size: 12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      white-space:nowrap;
      flex: 0 0 auto;
      }
      /* RIGHT: next lots cards ticker */
      .right-body{
      padding: 10px;
      height: 100%;
      min-height:0;
      }
      .cards-viewport{
      position:relative;
      height:100%;
      overflow:hidden;
      }
      .cards-inner{
      position:absolute;
      left:0; right:0; top:0;
      will-change: transform;
      }
      .lotcard{
      padding: 10px;
      border: 1px solid rgba(148,163,184,.16);
      border-radius: 16px;
      background: rgba(0,0,0,.14);
      margin-bottom: 10px;
      overflow:hidden;
      }
      .lotcard.next{ border-color: rgba(251,191,36,.22); background: rgba(251,191,36,.05); }
      .lotcard.win{ border-color: rgba(52,211,153,.22); background: rgba(52,211,153,.05); }
      .lotcard .top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom: 8px;
      }
      .lotcard .code{
      font-weight: 900;
      font-size: 18px;
      letter-spacing:.12em;
      text-transform:uppercase;
      text-shadow: 0 0 18px rgba(34,211,238,.14);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 70%;
      }
      .lotcard .flag{
      font-weight: 900;
      font-size: 10px;
      letter-spacing:.14em;
      text-transform:uppercase;
      padding: 4px 8px;
      border-radius:999px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(255,255,255,.04);
      color: rgba(226,232,240,.92);
      white-space:nowrap;
      flex: 0 0 auto;
      }
      .lotcard .flag.win{
      border-color: rgba(52,211,153,.25);
      background: rgba(52,211,153,.12);
      }
      .lotcard .flag.next{
      border-color: rgba(251,191,36,.25);
      background: rgba(251,191,36,.12);
      color: rgba(226,232,240,.95);
      }
      .lotcard .flag.no{
      border-color: rgba(251,113,133,.25);
      background: rgba(251,113,133,.10);
      }
      .lotcard .mid{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 8px;
      min-width:0;
      }
      .lotcard .meta{
      display:flex;
      flex-wrap:wrap;
      gap: 6px;
      min-width:0;
      max-width: 78%;
      }
      .lotcard .meta .pill{
      padding: 5px 8px;
      font-size: 10px;
      border-radius: 999px;
      border-color: rgba(148,163,184,.18);
      background: rgba(255,255,255,.04);
      max-width: 100%;
      }
      .lotcard .meta .pill.warn{ border-color: rgba(251,191,36,.25); background: rgba(251,191,36,.10); }
      .lotcard .meta .pill.ok{ border-color: rgba(52,211,153,.25); background: rgba(52,211,153,.10); }
      .lotcard .meta .pill.bad{ border-color: rgba(251,113,133,.25); background: rgba(251,113,133,.08); }
      .lotcard .countbox{
      text-align:right;
      flex: 0 0 auto;
      min-width: 64px;
      }
      .lotcard .count{
      font-weight: 900;
      font-size: 26px;
      letter-spacing:.08em;
      white-space:nowrap;
      }
      .lotcard.next .count{ color: var(--warn); text-shadow: 0 0 18px rgba(251,191,36,.18); }
      .lotcard.win .count{ color: var(--ok); text-shadow: 0 0 18px rgba(52,211,153,.18); }
      .lotcard .sub{
      margin-top: 2px;
      color: var(--muted);
      font-size: 11px;
      font-weight: 900;
      letter-spacing:.10em;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      }
      /* ===== RIGHT CARD NEW LAYOUT (WIN / NEXT) ===== */
      .lotcard .row2{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin: 6px 0 6px 0;
      }
      .lotcard .pricebig{
      font-weight: 900;
      font-size: 22px;
      letter-spacing:.06em;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-shadow: 0 0 18px rgba(34,211,238,.16);
      }
      .lotcard .winnerline{
      margin-top: 6px;
      padding-top: 8px;
      border-top: 1px solid rgba(148,163,184,.12);
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
      }
      .lotcard .winnerline .wstt{
      font-weight: 900;
      font-size: 11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid rgba(52,211,153,.26);
      background: rgba(52,211,153,.10);
      white-space:nowrap;
      flex: 0 0 auto;
      }
      .lotcard .winnerline .wname{
      font-weight: 900;
      font-size: 13px;
      letter-spacing:.06em;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
      }
      /* NEXT: countbox đặt góc phải dưới rõ ràng hơn */
      .lotcard .countbox{
      text-align:right;
      flex: 0 0 auto;
      min-width: 78px;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      justify-content:flex-end;
      gap: 2px;
      }
      .lotcard .sub{ opacity:.9; }
      /* NEW: next-customer list inside right cards */
      .nlist{
      margin-top: 6px;
      padding-top: 8px;
      border-top: 1px solid rgba(148,163,184,.12);
      display:flex;
      flex-direction:column;
      gap: 6px;
      }
      .nrow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 7px 8px;
      border-radius: 12px;
      border: 1px solid rgba(251,191,36,.18);
      background: rgba(251,191,36,.06);
      overflow:hidden;
      }
      .nrow .nleft{
      display:flex;
      align-items:center;
      gap: 8px;
      min-width:0;
      }
      .nrow .nstt{
      font-weight: 900;
      letter-spacing:.14em;
      font-size: 11px;
      color: rgba(226,232,240,.95);
      border: 1px solid rgba(251,191,36,.22);
      background: rgba(251,191,36,.10);
      padding: 3px 7px;
      border-radius: 999px;
      white-space:nowrap;
      }
      .nrow .nname{
      font-weight: 900;
      letter-spacing:.06em;
      font-size: 12px;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
      }
      .nrow .ntail{
      font-weight: 900;
      font-size: 10px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: rgba(226,232,240,.8);
      white-space:nowrap;
      flex: 0 0 auto;
      }
      /* footer marquee */
      .footer{
      margin-top: 0px;
      border: 1px solid rgba(148,163,184,.14);
      border-radius: 16px;
      background: rgba(0,0,0,.18);
      padding: 8px 10px;
      overflow:hidden;
      position:relative;
      box-shadow: var(--shadow);
      }
      .footer .marquee{
      font-weight: 900;
      letter-spacing:.10em;
      text-transform:uppercase;
      font-size: 11px;
      color: rgba(226,232,240,.82);
      }
      /* ===== Footer marquee: brand đẹp + chuyên nghiệp ===== */
      .footer-item{
      display:inline-flex;
      align-items:center;
      gap: 12px;
      padding-right: 44px;  /* khoảng cách giữa các block lặp */
      white-space: nowrap;
      }
      .ft-label{
      opacity:.70;
      font-weight:800;
      letter-spacing:.16em;
      }
      .ft-sep{
      opacity:.35;
      }
      .ft-brand{
      font-weight:900;
      letter-spacing:.08em;
      color: var(--ok);
      text-shadow: 0 0 14px rgba(52,211,153,.30);
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(52,211,153,.28);
      background: rgba(52,211,153,.10);
      }
      .ft-desc{
      opacity:.88;
      font-weight:800;
      letter-spacing:.06em;
      }
      /* =========================
      TOAST OVERLAY + TOAST (NEW)
      - Không nền đen cho toast
      - Overlay tinted + blur vẫn giữ focus
      - Giữ nguyên font-size hiện có
      ========================= */

      /* TOAST OVERLAY (tinted, không đen đặc) */
      .toast-overlay{
      position: fixed;
      inset: 0;

      /* ✅ overlay có màu (không đen): hơi xanh tím + glow ok/warn */
      background:
      radial-gradient(900px 520px at 50% 35%, rgba(34,211,238,.14), transparent 60%),
      radial-gradient(860px 520px at 70% 55%, rgba(52,211,153,.14), transparent 62%),
      radial-gradient(860px 520px at 30% 55%, rgba(251,191,36,.12), transparent 62%),
      linear-gradient(180deg, rgba(7,10,18,.52), rgba(10,16,34,.62));

      backdrop-filter: blur(14px);
      z-index: 48;
      display:none;
      }
      .toast-overlay.show{ display:block; }

      /* toast (center big) — AUTO FIT CONTENT */
      .toast{
      position: fixed;
      left: 50%;
      top: 50%;
      bottom: auto;
      z-index: 50;

      display: inline-flex;
      flex-direction: column;
      width: max-content;
      max-width: calc(100vw - 56px);
      max-height: calc(100vh - 70px);

      border-radius: 32px;
      overflow: hidden;

      transform: translate(-50%, -50%) scale(.95);
      opacity: 0;
      pointer-events: none;
      transition: opacity .22s ease, transform .22s ease;

      /* ✅ hệ màu mặc định (sẽ override theo ok/warn/bad) */
      --toast-bg: rgba(245, 250, 255, .12);
      --toast-bg2: rgba(255,255,255,.08);
      --toast-fg: rgba(245, 248, 255, .96);
      --toast-muted: rgba(226,232,240,.82);     /* ✅ chữ phụ dễ đọc */
      --toast-muted2: rgba(148,163,184,.78);    /* label phụ nhạt hơn chút nhưng không chìm */
      --toast-border: rgba(148,163,184,.22);
      --toast-glow: 0 0 80px rgba(34,211,238,.16);
      --toast-accent: var(--pri);
      --toast-accent2: rgba(34,211,238,.22);

      border: 1px solid var(--toast-border);

      /* ✅ nền toast dạng glass sáng, không đen */
      background:
      radial-gradient(1200px 520px at 50% 0%, rgba(255,255,255,.12), transparent 60%),
      linear-gradient(180deg, var(--toast-bg), var(--toast-bg2));

      box-shadow: var(--shadow), var(--toast-glow);
      backdrop-filter: blur(16px);
      }

      .toast.show{
      opacity: 1;
      transform: translate(-50%, -50%) scale(1.12);
      }

      /* Header */
      .toast .t-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 18px 20px;

      border-bottom: 1px solid rgba(255,255,255,.10);

      /* ✅ header sáng hơn, rõ chữ */
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));

      font-weight: 900;
      letter-spacing:.14em;
      text-transform:uppercase;
      font-size: 15px; /* ✅ giữ nguyên */
      color: var(--toast-fg);
      min-width: 0;
      }

      .toast .t-head .badge{
      font-size: 12px; /* ✅ giữ nguyên */
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);

      /* ✅ badge rõ ràng theo accent */
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      color: var(--toast-fg);
      white-space:nowrap;
      box-shadow: 0 0 18px rgba(0,0,0,.18);
      }

      /* Body */
      .toast .t-body{
      padding: 22px 22px 26px 22px;
      display:flex;
      flex-direction:column;
      gap: 16px;
      text-align:center;

      width: max-content;
      max-width: calc(100vw - 56px);
      }

      /* line1 */
      .toast .line1{
      font-weight: 900;
      font-size: 18px; /* ✅ giữ nguyên */
      letter-spacing: .14em;
      text-transform: uppercase;

      /* ✅ sáng hơn để dễ đọc trên glass */
      color: var(--toast-muted);

      width: max-content;
      max-width: calc(100vw - 56px);
      }

      /* Lines 2-4: label + value */
      .toast .line2, .toast .line3, .toast .line4{
      display:flex;
      align-items:baseline;
      justify-content:center;
      gap: 14px;

      width: max-content;
      max-width: calc(100vw - 56px);

      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      }

      /* ✅ LABEL (chữ phụ như MÃ LÔ / STT / VÀO VÒNG TIẾP...) */
      .toast .k-lbl{
      font-size: 14px; /* ✅ giữ nguyên */
      font-weight: 900;
      letter-spacing: .16em;
      text-transform: uppercase;

      /* ✅ tăng tương phản label phụ */
      color: var(--toast-muted2);
      opacity: 1;

      flex: 0 0 auto;
      min-width: 120px;
      text-align: right;
      }

      /* ✅ VALUE */
      .toast .k-val{
      font-weight: 900;
      text-transform: uppercase;
      color: var(--toast-fg);
      letter-spacing: .10em;

      /* ✅ glow nhẹ để dễ đọc */
      text-shadow: 0 0 22px rgba(34,211,238,.14);

      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: calc(100vw - 280px);
      }

      /* spotlight: MÃ LÔ */
      .toast .k-val.lot{
      font-size: clamp(74px, 7.2vw, 118px); /* ✅ giữ nguyên */
      letter-spacing: .14em;

      /* ✅ đổi glow phù hợp nền sáng */
      text-shadow:
      0 0 18px rgba(0,0,0,.22),
      0 0 34px rgba(34,211,238,.18);

      width: max-content;
      max-width: calc(100vw - 56px);
      }

      /* spotlight: TÊN KHÁCH */
      .toast .k-val.name{
      font-size: clamp(40px, 4.0vw, 68px); /* ✅ giữ nguyên */
      letter-spacing: .10em;
      text-align:center;

      text-shadow:
      0 0 18px rgba(0,0,0,.20),
      0 0 26px rgba(96,165,250,.14);

      width: max-content;
      max-width: calc(100vw - 56px);
      }

      /* giá */
      .toast .k-val.price{
      font-size: clamp(48px, 4.8vw, 86px); /* ✅ giữ nguyên */
      letter-spacing: .08em;

      text-shadow:
      0 0 18px rgba(0,0,0,.20),
      0 0 26px rgba(34,211,238,.14);

      width: max-content;
      max-width: calc(100vw - 56px);
      }

      .toast .line5{
      margin-top: 6px;
      display:flex;
      justify-content:center;
      }

      /* ✅ pill STT/SỐ KHÁCH: vẫn giữ font-size, chỉ đổi màu để hợp nền */
      .pillbig{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;

      font-size: clamp(34px, 3.2vw, 62px); /* ✅ giữ nguyên */
      letter-spacing:.10em;
      text-transform:uppercase;
      padding: 14px 26px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);

      /* ✅ nền pill sáng hơn + chữ rõ */
      background: rgba(255,255,255,.10);
      color: var(--toast-fg);

      box-shadow: 0 0 18px rgba(0,0,0,.18);
      white-space:nowrap;

      max-width: calc(100vw - 56px);
      overflow: hidden;
      text-overflow: ellipsis;
      }

      /* =========================
      THEME PER TYPE
      ========================= */

      /* OK (TRÚNG) */
      .toast.ok{
      --toast-accent: var(--ok);
      --toast-border: rgba(52,211,153,.30);
      --toast-glow: 0 0 72px rgba(52,211,153,.18);

      /* nền glass hơi xanh ngọc (vui tươi) */
      --toast-bg: rgba(52,211,153,.13);
      --toast-bg2: rgba(255,255,255,.08);

      --toast-muted2: rgba(236,253,245,.82);  /* ✅ label phụ rõ trên nền ok */
      }
      .toast.ok .t-head{
      background: linear-gradient(180deg, rgba(52,211,153,.22), rgba(255,255,255,.06));
      }
      .toast.ok .t-head .badge{
      border-color: rgba(52,211,153,.30);
      background: rgba(52,211,153,.16);
      box-shadow: 0 0 18px rgba(52,211,153,.18);
      }

      /* WARN (VÒNG SAU) */
      .toast.warn{
      --toast-accent: var(--warn);
      --toast-border: rgba(251,191,36,.30);
      --toast-glow: 0 0 72px rgba(251,191,36,.16);

      /* nền glass hơi vàng ấm */
      --toast-bg: rgba(251,191,36,.13);
      --toast-bg2: rgba(255,255,255,.08);

      --toast-muted2: rgba(255,251,235,.84);  /* ✅ label phụ rõ trên nền warn */
      }
      .toast.warn .t-head{
      background: linear-gradient(180deg, rgba(251,191,36,.22), rgba(255,255,255,.06));
      }
      .toast.warn .t-head .badge{
      border-color: rgba(251,191,36,.30);
      background: rgba(251,191,36,.16);
      box-shadow: 0 0 18px rgba(251,191,36,.16);
      }

      /* BAD (nếu có) */
      .toast.bad{
      --toast-accent: var(--bad);
      --toast-border: rgba(251,113,133,.30);
      --toast-glow: 0 0 72px rgba(251,113,133,.14);

      --toast-bg: rgba(251,113,133,.11);
      --toast-bg2: rgba(255,255,255,.08);

      --toast-muted2: rgba(255,241,242,.84);
      }
      .toast.bad .t-head{
      background: linear-gradient(180deg, rgba(251,113,133,.18), rgba(255,255,255,.06));
      }
      .toast.bad .t-head .badge{
      border-color: rgba(251,113,133,.30);
      background: rgba(251,113,133,.14);
      box-shadow: 0 0 18px rgba(251,113,133,.14);
      }

      /* ✅ k-val glow theo type (giúp chữ chính rõ hơn trên nền sáng) */
      .toast.ok .k-val{ text-shadow: 0 0 22px rgba(52,211,153,.18); }
      .toast.warn .k-val{ text-shadow: 0 0 22px rgba(251,191,36,.16); }
      .toast.bad .k-val{ text-shadow: 0 0 22px rgba(251,113,133,.14); }

      /* ✅ pillbig theo type (JS đang set inline vẫn OK; CSS này là fallback khi không set) */
      .toast.ok  .pillbig{ border-color: rgba(52,211,153,.30); background: rgba(52,211,153,.16); box-shadow: 0 0 22px rgba(52,211,153,.18); }
      .toast.warn .pillbig{ border-color: rgba(251,191,36,.30); background: rgba(251,191,36,.16); box-shadow: 0 0 22px rgba(251,191,36,.16); }
      .toast.bad  .pillbig{ border-color: rgba(251,113,133,.30); background: rgba(251,113,133,.14); box-shadow: 0 0 22px rgba(251,113,133,.14); }

      /* =========================
      HIỆU ỨNG CHÚC MỪNG (OK)
      - Không sửa HTML: dùng pseudo-elements
      ========================= */

      /* pop + shimmer nhẹ */
      @keyframes toastWinPop{
      0%   { transform: translate(-50%, -50%) scale(.92); filter: saturate(1); }
      55%  { transform: translate(-50%, -50%) scale(1.14); filter: saturate(1.15); }
      100% { transform: translate(-50%, -50%) scale(1.12); filter: saturate(1.05); }
      }
      @keyframes toastShine{
      0%   { transform: translateX(-120%) skewX(-18deg); opacity: 0; }
      12%  { opacity: .85; }
      55%  { opacity: .95; }
      100% { transform: translateX(140%) skewX(-18deg); opacity: 0; }
      }

      /* confetti nhẹ (điểm sáng bay) */
      @keyframes confettiFloat{
      0%   { transform: translateY(0px); opacity: 0; }
      15%  { opacity: .95; }
      100% { transform: translateY(90px); opacity: 0; }
      }

      /* áp vào toast OK khi show */
      .toast.ok.show{
      animation: toastWinPop .34s ease-out both;
      }

      /* lớp shine quét ngang */
      .toast.ok::before{
      content:"";
      position:absolute;
      inset: 0;
      pointer-events:none;
      background:
      linear-gradient(90deg,
      rgba(255,255,255,0) 0%,
      rgba(255,255,255,.10) 28%,
      rgba(255,255,255,.44) 50%,
      rgba(255,255,255,.10) 72%,
      rgba(255,255,255,0) 100%);
      opacity: 0;
      transform: translateX(-120%) skewX(-18deg);
      }
      .toast.ok.show::before{
      opacity: .9;
      animation: toastShine 1.2s ease-in-out 1;
      }

      /* confetti dots (nhẹ, không rối) */
      .toast.ok::after{
      content:"";
      position:absolute;
      left: 0; right: 0; top: 0;
      height: 120px;
      pointer-events:none;

      /* các chấm sáng rải đều */
      background:
      radial-gradient(circle at 12% 20%, rgba(255,255,255,.85) 0 2px, transparent 3px),
      radial-gradient(circle at 22% 55%, rgba(52,211,153,.90) 0 2px, transparent 3px),
      radial-gradient(circle at 35% 30%, rgba(34,211,238,.85) 0 2px, transparent 3px),
      radial-gradient(circle at 48% 18%, rgba(255,255,255,.85) 0 2px, transparent 3px),
      radial-gradient(circle at 62% 42%, rgba(52,211,153,.90) 0 2px, transparent 3px),
      radial-gradient(circle at 74% 24%, rgba(34,211,238,.85) 0 2px, transparent 3px),
      radial-gradient(circle at 86% 52%, rgba(255,255,255,.85) 0 2px, transparent 3px);

      opacity: 0;
      }
      .toast.ok.show::after{
      opacity: 1;
      animation: confettiFloat 1.0s ease-out 1;
      }

      /* responsiveness (giữ nguyên layout chính, chỉ giảm scale chút như cũ) */
      @media (max-width: 1060px){
      .main{ grid-template-columns: 1fr; }
      body{ overflow:auto; }
      .stage{ height:auto; min-height:100vh; }
      .center{ order: 1; }

      .toast{
      max-width: calc(100vw - 40px);
      }
      .toast .t-body{
      max-width: calc(100vw - 40px);
      }
      .toast.show{
      transform: translate(-50%, -50%) scale(1.06);
      }
      }



    </style>
  </head>
  <body class="gridbg scan">
    <button class="soundbtn" id="soundBtn" type="button" title="Âm thanh: Bật/Tắt">
      <span class="sr-only">Âm thanh</span>
      <span class="ico" id="soundIco">🔊</span>
    </button>
    <div class="stage" id="stage">
      <!-- TOP BAR -->
      <div class="topbar">
        <div class="top-left">
          <div class="brand-title">TRÌNH CHIẾU KIỂM PHIẾU</div>
          <div class="brand-row">
            <span class="pill" id="companyName" title=""></span>
            <span class="pill soft blue" id="sessionCode" title=""></span>
          </div>
        </div>
        <div class="top-mid">
          <div class="wrap">
            <div class="project-name" id="projectName" title=""></div>
            <div class="subline" id="roundLine">VÒNG 1 • TRẠNG THÁI ĐANG KIỂM</div>
          </div>
        </div>
        <div class="top-right">
          <div class="kpis">
            <div class="kpi pri">
              <div class="label">TỔNG LÔ</div>
              <div class="val" id="kpiTotalLots">0</div>
            </div>
            <div class="kpi ok">
              <div class="label">TRÚNG</div>
              <div class="val" id="kpiWon">0</div>
            </div>
            <div class="kpi warn">
              <div class="label">VÒNG SAU</div>
              <div class="val" id="kpiNext">0</div>
            </div>
            <div class="kpi bad">
              <div class="label">CHƯA CÓ</div>
              <div class="val" id="kpiPending">0</div>
            </div>
          </div>
          <button class="fsbtn" id="fsBtn" type="button" title="Toàn màn hình">
            <span class="sr-only">Toàn màn hình</span>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M8 3H5a2 2 0 0 0-2 2v3"/>
              <path d="M16 3h3a2 2 0 0 1 2 2v3"/>
              <path d="M8 21H5a2 2 0 0 1-2-2v-3"/>
              <path d="M16 21h3a2 2 0 0 0 2-2v-3"/>
            </svg>
          </button>
        </div>
      </div>
      <!-- MAIN -->
      <div class="main">
        <!-- LEFT -->
        <div class="panel">
          <div class="head">
            <div class="h-title">DANH SÁCH KHÁCH</div>
            <div class="h-badge" id="leftHint">TỰ ĐỘNG</div>
          </div>
          <div class="left-body">
            <div class="box won">
              <div class="box-head">
                <div class="t">TRÚNG</div>
                <span class="tag ok" id="wonCountTag">0</span>
              </div>
              <div class="box-body">
                <div class="ticker-viewport">
                  <div class="ticker-inner" id="wonTicker"></div>
                </div>
              </div>
            </div>
            <div class="box next">
              <div class="box-head">
                <div class="t">VÀO VÒNG SAU</div>
                <span class="tag warn" id="nextCountTag">0</span>
              </div>
              <div class="box-body">
                <div class="ticker-viewport">
                  <div class="ticker-inner" id="nextTicker"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- CENTER -->
        <div class="center">
          <!-- HERO -->
          <div class="hero">
            <div class="hero-inner">
              <div class="hero-top">
                <!-- STATUS FULL WIDTH -->
                <div class="hero-status hero-statusbar">
                  <div class="status-pill pri" id="statusPill">
                    <span class="s-dot" id="statusDot"></span>
                    <span id="statusText">ĐANG KIỂM</span>
                  </div>
                  <div class="status-sub" id="statusSub">
                    Hệ thống đang cập nhật kết quả theo thời gian thực.
                  </div>
                </div>
                <!-- MAIN GRID -->
                <div class="hero-main">
                  <!-- LEFT: LOT -->
                  <div class="hero-lot hero-lot-left">
                    <div class="lot-kicker" id="heroLotKicker">MÃ LÔ</div>
                    <div class="lot-code" id="heroLotCode">—</div>
                    <!-- giữ element để JS không lỗi, nhưng sẽ ẩn bằng CSS -->
                    <div class="lot-name" id="heroLotName">—</div>
                    <div class="lot-desc" id="heroLotDesc">—</div>
                  </div>
                  <!-- RIGHT: PRICE + WINNER (TRÚNG giữ như cũ) -->
                  <div class="hero-right">
                    <div class="hero-meta hero-meta-tight">
                      <div class="meta-row">
                        <span class="pill pri" id="heroBadge1">KẾT QUẢ MỚI</span>
                        <span class="pill soft" id="heroBadge2">#—</span>
                      </div>
                      <div class="price-wrap price-wrap-big">
                        <div class="price-label">
                          <span id="priceLabel">GIÁ CAO NHẤT</span>
                          <span class="pill soft" id="priceUnit">VNĐ</span>
                        </div>
                        <div class="price-val price-val-big" id="heroPrice">—</div>
                      </div>
                      <div class="winner-wrap bad winner-wrap-compact" id="winnerWrap">
                        <div class="winner-topline">
                          <div class="winner-label" id="winnerLabel">NGƯỜI TRÚNG</div>
                          <div class="winner-badge bad" id="winnerBadge">CHƯA CÓ</div>
                        </div>

                        <!-- ✅ TRÚNG: TÊN + STT cùng hàng -->

                        <div class="winner-maincol">
                          <div class="winner-name masked" id="winnerName">—<span class="caret">|</span></div>

                          <div class="winner-sttrow">
                            <div class="winner-sttbox masked" id="heroWinnerSttBox">
                              <div class="sttline">
                                <span class="stt-lbl">SỐ THỨ TỰ</span>
                                <span class="stt-val" id="heroWinnerSttVal">—</span>
                              </div>
                            </div>
                          </div>
                        </div>

                      </div>

                    </div>
                  </div>
                </div>
                <!-- ✅ NEXT LIST FULL WIDTH (nằm NGANG full phía dưới hero-main) -->
                <div class="next-wrap warn hero-next-full" id="heroNextWrap">
                  <div class="marquee" id="nextMarquee">
                    <div class="track" id="nextTrack"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- RECENT -->
          <div class="recent">
            <div class="head">
              <div class="h-title">KẾT QUẢ GẦN NHẤT</div>
            </div>
            <div class="recent-body" id="recentBody"></div>
          </div>
        </div>
        <!-- RIGHT -->
        <div class="panel">
          <div class="head">
            <div class="h-title">LÔ ĐÃ KIỂM</div>
            <div class="h-badge" id="rightHint">THEO MÃ LÔ</div>
          </div>
          <div class="right-body">
            <div class="cards-viewport">
              <div class="cards-inner" id="lotCards"></div>
            </div>
          </div>
        </div>
      </div>
      <!-- FOOTER MARQUEE -->
      <div class="footer">
        <div class="marquee" id="footerMarquee">
          <div class="track" id="footerTrack"></div>
        </div>
      </div>
    </div>
    <!-- TOAST OVERLAY + TOAST -->
    <div class="toast-overlay" id="toastOverlay"></div>
    <div class="toast" id="toast">
      <div class="t-head">
        <span id="toastTitle">CHÚC MỪNG</span>
        <span class="badge" id="toastBadge">TRÚNG</span>
      </div>
      <div class="t-body">
        <div class="line1" id="toastLine1">Kết quả đã được xác nhận</div>
        <div class="line2" id="toastLine2">—</div>
        <div class="line3" id="toastLine3">—</div>
        <div class="line4" id="toastLine4">—</div>
        <div class="line5" id="toastLine5"><span class="pillbig">—</span></div>
      </div>
    </div>
    <script>
      // =========================================================
      // DO NOT CHANGE FETCH LOGIC (keep as existing behavior)
      // =========================================================
      const SESSION_ID = {{ session_id|tojson }};
      const ROUND_NO   = {{ (round_no or 1)|tojson }};

      const POLL_MS = 2000;
      const API_URL = `/auction/sessions/api/display/sessions/${SESSION_ID}?round_no=${ROUND_NO}`;

      // =========================================================
      // AUDIO (Background + Bell + Win + NextRound)
      // =========================================================
      const AUDIO_URLS = {
      bell: "https://pub-0963cdac24ac4ec3a94d2bf5c523be29.r2.dev/daugia/uploads/public/file/bell_ting.mp3",
      next: "https://pub-0963cdac24ac4ec3a94d2bf5c523be29.r2.dev/daugia/uploads/public/file/next_round3.mp3",
      win: "https://pub-0963cdac24ac4ec3a94d2bf5c523be29.r2.dev/daugia/uploads/public/file/win3.mp3",
      bg: "https://pub-0963cdac24ac4ec3a94d2bf5c523be29.r2.dev/daugia/uploads/public/file/nhacnen2.mp3",
      };

      let SOUND_ENABLED = true;
      let _audioUnlocked = false;

      const audio = {
      bg: new Audio(AUDIO_URLS.bg),
      bell: new Audio(AUDIO_URLS.bell),
      win: new Audio(AUDIO_URLS.win),
      next: new Audio(AUDIO_URLS.next),
      };

      // setup
      audio.bg.loop = true;
      audio.bg.volume = 0.30;    // nền dịu nhẹ
      audio.bell.volume = 1.00;
      audio.win.volume = 1.00;
      audio.next.volume = 1.00;

      const DEFAULT_VOL = {
      bg:   audio.bg.volume,
      bell: audio.bell.volume,
      win:  audio.win.volume,
      next: audio.next.volume,
      };


      function _safePlay(a){
      if(!SOUND_ENABLED) return;
      if(!_audioUnlocked) return;
      try{
      a.play?.().catch(()=>{});
      }catch(_){}
      }

      function _safePause(a){
      try{ a.pause?.(); }catch(_){}
      }

      function _safeStop(a){
      try{
      a.pause?.();
      a.currentTime = 0;
      }catch(_){}
      }

      function stopAllAudio(){
      _safeStop(audio.bg);
      _safeStop(audio.bell);
      _safeStop(audio.win);
      _safeStop(audio.next);
      }
      function fadeAudioTo(a, targetVol, durationMs){
      return new Promise((resolve)=>{
      try{
      if(!a) return resolve();
      const start = Number(a.volume || 0);
      const target = Math.max(0, Math.min(1, Number(targetVol)));
      const dur = Math.max(0, Number(durationMs || 0));

      if(dur <= 0){
      a.volume = target;
      return resolve();
      }

      const t0 = performance.now();
      const tick = (now)=>{
      const p = Math.min(1, (now - t0) / dur);
      a.volume = start + (target - start) * p;
      if(p >= 1) return resolve();
      requestAnimationFrame(tick);
      };
      requestAnimationFrame(tick);
      }catch(_){ resolve(); }
      });
      }

      async function fadeOutAndStop(a, durationMs){
      try{
      if(!a) return;
      await fadeAudioTo(a, 0, durationMs);
      _safeStop(a);
      }catch(_){}
      }


      function playBackground(){
      if(!SOUND_ENABLED) return;
      if(!_audioUnlocked) return;
      _safeStop(audio.win);
      _safeStop(audio.next);
      _safeStop(audio.bell);
      // bg chỉ play nếu chưa chạy
      _safePlay(audio.bg);
      }

      function pauseBackground(){
      _safePause(audio.bg);
      }

      function unlockAudioOnce(){
      if(_audioUnlocked) return;
      _audioUnlocked = true;
      // prime: play/pause cực nhanh để unlock trên một số browser
      try{
      audio.bg.muted = true;
      audio.bg.play?.().then(()=>{
      audio.bg.pause?.();
      audio.bg.currentTime = 0;
      audio.bg.muted = false;
      if(SOUND_ENABLED) playBackground();
      }).catch(()=>{
      audio.bg.muted = false;
      });
      }catch(_){}
      }

      // =========================================================
      // Helpers
      // =========================================================
      const $ = (id) => document.getElementById(id);

      function safeText(x){
      return (x===null || x===undefined) ? '' : String(x);
      }
      function fmtInt(n){
      const v = Number(n||0);
      if(!isFinite(v)) return "0";
      return v.toLocaleString("vi-VN");
      }
      function fmtMoney(n){
      const v = Number(n||0);
      if(!isFinite(v)) return "—";
      return v.toLocaleString("vi-VN");
      }
      function fmtMoneyVND(n){
      const v = Number(n||0);
      if(!isFinite(v) || v <= 0) return "—";
      return v.toLocaleString("vi-VN") + " VNĐ";   // ✅ full số + VNĐ
      }


      function shortStatus(s){
      const x = (safeText(s)||'').toUpperCase();
      if(x.includes("ISSU")) return "ĐANG KIỂM";
      if(x.includes("OPEN")) return "ĐANG MỞ";
      if(x.includes("CLOSE")) return "ĐÃ CHỐT";
      if(x.includes("DONE")) return "HOÀN TẤT";
      if(!x) return "—";
      return x;
      }

      function statusClass(s){
      const x = (safeText(s)||'').toUpperCase();
      if(x.includes("DONE") || x.includes("CLOSE")) return "ok";
      if(x.includes("ISSU") || x.includes("OPEN")) return "pri";
      return "bad";
      }

      function resultClass(rt){
      const x = (safeText(rt)||'').toUpperCase();
      if(x === "WINNER" || x.includes("WIN")) return "win";
      if(x === "NEXT_ROUND" || x.includes("NEXT")) return "next";
      return "no";
      }

      function resultLabel(rt){
      const x = (safeText(rt)||'').toUpperCase();
      if(x === "WINNER" || x.includes("WIN")) return "TRÚNG";
      if(x === "NEXT_ROUND" || x.includes("NEXT")) return "VÒNG SAU";
      return "CHƯA CÓ";
      }
      function priceLabelForResultLabel(lbl){
      // WINNER => GIÁ TRÚNG, còn lại => GIÁ CAO NHẤT
      const x = (safeText(lbl)||"").toUpperCase();
      if(x === "TRÚNG" || x.includes("TRÚNG")) return "GIÁ TRÚNG";
      return "GIÁ CAO NHẤT";
      }
      function winMethodLabel(wm){
      const x = (safeText(wm)||"").toUpperCase();
      if(x === "LOTTERY") return "BỐC THĂM";
      if(!x) return "";
      return "TRẢ GIÁ";
      }

      function priceLabelFor(label, winMethod){
      // VÒNG SAU => luôn là GIÁ CAO NHẤT
      if(label === "VÒNG SAU") return "GIÁ CAO NHẤT";

      // TRÚNG => tuỳ win_method
      if(label === "TRÚNG"){
      const wm = (safeText(winMethod)||"").toUpperCase();
      if(wm === "LOTTERY") return "GIÁ TRÚNG (BỐC THĂM)";
      return "GIÁ TRÚNG";
      }

      return "GIÁ CAO NHẤT";
      }


      function maskSTT(stt){
      const v = safeText(stt).trim();
      if(!v) return "STT —";
      return `STT ${v}`;
      }

      function truncate(str, max){
      const s = safeText(str);
      if(s.length <= max) return s;
      return s.slice(0, Math.max(0, max-1)) + "…";
      }

      function upperName(x){
      const s = safeText(x).trim();
      return s ? s.toUpperCase() : "—";
      }

      function fitLotCodeFont(){
      const el = $("heroLotCode");
      if(!el) return;

      const txt = (el.textContent || "").trim();
      if(!txt) return;

      // đo độ rộng thực tế của box MÃ LÔ (div hero-lot)
      const box = el.closest(".hero-lot");
      if(!box) return;

      const w = box.clientWidth || 0;
      if(w <= 0) return;

      const len = txt.length;

      // ✅ cho phép tối đa 2 dòng:
      // nếu dài, coi như chia 2 dòng => số ký tự "tương đương mỗi dòng"
      const perLine = Math.max(3, Math.ceil(len / 2));

      // hệ số 0.78~0.9 tuỳ font; Oxanium hơi rộng nên dùng 0.78
      let fs = Math.floor((w / perLine) * 0.78);

      // ✅ không nhỏ hơn mức đủ nhìn, không quá to
      const MIN = 46;     // bạn có thể nâng lên 50 nếu muốn
      const MAX = 110;

      fs = Math.max(MIN, Math.min(MAX, fs));

      // apply
      el.style.fontSize = fs + "px";
      }

      // =========================================================
      // Smart repeat count for marquee (avoid blind x10)
      // =========================================================
      function calcRepeatN(realCount){
      const TARGET = 50;   // muốn tối thiểu ~50 item để chạy mượt
      const MAX_N  = 10;   // không cho nhân quá 10 lần

      const c = Number(realCount || 0);
      if(c <= 0) return 1;

      const n = Math.ceil(TARGET / c);
      return Math.max(1, Math.min(n, MAX_N));
      }
      // =========================================================
      // Seamless vertical repeat (cap total items <= 50)
      // =========================================================
      function calcRepeatTimesByMax(itemCount, targetItems = 28, maxItems = 50){
      const c = Number(itemCount || 0);
      if(c <= 0) return 1;

      // muốn >= targetItems cho mượt, nhưng tổng không vượt maxItems
      const need = Math.ceil(targetItems / c);
      const allow = Math.floor(maxItems / c) || 1;

      return Math.max(1, Math.min(need, allow));
      }

      /**
      * Build innerHTML = (base repeated N times) duplicated 2 blocks for seamless loop
      * return blockHeight (height of 1 block)
      */
      function setVerticalSeamless(innerEl, baseHtml, repeatTimes){
      const n = Math.max(1, Number(repeatTimes) || 1);
      const block = (baseHtml || "").trim();
      const safeBlock = block || `<div class="crow"><div class="r1"><div class="name">—</div><div class="stt">STT —</div></div></div>`;

      const one = safeBlock.repeat(n);
      innerEl.innerHTML = one + one; // double block for seamless

      // đo chiều cao 1 block (nửa tổng)
      const blockHeight = innerEl.scrollHeight / 2;
      return blockHeight || 0;
      }

      // =========================================================
      // Measure base (non-duplicated) height to decide scroll or not
      // =========================================================
      function measureBaseHeight(innerEl, baseHtml){
      // render đúng 1 lần để đo "chiều cao thật"
      innerEl.innerHTML = (baseHtml || "").trim()
      || `<div class="crow"><div class="r1"><div class="name">—</div><div class="stt">STT —</div></div></div>`;
      return innerEl.scrollHeight || 0;
      }

      // =========================================================
      // Fullscreen
      // =========================================================
      function toggleFullscreen(){
      try{
      if(!document.fullscreenElement){
      document.documentElement.requestFullscreen?.();
      }else{
      document.exitFullscreen?.();
      }
      }catch(_){}
      }
      $("fsBtn").addEventListener("click", toggleFullscreen);
      // =========================================================
      // Sound toggle button
      // =========================================================
      function renderSoundBtn(){
      const btn = $("soundBtn");
      const ico = $("soundIco");
      if(!btn || !ico) return;

      if(SOUND_ENABLED){
      btn.classList.remove("off");
      ico.textContent = "🔊";
      btn.title = "Âm thanh: BẬT (bấm để tắt)";
      }else{
      btn.classList.add("off");
      ico.textContent = "🔇";
      btn.title = "Âm thanh: TẮT (bấm để bật)";
      }
      }

      $("soundBtn").addEventListener("click", ()=>{
      unlockAudioOnce();
      SOUND_ENABLED = !SOUND_ENABLED;

      if(!SOUND_ENABLED){
      stopAllAudio();
      }else{
      playBackground();
      }
      renderSoundBtn();
      });

      // unlock audio khi user fullscreen (một click hợp lệ)
      $("fsBtn").addEventListener("click", ()=>{
      unlockAudioOnce();
      });


      // =========================================================
      // Tickers (smooth): duplicate content many times
      // =========================================================
      // helper: set marquee content and duplicate x N times (for smooth scrolling)
      function setMarqueeRepeat(trackEl, baseHtml, times){
      const n = Math.max(1, Number(times) || 1);
      const base = (baseHtml || "").trim()
      || `<span class="marquee-item"><span class="m-stt">STT —</span><span class="m-name">—</span></span>`;

      const block = base.repeat(n);
      trackEl.innerHTML = block + block;     // ✅ double for seamless
      trackEl.style.transform = "translateX(0px)";
      }

      function buildLotChips(lotCodes, cls, maxShow){
      const arr = (lotCodes || []).map(x => safeText(x).toUpperCase()).filter(Boolean);
      if(!arr.length) return "";

      const limit = Math.max(1, Number(maxShow || 4)); // default 4 chip
      // Nếu vượt limit => chừa 1 slot cho +N
      if(arr.length > limit){
      const shown = arr.slice(0, limit - 1);
      const rest = arr.length - shown.length; // số còn lại
      // chỉ show +N nếu N>=2 theo yêu cầu
      const plus = (rest >= 2) ? [`+${rest}`] : arr.slice(0, limit);
      const finalList = (rest >= 2) ? shown.concat(plus) : plus;

      return finalList.map(code => `<span class="chip ${cls}">${code}</span>`).join("");
      }

      // không dư
      return arr.map(code => `<span class="chip ${cls}">${code}</span>`).join("");
      }


      function buildTickerHTML(items, cls, maxShowChips){
      if(!items || !items.length){
      return `<div class="crow ${cls}"><div class="r1"><div class="name">—</div><div class="stt">STT —</div></div></div>`;
      }

      let html = "";
      for(const it of items){
      const nm  = upperName(it.name || "—");
      const stt = safeText(it.stt || "—");

      const chipsHtml = buildLotChips(it.lot_codes || [], cls, maxShowChips);

      html += `
      <div class="crow ${cls}">
        <div class="r1">
          <div class="name" title="${safeText(nm)}">${safeText(nm)}</div>
          <div class="stt">STT ${safeText(stt)}</div>
        </div>
        ${chipsHtml ? `<div class="r2">${chipsHtml}</div>` : ``}
      </div>
      `;
      }
      return html;
      }


      function startVerticalTicker(viewportEl, innerEl){
      // state lưu trên element để update không cần restart RAF
      const st = innerEl._vtState || { y: 0, last: performance.now(), speed: 18, blockH: 0 };
      innerEl._vtState = st;

      function tick(now){
      const dt = (now - st.last) / 1000;
      st.last = now;

      const vh = viewportEl.clientHeight;
      const bh = st.blockH || 0;

      // nếu không đủ cao để scroll thì đứng yên
      if(bh <= 0 || bh <= vh + 2){
      innerEl.style.transform = `translateY(0px)`;
      requestAnimationFrame(tick);
      return;
      }

      st.y = (st.y + st.speed * dt) % bh;
      innerEl.style.transform = `translateY(${-st.y}px)`;
      requestAnimationFrame(tick);
      }

      requestAnimationFrame(tick);
      }

      /** update content cho ticker dọc (won/next) */
      /** update content cho ticker dọc (won/next) */
      function updateVerticalTicker(viewportEl, innerEl, baseHtml, itemCount, speed){
      const st = innerEl._vtState || { y: 0, last: performance.now(), speed: 18, blockH: 0 };
      innerEl._vtState = st;

      if(Number(speed) > 0) st.speed = Number(speed);

      const vh = viewportEl.clientHeight;

      // ✅ 1) đo chiều cao THẬT (không duplicate)
      const baseH = measureBaseHeight(innerEl, baseHtml);

      // ✅ 2) nếu danh sách thật lọt khung => KHÔNG scroll, KHÔNG duplicate
      if(baseH <= vh + 2){
      st.blockH = 0;
      st.y = 0;
      innerEl.style.transform = `translateY(0px)`;
      return;
      }

      // ✅ 3) nếu không lọt => mới seamless (repeat + double)
      const times = calcRepeatTimesByMax(itemCount, 28, 50);
      st.blockH = setVerticalSeamless(innerEl, baseHtml, times);

      // giữ y để tránh giật
      if(st.blockH > 0 && st.y > st.blockH) st.y = 0;
      }




      function startCardsTicker(viewportEl, innerEl){
      const st = innerEl._ctState || { y: 0, last: performance.now(), speed: 16, blockH: 0 };
      innerEl._ctState = st;

      function tick(now){
      const dt = (now - st.last) / 1000;
      st.last = now;

      const vh = viewportEl.clientHeight;
      const bh = st.blockH || 0;

      if(bh <= 0 || bh <= vh + 2){
      innerEl.style.transform = `translateY(0px)`;
      requestAnimationFrame(tick);
      return;
      }

      st.y = (st.y + st.speed * dt) % bh;
      innerEl.style.transform = `translateY(${-st.y}px)`;
      requestAnimationFrame(tick);
      }

      requestAnimationFrame(tick);
      }

      function updateCardsTicker(viewportEl, innerEl, baseHtml, itemCount, speed){
      const st = innerEl._ctState || { y: 0, last: performance.now(), speed: 16, blockH: 0 };
      innerEl._ctState = st;

      if(Number(speed) > 0) st.speed = Number(speed);

      const vh = viewportEl.clientHeight;

      // ✅ đo chiều cao THẬT (không duplicate)
      const baseH = measureBaseHeight(innerEl, baseHtml);

      // ✅ fit => đứng yên (không lặp)
      if(baseH <= vh + 2){
      st.blockH = 0;
      st.y = 0;
      innerEl.style.transform = `translateY(0px)`;
      return;
      }

      // ✅ không fit => seamless
      const times = calcRepeatTimesByMax(itemCount, 24, 50);
      st.blockH = setVerticalSeamless(innerEl, baseHtml, times);

      if(st.blockH > 0 && st.y > st.blockH) st.y = 0;
      }




      function startMarquee(trackEl, speedPxPerSec){
      let x = 0;
      let last = performance.now();

      function tick(now){
      const dt = (now - last)/1000;
      last = now;

      const w = trackEl.scrollWidth;
      const vw = trackEl.parentElement.clientWidth;

      if(w <= vw){
      trackEl.style.transform = `translateX(0px)`;
      requestAnimationFrame(tick);
      return;
      }

      x += speedPxPerSec * dt;
      if(x > w / 2) x = 0;   // reset nửa track là đủ
      trackEl.style.transform = `translateX(${-x}px)`;
      requestAnimationFrame(tick);
      }

      requestAnimationFrame(tick);
      }


      // =========================================================
      // UI render (keep content logic consistent)
      // =========================================================
      let _initedTickers = false;

      // 👇 bỏ kiểu “key đơn” dễ nhảy, chuyển sang “event signature”
      let _lastEventSig = null;
      let _lastHeroSig = null;
      let _heroRevealTimer = null;

      let _teaseTimer = null;
      let _hasBootstrapped = false;   // đã load lần đầu chưa
      let _toastShowing = false;      // chặn spam khi toast đang hiện

      function setTopTexts(payload){
      const c = payload?.context || {};

      const company = safeText(c.company_name || "");
      const project = safeText(c.project_name || "");
      const sessionCode = safeText(c.project_code || c.session_id || "");

      $("companyName").textContent = truncate(company.toUpperCase(), 26);
      $("companyName").title = company;

      $("projectName").textContent = truncate(project.toUpperCase(), 34);
      $("projectName").title = project;

      $("sessionCode").textContent = sessionCode ? `PHIÊN ${String(sessionCode).toUpperCase()}` : "PHIÊN —";
      $("sessionCode").title = sessionCode;

      const roundNo = c.round_no ?? ROUND_NO;
      const st = shortStatus(c.round_status || "");
      $("roundLine").textContent = `VÒNG ${roundNo} • TRẠNG THÁI ${st}`;
      }

      function setKpis(payload){
      const s = payload?.context?.stats || {};

      $("kpiTotalLots").textContent = fmtInt(s.total_lots ?? 0);
      $("kpiWon").textContent      = fmtInt(s.won_lots ?? 0);
      $("kpiNext").textContent     = fmtInt(s.next_lots ?? 0);
      $("kpiPending").textContent  = fmtInt(s.pending_lots ?? 0);
      }

      function setStatus(payload){
      const st = payload?.context?.round_status || "";
      const cls = statusClass(st);

      const pill = $("statusPill");
      pill.classList.remove("ok","pri","warn","bad");
      pill.classList.add(cls);

      $("statusText").textContent = shortStatus(st);

      const dot = $("statusDot");
      dot.style.background = (cls==="ok") ? "var(--ok)" : (cls==="pri" ? "var(--pri)" : "var(--bad)");

      $("statusSub").textContent = "Hệ thống đang cập nhật kết quả theo thời gian thực.";
      }

      function setWinnerPanel(label){
      const wrap = $("winnerWrap");
      const badge = $("winnerBadge");

      wrap.classList.remove("ok","warn","bad");
      badge.classList.remove("ok","warn","bad");

      if(label === "TRÚNG"){
      wrap.classList.add("ok");
      badge.classList.add("ok");
      badge.textContent = "TRÚNG";
      $("winnerLabel").textContent = "NGƯỜI TRÚNG";
      }else if(label === "VÒNG SAU"){
      wrap.classList.add("warn");
      badge.classList.add("warn");
      badge.textContent = "VÒNG SAU";
      $("winnerLabel").textContent = "CHUYỂN VÒNG SAU";
      }else{
      wrap.classList.add("bad");
      badge.classList.add("bad");
      badge.textContent = "CHƯA CÓ";
      $("winnerLabel").textContent = "CHƯA CÓ KẾT QUẢ";
      }
      }

      function renderHeroNewest(payload){
      const newest =
      (payload?.recent_checked_lots && payload.recent_checked_lots[0])
      ? payload.recent_checked_lots[0]
      : (Array.isArray(payload?.by_lot) ? (payload.by_lot[0] || null) : null);

      const lot = newest?.lot || null;

      const lotCode = safeText(lot?.lot_code || "—").toUpperCase();
      const lotName = safeText(lot?.lot_name || "");
      const lotDesc = safeText(lot?.lot_description || "—");
      const areaText = fmtAreaM2(lot?.area_m2);
      const desc = safeText(lot?.lot_description || "").trim();


      $("heroLotKicker").textContent = "MÃ LÔ";
      $("heroLotCode").textContent = lotCode || "—";
      $("heroLotCode").textContent = lotCode || "—";
      requestAnimationFrame(fitLotCodeFont); // ✅ fit theo width + số ký tự

      $("heroLotName").textContent = lotName ? truncate(lotName.toUpperCase(), 28) : "—";
      $("heroLotDesc").textContent = desc
      ? `DIỆN TÍCH: ${areaText} • ${desc}`
      : `DIỆN TÍCH: ${areaText}`;


      const rt = newest?.result_type || "";
      const label = resultLabel(rt);

      const wm = newest?.win_method || "";                 // NEW
      const displayPrice =
      (label === "TRÚNG")
      ? (newest?.winning_price_vnd ?? newest?.price_vnd ?? 0)
      : (newest?.price_vnd ?? 0);

      $("priceLabel").textContent = priceLabelFor(label, wm);
      $("heroPrice").textContent  = fmtHeroMoney(displayPrice);

      // badge kết quả: thêm win method nếu TRÚNG
      const methodText = winMethodLabel(wm);
      $("heroBadge2").textContent = (label === "TRÚNG" && methodText)
      ? `${label} • ${methodText}`
      : label;

      $("heroBadge1").textContent = "KẾT QUẢ MỚI";

      setWinnerPanel(label);
      // ✅ bật layout TRÚNG riêng cho hero (không đụng VÒNG SAU)
      const heroEl = document.querySelector(".hero");
      if(heroEl){
      heroEl.classList.toggle("mode-win", label === "TRÚNG");
      }


      const winnerNameEl = $("winnerName");
      const winnerSttBoxEl = $("heroWinnerSttBox");
      const winnerSttValEl = $("heroWinnerSttVal");

      /* ===== HERO signature: chỉ coi là "mới" khi nội dung hero thật sự đổi ===== */
      const rid0 = newest?.round_lot_id || "";
      const rt0  = String((newest?.result_type || newest?.result || "")).toUpperCase();
      const wm0  = String((newest?.win_method || "")).toUpperCase();
      const p0   = Number(newest?.price_vnd || 0) || 0;
      const wp0  = Number(newest?.winning_price_vnd || 0) || 0;
      const wstt0= String(newest?.winner?.stt || "");
      const ncnt0= Number(newest?.next_count ?? (newest?.next_customers?.length ?? 0)) || 0;

      const heroSig = [String(rid0), rt0, wm0, String(p0), String(wp0), wstt0, String(ncnt0)].join("|");
      const heroChanged = (heroSig && heroSig !== _lastHeroSig);

      if(heroChanged){
      _lastHeroSig = heroSig;
      // chỉ khi đổi thật => mới mask rồi reveal
      winnerNameEl.classList.add("masked");
      winnerNameEl.classList.remove("reveal");

      if(winnerSttBoxEl){
      winnerSttBoxEl.classList.add("masked");
      winnerSttBoxEl.classList.remove("reveal");
      }

      clearTimeout(_heroRevealTimer);
      } else {
      // không đổi => luôn để trạng thái đọc được, tuyệt đối không nháy theo poll
      winnerNameEl.classList.remove("masked");
      winnerNameEl.classList.add("reveal");

      if(winnerSttBoxEl){
      winnerSttBoxEl.classList.remove("masked");
      winnerSttBoxEl.classList.add("reveal");
      }
      }


      const nextWrap = $("heroNextWrap");
      const nexts = newest?.next_customers || [];


      if(label==="TRÚNG"){
      const winName = safeText(newest?.winner?.name || "");
      const winStt  = safeText(newest?.winner?.stt  || "").trim();

      winnerNameEl.innerHTML = `${upperName(winName)}<span class="caret">|</span>`;
      nextWrap.style.display = "none"; // ẩn danh sách vòng sau ở HERO khi đã TRÚNG

      // ✅ hiện STT box (cỡ chữ bằng tên)
      if(winnerSttBoxEl && winnerSttValEl){
      winnerSttValEl.textContent = winStt ? winStt : "—";
      winnerSttBoxEl.style.display = "block";
      winnerSttBoxEl.classList.add("masked");
      winnerSttBoxEl.classList.remove("reveal");
      }

      }else if(label==="VÒNG SAU"){
      const n = Number(newest?.next_count ?? nexts.length ?? 0) || 0;
      winnerNameEl.innerHTML = `${fmtInt(n)} KHÁCH`;
      nextWrap.style.display = "";

      // ✅ VÒNG SAU => ẩn STT box
      if(winnerSttBoxEl){
      winnerSttBoxEl.style.display = "none";
      }

      }else{
      winnerNameEl.innerHTML = `—<span class="caret">|</span>`;
      nextWrap.style.display = "none"; // PENDING thì ẩn list vòng sau

      // ✅ khác => ẩn STT box
      if(winnerSttBoxEl){
      winnerSttBoxEl.style.display = "none";
      }
      }


      const heroNextN = Number(newest?.next_count ?? nexts.length ?? 0) || 0;


      const baseHtml = nexts.length
      ? nexts.map((p, idx)=>{
      const nm = upperName(p.name||"—");
      const stt = safeText(p.stt||"—");
      const no = idx + 1;
      return `
      <span class="marquee-item">
        <span class="m-idx">#${no}</span>
        <span class="m-stt">STT ${stt}</span>
        <span class="m-name">${nm}</span>
      </span>
      `;
      }).join("")
      : `<span class="marquee-item"><span class="m-idx">#—</span><span class="m-stt">STT —</span><span class="m-name">—</span></span>`;


      const repeatN = calcRepeatN(nexts.length);
      setMarqueeRepeat($("nextTrack"), baseHtml, repeatN);

      /* ===== reveal chỉ khi heroChanged (không phụ thuộc poll) ===== */
      if(heroChanged){
      clearTimeout(_heroRevealTimer);
      _heroRevealTimer = setTimeout(()=>{
      winnerNameEl.classList.remove("masked");
      winnerNameEl.classList.add("reveal");

      if(winnerSttBoxEl && getComputedStyle(winnerSttBoxEl).display !== "none"){
      winnerSttBoxEl.classList.remove("masked");
      winnerSttBoxEl.classList.add("reveal");
      }
      }, 900); // ✅ nhanh hơn 1 chút để không “đợi lâu”
      }

      /* ===== attention pulse: chạy bằng CSS (độc lập poll) ===== */
      if(label === "TRÚNG"){
      winnerNameEl.classList.add("hero-attn");
      if(winnerSttBoxEl && getComputedStyle(winnerSttBoxEl).display !== "none"){
      winnerSttBoxEl.classList.add("hero-attn");
      }
      } else {
      winnerNameEl.classList.remove("hero-attn");
      if(winnerSttBoxEl) winnerSttBoxEl.classList.remove("hero-attn");
      }


      // ✅ CHỈ trigger khi có round_lot_id thật + kết quả là TRÚNG / VÒNG SAU
      const rid = newest?.round_lot_id;

      // label bạn đã tính ở trên: resultLabel(rt) => "TRÚNG" / "VÒNG SAU" / "CHƯA CÓ"
      const shouldNotify = (label === "TRÚNG" || label === "VÒNG SAU");

      // tạo “event signature” ổn định: cùng 1 lô + cùng kết quả + cùng giá/winner/next_count thì KHÔNG coi là mới
      const sig = rid ? [
      String(rid),
      String((newest?.result_type || newest?.result || "")).toUpperCase(),
      String(Number(newest?.price_vnd || 0) || 0),
      String(newest?.winner?.stt || ""),
      String(Number(newest?.next_count ?? (newest?.next_customers?.length ?? 0)) || 0),
      ].join("|") : "";

      // bootstrap: chỉ ghi nhớ, không kêu
      if(!_hasBootstrapped){
      _lastEventSig = sig || null;
      _hasBootstrapped = true;
      } else {
      // ✅ bỏ qua nếu:
      // - không có rid (dữ liệu thiếu) => tránh “nhảy key”
      // - không phải TRÚNG/VÒNG SAU
      // - đang show toast (chặn spam)
      if(rid && shouldNotify && sig && sig !== _lastEventSig){
      _lastEventSig = sig;
      handleNewEventWithSound(newest, lotCode);
      }

      }


      }

      function renderLeftLists(payload){
      const bc = Array.isArray(payload?.by_customer) ? payload.by_customer : [];

      // ✅ TRÚNG: mỗi row = 1 khách, chips = list lô trúng
      const winners = bc
      .filter(x => Array.isArray(x?.won_lots) && x.won_lots.length > 0)
      .map(x => ({
      name: x?.customer?.name,
      stt:  x?.customer?.stt,
      lot_codes: (x.won_lots || []).map(l => l?.lot_code).filter(Boolean)
      }));

      // ✅ VÒNG SAU: mỗi row = 1 khách, chips = list lô vào vòng sau
      const nexts = bc
      .filter(x => Array.isArray(x?.next_lots) && x.next_lots.length > 0)
      .map(x => ({
      name: x?.customer?.name,
      stt:  x?.customer?.stt,
      lot_codes: (x.next_lots || []).map(l => l?.lot_code).filter(Boolean)
      }));

      // ✅ badge trên box = số người (không phải số lô)
      $("wonCountTag").textContent  = fmtInt(winners.length);
      $("nextCountTag").textContent = fmtInt(nexts.length);

      const wonEl  = $("wonTicker");
      const nextEl = $("nextTicker");

      // max chip 1 dòng: bạn chỉnh tuỳ ý
      const wonHtml  = buildTickerHTML(winners, "won", 4);
      const nextHtml = buildTickerHTML(nexts, "next", 4);

      wonEl.dataset.realCount  = String(winners.length);
      nextEl.dataset.realCount = String(nexts.length);

      if(!_initedTickers){
      wonEl.innerHTML  = wonHtml;
      nextEl.innerHTML = nextHtml;
      return;
      }

      const wonVp  = wonEl.closest(".ticker-viewport");
      const nextVp = nextEl.closest(".ticker-viewport");

      updateVerticalTicker(wonVp, wonEl, wonHtml, winners.length, 18);
      updateVerticalTicker(nextVp, nextEl, nextHtml, nexts.length, 18);
      }


      // RIGHT: cards show lot + highest price + list top 5 next customers (if NEXT_ROUND)
      function renderRightLots(payload){
      const src = Array.isArray(payload?.by_lot) ? payload.by_lot : [];

      const lots = src.filter(it => {
      const rt = (safeText(it?.result_type || "")).toUpperCase();
      return rt && rt !== "PENDING";
      });

      if(!lots.length){
      $("lotCards").innerHTML = `
      <div class="lotcard next">
        <div class="top">
          <div class="code">—</div>
          <div class="flag no">CHƯA CÓ</div>
        </div>
        <div class="mid">
          <div class="meta"><span class="pill warn">CHƯA CÓ LÔ TRÚNG / VÒNG SAU</span></div>
          <div class="countbox">
            <div class="count">0</div>
            <div class="sub">VÒNG SAU</div>
          </div>
        </div>
      </div>
      `;
      return;
      }

      let html = "";
      for(const it of lots){
      const rt = safeText(it?.result_type || "").toUpperCase();
      const isWin  = (rt === "WINNER" || rt.includes("WIN"));
      const isNext = (rt === "NEXT_ROUND" || rt.includes("NEXT"));

      const code = safeText(it?.lot?.lot_code || it?.lot_code || "—").toUpperCase();

      const wm = it?.win_method || "";
      const methodText = winMethodLabel(wm);

      const price =
      isWin
      ? (Number(it?.winning_price_vnd ?? it?.price_vnd ?? 0) || 0)
      : (Number(it?.price_vnd ?? 0) || 0);

      const priceText = price > 0 ? `${fmtMoney(price)}` : "—";


      const nextCustomers = Array.isArray(it?.next_customers) ? it.next_customers : [];
      const nextCount = Number(it?.next_count ?? nextCustomers.length ?? 0) || 0;

      const winnerStt = it?.winner?.stt;
      const winnerName = it?.winner?.name;

      const cardClass = isWin ? "win" : (isNext ? "next" : "");
      const flagCls   = isWin ? "win" : (isNext ? "next" : "no");
      const flagText  = isWin ? "TRÚNG" : (isNext ? "VÒNG SAU" : "CHƯA CÓ");

      // top 5 names
      const top5 = nextCustomers.slice(0,5);
      const extra = Math.max(0, nextCustomers.length - top5.length);

      const nlistHtml = isNext
      ? `
      <div class="nlist">
        ${top5.map((c, idx)=>{
        const stt = safeText(c?.stt || "—");
        const nm = upperName(c?.name || "—");
        return `
        <div class="nrow">
          <div class="nleft">
            <span class="nstt">STT ${stt}</span>
            <span class="nname" title="${safeText(nm)}">${safeText(nm)}</span>
          </div>
          <span class="ntail">#${idx+1}</span>
        </div>
        `;
        }).join("")}
        ${extra > 0 ? `<div class="nrow"><div class="nleft"><span class="nstt">+${extra}</span><span class="nname">KHÁCH KHÁC</span></div><span class="ntail">…</span></div>` : ``}
      </div>
      `
      : ``;

      const winnerSttText = safeText(winnerStt || "—");
      const winnerNameText = upperName(winnerName || "—");

      if(isWin){
      html += `
      <div class="lotcard win">
        <div class="top">
          <div class="code" title="${safeText(code)}">${safeText(code)}</div>
          <div class="flag win">${methodText ? `TRÚNG • ${methodText}` : "TRÚNG"}</div>
        </div>

        <div class="row2">
          <div class="pricebig">${priceText}</div>
        </div>

        <div class="winnerline">
          <span class="wstt">STT ${winnerSttText}</span>
          <span class="wname" title="${safeText(winnerNameText)}">${safeText(winnerNameText)}</span>
        </div>
      </div>
      `;
      } else if(isNext){
      html += `
      <div class="lotcard next">
        <div class="top">
          <div class="code" title="${safeText(code)}">${safeText(code)}</div>
          <div class="flag next">VÒNG SAU</div>
        </div>

        <div class="row2">
          <div class="pricebig">${priceText}</div>

          <div class="countbox">
            <div class="count">${fmtInt(nextCount)}</div>
            <div class="sub">VÒNG SAU</div>
          </div>
        </div>

        ${nlistHtml}
      </div>
      `;
      }

      }

      const cardsEl = $("lotCards");
      cardsEl.innerHTML = html;
      cardsEl.dataset.realCount = String(lots.length);

      if(_initedTickers){
      const cvp = cardsEl.closest(".cards-viewport");
      const itemCount = lots.length;
      updateCardsTicker(cvp, cardsEl, html, itemCount, 16);
      }


      }

      function renderRecent(payload){
      const rec = payload?.recent_checked_lots || [];

      // ✅ BỎ HERO (hero đang dùng rec[0]) => recent lấy từ rec[1], rec[2]
      const arr = rec.slice(1, 3); // đúng 2 item
      while(arr.length < 2) arr.push(null);


      const html = arr.map((it)=>{
      if(!it){
      return `
      <div class="rslot no">
        <div class="lc">—</div>
        <div class="badge-rt no">CHƯA CÓ</div>
        <div class="price-big">—</div>
        <div class="who-line">
          <span class="stt-pill">STT —</span>
          <span class="winner-name">—</span>
        </div>
      </div>
      `;
      }

      const code = safeText(it?.lot?.lot_code || "—").toUpperCase();
      const rt = it?.result_type || "";
      const cls = resultClass(rt);
      const lab = resultLabel(rt);

      const wm = it?.win_method || "";
      const methodText = winMethodLabel(wm);

      const displayPrice =
      (lab === "TRÚNG")
      ? (it?.winning_price_vnd ?? it?.price_vnd ?? 0)
      : (it?.price_vnd ?? 0);

      const priceText = fmtHeroMoney(displayPrice);


      const winnerName = upperName(it?.winner?.name || "—");
      const winnerStt  = safeText(it?.winner?.stt || "—");

      const nextCount = Number(it?.next_count ?? (it?.next_customers?.length ?? 0)) || 0;

      // ✅ Layout mới:
      // - Không còn dòng "TRẠNG THÁI"
      // - TRÚNG: STT pill + Tên
      // - VÒNG SAU: pill "N KHÁCH"
      if(lab === "TRÚNG"){
      return `
      <div class="rslot ${cls}">
        <div class="lc" title="${safeText(code)}">${safeText(code)}</div>
        <div class="badge-rt ${cls}">${methodText ? `TRÚNG • ${methodText}` : "TRÚNG"}</div>

        <div class="who-line" title="${safeText(winnerName)}">
          <span class="stt-pill">STT ${winnerStt}</span>
          <span class="winner-name">${safeText(winnerName)}</span>
        </div>

        <div class="price-big">${priceText}</div>
      </div>
      `;
      }

      if(lab === "VÒNG SAU"){
      return `
      <div class="rslot ${cls}">
        <div class="lc" title="${safeText(code)}">${safeText(code)}</div>
        <div class="badge-rt ${cls}">${lab}</div>

        <div class="who-line">
          <span class="next-pill">${fmtInt(nextCount)} KHÁCH</span>
          <span class="winner-name">CHUYỂN VÒNG SAU</span>
        </div>

        <div class="price-big">${priceText}</div>
      </div>
      `;
      }

      // CHƯA CÓ
      return `
      <div class="rslot ${cls}">
        <div class="lc" title="${safeText(code)}">${safeText(code)}</div>
        <div class="badge-rt ${cls}">${lab}</div>

        <div class="who-line">
          <span class="stt-pill">STT —</span>
          <span class="winner-name">CHƯA CÓ KẾT QUẢ</span>
        </div>

        <div class="price-big">${priceText}</div>
      </div>
      `;
      }).join("");

      $("recentBody").innerHTML = html;
      }

      // =========================================================
      // TOAST (blur whole page + big popup)
      // =========================================================
      function showToast(type, title, badge, line1, line2, line3, line4, line5){
      const toast = $("toast");
      const ov = $("toastOverlay");

      // ✅ nếu đang toast mà có toast mới -> huỷ timer cũ ngay
      clearTimeout(showToast._t);
      clearTimeout(showToast._preFadeT);

      _toastShowing = true;

      toast.classList.remove("ok","warn","bad");
      toast.classList.add(type);

      $("toastTitle").textContent = safeText(title);
      $("toastBadge").textContent = safeText(badge);

      $("toastLine1").textContent = safeText(line1);
      $("toastLine2").innerHTML = safeText(line2);
      $("toastLine3").innerHTML = safeText(line3);
      $("toastLine4").innerHTML = safeText(line4);

      const line5El = $("toastLine5");
      const pill = line5El.querySelector(".pillbig");
      if(pill){
      pill.textContent = safeText(line5);
      pill.style.borderColor = (type === "warn") ? "rgba(251,191,36,.35)" : "rgba(52,211,153,.35)";
      pill.style.background  = (type === "warn") ? "rgba(251,191,36,.14)" : "rgba(52,211,153,.14)";
      pill.style.boxShadow   = (type === "warn") ? "0 0 18px rgba(251,191,36,.22)" : "0 0 18px rgba(52,211,153,.25)";
      }

      // ✅ nếu đang show rồi thì chỉ update nội dung (đỡ giật)
      ov.classList.add("show");
      toast.classList.add("show");

      const TOAST_MS = 10000;          // giữ 10s như bạn đang dùng
      const PRE_FADE_MS = 3000;
      const FADE_OUT_MS = 2500;
      const BG_FADE_IN_MS = 1200;

      // ✅ hẹn fade trước khi close
      showToast._preFadeT = setTimeout(()=>{
      if(!SOUND_ENABLED) return;
      fadeAudioTo(audio.win,  0.06, FADE_OUT_MS);
      fadeAudioTo(audio.next, 0.06, FADE_OUT_MS);
      }, Math.max(0, TOAST_MS - PRE_FADE_MS));

      // ✅ close toast
      showToast._t = setTimeout(async ()=>{
      toast.classList.remove("show");
      ov.classList.remove("show");

      await Promise.all([
      fadeOutAndStop(audio.win,  250),
      fadeOutAndStop(audio.next, 250),
      ]);
      _safeStop(audio.bell);

      try{ audio.bg.volume = 0; }catch(_){}
      playBackground();
      await fadeAudioTo(audio.bg, 0.30, BG_FADE_IN_MS);

      _toastShowing = false;
      }, TOAST_MS);
      }


      function interruptToastNow(){
      // huỷ lịch đóng toast cũ (nếu có)
      clearTimeout(showToast._t);
      clearTimeout(showToast._preFadeT);

      // stop âm của toast cũ ngay để toast mới sạch sẽ
      _safeStop(audio.win);
      _safeStop(audio.next);
      _safeStop(audio.bell);

      // KHÔNG bật lại bg ở đây.
      // Toast cuối cùng sẽ tự close và tự fade-in bg như cũ trong showToast().
      _toastShowing = false;
      }




      function handleNewEventWithSound(newest, lotCode){
      // ✅ nếu đang toast mà có event mới -> cắt toast/âm cũ ngay
      if(_toastShowing){
      interruptToastNow();
      }

      // ✅ huỷ delay âm của event trước (nếu có) để tránh chồng tiếng
      clearTimeout(handleNewEventWithSound._delayT);

      // 1) quyết định loại kết quả
      const rt = newest?.result_type || newest?.result || "";
      const label = resultLabel(rt); // "TRÚNG" / "VÒNG SAU" / "CHƯA CÓ"

      // 2) nếu sound OFF => chỉ show toast
      if(!SOUND_ENABLED){
      showToastFromNewest(newest, lotCode);
      return;
      }

      // 3) sound ON => dừng nền, bell 1s rồi phát win/next song song toast
      unlockAudioOnce();
      pauseBackground();

      // reset trước khi phát
      _safeStop(audio.bell);
      _safeStop(audio.win);
      _safeStop(audio.next);

      // ✅ restore volume mặc định (tránh bị fade từ lần trước)
      try{ audio.bell.volume = DEFAULT_VOL.bell; }catch(_){}
      try{ audio.win.volume  = DEFAULT_VOL.win;  }catch(_){}
      try{ audio.next.volume = DEFAULT_VOL.next; }catch(_){}

      _safePlay(audio.bell);

      // bell ~1s, delay 900ms cho chắc
      handleNewEventWithSound._delayT = setTimeout(()=>{
      if(!SOUND_ENABLED) return;

      if(label === "TRÚNG"){
      try{ audio.win.volume = 1.00; }catch(_){}
      _safePlay(audio.win);
      }else if(label === "VÒNG SAU"){
      try{ audio.next.volume = 1.00; }catch(_){}
      _safePlay(audio.next);
      }

      showToastFromNewest(newest, lotCode);
      }, 900);
      }


      function showToastFromNewest(newest, lotCode){
      const rt = newest?.result_type || newest?.result || "";
      const label = resultLabel(rt);

      const wm = newest?.win_method || "";
      const priceLbl = priceLabelFor(label, wm);

      const displayPrice =
      (label === "TRÚNG")
      ? (newest?.winning_price_vnd ?? newest?.price_vnd ?? 0)
      : (newest?.price_vnd ?? 0);

      const priceText = fmtMoneyVND(displayPrice); // ✅ full số + VNĐ




      if(label === "TRÚNG"){
      const winName = safeText(newest?.winner?.name || newest?.winner_name || newest?.customer_name || "");
      const winStt  = safeText(newest?.winner?.stt  || newest?.winner_stt  || "").trim();

      showToast(
      "ok",
      "CHÚC MỪNG",
      "TRÚNG",
      "KẾT QUẢ ĐÃ ĐƯỢC XÁC NHẬN",
      // line2: MÃ LÔ (value cực nổi)
      `<span class="k-lbl">MÃ LÔ</span><span class="k-val lot">${safeText(lotCode)}</span>`,
      // line3: GIÁ (label mờ + value rõ)
      `<span class="k-lbl">${safeText(priceLbl)}</span><span class="k-val price">${priceText}</span>`,
      // line4: TÊN KHÁCH (spotlight thứ 2)
      `<span class="k-lbl">KHÁCH</span><span class="k-val name">${upperName(winName)}</span>`,
      // line5: STT (pill)
      `STT : ${winStt || "—"}`
      );
      }

      else if(label === "VÒNG SAU"){
      const nextCount = Number(newest?.next_count ?? (newest?.next_customers?.length ?? 0)) || 0;

      showToast(
      "warn",
      "THÔNG BÁO",
      "VÒNG SAU",
      "THÔNG BÁO KẾT QUẢ KIỂM PHIẾU",
      // line2: MÃ LÔ
      `<span class="k-lbl">MÃ LÔ</span><span class="k-val lot">${safeText(lotCode)}</span>`,
      // line3: GIÁ CAO NHẤT (label mờ)
      `<span class="k-lbl">${safeText(priceLbl)}</span><span class="k-val price">${priceText}</span>`,
      // line4: nhấn vào “SỐ KHÁCH”
      `<span class="k-lbl">VÀO VÒNG TIẾP</span><span class="k-val name">${fmtInt(nextCount)} KHÁCH</span>`,
      // line5: pill cũng nhấn mạnh
      `SỐ KHÁCH : ${fmtInt(nextCount)}`
      );
      }

      }


      // =========================================================
      // Footer marquee text
      // =========================================================
      function initFooter(){
      const base = `
      <span class="footer-item">
        <span class="ft-label">ĐƠN VỊ PHẦN MỀM</span>
        <span class="ft-sep">•</span>
        <span class="ft-brand">DauGiaThongMinh.vn</span>
        <span class="ft-sep">•</span>
        <span class="ft-desc">NỀN TẢNG VẬN HÀNH ĐẤU GIÁ ĐẤT (TỰ ĐỘNG HOÁ &amp; MINH BẠCH)</span>
      </span>
      `;

      // ✅ lặp nhiều lần để chắc chắn luôn dài hơn viewport => marquee luôn chạy
      $("footerTrack").innerHTML = base.repeat(12);

      // ✅ chạy chậm hơn hero để sang hơn
      startMarquee($("footerTrack"), 36);
      }



      // =========================================================
      // Polling
      // =========================================================
      async function pollOnce(){
      let r, js;
      try{
      r = await fetch(API_URL, {method:"GET", headers: {"Accept":"application/json"}});
      }catch(err){
      return null;
      }
      try{ js = await r.json(); }catch(_){ js = null; }
      if(!r || !r.ok) return js || null;
      return js;
      }

      async function mainLoop(){
      const payload = await pollOnce();
      if(payload){
      setTopTexts(payload);
      setKpis(payload);
      setStatus(payload);

      renderLeftLists(payload);
      renderHeroNewest(payload);
      renderRightLots(payload);
      renderRecent(payload);

      if(!_initedTickers){
      _initedTickers = true;

      // ===== LEFT tickers =====
      const wonEl  = $("wonTicker");
      const nextEl = $("nextTicker");
      const wonVp  = wonEl.closest(".ticker-viewport");
      const nextVp = nextEl.closest(".ticker-viewport");

      startVerticalTicker(wonVp, wonEl);
      startVerticalTicker(nextVp, nextEl);

      // dùng realCount (đã set trong renderLeftLists)
      const wonCount  = parseInt(wonEl.dataset.realCount || "0", 10);
      const nextCount = parseInt(nextEl.dataset.realCount || "0", 10);
      updateVerticalTicker(wonVp, wonEl, wonEl.innerHTML, wonCount, 18);
      updateVerticalTicker(nextVp, nextEl, nextEl.innerHTML, nextCount, 18);

      // ===== RIGHT cards ticker =====
      const cardsEl = $("lotCards");
      const cvp     = cardsEl.closest(".cards-viewport");

      startCardsTicker(cvp, cardsEl);

      const cardCount = parseInt(cardsEl.dataset.realCount || "0", 10);
      updateCardsTicker(cvp, cardsEl, cardsEl.innerHTML, cardCount, 16);

      // ===== HERO marquee + footer =====
      startMarquee($("nextTrack"), 58);
      initFooter();
      }


      }
      setTimeout(mainLoop, POLL_MS);
      }

      function fmtAreaM2(x){
      const v = Number(x);
      if(!isFinite(v) || v <= 0) return "—";

      // nếu là số nguyên -> không có thập phân
      if(Number.isInteger(v)) return `${v.toLocaleString("vi-VN")} m²`;

      // nếu có thập phân -> 2 chữ số
      return `${v.toFixed(2).replace(".", ",")} m²`;
      }

      function fmtHeroMoney(n){
      const v = Number(n||0);
      if(!isFinite(v) || v <= 0) return "—";

      // > 1 tỷ => hiển thị dạng "xxx.xxx.xxxk" (tức chia 1.000)
      // Ví dụ: 1.000.000.000 => 1.000.000k
      if(v >= 1_000_000_000){
      const k = Math.round(v / 1000);
      return k.toLocaleString("vi-VN") + "k";
      }

      // còn lại giữ bình thường
      return v.toLocaleString("vi-VN");
      }

      // boot
      mainLoop();
      renderSoundBtn();
      playBackground();


    </script>
  </body>
</html>