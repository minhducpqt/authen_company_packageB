{# templates/auction_session/index.html #}
{% extends "base.html" %}
{% block title %}{{ title or "Vận hành phiên đấu" }}{% endblock %}

{% block content %}
<style>
  :root{
    --bd: rgba(226,232,240,1);
    --bd2: rgba(241,245,249,1);
    --muted: rgba(100,116,139,1);
    --ink: rgba(15,23,42,1);
    --bg: #fff;
    --pri: #0ea5e9;
    --pri2:#0284c7;
    --ok:#16a34a;
    --warn:#f59e0b;
    --bad:#ef4444;
    --shadow: 0 10px 28px rgba(2,6,23,.08);
  }

  .wrap{max-width:1180px;margin:0 auto;padding:16px;}

  .page{
    background:var(--bg);
    border:1px solid var(--bd);
    border-radius:18px;
    box-shadow:0 2px 10px rgba(2,6,23,.04);
    overflow:hidden;
  }

  /* ===== Header ===== */
  .head{
    padding:16px 18px;
    border-bottom:1px solid var(--bd2);
    background:linear-gradient(180deg, rgba(248,250,252,.95), #fff);
    display:flex;
    gap:14px;
    align-items:flex-start;
    justify-content:space-between;
    flex-wrap:wrap;
  }
  .title{
    flex: 1 1 420px;
    min-width: 320px;
  }
  .title h1{
    margin:0;
    font-size:18px;
    color:var(--ink);
    font-weight:1000;
    letter-spacing:.2px;
  }
  .title p{
    margin:6px 0 0;
    color:var(--muted);
    font-size:13px;
    line-height:1.35;
    max-width: 760px;
  }

  .tools{
    flex: 0 0 auto;
    display:flex;
    gap:10px;
    align-items:flex-end;
    flex-wrap:wrap;
    justify-content:flex-end;
  }

  .field{display:flex;gap:8px;align-items:center;}
  label{font-size:12px;color:var(--muted);font-weight:900;white-space:nowrap;}

  select, input{
    height:38px;
    border:1px solid var(--bd);
    border-radius:12px;
    padding:0 12px;
    background:#fff;
    color:var(--ink);
    outline:none;
    font-size:13px;
    min-width: 220px;
  }
  select:focus,input:focus{border-color:rgba(14,165,233,.6); box-shadow:0 0 0 3px rgba(14,165,233,.15);}

  .btn{
    height:38px;
    border-radius:12px;
    border:1px solid var(--bd);
    background:#fff;
    padding:0 12px;
    font-weight:1000;
    font-size:13px;
    color:var(--ink);
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:8px;
    transition:.15s ease;
    text-decoration:none;
    user-select:none;
  }
  .btn:hover{transform:translateY(-1px);box-shadow:0 10px 20px rgba(2,6,23,.08);}
  .btn.primary{background:linear-gradient(180deg, var(--pri), var(--pri2)); border-color:rgba(2,132,199,.5); color:#fff;}
  .btn.ghost{background:rgba(248,250,252,1);}
  .btn.danger{background:rgba(239,68,68,.06); border-color:rgba(239,68,68,.25); color:#991b1b;}
  .btn:disabled{opacity:.55; cursor:not-allowed; transform:none; box-shadow:none;}

  /* ===== Content grid ===== */
  .grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:14px;
    padding:16px;
  }

  .pane{
    border:1px solid var(--bd);
    border-radius:18px;
    background:#fff;
    overflow:hidden;
  }
  .pane-h{
    padding:12px 14px;
    border-bottom:1px solid var(--bd2);
    background:rgba(248,250,252,1);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }
  .pane-h b{font-size:13px;color:var(--ink);font-weight:1000;}
  .pill{
    display:inline-flex;align-items:center;gap:6px;
    padding:4px 10px;border-radius:999px;
    font-size:12px;font-weight:1000;
    border:1px solid var(--bd);background:#fff;color:var(--muted);
    white-space:nowrap;
  }
  .pill.ok{color:var(--ok);border-color:rgba(22,163,74,.25);background:rgba(22,163,74,.06);}
  .pill.warn{color:var(--warn);border-color:rgba(245,158,11,.25);background:rgba(245,158,11,.08);}
  .pill.bad{color:var(--bad);border-color:rgba(239,68,68,.25);background:rgba(239,68,68,.06);}

  .list{padding:12px; display:flex; flex-direction:column; gap:10px;}

  .item{
    border:1px solid var(--bd);
    border-radius:16px;
    padding:12px;
    background:#fff;
    box-shadow:0 1px 2px rgba(2,6,23,.03);
  }
  .row{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap;}
  .item h3{margin:0;font-size:14px;color:var(--ink);font-weight:1100;}
  .meta{margin-top:6px;color:var(--muted);font-size:12px;display:flex;flex-wrap:wrap;gap:10px;line-height:1.3;}
  .actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end;}

  .mini{height:34px;border-radius:12px;padding:0 12px;font-size:12px;font-weight:1100;}
  .note{
    padding:10px 12px;
    border-top:1px dashed var(--bd);
    color:var(--muted);
    font-size:12px;
    background:rgba(248,250,252,.7);
    border-radius:12px;
    margin-top:10px;
    line-height:1.35;
  }

  .wide{padding:0 16px 16px;}

  .err{
    margin:12px 16px 0;
    border:1px solid rgba(239,68,68,.25);
    background:rgba(239,68,68,.06);
    color:#991b1b;
    padding:10px 12px;
    border-radius:16px;
    font-size:13px;
  }

  .hintline{
    color:var(--muted);
    font-size:12px;
    line-height:1.35;
  }
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;}
  .kbd{
    display:inline-flex;align-items:center;
    padding:1px 6px;border-radius:8px;
    border:1px solid var(--bd);
    background:#fff;
    font-size:12px;
    color:var(--ink);
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  }

  @media (max-width: 980px){
    .grid{grid-template-columns:1fr;}
    select, input{min-width: 180px;}
  }

  /* ===== Modal (Create Session) ===== */
  .modal-backdrop{
    position:fixed;inset:0;background:rgba(2,6,23,.55);
    display:none;align-items:flex-start;justify-content:center;
    padding:40px 14px;z-index:9999;
  }
  .modal{
    width:100%;max-width:680px;background:#fff;border-radius:18px;
    border:1px solid rgba(226,232,240,1);box-shadow:var(--shadow);overflow:hidden;
  }
  .modal-h{
    padding:14px 16px;border-bottom:1px solid var(--bd2);
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    background:linear-gradient(180deg, rgba(248,250,252,.95), #fff);
  }
  .modal-h b{font-size:14px;color:var(--ink);font-weight:1100;}
  .xbtn{width:36px;height:36px;border-radius:12px;border:1px solid var(--bd);background:#fff;cursor:pointer;font-weight:900;}
  .modal-b{padding:14px 16px;}
  .formgrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
  .formgrid .full{grid-column:1/-1;}
  .help{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.35;}
  .foot{display:flex;justify-content:flex-end;gap:10px;padding:14px 16px;border-top:1px solid var(--bd2);background:rgba(248,250,252,.7);}
  .toast{
    position:fixed;right:16px;bottom:16px;z-index:10000;
    background:#0f172a;color:#fff;border-radius:14px;padding:10px 12px;
    font-size:13px;box-shadow:0 10px 30px rgba(2,6,23,.25);
    display:none;max-width:520px;line-height:1.35;
  }

  /* ===== Custom Confirm / Alert (no browser confirm) ===== */
  .cmodal-backdrop{
    position:fixed;inset:0;background:rgba(2,6,23,.55);
    display:none;align-items:center;justify-content:center;
    padding:18px;z-index:10050;
  }
  .cmodal{
    width:100%;max-width:520px;background:#fff;border-radius:18px;
    border:1px solid rgba(226,232,240,1);box-shadow:0 18px 44px rgba(2,6,23,.18);
    overflow:hidden;
  }
  .cmodal-h{
    padding:14px 16px;border-bottom:1px solid var(--bd2);
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    background:linear-gradient(180deg, rgba(248,250,252,.95), #fff);
  }
  .cmodal-h b{font-size:14px;color:var(--ink);font-weight:1100;}
  .cmodal-b{padding:14px 16px;color:var(--ink);font-size:13px;line-height:1.45;}
  .cmodal-b .sub{margin-top:6px;color:var(--muted);font-size:12px;line-height:1.35;}
  .cmodal-f{
    display:flex;justify-content:flex-end;gap:10px;padding:14px 16px;
    border-top:1px solid var(--bd2);background:rgba(248,250,252,.7);
  }
  .cicon{
    width:34px;height:34px;border-radius:12px;display:inline-flex;align-items:center;justify-content:center;
    border:1px solid var(--bd);background:#fff;color:var(--muted);flex:0 0 auto;
  }
  .crow{display:flex;gap:10px;align-items:flex-start;}
  .cmodal-b p{margin:0;}
</style>

<div class="wrap">
  <div class="page">
    <div class="head">
      <div class="title">
        <h1>{{ title or "Vận hành phiên đấu" }}</h1>
        <p>
          1) Chọn <b>Dự án</b> (tự lưu, lần sau quay lại không cần chọn lại) → 2) Hệ thống hiển thị các phiên của dự án →
          3) Bấm <b>Mở</b> để vào màn hình phiên (mặc định Round mới nhất).<br/>
          <span class="hintline">Mẹo: dùng <span class="kbd">Start</span> để snapshot Round 1; dùng <span class="kbd">Tạo phiên</span> để tạo phiên mới (DRAFT).</span>
        </p>
      </div>

      <form class="tools" method="get" action="/auction/sessions" id="filterForm">
        <div class="field">
          <label for="statusSel">Trạng thái</label>
          <select id="statusSel" name="status" style="min-width:160px;">
            <option value="" {% if not status %}selected{% endif %}>Tất cả</option>
            <option value="ACTIVE" {% if status=='ACTIVE' %}selected{% endif %}>ACTIVE</option>
            <option value="INACTIVE" {% if status=='INACTIVE' %}selected{% endif %}>INACTIVE</option>
            <option value="DRAFT" {% if status=='DRAFT' %}selected{% endif %}>DRAFT</option>
          </select>
        </div>

        <div class="field">
          <label for="projectSel">Dự án</label>
          <select id="projectSel" name="project">
            <option value="">— Chọn dự án —</option>
            {% for p in projects %}
              {% set code = (p.get('project_code') or p.get('code') or '') %}
              <option value="{{ code }}" data-project-id="{{ p.get('id') or p.get('project_id') }}"
                {% if (project or '')|upper == code|upper %}selected{% endif %}>
                {{ code }} — {{ p.get('name') or p.get('project_name') or 'Dự án' }}
              </option>
            {% endfor %}
          </select>
        </div>

        <button class="btn ghost" type="submit">
          <i class="ri-filter-3-line"></i> Lọc
        </button>
      </form>
    </div>

    {% if error %}
      <div class="err">
        <b>Lỗi tải dữ liệu phiên:</b>
        <span style="opacity:.9">status={{ error.status }}</span>
        <div style="margin-top:6px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;font-size:12px;white-space:pre-wrap;">
          {{ error.body }}
        </div>
      </div>
    {% endif %}

    <div class="grid">
      <!-- Left: primary session -->
      <div class="pane">
        <div class="pane-h">
          <b>Phiên dở dang (ưu tiên)</b>
          {% if active and active.has_active %}
            <span class="pill ok"><i class="ri-flashlight-line"></i> Có phiên</span>
          {% else %}
            <span class="pill warn"><i class="ri-information-line"></i> Chưa có</span>
          {% endif %}
        </div>

        <div class="list">
          {% if not project_id %}
            <div class="item">
              <div class="row">
                <div>
                  <h3>Chưa chọn dự án</h3>
                  <div class="meta">
                    <span><i class="ri-arrow-up-down-line"></i> Chọn dự án ở thanh trên để tải danh sách phiên.</span>
                  </div>
                </div>
              </div>
              <div class="note">
                Trang sẽ tự nhớ dự án bạn chọn (localStorage). Nếu bạn tạo phiên xong, hệ thống sẽ redirect về dự án đó để thấy phiên vừa tạo.
              </div>
            </div>

          {% elif not (active and active.has_active and active.primary_session) %}
            <div class="item">
              <div class="row">
                <div>
                  <h3>Không có phiên dở dang</h3>
                  <div class="meta">
                    <span><i class="ri-file-add-line"></i> Tạo phiên mới để bắt đầu vận hành.</span>
                  </div>
                </div>
                <div class="actions">
                  <button class="btn primary mini" type="button" onclick="openCreateSession()">
                    <i class="ri-add-line"></i> Tạo phiên
                  </button>
                </div>
              </div>
              <div class="note">
                Sau khi tạo phiên, bấm <b>Start</b> để snapshot Round 1 (lô + khách đủ điều kiện).
              </div>
            </div>

          {% else %}
            {% set s = active.primary_session %}
            <div class="item">
              <div class="row">
                <div>
                  <h3>
                    #{{ s.id }} — {{ s.name or "Phiên đấu" }}
                    {% if s.status %}
                      <span class="pill {% if s.status in ['OPEN'] %}ok{% elif s.status in ['PAUSED','DRAFT'] %}warn{% else %}bad{% endif %}" style="margin-left:8px;">
                        {{ s.status }}
                      </span>
                    {% endif %}
                  </h3>
                  <div class="meta">
                    <span><i class="ri-stack-line"></i> Round: <b>{{ s.current_round_no or 0 }}</b></span>
                    <span><i class="ri-checkbox-circle-line"></i> Tổng lô: <b>{{ s.total_lot_count or 0 }}</b></span>
                    <span><i class="ri-time-line"></i> Chưa chốt: <b>{{ s.unfinished_lot_count or 0 }}</b></span>
                  </div>
                </div>
                <div class="actions">
                  <button class="btn primary mini" type="button"
                          onclick="openSessionSmart({{ s.id }}, '{{ (s.status or '')|e }}', {{ (s.current_round_no or 0) }})">
                    <i class="ri-play-circle-line"></i> Mở
                  </button>

                  {# ẨN Start nếu phiên đang OPEN #}
                  {% if (s.status or '')|upper != 'OPEN' %}
                    <button class="btn mini" type="button" onclick="openStartSession({{ s.id }})">
                      <i class="ri-rocket-line"></i> Start
                    </button>
                  {% endif %}
                </div>

              </div>
              <div class="note">
                “Mở” vào màn xử lý lô theo vòng hiện tại / vòng mới nhất.
              </div>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Right: candidates -->
      <div class="pane">
        <div class="pane-h">
          <b>Danh sách phiên dở (candidates)</b>
          <span class="pill"><i class="ri-list-check"></i> {{ (active.candidates|length) if active and active.candidates else 0 }}</span>
        </div>

        <div class="list">
          {% if not project_id %}
            <div class="item">
              <h3>Chưa có dữ liệu</h3>
              <div class="meta">
                <span><i class="ri-information-line"></i> Chọn dự án để load danh sách candidates.</span>
              </div>
            </div>
          {% else %}
            {% set cs = active.candidates or [] %}
            {% if cs|length == 0 %}
              <div class="item">
                <div class="row">
                  <div>
                    <h3>Không có phiên nào đang dở</h3>
                    <div class="meta">
                      <span><i class="ri-add-line"></i> Tạo phiên mới để bắt đầu.</span>
                    </div>
                  </div>
                  <div class="actions">
                    <button class="btn primary mini" type="button" onclick="openCreateSession()">
                      <i class="ri-add-line"></i> Tạo phiên
                    </button>
                  </div>
                </div>
              </div>
            {% else %}
              {% for s in cs %}
                <div class="item">
                  <div class="row">
                    <div>
                      <h3>
                        #{{ s.id }} — {{ s.name or "Phiên đấu" }}
                        {% if s.status %}
                          <span class="pill {% if s.status in ['OPEN'] %}ok{% elif s.status in ['PAUSED','DRAFT'] %}warn{% else %}bad{% endif %}" style="margin-left:8px;">
                            {{ s.status }}
                          </span>
                        {% endif %}
                      </h3>
                      <div class="meta">
                        <span><i class="ri-stack-line"></i> Round: <b>{{ s.current_round_no or 0 }}</b></span>
                        <span><i class="ri-checkbox-circle-line"></i> Tổng lô: <b>{{ s.total_lot_count or 0 }}</b></span>
                        <span><i class="ri-time-line"></i> Chưa chốt: <b>{{ s.unfinished_lot_count or 0 }}</b></span>
                      </div>
                    </div>
                    <div class="actions">
                      <button class="btn primary mini" type="button"
                              onclick="openSessionSmart({{ s.id }}, '{{ (s.status or '')|e }}', {{ (s.current_round_no or 0) }})">
                        <i class="ri-play-circle-line"></i> Mở
                      </button>

                      {# ẨN Start nếu phiên đang OPEN #}
                      {% if (s.status or '')|upper != 'OPEN' %}
                        <button class="btn mini" type="button" onclick="openStartSession({{ s.id }})">
                          <i class="ri-rocket-line"></i> Start
                        </button>
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% endfor %}
            {% endif %}
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Create quick -->
    <div class="wide">
      <div class="pane" style="border-style:dashed;background:rgba(248,250,252,.5);">
        <div class="pane-h">
          <b>Tạo phiên mới</b>
          <span class="pill"><i class="ri-shield-check-line"></i> Snapshot từ danh sách đủ điều kiện</span>
        </div>
        <div class="list">
          <div class="item">
            <div class="row">
              <div>
                <h3>Quy trình nhanh</h3>
                <div class="meta">
                  <span><i class="ri-number-1"></i> Chọn dự án</span>
                  <span><i class="ri-number-2"></i> Tạo phiên (DRAFT)</span>
                  <span><i class="ri-number-3"></i> Bấm “Start” → tạo Round 1 + snapshot lô + khách</span>
                </div>
                <div class="note">
                  Gợi ý tên phiên: <span class="mono">PROJECT_CODE – dd/mm/yyyy – Buổi</span>
                </div>
              </div>
              <div class="actions">
                <button class="btn primary" type="button" onclick="openCreateSession()">
                  <i class="ri-add-line"></i> Tạo phiên
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- ================= Modal: Create Session ================= -->
<div id="createBackdrop" class="modal-backdrop" onclick="closeCreateSession(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-h">
      <b><i class="ri-add-line"></i> Tạo phiên đấu</b>
      <button class="xbtn" type="button" onclick="closeCreateSession()"><i class="ri-close-line"></i></button>
    </div>

    <div class="modal-b">
      <div class="formgrid">
        <div class="full">
          <label>Dự án</label>
          <select id="csProject">
            <option value="">— Chọn dự án —</option>
            {% for p in projects %}
              {% set pid = p.get('id') or p.get('project_id') %}
              {% set code = p.get('project_code') or p.get('code') %}
              <option value="{{ pid }}" data-project-code="{{ code }}"
                {% if project_obj and (project_obj.get('id')==pid or project_obj.get('project_id')==pid) %}selected{% endif %}>
                {{ code }} — {{ p.get('name') or p.get('project_name') or 'Dự án' }}
              </option>
            {% endfor %}
          </select>
          <div class="help">Sau khi tạo xong trang sẽ chuyển về đúng dự án để SSR load phiên.</div>
        </div>

        <div class="full">
          <label>Tên phiên</label>
          <input id="csName" placeholder="Ví dụ: KINHDO3 – 21/01/2026 – Sáng" />
          <div class="help">Nếu bỏ trống, hệ thống vẫn tạo phiên nhưng nên đặt tên để dễ quản trị.</div>
        </div>

        <div>
          <label>Địa điểm</label>
          <input id="csLoc" placeholder="Hội trường..." />
        </div>

        <div>
          <label>Ghi chú</label>
          <input id="csNote" placeholder="Tuỳ chọn" />
        </div>

        <div class="full">
          <div class="help">
            Sau khi tạo xong, bạn bấm <b>Start</b> để snapshot Round 1 (lô + khách đủ điều kiện).
          </div>
        </div>
      </div>
    </div>

    <div class="foot">
      <button class="btn" type="button" onclick="closeCreateSession()"><i class="ri-close-line"></i> Huỷ</button>
      <button class="btn primary" type="button" onclick="submitCreateSession()"><i class="ri-check-line"></i> Tạo</button>
    </div>
  </div>
</div>

<!-- ================= Custom Confirm / Alert ================= -->
<div id="cBackdrop" class="cmodal-backdrop" onclick="closeCModal(event)">
  <div class="cmodal" onclick="event.stopPropagation()">
    <div class="cmodal-h">
      <b id="cTitle">Xác nhận</b>
      <button class="xbtn" type="button" onclick="closeCModal()"><i class="ri-close-line"></i></button>
    </div>
    <div class="cmodal-b">
      <div class="crow">
        <div class="cicon" id="cIcon"><i class="ri-question-line"></i></div>
        <div style="flex:1 1 auto; min-width:0;">
          <p id="cMsg">Bạn có chắc chắn?</p>
          <div class="sub" id="cSub" style="display:none;"></div>
        </div>
      </div>
    </div>
    <div class="cmodal-f" id="cFooter">
      <button class="btn" type="button" id="cCancel"><i class="ri-close-line"></i> Huỷ</button>
      <button class="btn primary" type="button" id="cOk"><i class="ri-check-line"></i> OK</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
  // <editor-fold desc="Auction Sessions - UI Helpers (toast, storage, filters, custom modal)">
  // =========================
  // Toast
  // =========================
  function toast(msg){
    const t = document.getElementById('toast');
    if(!t) return;
    t.textContent = String(msg || '');
    t.style.display = 'block';
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=>{ t.style.display='none'; }, 2800);
  }

  // =========================
  // Custom Confirm / Alert (no browser confirm)
  // =========================
  function closeCModal(ev){
    if(ev && ev.target && ev.target.id !== 'cBackdrop') return;
    const b = document.getElementById('cBackdrop');
    if(!b) return;
    b.style.display = 'none';

    // cleanup listeners
    const okBtn = document.getElementById('cOk');
    const cancelBtn = document.getElementById('cCancel');
    if(okBtn && okBtn.__handler){ okBtn.removeEventListener('click', okBtn.__handler); okBtn.__handler = null; }
    if(cancelBtn && cancelBtn.__handler){ cancelBtn.removeEventListener('click', cancelBtn.__handler); cancelBtn.__handler = null; }

    if(document.__cEscHandler){
      document.removeEventListener('keydown', document.__cEscHandler);
      document.__cEscHandler = null;
    }
  }

  function _openCModal(opts){
    const b = document.getElementById('cBackdrop');
    if(!b) return;
    const titleEl = document.getElementById('cTitle');
    const msgEl   = document.getElementById('cMsg');
    const subEl   = document.getElementById('cSub');
    const iconEl  = document.getElementById('cIcon');
    const okBtn   = document.getElementById('cOk');
    const cancelBtn = document.getElementById('cCancel');
    const footer  = document.getElementById('cFooter');

    const title = (opts && opts.title) ? String(opts.title) : 'Xác nhận';
    const message = (opts && opts.message) ? String(opts.message) : 'Bạn có chắc chắn?';
    const sub = (opts && opts.sub) ? String(opts.sub) : '';
    const mode = (opts && opts.mode) ? String(opts.mode) : 'confirm'; // confirm|alert
    const tone = (opts && opts.tone) ? String(opts.tone) : 'question'; // question|warn|danger|info|ok
    const okText = (opts && opts.okText) ? String(opts.okText) : 'OK';
    const cancelText = (opts && opts.cancelText) ? String(opts.cancelText) : 'Huỷ';

    if(titleEl) titleEl.textContent = title;
    if(msgEl) msgEl.textContent = message;

    if(subEl){
      if(sub){
        subEl.style.display = 'block';
        subEl.textContent = sub;
      }else{
        subEl.style.display = 'none';
        subEl.textContent = '';
      }
    }

    // icon + style
    if(iconEl){
      let html = '<i class="ri-question-line"></i>';
      let bd = '1px solid var(--bd)';
      let bg = '#fff';
      let color = 'var(--muted)';

      if(tone === 'warn'){
        html = '<i class="ri-alert-line"></i>';
        bd = '1px solid rgba(245,158,11,.35)';
        bg = 'rgba(245,158,11,.08)';
        color = 'var(--warn)';
      }else if(tone === 'danger'){
        html = '<i class="ri-error-warning-line"></i>';
        bd = '1px solid rgba(239,68,68,.35)';
        bg = 'rgba(239,68,68,.08)';
        color = 'var(--bad)';
      }else if(tone === 'info'){
        html = '<i class="ri-information-line"></i>';
        bd = '1px solid rgba(14,165,233,.35)';
        bg = 'rgba(14,165,233,.10)';
        color = 'var(--pri2)';
      }else if(tone === 'ok'){
        html = '<i class="ri-checkbox-circle-line"></i>';
        bd = '1px solid rgba(22,163,74,.30)';
        bg = 'rgba(22,163,74,.08)';
        color = 'var(--ok)';
      }

      iconEl.innerHTML = html;
      iconEl.style.border = bd;
      iconEl.style.background = bg;
      iconEl.style.color = color;
    }

    // footer buttons
    if(okBtn){
      okBtn.innerHTML = '<i class="ri-check-line"></i> ' + okText;
      okBtn.classList.remove('danger');
      okBtn.classList.add('primary');
      if(tone === 'danger'){
        okBtn.classList.remove('primary');
        okBtn.classList.add('danger');
      }
    }
    if(cancelBtn){
      cancelBtn.innerHTML = '<i class="ri-close-line"></i> ' + cancelText;
    }
    if(footer){
      // alert mode: hide cancel
      cancelBtn.style.display = (mode === 'alert') ? 'none' : '';
    }

    b.style.display = 'flex';
  }

  function confirmX({title='Xác nhận', message='Bạn có chắc chắn?', sub='', tone='question', okText='OK', cancelText='Huỷ'} = {}){
    return new Promise((resolve)=>{
      _openCModal({title, message, sub, tone, okText, cancelText, mode:'confirm'});

      const okBtn = document.getElementById('cOk');
      const cancelBtn = document.getElementById('cCancel');

      const onOk = ()=>{ closeCModal(); resolve(true); };
      const onCancel = ()=>{ closeCModal(); resolve(false); };

      okBtn.__handler = onOk;
      cancelBtn.__handler = onCancel;

      okBtn.addEventListener('click', onOk);
      cancelBtn.addEventListener('click', onCancel);

      // esc to cancel
      document.__cEscHandler = (e)=>{ if(e.key === 'Escape'){ onCancel(); } };
      document.addEventListener('keydown', document.__cEscHandler);
    });
  }

  function alertX({title='Thông báo', message='', sub='', tone='info', okText='Đã hiểu'} = {}){
    return new Promise((resolve)=>{
      _openCModal({title, message, sub, tone, okText, cancelText:'', mode:'alert'});

      const okBtn = document.getElementById('cOk');
      const onOk = ()=>{ closeCModal(); resolve(true); };
      okBtn.__handler = onOk;
      okBtn.addEventListener('click', onOk);

      document.__cEscHandler = (e)=>{ if(e.key === 'Escape'){ onOk(); } };
      document.addEventListener('keydown', document.__cEscHandler);
    });
  }

  // =========================
  // Remember project selection (localStorage)
  // =========================
  const LS_KEY_PROJECT = 'auction_session_last_project';
  const LS_KEY_STATUS  = 'auction_session_last_status';

  function rememberFilters(){
    try{
      const p = (document.getElementById('projectSel')?.value || '').trim();
      const st = (document.getElementById('statusSel')?.value || '').trim();
      if(p) localStorage.setItem(LS_KEY_PROJECT, p);
      else localStorage.removeItem(LS_KEY_PROJECT);

      if(st) localStorage.setItem(LS_KEY_STATUS, st);
      else localStorage.removeItem(LS_KEY_STATUS);
    }catch(_){}
  }

  // ✅ FIX: stop infinite reload when URL has ?project= (empty) + only submit when project is valid
  function restoreFiltersIfEmpty(){
    const u = new URL(window.location.href);

    const hasProjectParam = u.searchParams.has('project');
    const urlProject = (u.searchParams.get('project') || '').trim();

    // Case: URL contains project but empty ?project=
    // => do NOT auto restore, user must choose project normally
    if(hasProjectParam && !urlProject){
      // Optional cleanup (commented):
      // u.searchParams.delete('project');
      // history.replaceState({}, '', u.toString());
      return;
    }

    // If URL already has valid project -> do nothing
    if(urlProject) return;

    let savedProject = '';
    let savedStatus = '';
    try{
      savedProject = (localStorage.getItem(LS_KEY_PROJECT) || '').trim();
      savedStatus  = (localStorage.getItem(LS_KEY_STATUS) || '').trim();
    }catch(_){}

    if(!savedProject) return;

    const projectSel = document.getElementById('projectSel');
    const statusSel  = document.getElementById('statusSel');
    const form = document.getElementById('filterForm');
    if(!projectSel || !form) return;

    const exists = Array.from(projectSel.options).some(o =>
      ((o.value||'').trim().toUpperCase() === savedProject.toUpperCase())
    );

    // If saved project not found in dropdown -> clear memory and stop (avoid loop)
    if(!exists){
      try{
        localStorage.removeItem(LS_KEY_PROJECT);
        // optional: also clear status if you want
        // localStorage.removeItem(LS_KEY_STATUS);
      }catch(_){}
      return;
    }

    projectSel.value = savedProject;

    if(statusSel && savedStatus){
      const ok = Array.from(statusSel.options).some(o => (o.value||'') === savedStatus);
      if(ok) statusSel.value = savedStatus;
    }

    // Only submit if we actually have a non-empty project selected
    const v = (projectSel.value || '').trim();
    if(!v) return;

    form.submit();
  }

  // Save on change + on submit
  (function bindFilterMemory(){
    const projectSel = document.getElementById('projectSel');
    const statusSel  = document.getElementById('statusSel');
    const form       = document.getElementById('filterForm');

    if(projectSel){
      projectSel.addEventListener('change', ()=>{
        rememberFilters();
        // UX: nếu đã chọn dự án thì auto submit để load luôn
        const v = (projectSel.value||'').trim();
        if(v){
          form?.submit();
        }
      });
    }
    if(statusSel){
      statusSel.addEventListener('change', ()=>{ rememberFilters(); });
    }
    if(form){
      form.addEventListener('submit', ()=>{ rememberFilters(); });
    }
  })();
  // </editor-fold>

  // <editor-fold desc="Auction Sessions - Modal Create Session">
  // =========================
  // Modal: Create session
  // =========================
  function openCreateSession(){
    const backdrop = document.getElementById('createBackdrop');
    if(!backdrop) return;
    backdrop.style.display='flex';

    // Prefill name if empty
    const n = document.getElementById('csName');
    if(n && !n.value){
      const sel = document.getElementById('projectSel');
      const opt = sel && sel.options[sel.selectedIndex] ? sel.options[sel.selectedIndex] : null;
      const code = opt ? (opt.value || '').trim() : '';
      const d = new Date();
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = d.getFullYear();
      n.value = (code ? (code + " – ") : "") + dd + "/" + mm + "/" + yy;
    }

    // Sync modal project with current top select if possible (by code)
    const topSel = document.getElementById('projectSel');
    const code = topSel ? (topSel.value || '').trim() : '';
    if(code){
      const cs = document.getElementById('csProject');
      if(cs){
        for(const o of cs.options){
          if((o.getAttribute('data-project-code')||'').toUpperCase() === code.toUpperCase()){
            cs.value = o.value;
            break;
          }
        }
      }
    }
  }

  function closeCreateSession(ev){
    if(ev && ev.target && ev.target.id !== 'createBackdrop') return;
    const backdrop = document.getElementById('createBackdrop');
    if(backdrop) backdrop.style.display='none';
  }

  async function submitCreateSession(){
    const cs = document.getElementById('csProject');
    const projectId = Number(cs?.value || 0);
    if(!projectId){
      await alertX({ title: "Thiếu thông tin", message: "Vui lòng chọn dự án.", tone: "warn" });
      return;
    }

    const opt = cs.options[cs.selectedIndex];
    const projectCode = (opt?.getAttribute('data-project-code') || '').trim();

    const payload = {
      project_id: projectId,
      name: (document.getElementById('csName')?.value || "").trim() || null,
      location: (document.getElementById('csLoc')?.value || "").trim() || null,
      note: (document.getElementById('csNote')?.value || "").trim() || null
    };

    // disable buttons to prevent double submit
    const btns = Array.from(document.querySelectorAll('#createBackdrop .btn'));
    btns.forEach(b => b.disabled = true);

    const errText = (js, status) => {
      try{
        if(!js) return "HTTP " + status;
        if(typeof js === 'string') return js;
        return (js.detail || js.error || js.message || ("HTTP " + status + " - " + JSON.stringify(js)));
      }catch(_){
        return "HTTP " + status;
      }
    };

    try{
      const r = await fetch("/auction/sessions/api/sessions", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });

      let js = null;
      try{ js = await r.json(); }catch(_){ js = null; }

      if(!r.ok){
        await alertX({ title: "Tạo phiên thất bại", message: "Tạo phiên lỗi: " + errText(js, r.status), tone: "danger" });
        return;
      }

      // Service A trả: { ok: true, data: {...} }
      const data = (js && typeof js === 'object') ? (js.data || js) : {};
      const sid = data?.id || data?.session_id || js?.id || js?.session_id || "";

      closeCreateSession();
      toast("Đã tạo phiên" + (sid ? (" #" + sid) : "") + ". Đang tải lại...");

      // Remember chosen project/status for next visit
      try{
        if(projectCode) localStorage.setItem(LS_KEY_PROJECT, projectCode);
      }catch(_){}

      // Redirect back to index with project filter so SSR sees new session
      const u = new URL(window.location.href);
      u.pathname = "/auction/sessions";
      if(projectCode) u.searchParams.set('project', projectCode);
      else u.searchParams.delete('project');

      // keep current status filter if any, else empty
      const statusSel = document.getElementById('statusSel');
      const st = (statusSel?.value || '').trim();
      if(st) u.searchParams.set('status', st);
      else u.searchParams.delete('status');

      window.location.href = u.toString();

    }catch(e){
      await alertX({ title: "Lỗi mạng", message: "Lỗi mạng khi tạo phiên: " + (e?.message || "unknown"), tone: "danger" });
    }finally{
      btns.forEach(b => b.disabled = false);
    }
  }
  // </editor-fold>

  // <editor-fold desc="Auction Sessions - Start Session">
  // =========================
  // Start session (custom confirm)
  // =========================
  async function openStartSession(sessionId){
    sessionId = Number(sessionId||0);
    if(!sessionId){
      await alertX({ title: "Thiếu dữ liệu", message: "Thiếu sessionId", tone: "warn" });
      return;
    }

    const ok = await confirmX({
      title: "Start phiên",
      message: "Start phiên #" + sessionId + " để snapshot Round 1?",
      sub: "Thao tác này sẽ tạo Round 1 (lô + khách đủ điều kiện) theo snapshot tại thời điểm hiện tại.",
      tone: "warn",
      okText: "Start",
      cancelText: "Huỷ"
    });

    if(!ok) return;
    await startSession(sessionId);
  }

  async function startSession(sessionId){
    try{
      const r = await fetch("/auction/sessions/api/sessions/start",{
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({session_id: Number(sessionId)})
      });
      const js = await r.json().catch(()=> ({}));
      if(!r.ok){
        await alertX({ title: "Start thất bại", message: "Start lỗi: " + (js.detail || js.error || ("HTTP " + r.status)), tone: "danger" });
        return;
      }
      toast("Đã start phiên #" + sessionId + ". Đang tải lại...");
      window.location.reload();
    }catch(e){
      await alertX({ title: "Lỗi mạng", message: "Lỗi mạng khi start.", tone: "danger" });
    }
  }

  // Open session smart (custom confirm)
  async function openSessionSmart(sessionId, status, currentRoundNo){
    sessionId = Number(sessionId||0);
    status = (status || '').toUpperCase();
    currentRoundNo = Number(currentRoundNo||0);

    if(status === 'DRAFT' || currentRoundNo === 0){
      const ok = await confirmX({
        title: "Phiên chưa snapshot",
        message: "Phiên đang DRAFT / chưa snapshot. Hệ thống sẽ Start để tạo Round 1 rồi mở phiên. Tiếp tục?",
        sub: "Nếu đồng ý, hệ thống sẽ gọi Start phiên trước, sau đó chuyển vào màn hình xử lý phiên.",
        tone: "warn",
        okText: "Tiếp tục",
        cancelText: "Huỷ"
      });
      if(!ok) return;

      try{
        const r = await fetch("/auction/sessions/api/sessions/start",{
          method:"POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({session_id: sessionId})
        });
        const js = await r.json().catch(()=> ({}));
        if(!r.ok){
          await alertX({ title: "Start thất bại", message: "Start lỗi: " + (js.detail || js.error || ("HTTP " + r.status)), tone: "danger" });
          return;
        }
      }catch(e){
        await alertX({ title: "Lỗi mạng", message: "Lỗi mạng khi start.", tone: "danger" });
        return;
      }
    }

    window.location.href = "/auction/sessions/" + sessionId;
  }
  // </editor-fold>

  // <editor-fold desc="Auction Sessions - Init">
  // =========================
  // Init (ONLY ONCE - remove duplicate init)
  // =========================
  (function init(){
    restoreFiltersIfEmpty();

    // Esc to close create modal
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape'){
        const b = document.getElementById('createBackdrop');
        if(b && b.style.display === 'flex') closeCreateSession();
      }
    });
  })();
  // </editor-fold>
</script>

{% endblock %}
