{# templates/auction_session/session.html #}
{% extends "base.html" %}
{% block title %}{{ title or "Phiên đấu" }}{% endblock %}

{% block content %}
<style>
  :root{
    --bd: rgba(226,232,240,1);
    --bd2: rgba(241,245,249,1);
    --ink: rgba(15,23,42,1);
    --muted: rgba(100,116,139,1);
    --bg: #fff;
    --bg2: rgba(248,250,252,1);
    --pri: #0ea5e9;
    --pri2:#0284c7;
    --ok:#16a34a;
    --warn:#f59e0b;
    --bad:#ef4444;
    --shadow: 0 18px 44px rgba(2,6,23,.18);
  }

  .wrap{max-width:1220px;margin:0 auto;padding:16px;}
  .top{
    display:flex;justify-content:space-between;align-items:flex-start;gap:14px;flex-wrap:wrap;
    padding:14px 16px;border:1px solid var(--bd);border-radius:18px;background:linear-gradient(180deg, rgba(248,250,252,.92), #fff);
    box-shadow:0 2px 10px rgba(2,6,23,.04);
  }
  .tleft h1{margin:0;font-size:18px;color:var(--ink);font-weight:1000;}
  .tleft .sub{margin-top:6px;color:var(--muted);font-size:13px;display:flex;flex-wrap:wrap;gap:10px;line-height:1.35;}
  .sub b{color:var(--ink);}

  .tright{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;}

  .btn{
    height:36px;border-radius:12px;border:1px solid var(--bd);background:#fff;
    padding:0 12px;font-weight:1000;font-size:13px;color:var(--ink);cursor:pointer;
    display:inline-flex;align-items:center;gap:8px;text-decoration:none;transition:.15s ease;
  }
  .btn:hover{transform:translateY(-1px);box-shadow:0 10px 20px rgba(2,6,23,.08);}
  .btn.primary{background:linear-gradient(180deg, var(--pri), var(--pri2));border-color:rgba(2,132,199,.5);color:#fff;}
  .btn.ghost{background:rgba(248,250,252,1);}
  .btn.danger{background:rgba(239,68,68,.06);border-color:rgba(239,68,68,.25);color:#991b1b;}
  .btn:disabled{opacity:.55;cursor:not-allowed;transform:none;box-shadow:none;}

  .pill{
    display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;
    font-size:12px;font-weight:1000;border:1px solid var(--bd);background:#fff;color:var(--muted);
  }
  .pill.ok{color:var(--ok);border-color:rgba(22,163,74,.25);background:rgba(22,163,74,.06);}
  .pill.warn{color:var(--warn);border-color:rgba(245,158,11,.25);background:rgba(245,158,11,.08);}
  .pill.bad{color:var(--bad);border-color:rgba(239,68,68,.25);background:rgba(239,68,68,.06);}

  /* Round tabs */
  .tabs{ margin-top:12px; display:flex;gap:8px;flex-wrap:wrap;align-items:center; }
  .tab{
    height:34px;border-radius:999px;border:1px solid var(--bd);background:#fff;
    padding:0 12px;display:inline-flex;align-items:center;gap:8px;
    font-size:12px;font-weight:1000;color:var(--ink);text-decoration:none;cursor:pointer;
  }
  .tab.active{
    background:linear-gradient(180deg, rgba(14,165,233,.15), rgba(14,165,233,.07));
    border-color:rgba(14,165,233,.35);
    color:#075985;
  }
  .roundMore{
    height:34px;border-radius:999px;border:1px solid var(--bd);background:#fff;
    padding:0 10px;font-size:12px;font-weight:1000;color:var(--ink);
  }

  /* Summary cards */
  .sum{ margin-top:12px; display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; }
  .sumCard{
    border:1px solid var(--bd);
    border-radius:16px;
    background:#fff;
    box-shadow:0 2px 10px rgba(2,6,23,.04);
    padding:12px 12px;
    display:flex;flex-direction:column;gap:6px;
  }
  .sumCard .k{font-size:12px;color:var(--muted);font-weight:1000;display:flex;gap:8px;align-items:center;}
  .sumCard .v{font-size:18px;color:var(--ink);font-weight:1100;letter-spacing:.2px;}
  .sumCard .h{font-size:12px;color:var(--muted);line-height:1.25;}

  /* Table card */
  .card{
    margin-top:12px;border:1px solid var(--bd);border-radius:18px;background:#fff;
    box-shadow:0 2px 10px rgba(2,6,23,.04);overflow:hidden;
  }
  .card-h{
    padding:12px 14px;border-bottom:1px solid var(--bd2);
    background:rgba(248,250,252,1);
    display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
  }
  .card-h b{font-size:13px;color:var(--ink);}
  .search{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
  .search input{
    height:34px;border-radius:12px;border:1px solid var(--bd);
    padding:0 10px;font-size:13px;outline:none;min-width:240px;
  }
  .search input:focus{border-color:rgba(14,165,233,.6); box-shadow:0 0 0 3px rgba(14,165,233,.15);}

  table{width:100%;border-collapse:separate;border-spacing:0;}
  thead th{
    text-align:left;font-size:12px;color:var(--muted);font-weight:1000;
    padding:10px 12px;border-bottom:1px solid var(--bd2);background:#fff;
    position:sticky;top:0;z-index:2;
  }
  tbody td{
    padding:12px;border-bottom:1px solid var(--bd2);vertical-align:top;font-size:13px;color:var(--ink);
  }
  tbody tr:hover td{background:rgba(248,250,252,.65);}

  /* LOT INFO (gọn 2 dòng) */
  .lotTitle{
    font-weight:1100;
    letter-spacing:.15px;
    font-size:15px;
    line-height:1.2;
    color:rgba(15,23,42,1);
    display:flex;
    align-items:flex-start;
    gap:10px;
  }
  .lotDot{
    width:10px;height:10px;border-radius:999px;flex:0 0 auto;margin-top:3px;
    background:linear-gradient(180deg, rgba(14,165,233,.95), rgba(2,132,199,.95));
    box-shadow:0 8px 16px rgba(2,132,199,.25);
  }
  .lotLines{display:flex;flex-direction:column;gap:4px;}
  .lotCode{font-weight:1200;}
  .lotDesc{color:var(--muted);font-size:12px;line-height:1.25;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;}

  .muted{color:var(--muted);font-size:12px;line-height:1.25;margin-top:4px;}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;}
  .right{display:flex;justify-content:flex-end;}

  .miniBtn{
    height:32px;border-radius:12px;border:1px solid var(--bd);
    background:#fff;padding:0 10px;font-size:12px;font-weight:1000;cursor:pointer;
    display:inline-flex;align-items:center;gap:8px;
  }
  .miniBtn.primary{background:linear-gradient(180deg, var(--pri), var(--pri2));border-color:rgba(2,132,199,.5);color:#fff;}
  .miniBtn.ghost{background:rgba(248,250,252,1);}
  .miniBtn:hover{transform:translateY(-1px);box-shadow:0 10px 18px rgba(2,6,23,.08);}
  .miniBtn:disabled{opacity:.55;cursor:not-allowed;transform:none;box-shadow:none;}

  .printIcon{
    height:26px;border-radius:10px;border:1px solid var(--bd);
    background:#fff;padding:0 8px;font-size:12px;font-weight:1000;cursor:pointer;
    display:inline-flex;align-items:center;gap:6px;
  }
  .printIcon:hover{transform:translateY(-1px);box-shadow:0 10px 18px rgba(2,6,23,.08);}

  .empty{padding:16px;color:var(--muted);font-size:13px;}

  /* Big Next count */
  .bigCount{
    display:inline-flex;align-items:center;gap:8px;margin-top:8px;
    padding:8px 10px;border-radius:14px;border:1px solid rgba(245,158,11,.25);
    background:rgba(245,158,11,.08);
  }
  .bigCount .n{
    font-size:18px;font-weight:1300;letter-spacing:.2px;color:#92400e;line-height:1;
  }
  .bigCount .t{font-size:12px;font-weight:1000;color:rgba(100,116,139,.95);line-height:1.2;}

  /* Modal — fixed viewport, body scroll, footer sticky */
  .backdrop{
    position:fixed;inset:0;background:rgba(2,6,23,.58);
    display:none;align-items:center;justify-content:center;
    padding:18px 14px;z-index:9999;
  }
  .modal{
    width:100%;max-width:980px;background:#fff;border-radius:18px;
    border:1px solid rgba(226,232,240,1);box-shadow:var(--shadow);overflow:hidden;
    max-height: calc(100vh - 48px);
    display:flex;flex-direction:column;
  }
  .mh{
    padding:14px 16px;border-bottom:1px solid var(--bd2);
    display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
    background:linear-gradient(180deg, rgba(248,250,252,.95), #fff);
    flex:0 0 auto;
  }
  .mh b{font-size:14px;color:var(--ink);font-weight:1100;}
  .mh .mmeta{margin-top:6px;color:var(--muted);font-size:12px;display:flex;gap:10px;flex-wrap:wrap;}
  .xbtn{ width:34px;height:34px;border-radius:10px;border:1px solid var(--bd); background:#fff;cursor:pointer;font-weight:900; }

  .mb{padding:14px 16px;background:#fff; overflow:auto; flex:1 1 auto;}

  /* vertical blocks */
  .vstack{display:flex;flex-direction:column;gap:12px;}

  .box{
    border:1px solid var(--bd);
    border-radius:16px;
    overflow:hidden;
    background:#fff;
  }
  .box-h{
    padding:10px 12px;border-bottom:1px solid var(--bd2);
    background:rgba(248,250,252,1);
    display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
  }
  .box-h b{font-size:12px;color:var(--ink);font-weight:1100;}
  .box-b{padding:12px;}

  .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px;}
  .field label{font-size:12px;color:var(--muted);font-weight:1000;}
  .field select,.field input,.field textarea{
    height:36px;border-radius:12px;border:1px solid var(--bd);
    padding:0 10px;font-size:13px;outline:none;background:#fff;color:var(--ink);
  }
  .field textarea{height:auto;min-height:78px;padding:10px;resize:vertical;}
  .field select:focus,.field input:focus,.field textarea:focus{
    border-color:rgba(14,165,233,.6);box-shadow:0 0 0 3px rgba(14,165,233,.15);
  }

  /* Win method prominent */
  .field.prominent label{display:flex;align-items:center;gap:8px;}
  .field.prominent select{
    height:44px;border-radius:14px;font-size:14px;font-weight:1100;letter-spacing:.2px;
    background:linear-gradient(180deg, rgba(14,165,233,.06), rgba(248,250,252,.85));
    border-color:rgba(14,165,233,.28);
  }
  .field.prominent select:focus{
    border-color:rgba(14,165,233,.6);
    box-shadow:0 0 0 4px rgba(14,165,233,.16);
  }

  .seg{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;}
  .seg button{
    height:34px;border-radius:999px;border:1px solid var(--bd);background:#fff;
    padding:0 12px;font-size:12px;font-weight:1000;cursor:pointer;color:var(--ink);
  }
  .seg button.active{
    background:linear-gradient(180deg, rgba(14,165,233,.15), rgba(14,165,233,.07));
    border-color:rgba(14,165,233,.35);
    color:#075985;
  }

  /* Price block */
  .priceCard{
    border:1px solid rgba(14,165,233,.22);
    background:linear-gradient(180deg, rgba(14,165,233,.05), rgba(248,250,252,.82));
    border-radius:16px;
    padding:12px 12px;
    display:flex;align-items:flex-end;justify-content:space-between;gap:12px;flex-wrap:wrap;
    margin:10px 0 12px;
  }
  .priceCard .plabel{
    font-size:12px;color:var(--muted);font-weight:1000;
    display:flex;align-items:center;gap:8px;
  }
  .priceCard .pvalue{
    font-size:26px;font-weight:1200;letter-spacing:.3px;color:var(--ink);line-height:1.05;
  }
  .priceCard .pvalue.muted{color:rgba(15,23,42,.55);}
  .priceCard .pinput{min-width:300px;display:flex;flex-direction:column;gap:6px;}
  .moneyWrap{position:relative;}
  .moneySuffix{
    position:absolute;right:12px;top:50%;transform:translateY(-50%);
    font-size:12px;font-weight:1100;color:rgba(100,116,139,.9);
    pointer-events:none;
    padding-left:10px;
    background:linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.9));
  }
  .priceInput{
    height:46px !important;
    border-radius:14px !important;
    font-size:18px !important;
    font-weight:1200 !important;
    letter-spacing:.3px;
    padding:0 48px 0 12px !important;
    background:rgba(255,255,255,.92) !important;
    border-color:rgba(2,132,199,.22) !important;
  }
  .priceInput:focus{
    border-color:rgba(14,165,233,.6) !important;
    box-shadow:0 0 0 4px rgba(14,165,233,.16) !important;
  }
  .priceHelp{font-size:12px;color:var(--muted);line-height:1.35;}

  /* Winner picker */
  .picker{
    border:1px solid var(--bd);
    border-radius:14px;
    overflow:hidden;
    background:#fff;
    display:flex;
    flex-direction:column;
    min-height:260px;
  }
  .picker .ph{
    padding:10px 10px;border-bottom:1px solid var(--bd2);
    background:rgba(248,250,252,1);
    display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;
  }
  .picker .ph b{font-size:12px;font-weight:1100;}
  .picker .ph input{
    height:30px;border-radius:10px;border:1px solid var(--bd);
    padding:0 8px;font-size:12px;outline:none;min-width:180px;
  }
  .picker .pb{ padding:8px;display:flex;flex-direction:column;gap:8px;overflow:auto;max-height:340px; }
  .pitem{
    border:1px solid var(--bd);
    border-radius:12px;
    padding:10px;
    background:#fff;
    display:flex;justify-content:space-between;gap:10px;align-items:flex-start;
    cursor:pointer;
  }
  .pitem:hover{background:rgba(248,250,252,.7);}
  .pitem.selected{
    border-color:rgba(14,165,233,.55);
    box-shadow:0 0 0 3px rgba(14,165,233,.12);
  }
  .pitem b{font-size:13px;font-weight:1100;}
  .pitem .pm{font-size:12px;color:var(--muted);margin-top:4px;line-height:1.25;}
  .pitem .tag{
    display:inline-flex;align-items:center;gap:6px;
    padding:3px 8px;border-radius:999px;
    font-size:11px;font-weight:1000;
    border:1px solid var(--bd);background:#fff;color:var(--muted);
    white-space:nowrap;
  }
  .pitem.selected .tag{color:#075985;border-color:rgba(14,165,233,.35);background:rgba(14,165,233,.08);}

  /* Dual list */
  .dual{display:grid;grid-template-columns: 1fr 70px 1fr;gap:10px;align-items:stretch;}
  .plist{
    border:1px solid var(--bd);
    border-radius:14px;
    overflow:hidden;
    background:#fff;
    display:flex;
    flex-direction:column;
    min-height:300px;
  }
  .plist .ph{
    padding:10px 10px;border-bottom:1px solid var(--bd2);
    background:rgba(248,250,252,1);
    display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;
  }
  .plist .ph b{font-size:12px;font-weight:1100;}
  .plist .ph input{
    height:30px;border-radius:10px;border:1px solid var(--bd);
    padding:0 8px;font-size:12px;outline:none;min-width:140px;
  }
  .plist .pb{ padding:8px;display:flex;flex-direction:column;gap:8px;overflow:auto;max-height:360px; }
  .pitem2{
    border:1px solid var(--bd);
    border-radius:12px;
    padding:10px;
    background:#fff;
    display:flex;justify-content:space-between;gap:10px;align-items:flex-start;
  }
  .pitem2 b{font-size:13px;font-weight:1100;}
  .pitem2 .pm{font-size:12px;color:var(--muted);margin-top:4px;line-height:1.25;}
  .pitem2 .pact{display:flex;flex-direction:column;gap:6px;align-items:flex-end;}

  .iconbtn{
    height:30px;border-radius:10px;border:1px solid var(--bd);
    background:#fff;padding:0 10px;font-size:12px;font-weight:1000;cursor:pointer;
    display:inline-flex;align-items:center;gap:8px;
  }
  .iconbtn.primary{background:rgba(14,165,233,.08);border-color:rgba(14,165,233,.25);color:#075985;}
  .iconbtn.danger{background:rgba(239,68,68,.06);border-color:rgba(239,68,68,.25);color:#991b1b;}

  .arrows{ display:flex;flex-direction:column;justify-content:center;align-items:center;gap:10px; }
  .arrows .iconbtn{width:60px;justify-content:center;}

  .foot{
    padding:14px 16px;border-top:1px solid var(--bd2);
    background:rgba(248,250,252,.9);
    display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap;
    flex:0 0 auto;
  }
  .hint{color:var(--muted);font-size:12px;line-height:1.3;}
  .toast{
    position:fixed;right:16px;bottom:16px;z-index:10000;
    background:#0f172a;color:#fff;border-radius:14px;padding:10px 12px;
    font-size:13px;box-shadow:0 10px 30px rgba(2,6,23,.25);
    display:none;max-width:520px;line-height:1.35;
  }

  /* ===== Custom Dialog (Confirm/Error) ===== */
  .dlg-backdrop{
    position:fixed;inset:0;background:rgba(2,6,23,.58);
    display:none;align-items:center;justify-content:center;
    padding:18px 14px;z-index:11000;
  }
  .dlg{
    width:100%;max-width:640px;background:#fff;border-radius:18px;
    border:1px solid rgba(226,232,240,1);box-shadow:var(--shadow);overflow:hidden;
  }
  .dlg-h{
    padding:12px 14px;border-bottom:1px solid var(--bd2);
    background:linear-gradient(180deg, rgba(248,250,252,.95), #fff);
    display:flex;align-items:center;justify-content:space-between;gap:10px;
  }
  .dlg-h b{font-size:13px;color:var(--ink);font-weight:1100;}
  .dlg-x{
    width:34px;height:34px;border-radius:10px;border:1px solid var(--bd);
    background:#fff;cursor:pointer;font-weight:900;
  }
  .dlg-b{padding:14px;}
  .dlg-msg{color:var(--ink);font-size:13px;line-height:1.45;white-space:pre-wrap;}
  .dlg-sub{margin-top:8px;color:var(--muted);font-size:12px;line-height:1.35;}
  .dlg-in{ margin-top:12px; display:none; }
  .dlg-in label{display:block;font-size:12px;color:var(--muted);font-weight:1000;margin-bottom:6px;}
  .dlg-in input{
    width:100%;
    height:38px;border-radius:12px;border:1px solid var(--bd);
    padding:0 10px;font-size:13px;outline:none;background:#fff;color:var(--ink);
  }
  .dlg-in input:focus{border-color:rgba(14,165,233,.6); box-shadow:0 0 0 3px rgba(14,165,233,.15);}
  .dlg-f{
    padding:12px 14px;border-top:1px solid var(--bd2);
    background:rgba(248,250,252,.9);
    display:flex;justify-content:flex-end;gap:10px;align-items:center;flex-wrap:wrap;
  }

  @media (max-width: 1040px){
    .dual{grid-template-columns:1fr;}
    .arrows{flex-direction:row;}
    .sum{grid-template-columns:1fr 1fr;}
    thead{display:none;}
    table, tbody, tr, td {display:block;width:100%;}
    tbody td{border-bottom:0;}
    tbody tr{border-bottom:1px solid var(--bd2);}
    .right{justify-content:flex-start;}
    .priceCard .pinput{min-width:100%;}
  }
</style>

<div class="wrap">

  <div class="top">
    <div class="tleft">
      <h1>{{ title or ("Phiên đấu #" ~ session_id) }}</h1>
      <div class="sub">
        <span class="pill {% if (session.status or '')=='OPEN' %}ok{% elif (session.status or '') in ['DRAFT','PAUSED'] %}warn{% else %}bad{% endif %}">
          <i class="ri-pulse-line"></i> {{ session.status or "—" }}
        </span>
        <span><i class="ri-building-2-line"></i> Project: <b>{{ session.project_code or "-" }}</b></span>
        <span><i class="ri-stack-line"></i> Round: <b>#{{ round_no or 1 }}</b></span>
      </div>

      <div class="tabs" id="roundTabs">
        {% set rs = rounds or [] %}
        {% if rs|length > 0 %}
          {% for r in rs %}
            <a class="tab {% if (r.round_no or r.get('round_no')) == round_no %}active{% endif %}"
               href="/auction/sessions/{{ session_id }}?round_no={{ r.round_no or r.get('round_no') }}">
              Vòng {{ r.round_no or r.get('round_no') }}
            </a>
          {% endfor %}
        {% else %}
          <span class="pill warn"><i class="ri-information-line"></i> Chưa có vòng</span>
        {% endif %}
      </div>
    </div>

    <div class="tright">
      <a class="btn ghost" href="/auction/sessions"><i class="ri-arrow-left-line"></i> Quay lại</a>

      {# Start/Mở là 1 hành động, gọi start (A idempotent) #}
      <button class="btn" type="button" onclick="startSessionIfNeeded()">
        <i class="ri-rocket-line"></i> Mở phiên (Start)
      </button>

      <button class="btn primary" type="button" onclick="createNextRound()">
        <i class="ri-skip-forward-line"></i> Tạo vòng sau
      </button>

      <button class="btn" type="button" onclick="refreshAll()">
        <i class="ri-refresh-line"></i> Làm mới
      </button>
    </div>
  </div>

  {% if error %}
    <div style="margin-top:12px;border:1px solid rgba(239,68,68,.25);background:rgba(239,68,68,.06);color:#991b1b;padding:10px 12px;border-radius:16px;">
      <b>Lỗi tải UI vòng:</b> status={{ error.status }}
      <div style="margin-top:6px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;font-size:12px;white-space:pre-wrap;">
        {{ error.body }}
      </div>
    </div>
  {% endif %}

  <div class="sum">
    <div class="sumCard">
      <div class="k"><i class="ri-checkbox-circle-line"></i> Tổng lô (vòng này)</div>
      <div class="v" id="sumLots">0</div>
      <div class="h">Đếm theo snapshot round lots.</div>
    </div>
    <div class="sumCard">
      <div class="k"><i class="ri-user-3-line"></i> Tổng khách đấu (unique)</div>
      <div class="v" id="sumCustomers">0</div>
      <div class="h">Unique theo <span class="mono">customer_id</span> trong vòng.</div>
    </div>
    <div class="sumCard">
      <div class="k"><i class="ri-trophy-line"></i> Lô WON</div>
      <div class="v" id="sumWon">0</div>
      <div class="h">Theo <span class="mono">result_type=WINNER</span> + results.</div>
    </div>
    <div class="sumCard">
      <div class="k"><i class="ri-arrow-right-up-line"></i> Lô sang vòng sau</div>
      <div class="v" id="sumNext">0</div>
      <div class="h">Theo <span class="mono">result_type=NEXT_ROUND</span>.</div>
    </div>
  </div>

  <div class="card">
    <div class="card-h">
      <b>Danh sách lô — Round #{{ round_no }}</b>
      <div class="search">
        <input id="q" placeholder="Tìm theo mã lô / mô tả..." oninput="renderLots()" />
        {# Các nút in: giữ chỗ, không làm impact nghiệp vụ nếu backend chưa nối #}
        <button class="miniBtn ghost" type="button" onclick="printAllBidTickets()">
          <i class="ri-printer-line"></i> In toàn bộ phiếu trả giá
        </button>
        <button class="miniBtn primary" type="button" onclick="printRoundWinners()">
          <i class="ri-printer-line"></i> In phiếu trúng (vòng)
        </button>
      </div>
    </div>

    <div style="max-height: calc(100vh - 380px); overflow:auto;">
      <table>
        <thead>
          <tr>
            <th style="width:230px;">Lô</th>
            <th>Thông tin</th>
            <th style="width:340px;">Kết quả vòng này</th>
            <th class="right" style="width:170px;">Thao tác</th>
          </tr>
        </thead>
        <tbody id="lotTbody"></tbody>
      </table>

      <div id="emptyState" class="empty" style="display:none;">
        Không có lô nào phù hợp bộ lọc.
      </div>
    </div>
  </div>

</div>

<!-- =========================================================
     Modal: Decide Lot
========================================================== -->
<div id="backdrop" class="backdrop" onclick="closeModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="mh">
      <div>
        <b id="mTitle"><i class="ri-settings-3-line"></i> Xử lý lô</b>
        <div class="mmeta" id="mMeta"></div>
      </div>
      <button class="xbtn" type="button" onclick="closeModal()"><i class="ri-close-line"></i></button>
    </div>

    <div class="mb">
      <div class="vstack">

        <div class="box">
          <div class="box-h">
            <b><i class="ri-landscape-line"></i> Thông tin lô (vòng hiện tại)</b>
            <span class="pill" id="mStatusPill">—</span>
          </div>
          <div class="box-b" id="mLotInfo"></div>
        </div>

        <div class="box">
          <div class="box-h">
            <b><i class="ri-gavel-line"></i> Chốt kết quả vòng này</b>
            <span class="pill" id="mLockPill" style="display:none;"></span>
          </div>
          <div class="box-b">

            <div class="seg">
              <button id="segWinner" type="button" onclick="switchMode('WINNER')">1) Chốt WON</button>
              <button id="segNext" type="button" onclick="switchMode('NEXT')">2) Vào vòng sau</button>
              <button id="segNoValid" type="button" onclick="switchMode('NO_VALID')">No valid</button>
            </div>

            <!-- MODE WINNER -->
            <div id="modeWinner">

              <div class="field prominent">
                <label><i class="ri-award-line"></i> Hình thức thắng (quan trọng)</label>
                <select id="winMethod" onchange="onWinMethodChange()">
                  <option value="HIGHEST">Trả giá cao nhất (HIGHEST)</option>
                  <option value="MANUAL">Nhập tay / quyết định (MANUAL)</option>
                  <option value="LOTTERY">Bốc thăm (LOTTERY)</option>
                </select>
              </div>

              <div class="priceCard" id="winnerPriceCard">
                <div>
                  <div class="plabel"><i class="ri-flag-2-line"></i> Giá khởi điểm vòng</div>
                  <div class="pvalue" id="mStartPriceText">—</div>
                </div>

                <div class="pinput">
                  <div class="plabel" id="winningPriceLabel"><i class="ri-money-dollar-circle-line"></i> Giá trúng (VND)</div>
                  <div class="moneyWrap">
                    <input id="winningPrice" class="priceInput" inputmode="numeric" placeholder="Nhập giá trúng..."
                           oninput="onMoneyInput('winningPrice')" />
                    <span class="moneySuffix">VND</span>
                  </div>
                  <div class="priceHelp" id="winningPriceHelp">Nhập số, hệ thống sẽ tự format dạng tiền (1.234.567).</div>
                </div>

                <div>
                  <div class="plabel"><i class="ri-eye-line"></i> Hiển thị</div>
                  <div class="pvalue muted" id="winningPricePretty">—</div>
                </div>
              </div>

              <div class="picker">
                <div class="ph">
                  <b>Chọn người thắng (search)</b>
                  <input id="winnerSearch" placeholder="tìm theo tên/CCCD/SĐT..." oninput="renderWinnerPicker()" />
                </div>
                <div class="pb" id="winnerList"></div>
              </div>
              <input type="hidden" id="winnerCustomerId" />

              <div class="field" style="margin-top:10px;">
                <label>Ghi chú</label>
                <textarea id="noteWinner" placeholder="Tuỳ chọn..."></textarea>
              </div>
            </div>

            <!-- MODE NEXT ROUND -->
            <div id="modeNext" style="display:none;">

              <div class="priceCard" id="nextPriceCard">
                <div>
                  <div class="plabel"><i class="ri-flag-2-line"></i> Giá khởi điểm vòng</div>
                  <div class="pvalue" id="mStartPriceText2">—</div>
                </div>

                <div class="pinput">
                  <div class="plabel"><i class="ri-line-chart-line"></i> Giá cao nhất vòng này (VND)</div>
                  <div class="moneyWrap">
                    <input id="highestPrice" class="priceInput" inputmode="numeric" placeholder="Nhập giá cao nhất..."
                           oninput="onMoneyInput('highestPrice')" />
                    <span class="moneySuffix">VND</span>
                  </div>
                  <div class="priceHelp">Giá này sẽ dùng làm <b>giá khởi điểm vòng sau</b> (unit theo bid_price_unit).</div>
                </div>

                <div>
                  <div class="plabel"><i class="ri-eye-line"></i> Hiển thị</div>
                  <div class="pvalue muted" id="highestPricePretty">—</div>
                </div>
              </div>

              <div class="dual">
                <div class="plist">
                  <div class="ph">
                    <b id="dualInTitle">Trong vòng này</b>
                    <input id="filterIn" placeholder="lọc..." oninput="renderDualLists()" />
                  </div>
                  <div class="pb" id="listIn"></div>
                </div>

                <div class="arrows">
                  <button class="iconbtn primary" type="button" onclick="moveAllToNext()"><i class="ri-arrow-right-double-line"></i></button>
                  <button class="iconbtn" type="button" onclick="moveAllToIn()"><i class="ri-arrow-left-double-line"></i></button>
                </div>

                <div class="plist">
                  <div class="ph">
                    <b id="dualNextTitle">Vào vòng sau</b>
                    <input id="filterNext" placeholder="lọc..." oninput="renderDualLists()" />
                  </div>
                  <div class="pb" id="listNext"></div>
                </div>
              </div>

              <div class="field" style="margin-top:10px;">
                <label>Ghi chú</label>
                <textarea id="noteNext" placeholder="Tuỳ chọn..."></textarea>
              </div>

              <div class="hint">
                Vòng sau sẽ lấy <b>giá khởi điểm = giá cao nhất vòng này</b> (theo API create_next_round).
              </div>
            </div>

            <!-- MODE NO VALID -->
            <div id="modeNoValid" style="display:none;">
              <div class="hint">Chọn khi lô không có phiếu hợp lệ / không đủ điều kiện.</div>
              <div class="field" style="margin-top:10px;">
                <label>Ghi chú</label>
                <textarea id="noteNoValid" placeholder="Tuỳ chọn..."></textarea>
              </div>
            </div>

          </div>
        </div>

      </div>
    </div>

    <div class="foot">
      <div class="hint" id="mHint">
        API: <code class="mono">/auction/sessions/api/round-lots/{id}/decide</code>. Nếu bị khoá, API trả <b>409 LOCKED_BY_...</b>.
      </div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <button class="btn danger" type="button" onclick="resetPending()"><i class="ri-restart-line"></i> Reset PENDING</button>
        <button class="btn primary" type="button" onclick="submitDecide()"><i class="ri-check-line"></i> Lưu kết quả</button>
      </div>
    </div>
  </div>
</div>

<!-- =========================================================
     Custom Dialog (Confirm/Error)
========================================================== -->
<div id="dlgBackdrop" class="dlg-backdrop" onclick="dlgClose(event)">
  <div class="dlg" onclick="event.stopPropagation()">
    <div class="dlg-h">
      <b id="dlgTitle"><i class="ri-information-line"></i> Thông báo</b>
      <button class="dlg-x" type="button" onclick="dlgClose()"><i class="ri-close-line"></i></button>
    </div>
    <div class="dlg-b">
      <div class="dlg-msg" id="dlgMsg"></div>
      <div class="dlg-sub" id="dlgSub" style="display:none;"></div>

      <div class="dlg-in" id="dlgInputWrap">
        <label id="dlgInputLabel">Nhập xác nhận</label>
        <input id="dlgInput" placeholder="" />
        <div class="dlg-sub" id="dlgInputHint" style="margin-top:6px;display:block;"></div>
      </div>
    </div>
    <div class="dlg-f">
      <button class="btn ghost" type="button" id="dlgCancel" onclick="dlgCancel()">
        <i class="ri-close-line"></i> Huỷ
      </button>
      <button class="btn primary" type="button" id="dlgOk" onclick="dlgOk()" disabled>
        <i class="ri-check-line"></i> Xác nhận
      </button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
  // =========================
  // Boot data from server (SSR)
  // =========================
  const SESSION_ID = Number({{ session_id|int }});
  let ROUND_NO = Number({{ round_no|int }});

  let UI = {{ ui|tojson }};
  let SESSION = {{ session|tojson }};
  let ROUNDS = {{ rounds|tojson }};

  // results map by lot_id from /results
  let RESULTS = [];
  let RESULT_BY_LOT = {}; // lot_id => result row

  // modal state
  let currentLot = null;            // round_lot object
  let currentParticipants = [];
  let dualIn = [];
  let dualNext = [];
  let selectedWinnerId = null;

  // =========================
  // Toast
  // =========================
  function toast(msg){
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.style.display = 'block';
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=>{ t.style.display='none'; }, 3200);
  }

  // =========================
  // Utils
  // =========================
  function fmtMoney(v){
    const n = Number(v || 0);
    if(!isFinite(n)) return '-';
    return n.toLocaleString('vi-VN');
  }

  function safeText(s){
    return (s === null || s === undefined) ? '' : String(s);
  }

  function escapeHtml(str){
    return (str||'').toString()
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  function pad3(n){
    n = Number(n||0);
    if(!isFinite(n) || n<=0) return '';
    return String(n).padStart(3,'0');
  }

  function fmtStt(stt){
    const s = pad3(stt);
    return s ? s : '';
  }

  function maskPhone(s){
    const x = safeText(s).replace(/\s+/g,'');
    if(!x) return '';
    if(x.length <= 4) return '****';
    return x.slice(0,2) + '****' + x.slice(-2);
  }

  function getLotSnapshot(lot){
    const snap = (lot && (lot.lot_snapshot || (lot.extras && lot.extras.snapshot))) || {};
    return snap || {};
  }

  function participantSnapshot(p){
    return (p && (p.customer_snapshot || (p.extras && p.extras.snapshot))) || {};
  }

  function getStartPriceVnd(lot){
    const snap = getLotSnapshot(lot);
    const sp = (lot && lot.start_price_vnd != null) ? Number(lot.start_price_vnd) : Number(snap.starting_price_vnd || 0);
    return isFinite(sp) ? sp : 0;
  }

  function stripToDigits(s){
    return String(s||'').replace(/[^\d]/g,'');
  }

  function formatMoneyDigits(digits){
    if(!digits) return '';
    const n = Number(digits);
    if(!isFinite(n)) return '';
    return n.toLocaleString('vi-VN');
  }

  function onMoneyInput(id){
    const el = document.getElementById(id);
    if(!el) return;
    const raw = el.value || '';
    const digits = stripToDigits(raw);
    const pretty = formatMoneyDigits(digits);
    el.value = pretty;

    if(id === 'winningPrice'){
      const pp = document.getElementById('winningPricePretty');
      pp.textContent = pretty || '—';
      pp.className = 'pvalue' + (pretty ? '' : ' muted');
    }
    if(id === 'highestPrice'){
      const pp = document.getElementById('highestPricePretty');
      pp.textContent = pretty || '—';
      pp.className = 'pvalue' + (pretty ? '' : ' muted');
    }
  }

  function parseMoneyInput(id){
    const el = document.getElementById(id);
    if(!el) return null;
    const digits = stripToDigits(el.value || '');
    if(!digits) return null;
    const n = Number(digits);
    if(!isFinite(n)) return null;
    return n;
  }

  // =========================
  // Custom Dialog
  // =========================
  let __dlgResolve = null;
  let __dlgRequireText = null;

  function dlgClose(ev){
    if(ev && ev.target && ev.target.id !== 'dlgBackdrop') return;
    document.getElementById('dlgBackdrop').style.display = 'none';
  }
  function dlgCancel(){
    dlgClose();
    if(__dlgResolve){ __dlgResolve(false); __dlgResolve = null; }
  }
  function dlgOk(){
    const okBtn = document.getElementById('dlgOk');
    if(okBtn && okBtn.disabled) return;

    if(__dlgRequireText){
      const ii = document.getElementById('dlgInput');
      const v = (ii.value || '').trim();
      if(v !== __dlgRequireText){
        const ih = document.getElementById('dlgInputHint');
        ih.textContent = `Sai xác nhận. Bạn phải nhập đúng: "${__dlgRequireText}".`;
        ih.style.color = '#991b1b';
        okBtn.disabled = true;
        return;
      }
    }

    dlgClose();
    if(__dlgResolve){ __dlgResolve(true); __dlgResolve = null; }
  }

  function showDialog(opts){
    const title = safeText(opts.title || 'Thông báo');
    const msg = safeText(opts.message || '');
    const sub = safeText(opts.sub || '');
    const mode = opts.mode || 'confirm';
    const okText = safeText(opts.okText || (mode==='alert' ? 'Đóng' : 'Xác nhận'));
    const cancelText = safeText(opts.cancelText || 'Huỷ');

    __dlgRequireText = (opts.requireText || null);

    const b = document.getElementById('dlgBackdrop');
    const t = document.getElementById('dlgTitle');
    const m = document.getElementById('dlgMsg');
    const s = document.getElementById('dlgSub');

    const iw = document.getElementById('dlgInputWrap');
    const ii = document.getElementById('dlgInput');
    const ih = document.getElementById('dlgInputHint');

    const okBtn = document.getElementById('dlgOk');
    const cancelBtn = document.getElementById('dlgCancel');

    t.innerHTML = `<i class="${mode==='error' ? 'ri-error-warning-line' : 'ri-information-line'}"></i> ${escapeHtml(title)}`;
    m.textContent = msg;

    if(sub){
      s.style.display = 'block';
      s.textContent = sub;
    } else {
      s.style.display = 'none';
      s.textContent = '';
    }

    okBtn.innerHTML = `<i class="ri-check-line"></i> ${escapeHtml(okText)}`;
    cancelBtn.innerHTML = `<i class="ri-close-line"></i> ${escapeHtml(cancelText)}`;

    if(__dlgRequireText){
      iw.style.display = 'block';
      ii.value = '';
      ii.placeholder = __dlgRequireText;

      ih.style.color = '';
      ih.textContent = `Bạn phải nhập đúng: "${__dlgRequireText}" để bật nút xác nhận.`;

      okBtn.disabled = true;

      ii.oninput = ()=>{
        const v = (ii.value || '').trim();
        ih.style.color = '';
        ih.textContent = `Bạn phải nhập đúng: "${__dlgRequireText}" để bật nút xác nhận.`;
        okBtn.disabled = (v !== __dlgRequireText);
      };
      ii.onkeydown = (e)=>{
        if(e.key === 'Enter'){
          e.preventDefault();
          if(!okBtn.disabled) dlgOk();
        }
      };
      setTimeout(()=> ii.focus(), 0);
    } else {
      iw.style.display = 'none';
      ii.value = '';
      ii.oninput = null;
      ii.onkeydown = null;
      okBtn.disabled = false;
    }

    if(mode === 'alert' || mode === 'error'){
      cancelBtn.style.display = 'none';
      okBtn.disabled = false;
    } else {
      cancelBtn.style.display = 'inline-flex';
      if(!__dlgRequireText) okBtn.disabled = false;
    }

    b.style.display = 'flex';

    return new Promise((resolve)=>{
      __dlgResolve = resolve;
    });
  }

  async function showConfirm(title, message, opts={}){
    return await showDialog({
      mode: 'confirm',
      title,
      message,
      sub: opts.sub || '',
      okText: opts.okText || 'Xác nhận',
      cancelText: opts.cancelText || 'Huỷ',
      requireText: opts.requireText || null
    });
  }

  function showError(title, message, sub=''){
    showDialog({
      mode: 'error',
      title,
      message,
      sub,
      okText: 'Đóng'
    });
  }

  // =========================
  // Round nav (JS render for many rounds)
  // =========================
  function renderRoundNav(){
    const host = document.getElementById('roundTabs');
    if(!host) return;
    host.innerHTML = '';

    const rs = Array.isArray(ROUNDS) ? ROUNDS.slice() : [];
    const nums = rs
      .map(r => Number((r && (r.round_no ?? r.roundNo ?? (r.get && r.get('round_no')))) || 0))
      .filter(n => n > 0)
      .sort((a,b)=>a-b);

    if(nums.length === 0){
      host.innerHTML = `<span class="pill warn"><i class="ri-information-line"></i> Chưa có vòng</span>`;
      return;
    }

    const MAX_SHOW = 10;
    const showNums = nums.slice(0, MAX_SHOW);
    const moreNums = nums.slice(MAX_SHOW);

    const makeHref = (n)=> `/auction/sessions/${SESSION_ID}?round_no=${n}`;

    for(const n of showNums){
      const a = document.createElement('a');
      a.className = 'tab' + (n===ROUND_NO ? ' active' : '');
      a.href = makeHref(n);
      a.textContent = `Vòng ${n}`;
      host.appendChild(a);
    }

    if(moreNums.length){
      const sel = document.createElement('select');
      sel.className = 'roundMore';

      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = 'Chọn vòng...';
      sel.appendChild(opt0);

      for(const n of moreNums){
        const o = document.createElement('option');
        o.value = String(n);
        o.textContent = `Vòng ${n}`;
        if(n === ROUND_NO) o.selected = true;
        sel.appendChild(o);
      }

      sel.addEventListener('change', ()=>{
        const v = Number(sel.value||0);
        if(v>0) window.location.href = makeHref(v);
      });

      host.appendChild(sel);
    }
  }

  // =========================
  // Load results + render
  // =========================
  async function fetchResults(){
    const r = await fetch(`/auction/sessions/api/sessions/${SESSION_ID}/results`);
    const js = await r.json().catch(()=> ({}));
    if(!r.ok){
      RESULTS = [];
      RESULT_BY_LOT = {};
      toast("Không tải được results: " + (js.detail || ("HTTP " + r.status)));
      return;
    }
    RESULTS = (js.data || []);
    RESULT_BY_LOT = {};
    for(const row of RESULTS){
      if(row && row.lot_id != null) RESULT_BY_LOT[String(row.lot_id)] = row;
    }
  }

  function computeRoundSummary(){
    const lots = (UI && UI.lots) ? UI.lots : [];
    const totalLots = lots.length;

    const setCus = new Set();
    let wonLots = 0;
    let nextLots = 0;

    for(const l of lots){
      const rt = safeText(l.result_type || 'PENDING');
      if(rt === 'WINNER') wonLots++;
      if(rt === 'NEXT_ROUND') nextLots++;

      const ps = (l.participants || []);
      for(const p of ps){
        const snap = participantSnapshot(p);
        const cid = Number(p.customer_id || snap.customer_id || 0);
        if(cid>0) setCus.add(cid);
      }
    }

    document.getElementById('sumLots').textContent = String(totalLots);
    document.getElementById('sumCustomers').textContent = String(setCus.size);
    document.getElementById('sumWon').textContent = String(wonLots);
    document.getElementById('sumNext').textContent = String(nextLots);
  }

  function renderLots(){
    const lots = (UI && UI.lots) ? UI.lots : [];
    const q = (document.getElementById('q').value || '').trim().toLowerCase();
    const tbody = document.getElementById('lotTbody');
    tbody.innerHTML = '';

    let shown = 0;

    for(const lot of lots){
      const snap = getLotSnapshot(lot);
      const lotCode = safeText(lot.lot_code || snap.lot_code || '');
      const desc = safeText(snap.lot_description || lot.lot_name || '');
      const hay = (lotCode + ' ' + desc).toLowerCase();
      if(q && !hay.includes(q)) continue;

      const partCount = (lot.participants || []).length;
      const rt = safeText(lot.result_type || 'PENDING');
      const lotId = Number(lot.lot_id || snap.lot_id || 0);
      const res = RESULT_BY_LOT[String(lotId || '')] || null;

      const area = (snap.area_m2 ?? lot.lot_area ?? '');
      const startPrice = getStartPriceVnd(lot);
      const step = (snap.bid_step_vnd ?? '');
      const note = safeText(lot.note || '');

      let statusHtml = '';
      if(rt === 'WINNER' && res && (safeText(res.status) === 'WON')){
        const who = safeText(res.winner_name || '') || ('#' + safeText(res.winner_customer_id||''));
        const phoneMasked = maskPhone(res.winner_phone || '');
        const roundLotId = Number(lot.id || 0);

        const printBtn = roundLotId
          ? `<button class="printIcon" type="button" onclick="printWinnerOne(${roundLotId})" title="In phiếu trúng (lô này)">
               <i class="ri-printer-line"></i>
             </button>`
          : ``;

        statusHtml = `
          <div class="pill ok"><i class="ri-trophy-line"></i> WON</div>
          <div class="muted" style="margin-top:6px;">
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
              <b>${escapeHtml(who)}</b>
              ${phoneMasked ? `<span class="pill"><i class="ri-phone-line"></i> ${escapeHtml(phoneMasked)}</span>` : ``}
              ${printBtn}
            </div>
            <div>Giá: <b>${fmtMoney(res.winning_price_vnd)}</b> • Vòng: <b>#${escapeHtml(res.winning_round_no||'')}</b></div>
          </div>
        `;
      } else if(rt === 'NEXT_ROUND'){
        const nx = (lot.next_participants || []);
        statusHtml = `
          <div class="pill warn"><i class="ri-arrow-right-up-line"></i> Vào vòng sau</div>
          <div class="bigCount">
            <div class="n">${nx.length}</div>
            <div class="t">người vào<br/>vòng sau</div>
          </div>
        `;
      } else if(rt === 'NO_VALID'){
        statusHtml = `
          <div class="pill bad"><i class="ri-close-circle-line"></i> No valid</div>
          <div class="muted">Không có phiếu hợp lệ.</div>
        `;
      } else {
        statusHtml = `
          <div class="pill"><i class="ri-time-line"></i> PENDING</div>
          <div class="muted">${partCount} người tham gia vòng này.</div>
        `;
      }

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <div class="lotTitle">
            <span class="lotDot"></span>
            <div class="lotLines">
              <div class="lotCode">${escapeHtml(lotCode || '-')}</div>
              <div class="lotDesc">${escapeHtml(desc || '')}</div>
            </div>
          </div>
        </td>

        <td>
          <div class="muted" style="display:flex;flex-wrap:wrap;gap:10px;">
            <span><i class="ri-ruler-2-line"></i> Diện tích: <b>${escapeHtml(area)}</b></span>
            <span><i class="ri-coins-line"></i> Giá khởi điểm: <b>${fmtMoney(startPrice)}</b></span>
            <span><i class="ri-arrow-up-line"></i> Bước giá: <b>${fmtMoney(step)}</b></span>
            <span><i class="ri-user-3-line"></i> Tham gia: <b>${partCount}</b></span>
          </div>
          ${note ? `<div class="muted" style="margin-top:6px;"><i class="ri-sticky-note-line"></i> ${escapeHtml(note)}</div>` : ``}
        </td>

        <td>${statusHtml}</td>

        <td class="right">
          <button class="miniBtn primary" type="button" onclick="openLotModal(${Number(lot.id)})">
            <i class="ri-settings-3-line"></i> Xử lý
          </button>
        </td>
      `;
      tbody.appendChild(tr);
      shown++;
    }

    document.getElementById('emptyState').style.display = (shown===0) ? 'block' : 'none';
    computeRoundSummary();
  }

  // =========================
  // Refresh
  // =========================
  async function fetchRoundUI(roundNo){
    const r = await fetch(`/auction/sessions/api/sessions/${SESSION_ID}/rounds/${roundNo}/ui`);
    const js = await r.json().catch(()=> ({}));
    if(!r.ok){
      toast("Tải UI vòng lỗi: " + (js.detail || ("HTTP " + r.status)));
      return;
    }
    UI = js;
  }

  async function refreshAll(){
    await fetchResults();
    await fetchRoundUI(ROUND_NO);
    renderRoundNav();
    renderLots();
  }

  // =========================
  // Session actions
  // =========================
  async function startSessionIfNeeded(){
    const ok = await showConfirm(
      "Mở phiên (Start)",
      "Thực hiện START để đảm bảo Round 1 đã snapshot (lô + khách đủ điều kiện).",
      { sub: "Start là idempotent: nếu đã start trước đó, hệ thống sẽ an toàn bỏ qua/không nhân đôi dữ liệu." }
    );
    if(!ok) return;

    try{
      const r = await fetch("/auction/sessions/api/sessions/start", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({session_id: SESSION_ID})
      });
      const js = await r.json().catch(()=> ({}));
      if(!r.ok){
        showError("Start thất bại", safeText(js.detail || js.error || ("HTTP " + r.status)));
        return;
      }
      toast("Đã start. Làm mới dữ liệu...");
      await refreshAll();
    }catch(e){
      showError("Lỗi mạng", "Không thể gọi API start. Vui lòng thử lại.");
    }
  }

  async function createNextRound(){
    const ok = await showConfirm(
      "Tạo vòng sau",
      `Bạn sắp tạo vòng tiếp theo từ các lô NEXT_ROUND của vòng #${ROUND_NO}.`,
      {
        sub: "Đây là thao tác tạo vòng mới. Vui lòng kiểm tra chắc chắn đã chốt đầy đủ các lô cần thiết.",
        requireText: "tôi xác nhận",
        okText: "Tạo vòng sau",
        cancelText: "Huỷ"
      }
    );
    if(!ok) return;

    const payload = { session_id: SESSION_ID, from_round_no: ROUND_NO, note: null };

    try{
      const r = await fetch(`/auction/sessions/api/sessions/${SESSION_ID}/rounds/next`, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const js = await r.json().catch(()=> ({}));
      if(!r.ok){
        showError("Tạo vòng sau thất bại", safeText(js.detail || js.error || ("HTTP " + r.status)));
        return;
      }
      toast("Đã tạo vòng #" + (js.created_round_no || '') + " (" + (js.created_lot_count||0) + " lô)");
      if(js.created_round_no){
        window.location.href = `/auction/sessions/${SESSION_ID}?round_no=${js.created_round_no}`;
      } else {
        await refreshAll();
      }
    }catch(e){
      showError("Lỗi mạng", "Không thể gọi API tạo vòng sau. Vui lòng thử lại.");
    }
  }

  // =========================
  // Print (placeholders - không phá logic)
  // =========================
  function printAllBidTickets(){
    toast("Chưa nối endpoint in phiếu trả giá cho phiên (placeholder).");
  }
  function printRoundWinners(){
    toast("Chưa nối endpoint in phiếu trúng theo vòng (placeholder).");
  }
  function printWinnerOne(roundLotId){
    toast("Chưa nối endpoint in phiếu trúng theo lô (placeholder). round_lot_id=" + roundLotId);
  }

  // =========================
  // Modal open / close
  // =========================
  function closeModal(ev){
    if(ev && ev.target && ev.target.id !== 'backdrop') return;
    document.getElementById('backdrop').style.display = 'none';
    currentLot = null;
    currentParticipants = [];
    dualIn = [];
    dualNext = [];
    selectedWinnerId = null;
  }

  async function openLotModal(roundLotId){
    const lots = (UI && UI.lots) ? UI.lots : [];
    currentLot = lots.find(x => Number(x.id) === Number(roundLotId));
    if(!currentLot){
      toast("Không tìm thấy round_lot_id=" + roundLotId);
      return;
    }

    await tryLock(roundLotId);

    currentParticipants = (currentLot.participants || []).map(p => {
      const snap = participantSnapshot(p);
      return {
        customer_id: Number(p.customer_id || snap.customer_id || 0),
        stt: Number(p.stt || snap.stt || 0),
        name: safeText(snap.customer_full_name || ''),
        phone: safeText(snap.phone || ''),
        cccd: safeText(snap.cccd || ''),
        email: safeText(snap.email || ''),
        address: safeText(snap.address || '')
      };
    }).filter(x => x.customer_id > 0);

    document.getElementById('noteWinner').value = '';
    document.getElementById('noteNext').value = '';
    document.getElementById('noteNoValid').value = '';
    document.getElementById('winnerSearch').value = '';
    document.getElementById('winnerCustomerId').value = '';
    selectedWinnerId = null;

    document.getElementById('winningPricePretty').textContent = '—';
    document.getElementById('highestPricePretty').textContent = '—';

    const rt = safeText(currentLot.result_type || 'PENDING');
    if(rt === 'NEXT_ROUND') switchMode('NEXT');
    else if(rt === 'NO_VALID') switchMode('NO_VALID');
    else switchMode('WINNER');

    document.getElementById('winMethod').value = safeText(currentLot.win_method || 'HIGHEST');
    onWinMethodChange();

    const sp = getStartPriceVnd(currentLot);
    document.getElementById('mStartPriceText').textContent = fmtMoney(sp);
    document.getElementById('mStartPriceText2').textContent = fmtMoney(sp);

    const hp = (currentLot.highest_price_vnd != null) ? Number(currentLot.highest_price_vnd) : null;
    document.getElementById('winningPrice').value = hp ? fmtMoney(hp) : '';
    document.getElementById('highestPrice').value = hp ? fmtMoney(hp) : '';

    onMoneyInput('winningPrice');
    onMoneyInput('highestPrice');

    const curWinner = Number(currentLot.winner_customer_id || 0);
    if(curWinner){
      selectedWinnerId = curWinner;
      document.getElementById('winnerCustomerId').value = String(curWinner);
    }

    const nextIds = new Set((currentLot.next_participants||[]).map(x => Number(x.customer_id||0)).filter(Boolean));
    dualNext = [];
    dualIn = [];
    for(const p of currentParticipants){
      if(nextIds.has(p.customer_id)) dualNext.push(p);
      else dualIn.push(p);
    }

    renderModalHeader();
    renderModalLotInfo();
    renderWinnerPicker();
    renderDualLists();

    document.getElementById('backdrop').style.display = 'flex';
  }

  function renderModalHeader(){
    const snap = getLotSnapshot(currentLot);
    const lotCode = safeText(currentLot.lot_code || snap.lot_code || '');
    document.getElementById('mTitle').innerHTML = `<i class="ri-settings-3-line"></i> Xử lý ${escapeHtml(lotCode || 'Lô')}`;

    const area = (snap.area_m2 ?? currentLot.lot_area ?? '');
    const startPrice = getStartPriceVnd(currentLot);
    const step = (snap.bid_step_vnd ?? '');
    const partCount = (currentLot.participants || []).length;

    document.getElementById('mMeta').innerHTML = `
      <span class="pill"><i class="ri-stack-line"></i> Round #${escapeHtml(ROUND_NO)}</span>
      <span class="pill"><i class="ri-ruler-2-line"></i> ${escapeHtml(area)} m²</span>
      <span class="pill"><i class="ri-coins-line"></i> ${fmtMoney(startPrice)}</span>
      <span class="pill"><i class="ri-arrow-up-line"></i> Step ${fmtMoney(step)}</span>
      <span class="pill"><i class="ri-user-3-line"></i> ${partCount} người</span>
    `;

    const rt = safeText(currentLot.result_type || 'PENDING');
    const statusPill = document.getElementById('mStatusPill');
    statusPill.className = 'pill';
    if(rt === 'WINNER') statusPill.classList.add('ok');
    else if(rt === 'NEXT_ROUND') statusPill.classList.add('warn');
    else if(rt === 'NO_VALID') statusPill.classList.add('bad');
    statusPill.textContent = rt;
  }

  function renderModalLotInfo(){
    const snap = getLotSnapshot(currentLot);
    const lotCode = safeText(currentLot.lot_code || snap.lot_code || '');
    const desc = safeText(snap.lot_description || currentLot.lot_name || '');
    const area = (snap.area_m2 ?? currentLot.lot_area ?? '');
    const startPrice = getStartPriceVnd(currentLot);
    const step = (snap.bid_step_vnd ?? '');
    const lock = (currentLot.extras && currentLot.extras.lock) ? currentLot.extras.lock : null;

    const lockHtml = lock && lock.by
      ? `<div class="pill warn"><i class="ri-lock-line"></i> LOCK: ${escapeHtml(lock.by)} • TTL ${escapeHtml(lock.ttl_seconds||'')}</div>`
      : `<div class="pill"><i class="ri-lock-unlock-line"></i> Chưa lock</div>`;

    document.getElementById('mLotInfo').innerHTML = `
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <span class="pill"><i class="ri-barcode-line"></i> ${escapeHtml(lotCode||'-')}</span>
        ${lockHtml}
      </div>
      <div style="margin-top:10px;">
        <div style="font-weight:1100;color:var(--ink);">${escapeHtml(desc||'')}</div>
        <div class="muted" style="margin-top:6px;display:flex;flex-wrap:wrap;gap:10px;">
          <span><i class="ri-ruler-2-line"></i> Diện tích: <b>${escapeHtml(area)}</b></span>
          <span><i class="ri-coins-line"></i> Giá khởi điểm vòng: <b>${fmtMoney(startPrice)}</b></span>
          <span><i class="ri-arrow-up-line"></i> Bước giá: <b>${fmtMoney(step)}</b></span>
        </div>
      </div>
    `;
  }

  // =========================
  // Lock best-effort
  // =========================
  async function tryLock(roundLotId){
    const r = await fetch(`/auction/sessions/api/round-lots/${roundLotId}/lock`,{
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ttl_seconds: 900})
    });
    const js = await r.json().catch(()=> ({}));

    const lp = document.getElementById('mLockPill');
    if(lp) lp.style.display = 'none';

    if(r.ok){
      const data = js?.data || js;
      if(currentLot && data && Number(data.id) === Number(currentLot.id)){
        if(data.updated_at) currentLot.updated_at = data.updated_at;
        if(data.extras) currentLot.extras = data.extras;
      }
      return true;
    }

    const msg = safeText(js.detail || js.error || '');
    if(r.status === 409 && msg.startsWith("LOCKED_BY_")){
      if(lp){
        lp.style.display = 'inline-flex';
        lp.className = 'pill warn';
        lp.innerHTML = `<i class="ri-lock-line"></i> ${escapeHtml(msg)}`;
      }
      toast("Lô đang bị khoá: " + msg);
    } else if(r.status !== 404){
      showError("Lock thất bại", msg || ("HTTP " + r.status));
    }
    return false;
  }

  // =========================
  // Mode switch
  // =========================
  function switchMode(mode){
    document.getElementById('segWinner').classList.toggle('active', mode==='WINNER');
    document.getElementById('segNext').classList.toggle('active', mode==='NEXT');
    document.getElementById('segNoValid').classList.toggle('active', mode==='NO_VALID');

    document.getElementById('modeWinner').style.display = (mode==='WINNER') ? 'block' : 'none';
    document.getElementById('modeNext').style.display = (mode==='NEXT') ? 'block' : 'none';
    document.getElementById('modeNoValid').style.display = (mode==='NO_VALID') ? 'block' : 'none';

    window.__mode = mode;
  }

  function onWinMethodChange(){
    const m = document.getElementById('winMethod').value;
    const label = document.getElementById('winningPriceLabel');
    const help = document.getElementById('winningPriceHelp');
    const input = document.getElementById('winningPrice');

    if(m === 'LOTTERY'){
      label.innerHTML = `<i class="ri-money-dollar-circle-line"></i> Giá trúng (tự lấy giá khởi điểm vòng)`;
      help.innerHTML = 'Nếu <b>LOTTERY</b> thì hệ thống lấy <b>giá khởi điểm</b> của vòng. Không cần nhập.';
      input.value = '';
      input.disabled = true;
      onMoneyInput('winningPrice');

    } else {
      input.disabled = false;
      label.innerHTML = `<i class="ri-money-dollar-circle-line"></i> Giá trúng (VND)`;
      help.textContent = 'Nhập số, hệ thống sẽ tự format dạng tiền (1.234.567).';
    }
  }

  // =========================
  // Winner picker (ẩn số điện thoại theo yêu cầu bảo mật)
  // =========================
  function renderWinnerPicker(){
    const host = document.getElementById('winnerList');
    if(!host) return;
    host.innerHTML = '';

    const q = (document.getElementById('winnerSearch').value || '').trim().toLowerCase();
    const list = Array.isArray(currentParticipants) ? currentParticipants : [];

    for(const p of list){
      const hay = (safeText(p.name) + ' ' + safeText(p.cccd) + ' ' + safeText(p.phone)).toLowerCase();
      if(q && !hay.includes(q)) continue;

      const div = document.createElement('div');
      div.className = 'pitem' + ((Number(p.customer_id) === Number(selectedWinnerId)) ? ' selected' : '');
      div.onclick = ()=> {
        selectedWinnerId = Number(p.customer_id);
        document.getElementById('winnerCustomerId').value = String(selectedWinnerId);
        renderWinnerPicker();
      };

      const sttPrefix = fmtStt(p.stt);
      const nameLine = `${sttPrefix ? (escapeHtml(sttPrefix) + " — ") : ""}${escapeHtml(p.name || ('#'+p.customer_id))}`;
      const phoneMasked = maskPhone(p.phone);

      div.innerHTML = `
        <div>
          <b>${nameLine}</b>
          <div class="pm">
            CCCD: <span class="mono">${escapeHtml(p.cccd)}</span>
            ${phoneMasked ? ` • SĐT: <span class="mono">${escapeHtml(phoneMasked)}</span>` : ``}
          </div>
        </div>
        <div><span class="tag"><i class="ri-check-line"></i> Chọn</span></div>
      `;
      host.appendChild(div);
    }

    if(!host.children.length){
      host.innerHTML = `<div class="empty">Không có kết quả phù hợp.</div>`;
    }
  }

  // =========================
  // Dual list (NEXT ROUND) + counters (ẩn sđt)
  // =========================
  function updateDualCounters(){
    const N = (Array.isArray(currentParticipants) ? currentParticipants.length : 0);
    const M = (Array.isArray(dualNext) ? dualNext.length : 0);

    const inT = document.getElementById('dualInTitle');
    const nxT = document.getElementById('dualNextTitle');

    if(inT) inT.textContent = `Trong vòng này (${N})`;
    if(nxT) nxT.textContent = `Vào vòng sau (${M}/${N})`;
  }

  function renderDualLists(){
    updateDualCounters();

    const fi = (document.getElementById('filterIn').value||'').trim().toLowerCase();
    const fn = (document.getElementById('filterNext').value||'').trim().toLowerCase();

    const inEl = document.getElementById('listIn');
    const nxEl = document.getElementById('listNext');
    inEl.innerHTML = '';
    nxEl.innerHTML = '';

    for(const p of dualIn){
      const hay = (safeText(p.name) + ' ' + safeText(p.cccd) + ' ' + safeText(p.phone)).toLowerCase();
      if(fi && !hay.includes(fi)) continue;

      const sttPrefix = fmtStt(p.stt);
      const nameLine = `${sttPrefix ? (escapeHtml(sttPrefix) + " — ") : ""}${escapeHtml(p.name || ('#'+p.customer_id))}`;
      const phoneMasked = maskPhone(p.phone);

      const div = document.createElement('div');
      div.className = 'pitem2';
      div.innerHTML = `
        <div>
          <b>${nameLine}</b>
          <div class="pm">
            CCCD: <span class="mono">${escapeHtml(p.cccd)}</span>
            ${phoneMasked ? ` • SĐT: <span class="mono">${escapeHtml(phoneMasked)}</span>` : ``}
          </div>
        </div>
        <div class="pact">
          <button class="iconbtn primary" type="button" onclick="moveOneToNext(${p.customer_id})">
            <i class="ri-arrow-right-line"></i> Chọn
          </button>
        </div>
      `;
      inEl.appendChild(div);
    }

    for(const p of dualNext){
      const hay = (safeText(p.name) + ' ' + safeText(p.cccd) + ' ' + safeText(p.phone)).toLowerCase();
      if(fn && !hay.includes(fn)) continue;

      const sttPrefix = fmtStt(p.stt);
      const nameLine = `${sttPrefix ? (escapeHtml(sttPrefix) + " — ") : ""}${escapeHtml(p.name || ('#'+p.customer_id))}`;
      const phoneMasked = maskPhone(p.phone);

      const div = document.createElement('div');
      div.className = 'pitem2';
      div.innerHTML = `
        <div>
          <b>${nameLine}</b>
          <div class="pm">
            CCCD: <span class="mono">${escapeHtml(p.cccd)}</span>
            ${phoneMasked ? ` • SĐT: <span class="mono">${escapeHtml(phoneMasked)}</span>` : ``}
          </div>
        </div>
        <div class="pact">
          <button class="iconbtn danger" type="button" onclick="moveOneToIn(${p.customer_id})">
            <i class="ri-arrow-left-line"></i> Bỏ
          </button>
        </div>
      `;
      nxEl.appendChild(div);
    }
  }

  function moveOneToNext(customerId){
    customerId = Number(customerId);
    const idx = dualIn.findIndex(x => x.customer_id === customerId);
    if(idx >= 0){
      dualNext.push(dualIn[idx]);
      dualIn.splice(idx,1);
      renderDualLists();
    }
  }
  function moveOneToIn(customerId){
    customerId = Number(customerId);
    const idx = dualNext.findIndex(x => x.customer_id === customerId);
    if(idx >= 0){
      dualIn.push(dualNext[idx]);
      dualNext.splice(idx,1);
      renderDualLists();
    }
  }
  function moveAllToNext(){
    dualNext = dualNext.concat(dualIn);
    dualIn = [];
    renderDualLists();
  }
  function moveAllToIn(){
    dualIn = dualIn.concat(dualNext);
    dualNext = [];
    renderDualLists();
  }

  // =========================
  // Confirm text helpers
  // =========================
  function getCurrentLotCode(){
    if(!currentLot) return '';
    const snap = getLotSnapshot(currentLot);
    return safeText(currentLot.lot_code || snap.lot_code || '');
  }

  function findParticipantById(cid){
    cid = Number(cid||0);
    if(!cid) return null;
    return (currentParticipants || []).find(x => Number(x.customer_id) === cid) || null;
  }

  function buildConfirmText(mode, payload){
    const lotCode = getCurrentLotCode() || '—';
    const startPrice = getStartPriceVnd(currentLot);

    if(mode === 'WINNER'){
      const winner = findParticipantById(payload.winner_customer_id);
      const stt = winner ? fmtStt(winner.stt) : '';
      const who = winner ? `${stt ? (stt + " — ") : ""}${winner.name}` : (`#${payload.winner_customer_id}`);

      let priceText = '';
      let extraLine = '';
      if(payload.win_method === 'LOTTERY'){
        extraLine = `Ghi chú: LOTTERY — Giá trúng theo giá khởi điểm vòng (${fmtMoney(startPrice)}).`;
        priceText = fmtMoney(startPrice);
      } else {
        priceText = fmtMoney(payload.highest_price_vnd);
      }

      return [
        "BIÊN BẢN XÁC NHẬN KẾT QUẢ",
        "-------------------------",
        `Lô: ${lotCode}`,
        `Kết quả: Trúng đấu giá`,
        `Hình thức: ${payload.win_method}`,
        `Khách trúng: ${who}`,
        `Giá trúng: ${priceText} VND`,
        payload.note ? `Ghi chú: ${payload.note}` : "",
        extraLine
      ].filter(Boolean).join("\n");
    }

    if(mode === 'NEXT'){
      const N = (Array.isArray(currentParticipants) ? currentParticipants.length : 0);
      const M = (Array.isArray(dualNext) ? dualNext.length : 0);
      return [
        "BIÊN BẢN XÁC NHẬN KẾT QUẢ",
        "-------------------------",
        `Lô: ${lotCode}`,
        `Kết quả: Vào vòng sau`,
        `Trong vòng này (N): ${N}`,
        `Vào vòng sau (M/N): ${M}/${N}`,
        `Giá cao nhất vòng này: ${fmtMoney(payload.highest_price_vnd)} VND`,
        payload.note ? `Ghi chú: ${payload.note}` : ""
      ].filter(Boolean).join("\n");
    }

    if(mode === 'NO_VALID'){
      return [
        "BIÊN BẢN XÁC NHẬN KẾT QUẢ",
        "-------------------------",
        `Lô: ${lotCode}`,
        `Kết quả: No valid`,
        payload.note ? `Ghi chú: ${payload.note}` : ""
      ].filter(Boolean).join("\n");
    }

    return "Xác nhận thực hiện?";
  }

  // =========================
  // Submit decide
  // =========================
  async function resetPending(){
    if(!currentLot) return;

    const ok = await showConfirm(
      "Reset PENDING",
      "Reset lô về PENDING? (Cho phép chốt lại)",
      { requireText: "reset", okText: "Reset", cancelText: "Huỷ" }
    );
    if(!ok) return;

    const payload = {
      result_type: "PENDING",
      win_method: "HIGHEST",
      highest_price_vnd: null,
      winner_customer_id: null,
      next_participants: [],
      note: "RESET_TO_PENDING"
    };

    const roundLotId = Number(currentLot.id);

    try{
      const r = await fetch(`/auction/sessions/api/round-lots/${roundLotId}/decide`, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const js = await r.json().catch(()=> ({}));

      if(!r.ok){
        const msg = safeText(js.detail || js.error || ("HTTP " + r.status));
        if(r.status === 409 && msg.startsWith("LOCKED_BY_")){
          showError("Không thể reset", "Lô đang bị khoá bởi người khác.", msg);
        } else {
          showError("Reset thất bại", msg);
        }
        return;
      }

      toast("Đã reset về PENDING.");
      await refreshAll();
      await openLotModal(roundLotId);
    }catch(e){
      showError("Lỗi mạng", "Không thể gọi API reset. Vui lòng thử lại.");
    }
  }

  async function submitDecide(){
    if(!currentLot) return;

    const mode = window.__mode || 'WINNER';
    const roundLotId = Number(currentLot.id);

    // best-effort lock (không hard fail)
    await tryLock(roundLotId);

    let payload = null;

    if(mode === 'WINNER'){
      const winMethod = safeText(document.getElementById('winMethod').value || 'HIGHEST');
      const winnerId = Number(document.getElementById('winnerCustomerId').value || 0);
      const note = (document.getElementById('noteWinner').value || '').trim() || null;

      if(!winnerId){
        showError("Thiếu thông tin", "Bạn chưa chọn người thắng.");
        return;
      }

      // Guard: Round 1 không cho LOTTERY (backend có trigger/guard)
      if(winMethod === 'LOTTERY' && Number(ROUND_NO) === 1){
        showError("Không hợp lệ", "Vòng #1 không được chốt LOTTERY (bốc thăm). Vui lòng chọn HIGHEST hoặc MANUAL.");
        return;
      }

      let price = null;
      if(winMethod !== 'LOTTERY'){
        price = parseMoneyInput('winningPrice');
        if(price === null || price <= 0){
          showError("Thiếu thông tin", "Bạn chưa nhập giá trúng hợp lệ.");
          return;
        }
      }

      payload = {
        result_type: "WINNER",
        win_method: winMethod,
        highest_price_vnd: (winMethod === 'LOTTERY') ? null : price,
        winner_customer_id: winnerId,
        next_participants: [],
        note: note
      };

      const confirmText = buildConfirmText('WINNER', payload);
      const ok = await showConfirm(
        "Xác nhận chốt WON",
        confirmText,
        {
          sub: "Vui lòng kiểm tra kỹ. Sau khi chốt sẽ ghi nhận kết quả trúng.",
          okText: "Chốt WON",
          cancelText: "Huỷ",
          requireText: "chot won"
        }
      );
      if(!ok) return;

    } else if(mode === 'NEXT'){
      const note = (document.getElementById('noteNext').value || '').trim() || null;
      const hp = parseMoneyInput('highestPrice');
      if(hp === null || hp <= 0){
        showError("Thiếu thông tin", "Bạn chưa nhập giá cao nhất vòng này hợp lệ.");
        return;
      }

      const ids = (Array.isArray(dualNext) ? dualNext : [])
        .map(x => Number(x.customer_id || 0))
        .filter(x => x > 0);

      if(ids.length === 0){
        showError("Thiếu thông tin", "Bạn chưa chọn ai vào vòng sau.");
        return;
      }

      payload = {
        result_type: "NEXT_ROUND",
        win_method: "HIGHEST",
        highest_price_vnd: hp,
        winner_customer_id: null,
        next_customer_ids: ids,
        note: note
      };

      const confirmText = buildConfirmText('NEXT', payload);
      const ok = await showConfirm(
        "Xác nhận chốt vào vòng sau",
        confirmText,
        {
          sub: "Vui lòng kiểm tra danh sách M/N. Danh sách này sẽ được dùng để tạo vòng sau.",
          okText: "Chốt vào vòng sau",
          cancelText: "Huỷ",
          requireText: "chot vong sau"
        }
      );
      if(!ok) return;

    } else if(mode === 'NO_VALID'){
      const note = (document.getElementById('noteNoValid').value || '').trim() || null;

      payload = {
        result_type: "NO_VALID",
        win_method: "HIGHEST",
        highest_price_vnd: null,
        winner_customer_id: null,
        note: note
      };

      const confirmText = buildConfirmText('NO_VALID', payload);
      const ok = await showConfirm(
        "Xác nhận No valid",
        confirmText,
        {
          sub: "Vui lòng chắc chắn lô không có phiếu hợp lệ.",
          okText: "Chốt No valid",
          cancelText: "Huỷ",
          requireText: "chot no valid"
        }
      );
      if(!ok) return;

    } else {
      showError("Lỗi", "Mode không hợp lệ: " + safeText(mode));
      return;
    }

    toast("Đang chốt kết quả...");

    try{
      const r = await fetch(`/auction/sessions/api/round-lots/${roundLotId}/decide`, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const js = await r.json().catch(()=> ({}));

      if(!r.ok){
        const msg = safeText(js.detail || js.error || ("HTTP " + r.status));
        if(r.status === 409 && msg.startsWith("LOCKED_BY_")){
          showError("Không thể chốt", "Lô đang bị khoá bởi người khác.", msg);
        } else {
          showError("Chốt thất bại", msg);
        }
        return;
      }

      toast("Đã chốt kết quả thành công.");
      closeModal();
      await refreshAll();

    }catch(e){
      showError("Lỗi mạng", "Không thể gọi API chốt kết quả. Vui lòng thử lại.");
    }
  }

  // =========================
  // Boot
  // =========================
  (function boot(){
    renderRoundNav();
    refreshAll();
  })();
</script>
{% endblock %}
