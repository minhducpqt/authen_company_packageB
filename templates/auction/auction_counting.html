{% extends "base.html" %}
{% block title %}Kiểm phiếu trúng đấu giá{% endblock %}

{% block content %}
{% set projects = projects or [] %}
{% set project_id = project_id %}
{% set session = session %}
{% set rows = (data or {}).get('data') or [] %}
{% set total = (data or {}).get('total') or (rows|length) %}
{% set qv = q or "" %}

<div class="mb-6">
  <div class="flex items-start justify-between gap-3 flex-wrap">
    <div>
      <h1 class="text-2xl font-semibold text-slate-900 flex items-center gap-2">
        <i class="ri-auction-line text-emerald-600 text-3xl"></i>
        Kiểm phiếu trúng đấu giá (2 vòng)
      </h1>
      <p class="text-slate-500 text-sm mt-1">
        Vòng 1: xác định <b>TIED</b> (>=2 khách cùng giá cao nhất). Vòng 2: bốc thăm chọn <b>WON</b> từ danh sách TIED (bắt buộc xác nhận <code>is_lucky_draw</code>).
      </p>
    </div>

    <div class="flex items-center gap-2">
      <a
        id="btnDisplay"
        class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-slate-700 text-sm font-medium inline-flex items-center gap-2"
        href="{% if project %}/auction/counting/display?project={{ project|urlencode }}{% else %}#{% endif %}"
        target="_blank"
      >
        <i class="ri-slideshow-3-line"></i>
        Trình chiếu
      </a>

      <button
        id="btnRefresh"
        class="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-medium inline-flex items-center gap-2"
        type="button"
        {% if not project_id %}disabled aria-disabled="true" class="opacity-50"{% endif %}
      >
        <i class="ri-refresh-line"></i>
        Tải lại
      </button>
    </div>
  </div>
</div>

{# ====== Errors ====== #}
{% if session_err %}
  <div class="p-3 rounded-xl bg-red-50 border border-red-100 text-red-700 text-sm mb-4">
    Không tạo/khởi động được phiên kiểm phiếu. {{ session_err.body.detail if session_err.body else session_err }}
  </div>
{% endif %}

{% if error %}
  <div class="p-3 rounded-xl bg-red-50 border border-red-100 text-red-700 text-sm mb-4">
    Lỗi tải danh sách lô. {{ error.body.detail if error.body else error }}
  </div>
{% endif %}

{# ====== Project chooser + filters ====== #}
<div class="bg-white border border-slate-200 rounded-2xl shadow-sm mb-4">
  <div class="p-4 md:p-5 flex flex-col gap-3">
    <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
      <div class="md:col-span-5">
        <label class="block text-sm font-medium text-slate-700 mb-1">Chọn dự án</label>
        <div class="relative">
          <select
            id="projectSelect"
            class="w-full rounded-xl border-slate-200 focus:border-emerald-500 focus:ring-emerald-500 text-sm"
          >
            <option value="">— Chọn dự án —</option>
            {% for p in projects %}
              {% set code = (p.project_code or p.code or "") %}
              {% set pid = (p.id or p.project_id or "") %}
              {% set key = (code if code else pid) %}
              {% set st = (p.status or "") %}
              <option
                value="{{ key }}"
                {% if project and (project|string) == (key|string) %}selected{% endif %}
              >
                {{ code or ("#" ~ pid) }} — {{ p.name or "(no name)" }}
                {% if st %} ({{ st }}){% endif %}
              </option>
            {% endfor %}
          </select>

          <div class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none">
            <i class="ri-arrow-down-s-line"></i>
          </div>
        </div>
        <div class="text-xs text-slate-500 mt-1">
          Dropdown gồm <b>cả ACTIVE và INACTIVE</b>. Nếu chỉ có 1 ACTIVE, hệ thống tự chọn.
        </div>
      </div>

      <div class="md:col-span-4">
        <label class="block text-sm font-medium text-slate-700 mb-1">Tìm lô</label>
        <input
          id="qInput"
          class="w-full rounded-xl border-slate-200 focus:border-emerald-500 focus:ring-emerald-500 text-sm"
          placeholder="Nhập mã lô hoặc tên lô..."
          value="{{ qv }}"
        />
      </div>

      <div class="md:col-span-3 flex gap-2">
        <button
          id="btnApplyFilter"
          class="flex-1 px-3 py-2 rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-sm font-medium"
          type="button"
        >
          Lọc
        </button>
        <button
          id="btnClearFilter"
          class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-slate-700 text-sm font-medium"
          type="button"
        >
          Reset
        </button>
      </div>
    </div>

    <div class="flex flex-wrap items-center gap-2 text-sm">
      <span class="inline-flex items-center gap-2 px-3 py-1 rounded-xl bg-slate-50 border border-slate-200 text-slate-700">
        <i class="ri-flag-line text-slate-500"></i>
        Phiên:
        <span class="font-semibold" id="sessionBadge">
          {% if session and session.id %}#{{ session.id }} ({{ session.status }}){% else %}—{% endif %}
        </span>
      </span>

      <span class="inline-flex items-center gap-2 px-3 py-1 rounded-xl bg-slate-50 border border-slate-200 text-slate-700">
        <i class="ri-stack-line text-slate-500"></i>
        Tổng lô: <b id="totalLots">{{ total }}</b>
      </span>

      <span class="inline-flex items-center gap-2 px-3 py-1 rounded-xl bg-emerald-50 border border-emerald-100 text-emerald-700">
        <i class="ri-trophy-line"></i>
        WON: <b id="countWon">0</b>
      </span>

      <span class="inline-flex items-center gap-2 px-3 py-1 rounded-xl bg-amber-50 border border-amber-100 text-amber-700">
        <i class="ri-group-line"></i>
        TIED: <b id="countTied">0</b>
      </span>

      <span class="inline-flex items-center gap-2 px-3 py-1 rounded-xl bg-slate-50 border border-slate-200 text-slate-700">
        <i class="ri-checkbox-circle-line text-slate-500"></i>
        Đã xử lý: <b id="countChecked">0</b>
      </span>
    </div>
  </div>
</div>

{# ====== Lots table ====== #}
<div class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden">
  <div class="px-4 md:px-5 py-3 border-b border-slate-100 flex items-center justify-between gap-2">
    <div class="text-sm font-semibold text-slate-800">Danh sách lô</div>
    <div class="text-xs text-slate-500">
      Bấm <b>Xử lý</b> để nhập kết quả vòng 1 / vòng 2.
    </div>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full text-sm">
      <thead class="bg-slate-50 text-slate-600">
        <tr>
          <th class="text-left px-4 py-3 font-semibold w-[140px]">Mã lô</th>
          <th class="text-left px-4 py-3 font-semibold min-w-[260px]">Tên lô</th>
          <th class="text-left px-4 py-3 font-semibold min-w-[260px]">Giá / Bước giá</th>
          <th class="text-left px-4 py-3 font-semibold w-[140px]">Trạng thái</th>
          <th class="text-left px-4 py-3 font-semibold min-w-[260px]">Ghi chú</th>
          <th class="text-right px-4 py-3 font-semibold w-[120px]">Thao tác</th>
        </tr>
      </thead>
      <tbody id="lotTbody">
        {% for r in rows %}
          {% set st = (r.counting_status or "") %}
          <tr
            class="border-t border-slate-100"
            data-lot='{{ r|tojson }}'
          >
            <td class="px-4 py-3 align-top">
              <div class="font-semibold text-slate-900">{{ r.lot_code }}</div>
              <div class="text-xs text-slate-500">
                ID: {{ r.lot_id }}
              </div>
            </td>
            <td class="px-4 py-3 align-top">
              <div class="text-slate-900 font-medium">{{ r.lot_name or "" }}</div>
            </td>
            <td class="px-4 py-3 align-top">
              <div class="text-slate-900">
                <span class="font-medium">Giá khởi điểm (cả lô):</span>
                <span class="tabular-nums">{{ r.starting_price_vnd or "" }}</span>
              </div>

              {% if r.area %}
                <div class="text-slate-700">
                  <span class="font-medium">Diện tích:</span>
                  <span class="tabular-nums">{{ r.area }}</span> m²
                </div>
                <div class="text-slate-700">
                  <span class="font-medium">Giá khởi điểm (m²):</span>
                  <span class="tabular-nums">
                    {# compute safely server-side only if numeric; else JS will compute #}
                    —
                  </span>
                </div>
              {% endif %}

              {% if r.bid_step_vnd %}
                <div class="text-slate-700">
                  <span class="font-medium">Bước giá:</span>
                  <span class="tabular-nums">{{ r.bid_step_vnd }}</span>
                </div>
              {% endif %}

              {% if r.highest_price_vnd %}
                <div class="text-slate-700 mt-1">
                  <span class="font-medium">Giá cao nhất:</span>
                  <span class="tabular-nums">{{ r.highest_price_vnd }}</span>
                </div>
              {% endif %}
            </td>
            <td class="px-4 py-3 align-top">
              {% if st == "WON" %}
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-emerald-50 border border-emerald-100 text-emerald-700 text-xs font-semibold">
                  <i class="ri-trophy-line"></i> WON
                </span>
              {% elif st == "TIED" %}
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-amber-50 border border-amber-100 text-amber-700 text-xs font-semibold">
                  <i class="ri-group-line"></i> TIED
                </span>
              {% elif st == "PENDING" %}
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-slate-50 border border-slate-200 text-slate-700 text-xs font-semibold">
                  <i class="ri-time-line"></i> PENDING
                </span>
              {% else %}
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-slate-50 border border-slate-200 text-slate-500 text-xs font-semibold">
                  —
                </span>
              {% endif %}
            </td>
            <td class="px-4 py-3 align-top">
              <div class="text-slate-700 text-xs whitespace-pre-line">
                {% if r.edit_reason %}<div><b>Lý do:</b> {{ r.edit_reason }}</div>{% endif %}
                {% if r.set_by %}<div><b>Người nhập:</b> {{ r.set_by }}</div>{% endif %}
                {% if r.set_at %}<div><b>Thời điểm:</b> {{ r.set_at }}</div>{% endif %}
              </div>
            </td>
            <td class="px-4 py-3 align-top text-right">
              <button
                class="btnHandle inline-flex items-center gap-1 px-3 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-semibold"
                type="button"
                {% if not project_id %}disabled aria-disabled="true" class="opacity-50"{% endif %}
              >
                <i class="ri-edit-2-line"></i> Xử lý
              </button>
            </td>
          </tr>
        {% endfor %}

        {% if rows|length == 0 %}
          <tr>
            <td class="px-4 py-6 text-slate-500 text-sm" colspan="6">
              {% if not project_id %}
                Hãy chọn dự án để bắt đầu kiểm phiếu.
              {% else %}
                Không có lô nào (hoặc không khớp bộ lọc).
              {% endif %}
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <div class="px-4 md:px-5 py-3 border-t border-slate-100 flex items-center justify-between text-sm">
    <div class="text-slate-500">
      Trang {{ page }} • Hiển thị {{ rows|length }} / {{ total }}
    </div>
    <div class="flex items-center gap-2">
      <a
        class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-slate-700 text-sm font-medium"
        href="?project={{ project|urlencode }}&q={{ qv|urlencode }}&page={{ 1 }}&size={{ size }}"
      >Đầu</a>
      <a
        class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-slate-700 text-sm font-medium {% if page <= 1 %}opacity-50 pointer-events-none{% endif %}"
        href="?project={{ project|urlencode }}&q={{ qv|urlencode }}&page={{ (page-1) }}&size={{ size }}"
      >Trước</a>
      <a
        class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-slate-700 text-sm font-medium {% if (page*size) >= total %}opacity-50 pointer-events-none{% endif %}"
        href="?project={{ project|urlencode }}&q={{ qv|urlencode }}&page={{ (page+1) }}&size={{ size }}"
      >Sau</a>
    </div>
  </div>
</div>

{# =========================
   Custom Modal: Editor
   ========================= #}
<div id="modalMask" class="fixed inset-0 bg-black/40 hidden z-[60]"></div>

<div id="editorModal" class="fixed inset-0 hidden z-[61]">
  <div class="min-h-full flex items-end md:items-center justify-center p-3 md:p-6">
    <div class="w-full max-w-5xl bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
      <div class="px-5 py-4 border-b border-slate-100 flex items-center justify-between">
        <div class="min-w-0">
          <div class="text-sm text-slate-500">Xử lý kết quả</div>
          <div class="text-lg font-semibold text-slate-900 truncate" id="modalTitle">—</div>
          <div class="text-xs text-slate-500 mt-1" id="modalSub">—</div>
        </div>
        <button id="btnCloseModal" class="p-2 rounded-xl hover:bg-slate-50 text-slate-500" type="button">
          <i class="ri-close-line text-xl"></i>
        </button>
      </div>

      <div class="p-5 grid grid-cols-1 lg:grid-cols-12 gap-4">
        <div class="lg:col-span-5 space-y-3">
          <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
            <div class="text-sm font-semibold text-slate-900 mb-2">Thông tin lô</div>
            <div class="text-sm text-slate-700 space-y-1">
              <div><b>Mã lô:</b> <span id="mLotCode"></span></div>
              <div><b>Tên lô:</b> <span id="mLotName"></span></div>
              <div><b>Diện tích:</b> <span id="mArea">—</span></div>
              <div><b>Giá khởi điểm (cả lô):</b> <span id="mStartLot">—</span></div>
              <div><b>Giá khởi điểm (m²):</b> <span id="mStartM2">—</span></div>
              <div><b>Bước giá:</b> <span id="mBidStep">—</span></div>
              <div><b>Loại hình đấu:</b> <span id="mAuctionMode" class="font-semibold">—</span></div>
            </div>
          </div>

          <div class="p-4 rounded-2xl border border-slate-200">
            <div class="text-sm font-semibold text-slate-900 mb-2">Trạng thái nhập</div>

            <label class="block text-sm font-medium text-slate-700 mb-1">Trạng thái</label>
            <select id="mStatus" class="w-full rounded-xl border-slate-200 focus:border-indigo-500 focus:ring-indigo-500 text-sm">
              <option value="PENDING">PENDING (chưa xử lý)</option>
              <option value="TIED">TIED (vòng 1: hòa)</option>
              <option value="WON">WON (kết quả: trúng)</option>
            </select>

            <div class="mt-3">
              <label class="block text-sm font-medium text-slate-700 mb-1">Giá cao nhất</label>
              <input id="mHighest" inputmode="numeric" class="w-full rounded-xl border-slate-200 focus:border-indigo-500 focus:ring-indigo-500 text-sm"
                     placeholder="Nhập giá cao nhất (VND)..." />
              <div class="text-xs text-slate-500 mt-1">
                Gợi ý: nếu dự án <b>PER_SQM</b> thì giá nhập thường là giá theo m²; nếu <b>PER_LOT</b> thì là giá theo cả lô.
              </div>
            </div>

            <div class="mt-3">
              <label class="block text-sm font-medium text-slate-700 mb-1">Lý do chỉnh sửa (tuỳ chọn)</label>
              <input id="mReason" class="w-full rounded-xl border-slate-200 focus:border-indigo-500 focus:ring-indigo-500 text-sm"
                     placeholder="Ví dụ: sửa sai người hòa / cập nhật lại giá..." />
            </div>

            <div id="wonConfirmBox" class="mt-3 hidden">
              <div class="p-3 rounded-xl bg-emerald-50 border border-emerald-100">
                <div class="text-sm font-semibold text-emerald-800">Xác nhận is_lucky_draw</div>
                <div class="text-xs text-emerald-700 mt-1">
                  Khi lưu <b>WON</b>, bắt buộc người nhập xác nhận đây có phải kết quả bốc thăm hay không.
                </div>

                <div class="mt-2 flex gap-3 text-sm">
                  <label class="inline-flex items-center gap-2">
                    <input type="radio" name="isLuckyDraw" value="true" class="rounded border-slate-300" />
                    <span>Có bốc thăm</span>
                  </label>
                  <label class="inline-flex items-center gap-2">
                    <input type="radio" name="isLuckyDraw" value="false" class="rounded border-slate-300" />
                    <span>Không bốc thăm</span>
                  </label>
                </div>
              </div>
            </div>

          </div>
        </div>

        <div class="lg:col-span-7 space-y-3">
          <div class="p-4 rounded-2xl border border-slate-200">
            <div class="flex items-center justify-between gap-2">
              <div class="text-sm font-semibold text-slate-900">Danh sách khách đủ điều kiện</div>
              <div class="text-xs text-slate-500" id="eligibleNote">—</div>
            </div>

            <div class="mt-2 flex flex-col md:flex-row gap-2">
              <input id="eligibleSearch" class="flex-1 rounded-xl border-slate-200 focus:border-indigo-500 focus:ring-indigo-500 text-sm"
                     placeholder="Tìm theo tên/CCCD/phone..." />
              <button id="btnReloadEligible" type="button"
                      class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-slate-700 text-sm font-medium inline-flex items-center gap-2">
                <i class="ri-refresh-line"></i> Tải DS
              </button>
            </div>

            <div class="mt-3 grid grid-cols-1 gap-2 max-h-[360px] overflow-auto pr-1" id="eligibleList">
              <div class="text-sm text-slate-500">Chọn trạng thái để tải danh sách.</div>
            </div>

            <div class="mt-3 text-xs text-slate-500">
              - Nếu <b>TIED</b>: tick <b>=&gt; chọn >= 2</b> khách hòa. <br/>
              - Nếu <b>WON</b>: chọn <b>1</b> khách trúng.
            </div>
          </div>

          <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
            <div class="text-sm font-semibold text-slate-900 mb-2">Tóm tắt lựa chọn</div>
            <div class="text-sm text-slate-700" id="selectionSummary">—</div>
          </div>

        </div>
      </div>

      <div class="px-5 py-4 border-t border-slate-100 flex flex-col md:flex-row items-stretch md:items-center justify-between gap-2">
        <div class="text-xs text-slate-500" id="saveHint">
          Khi lưu WON/TIED, hệ thống sẽ cập nhật lên Service A và đồng bộ hiển thị.
        </div>
        <div class="flex items-center gap-2 justify-end">
          <button id="btnSave" type="button"
                  class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold inline-flex items-center gap-2">
            <i class="ri-save-3-line"></i> Lưu
          </button>
          <button id="btnCancel" type="button"
                  class="px-4 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-slate-700 text-sm font-semibold">
            Đóng
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

{# =========================
   Custom Confirm Modal
   ========================= #}
<div id="confirmModal" class="fixed inset-0 hidden z-[70]">
  <div class="min-h-full flex items-end md:items-center justify-center p-3 md:p-6">
    <div class="w-full max-w-lg bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
      <div class="px-5 py-4 border-b border-slate-100 flex items-center justify-between">
        <div class="text-lg font-semibold text-slate-900">Xác nhận lưu</div>
        <button id="btnConfirmClose" class="p-2 rounded-xl hover:bg-slate-50 text-slate-500" type="button">
          <i class="ri-close-line text-xl"></i>
        </button>
      </div>
      <div class="p-5">
        <div class="text-sm text-slate-700 whitespace-pre-line" id="confirmText">—</div>
      </div>
      <div class="px-5 py-4 border-t border-slate-100 flex items-center justify-end gap-2">
        <button id="btnConfirmNo" type="button" class="px-4 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-slate-700 text-sm font-semibold">
          Huỷ
        </button>
        <button id="btnConfirmYes" type="button" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-semibold">
          Đồng ý lưu
        </button>
      </div>
    </div>
  </div>
</div>

{# =========================
   Toast / Error modal
   ========================= #}
<div id="toast" class="fixed bottom-4 right-4 z-[80] hidden">
  <div class="max-w-md bg-slate-900 text-white px-4 py-3 rounded-2xl shadow-lg text-sm flex items-start gap-2">
    <i class="ri-information-line text-lg mt-0.5"></i>
    <div class="min-w-0">
      <div class="font-semibold" id="toastTitle">Thông báo</div>
      <div class="opacity-90 mt-0.5 whitespace-pre-line" id="toastMsg">—</div>
    </div>
    <button id="toastClose" class="ml-2 opacity-80 hover:opacity-100">
      <i class="ri-close-line"></i>
    </button>
  </div>
</div>

<script>
(function(){
  const PROJECT_ID = {{ project_id or 'null' }};
  const PROJECT_KEY = "{{ (project or '')|e }}";
  const SESSION_ID = {{ (session.id if session and session.id else 'null') }};
  const PROJECT_OBJ = {{ (project_obj or {})|tojson }};
  const AUCTION_MODE = (PROJECT_OBJ && PROJECT_OBJ.auction_mode) ? String(PROJECT_OBJ.auction_mode).toUpperCase() : "";

  const el = (id)=>document.getElementById(id);
  const qs = (s,root=document)=>root.querySelector(s);
  const qsa = (s,root=document)=>Array.from(root.querySelectorAll(s));

  function toast(title,msg){
    el("toastTitle").textContent = title || "Thông báo";
    el("toastMsg").textContent = msg || "";
    el("toast").classList.remove("hidden");
  }
  el("toastClose").addEventListener("click", ()=> el("toast").classList.add("hidden"));

  function openModal(){
    el("modalMask").classList.remove("hidden");
    el("editorModal").classList.remove("hidden");
    document.body.classList.add("overflow-hidden");
  }
  function closeModal(){
    el("modalMask").classList.add("hidden");
    el("editorModal").classList.add("hidden");
    document.body.classList.remove("overflow-hidden");
  }

  el("btnCloseModal").addEventListener("click", closeModal);
  el("btnCancel").addEventListener("click", closeModal);
  el("modalMask").addEventListener("click", ()=>{
    // do nothing (avoid misclick close), user must press Close
  });

  // project select navigation
  el("projectSelect").addEventListener("change", ()=>{
    const v = el("projectSelect").value || "";
    const url = new URL(window.location.href);
    if(v) url.searchParams.set("project", v);
    else url.searchParams.delete("project");
    url.searchParams.set("page","1");
    window.location.href = url.toString();
  });

  el("btnApplyFilter").addEventListener("click", ()=>{
    const url = new URL(window.location.href);
    const q = (el("qInput").value || "").trim();
    if(q) url.searchParams.set("q", q);
    else url.searchParams.delete("q");
    url.searchParams.set("page","1");
    window.location.href = url.toString();
  });

  el("btnClearFilter").addEventListener("click", ()=>{
    const url = new URL(window.location.href);
    url.searchParams.delete("q");
    url.searchParams.set("page","1");
    window.location.href = url.toString();
  });

  el("btnRefresh").addEventListener("click", ()=>{
    window.location.reload();
  });

  // disable display button if no project
  const displayBtn = el("btnDisplay");
  if(!PROJECT_ID){
    displayBtn.classList.add("opacity-50","pointer-events-none");
    displayBtn.setAttribute("aria-disabled","true");
    displayBtn.href = "#";
  }

  // count summary from table
  function refreshCounters(){
    const trs = qsa("#lotTbody tr[data-lot]");
    let won=0, tied=0;
    trs.forEach(tr=>{
      try{
        const d = JSON.parse(tr.getAttribute("data-lot") || "{}");
        const st = String(d.counting_status || "").toUpperCase();
        if(st==="WON") won++;
        if(st==="TIED") tied++;
      }catch(e){}
    });
    el("countWon").textContent = String(won);
    el("countTied").textContent = String(tied);
    el("countChecked").textContent = String(won + tied);
  }
  refreshCounters();

  // ---------------------------
  // Editor state
  // ---------------------------
  let currentLot = null;
  let eligible = []; // list from API
  let selectedWinner = null;
  let selectedTied = new Set();

  function fmtNum(n){
    if(n===null || n===undefined || n==="") return "";
    const x = Number(String(n).replaceAll(",","").trim());
    if(!isFinite(x)) return String(n);
    return x.toLocaleString("en-US");
  }
  function parseNum(s){
    if(s===null || s===undefined) return null;
    const t = String(s).replaceAll(",","").replaceAll(" ","").trim();
    if(!t) return null;
    const x = Number(t);
    return isFinite(x) ? x : null;
  }

  function computeStartM2(startLot, area){
    const a = Number(area);
    const s = Number(startLot);
    if(!isFinite(a) || a<=0 || !isFinite(s)) return null;
    return Math.round(s / a);
  }

  function setLuckyDrawRadios(v){
    const rs = qsa('input[name="isLuckyDraw"]');
    rs.forEach(r=> r.checked = (String(v)===String(r.value)));
  }
  function getLuckyDrawValue(){
    const r = qs('input[name="isLuckyDraw"]:checked');
    return r ? r.value : null;
  }

  function updateAuctionInfo(){
    const lot = currentLot || {};
    const area = lot.area ?? lot.area_m2 ?? null;
    const startLot = lot.starting_price_vnd ?? null;
    const bidStep = lot.bid_step_vnd ?? null;

    el("mLotCode").textContent = lot.lot_code || "";
    el("mLotName").textContent = lot.lot_name || "";
    el("mArea").textContent = area ? (fmtNum(area) + " m²") : "—";
    el("mStartLot").textContent = startLot!=null ? (fmtNum(startLot) + " VND") : "—";

    const sm2 = (startLot!=null && area!=null) ? computeStartM2(startLot, area) : null;
    el("mStartM2").textContent = sm2!=null ? (fmtNum(sm2) + " VND/m²") : "—";

    el("mBidStep").textContent = bidStep!=null ? (fmtNum(bidStep) + " VND") : "—";

    const mode = AUCTION_MODE || (lot.auction_mode ? String(lot.auction_mode).toUpperCase() : "");
    el("mAuctionMode").textContent = mode ? mode : "—";

    const modeLabel = mode === "PER_SQM" ? "Đấu theo m²" : (mode === "PER_LOT" ? "Đấu theo cả lô" : "—");
    el("modalSub").textContent = modeLabel;
  }

  function updateStatusUI(){
    const st = String(el("mStatus").value || "").toUpperCase();
    // show lucky draw box only when WON
    if(st === "WON"){
      el("wonConfirmBox").classList.remove("hidden");
    }else{
      el("wonConfirmBox").classList.add("hidden");
      setLuckyDrawRadios(""); // clear
    }

    // reset selections shown
    renderEligibleList();
    updateSelectionSummary();
  }

  el("mStatus").addEventListener("change", updateStatusUI);
  el("eligibleSearch").addEventListener("input", renderEligibleList);

  async function apiEligibleCustomers(){
    if(!PROJECT_ID || !currentLot) return [];
    const lotCode = encodeURIComponent(String(currentLot.lot_code || "").trim());
    if(!lotCode) return [];
    const url = `/auction/counting/api/projects/${PROJECT_ID}/lots/${lotCode}/eligible-customers?limit=5000&include_unpaid=false`;
    try{
      const r = await fetch(url, {headers: {"Accept":"application/json"}});
      const js = await r.json();
      if(!r.ok || !js || js.ok!==true){
        throw new Error((js && (js.detail || js.error)) || ("HTTP " + r.status));
      }
      return js.data || [];
    }catch(e){
      toast("Lỗi", "Không tải được DS khách đủ điều kiện.\n" + (e.message || e));
      return [];
    }
  }

  function normText(s){
    return String(s||"").toLowerCase();
  }

  function renderEligibleList(){
    const root = el("eligibleList");
    const st = String(el("mStatus").value || "").toUpperCase();
    const q = normText(el("eligibleSearch").value || "").trim();

    const list = (eligible || []).filter(it=>{
      if(!q) return true;
      return (
        normText(it.full_name).includes(q) ||
        normText(it.cccd).includes(q) ||
        normText(it.phone).includes(q)
      );
    });

    root.innerHTML = "";

    if(!PROJECT_ID){
      root.innerHTML = `<div class="text-sm text-slate-500">Hãy chọn dự án.</div>`;
      return;
    }
    if(!currentLot){
      root.innerHTML = `<div class="text-sm text-slate-500">Chưa chọn lô.</div>`;
      return;
    }
    if(list.length===0){
      root.innerHTML = `<div class="text-sm text-slate-500">Không có dữ liệu phù hợp.</div>`;
      return;
    }

    const isWon = (st==="WON");
    const isTied = (st==="TIED");

    list.forEach(it=>{
      const cid = it.customer_id;
      const name = it.full_name || "";
      const cccd = it.cccd || "";
      const phone = it.phone || "";
      const right = `<span class="text-xs text-slate-500">#${cid}</span>`;

      const pickType = isWon ? "radio" : "checkbox";
      const checked = isWon ? (String(selectedWinner)===String(cid)) : (selectedTied.has(String(cid)));

      const row = document.createElement("label");
      row.className = "flex items-start gap-3 p-3 rounded-2xl border border-slate-200 hover:bg-slate-50 cursor-pointer";
      row.innerHTML = `
        <input class="mt-1" type="${pickType}" name="pickCustomer" value="${cid}" ${checked?"checked":""} />
        <div class="min-w-0 flex-1">
          <div class="flex items-start justify-between gap-2">
            <div class="font-semibold text-slate-900 truncate">${name}</div>
            ${right}
          </div>
          <div class="text-xs text-slate-600 mt-1">
            CCCD: <span class="font-medium">${cccd}</span>
            &nbsp;•&nbsp; Phone: <span class="font-medium">${phone}</span>
          </div>
        </div>
      `;

      const input = row.querySelector("input");
      input.addEventListener("change", ()=>{
        if(isWon){
          selectedWinner = String(cid);
          selectedTied.clear();
          // force re-render (uncheck others)
          renderEligibleList();
        }else if(isTied){
          selectedWinner = null;
          if(input.checked) selectedTied.add(String(cid));
          else selectedTied.delete(String(cid));
        }else{
          selectedWinner = null;
          selectedTied.clear();
        }
        updateSelectionSummary();
      });

      root.appendChild(row);
    });
  }

  function updateSelectionSummary(){
    const st = String(el("mStatus").value || "").toUpperCase();
    if(st==="PENDING"){
      el("selectionSummary").textContent = "PENDING: chưa chọn khách.";
      return;
    }
    if(st==="WON"){
      if(!selectedWinner){
        el("selectionSummary").textContent = "WON: chưa chọn khách trúng.";
        return;
      }
      const it = (eligible||[]).find(x=>String(x.customer_id)===String(selectedWinner));
      el("selectionSummary").textContent = it ? (`WON: #${it.customer_id} • ${it.full_name || ""}`) : (`WON: #${selectedWinner}`);
      return;
    }
    // TIED
    const ids = Array.from(selectedTied);
    if(ids.length<2){
      el("selectionSummary").textContent = "TIED: cần chọn tối thiểu 2 khách hòa.";
      return;
    }
    const names = ids.map(id=>{
      const it = (eligible||[]).find(x=>String(x.customer_id)===String(id));
      return it ? (`#${id} ${it.full_name||""}`) : `#${id}`;
    });
    el("selectionSummary").textContent = "TIED: " + names.join(" • ");
  }

  // reload eligible
  el("btnReloadEligible").addEventListener("click", async ()=>{
    if(!currentLot){ toast("Thông báo","Chưa chọn lô."); return; }
    el("eligibleNote").textContent = "Đang tải...";
    eligible = await apiEligibleCustomers();
    el("eligibleNote").textContent = "Tổng: " + (eligible.length || 0);
    // keep selections if still exists
    renderEligibleList();
    updateSelectionSummary();
  });

  // open editor on row
  qsa(".btnHandle").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      if(!PROJECT_ID || !SESSION_ID){
        toast("Thiếu thông tin", "Hãy chọn dự án để tạo phiên kiểm phiếu.");
        return;
      }
      const tr = btn.closest("tr[data-lot]");
      if(!tr) return;
      try{
        currentLot = JSON.parse(tr.getAttribute("data-lot") || "{}");
      }catch(e){
        toast("Lỗi","Không đọc được dữ liệu lô.");
        return;
      }

      // reset state
      eligible = [];
      selectedWinner = null;
      selectedTied = new Set();

      el("modalTitle").textContent = `Lô ${currentLot.lot_code || ""} — ${currentLot.lot_name || ""}`;
      updateAuctionInfo();

      // set modal form from existing data (if any)
      const st = String(currentLot.counting_status || "PENDING").toUpperCase();
      el("mStatus").value = ["PENDING","TIED","WON"].includes(st) ? st : "PENDING";
      el("mHighest").value = currentLot.highest_price_vnd != null ? fmtNum(currentLot.highest_price_vnd) : "";
      el("mReason").value = currentLot.edit_reason || "";

      // restore tied ids if any
      if(st==="TIED"){
        const ids = currentLot.tied_customer_ids;
        let arr = [];
        if(Array.isArray(ids)) arr = ids;
        else if(typeof ids === "string"){
          try{ arr = JSON.parse(ids); }catch(e){}
        }
        (arr||[]).forEach(x=> selectedTied.add(String(x)));
      }
      if(st==="WON" && currentLot.winner_customer_id){
        selectedWinner = String(currentLot.winner_customer_id);
        // restore is_lucky_draw if present
        if(currentLot.is_lucky_draw === true) setLuckyDrawRadios("true");
        if(currentLot.is_lucky_draw === false) setLuckyDrawRadios("false");
      }else{
        setLuckyDrawRadios("");
      }

      updateStatusUI();
      openModal();

      // load eligible immediately
      el("eligibleNote").textContent = "Đang tải...";
      eligible = await apiEligibleCustomers();
      el("eligibleNote").textContent = "Tổng: " + (eligible.length || 0);

      // if selections exist, re-render
      renderEligibleList();
      updateSelectionSummary();
    });
  });

  // ---------------------------
  // Confirm flow (custom)
  // ---------------------------
  let pendingConfirm = null; // function

  function openConfirm(text, onYes){
    el("confirmText").textContent = text || "";
    pendingConfirm = onYes;
    el("modalMask").classList.remove("hidden");
    el("confirmModal").classList.remove("hidden");
  }
  function closeConfirm(){
    el("confirmModal").classList.add("hidden");
    pendingConfirm = null;
    // keep editor open; mask remains from editor
  }
  el("btnConfirmClose").addEventListener("click", closeConfirm);
  el("btnConfirmNo").addEventListener("click", closeConfirm);
  el("btnConfirmYes").addEventListener("click", async ()=>{
    const fn = pendingConfirm;
    closeConfirm();
    if(fn) await fn();
  });

  // ---------------------------
  // Save
  // ---------------------------
  async function apiUpsert(payload){
    const lotCode = encodeURIComponent(String(currentLot.lot_code || "").trim());
    const url = `/auction/counting/api/sessions/${SESSION_ID}/lots/${lotCode}`;
    const r = await fetch(url, {
      method: "PUT",
      headers: {"Content-Type":"application/json","Accept":"application/json"},
      body: JSON.stringify(payload)
    });
    const js = await r.json().catch(()=> ({}));
    if(!r.ok || !js || js.ok!==true){
      const msg = (js && (js.detail || js.error)) ? (js.detail || js.error) : ("HTTP " + r.status);
      throw new Error(msg);
    }
    return js;
  }

  el("btnSave").addEventListener("click", async ()=>{
    if(!PROJECT_ID || !SESSION_ID || !currentLot){
      toast("Thiếu dữ liệu", "Không đủ thông tin để lưu.");
      return;
    }

    const status = String(el("mStatus").value || "").toUpperCase();
    const highest = parseNum(el("mHighest").value);
    const reason = (el("mReason").value || "").trim();

    // Build payload by status (matching Service A)
    const payload = { status };

    if(status === "PENDING"){
      // allow clear
      payload.edit_reason = reason || null;
    }

    if(status === "TIED"){
      if(highest===null || highest<=0){
        toast("Thiếu dữ liệu", "TIED cần nhập Giá cao nhất > 0.");
        return;
      }
      const ids = Array.from(selectedTied).map(x=> parseInt(x,10)).filter(x=> Number.isFinite(x) && x>0);
      const uniq = Array.from(new Set(ids));
      if(uniq.length < 2){
        toast("Thiếu dữ liệu", "TIED cần chọn tối thiểu 2 khách hòa.");
        return;
      }
      payload.highest_price_vnd = highest;
      payload.tied_customer_ids = uniq;
      payload.edit_reason = reason || null;
    }

    if(status === "WON"){
      if(highest===null || highest<=0){
        toast("Thiếu dữ liệu", "WON cần nhập Giá cao nhất > 0.");
        return;
      }
      if(!selectedWinner){
        toast("Thiếu dữ liệu", "WON cần chọn 1 khách trúng.");
        return;
      }
      const draw = getLuckyDrawValue(); // must be chosen explicitly
      if(draw === null){
        toast("Thiếu dữ liệu", "WON bắt buộc xác nhận is_lucky_draw (Có/Không bốc thăm).");
        return;
      }

      payload.highest_price_vnd = highest;
      payload.winner_customer_id = parseInt(selectedWinner, 10);
      payload.is_lucky_draw = (draw === "true");
      payload.edit_reason = reason || null;
    }

    // confirm text
    const lotLine = `Lô ${currentLot.lot_code || ""} — ${currentLot.lot_name || ""}`;
    let confirmText = `${lotLine}\nTrạng thái: ${status}\n`;
    if(status==="WON"){
      const it = (eligible||[]).find(x=>String(x.customer_id)===String(selectedWinner));
      confirmText += `Khách trúng: ${it ? ("#"+it.customer_id+" "+(it.full_name||"")) : ("#"+selectedWinner)}\n`;
      confirmText += `Giá cao nhất: ${fmtNum(highest)}\n`;
      confirmText += `is_lucky_draw: ${payload.is_lucky_draw ? "TRUE (bốc thăm)" : "FALSE (không bốc thăm)"}\n`;
    }
    if(status==="TIED"){
      confirmText += `Giá cao nhất: ${fmtNum(highest)}\n`;
      confirmText += `Số khách hòa: ${payload.tied_customer_ids.length}\n`;
    }
    if(status==="PENDING"){
      confirmText += `Sẽ xóa/đưa về PENDING cho lô này.\n`;
    }
    if(reason) confirmText += `Lý do: ${reason}\n`;

    openConfirm(confirmText, async ()=>{
      try{
        el("btnSave").disabled = true;
        el("btnSave").classList.add("opacity-70");
        await apiUpsert(payload);
        toast("Thành công", "Đã lưu kết quả. Trang sẽ tải lại để đồng bộ.");
        setTimeout(()=> window.location.reload(), 600);
      }catch(e){
        toast("Lỗi lưu", e.message || String(e));
      }finally{
        el("btnSave").disabled = false;
        el("btnSave").classList.remove("opacity-70");
      }
    });
  });

})();
</script>
{% endblock %}
