{% extends "base.html" %}
{% block title %}Kiểm phiếu trúng đấu giá (2 vòng){% endblock %}

{% block content %}
{% set rows = (data or {}).get('data') or [] %}
{% set total = (data or {}).get('total') or 0 %}
{% set sess = session %}
{% set prj = project_obj %}
{% set project_id = project_id %}
{% set qval = q or '' %}
{% set selected_key = project or '' %}

<style>
  /* ====== Small utility (fallback if base.html doesn't have) ====== */
  .ac-card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .ac-muted{color:#64748b}
  .ac-chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid #e5e7eb;background:#f8fafc;font-weight:600;font-size:13px}
  .ac-chip strong{font-weight:800}
  .ac-btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;font-weight:700}
  .ac-btn.primary{background:#16a34a;border-color:#16a34a;color:#fff}
  .ac-btn.dark{background:#0f172a;border-color:#0f172a;color:#fff}
  .ac-btn.ghost{background:#fff}
  .ac-btn:disabled{opacity:.55;cursor:not-allowed}
  .ac-input{width:100%;border:1px solid #cbd5e1;border-radius:12px;padding:10px 12px;outline:none;background:#fff}
  .ac-input:focus{border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.15)}
  .ac-select{width:100%;border:1px solid #cbd5e1;border-radius:12px;padding:10px 12px;background:#fff}
  .ac-table{width:100%;border-collapse:separate;border-spacing:0}
  .ac-table th{font-size:12px;text-transform:uppercase;letter-spacing:.03em;color:#64748b;text-align:left;padding:12px 14px;border-bottom:1px solid #e5e7eb;background:#f8fafc}
  .ac-table td{padding:14px;border-bottom:1px solid #eef2f7;vertical-align:top}
  .ac-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-weight:800;font-size:12px;border:1px solid transparent}
  .ac-badge.pending{background:#f1f5f9;color:#0f172a;border-color:#e2e8f0}
  .ac-badge.won{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}
  .ac-badge.tied{background:#fff7ed;color:#9a3412;border-color:#fed7aa}
  .ac-kv{display:flex;gap:10px;flex-wrap:wrap}
  .ac-kv span{display:inline-flex;gap:6px;align-items:baseline}
  .ac-kv .k{color:#64748b;font-size:12px}
  .ac-kv .v{font-weight:800;color:#0f172a}
  .ac-winner{margin-top:8px;padding:10px 12px;border-radius:12px;background:#f8fafc;border:1px solid #e5e7eb}
  .ac-winner .name{font-weight:900}
  .ac-winner .sub{color:#475569;font-size:13px;margin-top:2px}
  .ac-right{display:flex;gap:10px;align-items:center;justify-content:flex-end;flex-wrap:wrap}
  .ac-topbar{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap}
  .ac-h1{font-size:24px;font-weight:900;color:#0f172a;display:flex;gap:10px;align-items:center}
  .ac-h1 i{font-size:26px;color:#16a34a}
  .ac-sub{margin-top:6px;color:#64748b}
  .ac-grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
  @media (max-width: 1024px){ .ac-grid{grid-template-columns:1fr} }
  /* ===== Modal ===== */
  .ac-modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.55);display:none;align-items:center;justify-content:center;padding:18px;z-index:60}
  .ac-modal-backdrop.show{display:flex}
  .ac-modal{width:min(1120px, 100%);max-height:calc(100vh - 36px);background:#fff;border-radius:18px;box-shadow:0 20px 80px rgba(0,0,0,.35);overflow:hidden;display:flex;flex-direction:column}
  .ac-modal-header{padding:16px 18px;border-bottom:1px solid #eef2f7;display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
  .ac-modal-title{font-weight:1000;font-size:18px;color:#0f172a}
  .ac-modal-sub{font-size:13px;color:#64748b;margin-top:4px}
  .ac-modal-body{padding:16px 18px;overflow:auto}
  .ac-modal-footer{padding:14px 18px;border-top:1px solid #eef2f7;display:flex;gap:10px;justify-content:flex-end;background:#fff;position:sticky;bottom:0}
  .ac-x{border:none;background:transparent;font-size:22px;line-height:1;color:#475569;cursor:pointer}
  /* ===== Pricing focus ===== */
  .price-box{border:1px solid #dbeafe;background:#eff6ff;border-radius:16px;padding:14px}
  .price-main{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .price-main .label{color:#1e3a8a;font-size:12px;font-weight:800;text-transform:uppercase;letter-spacing:.04em}
  .price-main .big{font-size:28px;font-weight:1000;color:#0f172a}
  .stepper{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .stepper .sbtn{padding:10px 12px;border-radius:12px;border:1px solid #cbd5e1;background:#fff;font-weight:900;min-width:56px}
  .stepper .sbtn:hover{background:#f8fafc}
  .help-note{font-size:12px;color:#475569;margin-top:8px}
  .cust-row{border:1px solid #e5e7eb;border-radius:16px;padding:12px 12px;background:#fff;display:flex;align-items:flex-start;gap:12px}
  .cust-row:hover{border-color:#cbd5e1}
  .cust-meta{flex:1;min-width:0}
  .cust-name{font-weight:1000;color:#0f172a}
  .cust-sub{margin-top:4px;color:#475569;font-size:13px;display:flex;gap:8px;flex-wrap:wrap}
  .cust-id{font-weight:800;color:#64748b}
  .cust-pick{margin-top:2px}
  .ac-toast{display:none;margin:0 0 14px 0;padding:12px 12px;border-radius:14px;border:1px solid #fecaca;background:#fef2f2;color:#991b1b}
  .ac-toast.show{display:block}
  .tiny{font-size:12px;color:#64748b}
</style>

<div class="ac-topbar mb-6">
  <div>
    <div class="ac-h1">
      <i class="ri-auction-line"></i>
      Kiểm phiếu trúng đấu giá (2 vòng)
    </div>
    <div class="ac-sub">
      Vòng 1: xác định <b>TIED</b> (≥2 khách cùng giá cao nhất). Vòng 2: bốc thăm chọn <b>WON</b> từ danh sách TIED (khi lưu WON bắt buộc xác nhận <b>is_lucky_draw</b>).
    </div>
  </div>

  <div class="ac-right">
    <button class="ac-btn ghost" id="btnOpenDisplay" type="button">
      <i class="ri-slideshow-3-line"></i> Trình chiếu
    </button>
    <button class="ac-btn primary" id="btnReload" type="button">
      <i class="ri-refresh-line"></i> Tải lại
    </button>
  </div>
</div>

{% if session_err %}
  <div class="ac-toast show">
    Không tạo/khởi tạo được phiên COUNTING.
    <div class="tiny">HTTP {{ session_err.status }} — {{ session_err.body }}</div>
  </div>
{% endif %}

{% if error %}
  <div class="ac-toast show">
    Lỗi tải danh sách lô.
    <div class="tiny">HTTP {{ error.status }} — {{ error.body }}</div>
  </div>
{% endif %}

<div class="ac-card p-5 mb-6">
  <div class="ac-grid">
    <div>
      <div class="font-extrabold text-slate-900 mb-2">Chọn dự án</div>
      <div class="flex gap-10 flex-wrap items-center">
        <div style="min-width: 360px; flex: 1;">
          <select class="ac-select" id="selProject">
            <option value="">— Chọn dự án —</option>
            {% for p in projects %}
              {% set code = p.get('project_code') or p.get('code') %}
              {% set pid = p.get('id') or p.get('project_id') %}
              {% set label = (code or pid) ~ " — " ~ (p.get('name') or '') %}
              <option value="{{ code or pid }}" {% if (selected_key|upper) == ((code or pid|string)|upper) %}selected{% endif %}>
                {{ label }}
              </option>
            {% endfor %}
          </select>
          <div class="mt-2 ac-muted text-sm">
            Dropdown gồm cả <b>ACTIVE</b> và <b>INACTIVE</b>. Nếu chỉ có 1 ACTIVE, hệ thống tự chọn.
          </div>
        </div>

        <div style="min-width: 280px;">
          <div class="font-extrabold text-slate-900 mb-2">Tìm lô</div>
          <form id="frmFilter" class="flex gap-2">
            <input class="ac-input" name="q" id="inpQ" placeholder="Nhập mã lô..." value="{{ qval }}" />
            <button class="ac-btn dark" type="submit"><i class="ri-filter-3-line"></i> Lọc</button>
            <button class="ac-btn ghost" type="button" id="btnReset">Reset</button>
          </form>
        </div>
      </div>

      <div class="mt-4 flex gap-2 flex-wrap items-center">
        <span class="ac-chip"><i class="ri-timer-line"></i> Phiên: <strong>{% if sess %}#{{ sess.id }} ({{ sess.status }}){% else %}—{% endif %}</strong></span>
        <span class="ac-chip"><i class="ri-stack-line"></i> Tổng lô: <strong id="chipTotalLots">—</strong></span>
        <span class="ac-chip" style="background:#ecfdf5;border-color:#a7f3d0;color:#065f46"><i class="ri-trophy-line"></i> WON: <strong id="chipWon">—</strong></span>
        <span class="ac-chip" style="background:#fff7ed;border-color:#fed7aa;color:#9a3412"><i class="ri-git-merge-line"></i> TIED: <strong id="chipTied">—</strong></span>
        <span class="ac-chip" style="background:#f1f5f9;border-color:#e2e8f0;color:#0f172a"><i class="ri-check-line"></i> Đã xử lý: <strong id="chipChecked">—</strong></span>
      </div>
    </div>

    <div>
      <div class="font-extrabold text-slate-900 mb-2">Ghi chú nghiệp vụ</div>
      <div class="ac-muted text-sm leading-relaxed">
        - Vòng 1: nhập <b>WON</b> nếu có 1 người cao nhất; nhập <b>TIED</b> nếu ≥2 người hòa.<br/>
        - Vòng 2: chọn 1 người trong danh sách TIED → lưu <b>WON</b> và <b>tick “Bốc thăm”</b> (is_lucky_draw).<br/>
        - Có thể chỉnh sửa linh hoạt (TIED → WON hoặc WON → TIED/PENDING) nếu phát hiện nhập sai.
      </div>
    </div>
  </div>
</div>

<div class="ac-card overflow-hidden">
  <div class="flex items-center justify-between px-5 py-4 border-b border-slate-100">
    <div class="font-extrabold text-slate-900">Danh sách lô</div>
    <div class="ac-muted text-sm">Bấm <b>Xử lý</b> để nhập kết quả vòng 1 / vòng 2.</div>
  </div>

  <div class="overflow-x-auto">
    <table class="ac-table" id="tblLots">
      <thead>
        <tr>
          <th style="width:160px">Mã lô</th>
          <th style="width:360px">Giá / Bước / Diện tích</th>
          <th style="width:160px">Giá trúng</th>
          <th style="width:200px">Trạng thái</th>
          <th>Người trúng (nếu có)</th>
          <th style="width:140px;text-align:right">Thao tác</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
          {% set st = (r.get('counting_status') or 'PENDING') %}
          <tr data-lot='{{ r | tojson }}'>
            <td>
              <div class="font-extrabold text-slate-900">{{ r.get('lot_code') }}</div>
              <div class="tiny">ID: {{ r.get('lot_id') }}</div>
            </td>

            <td>
              <div class="ac-kv">
                <span><span class="k">Giá KL:</span><span class="v" data-money="{{ r.get('starting_price_vnd') }}">{{ r.get('starting_price_vnd') }}</span></span>
                <span><span class="k">Bước:</span><span class="v" data-money="{{ r.get('bid_step_vnd') }}">{{ r.get('bid_step_vnd') }}</span></span>
                <span><span class="k">DT:</span><span class="v">{{ r.get('area') or '—' }} m²</span></span>
              </div>
              <div class="mt-2 tiny">
                Giá/m²: <b data-money-sqm="{{ r.get('starting_price_vnd') }}" data-area="{{ r.get('area') }}">—</b>
                · Mode: <b class="mode">{{ r.get('auction_mode') or ((data or {}).get('project') or {}).get('auction_mode') or (project_obj or {}).get('auction_mode') or '—' }}</b>
              </div>
              {% if r.get('highest_price_vnd') %}
                <div class="mt-2 tiny">
                  Giá cao nhất đã nhập: <b data-money="{{ r.get('highest_price_vnd') }}">{{ r.get('highest_price_vnd') }}</b>
                </div>
              {% endif %}
            </td>

            <td>
              {% if st == 'WON' and r.get('highest_price_vnd') %}
                <div class="font-extrabold text-slate-900" data-money="{{ r.get('highest_price_vnd') }}">{{ r.get('highest_price_vnd') }}</div>
                <div class="tiny">{% if r.get('is_lucky_draw') %}Bốc thăm{% else %}Không bốc thăm{% endif %}</div>
              {% else %}
                <div class="ac-muted">—</div>
              {% endif %}
            </td>

            <td>
              {% if st == 'WON' %}
                <span class="ac-badge won"><i class="ri-trophy-line"></i> WON</span>
              {% elif st == 'TIED' %}
                <span class="ac-badge tied"><i class="ri-git-merge-line"></i> TIED</span>
              {% else %}
                <span class="ac-badge pending"><i class="ri-time-line"></i> PENDING</span>
              {% endif %}

              <div class="tiny mt-2">
                {% if r.get('set_by') %}Người nhập: <b>{{ r.get('set_by') }}</b>{% endif %}
                {% if r.get('set_at') %}
                  <div>Thời điểm: <b class="ts">{{ r.get('set_at') }}</b></div>
                {% endif %}
                {% if r.get('edit_reason') %}
                  <div>Ghi chú: {{ r.get('edit_reason') }}</div>
                {% endif %}
              </div>
            </td>

            <td>
              {# winner info from API (if later A adds it in list response) #}
              {% if r.get('winner_name') or r.get('winner_cccd') or r.get('winner_phone') %}
                <div class="ac-winner">
                  <div class="name">{{ r.get('winner_name') or '—' }}</div>
                  <div class="sub">
                    CCCD: <b>{{ r.get('winner_cccd') or '—' }}</b>
                    · SĐT: <b>{{ r.get('winner_phone') or '—' }}</b>
                  </div>
                </div>
              {% else %}
                <div class="ac-muted">—</div>
              {% endif %}
            </td>

            <td style="text-align:right">
              <button class="ac-btn ghost btnHandle" type="button">
                <i class="ri-edit-2-line"></i> Xử lý
              </button>
            </td>
          </tr>
        {% endfor %}

        {% if rows|length == 0 %}
          <tr>
            <td colspan="6" class="ac-muted" style="padding:18px">Chưa có dữ liệu. Hãy chọn dự án.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

{# ===================== MODAL ===================== #}
<div class="ac-modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="ac-modal" role="dialog" aria-modal="true">
    <div class="ac-modal-header">
      <div>
        <div class="ac-modal-title" id="modalTitle">Xử lý kết quả</div>
        <div class="ac-modal-sub" id="modalSub">—</div>
      </div>
      <button class="ac-x" type="button" id="btnCloseModal">×</button>
    </div>

    <div class="ac-modal-body">
      <div class="ac-toast" id="modalErr"></div>

      <div class="ac-grid" style="grid-template-columns:.95fr 1.05fr">
        <div style="display:flex;flex-direction:column;gap:12px">

          <div class="ac-card p-4" style="border-radius:16px">
            <div class="font-extrabold text-slate-900 mb-2">Trạng thái nhập</div>

            <label class="tiny font-extrabold text-slate-700">Trạng thái</label>
            <select class="ac-select mt-1" id="selStatus">
              <option value="PENDING">PENDING (chưa xử lý)</option>
              <option value="WON">WON (chốt người trúng)</option>
              <option value="TIED">TIED (hòa ≥2 khách)</option>
            </select>

            <div class="mt-3 price-box">
              <div class="price-main">
                <div>
                  <div class="label">Giá cao nhất (để xét)</div>
                  <div class="tiny mt-1" id="priceHint">—</div>
                </div>
              </div>

              <div style="margin-top:10px">
                <input class="ac-input" id="inpHighest" inputmode="numeric" placeholder="Nhập giá..." />
              </div>

              <div class="stepper">
                <button class="sbtn" type="button" data-step="-5">-5</button>
                <button class="sbtn" type="button" data-step="-2">-2</button>
                <button class="sbtn" type="button" data-step="-1">-1</button>
                <button class="sbtn" type="button" data-step="1">+1</button>
                <button class="sbtn" type="button" data-step="2">+2</button>
                <button class="sbtn" type="button" data-step="5">+5</button>
              </div>

              <div class="help-note">
                Mẹo: nếu chưa nhập giá, bấm +1 sẽ lấy <b>giá khởi điểm</b> làm base và cộng theo <b>bước giá</b>.
              </div>
            </div>

            <div class="mt-3">
              <label class="tiny font-extrabold text-slate-700">Lý do chỉnh sửa (tuỳ chọn)</label>
              <input class="ac-input mt-1" id="inpReason" placeholder="Ví dụ: sửa sai người hòa / cập nhật lại giá..." />
            </div>

            <div class="mt-3" id="boxLucky" style="display:none">
              <label class="tiny font-extrabold text-slate-700">Xác nhận bốc thăm (is_lucky_draw)</label>
              <label style="display:flex;gap:10px;align-items:center;margin-top:8px">
                <input type="checkbox" id="chkLucky" style="width:18px;height:18px"/>
                <span class="font-extrabold text-slate-900">Kết quả WON này là do bốc thăm</span>
              </label>
              <div class="tiny mt-1 ac-muted">Bắt buộc tick nếu bạn đang chốt người trúng từ nhóm TIED.</div>
            </div>
          </div>
        </div>

        <div style="display:flex;flex-direction:column;gap:12px">
          <div class="ac-card p-4" style="border-radius:16px">
            <div class="flex items-center justify-between gap-10 flex-wrap">
              <div>
                <div class="font-extrabold text-slate-900">Danh sách khách đủ điều kiện</div>
                <div class="tiny ac-muted mt-1">Chọn khách theo trạng thái: WON (1 khách) · TIED (≥2 khách)</div>
              </div>
              <button class="ac-btn ghost" type="button" id="btnLoadCustomers">
                <i class="ri-download-2-line"></i> Tải DS
              </button>
            </div>

            <div class="mt-3">
              <input class="ac-input" id="inpSearchCust" placeholder="Tìm theo tên/CCCD/phone..." />
            </div>

            <div class="mt-3 ac-muted tiny" id="custCount">Tổng: —</div>

            <div class="mt-3" id="custList" style="display:flex;flex-direction:column;gap:10px;max-height:420px;overflow:auto;padding-right:2px"></div>

            <div class="ac-card p-3 mt-3" style="border-radius:14px;background:#f8fafc">
              <div class="font-extrabold text-slate-900 mb-1">Tóm tắt lựa chọn</div>
              <div class="tiny" id="pickSummary">PENDING: chưa chọn khách.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="ac-modal-footer">
      <button class="ac-btn ghost" type="button" id="btnCancel">Đóng</button>
      <button class="ac-btn primary" type="button" id="btnSave">
        <i class="ri-save-3-line"></i> Lưu
      </button>
    </div>
  </div>
</div>

<script>
(function(){
  const PROJECT_ID = {{ project_id or 'null' }};
  const SESSION_ID = {{ (sess.id if sess else 'null') }};
  const SELECTED_KEY = {{ (selected_key|tojson) }};
  const POLL_URL = "/auction/counting/api/display/snapshot";

  const fmtVND = (n) => {
    if (n === null || n === undefined || n === '') return "—";
    const x = Number(n);
    if (!isFinite(x)) return "—";
    return Math.round(x).toLocaleString('vi-VN');
  };

  const moneyNoFrac = (el) => {
    const v = el.getAttribute('data-money');
    el.textContent = fmtVND(v);
  };

  const calcSqmPrice = (total, area) => {
    const t = Number(total);
    const a = Number(area);
    if (!isFinite(t) || !isFinite(a) || a <= 0) return null;
    return t / a;
  };

  // format on list immediately
  document.querySelectorAll('[data-money]').forEach(moneyNoFrac);
  document.querySelectorAll('[data-money-sqm]').forEach(el=>{
    const total = el.getAttribute('data-money-sqm');
    const area = el.getAttribute('data-area');
    const sqm = calcSqmPrice(total, area);
    el.textContent = sqm ? (fmtVND(sqm) + " VND/m²") : "—";
  });
  document.querySelectorAll('.ts').forEach(el=>{
    // keep as is; you can custom format later
    try{
      const d = new Date(el.textContent);
      if (!isNaN(d.getTime())){
        el.textContent = d.toLocaleString('vi-VN');
      }
    }catch(e){}
  });

  // chips via snapshot
  async function refreshSnapshot(){
    if (!PROJECT_ID) return;
    const url = new URL(location.origin + POLL_URL);
    url.searchParams.set("project_id", PROJECT_ID);
    if (SESSION_ID) url.searchParams.set("session_id", SESSION_ID);
    try{
      const r = await fetch(url.toString(), {headers: {"Accept":"application/json"}});
      if (!r.ok) return;
      const js = await r.json();
      const sum = (js && js.summary) || {};
      document.getElementById("chipTotalLots").textContent = (sum.total_lots ?? "—");
      document.getElementById("chipWon").textContent = (sum.won ?? "—");
      document.getElementById("chipTied").textContent = (sum.tied ?? "—");
      document.getElementById("chipChecked").textContent = (sum.checked ?? "—");
    }catch(e){}
  }
  refreshSnapshot();

  // top actions
  document.getElementById("btnReload").addEventListener("click", ()=>location.reload());
  document.getElementById("btnReset").addEventListener("click", ()=>{
    const pid = document.getElementById("selProject").value || "";
    const url = new URL(location.href);
    url.searchParams.delete("q");
    url.searchParams.set("page","1");
    if (pid) url.searchParams.set("project", pid);
    else url.searchParams.delete("project");
    location.href = url.toString();
  });

  document.getElementById("frmFilter").addEventListener("submit", (e)=>{
    e.preventDefault();
    const pid = document.getElementById("selProject").value || "";
    const q = document.getElementById("inpQ").value || "";
    const url = new URL(location.href);
    url.searchParams.set("page","1");
    if (pid) url.searchParams.set("project", pid); else url.searchParams.delete("project");
    if (q.trim()) url.searchParams.set("q", q.trim()); else url.searchParams.delete("q");
    location.href = url.toString();
  });

  document.getElementById("selProject").addEventListener("change", ()=>{
    const v = document.getElementById("selProject").value || "";
    const url = new URL(location.href);
    url.searchParams.set("page","1");
    url.searchParams.delete("q");
    if (v) url.searchParams.set("project", v); else url.searchParams.delete("project");
    location.href = url.toString();
  });

  document.getElementById("btnOpenDisplay").addEventListener("click", ()=>{
    const v = document.getElementById("selProject").value || SELECTED_KEY || "";
    if (!v){
      alert("Hãy chọn dự án trước."); // base fallback; nếu bạn muốn modal custom như quy ước, mình đổi sau
      return;
    }
    const u = new URL(location.origin + "/auction/counting/display");
    u.searchParams.set("project", v);
    window.open(u.toString(), "_blank");
  });

  // ===== Modal state =====
  const bd = document.getElementById("modalBackdrop");
  const btnClose = document.getElementById("btnCloseModal");
  const btnCancel = document.getElementById("btnCancel");
  const btnSave = document.getElementById("btnSave");
  const modalErr = document.getElementById("modalErr");

  const selStatus = document.getElementById("selStatus");
  const inpHighest = document.getElementById("inpHighest");
  const inpReason = document.getElementById("inpReason");
  const boxLucky = document.getElementById("boxLucky");
  const chkLucky = document.getElementById("chkLucky");

  const btnLoadCustomers = document.getElementById("btnLoadCustomers");
  const inpSearchCust = document.getElementById("inpSearchCust");
  const custList = document.getElementById("custList");
  const custCount = document.getElementById("custCount");
  const pickSummary = document.getElementById("pickSummary");
  const priceHint = document.getElementById("priceHint");

  let curLot = null;
  let customers = [];
  let picked = new Set(); // customer_ids selected
  let baseStart = 0;
  let stepV = 0;
  let auctionMode = "PER_LOT"; // or PER_SQM
  let startPerSqm = null;

  function openModal(lot){
    curLot = lot;
    picked = new Set();
    customers = [];
    custList.innerHTML = "";
    custCount.textContent = "Tổng: —";
    inpSearchCust.value = "";
    modalErr.classList.remove("show");
    modalErr.textContent = "";

    const lotCode = lot.lot_code || lot.lotCode || "";
    const lotId = lot.lot_id || lot.id || "";
    const area = lot.area || lot.area_m2 || null;

    // start price full lot
    const sp = Number(lot.starting_price_vnd || 0);
    const bs = Number(lot.bid_step_vnd || 0);

    baseStart = isFinite(sp) ? sp : 0;
    stepV = isFinite(bs) ? bs : 0;

    // mode (project-level)
    auctionMode = (lot.auction_mode || ({{ (project_obj.get('auction_mode') if project_obj else '')|tojson }}) || "PER_LOT").toString().toUpperCase();
    startPerSqm = calcSqmPrice(baseStart, area);

    document.getElementById("modalTitle").textContent = `Xử lý kết quả — Lô ${lotCode}`;
    document.getElementById("modalSub").textContent =
      `Mode: ${auctionMode} · Bước giá: ${fmtVND(stepV)} VND · Giá KL: ${fmtVND(baseStart)} VND` +
      (startPerSqm ? ` · Giá KL/m²: ${fmtVND(startPerSqm)} VND/m²` : "");

    // default status + prefill from existing counting
    const st = (lot.counting_status || "PENDING").toString().toUpperCase();
    selStatus.value = ["PENDING","WON","TIED"].includes(st) ? st : "PENDING";
    inpReason.value = lot.edit_reason || "";

    // price hint depending on mode
    const baseForInput = (auctionMode === "PER_SQM" && startPerSqm) ? startPerSqm : baseStart;
    priceHint.textContent =
      (auctionMode === "PER_SQM")
        ? `Dự án đấu theo m²: giá nhập thường là giá theo m² (base ≈ ${fmtVND(baseForInput)}).`
        : `Dự án đấu theo cả lô: giá nhập là giá cho cả lô (base = ${fmtVND(baseForInput)}).`;

    // set input from existing highest_price_vnd (as typed raw)
    if (lot.highest_price_vnd){
      inpHighest.value = fmtVND(lot.highest_price_vnd);
    } else {
      inpHighest.value = "";
    }

    // lucky draw default
    chkLucky.checked = !!lot.is_lucky_draw;

    // preselect winner/tied candidates if exists
    if (selStatus.value === "WON" && lot.winner_customer_id){
      picked.add(Number(lot.winner_customer_id));
    } else if (selStatus.value === "TIED" && lot.tied_customer_ids){
      let ids = lot.tied_customer_ids;
      if (typeof ids === "string"){
        try{ ids = JSON.parse(ids); }catch(e){ ids = []; }
      }
      if (Array.isArray(ids)){
        ids.forEach(x=>{
          const n = Number(x);
          if (isFinite(n) && n>0) picked.add(n);
        });
      }
    }

    updateLuckyUI();
    updatePickSummary();
    bd.classList.add("show");
    bd.setAttribute("aria-hidden","false");
    document.body.style.overflow = "hidden";
  }

  function closeModal(){
    bd.classList.remove("show");
    bd.setAttribute("aria-hidden","true");
    document.body.style.overflow = "";
    curLot = null;
  }

  function showErr(msg){
    modalErr.textContent = msg;
    modalErr.classList.add("show");
    // scroll modal body top
    document.querySelector(".ac-modal-body").scrollTop = 0;
  }

  btnClose.addEventListener("click", closeModal);
  btnCancel.addEventListener("click", closeModal);
  bd.addEventListener("click", (e)=>{ if(e.target === bd) closeModal(); });

  function parseMoneyInput(str){
    const s = (str || "").toString().replace(/[^\d]/g,"");
    if (!s) return null;
    const n = Number(s);
    return isFinite(n) ? n : null;
  }
  function setMoneyInput(n){
    if (n === null || n === undefined) { inpHighest.value = ""; return; }
    inpHighest.value = fmtVND(n);
  }
  inpHighest.addEventListener("input", ()=>{
    // live formatting but keep caret tricky => simplest: allow digits only then format on blur
    const raw = inpHighest.value.replace(/[^\d]/g,"");
    inpHighest.value = raw ? raw : "";
  });
  inpHighest.addEventListener("blur", ()=>{
    const n = parseMoneyInput(inpHighest.value);
    if (n !== null) setMoneyInput(n);
  });

  document.querySelectorAll(".stepper .sbtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const k = Number(btn.getAttribute("data-step") || 0);
      if (!k) return;

      const step = stepV || 0;
      if (step <= 0){
        showErr("Chưa có bước giá hợp lệ (bid_step_vnd).");
        return;
      }

      // base for input depends on auction_mode
      const base = (auctionMode === "PER_SQM" && startPerSqm) ? startPerSqm : baseStart;
      let cur = parseMoneyInput(inpHighest.value);
      if (cur === null) cur = Math.round(base);

      cur = cur + k * step;
      if (cur < 0) cur = 0;

      setMoneyInput(cur);
    });
  });

  function updateLuckyUI(){
    // show only for WON
    const st = selStatus.value;
    boxLucky.style.display = (st === "WON") ? "block" : "none";
    if (st !== "WON"){
      chkLucky.checked = false;
    }
  }

  function updatePickSummary(){
    const st = selStatus.value;
    if (st === "PENDING"){
      pickSummary.textContent = "PENDING: chưa chọn khách.";
      return;
    }
    const ids = Array.from(picked.values());
    if (st === "WON"){
      pickSummary.textContent = ids.length ? `WON: chọn #${ids[0]}` : "WON: chưa chọn người trúng.";
      return;
    }
    // TIED
    pickSummary.textContent = ids.length ? `TIED: chọn ${ids.length} khách (#${ids.join(", #")})` : "TIED: chưa chọn khách hòa.";
  }

  selStatus.addEventListener("change", ()=>{
    // adjust picked rules
    const st = selStatus.value;
    if (st === "WON" && picked.size > 1){
      // keep first only
      const first = picked.values().next().value;
      picked = new Set([first]);
    }
    if (st === "PENDING"){
      picked = new Set();
    }
    updateLuckyUI();
    renderCustomers();
    updatePickSummary();
  });

  // Handle click on list button
  document.querySelectorAll(".btnHandle").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const tr = btn.closest("tr");
      if (!tr) return;
      try{
        const lot = JSON.parse(tr.getAttribute("data-lot"));
        if (!PROJECT_ID || !SESSION_ID){
          alert("Hãy chọn dự án trước."); // fallback
          return;
        }
        openModal(lot);
      }catch(e){}
    });
  });

  // Load eligible customers
  async function loadCustomers(){
    if (!curLot) return;
    const lotCode = encodeURIComponent((curLot.lot_code || "").trim());
    if (!lotCode) return;

    btnLoadCustomers.disabled = true;
    btnLoadCustomers.innerHTML = `<i class="ri-loader-4-line"></i> Đang tải...`;

    const url = `/auction/counting/api/projects/${PROJECT_ID}/lots/${lotCode}/eligible-customers?limit=5000&include_unpaid=false`;
    try{
      const r = await fetch(url, {headers: {"Accept":"application/json"}});
      const js = await r.json();
      if (!r.ok || !js || js.ok !== true){
        throw new Error((js && (js.detail || js.error)) || "Load failed");
      }
      customers = js.data || [];
      custCount.textContent = `Tổng: ${customers.length}`;
      renderCustomers();
    }catch(e){
      showErr("Không tải được danh sách khách đủ điều kiện.");
    }finally{
      btnLoadCustomers.disabled = false;
      btnLoadCustomers.innerHTML = `<i class="ri-download-2-line"></i> Tải DS`;
    }
  }

  btnLoadCustomers.addEventListener("click", loadCustomers);

  inpSearchCust.addEventListener("input", ()=>{
    renderCustomers();
  });

  function renderCustomers(){
    const kw = (inpSearchCust.value || "").trim().toLowerCase();
    let list = customers || [];
    if (kw){
      list = list.filter(c=>{
        const s = [
          c.full_name, c.cccd, c.phone, c.email, c.address, c.customer_id
        ].map(x=> (x ?? "").toString().toLowerCase()).join(" ");
        return s.includes(kw);
      });
    }

    const st = selStatus.value;
    custList.innerHTML = "";

    list.forEach(c=>{
      const cid = Number(c.customer_id || c.id);
      if (!cid) return;

      const checked = picked.has(cid);

      const row = document.createElement("div");
      row.className = "cust-row";
      row.innerHTML = `
        <div class="cust-pick">
          <input type="checkbox" ${checked ? "checked" : ""} style="width:18px;height:18px;margin-top:3px"/>
        </div>
        <div class="cust-meta">
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
            <div class="cust-name">${escapeHtml(c.full_name || "—")}</div>
            <div class="cust-id">#${cid}</div>
          </div>
          <div class="cust-sub">
            <span>CCCD: <b>${escapeHtml(c.cccd || "—")}</b></span>
            <span>· Phone: <b>${escapeHtml(c.phone || "—")}</b></span>
          </div>
        </div>
      `;

      const cb = row.querySelector("input[type=checkbox]");
      cb.addEventListener("change", ()=>{
        if (st === "PENDING"){
          cb.checked = false;
          return;
        }
        if (st === "WON"){
          // only 1
          picked = new Set([cid]);
          // uncheck others by rerender
          renderCustomers();
        } else {
          // TIED multi
          if (cb.checked) picked.add(cid);
          else picked.delete(cid);
        }
        updatePickSummary();
      });

      custList.appendChild(row);
    });

    updatePickSummary();
  }

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  // Save
  async function save(){
    if (!curLot) return;
    modalErr.classList.remove("show");
    modalErr.textContent = "";

    const lotCode = encodeURIComponent((curLot.lot_code || "").trim());
    const st = selStatus.value;
    const hp = parseMoneyInput(inpHighest.value);
    const reason = (inpReason.value || "").trim();
    const ids = Array.from(picked.values());

    // validate
    if (st === "WON"){
      if (!hp || hp <= 0) return showErr("Giá cao nhất là bắt buộc khi WON.");
      if (ids.length !== 1) return showErr("WON phải chọn đúng 1 khách trúng.");
      // is_lucky_draw required when status=WON (per your Service A)
      // User must explicitly confirm via checkbox (payload carries is_lucky_draw)
      // You said: operator confirms, sure correct.
      const draw = !!chkLucky.checked;
      // allow both false/true, but must be present -> always send boolean
      var payload = {
        status: "WON",
        highest_price_vnd: hp,
        winner_customer_id: ids[0],
        is_lucky_draw: draw,
        edit_reason: reason || null
      };
    } else if (st === "TIED"){
      if (!hp || hp <= 0) return showErr("Giá cao nhất là bắt buộc khi TIED.");
      if (ids.length < 2) return showErr("TIED phải chọn ≥ 2 khách hòa.");
      var payload = {
        status: "TIED",
        highest_price_vnd: hp,
        tied_customer_ids: ids,
        edit_reason: reason || null
      };
    } else {
      var payload = {
        status: "PENDING",
        edit_reason: reason || null
      };
    }

    btnSave.disabled = true;
    btnSave.innerHTML = `<i class="ri-loader-4-line"></i> Đang lưu...`;

    try{
      const url = `/auction/counting/api/sessions/${SESSION_ID}/lots/${lotCode}`;
      const r = await fetch(url, {
        method: "PUT",
        headers: {"Content-Type":"application/json","Accept":"application/json"},
        body: JSON.stringify(payload)
      });
      const js = await r.json();
      if (!r.ok || !js || js.ok !== true){
        throw new Error((js && (js.detail || js.error)) || "Save failed");
      }
      // success: reload to reflect list changes
      closeModal();
      location.reload();
    }catch(e){
      showErr("Lưu thất bại. Vui lòng kiểm tra dữ liệu và thử lại.");
    }finally{
      btnSave.disabled = false;
      btnSave.innerHTML = `<i class="ri-save-3-line"></i> Lưu`;
    }
  }

  btnSave.addEventListener("click", save);

  // open modal by keyboard ESC
  document.addEventListener("keydown", (e)=>{
    if (e.key === "Escape" && bd.classList.contains("show")) closeModal();
  });

})();
</script>
{% endblock %}
