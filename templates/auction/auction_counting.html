{# templates/auction/auction_counting.html #}
{% extends "base.html" %}
{% block title %}Ki·ªÉm phi·∫øu tr√∫ng ƒë·∫•u gi√°{% endblock %}

{% block content %}
{% set projects = projects or [] %}
{% set project_id = project_id %}
{% set project_key = project or "" %}
{% set project_obj = project_obj or {} %}
{% set session = session or {} %}
{% set rows = (data or {}).get("data") or [] %}
{% set total = (data or {}).get("total") or (rows|length) %}
{% set q = q or "" %}
{% set page = page or 1 %}
{% set size = size or 200 %}
{% set auction_mode = (project_obj.get("auction_mode") or "") %}

<style>
  :root{
    --bd: rgba(226,232,240,1);
    --bd2: rgba(241,245,249,1);
    --muted: rgba(100,116,139,1);
    --ink: rgba(15,23,42,1);
    --bg: #fff;
    --rowEven: rgba(248,250,252,1);
  }

  .ac-card { border: 1px solid var(--bd); border-radius: 16px; background: var(--bg); box-shadow: 0 1px 2px rgba(0,0,0,.03); }
  .ac-pill { display:inline-flex; align-items:center; gap:.5rem; padding:.32rem .65rem; border-radius: 999px; font-weight: 700; font-size: .88rem; border: 1px solid var(--bd); background: rgba(248,250,252,1);}
  .ac-pill.green { border-color: rgba(167,243,208,1); background: rgba(236,253,245,1); color: rgba(6,95,70,1); }
  .ac-pill.orange { border-color: rgba(253,186,116,1); background: rgba(255,247,237,1); color: rgba(154,52,18,1); }
  .ac-pill.gray { border-color: var(--bd); background: rgba(248,250,252,1); color: rgba(51,65,85,1); }
  .ac-pill.blue { border-color: rgba(191,219,254,1); background: rgba(239,246,255,1); color: rgba(30,64,175,1); }

  .ac-btn { display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.56rem .9rem; border-radius: 12px; font-weight: 900; border: 1px solid var(--bd); background:#fff; }
  .ac-btn.primary { background: rgba(16,185,129,1); color:#fff; border-color: rgba(16,185,129,1); }
  .ac-btn.primary:hover { filter: brightness(.98); }
  .ac-btn.ghost:hover { background: rgba(248,250,252,1); }
  .ac-btn:disabled { opacity:.5; cursor:not-allowed; }

  .ac-btn.slim{ padding:.42rem .7rem; border-radius: 999px; font-size:.86rem; }
  .ac-btn.print{ border-color: rgba(191,219,254,1); background: rgba(239,246,255,1); color: rgba(30,64,175,1); }
  .ac-btn.print:hover{ filter: brightness(.98); }

  .ac-mini-print{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width: 34px;
    height: 34px;
    border-radius: 10px;
    border: 1px solid rgba(191,219,254,1);
    background: rgba(239,246,255,1);
    color: rgba(30,64,175,1);
    box-shadow: 0 1px 2px rgba(0,0,0,.04);
  }
  .ac-mini-print:hover{ filter: brightness(.98); }

  .ac-input { width: 100%; border-radius: 12px; border: 1px solid var(--bd); padding: .68rem .85rem; outline: none; background:#fff; }
  .ac-input:focus { border-color: rgba(99,102,241,1); box-shadow: 0 0 0 4px rgba(99,102,241,.15); }

  .ac-table { width:100%; border-collapse: separate; border-spacing: 0; }
  .ac-th { text-align:left; font-size:.76rem; letter-spacing:.02em; text-transform:uppercase; color: var(--muted); padding: .62rem .95rem; border-bottom:1px solid var(--bd); background: rgba(248,250,252,1); }
  .ac-td { padding: .62rem .95rem; border-bottom:1px solid var(--bd2); vertical-align: top; }
  .ac-row:hover { background: rgba(241,245,249,1); }
  #lotsTbody tr.ac-row:nth-child(even){ background: var(--rowEven); }
  #lotsTbody tr.ac-row:nth-child(even):hover{ background: rgba(241,245,249,1); }

  .ac-muted { color: var(--muted); }
  .ac-strong { color: var(--ink); font-weight: 900; }
  .ac-mono { font-variant-numeric: tabular-nums; }

  .ac-badge { display:inline-flex; align-items:center; gap:.4rem; padding:.22rem .58rem; border-radius: 999px; font-weight: 950; font-size:.82rem; }
  .ac-badge.won { background: rgba(236,253,245,1); color: rgba(6,95,70,1); border: 1px solid rgba(167,243,208,1); }
  .ac-badge.tied { background: rgba(255,247,237,1); color: rgba(154,52,18,1); border: 1px solid rgba(253,186,116,1); }
  .ac-badge.pending { background: rgba(248,250,252,1); color: rgba(71,85,105,1); border: 1px solid var(--bd); }

  /* Modal */
  .ac-modal-backdrop { position: fixed; inset: 0; background: rgba(2,6,23,.55); display:none; align-items:center; justify-content:center; padding: 18px; z-index: 60; }
  .ac-modal { width: 100%; max-width: 1200px; background: #fff; border-radius: 18px; overflow:hidden; box-shadow: 0 20px 50px rgba(0,0,0,.25); max-height: calc(100vh - 36px); display:flex; flex-direction:column; }
  .ac-modal-header { padding: 16px 18px; border-bottom: 1px solid var(--bd); display:flex; align-items:flex-start; justify-content:space-between; gap: 12px; }
  .ac-modal-body { padding: 16px 18px; overflow:auto; }
  .ac-modal-footer { padding: 14px 18px; border-top: 1px solid var(--bd); display:flex; justify-content:flex-end; gap: 10px; background: rgba(248,250,252,1); }

  .ac-kbd { font-weight: 900; font-size: .78rem; padding: .12rem .38rem; border-radius: 8px; border:1px solid var(--bd); background:#fff; color: rgba(51,65,85,1); }

  /* ‚úÖ Input + inline autocorrect */
  .ac-input-wrap { position: relative; }
  .ac-input-wrap .ac-input { padding-right: 170px; }
  .ac-input-inbtn {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    padding: .48rem .7rem;
    border-radius: 12px;
    font-weight: 900;
    border: 1px solid var(--bd);
    background: #fff;
    display:inline-flex;
    align-items:center;
    gap:.45rem;
    box-shadow: 0 1px 2px rgba(0,0,0,.04);
    user-select:none;
    white-space:nowrap;
    font-size:.9rem;
  }
  .ac-input-inbtn:hover { background: rgba(248,250,252,1); }

  /* ‚úÖ Step buttons close to textbox */
  .ac-quick { display:flex; flex-wrap:wrap; gap: 8px; margin-top: 10px; }
  .ac-quick button { min-width: 56px; padding:.5rem .7rem; font-size:.9rem; }

  .ac-customer { border:1px solid var(--bd); border-radius: 14px; padding: 10px 12px; display:flex; align-items:flex-start; justify-content:space-between; gap: 10px; background:#fff; }
  .ac-customer .meta { color: var(--muted); font-size:.86rem; margin-top: 2px; }
  .ac-customer .tag { font-size:.74rem; font-weight:900; padding:.12rem .45rem; border-radius:999px; border:1px solid var(--bd); background: rgba(248,250,252,1); color: rgba(51,65,85,1); }

  .ac-cart { border:1px dashed rgba(148,163,184,1); background: rgba(248,250,252,1); border-radius: 16px; padding: 12px; }
  .ac-cart .item { display:flex; align-items:flex-start; justify-content:space-between; gap: 10px; padding: 10px; border-radius: 12px; background:#fff; border:1px solid var(--bd); }
  .ac-cart .item + .item { margin-top: 8px; }
  .ac-cart .rm { border:1px solid var(--bd); background:#fff; border-radius: 10px; padding:.35rem .55rem; font-weight:900; }
  .ac-cart .rm:hover { background: rgba(248,250,252,1); }

  .ac-toast { position: fixed; right: 16px; bottom: 16px; z-index: 80; display:flex; flex-direction:column; gap:10px; }
  .ac-toast-item { max-width: 420px; padding: 12px 14px; border-radius: 14px; border:1px solid var(--bd); background:#fff; box-shadow: 0 10px 30px rgba(0,0,0,.12); }
  .ac-toast-item.err { border-color: rgba(254,202,202,1); background: rgba(254,242,242,1); }
  .ac-toast-item.ok { border-color: rgba(167,243,208,1); background: rgba(236,253,245,1); }
  .ac-toast-item .t { font-weight: 950; margin-bottom: 2px; }

  /* Compact lot cell */
  .lot-cell { display:flex; flex-direction:column; gap: 4px; }
  .lot-code { font-size: .98rem; font-weight: 950; letter-spacing: .15px; }
  .lot-sub { font-size:.8rem; color: var(--muted); display:flex; flex-wrap:wrap; gap: 8px; }
  .lot-sub b { color: rgba(51,65,85,1); font-weight: 900; }

  .cart-confirm { border:1px solid var(--bd); background:#fff; border-radius: 14px; padding: 10px 12px; }
  .cart-confirm .line { display:flex; align-items:center; justify-content:space-between; gap: 10px; }
  .cart-confirm .big { font-weight: 950; color: var(--ink); }
  .cart-confirm .sub { font-size:.86rem; color: var(--muted); margin-top: 2px; }
  .cart-confirm .price { font-variant-numeric: tabular-nums; font-weight: 950; }

  /* Price cell smaller / cleaner */
  .ac-price-big{ font-size: 1.1rem; font-weight: 950; letter-spacing:.2px; }
  .ac-price-sub{ font-size:.78rem; color: var(--muted); margin-top: .25rem; }
</style>

<div class="mb-6 flex items-start justify-between gap-3">
  <div class="min-w-0">
    <div class="flex items-center gap-2">
      <i class="ri-auction-line text-emerald-600 text-3xl"></i>
      <h1 class="text-2xl font-extrabold text-slate-900 truncate">
        Ki·ªÉm phi·∫øu tr√∫ng ƒë·∫•u gi√°
      </h1>
    </div>
    <p class="text-slate-500 text-sm mt-1">
      Ch·ªçn l√¥ ‚Üí nh·∫≠p gi√° cao nh·∫•t ‚Üí tick kh√°ch.
      <span class="font-semibold">1 tick ‚Üí TR√öNG</span>,
      <span class="font-semibold">‚â•2 tick ‚Üí V√≤ng ti·∫øp theo</span>.
      (Admin: hi·ªÉn th·ªã full CCCD/SƒêT)
    </p>
  </div>

  <div class="flex items-center gap-2 shrink-0">
    <a
      class="ac-btn ghost"
      id="btnProjector"
      href="{% if project_key %}/auction/counting/display?project={{ project_key|urlencode }}{% else %}#{% endif %}"
      target="_blank"
      {% if not project_key %}aria-disabled="true"{% endif %}
    >
      <i class="ri-slideshow-3-line"></i>
      Tr√¨nh chi·∫øu
    </a>
    <button class="ac-btn primary" id="btnReload" type="button">
      <i class="ri-refresh-line"></i>
      T·∫£i snapshot
    </button>
  </div>
</div>

<div class="ac-card p-5 mb-6">
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
    <div class="lg:col-span-2">
      <label class="text-sm font-bold text-slate-900">Ch·ªçn d·ª± √°n</label>
      <div class="mt-2 flex gap-2">
        <select id="projectSelect" class="ac-input">
          <option value="">‚Äî Ch·ªçn d·ª± √°n ‚Äî</option>
          {% for p in projects %}
            {% set code = (p.get("project_code") or p.get("code") or "") %}
            {% set pid = (p.get("id") or p.get("project_id") or "") %}
            {% set name = (p.get("name") or "") %}
            {% set st = (p.get("status") or "") %}
            {% set key = (code if code else pid|string) %}
            <option value="{{ key }}" {% if project_key and (project_key|string) == (key|string) %}selected{% endif %}>
              {{ code or ("#" ~ pid) }} ‚Äî {{ name }}{% if st %} ({{ st }}){% endif %}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="text-xs text-slate-500 mt-2">
        Dropdown g·ªìm c·∫£ ACTIVE v√† INACTIVE. N·∫øu ch·ªâ c√≥ 1 ACTIVE th√¨ h·ªá th·ªëng t·ª± ch·ªçn.
      </div>

      <div class="mt-4 flex flex-wrap items-center gap-2">
        <span class="ac-pill">
          <i class="ri-timer-2-line"></i>
          Phi√™n:
          <span class="ac-strong" id="pillSession">
            {% if session and session.get("id") %}
              #{{ session.get("id") }} ({{ session.get("status") or "COUNTING" }})
            {% else %}
              ‚Äî
            {% endif %}
          </span>
        </span>

        <span class="ac-pill">
          <i class="ri-stack-line"></i>
          T·ªïng l√¥:
          <span class="ac-strong" id="pillTotalLots">{{ total }}</span>
        </span>

        <span class="ac-pill green">
          <i class="ri-trophy-line"></i>
          WON:
          <span class="ac-strong" id="pillWon">‚Äî</span>
        </span>

        <span class="ac-pill orange">
          <i class="ri-user-shared-2-line"></i>
          TIED:
          <span class="ac-strong" id="pillTied">‚Äî</span>
        </span>

        <span class="ac-pill blue">
          <i class="ri-check-line"></i>
          ƒê√£ x·ª≠ l√Ω:
          <span class="ac-strong" id="pillChecked">‚Äî</span>
        </span>

        {# ‚úÖ Print for next round (two modes) #}
        <button
          class="ac-btn slim print"
          id="btnPrintTiedAll"
          type="button"
          {% if not project_id or not session or not session.get("id") %}disabled{% endif %}
          title="In phi·∫øu cho v√≤ng ti·∫øp theo theo th·ª© t·ª± L√¥ ‚Üí Kh√°ch"
        >
          <i class="ri-printer-line"></i>
          In Phi·∫øu (V√≤ng Ti·∫øp - Theo L√¥)
        </button>

        <button
          class="ac-btn slim print"
          id="btnPrintTiedAllByCustomer"
          type="button"
          {% if not project_id or not session or not session.get("id") %}disabled{% endif %}
          title="In phi·∫øu cho v√≤ng ti·∫øp theo theo th·ª© t·ª± Kh√°ch ‚Üí L√¥"
        >
          <i class="ri-printer-line"></i>
          In Phi·∫øu (V√≤ng Ti·∫øp - Theo Kh√°ch)
        </button>

      </div>
    </div>

    <div>
      <label class="text-sm font-bold text-slate-900">T√¨m l√¥</label>
      <div class="mt-2 flex gap-2">
        <input id="qInput" class="ac-input" placeholder="Nh·∫≠p m√£ l√¥..." value="{{ q }}" {% if not project_id %}disabled{% endif %} />
        <button class="ac-btn ghost" id="btnFilter" type="button" {% if not project_id %}disabled{% endif %}>
          <i class="ri-filter-3-line"></i> L·ªçc
        </button>
        <button class="ac-btn ghost" id="btnReset" type="button" {% if not project_id %}disabled{% endif %}>Reset</button>
      </div>
      {% if error %}
        <div class="mt-3 text-sm p-3 rounded-xl border border-red-200 bg-red-50 text-red-700">
          L·ªói t·∫£i danh s√°ch: ({{ error.status }}) {{ error.body }}
        </div>
      {% endif %}
      {% if session_err %}
        <div class="mt-3 text-sm p-3 rounded-xl border border-amber-200 bg-amber-50 text-amber-800">
          L·ªói t·∫°o phi√™n COUNTING: ({{ session_err.status }}) {{ session_err.body }}
        </div>
      {% endif %}
    </div>
  </div>
</div>

<div class="ac-card overflow-hidden">
  <div class="px-5 py-4 border-b border-slate-100 flex items-center justify-between gap-3">
    <div class="font-extrabold text-slate-900">Danh s√°ch l√¥</div>
    <div class="text-sm text-slate-500">B·∫•m <span class="font-bold">X·ª≠ l√Ω</span> ƒë·ªÉ nh·∫≠p k·∫øt qu·∫£.</div>
  </div>

  <div class="overflow-x-auto">
    <table class="ac-table">
      <thead>
        <tr>
          <th class="ac-th" style="width: 420px;">L√¥</th>
          <th class="ac-th" style="width: 190px;">Tr·∫°ng th√°i</th>
          <th class="ac-th" style="width: 220px;">Gi√° cao nh·∫•t</th>
          <th class="ac-th">Ng∆∞·ªùi tr√∫ng / V√≤ng ti·∫øp theo (n·∫øu c√≥)</th>
          <th class="ac-th" style="width: 140px; text-align:right;">Thao t√°c</th>
        </tr>
      </thead>
      <tbody id="lotsTbody">
        {% for r in rows %}
          {% set lot_code = r.get("lot_code") or "" %}
          {% set lot_id = r.get("lot_id") or r.get("id") %}
          {% set st = (r.get("counting_status") or "PENDING") %}
          {% set hp = r.get("highest_price_vnd") %}
          {% set is_draw = r.get("is_lucky_draw") %}
          {% set area = r.get("area") %}
          {% set sp = r.get("starting_price_vnd") %}
          {% set step = r.get("bid_step_vnd") %}
          {% set winner_id = r.get("winner_customer_id") or r.get("winner_id") %}
          {% set tied_ids = r.get("tied_customer_ids") or r.get("tied_ids") or [] %}
          <tr class="ac-row"
              data-lot-code="{{ lot_code }}"
              data-lot-id="{{ lot_id }}"
              data-lot-name="{{ (r.get('lot_name') or r.get('name') or '')|e }}"
              data-starting-price="{{ sp if sp is not none else '' }}"
              data-area="{{ area if area is not none else '' }}"
              data-bid-step="{{ step if step is not none else '' }}"
              data-counting-status="{{ st }}"
              data-highest-price="{{ hp if hp is not none else '' }}"
              data-is-draw="{{ '1' if is_draw else '0' }}"
              data-winner-id="{{ winner_id if winner_id is not none else '' }}"
              data-tied-ids='{{ tied_ids|tojson }}'
          >
            <td class="ac-td">
              <div class="lot-cell">
                <div class="lot-code">{{ lot_code }}</div>
                <div class="lot-sub">
                  <span><b>ID</b>: {{ lot_id }}</span>
                  <span>¬∑</span>
                  <span><b>KL</b>: <span class="ac-mono jsMoney" data-value="{{ sp if sp is not none else '' }}">‚Äî</span></span>
                  <span>¬∑</span>
                  <span><b>DT</b>: <span class="ac-mono jsArea" data-value="{{ area if area is not none else '' }}">‚Äî</span></span>
                  <span>¬∑</span>
                  <span><b>B∆∞·ªõc</b>: <span class="ac-mono jsMoney" data-value="{{ step if step is not none else '' }}">‚Äî</span></span>
                </div>
                <div class="lot-sub">
                  <span><b>KL/m¬≤</b>: <span class="ac-mono jsStartPerSqm">‚Äî</span></span>
                </div>
              </div>
            </td>

            <td class="ac-td">
              <div class="jsStatusPill">
                {% if st == 'WON' %}
                  <span class="ac-badge won"><i class="ri-trophy-line"></i> WON</span>
                {% elif st == 'TIED' %}
                  <span class="ac-badge tied"><i class="ri-user-shared-2-line"></i> TIED</span>
                {% else %}
                  <span class="ac-badge pending"><i class="ri-time-line"></i> PENDING</span>
                {% endif %}
              </div>
              <div class="text-xs ac-muted mt-2 jsMetaBy">
                {% if r.get("set_by") or r.get("edited_by") %}
                  Ng∆∞·ªùi nh·∫≠p: <span class="font-semibold">{{ r.get("set_by") or r.get("edited_by") }}</span>
                {% endif %}
              </div>
              <div class="text-xs ac-muted jsMetaAt">
                {% if r.get("set_at") %}
                  Th·ªùi ƒëi·ªÉm: <span class="font-semibold jsTime" data-iso="{{ r.get('set_at') }}">{{ r.get("set_at") }}</span>
                {% endif %}
              </div>
            </td>

            <td class="ac-td">
              <div class="ac-price-big ac-mono jsMoney jsHpCell" data-value="{{ hp if hp is not none else '' }}">‚Äî</div>
              <div class="ac-price-sub jsDrawNote">
                {% if st == 'WON' %}
                  {% if is_draw %}B·ªëc thƒÉm{% else %}Kh√¥ng b·ªëc thƒÉm{% endif %}
                {% endif %}
              </div>
            </td>

            <td class="ac-td">
              <div class="jsWinnerCell text-sm">
                {% if st == "TIED" %}
                  {% set n = (tied_ids|length) if tied_ids is iterable else 0 %}
                  <span class="ac-badge tied"><i class="ri-focus-2-line"></i> V√≤ng ti·∫øp theo</span>
                  <div class="text-sm text-slate-500 mt-1 flex items-center gap-2">
                    <span>{{ n }} kh√°ch</span>
                    <a
                      class="ac-mini-print jsPrintTiedLot"
                      href="#"
                      data-only-lot-id="{{ lot_id }}"
                      title="In phi·∫øu cho c√°c kh√°ch TIED c·ªßa l√¥ n√†y"
                      target="_blank"
                      rel="noopener"
                    >
                      <i class="ri-printer-line"></i>
                    </a>
                  </div>
                {% else %}
                  <span class="ac-muted">‚Äî</span>
                {% endif %}
              </div>
            </td>

            <td class="ac-td" style="text-align:right;">
              <button class="ac-btn ghost jsHandleBtn" type="button" {% if not project_id or not session or not session.get("id") %}disabled{% endif %}>
                <i class="ri-edit-2-line"></i> X·ª≠ l√Ω
              </button>
            </td>
          </tr>
        {% endfor %}
        {% if rows|length == 0 %}
          <tr>
            <td class="ac-td" colspan="5">
              <div class="text-slate-500 text-sm">Ch∆∞a c√≥ d·ªØ li·ªáu. H√£y ch·ªçn d·ª± √°n.</div>
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

{# =========================
   MODAL: EDIT LOT RESULT
   ========================= #}
<div class="ac-modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="ac-modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="ac-modal-header">
      <div class="min-w-0">
        <div class="text-xs font-extrabold text-slate-500 uppercase">X·ª≠ l√Ω k·∫øt qu·∫£</div>
        <div id="modalTitle" class="text-xl font-extrabold text-slate-900 truncate">‚Äî</div>
        <div id="modalSub" class="text-sm text-slate-500 mt-1 truncate">‚Äî</div>
      </div>
      <button class="ac-btn ghost" type="button" id="btnModalClose" aria-label="Close">
        <i class="ri-close-line text-xl"></i>
      </button>
    </div>

    <div class="ac-modal-body">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">

        <div class="lg:col-span-5 ac-card p-4">
          <div class="flex items-center justify-between gap-2">
            <div class="font-extrabold text-slate-900">Nh·∫≠p k·∫øt qu·∫£</div>
            <div class="text-xs text-slate-500 font-bold">(Smart tr·∫°ng th√°i theo s·ªë tick)</div>
          </div>

          <input type="hidden" id="inpStatus" value="PENDING"/>

          <div class="mt-4 p-4 rounded-2xl border border-slate-200 bg-slate-50">
            <div class="flex items-center justify-between gap-2">
              <div class="font-extrabold text-slate-900">Gi√° cao nh·∫•t (ƒë·ªÉ x√©t)</div>
              <div class="text-xs text-slate-500">N√∫t <span class="ac-kbd">+/-</span> theo b∆∞·ªõc gi√°</div>
            </div>

            <div class="ac-input-wrap mt-3">
              <input id="inpHighest" class="ac-input text-lg font-extrabold ac-mono" inputmode="numeric" placeholder="Nh·∫≠p gi√°..." />
              <button type="button" class="ac-input-inbtn" id="btnAutoCorrect" title="Correct gi√° hi·ªán t·∫°i theo b∆∞·ªõc gi√°; n·∫øu c√≥ gi√° ghi tr√™n phi·∫øu th√¨ kh√¥ng v∆∞·ª£t qu√°">
                <i class="ri-magic-line"></i> Auto correct
              </button>
            </div>

            <div class="text-xs text-slate-500 mt-2">
              Auto-correct s·∫Ω <b>ch·ªânh ƒë√∫ng gi√° ƒëang n·∫±m trong √¥</b> theo b∆∞·ªõc gi√°.
              N·∫øu c√°c kh√°ch ƒëang tick c√≥ <b>gi√° ghi tr√™n phi·∫øu</b> th√¨ s·∫Ω ƒë·∫£m b·∫£o <b>kh√¥ng v∆∞·ª£t qu√°</b> m·ª©c ƒë√≥.
            </div>

            <div class="ac-quick">
              <button type="button" class="ac-btn ghost jsStepBtn" data-step="-5">-5</button>
              <button type="button" class="ac-btn ghost jsStepBtn" data-step="-2">-2</button>
              <button type="button" class="ac-btn ghost jsStepBtn" data-step="-1">-1</button>
              <button type="button" class="ac-btn ghost jsStepBtn" data-step="1">+1</button>
              <button type="button" class="ac-btn ghost jsStepBtn" data-step="2">+2</button>
              <button type="button" class="ac-btn ghost jsStepBtn" data-step="5">+5</button>
            </div>

            <div class="text-xs text-slate-500 mt-3">
              N·∫øu ch∆∞a nh·∫≠p gi√°, b·∫•m <b>+1</b> s·∫Ω l·∫•y <b>gi√° kh·ªüi ƒëi·ªÉm</b> l√†m base r·ªìi c·ªông theo <b>b∆∞·ªõc gi√°</b>.
            </div>
          </div>

          <div class="mt-4 ac-card p-4" style="background: rgba(248,250,252,1);">
            <div class="font-extrabold text-slate-900">T√≥m t·∫Øt</div>
            <div class="text-sm text-slate-700 mt-1" id="selSummary">‚Äî</div>
          </div>
        </div>

        <div class="lg:col-span-7 ac-card p-4">
          <div class="flex items-start justify-between gap-2">
            <div>
              <div class="font-extrabold text-slate-900">Kh√°ch ƒë·ªß ƒëi·ªÅu ki·ªán</div>
              <div class="text-sm text-slate-500" id="candHint">Tick kh√°ch ƒë·ªÉ ƒë∆∞a v√†o danh s√°ch ch·ªçn.</div>
            </div>
            <div class="text-sm text-slate-500" id="candCount">T·ªïng: ‚Äî</div>
          </div>

          <div class="mt-3 grid grid-cols-1 lg:grid-cols-12 gap-3">
            <div class="lg:col-span-7">
              <input id="candSearch" class="ac-input" placeholder="T√¨m theo t√™n/CCCD/phone..." />
              <div class="mt-3 space-y-2" id="candList">
                <div class="text-sm text-slate-500">ƒêang t·∫£i...</div>
              </div>
            </div>

            <div class="lg:col-span-5">
              <div class="ac-cart">
                <div class="flex items-center justify-between gap-2">
                  <div class="font-extrabold text-slate-900">Th√¥ng tin ƒëang ch·ªçn</div>
                  <div class="text-xs text-slate-500 font-bold" id="cartCount">0</div>
                </div>
                <div class="text-xs text-slate-500 mt-1">
                  1 ng∆∞·ªùi ‚Üí TR√öNG ¬∑ ‚â•2 ng∆∞·ªùi ‚Üí V√≤ng ti·∫øp theo
                </div>

                <div class="mt-3 cart-confirm" id="cartConfirmBox">
                  <div class="line">
                    <div class="big" id="cartStateLine">‚Äî</div>
                    <div class="ac-badge pending" id="cartStateBadge"><i class="ri-time-line"></i> PENDING</div>
                  </div>
                  <div class="sub mt-2">
                    Gi√° h·ª£p l·ªá cao nh·∫•t:
                    <span class="price" id="cartHighestPrice">‚Äî</span>
                  </div>

                  <div class="mt-3" id="cartLuckyWrap" style="display:none;">
                    <label class="inline-flex items-start gap-3 cursor-pointer select-none">
                      <input id="inpLuckyDraw" type="checkbox" class="mt-1" />
                      <span>
                        <div class="font-extrabold text-slate-900">WON n√†y l√† do b·ªëc thƒÉm (is_lucky_draw)</div>
                        <div class="text-sm text-slate-500">Ch·ªâ d√πng khi ƒëang ch·ªçn ƒë√∫ng 1 ng∆∞·ªùi.</div>
                      </span>
                    </label>
                  </div>
                </div>

                <div class="mt-3" id="cartList">
                  <div class="text-sm text-slate-500">Ch∆∞a ch·ªçn kh√°ch.</div>
                </div>

                <div class="mt-3 grid grid-cols-1 gap-2">
                  <button type="button" class="ac-btn ghost w-full" id="btnClearCart" style="border-radius:14px;">
                    <i class="ri-delete-bin-6-line"></i> Xo√° to√†n b·ªô l·ª±a ch·ªçn
                  </button>

                  <button type="button" class="ac-btn primary w-full" id="btnCartConfirm" style="border-radius:14px;">
                    <i class="ri-check-line"></i> X√°c nh·∫≠n
                  </button>
                  <div class="text-xs text-slate-500">
                    (0 ch·ªçn ‚Üí kh√¥ng cho x√°c nh·∫≠n)
                  </div>
                </div>
              </div>

              <div class="mt-3 text-xs text-slate-500">
                Tip: t√¨m t√™n r·ªìi tick ‚Äî danh s√°ch ch·ªçn s·∫Ω n·∫±m c·ªë ƒë·ªãnh ·ªü ‚ÄúTh√¥ng tin ƒëang ch·ªçn‚Äù.
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div class="ac-modal-footer">
      <button class="ac-btn ghost" type="button" id="btnModalCancel">ƒê√≥ng</button>
    </div>
  </div>
</div>

{# =========================
   CONFIRM MODAL
   ========================= #}
<div class="ac-modal-backdrop" id="confirmBackdrop" aria-hidden="true">
  <div class="ac-modal" style="max-width: 720px;">
    <div class="ac-modal-header">
      <div>
        <div class="text-xs font-extrabold text-slate-500 uppercase">X√°c nh·∫≠n l∆∞u</div>
        <div class="text-xl font-extrabold text-slate-900">B·∫°n ch·∫Øc ch·∫Øn mu·ªën l∆∞u k·∫øt qu·∫£?</div>
        <div class="text-sm text-slate-500 mt-1">Ki·ªÉm tra nhanh tr∆∞·ªõc khi x√°c nh·∫≠n.</div>
      </div>
      <button class="ac-btn ghost" type="button" id="btnConfirmClose" aria-label="Close">
        <i class="ri-close-line text-xl"></i>
      </button>
    </div>

    <div class="ac-modal-body">
      <div class="ac-card p-4">
        <div class="text-sm text-slate-500">T√≥m t·∫Øt</div>
        <div id="confirmSummary" class="mt-2 text-slate-900 font-semibold"></div>
      </div>
      <div class="ac-card p-4 mt-3">
        <div class="text-sm text-slate-500">Chi ti·∫øt</div>
        <div id="confirmDetail" class="mt-2 text-sm text-slate-700 whitespace-pre-wrap"></div>
      </div>
    </div>

    <div class="ac-modal-footer">
      <button class="ac-btn ghost" type="button" id="btnConfirmCancel">H·ªßy</button>
      <button class="ac-btn primary" type="button" id="btnConfirmOk">
        <i class="ri-check-line"></i> X√°c nh·∫≠n
      </button>
    </div>
  </div>
</div>

<div class="ac-toast" id="toastHost"></div>

<script>
(() => {
  const PROJECT_ID = {{ project_id or "null" }};
  const SESSION_ID = {{ (session.get("id") if session else None) or "null" }};
  const AUCTION_MODE = {{ (auction_mode|tojson) }};

  const fmtVND = (n) => {
    const x = Number(n);
    if (!isFinite(x)) return "‚Äî";
    return new Intl.NumberFormat("vi-VN", { maximumFractionDigits: 0 }).format(Math.round(x));
  };
  const fmtArea = (n) => {
    const x = Number(n);
    if (!isFinite(x)) return "‚Äî";
    return new Intl.NumberFormat("vi-VN", { maximumFractionDigits: 1 }).format(x) + " m¬≤";
  };
  const safeText = (s) => (s == null ? "" : String(s));

  const toastHost = document.getElementById("toastHost");
  function toast(type, title, msg) {
    const el = document.createElement("div");
    el.className = "ac-toast-item " + (type === "err" ? "err" : "ok");
    el.innerHTML = `<div class="t">${title}</div><div class="text-sm text-slate-700">${msg}</div>`;
    toastHost.appendChild(el);
    setTimeout(() => { el.style.opacity = "0"; el.style.transform = "translateY(6px)"; }, 3500);
    setTimeout(() => { el.remove(); }, 4200);
  }

  const projectSelect = document.getElementById("projectSelect");
  const qInput = document.getElementById("qInput");
  const btnFilter = document.getElementById("btnFilter");
  const btnReset = document.getElementById("btnReset");
  const btnReload = document.getElementById("btnReload");
  const btnProjector = document.getElementById("btnProjector");

  // ‚úÖ NEW: print buttons
  const btnPrintTiedAll = document.getElementById("btnPrintTiedAll");
  const btnPrintTiedAllByCustomer = document.getElementById("btnPrintTiedAllByCustomer");

  function openPrintTied(onlyLotId = null, sortType = "lot_customer") {
    if (!SESSION_ID) {
      toast("err", "Thi·∫øu phi√™n", "Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c session_id ƒë·ªÉ in.");
      return;
    }
    const u = new URL("/bid-tickets/print-tied", window.location.origin);
    u.searchParams.set("session_id", String(SESSION_ID));
    if (onlyLotId != null) u.searchParams.set("only_lot_id", String(onlyLotId));
    if (sortType) u.searchParams.set("sort_type", String(sortType));
    window.open(u.toString(), "_blank", "noopener");
  }

  // Theo L√¥ (default)
  btnPrintTiedAll?.addEventListener("click", () => openPrintTied(null, "lot_customer"));

  // Theo Kh√°ch
  btnPrintTiedAllByCustomer?.addEventListener("click", () => openPrintTied(null, "customer_lot"));


  // delegation for row print icons
  document.addEventListener("click", (e) => {
    const a = e.target?.closest?.(".jsPrintTiedLot");
    if (!a) return;
    e.preventDefault();
    const lotId = Number(a.getAttribute("data-only-lot-id") || 0);
    if (!lotId) return;
    openPrintTied(lotId);
  });

  function goWithParams(params) {
    const url = new URL(window.location.href);
    url.search = "";
    Object.entries(params).forEach(([k,v]) => {
      if (v !== undefined && v !== null && String(v).trim() !== "") url.searchParams.set(k, v);
    });
    window.location.href = url.toString();
  }

  projectSelect?.addEventListener("change", () => {
    const v = projectSelect.value;
    goWithParams({ project: v });
  });

  btnFilter?.addEventListener("click", () => {
    goWithParams({ project: projectSelect.value, q: qInput.value.trim() || "" });
  });

  qInput?.addEventListener("keydown", (e) => {
    if (e.key === "Enter") btnFilter.click();
  });

  btnReset?.addEventListener("click", () => {
    goWithParams({ project: projectSelect.value });
  });

  if (!projectSelect.value) {
    btnProjector?.setAttribute("aria-disabled", "true");
  } else {
    btnProjector.href = "/auction/counting/display?project=" + encodeURIComponent(projectSelect.value);
  }

  function renderRowBase() {
    document.querySelectorAll(".jsMoney").forEach(el => {
      const v = el.getAttribute("data-value");
      el.textContent = v ? fmtVND(v) : "‚Äî";
      el.classList.add("ac-mono");
    });
    document.querySelectorAll(".jsArea").forEach(el => {
      const v = el.getAttribute("data-value");
      el.textContent = v ? fmtArea(v) : "‚Äî";
      el.classList.add("ac-mono");
    });

    document.querySelectorAll("#lotsTbody tr[data-lot-code]").forEach(tr => {
      const sp = Number(tr.getAttribute("data-starting-price"));
      const area = Number(tr.getAttribute("data-area"));
      const spEl = tr.querySelector(".jsStartPerSqm");
      if (spEl) {
        if (isFinite(sp) && sp > 0 && isFinite(area) && area > 0) spEl.textContent = fmtVND(sp / area) + " VND/m¬≤";
        else spEl.textContent = "‚Äî";
      }
    });

    document.querySelectorAll(".jsTime").forEach(el => {
      const iso = el.getAttribute("data-iso");
      if (!iso) return;
      try {
        const d = new Date(iso);
        if (isNaN(d.getTime())) return;
        const t = d.toLocaleTimeString("vi-VN", { hour: "2-digit", minute: "2-digit" });
        const dd = d.toLocaleDateString("vi-VN");
        el.textContent = t + " ¬∑ " + dd;
      } catch {}
    });
  }
  renderRowBase();

  async function loadSnapshotAndApply() {
    if (!PROJECT_ID || !SESSION_ID) return;
    try {
      const url = new URL("/auction/counting/api/display/snapshot", window.location.origin);
      url.searchParams.set("project_id", String(PROJECT_ID));
      url.searchParams.set("session_id", String(SESSION_ID));
      const r = await fetch(url.toString(), { credentials: "include" });
      const js = await r.json();
      if (!r.ok || !js || js.ok !== true) throw new Error(js?.detail || "snapshot error");

      const sum = js.summary || {};
      document.getElementById("pillWon").textContent = sum.won ?? "‚Äî";
      document.getElementById("pillTied").textContent = sum.tied ?? "‚Äî";
      document.getElementById("pillChecked").textContent = sum.checked ?? "‚Äî";

      // enable/disable print all tied
      const canPrint = !!(SESSION_ID && (sum.tied ?? 0) > 0);
      if (btnPrintTiedAll) btnPrintTiedAll.disabled = !canPrint;
      if (btnPrintTiedAllByCustomer) btnPrintTiedAllByCustomer.disabled = !canPrint;


      const winners = js.winners || [];
      const winMap = new Map();
      winners.forEach(w => {
        if (w?.lot_code) winMap.set(String(w.lot_code).toLowerCase(), w);
      });

      document.querySelectorAll("#lotsTbody tr[data-lot-code]").forEach(tr => {
        const lc = String(tr.getAttribute("data-lot-code") || "").toLowerCase();
        const cell = tr.querySelector(".jsWinnerCell");
        if (!cell) return;

        const st = String(tr.getAttribute("data-counting-status") || "PENDING").toUpperCase();
        const w = winMap.get(lc);

        if (!w) {
          if (st === "TIED") {
            let ids = [];
            try { ids = JSON.parse(tr.getAttribute("data-tied-ids") || "[]") || []; } catch {}
            const n = Array.isArray(ids) ? ids.length : 0;
            const lotId = Number(tr.getAttribute("data-lot-id") || 0);

            cell.innerHTML = `
              <span class="ac-badge tied"><i class="ri-focus-2-line"></i> V√≤ng ti·∫øp theo</span>
              <div class="text-sm text-slate-500 mt-1 flex items-center gap-2">
                <span>${n ? (n + " kh√°ch") : "‚Äî"}</span>
                ${lotId ? `
                  <a class="ac-mini-print jsPrintTiedLot"
                     href="#"
                     data-only-lot-id="${lotId}"
                     title="In phi·∫øu cho c√°c kh√°ch TIED c·ªßa l√¥ n√†y"
                     target="_blank" rel="noopener">
                    <i class="ri-printer-line"></i>
                  </a>` : ``}
              </div>`;
          } else {
            cell.innerHTML = `<span class="ac-muted">‚Äî</span>`;
          }
          return;
        }

        const name = safeText(w.full_name || w.name || "");
        const cccd = safeText(w.cccd || "");
        const phone = safeText(w.phone || "");
        const meta = [];
        if (cccd) meta.push(`CCCD: <span class="font-semibold">${cccd}</span>`);
        if (phone) meta.push(`Phone: <span class="font-semibold">${phone}</span>`);
        cell.innerHTML = `
          <div class="font-extrabold text-slate-900">${name || "(Kh√¥ng t√™n)"}</div>
          <div class="text-sm text-slate-500">${meta.join(" ¬∑ ")}</div>
        `;
      });

    } catch (e) {
      console.warn(e);
    }
  }

  loadSnapshotAndApply();

  btnReload?.addEventListener("click", async () => {
    await loadSnapshotAndApply();
    toast("ok", "ƒê√£ t·∫£i snapshot", "ƒê√£ c·∫≠p nh·∫≠t ng∆∞·ªùi tr√∫ng & th·ªëng k√™ (kh√¥ng reload trang).");
  });

  const modalBackdrop = document.getElementById("modalBackdrop");
  const btnModalClose = document.getElementById("btnModalClose");
  const btnModalCancel = document.getElementById("btnModalCancel");

  const inpStatus = document.getElementById("inpStatus");
  const inpHighest = document.getElementById("inpHighest");
  const inpLuckyDraw = document.getElementById("inpLuckyDraw");
  const btnAutoCorrect = document.getElementById("btnAutoCorrect");

  const candHint = document.getElementById("candHint");
  const candCount = document.getElementById("candCount");
  const candSearch = document.getElementById("candSearch");
  const candList = document.getElementById("candList");

  const cartCount = document.getElementById("cartCount");
  const cartList = document.getElementById("cartList");
  const btnClearCart = document.getElementById("btnClearCart");
  const btnCartConfirm = document.getElementById("btnCartConfirm");

  const cartStateLine = document.getElementById("cartStateLine");
  const cartStateBadge = document.getElementById("cartStateBadge");
  const cartHighestPrice = document.getElementById("cartHighestPrice");
  const cartLuckyWrap = document.getElementById("cartLuckyWrap");

  const selSummary = document.getElementById("selSummary");

  const confirmBackdrop = document.getElementById("confirmBackdrop");
  const btnConfirmClose = document.getElementById("btnConfirmClose");
  const btnConfirmCancel = document.getElementById("btnConfirmCancel");
  const btnConfirmOk = document.getElementById("btnConfirmOk");
  const confirmSummary = document.getElementById("confirmSummary");
  const confirmDetail = document.getElementById("confirmDetail");

  let activeLot = null;
  let activeTr = null;
  let candidates = [];
  let selectedIds = new Set();

  function openModal() {
    modalBackdrop.style.display = "flex";
    modalBackdrop.setAttribute("aria-hidden", "false");
    document.body.style.overflow = "hidden";
  }
  function closeModal() {
    modalBackdrop.style.display = "none";
    modalBackdrop.setAttribute("aria-hidden", "true");
    document.body.style.overflow = "";
    activeLot = null;
    activeTr = null;
    candidates = [];
    selectedIds = new Set();
    inpLuckyDraw.checked = false;
    cartLuckyWrap.style.display = "none";
    inpStatus.value = "PENDING";
  }

  function openConfirm() {
    confirmBackdrop.style.display = "flex";
    confirmBackdrop.setAttribute("aria-hidden", "false");
    document.body.style.overflow = "hidden";
  }
  function closeConfirm() {
    confirmBackdrop.style.display = "none";
    confirmBackdrop.setAttribute("aria-hidden", "true");
  }

  btnModalClose?.addEventListener("click", closeModal);
  btnModalCancel?.addEventListener("click", closeModal);
  modalBackdrop?.addEventListener("click", (e) => {
    if (e.target === modalBackdrop) closeModal();
  });

  btnConfirmClose?.addEventListener("click", closeConfirm);
  btnConfirmCancel?.addEventListener("click", closeConfirm);
  confirmBackdrop?.addEventListener("click", (e) => {
    if (e.target === confirmBackdrop) closeConfirm();
  });

  function digitsOnly(s) { return (s || "").replace(/[^\d]/g, ""); }
  function parseMoney(s) {
    const d = digitsOnly(s);
    if (!d) return null;
    const n = Number(d);
    return isFinite(n) ? n : null;
  }
  function setMoneyInput(el, n) {
    if (n == null || !isFinite(n)) { el.value = ""; return; }
    el.value = fmtVND(n);
  }

  inpHighest?.addEventListener("input", () => {
    const n = parseMoney(inpHighest.value);
    if (n == null) { refreshCartConfirm(); refreshSummary(); return; }
    const s = fmtVND(n);
    inpHighest.value = s;
    try { inpHighest.setSelectionRange(s.length, s.length); } catch {}
    refreshCartConfirm();
    refreshSummary();
  });

  document.querySelectorAll(".jsStepBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      if (!activeLot) return;
      const stepMul = Number(btn.getAttribute("data-step") || "0");
      if (!stepMul) return;

      const bidStep = Number(activeLot.bid_step || 0);
      const basePrice = Number(activeLot.base_start || 0);
      if (!isFinite(bidStep) || bidStep <= 0) {
        toast("err", "Thi·∫øu b∆∞·ªõc gi√°", "L√¥ n√†y ch∆∞a c√≥ bid_step_vnd ho·∫∑c b∆∞·ªõc gi√° kh√¥ng h·ª£p l·ªá.");
        return;
      }

      let cur = parseMoney(inpHighest.value);
      if (cur == null) cur = basePrice;
      const next = cur + stepMul * bidStep;
      setMoneyInput(inpHighest, Math.max(next, 0));
      refreshCartConfirm();
      refreshSummary();
    });
  });

  btnClearCart?.addEventListener("click", () => {
    selectedIds = new Set();
    inpLuckyDraw.checked = false;
    cartLuckyWrap.style.display = "none";
    renderCandidates();
    renderCart();
    applySmartStatus();
  });

  function applySmartStatus() {
    const n = selectedIds.size;
    if (n === 1) inpStatus.value = "WON";
    else if (n >= 2) inpStatus.value = "TIED";
    else inpStatus.value = "PENDING";

    if (n === 1) cartLuckyWrap.style.display = "block";
    else {
      cartLuckyWrap.style.display = "none";
      inpLuckyDraw.checked = false;
    }
    refreshCartConfirm();
    refreshSummary();
  }

  function normalizeStr(s) {
    return (s || "").toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  }

  function candidateById(id) {
    const map = new Map();
    candidates.forEach(c => map.set(Number(c.customer_id || c.id), c));
    return map.get(Number(id));
  }

  function renderCart() {
    const ids = Array.from(selectedIds);
    cartCount.textContent = String(ids.length);

    if (!ids.length) {
      cartList.innerHTML = `<div class="text-sm text-slate-500">Ch∆∞a ch·ªçn kh√°ch.</div>`;
      btnCartConfirm.disabled = true;
      refreshCartConfirm();
      refreshSummary();
      return;
    }

    btnCartConfirm.disabled = false;

    const rows = ids.map(id => {
      const c = candidateById(id) || {};
      const name = safeText(c.full_name || "");
      const cccd = safeText(c.cccd || "");
      const phone = safeText(c.phone || "");
      return `
        <div class="item" data-id="${id}">
          <div class="min-w-0">
            <div class="font-extrabold text-slate-900 leading-tight">${name || "(Kh√¥ng t√™n)"}</div>
            <div class="text-xs text-slate-500 mt-1">
              <span class="tag">#${id}</span>
              ${cccd ? `<span class="ml-2">CCCD: <b class="text-slate-700">${cccd}</b></span>` : ""}
              ${phone ? `<span class="ml-2">Phone: <b class="text-slate-700">${phone}</b></span>` : ""}
            </div>
          </div>
          <button type="button" class="rm" title="B·ªè kh·ªèi danh s√°ch">‚úï</button>
        </div>
      `;
    }).join("");

    cartList.innerHTML = rows;

    cartList.querySelectorAll(".item .rm").forEach(btn => {
      btn.addEventListener("click", () => {
        const item = btn.closest(".item");
        const id = Number(item?.getAttribute("data-id"));
        if (!id) return;
        selectedIds.delete(id);
        renderCandidates();
        renderCart();
        applySmartStatus();
      });
    });

    refreshCartConfirm();
    refreshSummary();
  }

  function renderCandidates() {
    const q = normalizeStr(candSearch.value || "");
    const list = candidates.filter(c => {
      if (!q) return true;
      const hay = normalizeStr((c.full_name || "") + " " + (c.cccd || "") + " " + (c.phone || "") + " " + (c.email || ""));
      return hay.includes(q);
    });

    candList.innerHTML = "";
    if (!list.length) {
      candList.innerHTML = `<div class="text-sm text-slate-500">Kh√¥ng c√≥ kh√°ch ph√π h·ª£p.</div>`;
      return;
    }

    list.forEach(c => {
      const cid = Number(c.customer_id || c.id);
      const name = safeText(c.full_name || "");
      const cccd = safeText(c.cccd || "");
      const phone = safeText(c.phone || "");
      const checked = selectedIds.has(cid);

      const card = document.createElement("div");
      card.className = "ac-customer";
      card.innerHTML = `
        <label class="flex items-start gap-3 w-full cursor-pointer">
          <input type="checkbox" ${checked ? "checked" : ""} class="mt-1" />
          <div class="min-w-0">
            <div class="font-extrabold text-slate-900 truncate">${name || "(Kh√¥ng t√™n)"}</div>
            <div class="meta">
              ${cccd ? `CCCD: <span class="font-semibold">${cccd}</span>` : ""}
              ${phone ? ` ¬∑ Phone: <span class="font-semibold">${phone}</span>` : ""}
            </div>
          </div>
        </label>
        <div class="text-sm font-extrabold text-slate-400">#${cid || "‚Äî"}</div>
      `;

      const input = card.querySelector("input");
      input.addEventListener("change", () => {
        if (input.checked) selectedIds.add(cid);
        else selectedIds.delete(cid);

        renderCandidates();
        renderCart();
        applySmartStatus();
      });

      candList.appendChild(card);
    });
  }

  candSearch?.addEventListener("input", () => renderCandidates());

  function refreshCartConfirm() {
    const hp = parseMoney(inpHighest.value);
    cartHighestPrice.textContent = (hp != null ? fmtVND(hp) : "‚Äî");

    const n = selectedIds.size;

    if (n === 1) {
      cartStateLine.textContent = "üèÜ TR√öNG (1 ng∆∞·ªùi)";
      cartStateBadge.className = "ac-badge won";
      cartStateBadge.innerHTML = `<i class="ri-trophy-line"></i> WON`;
    } else if (n >= 2) {
      cartStateLine.textContent = "üéØ V√íNG TI·∫æP THEO (" + n + " ng∆∞·ªùi)";
      cartStateBadge.className = "ac-badge tied";
      cartStateBadge.innerHTML = `<i class="ri-focus-2-line"></i> TIED`;
    } else {
      cartStateLine.textContent = "‚è≥ CH∆ØA CH·ªåN NG∆Ø·ªúI";
      cartStateBadge.className = "ac-badge pending";
      cartStateBadge.innerHTML = `<i class="ri-time-line"></i> PENDING`;
    }
  }

  function refreshSummary() {
    const hp = parseMoney(inpHighest.value);
    const draw = !!inpLuckyDraw.checked;
    const picks = Array.from(selectedIds);
    const hpText = (hp != null ? fmtVND(hp) : "‚Äî");

    if (picks.length === 0) {
      selSummary.innerHTML = `<span class="ac-badge pending"><i class="ri-time-line"></i> PENDING</span> ¬∑ Ch∆∞a ch·ªçn kh√°ch ¬∑ Gi√°: <b>${hpText}</b>`;
      candHint.textContent = "Tick kh√°ch ƒë·ªÉ ƒë∆∞a v√†o danh s√°ch ch·ªçn.";
      return;
    }

    if (picks.length === 1) {
      selSummary.innerHTML = `<span class="ac-badge won"><i class="ri-trophy-line"></i> WON</span> ¬∑ #${picks[0]} ¬∑ Gi√°: <b>${hpText}</b> ¬∑ is_lucky_draw: <b>${draw ? "C√≥" : "Kh√¥ng"}</b>`;
      candHint.textContent = "ƒêang ch·ªçn 1 kh√°ch ‚Üí h·ªá th·ªëng hi·ªÉu TR√öNG.";
      return;
    }

    selSummary.innerHTML = `<span class="ac-badge tied"><i class="ri-focus-2-line"></i> TIED</span> ¬∑ ${picks.length} kh√°ch ‚Üí V√≤ng ti·∫øp theo ¬∑ Gi√°: <b>${hpText}</b>`;
    candHint.textContent = "ƒêang ch·ªçn ‚â•2 kh√°ch ‚Üí h·ªá th·ªëng hi·ªÉu v√†o v√≤ng ti·∫øp theo.";
  }

  async function loadCandidates(lot_code) {
    candList.innerHTML = `<div class="text-sm text-slate-500">ƒêang t·∫£i...</div>`;
    candCount.textContent = "T·ªïng: ‚Äî";
    candidates = [];
    try {
      const url = new URL(`/auction/counting/api/projects/${PROJECT_ID}/lots/${encodeURIComponent(lot_code)}/eligible-customers`, window.location.origin);
      url.searchParams.set("include_unpaid", "false");
      url.searchParams.set("limit", "5000");
      const r = await fetch(url.toString(), { credentials: "include" });
      const js = await r.json();
      if (!r.ok || !js || js.ok !== true) throw new Error(js?.detail || "load candidates error");
      candidates = js.data || [];
      candCount.textContent = "T·ªïng: " + candidates.length;

      renderCandidates();
      renderCart();
      applySmartStatus();

    } catch (e) {
      console.warn(e);
      candList.innerHTML = `<div class="text-sm text-red-700">Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch kh√°ch.</div>`;
      toast("err", "L·ªói t·∫£i danh s√°ch", "Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch kh√°ch ƒë·ªß ƒëi·ªÅu ki·ªán.");
    }
  }

  function parseJsonSafe(s, fallback) {
    try { return JSON.parse(s); } catch { return fallback; }
  }

  // =========================
  // ‚úÖ AUTO CORRECT (FIXED)
  // =========================
  function _num(v) {
    const n = Number(v);
    return isFinite(n) ? n : null;
  }

  function getTicketMaxPrice(c) {
    const keys = [
      "ticket_price_vnd", "wrote_price_vnd", "written_price_vnd",
      "max_price_vnd", "bid_price_vnd", "bid_price", "price_vnd",
      "max_price", "price"
    ];
    for (const k of keys) {
      if (c && c[k] != null && c[k] !== "") {
        const n = _num(c[k]);
        if (n != null && n > 0) return n;
      }
    }
    return null;
  }

  function alignDownToStep(target, base, step) {
    const t = Number(target), b = Number(base), s = Number(step);
    if (!isFinite(t) || !isFinite(b) || !isFinite(s) || s <= 0) return null;
    if (t <= b) return b;
    const k = Math.floor((t - b) / s);
    return b + k * s;
  }

  btnAutoCorrect?.addEventListener("click", () => {
    if (!activeLot) {
      toast("err", "Ch∆∞a c√≥ l√¥", "H√£y b·∫•m ‚ÄúX·ª≠ l√Ω‚Äù m·ªôt l√¥ tr∆∞·ªõc.");
      return;
    }

    const bidStep = Number(activeLot.bid_step || 0);
    const base = Number(activeLot.base_start || 0);

    if (!isFinite(bidStep) || bidStep <= 0) {
      toast("err", "Thi·∫øu b∆∞·ªõc gi√°", "L√¥ n√†y ch∆∞a c√≥ bid_step_vnd ho·∫∑c b∆∞·ªõc gi√° kh√¥ng h·ª£p l·ªá.");
      return;
    }
    if (!isFinite(base) || base <= 0) {
      toast("err", "Thi·∫øu gi√° kh·ªüi ƒëi·ªÉm", "Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c gi√° kh·ªüi ƒëi·ªÉm (base) ƒë·ªÉ cƒÉn theo b∆∞·ªõc.");
      return;
    }

    let cur = parseMoney(inpHighest.value);
    if (cur == null) cur = base;

    let cap = null;
    if (selectedIds.size > 0) {
      const ids = Array.from(selectedIds);
      const caps = [];
      ids.forEach(id => {
        const c = candidateById(id) || {};
        const p = getTicketMaxPrice(c);
        if (p != null) caps.push(p);
      });
      if (caps.length) cap = Math.min(...caps);
    }

    const target = (cap != null && isFinite(cap) && cap > 0) ? Math.min(cur, cap) : cur;

    const corrected = alignDownToStep(target, base, bidStep);
    if (corrected == null) {
      toast("err", "Kh√¥ng th·ªÉ auto-correct", "Kh√¥ng t√¨m ƒë∆∞·ª£c m·ª©c gi√° h·ª£p l·ªá theo b∆∞·ªõc gi√° (ki·ªÉm tra base/step).");
      return;
    }

    setMoneyInput(inpHighest, corrected);
    refreshCartConfirm();
    refreshSummary();

    if (cap != null && isFinite(cap) && cap > 0) {
      toast("ok", "Auto correct xong", `ƒê√£ ƒë∆∞a v·ªÅ ${fmtVND(corrected)} (‚â§ gi√° ghi tr√™n phi·∫øu: ${fmtVND(cap)}).`);
    } else {
      toast("ok", "Auto correct xong", `ƒê√£ ƒë∆∞a v·ªÅ ${fmtVND(corrected)} theo base + b∆∞·ªõc gi√°.`);
    }
  });

  // =========================
  // Open modal + prefill selection
  // =========================
  document.querySelectorAll(".jsHandleBtn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const tr = btn.closest("tr[data-lot-code]");
      if (!tr) return;

      if (!PROJECT_ID || !SESSION_ID) {
        toast("err", "Ch∆∞a ch·ªçn d·ª± √°n", "Vui l√≤ng ch·ªçn d·ª± √°n tr∆∞·ªõc khi thao t√°c.");
        return;
      }

      const lot_code = tr.getAttribute("data-lot-code");
      const lot_id = tr.getAttribute("data-lot-id");
      const lot_name = tr.getAttribute("data-lot-name") || "";

      const starting_price = Number(tr.getAttribute("data-starting-price"));
      const area = Number(tr.getAttribute("data-area"));
      const bid_step = Number(tr.getAttribute("data-bid-step"));

      const baseStart = (() => {
        if (AUCTION_MODE === "PER_SQM" && isFinite(starting_price) && starting_price > 0 && isFinite(area) && area > 0) {
          return starting_price / area;
        }
        return isFinite(starting_price) ? starting_price : 0;
      })();

      activeLot = { lot_code, lot_id, lot_name, starting_price, area, bid_step, base_start: baseStart };
      activeTr = tr;

      document.getElementById("modalTitle").textContent = `L√¥ ${lot_code}`;
      const s1 = isFinite(starting_price) ? fmtVND(starting_price) : "‚Äî";
      const s2 = (AUCTION_MODE === "PER_SQM" && isFinite(baseStart) && baseStart > 0) ? (fmtVND(baseStart) + " VND/m¬≤") : "‚Äî";
      const sArea = isFinite(area) ? fmtArea(area) : "‚Äî";
      const sStep = isFinite(bid_step) ? fmtVND(bid_step) + " VND" : "‚Äî";
      document.getElementById("modalSub").textContent = `B∆∞·ªõc: ${sStep} ¬∑ KL: ${s1} ¬∑ DT: ${sArea} ¬∑ KL/m¬≤: ${s2}`;

      const curHighest = tr.getAttribute("data-highest-price");
      if (curHighest) setMoneyInput(inpHighest, Number(curHighest));
      else inpHighest.value = "";

      selectedIds = new Set();
      const winnerId = Number(tr.getAttribute("data-winner-id") || 0);
      const tiedIds = parseJsonSafe(tr.getAttribute("data-tied-ids") || "[]", []);
      const curStatus = String(tr.getAttribute("data-counting-status") || "PENDING").toUpperCase();

      if (curStatus === "WON" && winnerId) selectedIds.add(winnerId);
      else if (curStatus === "TIED" && Array.isArray(tiedIds)) tiedIds.forEach(x => selectedIds.add(Number(x)));

      const curDraw = tr.getAttribute("data-is-draw") === "1";
      inpLuckyDraw.checked = !!curDraw;

      openModal();
      await loadCandidates(lot_code);

      applySmartStatus();
      if (selectedIds.size !== 1) inpLuckyDraw.checked = false;

      refreshCartConfirm();
      refreshSummary();
    });
  });

  // =========================
  // Confirm + Save API (gi·ªØ nguy√™n)
  // =========================
  function pickCustomerObjects(ids) {
    const map = new Map();
    candidates.forEach(c => map.set(Number(c.customer_id || c.id), c));
    return ids.map(id => map.get(id)).filter(Boolean);
  }

  function validatePayload() {
    const hp = parseMoney(inpHighest.value);
    const draw = !!inpLuckyDraw.checked;

    if (!activeLot) return { ok:false, msg:"Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c l√¥ ƒëang x·ª≠ l√Ω." };
    if (selectedIds.size === 0) return { ok:false, msg:"B·∫°n ph·∫£i tick √≠t nh·∫•t 1 kh√°ch (0 tick kh√¥ng cho l∆∞u)." };
    if (hp == null || hp <= 0) return { ok:false, msg:"Vui l√≤ng nh·∫≠p Gi√° h·ª£p l·ªá cao nh·∫•t > 0." };

    if (selectedIds.size === 1) {
      const winnerId = Array.from(selectedIds)[0];
      return {
        ok: true,
        payload: {
          status: "WON",
          highest_price_vnd: hp,
          winner_customer_id: winnerId,
          is_lucky_draw: draw
        }
      };
    }

    return {
      ok: true,
      payload: {
        status: "TIED",
        highest_price_vnd: hp,
        tied_customer_ids: Array.from(selectedIds)
      }
    };
  }

  function confirmSummaryLine(lotCode, st, hp, draw, n) {
    if (st === "WON") return `üèÜ L√¥ ${lotCode} ¬∑ TR√öNG ¬∑ Gi√°: ${fmtVND(hp)} ¬∑ B·ªëc thƒÉm: ${draw ? "C√≥" : "Kh√¥ng"}`;
    return `üéØ L√¥ ${lotCode} ¬∑ V√≤ng ti·∫øp theo (${n} ng∆∞·ªùi) ¬∑ Gi√°: ${fmtVND(hp)}`;
  }

  let pendingConfirm = null;

  btnCartConfirm?.addEventListener("click", () => {
    const v = validatePayload();
    if (!v.ok) {
      toast("err", "Ch∆∞a h·ª£p l·ªá", v.msg || "Vui l√≤ng ki·ªÉm tra l·∫°i d·ªØ li·ªáu.");
      return;
    }

    const st = (v.payload.status || "").toUpperCase();
    const hp = Number(v.payload.highest_price_vnd || 0);
    const draw = !!v.payload.is_lucky_draw;

    const ids = Array.from(selectedIds);
    const picked = pickCustomerObjects(ids);

    const lotCode = activeLot?.lot_code || "‚Äî";
    confirmSummary.textContent = confirmSummaryLine(lotCode, st, hp, draw, ids.length);

    const detailLines = [];
    detailLines.push(`L√¥: ${lotCode}`);
    detailLines.push(`Gi√° kh·ªüi ƒëi·ªÉm (c·∫£ l√¥): ${isFinite(activeLot.starting_price) ? fmtVND(activeLot.starting_price) : "‚Äî"} VND`);
    detailLines.push(`Di·ªán t√≠ch: ${isFinite(activeLot.area) ? fmtArea(activeLot.area) : "‚Äî"}`);
    detailLines.push(`B∆∞·ªõc gi√°: ${isFinite(activeLot.bid_step) ? fmtVND(activeLot.bid_step) : "‚Äî"} VND`);
    detailLines.push(`Gi√° h·ª£p l·ªá cao nh·∫•t: ${fmtVND(hp)}${AUCTION_MODE === "PER_SQM" ? " (theo m¬≤)" : " (theo l√¥)"}`);

    if (st === "WON") {
      const c = picked[0] || {};
      detailLines.push(`K·∫øt qu·∫£: TR√öNG`);
      detailLines.push(`Ng∆∞·ªùi tr√∫ng: #${ids[0]} ¬∑ ${c.full_name || ""}${c.cccd ? " ¬∑ CCCD " + c.cccd : ""}${c.phone ? " ¬∑ " + c.phone : ""}`);
      detailLines.push(`B·ªëc thƒÉm: ${draw ? "C√≥" : "Kh√¥ng"}`);
    } else {
      detailLines.push(`K·∫øt qu·∫£: V√≤ng ti·∫øp theo`);
      detailLines.push(`Danh s√°ch (${ids.length}):`);
      picked.forEach(c => {
        const id = Number(c.customer_id || c.id);
        detailLines.push(`- #${id} ¬∑ ${c.full_name || ""}${c.cccd ? " ¬∑ " + c.cccd : ""}${c.phone ? " ¬∑ " + c.phone : ""}`);
      });
    }

    confirmDetail.textContent = detailLines.join("\n");
    pendingConfirm = v.payload;
    openConfirm();
  });

  function setStatusPill(tr, st) {
    const host = tr.querySelector(".jsStatusPill");
    if (!host) return;
    if (st === "WON") host.innerHTML = `<span class="ac-badge won"><i class="ri-trophy-line"></i> WON</span>`;
    else if (st === "TIED") host.innerHTML = `<span class="ac-badge tied"><i class="ri-focus-2-line"></i> TIED</span>`;
    else host.innerHTML = `<span class="ac-badge pending"><i class="ri-time-line"></i> PENDING</span>`;
  }

  function setDrawNote(tr, st, isDraw) {
    const note = tr.querySelector(".jsDrawNote");
    if (!note) return;
    if (st === "WON") note.textContent = isDraw ? "B·ªëc thƒÉm" : "Kh√¥ng b·ªëc thƒÉm";
    else note.textContent = "";
  }

  function setHighestCell(tr, hp) {
    const el = tr.querySelector(".jsHpCell");
    if (!el) return;
    el.setAttribute("data-value", String(hp ?? ""));
    el.textContent = hp ? fmtVND(hp) : "‚Äî";
  }

  function applyRowStateFromPayload(tr, payload) {
    const st = String(payload.status || "PENDING").toUpperCase();
    tr.setAttribute("data-counting-status", st);
    tr.setAttribute("data-highest-price", String(payload.highest_price_vnd || ""));
    tr.setAttribute("data-is-draw", payload.is_lucky_draw ? "1" : "0");

    if (st === "WON") {
      tr.setAttribute("data-winner-id", String(payload.winner_customer_id || ""));
      tr.setAttribute("data-tied-ids", "[]");
    } else if (st === "TIED") {
      tr.setAttribute("data-winner-id", "");
      tr.setAttribute("data-tied-ids", JSON.stringify(payload.tied_customer_ids || []));
    } else {
      tr.setAttribute("data-winner-id", "");
      tr.setAttribute("data-tied-ids", "[]");
    }

    setStatusPill(tr, st);
    setHighestCell(tr, payload.highest_price_vnd);
    setDrawNote(tr, st, !!payload.is_lucky_draw);

    const cell = tr.querySelector(".jsWinnerCell");
    if (!cell) return;

    if (st === "TIED") {
      const n = (payload.tied_customer_ids || []).length;
      const lotId = Number(tr.getAttribute("data-lot-id") || 0);
      cell.innerHTML = `
        <span class="ac-badge tied"><i class="ri-focus-2-line"></i> V√≤ng ti·∫øp theo</span>
        <div class="text-sm text-slate-500 mt-1 flex items-center gap-2">
          <span>${n} kh√°ch (ƒë√£ l∆∞u)</span>
          ${lotId ? `
            <a class="ac-mini-print jsPrintTiedLot"
               href="#"
               data-only-lot-id="${lotId}"
               title="In phi·∫øu cho c√°c kh√°ch TIED c·ªßa l√¥ n√†y"
               target="_blank" rel="noopener">
              <i class="ri-printer-line"></i>
            </a>` : ``}
        </div>`;
    } else if (st !== "WON") {
      cell.innerHTML = `<span class="ac-muted">‚Äî</span>`;
    }
  }

  btnConfirmOk?.addEventListener("click", async () => {
    if (!pendingConfirm || !activeLot) { closeConfirm(); return; }
    const lotCode = activeLot.lot_code;
    const payload = pendingConfirm;

    btnConfirmOk.disabled = true;
    btnConfirmOk.innerHTML = `<i class="ri-loader-4-line ri-spin"></i> ƒêang l∆∞u...`;

    try {
      const url = `/auction/counting/api/sessions/${encodeURIComponent(String(SESSION_ID))}/lots/${encodeURIComponent(lotCode)}`;
      const r = await fetch(url, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(payload)
      });
      const js = await r.json();
      if (!r.ok || !js || js.ok !== true) {
        throw new Error(js?.detail || js?.error || "save error");
      }

      if (activeTr) applyRowStateFromPayload(activeTr, payload);
      await loadSnapshotAndApply();

      toast("ok", "ƒê√£ l∆∞u", `ƒê√£ l∆∞u k·∫øt qu·∫£ cho l√¥ ${lotCode} (kh√¥ng reload trang).`);
      closeConfirm();
      closeModal();

    } catch (e) {
      console.warn(e);
      toast("err", "L∆∞u th·∫•t b·∫°i", "Kh√¥ng l∆∞u ƒë∆∞·ª£c. Vui l√≤ng th·ª≠ l·∫°i.");
    } finally {
      btnConfirmOk.disabled = false;
      btnConfirmOk.innerHTML = `<i class="ri-check-line"></i> X√°c nh·∫≠n`;
      pendingConfirm = null;
    }
  });

})();
</script>
{% endblock %}
