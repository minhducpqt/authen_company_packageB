{# templates/auction/auction_counting.html #}
{% extends "base.html" %}
{% block title %}Kiểm phiếu trúng đấu giá{% endblock %}

{% block content %}
{% set projects = projects or [] %}
{% set project_id = project_id %}
{% set project_key = project or "" %}
{% set project_obj = project_obj or {} %}
{% set session = session or {} %}
{% set rows = (data or {}).get("data") or [] %}
{% set total = (data or {}).get("total") or (rows|length) %}
{% set q = q or "" %}
{% set page = page or 1 %}
{% set size = size or 200 %}
{% set auction_mode = (project_obj.get("auction_mode") or "") %}

<style>
  .ac-card { border: 1px solid rgba(226,232,240,1); border-radius: 16px; background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,.03); }
  .ac-pill { display:inline-flex; align-items:center; gap:.5rem; padding:.35rem .7rem; border-radius: 999px; font-weight: 600; font-size: .9rem; border: 1px solid rgba(226,232,240,1); background: rgba(248,250,252,1);}
  .ac-pill.green { border-color: rgba(167,243,208,1); background: rgba(236,253,245,1); color: rgba(6,95,70,1); }
  .ac-pill.orange { border-color: rgba(253,186,116,1); background: rgba(255,247,237,1); color: rgba(154,52,18,1); }
  .ac-pill.gray { border-color: rgba(226,232,240,1); background: rgba(248,250,252,1); color: rgba(51,65,85,1); }
  .ac-pill.blue { border-color: rgba(191,219,254,1); background: rgba(239,246,255,1); color: rgba(30,64,175,1); }
  .ac-btn { display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.6rem 1rem; border-radius: 12px; font-weight: 700; border: 1px solid rgba(226,232,240,1); background:#fff; }
  .ac-btn.primary { background: rgba(16,185,129,1); color:#fff; border-color: rgba(16,185,129,1); }
  .ac-btn.primary:hover { filter: brightness(.98); }
  .ac-btn.ghost:hover { background: rgba(248,250,252,1); }
  .ac-btn:disabled { opacity:.5; cursor:not-allowed; }
  .ac-input { width: 100%; border-radius: 12px; border: 1px solid rgba(226,232,240,1); padding: .75rem .9rem; outline: none; background:#fff; }
  .ac-input:focus { border-color: rgba(99,102,241,1); box-shadow: 0 0 0 4px rgba(99,102,241,.15); }
  .ac-table { width:100%; border-collapse: separate; border-spacing: 0; }
  .ac-th { text-align:left; font-size:.8rem; letter-spacing:.02em; text-transform:uppercase; color: rgba(100,116,139,1); padding: .75rem 1rem; border-bottom:1px solid rgba(226,232,240,1); background: rgba(248,250,252,1); }
  .ac-td { padding: 1rem; border-bottom:1px solid rgba(241,245,249,1); vertical-align: top; }
  .ac-row:hover { background: rgba(248,250,252,1); }
  .ac-muted { color: rgba(100,116,139,1); }
  .ac-strong { color: rgba(15,23,42,1); font-weight: 800; }
  .ac-mono { font-variant-numeric: tabular-nums; }
  .ac-badge { display:inline-flex; align-items:center; gap:.4rem; padding:.25rem .6rem; border-radius: 999px; font-weight: 800; font-size:.85rem; }
  .ac-badge.won { background: rgba(236,253,245,1); color: rgba(6,95,70,1); border: 1px solid rgba(167,243,208,1); }
  .ac-badge.tied { background: rgba(255,247,237,1); color: rgba(154,52,18,1); border: 1px solid rgba(253,186,116,1); }
  .ac-badge.pending { background: rgba(248,250,252,1); color: rgba(71,85,105,1); border: 1px solid rgba(226,232,240,1); }
  /* Modal */
  .ac-modal-backdrop { position: fixed; inset: 0; background: rgba(2,6,23,.55); display:none; align-items:center; justify-content:center; padding: 18px; z-index: 60; }
  .ac-modal { width: 100%; max-width: 1100px; background: #fff; border-radius: 18px; overflow:hidden; box-shadow: 0 20px 50px rgba(0,0,0,.25); max-height: calc(100vh - 36px); display:flex; flex-direction:column; }
  .ac-modal-header { padding: 16px 18px; border-bottom: 1px solid rgba(226,232,240,1); display:flex; align-items:flex-start; justify-content:space-between; gap: 12px; }
  .ac-modal-body { padding: 16px 18px; overflow:auto; }
  .ac-modal-footer { padding: 14px 18px; border-top: 1px solid rgba(226,232,240,1); display:flex; justify-content:flex-end; gap: 10px; background: rgba(248,250,252,1); }
  .ac-kbd { font-weight: 800; font-size: .8rem; padding: .15rem .4rem; border-radius: 8px; border:1px solid rgba(226,232,240,1); background:#fff; color: rgba(51,65,85,1); }
  .ac-quick { display:flex; flex-wrap:wrap; gap: 8px; margin-top: 10px; }
  .ac-quick button { min-width: 56px; }
  .ac-customer { border:1px solid rgba(226,232,240,1); border-radius: 14px; padding: 12px; display:flex; align-items:flex-start; justify-content:space-between; gap: 10px; background:#fff; }
  .ac-customer.disabled { opacity:.55; pointer-events:none; background: rgba(248,250,252,1); }
  .ac-customer .meta { color: rgba(100,116,139,1); font-size:.9rem; margin-top: 2px; }
  .ac-toast { position: fixed; right: 16px; bottom: 16px; z-index: 80; display:flex; flex-direction:column; gap:10px; }
  .ac-toast-item { max-width: 420px; padding: 12px 14px; border-radius: 14px; border:1px solid rgba(226,232,240,1); background:#fff; box-shadow: 0 10px 30px rgba(0,0,0,.12); }
  .ac-toast-item.err { border-color: rgba(254,202,202,1); background: rgba(254,242,242,1); }
  .ac-toast-item.ok { border-color: rgba(167,243,208,1); background: rgba(236,253,245,1); }
  .ac-toast-item .t { font-weight: 900; margin-bottom: 2px; }
</style>

<div class="mb-6 flex items-start justify-between gap-3">
  <div class="min-w-0">
    <div class="flex items-center gap-2">
      <i class="ri-auction-line text-emerald-600 text-3xl"></i>
      <h1 class="text-2xl font-extrabold text-slate-900 truncate">
        Kiểm phiếu trúng đấu giá (2 vòng)
      </h1>
    </div>
    <p class="text-slate-500 text-sm mt-1">
      Vòng 1: xác định <span class="font-semibold">WON</span> (1 người cao nhất) hoặc <span class="font-semibold">TIED</span> (≥2 người hòa).
      Vòng 2: chọn <span class="font-semibold">WON</span> từ nhóm TIED và xác nhận <span class="font-semibold">is_lucky_draw</span>.
    </p>
  </div>

  <div class="flex items-center gap-2 shrink-0">
    <a
      class="ac-btn ghost"
      id="btnProjector"
      href="{% if project_key %}/auction/counting/display?project={{ project_key|urlencode }}{% else %}#{% endif %}"
      target="_blank"
      {% if not project_key %}aria-disabled="true"{% endif %}
    >
      <i class="ri-slideshow-3-line"></i>
      Trình chiếu
    </a>
    <button class="ac-btn primary" id="btnReload" type="button">
      <i class="ri-refresh-line"></i>
      Tải lại
    </button>
  </div>
</div>

<div class="ac-card p-5 mb-6">
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
    <div class="lg:col-span-2">
      <label class="text-sm font-bold text-slate-900">Chọn dự án</label>
      <div class="mt-2 flex gap-2">
        <select id="projectSelect" class="ac-input">
          <option value="">— Chọn dự án —</option>
          {% for p in projects %}
            {% set code = (p.get("project_code") or p.get("code") or "") %}
            {% set pid = (p.get("id") or p.get("project_id") or "") %}
            {% set name = (p.get("name") or "") %}
            {% set st = (p.get("status") or "") %}
            {% set key = (code if code else pid|string) %}
            <option value="{{ key }}" {% if project_key and (project_key|string) == (key|string) %}selected{% endif %}>
              {{ code or ("#" ~ pid) }} — {{ name }}{% if st %} ({{ st }}){% endif %}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="text-xs text-slate-500 mt-2">
        Dropdown gồm cả ACTIVE và INACTIVE. Nếu chỉ có 1 ACTIVE thì hệ thống tự chọn.
      </div>

      <div class="mt-4 flex flex-wrap gap-2">
        <span class="ac-pill">
          <i class="ri-timer-2-line"></i>
          Phiên:
          <span class="ac-strong" id="pillSession">
            {% if session and session.get("id") %}
              #{{ session.get("id") }} ({{ session.get("status") or "COUNTING" }})
            {% else %}
              —
            {% endif %}
          </span>
        </span>

        <span class="ac-pill">
          <i class="ri-stack-line"></i>
          Tổng lô:
          <span class="ac-strong" id="pillTotalLots">{{ total }}</span>
        </span>

        <span class="ac-pill green">
          <i class="ri-trophy-line"></i>
          WON:
          <span class="ac-strong" id="pillWon">—</span>
        </span>

        <span class="ac-pill orange">
          <i class="ri-user-shared-2-line"></i>
          TIED:
          <span class="ac-strong" id="pillTied">—</span>
        </span>

        <span class="ac-pill blue">
          <i class="ri-check-line"></i>
          Đã xử lý:
          <span class="ac-strong" id="pillChecked">—</span>
        </span>
      </div>
    </div>

    <div>
      <label class="text-sm font-bold text-slate-900">Tìm lô</label>
      <div class="mt-2 flex gap-2">
        <input id="qInput" class="ac-input" placeholder="Nhập mã lô..." value="{{ q }}" {% if not project_id %}disabled{% endif %} />
        <button class="ac-btn ghost" id="btnFilter" type="button" {% if not project_id %}disabled{% endif %}>
          <i class="ri-filter-3-line"></i> Lọc
        </button>
        <button class="ac-btn ghost" id="btnReset" type="button" {% if not project_id %}disabled{% endif %}>Reset</button>
      </div>
      {% if error %}
        <div class="mt-3 text-sm p-3 rounded-xl border border-red-200 bg-red-50 text-red-700">
          Lỗi tải danh sách: ({{ error.status }}) {{ error.body }}
        </div>
      {% endif %}
      {% if session_err %}
        <div class="mt-3 text-sm p-3 rounded-xl border border-amber-200 bg-amber-50 text-amber-800">
          Lỗi tạo phiên COUNTING: ({{ session_err.status }}) {{ session_err.body }}
        </div>
      {% endif %}
    </div>
  </div>
</div>

<div class="ac-card overflow-hidden">
  <div class="px-5 py-4 border-b border-slate-100 flex items-center justify-between gap-3">
    <div class="font-extrabold text-slate-900">Danh sách lô</div>
    <div class="text-sm text-slate-500">Bấm <span class="font-bold">Xử lý</span> để nhập kết quả vòng 1 / vòng 2.</div>
  </div>

  <div class="overflow-x-auto">
    <table class="ac-table">
      <thead>
        <tr>
          <th class="ac-th" style="width: 160px;">Mã lô</th>
          <th class="ac-th">Thông tin lô</th>
          <th class="ac-th" style="width: 210px;">Trạng thái</th>
          <th class="ac-th" style="width: 240px;">Giá trúng</th>
          <th class="ac-th" style="width: 320px;">Người trúng (nếu có)</th>
          <th class="ac-th" style="width: 140px; text-align:right;">Thao tác</th>
        </tr>
      </thead>
      <tbody id="lotsTbody">
        {% for r in rows %}
          {% set lot_code = r.get("lot_code") or "" %}
          {% set lot_id = r.get("lot_id") or r.get("id") %}
          {% set st = (r.get("counting_status") or "PENDING") %}
          {% set hp = r.get("highest_price_vnd") %}
          {% set is_draw = r.get("is_lucky_draw") %}
          {% set area = r.get("area") %}
          {% set sp = r.get("starting_price_vnd") %}
          {% set step = r.get("bid_step_vnd") %}
          <tr class="ac-row"
              data-lot-code="{{ lot_code }}"
              data-lot-id="{{ lot_id }}"
              data-lot-name="{{ (r.get('lot_name') or r.get('name') or '')|e }}"
              data-starting-price="{{ sp if sp is not none else '' }}"
              data-area="{{ area if area is not none else '' }}"
              data-bid-step="{{ step if step is not none else '' }}"
              data-counting-status="{{ st }}"
              data-highest-price="{{ hp if hp is not none else '' }}"
              data-is-draw="{{ '1' if is_draw else '0' }}"
          >
            <td class="ac-td">
              <div class="ac-strong text-lg">{{ lot_code }}</div>
              <div class="text-xs ac-muted">ID: {{ lot_id }}</div>
            </td>

            <td class="ac-td">
              <div class="text-sm ac-muted">
                <span class="font-semibold">Giá KL:</span>
                <span class="ac-mono jsMoney" data-value="{{ sp if sp is not none else '' }}">—</span>
                <span class="mx-2">·</span>
                <span class="font-semibold">Diện tích:</span>
                <span class="ac-mono jsArea" data-value="{{ area if area is not none else '' }}">—</span>
              </div>
              <div class="text-sm ac-muted mt-1">
                <span class="font-semibold">Giá KL/m²:</span>
                <span class="ac-mono jsStartPerSqm">—</span>
                <span class="mx-2">·</span>
                <span class="font-semibold">Bước:</span>
                <span class="ac-mono jsMoney" data-value="{{ step if step is not none else '' }}">—</span>
                <span class="mx-2">·</span>
                <span class="font-semibold">Mode:</span>
                <span class="ac-mono jsMode">—</span>
              </div>
            </td>

            <td class="ac-td">
              <div class="jsStatusPill">
                {% if st == 'WON' %}
                  <span class="ac-badge won"><i class="ri-trophy-line"></i> WON</span>
                {% elif st == 'TIED' %}
                  <span class="ac-badge tied"><i class="ri-user-shared-2-line"></i> TIED</span>
                {% else %}
                  <span class="ac-badge pending"><i class="ri-time-line"></i> PENDING</span>
                {% endif %}
              </div>
              <div class="text-xs ac-muted mt-2">
                {% if r.get("set_by") or r.get("edited_by") %}
                  Người nhập: <span class="font-semibold">{{ r.get("set_by") or r.get("edited_by") }}</span>
                {% endif %}
              </div>
              <div class="text-xs ac-muted">
                {% if r.get("set_at") %}
                  Thời điểm: <span class="font-semibold jsTime" data-iso="{{ r.get('set_at') }}">{{ r.get("set_at") }}</span>
                {% endif %}
              </div>
            </td>

            <td class="ac-td">
              <div class="text-xl ac-strong ac-mono jsMoney" data-value="{{ hp if hp is not none else '' }}">—</div>
              <div class="text-xs ac-muted mt-1 jsDrawNote">
                {% if st == 'WON' %}
                  {% if is_draw %}Bốc thăm{% else %}Không bốc thăm{% endif %}
                {% endif %}
              </div>
            </td>

            <td class="ac-td">
              <div class="jsWinnerCell text-sm">
                <span class="ac-muted">—</span>
              </div>
            </td>

            <td class="ac-td" style="text-align:right;">
              <button class="ac-btn ghost jsHandleBtn" type="button" {% if not project_id or not session or not session.get("id") %}disabled{% endif %}>
                <i class="ri-edit-2-line"></i> Xử lý
              </button>
            </td>
          </tr>
        {% endfor %}
        {% if rows|length == 0 %}
          <tr>
            <td class="ac-td" colspan="6">
              <div class="text-slate-500 text-sm">Chưa có dữ liệu. Hãy chọn dự án.</div>
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

{# =========================
   MODAL: EDIT LOT RESULT
   ========================= #}
<div class="ac-modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="ac-modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="ac-modal-header">
      <div class="min-w-0">
        <div class="text-xs font-extrabold text-slate-500 uppercase">Xử lý kết quả</div>
        <div id="modalTitle" class="text-xl font-extrabold text-slate-900 truncate">—</div>
        <div id="modalSub" class="text-sm text-slate-500 mt-1 truncate">—</div>
      </div>
      <button class="ac-btn ghost" type="button" id="btnModalClose" aria-label="Close">
        <i class="ri-close-line text-xl"></i>
      </button>
    </div>

    <div class="ac-modal-body">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="ac-card p-4">
          <div class="font-extrabold text-slate-900 mb-3">Nhập kết quả</div>

          <label class="text-sm font-bold text-slate-900">Trạng thái</label>
          <select id="inpStatus" class="ac-input mt-2">
            <option value="PENDING">PENDING (chưa xử lý)</option>
            <option value="WON">WON (chốt người trúng)</option>
            <option value="TIED">TIED (≥2 khách cùng giá cao nhất)</option>
          </select>

          <div class="mt-4 p-4 rounded-2xl border border-slate-200 bg-slate-50">
            <div class="flex items-center justify-between gap-2">
              <div class="font-extrabold text-slate-900">Giá cao nhất (để xét)</div>
              <div class="text-xs text-slate-500">
                Gợi ý: dùng các nút <span class="ac-kbd">+/-</span> theo bước giá.
              </div>
            </div>

            <input id="inpHighest" class="ac-input mt-3 text-lg font-extrabold ac-mono" inputmode="numeric" placeholder="Nhập giá..." />

            <div class="ac-quick">
              <button type="button" class="ac-btn ghost jsStepBtn" data-step="-5">-5</button>
              <button type="button" class="ac-btn ghost jsStepBtn" data-step="-2">-2</button>
              <button type="button" class="ac-btn ghost jsStepBtn" data-step="-1">-1</button>
              <button type="button" class="ac-btn ghost jsStepBtn" data-step="1">+1</button>
              <button type="button" class="ac-btn ghost jsStepBtn" data-step="2">+2</button>
              <button type="button" class="ac-btn ghost jsStepBtn" data-step="5">+5</button>
            </div>

            <div class="text-xs text-slate-500 mt-3">
              Nếu chưa nhập giá, bấm <span class="font-extrabold">+1</span> sẽ lấy <span class="font-extrabold">giá khởi điểm</span> làm base và cộng theo <span class="font-extrabold">bước giá</span>.
            </div>
          </div>

          <div class="mt-4">
            <label class="text-sm font-bold text-slate-900">Lý do chỉnh sửa (tuỳ chọn)</label>
            <input id="inpReason" class="ac-input mt-2" placeholder="Ví dụ: sửa sai người hòa / cập nhật lại giá..." />
          </div>

          <div class="mt-4">
            <label class="inline-flex items-start gap-3 cursor-pointer select-none">
              <input id="inpLuckyDraw" type="checkbox" class="mt-1" />
              <span>
                <div class="font-extrabold text-slate-900">Kết quả WON này là do bốc thăm (is_lucky_draw)</div>
                <div class="text-sm text-slate-500">Tick nếu bạn đang chốt người trúng từ nhóm TIED.</div>
              </span>
            </label>
          </div>
        </div>

        <div class="ac-card p-4">
          <div class="flex items-center justify-between gap-2">
            <div>
              <div class="font-extrabold text-slate-900">Danh sách khách đủ điều kiện</div>
              <div class="text-sm text-slate-500" id="candHint">—</div>
            </div>
            <div class="text-sm text-slate-500" id="candCount">Tổng: —</div>
          </div>

          <input id="candSearch" class="ac-input mt-3" placeholder="Tìm theo tên/CCCD/phone..." />

          <div class="mt-3 space-y-2" id="candList">
            <div class="text-sm text-slate-500">Đang tải...</div>
          </div>

          <div class="mt-4 p-4 rounded-2xl border border-slate-200 bg-slate-50">
            <div class="font-extrabold text-slate-900">Tóm tắt lựa chọn</div>
            <div class="text-sm text-slate-600 mt-1" id="selSummary">—</div>
          </div>
        </div>
      </div>
    </div>

    <div class="ac-modal-footer">
      <button class="ac-btn ghost" type="button" id="btnModalCancel">Đóng</button>
      <button class="ac-btn primary" type="button" id="btnModalSave">
        <i class="ri-save-2-line"></i> Lưu
      </button>
    </div>
  </div>
</div>

{# =========================
   CONFIRM MODAL
   ========================= #}
<div class="ac-modal-backdrop" id="confirmBackdrop" aria-hidden="true">
  <div class="ac-modal" style="max-width: 720px;">
    <div class="ac-modal-header">
      <div>
        <div class="text-xs font-extrabold text-slate-500 uppercase">Xác nhận lưu</div>
        <div class="text-xl font-extrabold text-slate-900">Bạn chắc chắn muốn lưu kết quả?</div>
        <div class="text-sm text-slate-500 mt-1">Vui lòng kiểm tra nhanh thông tin dưới đây trước khi xác nhận.</div>
      </div>
      <button class="ac-btn ghost" type="button" id="btnConfirmClose" aria-label="Close">
        <i class="ri-close-line text-xl"></i>
      </button>
    </div>

    <div class="ac-modal-body">
      <div class="ac-card p-4">
        <div class="text-sm text-slate-500">Tóm tắt</div>
        <div id="confirmSummary" class="mt-2 text-slate-900 font-semibold"></div>
      </div>
      <div class="ac-card p-4 mt-3">
        <div class="text-sm text-slate-500">Chi tiết</div>
        <div id="confirmDetail" class="mt-2 text-sm text-slate-700 whitespace-pre-wrap"></div>
      </div>
    </div>

    <div class="ac-modal-footer">
      <button class="ac-btn ghost" type="button" id="btnConfirmCancel">Hủy</button>
      <button class="ac-btn primary" type="button" id="btnConfirmOk">
        <i class="ri-check-line"></i> Xác nhận
      </button>
    </div>
  </div>
</div>

<div class="ac-toast" id="toastHost"></div>

<script>
(() => {
  const PROJECT_ID = {{ project_id or "null" }};
  const SESSION_ID = {{ (session.get("id") if session else None) or "null" }};
  const AUCTION_MODE = {{ (auction_mode|tojson) }};
  const POLL_MS = 5000;

  const fmtVND = (n) => {
    const x = Number(n);
    if (!isFinite(x)) return "—";
    return new Intl.NumberFormat("vi-VN", { maximumFractionDigits: 0 }).format(Math.round(x));
  };
  const fmtArea = (n) => {
    const x = Number(n);
    if (!isFinite(x)) return "—";
    return new Intl.NumberFormat("vi-VN", { maximumFractionDigits: 1 }).format(x) + " m²";
  };
  const safeText = (s) => (s == null ? "" : String(s));

  const toastHost = document.getElementById("toastHost");
  function toast(type, title, msg) {
    const el = document.createElement("div");
    el.className = "ac-toast-item " + (type === "err" ? "err" : "ok");
    el.innerHTML = `<div class="t">${title}</div><div class="text-sm text-slate-700">${msg}</div>`;
    toastHost.appendChild(el);
    setTimeout(() => { el.style.opacity = "0"; el.style.transform = "translateY(6px)"; }, 3500);
    setTimeout(() => { el.remove(); }, 4200);
  }

  // Top controls
  const projectSelect = document.getElementById("projectSelect");
  const qInput = document.getElementById("qInput");
  const btnFilter = document.getElementById("btnFilter");
  const btnReset = document.getElementById("btnReset");
  const btnReload = document.getElementById("btnReload");
  const btnProjector = document.getElementById("btnProjector");

  function goWithParams(params) {
    const url = new URL(window.location.href);
    url.search = "";
    Object.entries(params).forEach(([k,v]) => {
      if (v !== undefined && v !== null && String(v).trim() !== "") url.searchParams.set(k, v);
    });
    window.location.href = url.toString();
  }

  projectSelect?.addEventListener("change", () => {
    const v = projectSelect.value;
    goWithParams({ project: v });
  });

  btnFilter?.addEventListener("click", () => {
    goWithParams({ project: projectSelect.value, q: qInput.value.trim() || "" });
  });

  qInput?.addEventListener("keydown", (e) => {
    if (e.key === "Enter") btnFilter.click();
  });

  btnReset?.addEventListener("click", () => {
    goWithParams({ project: projectSelect.value });
  });

  btnReload?.addEventListener("click", () => window.location.reload());

  if (!projectSelect.value) {
    btnProjector?.setAttribute("aria-disabled", "true");
  } else {
    btnProjector.href = "/auction/counting/display?project=" + encodeURIComponent(projectSelect.value);
  }

  // Render money & area in table, compute start_per_sqm, mode label
  function renderRowBase() {
    document.querySelectorAll(".jsMoney").forEach(el => {
      const v = el.getAttribute("data-value");
      el.textContent = v ? fmtVND(v) : "—";
      el.classList.add("ac-mono");
    });
    document.querySelectorAll(".jsArea").forEach(el => {
      const v = el.getAttribute("data-value");
      el.textContent = v ? fmtArea(v) : "—";
      el.classList.add("ac-mono");
    });

    document.querySelectorAll("#lotsTbody tr[data-lot-code]").forEach(tr => {
      const sp = Number(tr.getAttribute("data-starting-price"));
      const area = Number(tr.getAttribute("data-area"));
      const mode = AUCTION_MODE || "";
      tr.querySelector(".jsMode").textContent = mode ? mode : "—";
      const spEl = tr.querySelector(".jsStartPerSqm");
      if (spEl) {
        if (isFinite(sp) && sp > 0 && isFinite(area) && area > 0) spEl.textContent = fmtVND(sp / area) + " VND/m²";
        else spEl.textContent = "—";
      }
    });

    document.querySelectorAll(".jsTime").forEach(el => {
      const iso = el.getAttribute("data-iso");
      if (!iso) return;
      try {
        const d = new Date(iso);
        if (isNaN(d.getTime())) return;
        const t = d.toLocaleTimeString("vi-VN", { hour: "2-digit", minute: "2-digit" });
        const dd = d.toLocaleDateString("vi-VN");
        el.textContent = t + " · " + dd;
      } catch {}
    });
  }

  renderRowBase();

  // Winner / summary via snapshot (fix “đã lưu nhưng không show tên”)
  async function loadSnapshotAndApply() {
    if (!PROJECT_ID || !SESSION_ID) return;

    try {
      const url = new URL("/auction/counting/api/display/snapshot", window.location.origin);
      url.searchParams.set("project_id", String(PROJECT_ID));
      url.searchParams.set("session_id", String(SESSION_ID));
      const r = await fetch(url.toString(), { credentials: "include" });
      const js = await r.json();
      if (!r.ok || !js || js.ok !== true) throw new Error(js?.detail || "snapshot error");

      const sum = js.summary || {};
      document.getElementById("pillWon").textContent = sum.won ?? "—";
      document.getElementById("pillTied").textContent = sum.tied ?? "—";
      document.getElementById("pillChecked").textContent = sum.checked ?? "—";

      const winners = js.winners || [];
      const winMap = new Map(); // lot_code -> winner obj
      winners.forEach(w => {
        if (w?.lot_code) winMap.set(String(w.lot_code).toLowerCase(), w);
      });

      document.querySelectorAll("#lotsTbody tr[data-lot-code]").forEach(tr => {
        const lc = String(tr.getAttribute("data-lot-code") || "").toLowerCase();
        const cell = tr.querySelector(".jsWinnerCell");
        if (!cell) return;

        const w = winMap.get(lc);
        if (!w) {
          cell.innerHTML = `<span class="ac-muted">—</span>`;
          return;
        }

        const name = safeText(w.full_name || w.name || "");
        const cccd = safeText(w.cccd || "");
        const phone = safeText(w.phone_masked || w.phone || "");

        const parts = [];
        if (name) parts.push(`<div class="font-extrabold text-slate-900">${name}</div>`);
        const meta = [];
        if (cccd) meta.push(`CCCD: <span class="font-semibold">${cccd}</span>`);
        if (phone) meta.push(`Phone: <span class="font-semibold">${phone}</span>`);
        parts.push(`<div class="text-sm text-slate-500">${meta.length ? meta.join(" · ") : ""}</div>`);

        cell.innerHTML = parts.join("");
      });

    } catch (e) {
      // keep silent; avoid noisy
      console.warn(e);
    }
  }

  loadSnapshotAndApply();

  // OPTIONAL: refresh snapshot every 10s to keep winners up-to-date without reloading
  setInterval(loadSnapshotAndApply, 10000);

  // =========================
  // Modal logic
  // =========================
  const modalBackdrop = document.getElementById("modalBackdrop");
  const btnModalClose = document.getElementById("btnModalClose");
  const btnModalCancel = document.getElementById("btnModalCancel");
  const btnModalSave = document.getElementById("btnModalSave");

  const inpStatus = document.getElementById("inpStatus");
  const inpHighest = document.getElementById("inpHighest");
  const inpReason = document.getElementById("inpReason");
  const inpLuckyDraw = document.getElementById("inpLuckyDraw");

  const candHint = document.getElementById("candHint");
  const candCount = document.getElementById("candCount");
  const candSearch = document.getElementById("candSearch");
  const candList = document.getElementById("candList");
  const selSummary = document.getElementById("selSummary");

  const confirmBackdrop = document.getElementById("confirmBackdrop");
  const btnConfirmClose = document.getElementById("btnConfirmClose");
  const btnConfirmCancel = document.getElementById("btnConfirmCancel");
  const btnConfirmOk = document.getElementById("btnConfirmOk");
  const confirmSummary = document.getElementById("confirmSummary");
  const confirmDetail = document.getElementById("confirmDetail");

  let activeLot = null; // {lot_code, lot_id, lot_name, starting_price, area, bid_step, ...}
  let candidates = [];
  let selectedIds = new Set();

  function openModal() {
    modalBackdrop.style.display = "flex";
    modalBackdrop.setAttribute("aria-hidden", "false");
    document.body.style.overflow = "hidden";
  }
  function closeModal() {
    modalBackdrop.style.display = "none";
    modalBackdrop.setAttribute("aria-hidden", "true");
    document.body.style.overflow = "";
    activeLot = null;
    candidates = [];
    selectedIds = new Set();
  }
  function openConfirm() {
    confirmBackdrop.style.display = "flex";
    confirmBackdrop.setAttribute("aria-hidden", "false");
    document.body.style.overflow = "hidden";
  }
  function closeConfirm() {
    confirmBackdrop.style.display = "none";
    confirmBackdrop.setAttribute("aria-hidden", "true");
  }

  btnModalClose?.addEventListener("click", closeModal);
  btnModalCancel?.addEventListener("click", closeModal);
  modalBackdrop?.addEventListener("click", (e) => {
    if (e.target === modalBackdrop) closeModal();
  });
  btnConfirmClose?.addEventListener("click", closeConfirm);
  btnConfirmCancel?.addEventListener("click", closeConfirm);
  confirmBackdrop?.addEventListener("click", (e) => {
    if (e.target === confirmBackdrop) closeConfirm();
  });

  // Price input formatting: keep raw digits
  function digitsOnly(s) { return (s || "").replace(/[^\d]/g, ""); }
  function parseMoney(s) {
    const d = digitsOnly(s);
    if (!d) return null;
    const n = Number(d);
    return isFinite(n) ? n : null;
  }
  function setMoneyInput(el, n) {
    if (n == null || !isFinite(n)) { el.value = ""; return; }
    el.value = fmtVND(n);
  }
  inpHighest?.addEventListener("input", () => {
    const caretEnd = inpHighest.selectionEnd;
    const n = parseMoney(inpHighest.value);
    if (n == null) return;
    const s = fmtVND(n);
    inpHighest.value = s;
    try { inpHighest.setSelectionRange(s.length, s.length); } catch {}
    refreshSummary();
  });

  // Step buttons
  document.querySelectorAll(".jsStepBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      if (!activeLot) return;
      const stepMul = Number(btn.getAttribute("data-step") || "0");
      if (!stepMul) return;

      const bidStep = Number(activeLot.bid_step || 0);
      const basePrice = Number(activeLot.base_start || 0);
      if (!isFinite(bidStep) || bidStep <= 0) {
        toast("err", "Thiếu bước giá", "Lô này chưa có bid_step_vnd hoặc bước giá không hợp lệ.");
        return;
      }

      let cur = parseMoney(inpHighest.value);
      if (cur == null) cur = basePrice; // if empty, start from base
      const next = cur + stepMul * bidStep;
      setMoneyInput(inpHighest, Math.max(next, 0));
      refreshSummary();
    });
  });

  // Enable/disable candidate list based on status
  function applyStatusUI() {
    const st = (inpStatus.value || "PENDING").toUpperCase();
    const isPending = st === "PENDING";

    // Pending => disable selection
    candSearch.disabled = isPending;
    inpHighest.disabled = isPending;
    document.querySelectorAll(".jsStepBtn").forEach(b => b.disabled = isPending);

    // Lucky draw only meaningful for WON
    inpLuckyDraw.disabled = (st !== "WON");

    // Hint
    if (st === "WON") candHint.textContent = "Chọn 1 khách trúng (1 tick).";
    else if (st === "TIED") candHint.textContent = "Chọn ≥2 khách hòa (nhiều tick).";
    else candHint.textContent = "PENDING: chưa chọn khách.";

    // Make list disabled style
    candList.querySelectorAll(".ac-customer").forEach(card => {
      if (isPending) card.classList.add("disabled"); else card.classList.remove("disabled");
    });

    refreshSummary();
  }
  inpStatus?.addEventListener("change", () => {
    // reset selection when switching modes to avoid accidental
    selectedIds = new Set();
    renderCandidates();
    applyStatusUI();
  });

  // Load candidates automatically when open modal
  async function loadCandidates(lot_code) {
    candList.innerHTML = `<div class="text-sm text-slate-500">Đang tải...</div>`;
    candCount.textContent = "Tổng: —";
    candidates = [];
    try {
      const url = new URL(`/auction/counting/api/projects/${PROJECT_ID}/lots/${encodeURIComponent(lot_code)}/eligible-customers`, window.location.origin);
      url.searchParams.set("include_unpaid", "false");
      url.searchParams.set("limit", "5000");
      const r = await fetch(url.toString(), { credentials: "include" });
      const js = await r.json();
      if (!r.ok || !js || js.ok !== true) throw new Error(js?.detail || "load candidates error");
      candidates = js.data || [];
      candCount.textContent = "Tổng: " + candidates.length;
      renderCandidates();
      applyStatusUI();
    } catch (e) {
      console.warn(e);
      candList.innerHTML = `<div class="text-sm text-red-700">Không tải được danh sách khách.</div>`;
      toast("err", "Lỗi tải danh sách", "Không tải được danh sách khách đủ điều kiện.");
    }
  }

  // Search + render candidates
  function normalizeStr(s) {
    return (s || "").toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  }
  function renderCandidates() {
    const st = (inpStatus.value || "PENDING").toUpperCase();
    const isPending = st === "PENDING";
    const q = normalizeStr(candSearch.value || "");
    const list = candidates.filter(c => {
      if (!q) return true;
      const hay = normalizeStr((c.full_name || "") + " " + (c.cccd || "") + " " + (c.phone || "") + " " + (c.email || ""));
      return hay.includes(q);
    });

    candList.innerHTML = "";
    if (!list.length) {
      candList.innerHTML = `<div class="text-sm text-slate-500">Không có khách phù hợp.</div>`;
      refreshSummary();
      return;
    }

    list.forEach(c => {
      const cid = Number(c.customer_id || c.id);
      const name = safeText(c.full_name || "");
      const cccd = safeText(c.cccd || "");
      const phone = safeText(c.phone || "");
      const checked = selectedIds.has(cid);

      const card = document.createElement("div");
      card.className = "ac-customer" + (isPending ? " disabled" : "");
      card.innerHTML = `
        <label class="flex items-start gap-3 w-full cursor-pointer">
          <input type="${st === 'WON' ? 'radio' : 'checkbox'}" name="candPick" ${checked ? "checked" : ""} class="mt-1" ${isPending ? "disabled" : ""} />
          <div class="min-w-0">
            <div class="font-extrabold text-slate-900 truncate">${name || "(Không tên)"}</div>
            <div class="meta">
              ${cccd ? `CCCD: <span class="font-semibold">${cccd}</span>` : ""}
              ${phone ? ` · Phone: <span class="font-semibold">${phone}</span>` : ""}
            </div>
          </div>
        </label>
        <div class="text-sm font-extrabold text-slate-400">#${cid || "—"}</div>
      `;

      const input = card.querySelector("input");
      input.addEventListener("change", () => {
        if (isPending) return;

        if (st === "WON") {
          selectedIds = new Set([cid]);
          // Uncheck others visually by re-render
          renderCandidates();
        } else if (st === "TIED") {
          if (input.checked) selectedIds.add(cid);
          else selectedIds.delete(cid);
          refreshSummary();
        }
      });

      candList.appendChild(card);
    });

    refreshSummary();
  }

  candSearch?.addEventListener("input", () => renderCandidates());

  function refreshSummary() {
    const st = (inpStatus.value || "PENDING").toUpperCase();
    const hp = parseMoney(inpHighest.value);
    const draw = !!inpLuckyDraw.checked;

    const picks = Array.from(selectedIds);
    if (st === "PENDING") {
      selSummary.textContent = "PENDING: chưa chọn khách.";
      return;
    }
    if (st === "WON") {
      selSummary.textContent = `WON: chọn ${picks.length ? ("#" + picks[0]) : "—"} · Giá: ${hp != null ? fmtVND(hp) : "—"} · is_lucky_draw: ${draw ? "Có" : "Không"}`;
      return;
    }
    if (st === "TIED") {
      selSummary.textContent = `TIED: chọn ${picks.length} khách · Giá: ${hp != null ? fmtVND(hp) : "—"}`;
      return;
    }
    selSummary.textContent = "—";
  }

  // Open modal from row
  document.querySelectorAll(".jsHandleBtn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const tr = btn.closest("tr[data-lot-code]");
      if (!tr) return;

      if (!PROJECT_ID || !SESSION_ID) {
        toast("err", "Chưa chọn dự án", "Vui lòng chọn dự án trước khi thao tác.");
        return;
      }

      const lot_code = tr.getAttribute("data-lot-code");
      const lot_id = tr.getAttribute("data-lot-id");
      const lot_name = tr.getAttribute("data-lot-name") || "";

      const starting_price = Number(tr.getAttribute("data-starting-price"));
      const area = Number(tr.getAttribute("data-area"));
      const bid_step = Number(tr.getAttribute("data-bid-step"));

      const baseStart = (() => {
        // starting_price_vnd is full-lot
        if (AUCTION_MODE === "PER_SQM" && isFinite(starting_price) && starting_price > 0 && isFinite(area) && area > 0) {
          return starting_price / area;
        }
        return isFinite(starting_price) ? starting_price : 0;
      })();

      activeLot = {
        lot_code, lot_id, lot_name,
        starting_price, area, bid_step,
        base_start: baseStart
      };

      // Header
      const title = document.getElementById("modalTitle");
      const sub = document.getElementById("modalSub");
      title.textContent = `Lô ${lot_code}`;
      const s1 = isFinite(starting_price) ? fmtVND(starting_price) : "—";
      const s2 = (AUCTION_MODE === "PER_SQM" && isFinite(baseStart) && baseStart > 0) ? (fmtVND(baseStart) + " VND/m²") : "—";
      const sArea = isFinite(area) ? fmtArea(area) : "—";
      const sStep = isFinite(bid_step) ? fmtVND(bid_step) + " VND" : "—";
      sub.textContent = `Mode: ${AUCTION_MODE || "—"} · Bước: ${sStep} · KL: ${s1} · DT: ${sArea} · KL/m²: ${s2}`;

      // Prefill from row current counting
      const curStatus = (tr.getAttribute("data-counting-status") || "PENDING").toUpperCase();
      const curHighest = tr.getAttribute("data-highest-price");
      const curDraw = tr.getAttribute("data-is-draw") === "1";

      inpStatus.value = (curStatus === "WON" || curStatus === "TIED") ? curStatus : "PENDING";
      inpLuckyDraw.checked = !!curDraw;
      inpReason.value = "";

      if (curHighest) setMoneyInput(inpHighest, Number(curHighest));
      else inpHighest.value = "";

      // reset selection (we will rely on snapshot winners to preselect if possible)
      selectedIds = new Set();

      openModal();
      applyStatusUI();

      // Auto load candidates always (as requested)
      await loadCandidates(lot_code);

      // Preselect based on existing status:
      // - WON: use snapshot winners map (preferred) OR row winner_customer_id if present (not always in B list)
      // - TIED: if A list provides tied_customer_ids we cannot access here; keep empty (admin can reselect)
      try {
        if (inpStatus.value === "WON") {
          // try read winner id from snapshot
          const trCell = tr.querySelector(".jsWinnerCell");
          // Not reliable; do another quick snapshot refresh then pick by lot_code
          await loadSnapshotAndApply();
          // We can't extract id from cell safely. But we can: when candidates load, if only 1 selected in server,
          // user can just keep it; we won't auto-select to avoid wrong.
        }
      } catch {}
    });
  });

  // Save -> validate -> confirm -> call API
  function pickCustomerObjects(ids) {
    const map = new Map();
    candidates.forEach(c => map.set(Number(c.customer_id || c.id), c));
    return ids.map(id => map.get(id)).filter(Boolean);
  }

  function validatePayload() {
    const st = (inpStatus.value || "PENDING").toUpperCase();
    const hp = parseMoney(inpHighest.value);
    const reason = (inpReason.value || "").trim();
    const draw = !!inpLuckyDraw.checked;

    if (!activeLot) return { ok:false, msg:"Không xác định được lô đang xử lý." };

    if (st === "PENDING") {
      return {
        ok: true,
        payload: { status: "PENDING", edit_reason: reason }
      };
    }

    if (hp == null || hp <= 0) return { ok:false, msg:"Vui lòng nhập Giá cao nhất > 0." };

    if (st === "WON") {
      if (selectedIds.size !== 1) return { ok:false, msg:"WON: vui lòng chọn đúng 1 khách trúng." };
      const winnerId = Array.from(selectedIds)[0];
      return {
        ok: true,
        payload: {
          status: "WON",
          highest_price_vnd: hp,
          winner_customer_id: winnerId,
          is_lucky_draw: draw,        // REQUIRED by Service A (true/false đều được)
          edit_reason: reason
        }
      };
    }

    if (st === "TIED") {
      if (selectedIds.size < 2) return { ok:false, msg:"TIED: vui lòng chọn ≥ 2 khách hòa." };
      return {
        ok: true,
        payload: {
          status: "TIED",
          highest_price_vnd: hp,
          tied_customer_ids: Array.from(selectedIds),
          edit_reason: reason
        }
      };
    }

    return { ok:false, msg:"Trạng thái không hợp lệ." };
  }

  let pendingConfirm = null;

  btnModalSave?.addEventListener("click", () => {
    const v = validatePayload();
    if (!v.ok) {
      toast("err", "Chưa hợp lệ", v.msg || "Vui lòng kiểm tra lại dữ liệu.");
      return;
    }

    const st = (inpStatus.value || "PENDING").toUpperCase();
    const hp = parseMoney(inpHighest.value);
    const draw = !!inpLuckyDraw.checked;
    const ids = Array.from(selectedIds);
    const picked = pickCustomerObjects(ids);

    // Build confirm content
    const lotCode = activeLot?.lot_code || "—";
    const sumLine = `Lô ${lotCode} · Trạng thái: ${st}` + (st !== "PENDING" ? ` · Giá: ${fmtVND(hp)}`
      + (st === "WON" ? ` · is_lucky_draw: ${draw ? "Có" : "Không"}` : "") : "");

    const detailLines = [];
    detailLines.push(`Lô: ${lotCode}`);
    detailLines.push(`Mode: ${AUCTION_MODE || "—"}`);
    detailLines.push(`Giá khởi điểm (cả lô): ${isFinite(activeLot.starting_price) ? fmtVND(activeLot.starting_price) : "—"} VND`);
    detailLines.push(`Diện tích: ${isFinite(activeLot.area) ? fmtArea(activeLot.area) : "—"}`);
    detailLines.push(`Bước giá: ${isFinite(activeLot.bid_step) ? fmtVND(activeLot.bid_step) : "—"} VND`);
    detailLines.push(`Trạng thái: ${st}`);

    if (st !== "PENDING") {
      detailLines.push(`Giá cao nhất: ${fmtVND(hp)}${AUCTION_MODE === "PER_SQM" ? " (theo m²)" : " (theo lô)"}`);
    }
    if (st === "WON") {
      const c = picked[0];
      detailLines.push(`Người trúng: #${ids[0]}${c?.full_name ? " · " + c.full_name : ""}${c?.cccd ? " · CCCD " + c.cccd : ""}${c?.phone ? " · " + c.phone : ""}`);
      detailLines.push(`is_lucky_draw: ${draw ? "Có (bốc thăm)" : "Không (không bốc thăm)"}`);
    }
    if (st === "TIED") {
      detailLines.push(`Danh sách TIED (${ids.length}):`);
      picked.forEach(c => {
        detailLines.push(`- #${Number(c.customer_id || c.id)} · ${c.full_name || ""}${c.cccd ? " · " + c.cccd : ""}${c.phone ? " · " + c.phone : ""}`);
      });
    }

    confirmSummary.textContent = sumLine;
    confirmDetail.textContent = detailLines.join("\n");

    pendingConfirm = v.payload;
    openConfirm();
  });

  btnConfirmOk?.addEventListener("click", async () => {
    if (!pendingConfirm || !activeLot) { closeConfirm(); return; }
    const lotCode = activeLot.lot_code;
    const payload = pendingConfirm;

    btnConfirmOk.disabled = true;
    btnConfirmOk.innerHTML = `<i class="ri-loader-4-line ri-spin"></i> Đang lưu...`;

    try {
      const url = `/auction/counting/api/sessions/${encodeURIComponent(String(SESSION_ID))}/lots/${encodeURIComponent(lotCode)}`;
      const r = await fetch(url, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(payload)
      });
      const js = await r.json();
      if (!r.ok || !js || js.ok !== true) {
        throw new Error(js?.detail || js?.error || "save error");
      }

      toast("ok", "Đã lưu", `Đã lưu kết quả cho lô ${lotCode}.`);
      closeConfirm();
      closeModal();

      // Refresh table quickly by reloading lots list through page reload
      // (đơn giản + chắc chắn đúng)
      setTimeout(() => window.location.reload(), 350);

    } catch (e) {
      console.warn(e);
      toast("err", "Lưu thất bại", "Không lưu được. Vui lòng thử lại.");
    } finally {
      btnConfirmOk.disabled = false;
      btnConfirmOk.innerHTML = `<i class="ri-check-line"></i> Xác nhận`;
      pendingConfirm = null;
    }
  });

  // When modal open, status drives enable/disable; also update summary
  inpLuckyDraw?.addEventListener("change", refreshSummary);

})();
</script>
{% endblock %}
