{# templates/auction/auction_results.html #}
{% extends "base.html" %}
{% block title %}Trúng đấu giá{% endblock %}

{% block content %}
<div class="mb-6">
  <h1 class="text-2xl font-semibold text-slate-900 flex items-center gap-2">
    <i class="ri-auction-line text-emerald-600 text-3xl"></i>
    Kết quả trúng đấu giá
  </h1>
  <p class="text-slate-500 text-sm mt-1">
    Chọn dự án → xem lô, theo dõi <span class="font-semibold text-slate-800">kết quả trúng</span>.
  </p>
</div>

<form id="filtersForm" method="get"
      class="bg-white border border-slate-200 rounded-2xl shadow-sm p-4 mb-4 flex flex-wrap gap-4 items-end"
      onsubmit="return false;">
  <div class="flex flex-col">
    <label class="text-xs font-semibold text-slate-500 mb-1">Dự án</label>
    <select id="fProject" name="project" class="h-10 rounded-xl border border-slate-200 px-3 text-sm min-w-[240px] bg-white">
      <option value="">— Chọn dự án —</option>
      {% for p in projects or [] %}
        {% set code = (p.project_code or p.code) %}
        <option value="{{ code }}" {% if code == project %}selected{% endif %}>
          {{ code }} — {{ p.name }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="flex flex-col">
    <label class="text-xs font-semibold text-slate-500 mb-1">Tìm lô</label>
    <input
      id="fQ"
      type="text"
      name="q"
      value="{{ q }}"
      class="h-10 rounded-xl border border-slate-200 px-3 text-sm min-w-[200px]"
      placeholder="Mã lô..."
      autocomplete="off"
    >
  </div>

  <div class="flex flex-col">
    <label class="text-xs font-semibold text-slate-500 mb-1">Trạng thái kết quả</label>
    <select id="fStatus" name="result_status" class="h-10 rounded-xl border border-slate-200 px-3 text-sm min-w-[170px] bg-white">
      {% set rs = (result_status or '') %}
      <option value="" {% if rs=='' %}selected{% endif %}>— Tất cả —</option>
      <option value="EMPTY" {% if rs=='EMPTY' %}selected{% endif %}>Chưa nhập (EMPTY)</option>
      <option value="WON" {% if rs=='WON' %}selected{% endif %}>Trúng (WON)</option>
      <option value="NO_SALE" {% if rs=='NO_SALE' %}selected{% endif %}>Không bán (NO_SALE)</option>
      <option value="CANCELED" {% if rs=='CANCELED' %}selected{% endif %}>Hủy (CANCELED)</option>
    </select>
  </div>

  <div class="flex flex-col">
    <label class="text-xs font-semibold text-slate-500 mb-1">Số dòng / trang</label>
    <input
      id="fSize"
      type="number"
      name="size"
      value="{{ size or 200 }}"
      class="h-10 rounded-xl border border-slate-200 px-3 text-sm w-28"
      min="1"
      max="500"
    >
  </div>

  <div class="flex items-center gap-3 ml-auto">
    {# ✅ Present (open new tab) #}
    {% if project_id %}
      <button
        type="button"
        id="btnPresent"
        class="h-10 px-4 rounded-xl bg-slate-900 text-white text-sm font-medium hover:bg-slate-800 inline-flex items-center gap-2"
        title="Mở màn hình trình chiếu kết quả (tab mới)"
      >
        <i class="ri-slideshow-2-line"></i> Present
      </button>
    {% endif %}

    {# ✅ Export #}
    {% if project_id and project_obj %}
      {% set pcode = (project_obj.project_code or project_obj.code or project) %}
      <a
        href="/auction/results/export?project_id={{ project_id }}&project_code={{ pcode }}"
        class="h-10 px-4 rounded-xl bg-emerald-600 text-white text-sm font-medium hover:bg-emerald-700 inline-flex items-center gap-2"
        title="Xuất Excel danh sách lô trúng (WON)"
      >
        <i class="ri-file-excel-2-line"></i> Export XLSX
      </a>
    {% endif %}

    <button
      type="button"
      id="btnResetFilters"
      class="h-10 px-4 rounded-xl border border-slate-300 text-sm font-medium text-slate-700 bg-white hover:bg-slate-50 inline-flex items-center gap-2"
      title="Đưa bộ lọc về mặc định"
    >
      <i class="ri-refresh-line"></i> Reset
    </button>
  </div>
</form>

{% if error %}
  <div class="mb-4 bg-rose-50 border border-rose-200 text-rose-700 rounded-xl p-3 text-sm">
    <div class="font-semibold">Lỗi gọi Service A</div>
    <div class="mt-1">status={{ error.status }} | {{ (error.body or {}).get('detail') or error.body }}</div>
  </div>
{% endif %}

{% set rows = (data or {}).get('data') or [] %}
{% set total = (data or {}).get('total') or (rows|length) %}

<div class="mb-3 text-sm text-slate-600">
  {% if project_id %}
    <span class="font-semibold text-slate-900">{{ total }}</span> lô được tìm thấy.
  {% else %}
    Chọn dự án để xem dữ liệu.
  {% endif %}
</div>

<div class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden">
  <div class="overflow-x-auto">
    <table class="min-w-[980px] w-full text-sm text-slate-700">
      <thead class="bg-slate-50 text-slate-500 border-b border-slate-200">
        <tr>
          <th class="px-4 py-2 text-left font-semibold">Mã lô</th>
          <th class="px-4 py-2 text-center font-semibold">KQ</th>
          <th class="px-4 py-2 text-left font-semibold">Khách trúng</th>
          <th class="px-4 py-2 text-right font-semibold">Giá trúng</th>
          <th class="px-4 py-2 text-right font-semibold">Giá khởi điểm</th>
          <th class="px-4 py-2 text-right font-semibold">Đặt trước</th>
          <th class="px-4 py-2 text-left font-semibold">Chốt</th>
        </tr>
      </thead>

      <tbody class="divide-y divide-slate-100" id="lotsTbody">
      {% for r in rows %}
        <tr class="hover:bg-slate-50 transition" data-lot-code="{{ r.lot_code }}">
          <td class="px-4 py-3 font-semibold text-slate-900 whitespace-nowrap">
            {{ r.lot_code }}
          </td>

          <td class="px-4 py-3 text-center whitespace-nowrap">
            {% set st = (r.result_status or '') %}
            {% if not st %}
              <span class="px-2 py-1 rounded-full text-xs font-semibold bg-slate-100 text-slate-600">EMPTY</span>
            {% elif st == 'WON' %}
              <span class="px-2 py-1 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-700">WON</span>
            {% elif st == 'NO_SALE' %}
              <span class="px-2 py-1 rounded-full text-xs font-semibold bg-amber-100 text-amber-700">NO_SALE</span>
            {% else %}
              <span class="px-2 py-1 rounded-full text-xs font-semibold bg-rose-100 text-rose-700">CANCELED</span>
            {% endif %}
          </td>

          <td class="px-4 py-3 text-sm">
            {% if r.winner_name %}
              <div class="font-semibold text-slate-900">{{ r.winner_name }}</div>
              <div class="text-xs text-slate-500">{{ r.winner_cccd or '' }}</div>
            {% else %}
              <span class="text-slate-400">—</span>
            {% endif %}
          </td>

          <td class="px-4 py-3 text-right whitespace-nowrap">
            {% if r.winning_price_vnd %}
              <span class="money font-semibold text-slate-900" data-value="{{ r.winning_price_vnd }}">—</span>
            {% else %}
              <span class="text-slate-400">—</span>
            {% endif %}
          </td>

          <td class="px-4 py-3 text-right whitespace-nowrap">
            <span class="money" data-value="{{ r.starting_price_vnd or '' }}">—</span>
          </td>

          <td class="px-4 py-3 text-right whitespace-nowrap">
            <span class="money" data-value="{{ r.deposit_vnd or '' }}">—</span>
          </td>

          <td class="px-4 py-3 text-xs text-slate-600 whitespace-nowrap">
            <div class="font-semibold text-slate-700">{{ r.finalized_by or '' }}</div>
            <div class="dt text-slate-500" data-iso="{{ r.finalized_at or '' }}">{{ r.finalized_at or '' }}</div>
          </td>
        </tr>
      {% endfor %}

      {% if rows|length == 0 %}
        <tr>
          <td colspan="7" class="px-4 py-6 text-center text-slate-400">
            {% if project_id %}
              Không có lô phù hợp bộ lọc hiện tại.
            {% else %}
              Chọn dự án để xem dữ liệu.
            {% endif %}
          </td>
        </tr>
      {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast">
  <div class="bg-slate-900 text-white text-sm px-4 py-3 rounded-xl shadow-lg" id="toastMsg">OK</div>
</div>

<style>
  .toast{position:fixed;right:16px;bottom:16px;z-index:60;display:none}
</style>

<script>
  const PROJECT_ID = {{ project_id or 'null' }};

  // ===== FILTERS =====
  const DEFAULT_SIZE = 200;

  function debounce(fn, wait){
    let t = null;
    return (...args)=>{
      clearTimeout(t);
      t = setTimeout(()=> fn(...args), wait);
    };
  }

  function currentUrl(){ return new URL(window.location.href); }

  function applyFilters(pushHistory=true){
    const u = currentUrl();

    const project = (document.getElementById('fProject')?.value || '').trim();
    const q = (document.getElementById('fQ')?.value || '').trim();
    const rs = (document.getElementById('fStatus')?.value || '').trim();
    const size = (document.getElementById('fSize')?.value || '').trim();

    u.searchParams.set('page', '1');

    if(project) u.searchParams.set('project', project); else u.searchParams.delete('project');
    if(q) u.searchParams.set('q', q); else u.searchParams.delete('q');
    if(rs) u.searchParams.set('result_status', rs); else u.searchParams.delete('result_status');

    const sizeNum = Number(size || DEFAULT_SIZE);
    if(sizeNum && sizeNum !== DEFAULT_SIZE) u.searchParams.set('size', String(sizeNum));
    else u.searchParams.delete('size');

    if(u.toString() === window.location.href) return;

    if(pushHistory) window.location.assign(u.toString());
    else window.location.replace(u.toString());
  }

  const applyFiltersDebounced = debounce(()=> applyFilters(true), 350);

  document.getElementById('fProject')?.addEventListener('change', ()=> applyFilters(true));
  document.getElementById('fStatus')?.addEventListener('change', ()=> applyFilters(true));
  document.getElementById('fSize')?.addEventListener('change', ()=> applyFilters(true));
  document.getElementById('fQ')?.addEventListener('input', ()=> applyFiltersDebounced());

  document.getElementById('btnResetFilters')?.addEventListener('click', ()=>{
    const u = currentUrl();
    u.searchParams.delete('project');
    u.searchParams.delete('q');
    u.searchParams.delete('result_status');
    u.searchParams.delete('size');
    u.searchParams.delete('page');
    window.location.assign(u.toString());
  });

  // ===== TOAST =====
  function toast(msg){
    const t = document.getElementById('toast');
    const m = document.getElementById('toastMsg');
    m.textContent = msg;
    t.style.display = 'block';
    setTimeout(()=> t.style.display='none', 2200);
  }

  // ===== MONEY HELPERS (for table render) =====
  function digitsOnly(v){
    let s = String(v ?? '').trim();
    if(!s) return '';
    s = s.replace(/,/g, '');
    const m = s.match(/^(\d+)\.(\d+)$/);
    if(m){
      const intPart = m[1];
      const fracPart = m[2];
      if(/^0+$/.test(fracPart)) return intPart;
      return intPart;
    }
    return s.replace(/[^\d]/g,'');
  }

  function groupVi(d){
    d = digitsOnly(d);
    if(!d) return '';
    d = d.replace(/^0+(?=\d)/,'');
    let out = '';
    let cnt = 0;
    for(let i=d.length-1;i>=0;i--){
      out = d[i] + out;
      cnt++;
      if(cnt % 3 === 0 && i !== 0) out = '.' + out;
    }
    return out;
  }

  function formatVNDInt(v){
    const d = digitsOnly(v);
    return d ? groupVi(d) : '';
  }

  function formatAllMoneyCells(){
    document.querySelectorAll('.money').forEach(el=>{
      const v = el.getAttribute('data-value');
      const f = formatVNDInt(v);
      el.textContent = f || '—';
    });
  }

  // ===== DATETIME =====
  function pad2(n){ return String(n).padStart(2,'0'); }
  function formatISOToVN(iso){
    if(!iso) return '';
    const d = new Date(iso);
    if(!isFinite(d.getTime())) return iso;

    const dd = pad2(d.getDate());
    const mm = pad2(d.getMonth()+1);
    const yyyy = d.getFullYear();
    const HH = pad2(d.getHours());
    const MM = pad2(d.getMinutes());
    const SS = pad2(d.getSeconds());
    return `${dd}/${mm}/${yyyy} ${HH}:${MM}:${SS}`;
  }
  function formatAllDateCells(){
    document.querySelectorAll('.dt').forEach(el=>{
      const iso = el.getAttribute('data-iso') || '';
      el.textContent = iso ? formatISOToVN(iso) : '';
    });
  }

  formatAllMoneyCells();
  formatAllDateCells();

  // ===== PRESENT (open tab) =====
  function buildPresentUrl(){
    // Chưa làm trang present thật — chỉ gắn action.
    // Giữ filter giống trang hiện tại.
    const u = currentUrl();

    const project = u.searchParams.get('project') || '';
    if(!project){
      return null;
    }

    const q = u.searchParams.get('q') || '';
    const rs = u.searchParams.get('result_status') || '';
    const size = u.searchParams.get('size') || '';

    const p = new URL(window.location.origin + "/auction/results/present");
    p.searchParams.set('project', project);
    if(q) p.searchParams.set('q', q);
    if(rs) p.searchParams.set('result_status', rs);
    if(size) p.searchParams.set('size', size);

    return p.toString();
  }

  document.getElementById('btnPresent')?.addEventListener('click', ()=>{
    const url = buildPresentUrl();
    if(!url){
      toast("Vui lòng chọn dự án trước");
      return;
    }
    window.open(url, "_blank", "noopener,noreferrer");
  });
</script>
{% endblock %}