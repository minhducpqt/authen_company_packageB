{# templates/auction/auction_counting_display.html #}
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{{ title or "Tr√¨nh chi·∫øu ki·ªÉm phi·∫øu" }}</title>

  <style>
    :root{
      /* Base */
      --bg0:#03040a;
      --bg1:#070816;
      --bg2:#0b0e22;

      /* Glass */
      --glass: rgba(255,255,255,.055);
      --glass2: rgba(255,255,255,.085);
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.18);

      /* Text */
      --text: rgba(255,255,255,.94);
      --muted: rgba(255,255,255,.62);

      /* Accents */
      --wonA:#00ffd5;
      --wonB:#00a7ff;

      --tiedA:#ffd86a;
      --tiedB:#ff4bd8;

      --pending:#cfcfd6;
      --danger:#ff4d6d;

      --radius: 22px;
      --hudH: 78px;
      --footerH: 34px;

      --cardH: 160px;
      --cardPad: 13px;

      /* Live */
      --liveDot:#1dff8a;
      --liveRing: rgba(29,255,138,.45);

      /* Shadow / Glow */
      --shadowA: 0 28px 100px rgba(0,0,0,.48);
      --shadowB: 0 18px 70px rgba(0,0,0,.40);
      --insetA: inset 0 1px 0 rgba(255,255,255,.07);

      /* UI */
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;

      /* Motion */
      --e1: cubic-bezier(.2,.9,.2,1);
      --e2: cubic-bezier(.2,.7,.2,1);
    }

    *{box-sizing:border-box}
    html,body{height:100%;}
    body{
      margin:0;
      color:var(--text);
      background:
        radial-gradient(1100px 680px at 16% 14%, rgba(0,255,213,.18), transparent 58%),
        radial-gradient(980px 620px at 86% 20%, rgba(255,77,216,.14), transparent 56%),
        radial-gradient(900px 560px at 62% 92%, rgba(0,167,255,.12), transparent 58%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
      font-family: var(--sans);
      letter-spacing: .1px;
    }

    /* Ambient FX layers */
    .fx-grid{
      position:fixed; inset:0; pointer-events:none; z-index:0;
      background:
        linear-gradient(rgba(255,255,255,.06) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.05) 1px, transparent 1px);
      background-size: 44px 44px, 44px 44px;
      opacity:.085;
      mix-blend-mode:overlay;
      filter: blur(.18px);
    }
    .fx-scan{
      position:fixed; inset:-60% 0 0 0; pointer-events:none; z-index:0;
      background: linear-gradient(180deg, transparent, rgba(255,255,255,.14), transparent);
      opacity:.11;
      animation: scan 7.8s linear infinite;
      filter: blur(.25px);
    }
    @keyframes scan{
      0%{ transform: translateY(-30%); }
      100%{ transform: translateY(150%); }
    }
    .fx-glow{
      position:fixed; inset:0; pointer-events:none; z-index:0;
      background:
        radial-gradient(900px 420px at 22% 30%, rgba(0,255,213,.11), transparent 60%),
        radial-gradient(860px 420px at 78% 72%, rgba(255,77,216,.10), transparent 60%);
      opacity:.95;
    }

    /* Subtle noise (no image) */
    .fx-noise{
      position:fixed; inset:0; pointer-events:none; z-index:1;
      background:
        repeating-linear-gradient(0deg,
          rgba(255,255,255,.016) 0px,
          rgba(255,255,255,.016) 1px,
          transparent 2px,
          transparent 4px);
      opacity:.22;
      mix-blend-mode: overlay;
      filter: blur(.35px);
    }

    /* TOP HUD */
    .hud{
      position:fixed; top:0; left:0; right:0;
      height:var(--hudH);
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 16px;
      z-index:30;
      backdrop-filter: blur(16px);
      background:
        linear-gradient(180deg, rgba(10,12,24,.92), rgba(10,12,24,.56));
      border-bottom:1px solid rgba(255,255,255,.12);
      box-shadow: 0 18px 70px rgba(0,0,0,.42);
    }

    /* HUD decorative corners */
    .hud::before, .hud::after{
      content:"";
      position:absolute;
      top:0; bottom:0;
      width:220px;
      pointer-events:none;
      opacity:.55;
    }
    .hud::before{
      left:0;
      background: radial-gradient(260px 90px at 14% 10%, rgba(0,255,213,.22), transparent 70%);
    }
    .hud::after{
      right:0;
      background: radial-gradient(260px 90px at 86% 10%, rgba(255,77,216,.18), transparent 70%);
    }

    .hud-left{min-width:0; position:relative; z-index:1;}
    .hud-title{
      font-weight:1000;
      letter-spacing:.7px;
      font-size:18px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-shadow: 0 0 28px rgba(0,255,213,.14);
    }
    .hud-sub{
      margin-top:6px;
      font-size:12px;
      color:rgba(255,255,255,.68);
      display:flex; align-items:center; gap:8px;
      white-space:nowrap;
    }

    /* NEW: ‚ÄúLIVE‚Äù label (UI only, no logic change) */
    .hud-live{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .hud-live b{
      font-weight:1000;
      font-size:11px;
      letter-spacing:.55px;
      color: rgba(255,255,255,.88);
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: var(--wonA);
      box-shadow:0 0 18px rgba(0,255,213,.60), 0 0 40px rgba(0,255,213,.22);
    }
    .sep{opacity:.55}

    .hud-right{
      display:flex;
      gap:10px;
      align-items:stretch;
      position:relative;
      z-index:1;
    }
    .kpi{
      width:126px;
      padding:9px 11px;
      border-radius:18px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow:
        0 0 26px rgba(255,255,255,.06),
        inset 0 1px 0 rgba(255,255,255,.08);
      display:flex; flex-direction:column; justify-content:center;
      transform: translateZ(0);
    }
    .kpi-num{
      font-size:22px;
      font-weight:1000;
      line-height:1;
      letter-spacing:.3px;
    }
    .kpi-lbl{
      margin-top:4px;
      font-size:11px;
      color:rgba(255,255,255,.62);
      letter-spacing:.25px;
      text-transform:uppercase;
    }
    .kpi-total .kpi-num{ text-shadow:0 0 26px rgba(255,255,255,.10); }
    .kpi-won  .kpi-num{ color:rgba(0,255,213,.96); text-shadow:0 0 26px rgba(0,255,213,.28); }
    .kpi-tied .kpi-num{ color:rgba(255,216,106,.98); text-shadow:0 0 26px rgba(255,216,106,.22); }
    .kpi-pend .kpi-num{ color:rgba(210,210,220,.92); text-shadow:0 0 26px rgba(255,255,255,.14); }

    /* LAYOUT */
    .wrap{
      position:relative;
      z-index:10;
      height:100%;
      padding-top: calc(var(--hudH) + 12px);
      padding-bottom: calc(var(--footerH) + 10px);
      padding-left: 16px;
      padding-right: 16px;
      display:grid;
      grid-template-columns: 1.05fr 1fr;
      gap:12px;
    }

    .panel{
      border-radius: 22px;
      background:
        radial-gradient(900px 340px at 18% 0%, rgba(0,255,213,.08), transparent 60%),
        radial-gradient(900px 340px at 82% 0%, rgba(255,77,216,.06), transparent 60%),
        rgba(255,255,255,.048);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadowA), var(--insetA);
      overflow:hidden;
      position:relative;
      transform: translateZ(0);
    }

    /* panel inner frame */
    .panel::after{
      content:"";
      position:absolute; inset:10px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.06);
      pointer-events:none;
      opacity:.7;
    }

    .panel-head{
      display:flex; align-items:center; justify-content:space-between;
      padding:11px 13px;
      border-bottom: 1px solid rgba(255,255,255,.085);
      background:
        linear-gradient(180deg, rgba(255,255,255,.075), rgba(255,255,255,.02));
      backdrop-filter: blur(10px);
      position:relative;
      z-index:2;
    }
    .panel-title{
      font-weight:1000;
      letter-spacing:.55px;
      font-size:13px;
      color:rgba(255,255,255,.90);
      display:flex; align-items:center; gap:10px;
      text-transform:uppercase;
    }

    /* NEW: hi-tech ‚Äúchip‚Äù icon */
    .chip{
      width:18px; height:18px;
      border-radius:7px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
      position:relative;
    }
    .chip::before, .chip::after{
      content:"";
      position:absolute;
      inset:4px;
      border-radius:5px;
      border:1px dashed rgba(255,255,255,.22);
      opacity:.9;
    }
    .chip::after{
      inset:-2px;
      border-radius:9px;
      border:1px solid rgba(255,255,255,.10);
      opacity:.55;
    }

    .badge{
      font-size:11px;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      color:rgba(255,255,255,.78);
      background: rgba(255,255,255,.05);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
      letter-spacing:.25px;
      white-space:nowrap;
    }

    .latest-body{
      padding:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-content:start;
      min-height: 240px;
      position:relative;
      z-index:1;
    }

    .all-body{
      position:relative;
      height: calc(100% - 50px);
      overflow:hidden;
    }

    /* subtle right-panel vignette */
    .all-body::after{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      background:
        linear-gradient(180deg, rgba(0,0,0,.15), transparent 18%),
        linear-gradient(0deg, rgba(0,0,0,.22), transparent 20%);
      opacity:.85;
      z-index:2;
    }

    .scroll-viewport{
      position:absolute;
      inset: 0;
      padding:12px;
      overflow:hidden;
      z-index:1;
    }
    .scroll-track{
      position:absolute;
      left:12px; right:12px; top:12px;
      will-change: transform;
      transform: translateZ(0);
    }

    .cycle-indicator{
      position:absolute;
      left:12px; right:12px; top:12px;
      display:flex;
      justify-content:center;
      pointer-events:none;
      opacity:0;
      transform: translateY(-10px);
      transition: opacity .22s var(--e2), transform .22s var(--e2);
      z-index:5;
    }
    .cycle-indicator.show{ opacity:1; transform: translateY(0); }
    .cycle-pill{
      padding:8px 14px;
      border-radius:999px;
      font-weight:1000;
      letter-spacing:.55px;
      font-size:12px;
      background: rgba(0,0,0,.38);
      border:1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(12px);
      box-shadow: 0 0 26px rgba(0,255,213,.16);
      animation: pulse 900ms ease-in-out;
      text-transform:uppercase;
    }
    @keyframes pulse{
      0%{ transform: scale(.98); opacity:.82; }
      50%{ transform: scale(1.03); opacity:1; }
      100%{ transform: scale(1.0); opacity:1; }
    }

    /* CARD */
    .card{
      height: var(--cardH);
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(900px 240px at 20% 10%, rgba(255,255,255,.08), transparent 65%),
        rgba(10,12,24,.46);
      box-shadow: var(--shadowB), var(--insetA);
      position:relative;
      overflow:hidden;
      transform: translateZ(0);
      isolation:isolate;
    }

    /* NEW: ultra-thin neon frame */
    .card::before{
      content:"";
      position:absolute; inset:0;
      border-radius: var(--radius);
      pointer-events:none;
      background:
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.02));
      opacity:.45;
      mix-blend-mode: overlay;
    }

    /* sheen */
    .card::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.12), transparent);
      transform: translateX(-70%);
      opacity:.10;
      animation: sheen 3.8s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes sheen{
      0%{ transform: translateX(-70%); opacity:.06; }
      55%{ opacity:.14; }
      100%{ transform: translateX(130%); opacity:.06; }
    }

    /* LIVE dot (Latest panel only) */
    .live-dot{
      position:absolute;
      top:12px;
      left:12px;
      width:10px;
      height:10px;
      border-radius:999px;
      background: var(--liveDot);
      box-shadow:
        0 0 0 0 rgba(29,255,138,.0),
        0 0 18px rgba(29,255,138,.55),
        0 0 40px rgba(29,255,138,.22);
      z-index:6;
      pointer-events:none;
      animation: liveBlink 1.2s ease-in-out infinite;
    }
    .live-dot::after{
      content:"";
      position:absolute;
      inset:-8px;
      border-radius:999px;
      border:1px solid rgba(29,255,138,.28);
      box-shadow: 0 0 24px rgba(29,255,138,.18);
      opacity:.75;
      animation: liveRing 1.2s ease-in-out infinite;
    }
    @keyframes liveBlink{
      0%,100%{ transform: scale(.95); opacity:.65; }
      50%{ transform: scale(1.15); opacity:1; }
    }
    @keyframes liveRing{
      0%{ transform: scale(.82); opacity:.55; }
      70%{ transform: scale(1.12); opacity:.15; }
      100%{ transform: scale(1.20); opacity:0; }
    }

    /* status glow layers */
    .card.won{ animation: glowWon 2.8s ease-in-out infinite; }
    .card.tied{ animation: glowTied 2.8s ease-in-out infinite; }

    @keyframes glowWon{
      0%,100%{ box-shadow: 0 18px 74px rgba(0,255,213,.18), 0 18px 74px rgba(0,167,255,.12), inset 0 1px 0 rgba(255,255,255,.06); }
      50%{ box-shadow: 0 24px 96px rgba(0,255,213,.25), 0 20px 88px rgba(0,167,255,.18), inset 0 1px 0 rgba(255,255,255,.07); }
    }
    @keyframes glowTied{
      0%,100%{ box-shadow: 0 18px 74px rgba(255,216,106,.20), 0 18px 74px rgba(255,77,216,.12), inset 0 1px 0 rgba(255,255,255,.06); }
      50%{ box-shadow: 0 24px 96px rgba(255,216,106,.26), 0 20px 88px rgba(255,77,216,.18), inset 0 1px 0 rgba(255,255,255,.07); }
    }

    .card-inner{
      position:relative;
      height:100%;
      padding: var(--cardPad);
      display:flex;
      flex-direction:column;
      gap:7px;
      z-index:2;
    }
    .row{ display:flex; align-items:baseline; justify-content:space-between; gap:10px; }

    .lot-code{
      font-weight:1000;
      letter-spacing: 1.2px;
      font-size:22px;
      line-height:1;
      text-transform:uppercase;
      white-space:nowrap;
    }

    .status-stack{
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .status-chip{
      font-size:11px;
      font-weight:1000;
      letter-spacing:.45px;
      padding:6px 10px;
      border-radius:999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      white-space:nowrap;
      text-transform:uppercase;
    }

    .tied-count{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      min-width: 54px;
      padding:6px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,216,106,.34);
      background: rgba(255,216,106,.12);
      box-shadow: 0 0 26px rgba(255,216,106,.18);
      line-height:1;
      position:relative;
      overflow:hidden;
    }
    .tied-count::after{
      content:"";
      position:absolute; inset:-40% -60%;
      background: radial-gradient(circle at 30% 30%, rgba(255,216,106,.28), transparent 55%);
      opacity:.75;
      transform: rotate(18deg);
      pointer-events:none;
    }
    .tied-count .n{
      font-size:18px;
      font-weight:1000;
      letter-spacing:.35px;
      color: rgba(255,216,106,.98);
      text-shadow: 0 0 22px rgba(255,216,106,.20);
      position:relative; z-index:1;
    }
    .tied-count .lbl{
      margin-top:4px;
      font-size:9px;
      font-weight:1000;
      letter-spacing:.55px;
      opacity:.88;
      text-transform:uppercase;
      position:relative; z-index:1;
    }

    .price{
      font-size:24px;
      font-weight:1000;
      letter-spacing:.25px;
      line-height:1.05;
      text-shadow: 0 0 26px rgba(255,255,255,.10);
    }
    .price-lbl{
      margin-top:-2px;
      font-size:11px;
      color: rgba(255,255,255,.62);
      letter-spacing:.35px;
      text-transform:uppercase;
    }

    .person{
      margin-top:auto;
      padding-top:8px;
      border-top:1px dashed rgba(255,255,255,.12);
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .name{
      font-weight:1000;
      font-size:15px;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .meta{
      display:flex;
      gap:8px;
      font-size:12px;
      color: rgba(255,255,255,.74);
      align-items:center;
      flex-wrap:wrap;
    }
    .meta span{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      max-width: 100%;
    }
    .meta .k{opacity:.85}
    .meta .v{
      font-family: var(--mono);
      letter-spacing:.35px;
      white-space:nowrap;
      overflow:visible;
      text-overflow:clip;
    }

    /* WON */
    .card.won{
      border-color: rgba(0,255,213,.42);
      background:
        radial-gradient(900px 240px at 18% 12%, rgba(0,255,213,.13), transparent 65%),
        radial-gradient(900px 240px at 82% 36%, rgba(0,167,255,.10), transparent 62%),
        rgba(10,12,24,.46);
    }
    .card.won .lot-code{
      color: rgba(0,255,213,.98);
      text-shadow: 0 0 30px rgba(0,255,213,.26);
    }
    .card.won .status-chip{
      color: rgba(0,255,213,.96);
      border-color: rgba(0,255,213,.34);
      background: rgba(0,255,213,.12);
      box-shadow: 0 0 26px rgba(0,255,213,.22);
    }

    /* TIED */
    .card.tied{
      border-color: rgba(255,216,106,.42);
      background:
        radial-gradient(900px 240px at 20% 10%, rgba(255,216,106,.16), transparent 65%),
        radial-gradient(900px 260px at 80% 30%, rgba(255,77,216,.14), transparent 60%),
        rgba(10,12,24,.46);
    }
    .card.tied .lot-code{
      color: rgba(255,216,106,.99);
      text-shadow: 0 0 30px rgba(255,216,106,.22);
    }
    .card.tied .status-chip{
      color: rgba(255,216,106,.96);
      border-color: rgba(255,216,106,.34);
      background: rgba(255,216,106,.12);
      box-shadow: 0 0 26px rgba(255,216,106,.20);
    }

    /* TIED marquee */
    .marquee{
      margin-top:auto;
      border-top:1px dashed rgba(255,255,255,.12);
      padding-top:8px;
      overflow:hidden;
      position:relative;
    }
    .marquee::before{
      content:"";
      position:absolute; left:0; top:0; bottom:0; width:34px;
      background: linear-gradient(90deg, rgba(10,12,24,.86), transparent);
      pointer-events:none;
      z-index:2;
    }
    .marquee::after{
      content:"";
      position:absolute; right:0; top:0; bottom:0; width:34px;
      background: linear-gradient(270deg, rgba(10,12,24,.86), transparent);
      pointer-events:none;
      z-index:2;
    }
    .marquee-track{
      display:inline-flex;
      gap:14px;
      white-space:nowrap;
      will-change: transform;
      animation: marquee 24s linear infinite;
      transform: translateZ(0);
    }
    @keyframes marquee{
      0%{ transform: translateX(0); }
      100%{ transform: translateX(-50%); }
    }
    .cand{
      display:inline-flex;
      align-items:center;
      gap:10px;
      font-size:12px;
      color: rgba(255,255,255,.86);
      padding:6px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.30);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
      backdrop-filter: blur(8px);
    }
    .cand b{ font-weight:1000; color: rgba(255,255,255,.96); }
    .cand i{
      font-style:normal;
      opacity:.9;
      padding-left:8px;
      border-left:1px solid rgba(255,255,255,.12);
      font-family: var(--mono);
      letter-spacing:.25px;
    }

    /* Placeholder */
    .ph{
      height: var(--cardH);
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.11);
      background: rgba(255,255,255,.04);
      position:relative;
      overflow:hidden;
      box-shadow: var(--shadowB), inset 0 1px 0 rgba(255,255,255,.05);
    }
    .ph::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.12), transparent);
      transform: translateX(-70%);
      animation: shimmer 1.7s ease-in-out infinite;
      opacity:.62;
      pointer-events:none;
    }
    @keyframes shimmer{
      0%{ transform: translateX(-70%); }
      100%{ transform: translateX(140%); }
    }
    .ph .ph-inner{
      position:relative;
      padding: var(--cardPad);
      height:100%;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .ph-line{
      height:14px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.06);
    }
    .ph-line.big{ height:20px; width:62%; }
    .ph-line.mid{ width:58%; }
    .ph-line.sm{ width:44%; }
    .ph-line.full{ width:100%; }
    .ph .ph-footer{
      margin-top:auto;
      height:42px;
      border-top:1px dashed rgba(255,255,255,.10);
      padding-top:10px;
      display:flex;
      gap:10px;
    }
    .ph-pill{
      height:20px; width:34%;
      border-radius:999px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.06);
    }

    /* No project overlay */
    .center-overlay{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:24px;
      z-index:40;
    }
    .center-box{
      width:min(900px, 92vw);
      border-radius: 26px;
      background:
        radial-gradient(900px 240px at 20% 10%, rgba(0,255,213,.12), transparent 60%),
        radial-gradient(900px 240px at 80% 10%, rgba(255,77,216,.10), transparent 60%),
        rgba(0,0,0,.40);
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: 0 30px 120px rgba(0,0,0,.58);
      backdrop-filter: blur(16px);
      padding: 18px 18px 16px;
      position:relative;
      overflow:hidden;
    }
    .center-box::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.10), transparent);
      transform: translateX(-70%);
      animation: sheen 4.4s ease-in-out infinite;
      opacity:.10;
      pointer-events:none;
    }
    .center-box h2{
      margin:0;
      font-size:18px;
      font-weight:1000;
      letter-spacing:.45px;
      text-transform:uppercase;
    }
    .center-box p{
      margin:10px 0 0 0;
      color: rgba(255,255,255,.72);
      font-size:12px;
      line-height:1.65;
    }
    .center-box b{
      color: rgba(255,255,255,.92);
      font-weight:1000;
    }

    /* Footer */
    .footer-marquee{
      position:fixed; left:0; right:0; bottom:0;
      height: var(--footerH);
      z-index:30;
      border-top: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(10,12,24,.30), rgba(10,12,24,.84));
      backdrop-filter: blur(12px);
      overflow:hidden;
    }
    .footer-track{
      position:absolute; left:0; top:0; height:100%;
      display:flex; align-items:center;
      gap:28px;
      padding-left:16px;
      white-space:nowrap;
      color: rgba(255,255,255,.70);
      font-size:12px;
      letter-spacing:.35px;
      animation: foot 18s linear infinite;
    }
    .footer-track b{
      font-weight:1000;
      color: rgba(255,255,255,.82);
    }
    @keyframes foot{
      0%{ transform: translateX(0); }
      100%{ transform: translateX(-50%); }
    }

    /* Better small-screen */
    @media (max-width: 1100px){
      .wrap{ grid-template-columns: 1fr; }
      .hud-right .kpi{ width:112px; }
      .kpi{ border-radius:16px; }
    }
    @media (max-width: 720px){
      :root{ --hudH: 86px; }
      .hud{ padding:10px 12px; }
      .hud-right{ gap:8px; }
      .hud-title{ font-size:16px; }
      .kpi{ width:108px; padding:8px 10px; }
      .kpi-num{ font-size:20px; }
      .latest-body{ grid-template-columns: 1fr; }
      .card, .ph{ height: 168px; }
    }

    /* Reduce motion if needed */
    @media (prefers-reduced-motion: reduce){
      .fx-scan, .card::after, .footer-track, .marquee-track, .card.won, .card.tied, .live-dot{
        animation: none !important;
      }
    }
  </style>
</head>

<body>
  <div class="fx-glow"></div>
  <div class="fx-grid"></div>
  <div class="fx-scan"></div>
  <div class="fx-noise"></div>

  <div class="hud">
    <div class="hud-left">
      <div class="hud-title" id="hudProjectName">D·ª∞ √ÅN: ‚Äî</div>
      <div class="hud-sub">
        <span class="hud-live" aria-label="Tr·∫°ng th√°i live">
          <span class="dot" id="hudDot"></span>
          <b>LIVE</b>
        </span>
        <span id="hudStatus">ƒêang c·∫≠p nh·∫≠t</span>
        <span class="sep">‚Ä¢</span>
        <span id="hudUpdatedAt">‚Äî</span>
      </div>
    </div>

    <div class="hud-right">
      <div class="kpi kpi-total">
        <div class="kpi-num" id="kpiTotal">0</div>
        <div class="kpi-lbl">T·ªïng l√¥</div>
      </div>
      <div class="kpi kpi-won">
        <div class="kpi-num" id="kpiWon">0</div>
        <div class="kpi-lbl">ƒê√£ tr√∫ng</div>
      </div>
      <div class="kpi kpi-tied">
        <div class="kpi-num" id="kpiTied">0</div>
        <div class="kpi-lbl">Ch·ªù b·ªëc thƒÉm</div>
      </div>
      <div class="kpi kpi-pend">
        <div class="kpi-num" id="kpiPending">0</div>
        <div class="kpi-lbl">ƒêang x·ª≠ l√Ω</div>
      </div>
    </div>
  </div>

  <main class="wrap">
    <section class="panel">
      <div class="panel-head">
        <div class="panel-title">
          <span class="chip" aria-hidden="true"></span>
          K·∫æT QU·∫¢ M·ªöI C·∫¨P NH·∫¨T
        </div>
        <span class="badge" id="badgeLatest">Top 6</span>
      </div>
      <div class="latest-body" id="latestBody"></div>
    </section>

    <section class="panel">
      <div class="panel-head">
        <div class="panel-title">
          <span class="chip" aria-hidden="true"></span>
          T·∫§T C·∫¢ L√î ƒê√É KI·ªÇM
        </div>
        <span class="badge">T·ª± ch·∫°y theo v√≤ng</span>
      </div>

      <div class="all-body">
        <div class="cycle-indicator" id="cycleIndicator">
          <div class="cycle-pill">B·∫ÆT ƒê·∫¶U DANH S√ÅCH</div>
        </div>

        <div class="scroll-viewport">
          <div class="scroll-track" id="scrollTrack"></div>
        </div>
      </div>
    </section>

    <div class="center-overlay" id="noProjectOverlay" style="display:none;">
      <div class="center-box">
        <h2>Ch∆∞a ch·ªçn d·ª± √°n ƒë·ªÉ tr√¨nh chi·∫øu</h2>
        <p>
          Trang n√†y c·∫ßn tham s·ªë d·ª± √°n <b>?project=</b> (project_code ho·∫∑c project_id).<br/>
          V√≠ d·ª•: <b>/auction/counting/display?project=KDO01</b> ho·∫∑c <b>?project=123</b>.
        </p>
      </div>
    </div>
  </main>

  <div class="footer-marquee">
    <div class="footer-track">
      ¬© <b>VNTECHX</b> ‚Ä¢ C√¥ng Ty C·ªï Ph·∫ßn Gi·∫£i Ph√°p C√¥ng Ngh·ªá VNTECHX ‚Ä¢ H·ªá th·ªëng tr√¨nh chi·∫øu ki·ªÉm phi·∫øu realtime ‚Ä¢
      ¬© <b>VNTECHX</b> ‚Ä¢ C√¥ng Ty C·ªï Ph·∫ßn Gi·∫£i Ph√°p C√¥ng Ngh·ªá VNTECHX ‚Ä¢ H·ªá th·ªëng tr√¨nh chi·∫øu ki·ªÉm phi·∫øu realtime ‚Ä¢
      ¬© <b>VNTECHX</b> ‚Ä¢ C√¥ng Ty C·ªï Ph·∫ßn Gi·∫£i Ph√°p C√¥ng Ngh·ªá VNTECHX ‚Ä¢ H·ªá th·ªëng tr√¨nh chi·∫øu ki·ªÉm phi·∫øu realtime ‚Ä¢
      ¬© <b>VNTECHX</b> ‚Ä¢ C√¥ng Ty C·ªï Ph·∫ßn Gi·∫£i Ph√°p C√¥ng Ngh·ªá VNTECHX ‚Ä¢ H·ªá th·ªëng tr√¨nh chi·∫øu ki·ªÉm phi·∫øu realtime ‚Ä¢
    </div>
  </div>

  <script>
    const PROJECT_ID = {{ (project_id or 0) | int }};
    const POLL_MS = {{ (poll_ms or 2000) | int }};

    function fmtVND(v){
      if (v === null || v === undefined || v === "") return "‚Äî";
      const n = Number(v);
      if (!isFinite(n)) return String(v);
      return n.toLocaleString("vi-VN") + " ƒë";
    }
    function digitsOnly(s){ return String(s || "").replace(/\D/g, ""); }
    function maskLast4(s){
      const d = digitsOnly(s);
      if (!d) return "‚Äî";
      const tail = d.slice(-4);
      const stars = "*".repeat(Math.max(d.length - 4, 6));
      return stars + tail;
    }
    function safeText(s){ return (s === null || s === undefined) ? "" : String(s); }
    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function customerCode(id){
      const n = Number(id);
      if (!isFinite(n) || n <= 0) return "";
      return `C${n}`;
    }

    const hudProjectName = document.getElementById("hudProjectName");
    const hudUpdatedAt   = document.getElementById("hudUpdatedAt");
    const hudStatus      = document.getElementById("hudStatus");
    const hudDot         = document.getElementById("hudDot");

    const kpiTotal   = document.getElementById("kpiTotal");
    const kpiWon     = document.getElementById("kpiWon");
    const kpiTied    = document.getElementById("kpiTied");
    const kpiPending = document.getElementById("kpiPending");

    const latestBody = document.getElementById("latestBody");
    const scrollTrack = document.getElementById("scrollTrack");
    const cycleIndicator = document.getElementById("cycleIndicator");
    const noProjectOverlay = document.getElementById("noProjectOverlay");

    // =========================
    // marquee kh√¥ng b·ªã gi·∫≠t v·ªÅ ƒë·∫ßu sau m·ªói poll
    // =========================
    const MARQUEE_DUR_SEC = 24;
    const marqueeEpoch = performance.now();

    function hashStr(s){
      s = String(s || "");
      let h = 2166136261;
      for (let i=0;i<s.length;i++){
        h ^= s.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h >>> 0);
    }
    function marqueeDelayForLot(lotCode){
      const t = (performance.now() - marqueeEpoch) / 1000;
      const base = t % MARQUEE_DUR_SEC;
      const off  = (hashStr(lotCode) % 1000) / 1000 * MARQUEE_DUR_SEC;
      return (base + off) % MARQUEE_DUR_SEC;
    }

    // =========================
    // State
    // =========================
    const LATEST_SLOTS = 6;

    // Scroll state (panel ph·∫£i) ‚Äî gi·ªØ nguy√™n gi·ªØa c√°c poll
    let scrollY = 0;
    let lastRAF = 0;
    let trackHeight = 0;
    let loopingEnabled = false;

    // t·ªëc ƒë·ªô v·ª´a ƒë·ªß ƒë·ªçc
    let scrollSpeed = 0.06;

    // =========================
    // Helpers: time parsing + sort
    // =========================
    function parseTs(v){
      if (!v) return 0;
      const t = Date.parse(String(v));
      return isFinite(t) ? t : 0;
    }
    function updatedAtOf(it){
      return parseTs(it && (it.updated_at ?? it.updatedAt));
    }

    // =========================
    // Card renderers
    // =========================
    function cardWON(it, showLiveDot){
      const lot = safeText(it.lot_code || "‚Äî").toUpperCase();
      const price = fmtVND(it.highest_price_vnd);
      const name = safeText(it.full_name || "‚Äî");

      const cid = (it.customer_id ?? it.id ?? "");
      const ccode = customerCode(cid);

      const phoneMasked =
        it.phone_masked ? safeText(it.phone_masked) :
        (it.phone ? maskLast4(it.phone) : "‚Äî");

      const codeSpan = ccode
        ? `<span><span class="k">M√£:</span> <span class="v">${escapeHtml(ccode)}</span></span>`
        : "";

      return `
        <div class="card won" data-lot="${escapeHtml(lot)}">
          ${showLiveDot ? `<span class="live-dot" aria-hidden="true"></span>` : ``}
          <div class="card-inner">
            <div class="row">
              <div class="lot-code">${escapeHtml(lot)}</div>
              <div class="status-stack">
                <div class="status-chip">üèÜ TR√öNG</div>
              </div>
            </div>

            <div>
              <div class="price">${escapeHtml(price)}</div>
              <div class="price-lbl">GI√Å TR·∫¢ CAO NH·∫§T</div>
            </div>

            <div class="person">
              <div class="name">${escapeHtml(name)}</div>
              <div class="meta">
                ${codeSpan}
                <span><span class="k">SƒêT:</span> <span class="v">${escapeHtml(phoneMasked)}</span></span>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function cardTIED(it, showLiveDot){
      const lot = safeText(it.lot_code || "‚Äî").toUpperCase();
      const price = fmtVND(it.highest_price_vnd);

      const cands = Array.isArray(it.candidates) ? it.candidates : [];
      const cnt = cands.length;

      const candChips = cands.map(c=>{
        const name = safeText(c.full_name || "‚Äî");
        const cid = (c.customer_id ?? c.id ?? "");
        const ccode = customerCode(cid);

        const phoneMasked =
          c.phone_masked ? safeText(c.phone_masked) :
          (c.phone ? maskLast4(c.phone) : "‚Äî");

        const prefix = ccode ? `${escapeHtml(ccode)} ‚Ä¢ ` : "";
        return `<span class="cand"><b>${prefix}${escapeHtml(name)}</b><i>SƒêT ${escapeHtml(phoneMasked)}</i></span>`;
      });

      const joined = candChips.join("");
      const doubled = joined + joined;

      const delay = marqueeDelayForLot(lot);

      return `
        <div class="card tied" data-lot="${escapeHtml(lot)}">
          ${showLiveDot ? `<span class="live-dot" aria-hidden="true"></span>` : ``}
          <div class="card-inner">
            <div class="row">
              <div class="lot-code">${escapeHtml(lot)}</div>
              <div class="status-stack">
                <div class="status-chip">üéØ B·ªêC THƒÇM</div>
                <div class="tied-count" title="S·ªë ng∆∞·ªùi b·ªëc thƒÉm">
                  <div class="n">${cnt}</div>
                  <div class="lbl">NG∆Ø·ªúI</div>
                </div>
              </div>
            </div>

            <div>
              <div class="price">${escapeHtml(price)}</div>
              <div class="price-lbl">GI√Å TR·∫¢ CAO NH·∫§T</div>
            </div>

            <div class="marquee">
              <div class="marquee-track" style="animation-duration:${MARQUEE_DUR_SEC}s; animation-delay:-${delay}s;">
                ${
                  doubled
                  || `<span class="cand"><b>ƒêang ch·ªù danh s√°ch b·ªëc thƒÉm‚Ä¶</b><i>SƒêT ‚Äî</i></span>`
                   + `<span class="cand"><b>ƒêang ch·ªù danh s√°ch b·ªëc thƒÉm‚Ä¶</b><i>SƒêT ‚Äî</i></span>`
                }
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function placeholderCard(){
      return `
        <div class="ph">
          <div class="ph-inner">
            <div class="ph-line big"></div>
            <div class="ph-line mid"></div>
            <div class="ph-line full"></div>
            <div class="ph-line sm"></div>
            <div class="ph-footer">
              <div class="ph-pill"></div>
              <div class="ph-pill"></div>
              <div class="ph-pill"></div>
            </div>
          </div>
        </div>
      `;
    }

    // =========================
    // Renderers
    // =========================
    function renderTop(js){
      const prj = js.project || {};
      const sum = js.summary || {};
      const total = Number(sum.total_lots || 0);
      const won = Number(sum.won || 0);
      const tied = Number(sum.tied || 0);
      const checked = Number(sum.checked || 0);
      const pending = Math.max(0, total - checked);

      const pname = prj.name || prj.project_code || "‚Äî";
      hudProjectName.textContent = `D·ª∞ √ÅN: ${String(pname).toUpperCase()}`;

      kpiTotal.textContent = String(total);
      kpiWon.textContent = String(won);
      kpiTied.textContent = String(tied);
      kpiPending.textContent = String(pending);

      const now = new Date();
      hudUpdatedAt.textContent = `C·∫≠p nh·∫≠t: ${now.toLocaleTimeString("vi-VN")}`;
    }

    // ‚úÖ Tab tr√°i: top 6 "m·ªõi nh·∫•t" theo updated_at DESC
    function renderLatestFromSnapshot(js){
      const winners = Array.isArray(js.winners) ? js.winners : [];
      const tied = Array.isArray(js.tied) ? js.tied : [];

      const pool = [];
      for (const w of winners) pool.push({type:"WON", item:w, ts: updatedAtOf(w)});
      for (const t of tied) pool.push({type:"TIED", item:t, ts: updatedAtOf(t)});

      pool.sort((a,b)=>{
        if (b.ts !== a.ts) return b.ts - a.ts;
        const aid = Number(a.item?.lot_id ?? 0);
        const bid = Number(b.item?.lot_id ?? 0);
        if (aid !== bid) return aid - bid;
        return String(a.item?.lot_code||"").localeCompare(String(b.item?.lot_code||""), "vi");
      });

      const top = pool.slice(0, LATEST_SLOTS);

      let html = "";
      for (const x of top){
        // ‚úÖ showLiveDot = true ch·ªâ cho panel tr√°i
        html += (x.type === "TIED") ? cardTIED(x.item, true) : cardWON(x.item, true);
      }
      const remain = Math.max(0, LATEST_SLOTS - top.length);
      for (let i=0;i<remain;i++) html += placeholderCard();
      latestBody.innerHTML = html;
    }

    // ‚úÖ Panel ph·∫£i: MERGE winners+tied -> sort lot_id ASC -> scroll
    function renderAllList(js){
      const winners = Array.isArray(js.winners) ? js.winners : [];
      const tied    = Array.isArray(js.tied) ? js.tied : [];

      const all = [];
      for (const w of winners) all.push({ type:"WON",  item:w });
      for (const t of tied)    all.push({ type:"TIED", item:t });

      all.sort((a,b)=>{
        const aid = Number(a.item?.lot_id ?? 0);
        const bid = Number(b.item?.lot_id ?? 0);
        if (aid !== bid) return aid - bid;

        const ac = String(a.item?.lot_code || "");
        const bc = String(b.item?.lot_code || "");
        const ccmp = ac.localeCompare(bc, "vi");
        if (ccmp !== 0) return ccmp;

        const ap = (a.type === "WON") ? 0 : 1;
        const bp = (b.type === "WON") ? 0 : 1;
        return ap - bp;
      });

      if (!all.length){
        scrollTrack.innerHTML = `
          <div style="padding:14px; color:rgba(255,255,255,.72);">
            <div style="font-weight:1000; letter-spacing:.55px; margin-bottom:8px; text-transform:uppercase;">
              Ch∆∞a c√≥ l√¥ n√†o ƒë∆∞·ª£c k·∫øt lu·∫≠n
            </div>
            <div style="font-size:12px; color:rgba(255,255,255,.62); line-height:1.65;">
              Khi c√≥ l√¥ TR√öNG ho·∫∑c v√†o B·ªêC THƒÇM, danh s√°ch s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y v√† t·ª± ch·∫°y theo v√≤ng ƒë·ªÉ kh√°ch theo d√µi.
            </div>
          </div>
        `;
        loopingEnabled = false;
        trackHeight = 0;
        scrollY = 0;
        scrollTrack.style.transform = `translateY(0px)`;
        return;
      }

      const prevHeight = trackHeight || 0;
      const prevScroll = scrollY || 0;

      const htmlHalf = all.map(x=>{
        // ‚úÖ panel ph·∫£i kh√¥ng c√≥ live dot
        const card = (x.type === "TIED") ? cardTIED(x.item, false) : cardWON(x.item, false);
        return `<div style="margin-bottom:10px">${card}</div>`;
      }).join("");

      scrollTrack.innerHTML = htmlHalf + htmlHalf;

      requestAnimationFrame(()=>{
        const children = Array.from(scrollTrack.children);
        const half = Math.floor(children.length / 2);

        let h = 0;
        for (let i=0;i<half;i++){
          h += children[i].getBoundingClientRect().height;
        }
        trackHeight = h;

        if (trackHeight > 0){
          if (prevHeight > 0){
            const ratio = prevScroll / prevHeight;
            scrollY = ratio * trackHeight;
          } else {
            scrollY = prevScroll;
          }
          scrollY = ((scrollY % trackHeight) + trackHeight) % trackHeight;
          scrollTrack.style.transform = `translateY(${-scrollY}px)`;
          loopingEnabled = true;
        } else {
          loopingEnabled = false;
          scrollY = 0;
          scrollTrack.style.transform = `translateY(0px)`;
        }
      });
    }

    // =========================
    // Smooth loop scroll
    // =========================
    function showCycleIndicator(){
      cycleIndicator.classList.add("show");
      setTimeout(()=>cycleIndicator.classList.remove("show"), 900);
    }

    function tick(ts){
      if (!lastRAF) lastRAF = ts;
      const dt = Math.min(40, ts - lastRAF);
      lastRAF = ts;

      if (loopingEnabled && trackHeight > 0){
        scrollY += (scrollSpeed * dt);
        if (scrollY >= trackHeight){
          scrollY = scrollY - trackHeight;
          showCycleIndicator();
        }
        scrollTrack.style.transform = `translateY(${-scrollY}px)`;
      }
      requestAnimationFrame(tick);
    }

    // =========================
    // Polling
    // =========================
    async function fetchSnapshot(){
      if (!PROJECT_ID || PROJECT_ID <= 0){
        noProjectOverlay.style.display = "flex";
        hudStatus.textContent = "Ch∆∞a ch·ªçn d·ª± √°n";
        hudDot.style.background = "var(--danger)";
        hudDot.style.boxShadow = "0 0 18px rgba(255,77,109,.60)";
        latestBody.innerHTML = placeholderCard()+placeholderCard()+placeholderCard()+placeholderCard()+placeholderCard()+placeholderCard();
        renderAllList({winners:[], tied:[]});
        return;
      }
      noProjectOverlay.style.display = "none";

      try{
        hudStatus.textContent = `ƒêang c·∫≠p nh·∫≠t m·ªói ${(POLL_MS/1000).toFixed(0)}s`;
        hudDot.style.background = "var(--wonA)";
        hudDot.style.boxShadow = "0 0 20px rgba(0,255,213,.60), 0 0 40px rgba(0,255,213,.25)";

        const url = `/auction/counting/api/display/snapshot?project_id=${encodeURIComponent(PROJECT_ID)}`;
        const r = await fetch(url, {headers: {"Accept":"application/json"}});
        const js = await r.json();

        if (!js || js.ok !== true){
          hudStatus.textContent = "L·ªói t·∫£i d·ªØ li·ªáu";
          hudDot.style.background = "var(--danger)";
          hudDot.style.boxShadow = "0 0 18px rgba(255,77,109,.60)";
          return;
        }

        renderTop(js);

        if (!js.session){
          latestBody.innerHTML = placeholderCard()+placeholderCard()+placeholderCard()+placeholderCard()+placeholderCard()+placeholderCard();
          renderAllList({winners:[], tied:[]});
          return;
        }

        renderLatestFromSnapshot(js);
        renderAllList(js);

      }catch(e){
        hudStatus.textContent = "M·∫•t k·∫øt n·ªëi ‚Äì ƒëang th·ª≠ l·∫°i‚Ä¶";
        hudDot.style.background = "var(--danger)";
        hudDot.style.boxShadow = "0 0 18px rgba(255,77,109,.60)";
      }
    }

    (function init(){
      requestAnimationFrame(tick);
      latestBody.innerHTML = placeholderCard()+placeholderCard()+placeholderCard()+placeholderCard()+placeholderCard()+placeholderCard();
      renderAllList({winners:[], tied:[]});
      fetchSnapshot();
      setInterval(fetchSnapshot, POLL_MS);
    })();
  </script>
</body>
</html>
