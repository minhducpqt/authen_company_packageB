{% extends "base.html" %}
{% block title %}Trình chiếu kiểm phiếu{% endblock %}

{% block content %}
{% set projects = projects or [] %}
{% set project_id = project_id %}
{% set project_key = project or "" %}
{% set project_obj = project_obj or {} %}

<div class="mb-5">
  <div class="flex items-start justify-between gap-3 flex-wrap">
    <div>
      <h1 class="text-2xl font-semibold text-slate-900 flex items-center gap-2">
        <i class="ri-slideshow-3-line text-indigo-600 text-3xl"></i>
        Trình chiếu kiểm phiếu
      </h1>
      <p class="text-slate-500 text-sm mt-1">
        Tự cập nhật mỗi <b>5 giây</b>. Chỉ hiển thị danh sách <b>WON</b> và các lô <b>TIED</b> đang chờ bốc thăm.
      </p>
    </div>

    <div class="flex items-center gap-2">
      <a href="/auction/counting?project={{ project_key|urlencode }}" class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-slate-700 text-sm font-medium inline-flex items-center gap-2">
        <i class="ri-settings-3-line"></i> Màn kiểm phiếu
      </a>
      <button id="btnFull" class="px-3 py-2 rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-sm font-medium inline-flex items-center gap-2" type="button">
        <i class="ri-fullscreen-line"></i> Fullscreen
      </button>
    </div>
  </div>
</div>

<div class="bg-white border border-slate-200 rounded-2xl shadow-sm mb-4">
  <div class="p-4 md:p-5 grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
    <div class="md:col-span-7">
      <label class="block text-sm font-medium text-slate-700 mb-1">Chọn dự án (để trình chiếu)</label>
      <div class="relative">
        <select id="projectSelect" class="w-full rounded-xl border-slate-200 focus:border-indigo-500 focus:ring-indigo-500 text-sm">
          <option value="">— Chọn dự án —</option>
          {% for p in projects %}
            {% set code = (p.project_code or p.code or "") %}
            {% set pid = (p.id or p.project_id or "") %}
            {% set key = (code if code else pid) %}
            {% set st = (p.status or "") %}
            <option value="{{ key }}" {% if project_key and (project_key|string)==(key|string) %}selected{% endif %}>
              {{ code or ("#" ~ pid) }} — {{ p.name or "(no name)" }}{% if st %} ({{ st }}){% endif %}
            </option>
          {% endfor %}
        </select>
        <div class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none">
          <i class="ri-arrow-down-s-line"></i>
        </div>
      </div>
      <div class="text-xs text-slate-500 mt-1">
        Nếu chưa chọn dự án, hệ thống sẽ không tải dữ liệu.
      </div>
    </div>

    <div class="md:col-span-5 flex items-center gap-2 justify-end">
      <div class="text-xs text-slate-500 text-right">
        <div>Dự án: <b id="projName">{{ project_obj.name or "—" }}</b></div>
        <div>Cập nhật: <b id="lastUpdated">—</b></div>
      </div>
      <button id="btnReload" type="button" class="px-3 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium inline-flex items-center gap-2">
        <i class="ri-refresh-line"></i> Tải ngay
      </button>
    </div>
  </div>

  <div class="px-4 md:px-5 pb-4">
    <div class="flex flex-wrap items-center gap-2 text-sm">
      <span class="inline-flex items-center gap-2 px-3 py-1 rounded-xl bg-slate-50 border border-slate-200 text-slate-700">
        <i class="ri-stack-line text-slate-500"></i>
        Tổng lô: <b id="sumTotal">—</b>
      </span>
      <span class="inline-flex items-center gap-2 px-3 py-1 rounded-xl bg-slate-50 border border-slate-200 text-slate-700">
        <i class="ri-checkbox-circle-line text-slate-500"></i>
        Đã xử lý: <b id="sumChecked">—</b>
      </span>
      <span class="inline-flex items-center gap-2 px-3 py-1 rounded-xl bg-emerald-50 border border-emerald-100 text-emerald-700">
        <i class="ri-trophy-line"></i>
        WON: <b id="sumWon">—</b>
      </span>
      <span class="inline-flex items-center gap-2 px-3 py-1 rounded-xl bg-amber-50 border border-amber-100 text-amber-700">
        <i class="ri-group-line"></i>
        TIED: <b id="sumTied">—</b>
      </span>
    </div>
  </div>
</div>

<div class="grid grid-cols-1 xl:grid-cols-12 gap-4">
  <div class="xl:col-span-7 bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden">
    <div class="px-4 md:px-5 py-3 border-b border-slate-100 flex items-center justify-between">
      <div class="text-sm font-semibold text-slate-800">Danh sách trúng (WON)</div>
      <div class="text-xs text-slate-500">Hiển thị theo thứ tự mã lô</div>
    </div>
    <div class="overflow-auto max-h-[70vh]">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-50 text-slate-600">
          <tr>
            <th class="text-left px-4 py-3 font-semibold w-[140px]">Mã lô</th>
            <th class="text-left px-4 py-3 font-semibold min-w-[240px]">Tên lô</th>
            <th class="text-left px-4 py-3 font-semibold w-[180px]">Giá cao nhất</th>
            <th class="text-left px-4 py-3 font-semibold min-w-[240px]">Khách trúng</th>
            <th class="text-left px-4 py-3 font-semibold w-[160px]">Bốc thăm</th>
          </tr>
        </thead>
        <tbody id="wonTbody">
          <tr>
            <td class="px-4 py-6 text-slate-500" colspan="5">Chưa có dữ liệu.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="xl:col-span-5 bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden">
    <div class="px-4 md:px-5 py-3 border-b border-slate-100 flex items-center justify-between">
      <div class="text-sm font-semibold text-slate-800">Các lô đang hòa (TIED)</div>
      <div class="text-xs text-slate-500">Chờ bốc thăm</div>
    </div>

    <div class="p-4 md:p-5 space-y-3 overflow-auto max-h-[70vh]" id="tiedBox">
      <div class="text-sm text-slate-500">Chưa có dữ liệu.</div>
    </div>
  </div>
</div>

<div id="toast" class="fixed bottom-4 right-4 z-[80] hidden">
  <div class="max-w-md bg-slate-900 text-white px-4 py-3 rounded-2xl shadow-lg text-sm flex items-start gap-2">
    <i class="ri-information-line text-lg mt-0.5"></i>
    <div class="min-w-0">
      <div class="font-semibold" id="toastTitle">Thông báo</div>
      <div class="opacity-90 mt-0.5 whitespace-pre-line" id="toastMsg">—</div>
    </div>
    <button id="toastClose" class="ml-2 opacity-80 hover:opacity-100">
      <i class="ri-close-line"></i>
    </button>
  </div>
</div>

<script>
(function(){
  const el = (id)=>document.getElementById(id);
  const PROJECT_ID = {{ project_id or 'null' }};
  const PROJECT_KEY = "{{ (project_key or '')|e }}";

  function toast(title,msg){
    el("toastTitle").textContent = title || "Thông báo";
    el("toastMsg").textContent = msg || "";
    el("toast").classList.remove("hidden");
  }
  el("toastClose").addEventListener("click", ()=> el("toast").classList.add("hidden"));

  // project select navigation
  el("projectSelect").addEventListener("change", ()=>{
    const v = el("projectSelect").value || "";
    const url = new URL(window.location.href);
    if(v) url.searchParams.set("project", v);
    else url.searchParams.delete("project");
    window.location.href = url.toString();
  });

  el("btnFull").addEventListener("click", ()=>{
    const d = document.documentElement;
    if(!document.fullscreenElement){
      d.requestFullscreen?.().catch(()=>{});
    }else{
      document.exitFullscreen?.().catch(()=>{});
    }
  });

  function fmtNum(n){
    if(n===null || n===undefined || n==="") return "—";
    const x = Number(String(n).replaceAll(",","").trim());
    if(!isFinite(x)) return String(n);
    return x.toLocaleString("en-US");
  }

  function setUpdatedNow(){
    const d = new Date();
    el("lastUpdated").textContent = d.toLocaleString();
  }

  function renderSnapshot(js){
    const sum = js.summary || {};
    el("sumTotal").textContent = String(sum.total_lots ?? "—");
    el("sumChecked").textContent = String(sum.checked ?? "—");
    el("sumWon").textContent = String(sum.won ?? "—");
    el("sumTied").textContent = String(sum.tied ?? "—");

    // WON table
    const won = js.winners || [];
    const wonTbody = el("wonTbody");
    wonTbody.innerHTML = "";
    if(!won.length){
      wonTbody.innerHTML = `<tr><td class="px-4 py-6 text-slate-500" colspan="5">Chưa có kết quả WON.</td></tr>`;
    }else{
      won.forEach(r=>{
        const isDraw = !!r.is_lucky_draw;
        const tr = document.createElement("tr");
        tr.className = "border-t border-slate-100";
        tr.innerHTML = `
          <td class="px-4 py-3 align-top">
            <div class="font-semibold text-slate-900">${r.lot_code || ""}</div>
          </td>
          <td class="px-4 py-3 align-top">
            <div class="text-slate-900 font-medium">${r.lot_name || ""}</div>
          </td>
          <td class="px-4 py-3 align-top tabular-nums text-slate-900 font-semibold">
            ${fmtNum(r.highest_price_vnd)} VND
          </td>
          <td class="px-4 py-3 align-top">
            <div class="text-slate-900 font-semibold">${r.full_name || ""}</div>
            <div class="text-xs text-slate-500 mt-1">Phone: ${r.phone_masked || "—"} • ID: #${r.customer_id || "—"}</div>
          </td>
          <td class="px-4 py-3 align-top">
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-semibold
              ${isDraw ? "bg-emerald-50 border border-emerald-100 text-emerald-700" : "bg-slate-50 border border-slate-200 text-slate-700"}">
              <i class="${isDraw ? "ri-dice-line" : "ri-checkbox-circle-line"}"></i>
              ${isDraw ? "CÓ" : "KHÔNG"}
            </span>
          </td>
        `;
        wonTbody.appendChild(tr);
      });
    }

    // TIED cards
    const tied = js.tied || [];
    const tiedBox = el("tiedBox");
    tiedBox.innerHTML = "";
    if(!tied.length){
      tiedBox.innerHTML = `<div class="text-sm text-slate-500">Không có lô TIED.</div>`;
    }else{
      tied.forEach(t=>{
        const div = document.createElement("div");
        div.className = "p-4 rounded-2xl border border-amber-200 bg-amber-50";
        const cands = (t.candidates || []);
        const list = cands.map(c=>{
          return `
            <div class="flex items-center justify-between gap-2 py-1">
              <div class="min-w-0">
                <div class="text-sm font-semibold text-slate-900 truncate">${c.full_name || ""}</div>
                <div class="text-xs text-slate-600">Phone: ${c.phone_masked || "—"} • ID: #${c.customer_id || "—"}</div>
              </div>
            </div>
          `;
        }).join("");

        div.innerHTML = `
          <div class="flex items-start justify-between gap-2">
            <div class="min-w-0">
              <div class="text-sm font-bold text-amber-800">Lô ${t.lot_code || ""}</div>
              <div class="text-xs text-slate-600 mt-0.5">${t.lot_name || ""}</div>
            </div>
            <div class="text-right">
              <div class="text-xs text-slate-500">Giá cao nhất</div>
              <div class="text-sm font-bold text-slate-900 tabular-nums">${fmtNum(t.highest_price_vnd)} VND</div>
            </div>
          </div>

          <div class="mt-3 text-xs font-semibold text-slate-700">Danh sách hòa (${cands.length})</div>
          <div class="mt-2 divide-y divide-amber-200">
            ${list || `<div class="text-sm text-slate-500 py-2">—</div>`}
          </div>
        `;
        tiedBox.appendChild(div);
      });
    }
  }

  async function fetchSnapshot(){
    if(!PROJECT_ID){
      return;
    }
    const url = `/auction/counting/api/display/snapshot?project_id=${encodeURIComponent(PROJECT_ID)}`;
    try{
      const r = await fetch(url, {headers: {"Accept":"application/json"}});
      const js = await r.json();
      if(!r.ok || !js || js.ok!==true){
        throw new Error((js && (js.detail || js.error)) || ("HTTP " + r.status));
      }
      renderSnapshot(js);
      setUpdatedNow();
    }catch(e){
      toast("Lỗi", "Không tải được snapshot.\n" + (e.message || e));
    }
  }

  el("btnReload").addEventListener("click", fetchSnapshot);

  // Polling 5s (fixed as requested)
  if(PROJECT_ID){
    fetchSnapshot();
    setInterval(fetchSnapshot, 5000);
  }else{
    toast("Chưa chọn dự án", "Hãy chọn dự án để trình chiếu.");
  }
})();
</script>
{% endblock %}
