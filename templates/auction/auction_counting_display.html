{# templates/auction/auction_counting_display.html #}
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{{ title or "Tr√¨nh chi·∫øu ki·ªÉm phi·∫øu" }}</title>

  <style>
    :root{
      --bg0:#04050a;
      --bg1:#070816;

      --glass: rgba(255,255,255,.05);
      --glass2: rgba(255,255,255,.075);
      --stroke: rgba(255,255,255,.11);
      --stroke2: rgba(255,255,255,.16);

      --text: rgba(255,255,255,.93);
      --muted: rgba(255,255,255,.62);

      --wonA:#00ffd5;
      --wonB:#00a7ff;

      --tiedA:#ffd86a;
      --tiedB:#ff4bd8;

      --pending:#cfcfd6;
      --danger:#ff4d6d;

      --radius: 22px;
      --hudH: 76px;
      --footerH: 34px;

      --cardH: 160px;
      --cardPad: 13px;
    }

    *{box-sizing:border-box}
    html,body{height:100%;}
    body{
      margin:0;
      color:var(--text);
      background:
        radial-gradient(1200px 680px at 18% 12%, rgba(0,255,213,.16), transparent 58%),
        radial-gradient(980px 620px at 84% 18%, rgba(255,77,216,.13), transparent 56%),
        radial-gradient(900px 560px at 62% 90%, rgba(0,167,255,.10), transparent 58%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    .fx-grid{
      position:fixed; inset:0; pointer-events:none; z-index:0;
      background:
        linear-gradient(rgba(255,255,255,.06) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.05) 1px, transparent 1px);
      background-size: 44px 44px, 44px 44px;
      opacity:.09;
      mix-blend-mode:overlay;
      filter: blur(.15px);
    }
    .fx-scan{
      position:fixed; inset:-60% 0 0 0; pointer-events:none; z-index:0;
      background: linear-gradient(180deg, transparent, rgba(255,255,255,.14), transparent);
      opacity:.12;
      animation: scan 7.8s linear infinite;
      filter: blur(.2px);
    }
    @keyframes scan{
      0%{ transform: translateY(-30%); }
      100%{ transform: translateY(150%); }
    }
    .fx-glow{
      position:fixed; inset:0; pointer-events:none; z-index:0;
      background:
        radial-gradient(900px 420px at 25% 30%, rgba(0,255,213,.10), transparent 60%),
        radial-gradient(860px 420px at 75% 70%, rgba(255,77,216,.09), transparent 60%);
      opacity:.9;
    }

    /* TOP HUD */
    .hud{
      position:fixed; top:0; left:0; right:0;
      height:var(--hudH);
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 16px;
      z-index:20;
      backdrop-filter: blur(16px);
      background: linear-gradient(180deg, rgba(10,12,24,.90), rgba(10,12,24,.54));
      border-bottom:1px solid rgba(255,255,255,.12);
      box-shadow: 0 18px 70px rgba(0,0,0,.35);
    }
    .hud-left{min-width:0}
    .hud-title{
      font-weight:950;
      letter-spacing:.5px;
      font-size:18px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-shadow: 0 0 28px rgba(0,255,213,.14);
    }
    .hud-sub{
      margin-top:5px;
      font-size:12px;
      color:rgba(255,255,255,.65);
      display:flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: var(--wonA);
      box-shadow:0 0 20px rgba(0,255,213,.60), 0 0 40px rgba(0,255,213,.25);
    }
    .sep{opacity:.55}

    .hud-right{display:flex; gap:10px; align-items:stretch;}
    .kpi{
      width:118px;
      padding:9px 11px;
      border-radius:16px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow:
        0 0 26px rgba(255,255,255,.06),
        inset 0 1px 0 rgba(255,255,255,.08);
      display:flex; flex-direction:column; justify-content:center;
    }
    .kpi-num{font-size:22px; font-weight:950; line-height:1;}
    .kpi-lbl{margin-top:4px; font-size:11px; color:rgba(255,255,255,.62); letter-spacing:.2px;}
    .kpi-total .kpi-num{ text-shadow:0 0 26px rgba(255,255,255,.10); }
    .kpi-won  .kpi-num{ color:rgba(0,255,213,.96); text-shadow:0 0 26px rgba(0,255,213,.28); }
    .kpi-tied .kpi-num{ color:rgba(255,216,106,.98); text-shadow:0 0 26px rgba(255,216,106,.22); }
    .kpi-pend .kpi-num{ color:rgba(210,210,220,.92); text-shadow:0 0 26px rgba(255,255,255,.14); }

    /* LAYOUT */
    .wrap{
      position:relative;
      z-index:10;
      height:100%;
      padding-top: calc(var(--hudH) + 12px);
      padding-bottom: calc(var(--footerH) + 10px);
      padding-left: 16px;
      padding-right: 16px;
      display:grid;
      grid-template-columns: 1.05fr 1fr;
      gap:12px;
    }

    .panel{
      border-radius: 22px;
      background: rgba(255,255,255,.048);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow:
        0 28px 90px rgba(0,0,0,.40),
        inset 0 1px 0 rgba(255,255,255,.07);
      overflow:hidden;
      position:relative;
    }
    .panel::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(800px 220px at 20% 0%, rgba(0,255,213,.10), transparent 60%);
      opacity:.7;
      pointer-events:none;
    }

    .panel-head{
      display:flex; align-items:center; justify-content:space-between;
      padding:11px 13px;
      border-bottom: 1px solid rgba(255,255,255,.085);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.02));
      backdrop-filter: blur(10px);
    }
    .panel-title{
      font-weight:950;
      letter-spacing:.4px;
      font-size:13px;
      color:rgba(255,255,255,.90);
      display:flex; align-items:center; gap:10px;
    }
    .badge{
      font-size:11px;
      padding:5px 9px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      color:rgba(255,255,255,.76);
      background: rgba(255,255,255,.05);
    }

    .latest-body{
      padding:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-content:start;
      min-height: 240px;
    }

    .all-body{
      position:relative;
      height: calc(100% - 50px);
      overflow:hidden;
    }
    .scroll-viewport{
      position:absolute;
      inset: 0;
      padding:12px;
      overflow:hidden;
    }
    .scroll-track{
      position:absolute;
      left:12px; right:12px; top:12px;
      will-change: transform;
    }

    .cycle-indicator{
      position:absolute;
      left:12px; right:12px; top:12px;
      display:flex;
      justify-content:center;
      pointer-events:none;
      opacity:0;
      transform: translateY(-10px);
      transition: opacity .22s ease, transform .22s ease;
      z-index:5;
    }
    .cycle-indicator.show{ opacity:1; transform: translateY(0); }
    .cycle-pill{
      padding:8px 14px;
      border-radius:999px;
      font-weight:950;
      letter-spacing:.35px;
      font-size:12px;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(12px);
      box-shadow: 0 0 26px rgba(0,255,213,.16);
      animation: pulse 900ms ease-in-out;
    }
    @keyframes pulse{
      0%{ transform: scale(.98); opacity:.8; }
      50%{ transform: scale(1.02); opacity:1; }
      100%{ transform: scale(1.0); opacity:1; }
    }

    /* CARD */
    .card{
      height: var(--cardH);
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(900px 240px at 20% 10%, rgba(255,255,255,.08), transparent 65%),
        rgba(10,12,24,.46);
      box-shadow:
        0 18px 70px rgba(0,0,0,.40),
        inset 0 1px 0 rgba(255,255,255,.06);
      position:relative;
      overflow:hidden;
      transform: translateZ(0);
    }

    /* sheen */
    .card::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.12), transparent);
      transform: translateX(-70%);
      opacity:.10;
      animation: sheen 3.8s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes sheen{
      0%{ transform: translateX(-70%); opacity:.06; }
      55%{ opacity:.14; }
      100%{ transform: translateX(130%); opacity:.06; }
    }

    /* stronger status glow layers */
    .card.won::before,
    .card.tied::before{
      content:"";
      position:absolute; inset:-2px;
      border-radius: calc(var(--radius) + 2px);
      pointer-events:none;
      opacity:.0;
      filter: blur(0px);
      transition: opacity .25s ease;
    }
    .card.won::before{
      background:
        radial-gradient(700px 220px at 12% 10%, rgba(0,255,213,.22), transparent 60%),
        radial-gradient(680px 220px at 88% 75%, rgba(0,167,255,.18), transparent 62%);
    }
    .card.tied::before{
      background:
        radial-gradient(700px 220px at 12% 10%, rgba(255,216,106,.22), transparent 60%),
        radial-gradient(680px 220px at 88% 75%, rgba(255,77,216,.18), transparent 62%);
    }
    .card.won{ animation: glowWon 2.8s ease-in-out infinite; }
    .card.tied{ animation: glowTied 2.8s ease-in-out infinite; }
    @keyframes glowWon{
      0%,100%{ box-shadow: 0 18px 74px rgba(0,255,213,.18), 0 18px 74px rgba(0,167,255,.12), inset 0 1px 0 rgba(255,255,255,.06); }
      50%{ box-shadow: 0 22px 92px rgba(0,255,213,.26), 0 20px 84px rgba(0,167,255,.18), inset 0 1px 0 rgba(255,255,255,.07); }
    }
    @keyframes glowTied{
      0%,100%{ box-shadow: 0 18px 74px rgba(255,216,106,.20), 0 18px 74px rgba(255,77,216,.12), inset 0 1px 0 rgba(255,255,255,.06); }
      50%{ box-shadow: 0 22px 92px rgba(255,216,106,.28), 0 20px 84px rgba(255,77,216,.18), inset 0 1px 0 rgba(255,255,255,.07); }
    }
    .card.won:hover::before,
    .card.tied:hover::before{ opacity:.85; }

    .card-inner{
      position:relative;
      height:100%;
      padding: var(--cardPad);
      display:flex;
      flex-direction:column;
      gap:7px;
    }
    .row{ display:flex; align-items:baseline; justify-content:space-between; gap:10px; }
    .lot-code{
      font-weight:1000;
      letter-spacing: 1.0px;
      font-size:22px;
      line-height:1;
      text-transform:uppercase;
      white-space:nowrap;
    }

    .status-stack{
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .status-chip{
      font-size:11px;
      font-weight:950;
      letter-spacing:.35px;
      padding:6px 10px;
      border-radius:999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      white-space:nowrap;
    }

    .tied-count{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      min-width: 54px;
      padding:6px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,216,106,.34);
      background: rgba(255,216,106,.12);
      box-shadow: 0 0 26px rgba(255,216,106,.18);
      line-height:1;
    }
    .tied-count .n{
      font-size:18px;
      font-weight:1000;
      letter-spacing:.3px;
      color: rgba(255,216,106,.98);
      text-shadow: 0 0 22px rgba(255,216,106,.20);
    }
    .tied-count .lbl{
      margin-top:4px;
      font-size:9px;
      font-weight:950;
      letter-spacing:.4px;
      opacity:.85;
      text-transform:uppercase;
    }

    .price{
      font-size:24px;
      font-weight:1000;
      letter-spacing:.25px;
      line-height:1.05;
      text-shadow: 0 0 26px rgba(255,255,255,.10);
    }
    .price-lbl{
      margin-top:-2px;
      font-size:11px;
      color: rgba(255,255,255,.60);
      letter-spacing:.25px;
      text-transform:uppercase;
    }

    .person{
      margin-top:auto;
      padding-top:8px;
      border-top:1px dashed rgba(255,255,255,.12);
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .name{
      font-weight:950;
      font-size:15px;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .meta{
      display:flex;
      gap:8px;
      font-size:12px;
      color: rgba(255,255,255,.74);
      align-items:center;
      flex-wrap:wrap;
    }
    .meta span{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      max-width: 100%;
    }
    .meta .k{opacity:.85}
    .meta .v{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      letter-spacing:.35px;
      white-space:nowrap;
      overflow:visible;
      text-overflow:clip;
    }

    /* WON */
    .card.won{
      border-color: rgba(0,255,213,.40);
    }
    .card.won .lot-code{
      color: rgba(0,255,213,.97);
      text-shadow: 0 0 30px rgba(0,255,213,.26);
    }
    .card.won .status-chip{
      color: rgba(0,255,213,.96);
      border-color: rgba(0,255,213,.34);
      background: rgba(0,255,213,.12);
      box-shadow: 0 0 26px rgba(0,255,213,.22);
    }

    /* TIED */
    .card.tied{
      border-color: rgba(255,216,106,.40);
      background:
        radial-gradient(900px 240px at 20% 10%, rgba(255,216,106,.16), transparent 65%),
        radial-gradient(900px 260px at 80% 30%, rgba(255,77,216,.14), transparent 60%),
        rgba(10,12,24,.46);
    }
    .card.tied .lot-code{
      color: rgba(255,216,106,.98);
      text-shadow: 0 0 30px rgba(255,216,106,.22);
    }
    .card.tied .status-chip{
      color: rgba(255,216,106,.96);
      border-color: rgba(255,216,106,.34);
      background: rgba(255,216,106,.12);
      box-shadow: 0 0 26px rgba(255,216,106,.20);
    }

    /* TIED marquee */
    .marquee{
      margin-top:auto;
      border-top:1px dashed rgba(255,255,255,.12);
      padding-top:8px;
      overflow:hidden;
      position:relative;
    }
    .marquee-track{
      display:inline-flex;
      gap:14px;
      white-space:nowrap;
      will-change: transform;
      animation: marquee 24s linear infinite;
    }
    @keyframes marquee{
      0%{ transform: translateX(0); }
      100%{ transform: translateX(-50%); }
    }
    .cand{
      display:inline-flex;
      align-items:center;
      gap:10px;
      font-size:12px;
      color: rgba(255,255,255,.84);
      padding:6px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .cand b{ font-weight:950; color: rgba(255,255,255,.95); }
    .cand i{
      font-style:normal;
      opacity:.9;
      padding-left:8px;
      border-left:1px solid rgba(255,255,255,.12);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      letter-spacing:.25px;
    }

    /* Placeholder */
    .ph{
      height: var(--cardH);
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.11);
      background: rgba(255,255,255,.04);
      position:relative;
      overflow:hidden;
    }
    .ph::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.12), transparent);
      transform: translateX(-70%);
      animation: shimmer 1.7s ease-in-out infinite;
      opacity:.65;
    }
    @keyframes shimmer{
      0%{ transform: translateX(-70%); }
      100%{ transform: translateX(140%); }
    }
    .ph .ph-inner{
      position:relative;
      padding: var(--cardPad);
      height:100%;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .ph-line{
      height:14px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.06);
    }
    .ph-line.big{ height:20px; width:62%; }
    .ph-line.mid{ width:58%; }
    .ph-line.sm{ width:44%; }
    .ph-line.full{ width:100%; }
    .ph .ph-footer{
      margin-top:auto;
      height:42px;
      border-top:1px dashed rgba(255,255,255,.10);
      padding-top:10px;
      display:flex;
      gap:10px;
    }
    .ph-pill{
      height:20px; width:34%;
      border-radius:999px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.06);
    }

    /* No project overlay */
    .center-overlay{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:24px;
      z-index:30;
    }
    .center-box{
      width:min(860px, 92vw);
      border-radius: 24px;
      background: rgba(0,0,0,.38);
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: 0 30px 120px rgba(0,0,0,.52);
      backdrop-filter: blur(16px);
      padding: 18px;
    }
    .center-box h2{ margin:0; font-size:18px; font-weight:1000; letter-spacing:.35px; }
    .center-box p{
      margin:10px 0 0 0;
      color: rgba(255,255,255,.72);
      font-size:12px;
      line-height:1.55;
    }

    /* Footer */
    .footer-marquee{
      position:fixed; left:0; right:0; bottom:0;
      height: var(--footerH);
      z-index:20;
      border-top: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(10,12,24,.28), rgba(10,12,24,.78));
      backdrop-filter: blur(12px);
      overflow:hidden;
    }
    .footer-track{
      position:absolute; left:0; top:0; height:100%;
      display:flex; align-items:center;
      gap:28px;
      padding-left:16px;
      white-space:nowrap;
      color: rgba(255,255,255,.66);
      font-size:12px;
      letter-spacing:.25px;
      animation: foot 18s linear infinite;
    }
    @keyframes foot{
      0%{ transform: translateX(0); }
      100%{ transform: translateX(-50%); }
    }

    @media (max-width: 1100px){
      .wrap{ grid-template-columns: 1fr; }
      .hud-right .kpi{ width:108px; }
    }
  </style>
</head>

<body>
  <div class="fx-glow"></div>
  <div class="fx-grid"></div>
  <div class="fx-scan"></div>

  <div class="hud">
    <div class="hud-left">
      <div class="hud-title" id="hudProjectName">D·ª∞ √ÅN: ‚Äî</div>
      <div class="hud-sub">
        <span class="dot" id="hudDot"></span>
        <span id="hudStatus">ƒêang c·∫≠p nh·∫≠t</span>
        <span class="sep">‚Ä¢</span>
        <span id="hudUpdatedAt">‚Äî</span>
      </div>
    </div>

    <div class="hud-right">
      <div class="kpi kpi-total">
        <div class="kpi-num" id="kpiTotal">0</div>
        <div class="kpi-lbl">T·ªïng l√¥</div>
      </div>
      <div class="kpi kpi-won">
        <div class="kpi-num" id="kpiWon">0</div>
        <div class="kpi-lbl">ƒê√£ tr√∫ng</div>
      </div>
      <div class="kpi kpi-tied">
        <div class="kpi-num" id="kpiTied">0</div>
        <div class="kpi-lbl">Ch·ªù b·ªëc thƒÉm</div>
      </div>
      <div class="kpi kpi-pend">
        <div class="kpi-num" id="kpiPending">0</div>
        <div class="kpi-lbl">ƒêang x·ª≠ l√Ω</div>
      </div>
    </div>
  </div>

  <main class="wrap">
    <section class="panel">
      <div class="panel-head">
        <div class="panel-title"><span style="color:#5ad1ff">‚ñ†</span> K·∫æT QU·∫¢ M·ªöI C·∫¨P NH·∫¨T</div>
        <span class="badge" id="badgeLatest">Top 6</span>
      </div>
      <div class="latest-body" id="latestBody"></div>
    </section>

    <section class="panel">
      <div class="panel-head">
        <div class="panel-title"><span style="color:#4dff9b">‚ñ†</span> T·∫§T C·∫¢ L√î ƒê√É KI·ªÇM</div>
        <span class="badge">T·ª± ch·∫°y theo v√≤ng</span>
      </div>

      <div class="all-body">
        <div class="cycle-indicator" id="cycleIndicator">
          <div class="cycle-pill">B·∫ÆT ƒê·∫¶U V√íNG M·ªöI</div>
        </div>

        <div class="scroll-viewport">
          <div class="scroll-track" id="scrollTrack"></div>
        </div>
      </div>
    </section>

    <div class="center-overlay" id="noProjectOverlay" style="display:none;">
      <div class="center-box">
        <h2>Ch∆∞a ch·ªçn d·ª± √°n ƒë·ªÉ tr√¨nh chi·∫øu</h2>
        <p>
          Trang n√†y c·∫ßn tham s·ªë d·ª± √°n <b>?project=</b> (project_code ho·∫∑c project_id).<br/>
          V√≠ d·ª•: <b>/auction/counting/display?project=KDO01</b> ho·∫∑c <b>?project=123</b>.
        </p>
      </div>
    </div>
  </main>

  <div class="footer-marquee">
    <div class="footer-track">
      ¬©B·∫£n quy·ªÅn ph·∫ßn m·ªÅm: C√¥ng Ty C·ªï Ph·∫ßn Gi·∫£i Ph√°p C√¥ng Ngh·ªá VNTECHX ‚Ä¢
      ¬©B·∫£n quy·ªÅn ph·∫ßn m·ªÅm: C√¥ng Ty C·ªï Ph·∫ßn Gi·∫£i Ph√°p C√¥ng Ngh·ªá VNTECHX ‚Ä¢
      ¬©B·∫£n quy·ªÅn ph·∫ßn m·ªÅm: C√¥ng Ty C·ªï Ph·∫ßn Gi·∫£i Ph√°p C√¥ng Ngh·ªá VNTECHX ‚Ä¢
      ¬©B·∫£n quy·ªÅn ph·∫ßn m·ªÅm: C√¥ng Ty C·ªï Ph·∫ßn Gi·∫£i Ph√°p C√¥ng Ngh·ªá VNTECHX ‚Ä¢
    </div>
  </div>

  <script>
    const PROJECT_ID = {{ (project_id or 0) | int }};
    const POLL_MS = {{ (poll_ms or 2000) | int }};

    function fmtVND(v){
      if (v === null || v === undefined || v === "") return "‚Äî";
      const n = Number(v);
      if (!isFinite(n)) return String(v);
      return n.toLocaleString("vi-VN") + " ƒë";
    }
    function digitsOnly(s){ return String(s || "").replace(/\D/g, ""); }
    function maskLast4(s){
      const d = digitsOnly(s);
      if (!d) return "‚Äî";
      const tail = d.slice(-4);
      const stars = "*".repeat(Math.max(d.length - 4, 6));
      return stars + tail;
    }
    function safeText(s){ return (s === null || s === undefined) ? "" : String(s); }
    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"quot;")   // keep legacy behavior? (fixed below)
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function customerCode(id){
      const n = Number(id);
      if (!isFinite(n) || n <= 0) return "";
      return `C${n}`;
    }

    const hudProjectName = document.getElementById("hudProjectName");
    const hudUpdatedAt   = document.getElementById("hudUpdatedAt");
    const hudStatus      = document.getElementById("hudStatus");
    const hudDot         = document.getElementById("hudDot");

    const kpiTotal   = document.getElementById("kpiTotal");
    const kpiWon     = document.getElementById("kpiWon");
    const kpiTied    = document.getElementById("kpiTied");
    const kpiPending = document.getElementById("kpiPending");

    const latestBody = document.getElementById("latestBody");
    const scrollTrack = document.getElementById("scrollTrack");
    const cycleIndicator = document.getElementById("cycleIndicator");
    const noProjectOverlay = document.getElementById("noProjectOverlay");

    // =========================
    // State
    // =========================
    let lastSeenSig = new Map();      // lot_code -> signature (for "latest changed")
    let latestQueue = [];
    const LATEST_SLOTS = 6;

    // ‚úÖ ch·ªëng gi·ª±t: ch·ªâ rerender panel ph·∫£i khi data th·∫≠t s·ª± ƒë·ªïi (v√† ·ªïn ƒë·ªãnh theo sort)
    let lastAllListSig = "";          // signature of winners+tied list (sorted)
    let lastAllListCount = 0;

    // Scroll state (panel ph·∫£i) ‚Äî gi·ªØ nguy√™n gi·ªØa c√°c poll
    let scrollY = 0;
    let lastRAF = 0;
    let trackHeight = 0;
    let loopingEnabled = false;

    // t·ªëc ƒë·ªô v·ª´a ƒë·ªß ƒë·ªçc
    let scrollSpeed = 0.10;

    // =========================
    // Card renderers
    // =========================
    function cardWON(it){
      const lot = safeText(it.lot_code || "‚Äî").toUpperCase();
      const price = fmtVND(it.highest_price_vnd);
      const name = safeText(it.full_name || "‚Äî");

      const cid = (it.customer_id ?? it.id ?? "");
      const ccode = customerCode(cid);

      const phoneMasked =
        it.phone_masked ? safeText(it.phone_masked) :
        (it.phone ? maskLast4(it.phone) : "‚Äî");

      const codeSpan = ccode
        ? `<span><span class="k">M√£:</span> <span class="v">${escapeHtml(ccode)}</span></span>`
        : "";

      return `
        <div class="card won" data-lot="${escapeHtml(lot)}">
          <div class="card-inner">
            <div class="row">
              <div class="lot-code">${escapeHtml(lot)}</div>
              <div class="status-stack">
                <div class="status-chip">üèÜ TR√öNG</div>
              </div>
            </div>

            <div>
              <div class="price">${escapeHtml(price)}</div>
              <div class="price-lbl">GI√Å TR·∫¢ CAO NH·∫§T</div>
            </div>

            <div class="person">
              <div class="name">${escapeHtml(name)}</div>
              <div class="meta">
                ${codeSpan}
                <span><span class="k">SƒêT:</span> <span class="v">${escapeHtml(phoneMasked)}</span></span>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function cardTIED(it){
      const lot = safeText(it.lot_code || "‚Äî").toUpperCase();
      const price = fmtVND(it.highest_price_vnd);

      const cands = Array.isArray(it.candidates) ? it.candidates : [];
      const cnt = cands.length;

      const candChips = cands.map(c=>{
        const name = safeText(c.full_name || "‚Äî");
        const cid = (c.customer_id ?? c.id ?? "");
        const ccode = customerCode(cid);

        const phoneMasked =
          c.phone_masked ? safeText(c.phone_masked) :
          (c.phone ? maskLast4(c.phone) : "‚Äî");

        const prefix = ccode ? `${escapeHtml(ccode)} ‚Ä¢ ` : "";
        return `<span class="cand"><b>${prefix}${escapeHtml(name)}</b><i>SƒêT ${escapeHtml(phoneMasked)}</i></span>`;
      });

      const joined = candChips.join("");
      const doubled = joined + joined;

      return `
        <div class="card tied" data-lot="${escapeHtml(lot)}">
          <div class="card-inner">
            <div class="row">
              <div class="lot-code">${escapeHtml(lot)}</div>
              <div class="status-stack">
                <div class="status-chip">üéØ B·ªêC THƒÇM</div>
                <div class="tied-count" title="S·ªë ng∆∞·ªùi b·ªëc thƒÉm">
                  <div class="n">${cnt}</div>
                  <div class="lbl">NG∆Ø·ªúI</div>
                </div>
              </div>
            </div>

            <div>
              <div class="price">${escapeHtml(price)}</div>
              <div class="price-lbl">GI√Å TR·∫¢ CAO NH·∫§T</div>
            </div>

            <div class="marquee">
              <div class="marquee-track">
                ${
                  doubled
                  || `<span class="cand"><b>ƒêang ch·ªù danh s√°ch b·ªëc thƒÉm‚Ä¶</b><i>SƒêT ‚Äî</i></span>`
                   + `<span class="cand"><b>ƒêang ch·ªù danh s√°ch b·ªëc thƒÉm‚Ä¶</b><i>SƒêT ‚Äî</i></span>`
                }
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function placeholderCard(){
      return `
        <div class="ph">
          <div class="ph-inner">
            <div class="ph-line big"></div>
            <div class="ph-line mid"></div>
            <div class="ph-line full"></div>
            <div class="ph-line sm"></div>
            <div class="ph-footer">
              <div class="ph-pill"></div>
              <div class="ph-pill"></div>
              <div class="ph-pill"></div>
            </div>
          </div>
        </div>
      `;
    }

    // =========================
    // Signatures (for diff)
    // =========================
    function sigW(w){
      // ch·ªâ l·∫•y tr∆∞·ªùng ·ªïn ƒë·ªãnh ‚Äî tr√°nh "ƒë·ªïi nh·∫π" l√†m gi·∫≠t
      const lot = String(w.lot_code || "").toLowerCase();
      const cid = (w.customer_id ?? w.id ?? "");
      return `W|${lot}|${w.highest_price_vnd ?? ""}|${cid}|${w.full_name||""}|${w.phone_masked||""}`;
    }
    function sigT(t){
      const lot = String(t.lot_code || "").toLowerCase();
      const cands = Array.isArray(t.candidates) ? t.candidates : [];
      // sort ƒë·ªÉ ·ªïn ƒë·ªãnh, tr√°nh reorder khi·∫øn signature ƒë·ªïi
      const ids = cands
        .map(x => String(x.customer_id ?? x.id ?? x.full_name ?? ""))
        .sort()
        .join(",");
      return `T|${lot}|${t.highest_price_vnd ?? ""}|${ids}`;
    }

    // ‚úÖ signature d·ª±a tr√™n list ƒë√£ sort (·ªïn ƒë·ªãnh theo lot_code) => poll ng·∫ßm update, scroll kh√¥ng reset
    function allListSignature(js){
      const winners = (Array.isArray(js.winners) ? js.winners : []).slice();
      const tied = (Array.isArray(js.tied) ? js.tied : []).slice();
      winners.sort((a,b)=> String(a.lot_code||"").localeCompare(String(b.lot_code||""), "vi"));
      tied.sort((a,b)=> String(a.lot_code||"").localeCompare(String(b.lot_code||""), "vi"));

      const parts = [];
      for (const w of winners) parts.push(sigW(w));
      for (const t of tied) parts.push(sigT(t));
      return parts.join("||");
    }

    // =========================
    // Latest logic
    // =========================
    function updateLatestFromSnapshot(js){
      const winners = Array.isArray(js.winners) ? js.winners : [];
      const tied = Array.isArray(js.tied) ? js.tied : [];
      const changed = [];

      for (const w of winners){
        const key = String(w.lot_code || "").toLowerCase();
        if (!key) continue;
        const s = sigW(w);
        const prev = lastSeenSig.get(key);
        if (prev !== s){
          lastSeenSig.set(key, s);
          changed.push({type:"WON", item:w});
        }
      }
      for (const t of tied){
        const key = String(t.lot_code || "").toLowerCase();
        if (!key) continue;
        const s = sigT(t);
        const prev = lastSeenSig.get(key);
        if (prev !== s){
          lastSeenSig.set(key, s);
          changed.push({type:"TIED", item:t});
        }
      }

      for (const ch of changed.reverse()){
        latestQueue.unshift(ch);
      }
      const seen = new Set();
      latestQueue = latestQueue.filter(x=>{
        const key = String(x.item?.lot_code || "").toLowerCase();
        if (!key) return false;
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });
      latestQueue = latestQueue.slice(0, LATEST_SLOTS);

      if (latestQueue.length < LATEST_SLOTS){
        const pool = [];
        for (const w of winners) pool.push({type:"WON", item:w});
        for (const t of tied) pool.push({type:"TIED", item:t});
        for (const x of pool){
          if (latestQueue.length >= LATEST_SLOTS) break;
          const key = String(x.item?.lot_code || "").toLowerCase();
          if (!key) continue;
          if (seen.has(key)) continue;
          seen.add(key);
          latestQueue.push(x);
        }
      }
    }

    // =========================
    // Renderers
    // =========================
    function renderTop(js){
      const prj = js.project || {};
      const sum = js.summary || {};
      const total = Number(sum.total_lots || 0);
      const won = Number(sum.won || 0);
      const tied = Number(sum.tied || 0);
      const checked = Number(sum.checked || 0);
      const pending = Math.max(0, total - checked);

      const pname = prj.name || prj.project_code || "‚Äî";
      hudProjectName.textContent = `D·ª∞ √ÅN: ${String(pname).toUpperCase()}`;

      kpiTotal.textContent = String(total);
      kpiWon.textContent = String(won);
      kpiTied.textContent = String(tied);
      kpiPending.textContent = String(pending);

      const now = new Date();
      hudUpdatedAt.textContent = `C·∫≠p nh·∫≠t: ${now.toLocaleTimeString("vi-VN")}`;
    }

    function renderLatest(){
      let html = "";
      for (const x of latestQueue){
        html += (x.type === "TIED") ? cardTIED(x.item) : cardWON(x.item);
      }
      const remain = Math.max(0, LATEST_SLOTS - latestQueue.length);
      for (let i=0;i<remain;i++) html += placeholderCard();
      latestBody.innerHTML = html;
    }

    // ‚úÖ rebuild track ch·ªâ khi list th·∫≠t s·ª± ƒë·ªïi; v√† QUAN TR·ªåNG: gi·ªØ nguy√™n scrollY (kh√¥ng reset v·ªÅ 0)
    function renderAllListIfChanged(js){
      const winners0 = Array.isArray(js.winners) ? js.winners : [];
      const tied0 = Array.isArray(js.tied) ? js.tied : [];

      const sig = allListSignature(js);
      const totalItems = winners0.length + tied0.length;

      if (sig === lastAllListSig && totalItems === lastAllListCount){
        return; // kh√¥ng ƒë·ªïi => kh√¥ng re-render => marquee/scroll kh√¥ng b·ªã reset
      }
      lastAllListSig = sig;
      lastAllListCount = totalItems;

      // build list ·ªïn ƒë·ªãnh theo lot_code ƒë·ªÉ tr√°nh ‚Äúƒë·∫£o th·ª© t·ª±‚Äù g√¢y gi·∫≠t
      const winners = winners0.slice().sort((a,b)=> String(a.lot_code||"").localeCompare(String(b.lot_code||""), "vi"));
      const tied = tied0.slice().sort((a,b)=> String(a.lot_code||"").localeCompare(String(b.lot_code||""), "vi"));

      const all = [];
      for (const w of winners) all.push({type:"WON", item:w});
      for (const t of tied) all.push({type:"TIED", item:t});

      if (!all.length){
        scrollTrack.innerHTML = `
          <div style="padding:14px; color:rgba(255,255,255,.72);">
            <div style="font-weight:950; letter-spacing:.35px; margin-bottom:8px;">Ch∆∞a c√≥ l√¥ n√†o ƒë∆∞·ª£c k·∫øt lu·∫≠n</div>
            <div style="font-size:12px; color:rgba(255,255,255,.62); line-height:1.55;">
              Khi c√≥ l√¥ TR√öNG ho·∫∑c v√†o B·ªêC THƒÇM, danh s√°ch s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y v√† t·ª± ch·∫°y theo v√≤ng ƒë·ªÉ kh√°ch theo d√µi.
            </div>
          </div>
        `;
        loopingEnabled = false;
        trackHeight = 0;
        scrollY = 0;
        scrollTrack.style.transform = `translateY(0px)`;
        return;
      }

      // ‚úÖ l∆∞u tr·∫°ng th√°i cu·ªôn hi·ªán t·∫°i tr∆∞·ªõc khi rebuild
      const prevHeight = trackHeight || 0;
      const prevScroll = scrollY || 0;

      const htmlHalf = all.map(x=>{
        const card = (x.type === "TIED") ? cardTIED(x.item) : cardWON(x.item);
        return `<div style="margin-bottom:10px">${card}</div>`;
      }).join("");

      scrollTrack.innerHTML = htmlHalf + htmlHalf;

      requestAnimationFrame(()=>{
        const children = Array.from(scrollTrack.children);
        const half = Math.floor(children.length / 2);

        let h = 0;
        for (let i=0;i<half;i++){
          h += children[i].getBoundingClientRect().height;
        }
        trackHeight = h;

        // ‚úÖ gi·ªØ nguy√™n v·ªã tr√≠ cu·ªôn: n·∫øu height ƒë·ªïi, gi·ªØ theo t·ªâ l·ªá; n·∫øu kh√¥ng, gi·ªØ nguy√™n
        if (trackHeight > 0){
          if (prevHeight > 0){
            const ratio = prevScroll / prevHeight;
            scrollY = ratio * trackHeight;
          } else {
            scrollY = prevScroll;
          }
          // ƒë·∫£m b·∫£o n·∫±m trong [0, trackHeight)
          scrollY = ((scrollY % trackHeight) + trackHeight) % trackHeight;
          scrollTrack.style.transform = `translateY(${-scrollY}px)`;
          loopingEnabled = true;
        } else {
          loopingEnabled = false;
          scrollY = 0;
          scrollTrack.style.transform = `translateY(0px)`;
        }
      });
    }

    // =========================
    // Smooth loop scroll
    // =========================
    function showCycleIndicator(){
      cycleIndicator.classList.add("show");
      setTimeout(()=>cycleIndicator.classList.remove("show"), 900);
    }

    function tick(ts){
      if (!lastRAF) lastRAF = ts;
      const dt = Math.min(40, ts - lastRAF);
      lastRAF = ts;

      if (loopingEnabled && trackHeight > 0){
        scrollY += (scrollSpeed * dt);
        if (scrollY >= trackHeight){
          scrollY = scrollY - trackHeight;
          showCycleIndicator();
        }
        scrollTrack.style.transform = `translateY(${-scrollY}px)`;
      }
      requestAnimationFrame(tick);
    }

    // =========================
    // Polling
    // =========================
    async function fetchSnapshot(){
      if (!PROJECT_ID || PROJECT_ID <= 0){
        noProjectOverlay.style.display = "flex";
        hudStatus.textContent = "Ch∆∞a ch·ªçn d·ª± √°n";
        hudDot.style.background = "var(--danger)";
        hudDot.style.boxShadow = "0 0 18px rgba(255,77,109,.60)";
        latestQueue = [];
        renderLatest();
        renderAllListIfChanged({winners:[], tied:[]});
        return;
      }
      noProjectOverlay.style.display = "none";

      try{
        hudStatus.textContent = `ƒêang c·∫≠p nh·∫≠t m·ªói ${(POLL_MS/1000).toFixed(0)}s`;
        hudDot.style.background = "var(--wonA)";
        hudDot.style.boxShadow = "0 0 20px rgba(0,255,213,.60), 0 0 40px rgba(0,255,213,.25)";

        const url = `/auction/counting/api/display/snapshot?project_id=${encodeURIComponent(PROJECT_ID)}`;
        const r = await fetch(url, {headers: {"Accept":"application/json"}});
        const js = await r.json();

        if (!js || js.ok !== true){
          hudStatus.textContent = "L·ªói t·∫£i d·ªØ li·ªáu";
          hudDot.style.background = "var(--danger)";
          hudDot.style.boxShadow = "0 0 18px rgba(255,77,109,.60)";
          return;
        }

        renderTop(js);

        if (!js.session){
          latestQueue = [];
          renderLatest();
          renderAllListIfChanged({winners:[], tied:[]});
          return;
        }

        // c·∫≠p nh·∫≠t latest (tr√°i) v·∫´n ok
        updateLatestFromSnapshot(js);
        renderLatest();

        // ‚úÖ panel ph·∫£i: poll ng·∫ßm update ‚Äî scroll gi·ªØ nguy√™n, ch·ªâ rebuild khi list th·∫≠t s·ª± ƒë·ªïi
        renderAllListIfChanged(js);

      }catch(e){
        hudStatus.textContent = "M·∫•t k·∫øt n·ªëi ‚Äì ƒëang th·ª≠ l·∫°i‚Ä¶";
        hudDot.style.background = "var(--danger)";
        hudDot.style.boxShadow = "0 0 18px rgba(255,77,109,.60)";
      }
    }

    (function init(){
      requestAnimationFrame(tick);
      latestQueue = [];
      renderLatest();
      renderAllListIfChanged({winners:[], tied:[]});
      fetchSnapshot();
      setInterval(fetchSnapshot, POLL_MS);
    })();
  </script>
</body>
</html>
