{% extends "base.html" %}
{% block title %}Hoàn tiền đặt trước{% endblock %}

{% block content %}
{% set rows = (data or {}).get('data') or [] %}
{% set total = (data or {}).get('total') or (rows|length) %}
{% set total_amount_vnd = (data or {}).get('total_amount_vnd') or 0 %}

<div class="mb-6">
  <h1 class="text-2xl font-semibold text-slate-900 flex items-center gap-2">
    <i class="ri-refund-2-line text-indigo-600 text-3xl"></i>
    5.4 Hoàn tiền đặt trước
  </h1>
  <p class="text-slate-500 text-sm mt-1">
    Danh sách hoàn theo dự án — có thể kéo ngang để xem đủ thông tin.
  </p>
</div>

{% if error %}
  <div class="mb-4 bg-rose-50 border border-rose-200 text-rose-700 rounded-xl p-3 text-sm">
    <div class="font-semibold">Lỗi gọi Service A</div>
    <div class="mt-1">status={{ error.status }} | {{ (error.body or {}).get('detail') or error.body }}</div>
  </div>
{% endif %}

<form id="filtersForm" method="get"
      class="bg-white border rounded-2xl shadow-sm p-4 mb-4 flex flex-wrap gap-4 items-end"
      onsubmit="return false;">

  <div class="flex flex-col">
    <label class="text-xs font-semibold text-slate-500 mb-1">Dự án</label>
    <select id="fProject" name="project" class="h-10 rounded-xl border px-3 text-sm min-w-[320px]">
      <option value="">— Chọn dự án —</option>
      {% for p in projects or [] %}
        {% set code = (p.project_code or p.code) %}
        <option value="{{ code }}" {% if code == project %}selected{% endif %}>
          {{ code }} — {{ p.name }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="flex flex-col">
    <label class="text-xs font-semibold text-slate-500 mb-1">Loại danh sách</label>
    {% set cur_eligible = (eligible or 'ELIGIBLE') %}
    <select id="fEligible" name="eligible" class="h-10 rounded-xl border px-3 text-sm w-56">
      <option value="ELIGIBLE" {% if cur_eligible == 'ELIGIBLE' %}selected{% endif %}>Phải hoàn</option>
      <option value="EXCLUDED" {% if cur_eligible == 'EXCLUDED' %}selected{% endif %}>Không hoàn (khách trúng)</option>
      <option value="ALL" {% if cur_eligible == 'ALL' %}selected{% endif %}>Tất cả</option>
    </select>
  </div>

  <div class="flex flex-col">
    <label class="text-xs font-semibold text-slate-500 mb-1">Tín nhiệm</label>
    {% set cur_level = (score_level or 'ALL') %}
    <select id="fScoreLevel" name="score_level" class="h-10 rounded-xl border px-3 text-sm w-56">
      <option value="ALL" {% if cur_level == 'ALL' %}selected{% endif %}>Tất cả</option>
      <option value="HIGH" {% if cur_level == 'HIGH' %}selected{% endif %}>Tín nhiệm cao</option>
      <option value="MEDIUM" {% if cur_level == 'MEDIUM' %}selected{% endif %}>Tín nhiệm TB</option>
      <option value="LOW" {% if cur_level == 'LOW' %}selected{% endif %}>Tín nhiệm thấp</option>
    </select>
  </div>

  <div class="flex flex-col">
    <label class="text-xs font-semibold text-slate-500 mb-1">Tìm kiếm</label>
    <input id="fQ" type="text" name="q" value="{{ q }}"
           class="h-10 rounded-xl border px-3 text-sm min-w-[300px]"
           placeholder="CCCD, tên khách, mã lô, STK...">
  </div>

  <div class="flex flex-col">
    <label class="text-xs font-semibold text-slate-500 mb-1">Số dòng / trang</label>
    <input id="fSize" type="number" name="size" value="{{ size or 500 }}"
           class="h-10 rounded-xl border px-3 text-sm w-28" min="1" max="5000">
  </div>

  <!-- ✅ Local filter -->
  <div class="flex items-center gap-2 pb-1">
    <input id="fMismatchOnly" type="checkbox"
           class="w-4 h-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
    <label for="fMismatchOnly" class="text-sm text-slate-700 font-medium select-none">
      Chỉ hiện <b>TK nhận không trùng tên</b> (lọc local)
    </label>
    <span class="text-xs text-slate-500">(mỗi CCCD chỉ giữ 1 dòng)</span>
  </div>

  <div class="flex items-center gap-3 ml-auto flex-wrap justify-end">
    <button type="button" id="btnResetFilters"
            class="h-10 px-4 rounded-xl border border-slate-300 text-sm font-medium text-slate-700 bg-white hover:bg-slate-50 inline-flex items-center gap-2">
      <i class="ri-refresh-line"></i> Reset
    </button>

    <a id="btnExportXlsx"
       href="{% if project_id %}/auction/refunds/export.xlsx?project_id={{ project_id }}&eligible={{ cur_eligible }}&score_level={{ cur_level }}{% if q %}&q={{ q|urlencode }}{% endif %}{% else %}#{% endif %}"
       class="h-10 px-4 rounded-xl bg-emerald-600 text-white text-sm font-medium hover:bg-emerald-700 inline-flex items-center gap-2 {% if not project_id %}opacity-40 pointer-events-none{% endif %}">
      <i class="ri-file-excel-2-line"></i> Download XLSX
    </a>
  </div>
</form>

<!-- Summary -->
<div class="mb-3 flex flex-wrap items-center gap-2 text-sm text-slate-600">
  {% if project_id %}
    <span><b class="text-slate-900">{{ total }}</b> dòng</span>
    <span class="text-slate-300">•</span>
    <span><b class="text-slate-900 money" data-value="{{ total_amount_vnd }}">—</b> VND</span>
  {% else %}
    Chọn dự án để xem dữ liệu.
  {% endif %}
</div>

<div class="bg-white border rounded-2xl shadow-sm overflow-hidden">
  <div class="overflow-x-auto">
    <table class="min-w-[1400px] w-full text-sm text-slate-700">
      <thead class="bg-slate-50 text-slate-500 border-b">
        <tr>
          <th class="px-4 py-3 text-center font-semibold w-[90px]">Tín nhiệm</th>
          <th class="px-4 py-3 text-left font-semibold">Họ tên</th>
          <th class="px-4 py-3 text-left font-semibold">CCCD</th>
          <th class="px-4 py-3 text-left font-semibold">Lô</th>
          <th class="px-4 py-3 text-right font-semibold">Số tiền hoàn</th>
          <th class="px-4 py-3 text-left font-semibold">Tài khoản nhận</th>
          <th class="px-4 py-3 text-right font-semibold w-[120px]">Chi tiết</th>
          <th class="px-4 py-3 text-left font-semibold">Nội dung CK (chuẩn)</th>
        </tr>
      </thead>

      <tbody class="divide-y divide-slate-100" id="refundTbody">
      {% for r in rows %}
        {% set cccd = (r.customer_cccd or '') %}
        {% set lvl = (r.trust_level or 'LOW') %}
        {% set sc  = (r.trust_score if r.trust_score is not none else 0) %}

        {% set rowClass =
            'bg-emerald-50/40' if lvl == 'HIGH'
            else ('bg-amber-50/40' if lvl == 'MEDIUM'
            else 'bg-rose-50/35')
        %}
        {% set dotClass =
            'bg-emerald-500' if lvl == 'HIGH'
            else ('bg-amber-500' if lvl == 'MEDIUM'
            else 'bg-rose-500')
        %}

        <tr class="{{ rowClass }}"
            data-row="1"
            data-cccd="{{ cccd }}"
            data-customer-name="{{ (r.customer_name or '')|e }}"
            data-account-name="{{ (r.account_name or '')|e }}">

          <!-- ✅ Tín nhiệm: 2 dòng (STT + dot) -->
          <td class="px-4 py-3 text-center align-middle whitespace-nowrap">
            <div class="text-xs font-semibold text-slate-700">#{{ loop.index }}</div>
            <div class="mt-1 flex items-center justify-center">
              <span class="inline-flex w-3 h-3 rounded-full {{ dotClass }}" title="{{ lvl }} ({{ sc }})"></span>
            </div>
          </td>

          <td class="px-4 py-3">
            <!-- ✅ tên KH luôn màu bình thường; chỉ xanh khi match -->
            <div class="font-semibold text-slate-900 row-customer">{{ r.customer_name or '-' }}</div>
          </td>

          <td class="px-4 py-3 text-slate-600 whitespace-nowrap">{{ cccd }}</td>
          <td class="px-4 py-3 text-slate-600 whitespace-nowrap">{{ r.lot_code or '' }}</td>

          <td class="px-4 py-3 text-right whitespace-nowrap">
            <span class="money" data-value="{{ r.refund_amount_vnd if r.refund_amount_vnd is not none else (r.paid_vnd if r.paid_vnd is not none else 0) }}">—</span>
          </td>

          <td class="px-4 py-3 text-slate-700">
            {% if r.account_number or r.bank_code %}
              <!-- ✅ nếu mismatch: bôi đỏ toàn bộ cụm này; nếu match: bôi xanh cả cụm -->
              <div class="text-xs row-account">
                <div class="font-semibold">{{ r.bank_code or '' }} — {{ r.account_number or '' }}</div>
                <div class="acc-name text-slate-600">{{ r.account_name or '' }}</div>
              </div>
            {% else %}
              <span class="text-slate-400 text-xs">Chưa có TK hoàn</span>
            {% endif %}
          </td>

          <!-- ✅ Chi tiết đưa lên trước để dễ thấy -->
          <td class="px-4 py-3 text-right whitespace-nowrap">
            {% if r.id %}
              <button type="button"
                      class="btnDetail h-9 px-3 rounded-xl border border-slate-300 bg-white text-slate-700 text-xs font-semibold hover:bg-slate-50 inline-flex items-center gap-2"
                      data-id="{{ r.id }}">
                <i class="ri-information-line"></i> Detail
              </button>
            {% else %}
              <span class="text-xs text-slate-400">—</span>
            {% endif %}
          </td>

          <!-- ✅ Nội dung để cuối -->
          <td class="px-4 py-3 text-xs text-slate-700">
            <div class="font-mono bg-white border border-slate-200 rounded-xl px-3 py-2">
              {{ r.content or '' }}
            </div>
          </td>
        </tr>
      {% endfor %}

      {% if rows|length == 0 %}
        <tr>
          <td colspan="8" class="px-4 py-6 text-center text-slate-400">
            {% if project_id %}
              Không có dữ liệu theo bộ lọc hiện tại.
            {% else %}
              Chọn dự án để xem dữ liệu.
            {% endif %}
          </td>
        </tr>
      {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Detail Modal -->
<div id="detailModal" class="fixed inset-0 z-[60] hidden">
  <div id="detailBackdrop" class="absolute inset-0 bg-slate-900/40"></div>
  <div class="absolute inset-0 flex items-start justify-center p-4 sm:p-6 overflow-auto">
    <div class="w-full max-w-4xl bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
      <div class="px-5 py-4 border-b border-slate-100 flex items-center justify-between">
        <div class="min-w-0">
          <div class="text-sm font-semibold text-slate-900">Chi tiết tín nhiệm tài khoản</div>
          <div id="dmSubtitle" class="text-xs text-slate-500 mt-0.5">—</div>
        </div>
        <button id="dmClose"
                class="h-9 px-3 rounded-xl border border-slate-300 bg-white text-slate-700 text-sm font-semibold hover:bg-slate-50 inline-flex items-center gap-2">
          <i class="ri-close-line"></i> Đóng
        </button>
      </div>

      <div class="p-5">
        <div id="dmLoading" class="text-sm text-slate-600">Đang tải…</div>
        <div id="dmError" class="hidden text-sm text-rose-700 bg-rose-50 border border-rose-200 rounded-xl p-3"></div>

        <div id="dmBody" class="hidden space-y-5">
          <div class="rounded-2xl border border-slate-200 bg-slate-50/40 p-4">
            <div class="flex items-center justify-between gap-3 flex-wrap">
              <div class="text-sm font-semibold text-slate-900">Tài khoản hoàn hiện tại</div>
              <div class="flex items-center gap-2">
                <span id="dmCurBadge" class="inline-flex items-center px-2 py-0.5 rounded-lg border text-xs font-semibold">—</span>
                <span class="text-xs text-slate-500">score: <b id="dmCurScore" class="text-slate-900">—</b></span>
              </div>
            </div>

            <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
              <div class="p-3 rounded-xl bg-white border border-slate-200">
                <div class="text-xs text-slate-500 font-semibold">Tài khoản</div>
                <div id="dmCurAccount" class="mt-1 font-semibold text-slate-900">—</div>
                <div id="dmCurName" class="text-xs text-slate-500 mt-0.5">—</div>
              </div>
              <div class="p-3 rounded-xl bg-white border border-slate-200">
                <div class="text-xs text-slate-500 font-semibold">Tổng tiền đã chuyển</div>
                <div class="mt-1 font-semibold text-slate-900"><span id="dmCurTotal" class="money" data-value="0">—</span> VND</div>
                <div class="text-xs text-slate-500 mt-0.5">Số lần: <b id="dmCurSeen">—</b></div>
              </div>
              <div class="p-3 rounded-xl bg-white border border-slate-200">
                <div class="text-xs text-slate-500 font-semibold">Lần giao dịch</div>
                <div class="text-xs text-slate-500 mt-1">Xa nhất: <b id="dmCurFirst" class="text-slate-900">—</b></div>
                <div class="text-xs text-slate-500 mt-0.5">Gần nhất: <b id="dmCurLast" class="text-slate-900">—</b></div>
              </div>
            </div>
          </div>

          <div class="rounded-2xl border border-slate-200 bg-white p-4">
            <div class="text-sm font-semibold text-slate-900">Các tài khoản khách đã dùng giao dịch với công ty</div>
            <div class="text-xs text-slate-500 mt-1">Danh sách tham khảo để đối chiếu khi cần xác minh.</div>

            <div class="mt-3 overflow-x-auto">
              <table class="min-w-full text-sm text-slate-700">
                <thead class="bg-slate-50 text-slate-500 border-b">
                  <tr>
                    <th class="px-3 py-2 text-left font-semibold">Tín nhiệm</th>
                    <th class="px-3 py-2 text-left font-semibold">Tài khoản</th>
                    <th class="px-3 py-2 text-right font-semibold">Tổng tiền</th>
                    <th class="px-3 py-2 text-right font-semibold">Số lần</th>
                    <th class="px-3 py-2 text-left font-semibold">Xa nhất</th>
                    <th class="px-3 py-2 text-left font-semibold">Gần nhất</th>
                  </tr>
                </thead>
                <tbody id="dmOtherTbody" class="divide-y divide-slate-100">
                  <tr><td colspan="6" class="px-3 py-3 text-slate-400 text-center">—</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="px-5 py-3 border-t border-slate-100 bg-slate-50/60 text-xs text-slate-500">
        Nếu <b>trùng tên</b> (không dấu) → bôi xanh <b>Họ tên</b> và <b>Tài khoản nhận</b>.
        Nếu <b>không trùng</b> → bôi đỏ <b>Tài khoản nhận</b> (tên KH giữ màu bình thường).
      </div>
    </div>
  </div>
</div>

<script>
  const DEFAULT_SIZE = 500;

  function debounce(fn, wait){
    let t = null;
    return (...args)=>{
      clearTimeout(t);
      t = setTimeout(()=> fn(...args), wait);
    };
  }

  function currentUrl(){ return new URL(window.location.href); }

  function applyFilters(pushHistory=true){
    const u = currentUrl();

    const project = (document.getElementById('fProject')?.value || '').trim();
    const eligible = (document.getElementById('fEligible')?.value || 'ELIGIBLE').trim();
    const scoreLevel = (document.getElementById('fScoreLevel')?.value || 'ALL').trim();
    const q = (document.getElementById('fQ')?.value || '').trim();
    const size = (document.getElementById('fSize')?.value || '').trim();

    u.searchParams.set('page','1');

    if(project) u.searchParams.set('project', project); else u.searchParams.delete('project');

    if(eligible && eligible !== 'ELIGIBLE') u.searchParams.set('eligible', eligible);
    else u.searchParams.delete('eligible');

    if(scoreLevel && scoreLevel !== 'ALL') u.searchParams.set('score_level', scoreLevel);
    else u.searchParams.delete('score_level');

    if(q) u.searchParams.set('q', q); else u.searchParams.delete('q');

    const sizeNum = Number(size || DEFAULT_SIZE);
    if(sizeNum && sizeNum !== DEFAULT_SIZE) u.searchParams.set('size', String(sizeNum));
    else u.searchParams.delete('size');

    if(pushHistory) window.location.assign(u.toString());
    else window.location.replace(u.toString());
  }

  const applyFiltersDebounced = debounce(()=> applyFilters(true), 300);

  document.getElementById('fProject')?.addEventListener('change', ()=> applyFilters(true));
  document.getElementById('fEligible')?.addEventListener('change', ()=> applyFilters(true));
  document.getElementById('fScoreLevel')?.addEventListener('change', ()=> applyFilters(true));
  document.getElementById('fSize')?.addEventListener('change', ()=> applyFilters(true));
  document.getElementById('fQ')?.addEventListener('input', ()=> applyFiltersDebounced());

  // ✅ Reset: KHÔNG reset dự án
  document.getElementById('btnResetFilters')?.addEventListener('click', ()=>{
    const u = currentUrl();
    u.searchParams.delete('eligible');
    u.searchParams.delete('score_level');
    u.searchParams.delete('q');
    u.searchParams.delete('size');
    u.searchParams.delete('page');
    window.location.assign(u.toString());
  });

  function formatVND(value){
    if (value === null || value === undefined || value === '') return '—';
    const s = String(value).trim();
    const n = Number(s.replace(/,/g,''));
    if (!Number.isFinite(n)) return '—';
    const v = Math.round(n);
    return v.toLocaleString('vi-VN');
  }

  document.querySelectorAll('.money').forEach(el=>{
    const v = el.getAttribute('data-value');
    el.textContent = formatVND(v);
  });

  // =========================
  // Name match (no-accent)
  // =========================
  function stripAccents(s){
    s = String(s || '').trim();
    if(!s) return '';
    s = s.replaceAll('Đ','D').replaceAll('đ','d');
    try{
      s = s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').normalize('NFC');
    }catch(e){}
    return s.toLowerCase().replace(/\s+/g,' ').trim();
  }

  function namesMatch(accName, cusName){
    const a = stripAccents(accName);
    const c = stripAccents(cusName);
    if(!a || !c) return false;
    return (a.includes(c) || c.includes(a));
  }

  // ✅ match => xanh (họ tên + tài khoản)
  // ✅ mismatch => đỏ (chỉ tài khoản), họ tên giữ màu bình thường
  function applyNameColors(){
    document.querySelectorAll('tr[data-row="1"]').forEach(tr=>{
      const cus = tr.getAttribute('data-customer-name') || '';
      const acc = tr.getAttribute('data-account-name') || '';
      const ok = namesMatch(acc, cus);
      tr.dataset.nameMatch = ok ? "1" : "0";

      const nameEl = tr.querySelector('.row-customer');
      const accBox = tr.querySelector('.row-account');
      const accNameEl = tr.querySelector('.acc-name');

      // reset
      nameEl?.classList.remove('text-emerald-700','font-semibold');
      accBox?.classList.remove('text-emerald-700','text-rose-700','font-semibold');
      accNameEl?.classList.remove('text-emerald-700','text-rose-700','font-semibold');

      if(ok){
        nameEl?.classList.add('text-emerald-700','font-semibold');
        accBox?.classList.add('text-emerald-700','font-semibold');
        accNameEl?.classList.add('text-emerald-700','font-semibold');
      }else{
        // tên KH giữ nguyên
        accBox?.classList.add('text-rose-700','font-semibold');
        accNameEl?.classList.add('text-rose-700','font-semibold');
      }
    });
  }

  // =========================
  // Local filter: mismatch only + dedupe by CCCD
  // =========================
  function applyLocalFilter(){
    const onlyMismatch = !!document.getElementById('fMismatchOnly')?.checked;
    const seen = new Set();

    document.querySelectorAll('tr[data-row="1"]').forEach(tr=>{
      const cccd = (tr.getAttribute('data-cccd') || '').trim();
      const isMatch = (tr.dataset.nameMatch === "1");

      let show = true;

      if(onlyMismatch){
        if(isMatch) show = false;

        if(show){
          const key = cccd || "__NO_CCCD__";
          if(seen.has(key)) show = false;
          else seen.add(key);
        }
      }

      tr.classList.toggle('hidden', !show);
    });
  }

  document.getElementById('fMismatchOnly')?.addEventListener('change', ()=>{
    applyLocalFilter();
  });

  applyNameColors();
  applyLocalFilter();

  // -------------------------
  // Modal helpers
  // -------------------------
  function badgeMeta(level){
    const lvl = String(level || 'LOW').toUpperCase();
    if (lvl === 'HIGH') return { text: 'Cao', cls: 'bg-emerald-100 text-emerald-800 border-emerald-200' };
    if (lvl === 'MEDIUM') return { text: 'TB', cls: 'bg-amber-100 text-amber-800 border-amber-200' };
    return { text: 'Thấp', cls: 'bg-rose-100 text-rose-800 border-rose-200' };
  }

  function fmtTime(s){
    if(!s) return '—';
    try{
      const d = new Date(s);
      if (Number.isNaN(d.getTime())) return String(s);
      return d.toLocaleString('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh' });
    }catch(e){
      return String(s);
    }
  }

  const modal = document.getElementById('detailModal');
  const backdrop = document.getElementById('detailBackdrop');
  const btnClose = document.getElementById('dmClose');

  function openModal(){
    modal?.classList.remove('hidden');
    document.documentElement.classList.add('overflow-hidden');
  }
  function closeModal(){
    modal?.classList.add('hidden');
    document.documentElement.classList.remove('overflow-hidden');
  }

  btnClose?.addEventListener('click', closeModal);
  backdrop?.addEventListener('click', closeModal);
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal(); });

  async function loadDetail(candidateId){
    const loading = document.getElementById('dmLoading');
    const err = document.getElementById('dmError');
    const body = document.getElementById('dmBody');
    const subtitle = document.getElementById('dmSubtitle');

    loading.classList.remove('hidden');
    err.classList.add('hidden');
    body.classList.add('hidden');
    subtitle.textContent = `candidate_id=${candidateId}`;

    try{
      // ✅ gọi đúng route hiện có ở Service B (query-param)
      const res = await fetch(`/auction/refunds/detail.json?candidate_id=${encodeURIComponent(candidateId)}`, {
        headers: { 'Accept': 'application/json' }
      });

      const js = await res.json().catch(()=> ({}));
      if(!res.ok || js.ok === false){
        const msg = (js && (js.detail || js.message)) || `HTTP ${res.status}`;
        throw new Error(msg);
      }

      const cand = js.candidate || {};
      const cur  = js.current_refund_account || {};
      const others = js.accounts_used || [];

      const curLvl = String(cur.trust_level || 'LOW').toUpperCase();
      const curScore = (cur.trust_score ?? 0);

      const b = badgeMeta(curLvl);
      const badge = document.getElementById('dmCurBadge');
      badge.className = `inline-flex items-center px-2 py-0.5 rounded-lg border text-xs font-semibold ${b.cls}`;
      badge.textContent = b.text;

      document.getElementById('dmCurScore').textContent = String(curScore);

      const bankCode = cur.bank_code || cand.bank_code || '';
      const accNo = cur.account_number || cand.account_number || '';
      const accName = cur.account_name || cand.account_name || '';
      document.getElementById('dmCurAccount').textContent =
        `${bankCode}${bankCode && accNo ? ' — ' : ''}${accNo}`.trim() || '—';
      document.getElementById('dmCurName').textContent = accName || '—';

      const totalIn = cur.total_in_amount_vnd ?? 0;
      const seen = cur.seen_count ?? 0;
      const firstAt = cur.first_paid_at ?? null;
      const lastAt = cur.last_paid_at ?? null;

      const curTotalEl = document.getElementById('dmCurTotal');
      curTotalEl.setAttribute('data-value', String(totalIn || 0));
      curTotalEl.textContent = formatVND(totalIn || 0);

      document.getElementById('dmCurSeen').textContent = String(seen || 0);
      document.getElementById('dmCurFirst').textContent = fmtTime(firstAt);
      document.getElementById('dmCurLast').textContent = fmtTime(lastAt);

      const cname = cand.customer_name || '';
      const cccd = cand.customer_cccd || '';
      const lot = cand.lot_code || '';
      subtitle.textContent = `${cname}${cname && cccd ? ' • ' : ''}${cccd}${(cname||cccd) && lot ? ' • ' : ''}${lot}`.trim() || `candidate_id=${candidateId}`;

      const tbody = document.getElementById('dmOtherTbody');
      tbody.innerHTML = '';

      if(Array.isArray(others) && others.length){
        for(const a of others){
          const lvl = String(a.trust_level || 'LOW').toUpperCase();
          const score = (a.trust_score ?? 0);
          const bb = badgeMeta(lvl);

          const aBank = a.bank_code || '';
          const aAcc = a.account_number_raw || a.account_number_norm || '';
          const aName = a.account_name_raw || '';
          const aTotal = a.total_in_amount_vnd ?? 0;
          const aSeen  = a.seen_count ?? 0;
          const aFirst = a.first_paid_at ?? null;
          const aLast  = a.last_paid_at ?? null;
          const isCur = !!a.is_current_refund_account;

          const tr = document.createElement('tr');
          tr.className = isCur ? 'bg-indigo-50/60' : '';
          tr.innerHTML = `
            <td class="px-3 py-2 whitespace-nowrap">
              <div class="flex items-center gap-2">
                <span class="inline-flex items-center px-2 py-0.5 rounded-lg border text-xs font-semibold ${bb.cls}">${bb.text}</span>
                <span class="text-xs text-slate-500">(${score})</span>
                ${isCur ? '<span class="text-[10px] px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-800 border border-indigo-200">Đang chọn</span>' : ''}
              </div>
            </td>
            <td class="px-3 py-2">
              <div class="font-semibold text-slate-900">${(aBank && aAcc) ? `${aBank} — ${aAcc}` : (aAcc || '—')}</div>
              <div class="text-xs text-slate-500">${aName || ''}</div>
            </td>
            <td class="px-3 py-2 text-right whitespace-nowrap">${formatVND(aTotal || 0)}</td>
            <td class="px-3 py-2 text-right whitespace-nowrap">${String(aSeen || 0)}</td>
            <td class="px-3 py-2 whitespace-nowrap text-slate-600">${fmtTime(aFirst)}</td>
            <td class="px-3 py-2 whitespace-nowrap text-slate-600">${fmtTime(aLast)}</td>
          `;
          tbody.appendChild(tr);
        }
      }else{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="6" class="px-3 py-3 text-slate-400 text-center">Không có dữ liệu tài khoản tham khảo.</td>`;
        tbody.appendChild(tr);
      }

      loading.classList.add('hidden');
      err.classList.add('hidden');
      body.classList.remove('hidden');
    }catch(e){
      loading.classList.add('hidden');
      body.classList.add('hidden');
      err.classList.remove('hidden');
      err.textContent = `Không tải được chi tiết: ${e?.message || e}`;
    }
  }

  document.querySelectorAll('.btnDetail').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.getAttribute('data-id');
      if(!id) return;
      openModal();
      await loadDetail(id);
    });
  });
</script>
{% endblock %}
