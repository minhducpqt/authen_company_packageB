{% extends "base.html" %}
{% block title %}Hoàn tiền đặt trước{% endblock %}

{% block content %}
{# -----------------------------
  TAB detection (fallback-safe)
------------------------------ #}
{% set _tab = (request.query_params.get('tab') if request and request.query_params else None) %}
{% set tab = (_tab or 'list') %}
{% if tab not in ['list','audit'] %}{% set tab = 'list' %}{% endif %}

{% set rows = (data or {}).get('data') or [] %}
{% set total = (data or {}).get('total') or (rows|length) %}
{% set total_amount_vnd = (data or {}).get('total_amount_vnd') or 0 %}

<div class="mb-6">
  <h1 class="text-2xl font-semibold text-slate-900 flex items-center gap-2">
    <i class="ri-refund-2-line text-indigo-600 text-3xl"></i>
    5.4 Hoàn tiền đặt trước
  </h1>
  <p class="text-slate-500 text-sm mt-1">
    Danh sách hoàn theo dự án — có thể kéo ngang để xem đủ thông tin.
  </p>
</div>

{% if error %}
  <div class="mb-4 bg-rose-50 border border-rose-200 text-rose-700 rounded-xl p-3 text-sm">
    <div class="font-semibold">Lỗi gọi Service A</div>
    <div class="mt-1">status={{ error.status }} | {{ (error.body or {}).get('detail') or error.body }}</div>
  </div>
{% endif %}

{# =========================================================
   1) PROJECT SELECT (shared) + TOP RIGHT XLSX
   - single project selector for both tabs
   - download xlsx button is ALWAYS here (depends on project only)
   ========================================================= #}
<div class="bg-white border rounded-2xl shadow-sm p-4 mb-3">
  <div class="flex flex-wrap gap-4 items-end">
    <div class="flex flex-col min-w-[320px]">
      <label class="text-xs font-semibold text-slate-500 mb-1">Dự án</label>
      <select id="fProjectShared" class="h-10 rounded-xl border px-3 text-sm">
        <option value="">— Chọn dự án —</option>
        {% for p in projects or [] %}
          {% set code = (p.project_code or p.code) %}
          <option value="{{ code }}" {% if code == project %}selected{% endif %}>
            {{ code }} — {{ p.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    {% if project_id %}
      <div class="text-xs text-slate-500 pb-1">
        <span class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border bg-slate-50">
          <i class="ri-folder-2-line"></i>
          <span>Mã dự án: <b class="text-slate-900">{{ project }}</b></span>
          <span class="text-slate-300">•</span>
          <span>ID: <b class="text-slate-900">{{ project_id }}</b></span>
        </span>
      </div>
    {% endif %}

    <div class="ml-auto flex items-center gap-2 flex-wrap justify-end">
      {# XLSX download for LIST (keeps existing endpoint)
         NOTE: keep current query eligible/score/q if you want,
         but per your statement "ds hoàn chỉ phụ thuộc project"
         we only pass project_id (and keep it stable).
      #}
      <a id="btnExportXlsxTop"
         href="{% if project_id %}/auction/refunds/export.xlsx?project_id={{ project_id }}{% else %}#{% endif %}"
         class="h-10 px-4 rounded-xl bg-emerald-600 text-white text-sm font-medium hover:bg-emerald-700 inline-flex items-center gap-2 {% if not project_id %}opacity-40 pointer-events-none{% endif %}">
        <i class="ri-file-excel-2-line"></i> Download XLSX
      </a>
    </div>
  </div>
</div>

{# =========================================================
   2) TABS
   ========================================================= #}
<div class="mb-4">
  <div class="inline-flex rounded-2xl border bg-white shadow-sm overflow-hidden">
    <button type="button"
            id="tabBtnList"
            class="px-4 h-10 text-sm font-semibold inline-flex items-center gap-2 border-r
                   {% if tab == 'list' %}bg-indigo-600 text-white border-indigo-600{% else %}bg-white text-slate-700 hover:bg-slate-50{% endif %}">
      <i class="ri-list-check-2"></i>
      Danh sách hoàn
    </button>

    <button type="button"
            id="tabBtnAudit"
            class="px-4 h-10 text-sm font-semibold inline-flex items-center gap-2
                   {% if tab == 'audit' %}bg-indigo-600 text-white border-indigo-600{% else %}bg-white text-slate-700 hover:bg-slate-50{% endif %}">
      <i class="ri-shield-check-line"></i>
      Check audit
    </button>
  </div>
</div>

{# =========================================================
   TAB 1: LIST (KEEP LOGIC)
   - IMPORTANT: removed duplicate project selector inside the list form.
   - other code stays the same except:
     * mismatch-only no auto grouping
     * default url params (eligible=ELIGIBLE, score_level=LOW) handled in JS
     * default local checks enabled on load if no saved state
   ========================================================= #}
{% if tab == 'list' %}

<form id="filtersForm" method="get"
      class="bg-white border rounded-2xl shadow-sm p-4 mb-4 flex flex-wrap gap-4 items-end"
      onsubmit="return false;">

  {# ❌ REMOVED duplicate project selector here #}

  <div class="flex flex-col">
    <label class="text-xs font-semibold text-slate-500 mb-1">Loại danh sách</label>
    {% set cur_eligible = (eligible or 'ELIGIBLE') %}
    <select id="fEligible" name="eligible" class="h-10 rounded-xl border px-3 text-sm w-56">
      <option value="ELIGIBLE" {% if cur_eligible == 'ELIGIBLE' %}selected{% endif %}>Phải hoàn</option>
      <option value="EXCLUDED" {% if cur_eligible == 'EXCLUDED' %}selected{% endif %}>Không hoàn (khách trúng)</option>
      <option value="ALL" {% if cur_eligible == 'ALL' %}selected{% endif %}>Tất cả</option>
    </select>
  </div>

  <div class="flex flex-col">
    <label class="text-xs font-semibold text-slate-500 mb-1">Tín nhiệm</label>
    {% set cur_level = (score_level or 'ALL') %}
    <select id="fScoreLevel" name="score_level" class="h-10 rounded-xl border px-3 text-sm w-56">
      <option value="ALL" {% if cur_level == 'ALL' %}selected{% endif %}>Tất cả</option>
      <option value="HIGH" {% if cur_level == 'HIGH' %}selected{% endif %}>Tín nhiệm cao</option>
      <option value="MEDIUM" {% if cur_level == 'MEDIUM' %}selected{% endif %}>Tín nhiệm TB</option>
      <option value="LOW" {% if cur_level == 'LOW' %}selected{% endif %}>Tín nhiệm thấp</option>
    </select>
  </div>

  <div class="flex flex-col">
    <label class="text-xs font-semibold text-slate-500 mb-1">Tìm kiếm</label>
    <input id="fQ" type="text" name="q" value="{{ q }}"
           class="h-10 rounded-xl border px-3 text-sm min-w-[300px]"
           placeholder="CCCD, tên khách, mã lô, STK...">
  </div>

  <div class="flex flex-col">
    <label class="text-xs font-semibold text-slate-500 mb-1">Số dòng / trang</label>
    <input id="fSize" type="number" name="size" value="{{ size or 500 }}"
           class="h-10 rounded-xl border px-3 text-sm w-28" min="1" max="5000">
  </div>

  <!-- ✅ Local filter -->
  <div class="flex items-center gap-2 pb-1">
    <input id="fMismatchOnly" type="checkbox"
           class="w-4 h-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
    <label for="fMismatchOnly" class="text-sm text-slate-700 font-medium select-none">
      Chỉ hiện <b>TK nhận không trùng tên</b> (lọc local)
    </label>
    <span class="text-xs text-slate-500">(không tự group)</span>
  </div>

  <!-- ✅ Group by CCCD (local) -->
  <div class="flex items-center gap-2 pb-1">
    <input id="fGroupByCccd" type="checkbox"
           class="w-4 h-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
    <label for="fGroupByCccd" class="text-sm text-slate-700 font-medium select-none">
      Group theo <b>CCCD</b> (lọc local)
    </label>
    <span class="text-xs text-slate-500">(mỗi CCCD chỉ giữ 1 giao dịch đầu tiên)</span>
  </div>

  <div class="flex items-center gap-3 ml-auto flex-wrap justify-end">
    <button type="button" id="btnResetFilters"
            class="h-10 px-4 rounded-xl border border-slate-300 text-sm font-medium text-slate-700 bg-white hover:bg-slate-50 inline-flex items-center gap-2">
      <i class="ri-refresh-line"></i> Reset
    </button>
  </div>
</form>

<!-- Summary -->
<div class="mb-3 flex flex-wrap items-center gap-2 text-sm text-slate-600">
  {% if project_id %}
    <span><b class="text-slate-900">{{ total }}</b> dòng</span>
    <span class="text-slate-300">•</span>
    <span><b class="text-slate-900 money" data-value="{{ total_amount_vnd }}">—</b> VND</span>
    <span class="text-slate-300">•</span>
    <span>Hiển thị: <b id="visibleCount" class="text-slate-900">—</b> dòng</span>
  {% else %}
    Chọn dự án để xem dữ liệu.
  {% endif %}
</div>

<div class="bg-white border rounded-2xl shadow-sm overflow-hidden">
  <div class="overflow-x-auto">
    <table class="min-w-[1400px] w-full text-sm text-slate-700">
      <thead class="bg-slate-50 text-slate-500 border-b">
        <tr>
          <th class="px-4 py-3 text-center font-semibold w-[90px]">Tín nhiệm</th>
          <th class="px-4 py-3 text-left font-semibold">Họ tên</th>
          <th class="px-4 py-3 text-left font-semibold">CCCD</th>
          <th class="px-4 py-3 text-left font-semibold">Lô</th>
          <th class="px-4 py-3 text-right font-semibold">Số tiền hoàn</th>
          <th class="px-4 py-3 text-left font-semibold">Tài khoản nhận</th>
          <th class="px-4 py-3 text-right font-semibold w-[120px]">Chi tiết</th>
          <th class="px-4 py-3 text-left font-semibold">Nội dung CK (chuẩn)</th>
        </tr>
      </thead>

      <tbody class="divide-y divide-slate-100" id="refundTbody">
      {% for r in rows %}
        {% set cccd = (r.customer_cccd or '') %}
        {% set lvl = (r.trust_level or 'LOW') %}
        {% set sc  = (r.trust_score if r.trust_score is not none else 0) %}

        {% set rowClass =
            'bg-emerald-50/40' if lvl == 'HIGH'
            else ('bg-amber-50/40' if lvl == 'MEDIUM'
            else 'bg-rose-50/35')
        %}
        {% set dotClass =
            'bg-emerald-500' if lvl == 'HIGH'
            else ('bg-amber-500' if lvl == 'MEDIUM'
            else 'bg-rose-500')
        %}

        <tr class="{{ rowClass }}"
            data-row="1"
            data-cccd="{{ cccd }}"
            data-customer-name="{{ (r.customer_name or '')|e }}"
            data-account-name="{{ (r.account_name or '')|e }}">

          <td class="px-4 py-3 text-center align-middle whitespace-nowrap">
            <div class="text-xs font-semibold text-slate-700">#{{ loop.index }}</div>
            <div class="mt-1 flex items-center justify-center">
              <span class="inline-flex w-3 h-3 rounded-full {{ dotClass }}" title="{{ lvl }} ({{ sc }})"></span>
            </div>
          </td>

          <td class="px-4 py-3">
            <div class="font-semibold text-slate-900 row-customer">{{ r.customer_name or '-' }}</div>
          </td>

          <td class="px-4 py-3 text-slate-600 whitespace-nowrap">{{ cccd }}</td>
          <td class="px-4 py-3 text-slate-600 whitespace-nowrap">{{ r.lot_code or '' }}</td>

          <td class="px-4 py-3 text-right whitespace-nowrap">
            <span class="money" data-value="{{ r.refund_amount_vnd if r.refund_amount_vnd is not none else (r.paid_vnd if r.paid_vnd is not none else 0) }}">—</span>
          </td>

          <td class="px-4 py-3 text-slate-700">
            {% if r.account_number or r.bank_code %}
              <div class="text-xs row-account">
                <div class="font-semibold">{{ r.bank_code or '' }} — {{ r.account_number or '' }}</div>
                <div class="acc-name text-slate-600">{{ r.account_name or '' }}</div>
              </div>
            {% else %}
              <span class="text-slate-400 text-xs">Chưa có TK hoàn</span>
            {% endif %}
          </td>

          <td class="px-4 py-3 text-right whitespace-nowrap">
            {% if r.id %}
              <button type="button"
                      class="btnDetail h-9 px-3 rounded-xl border border-slate-300 bg-white text-slate-700 text-xs font-semibold hover:bg-slate-50 inline-flex items-center gap-2"
                      data-id="{{ r.id }}">
                <i class="ri-information-line"></i> Detail
              </button>
            {% else %}
              <span class="text-xs text-slate-400">—</span>
            {% endif %}
          </td>

          <td class="px-4 py-3 text-xs text-slate-700">
            <div class="font-mono bg-white border border-slate-200 rounded-xl px-3 py-2">
              {{ r.content or '' }}
            </div>
          </td>
        </tr>
      {% endfor %}

      {% if rows|length == 0 %}
        <tr>
          <td colspan="8" class="px-4 py-6 text-center text-slate-400">
            {% if project_id %}
              Không có dữ liệu theo bộ lọc hiện tại.
            {% else %}
              Chọn dự án để xem dữ liệu.
            {% endif %}
          </td>
        </tr>
      {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Detail Modal -->
<div id="detailModal" class="fixed inset-0 z-[60] hidden">
  <div id="detailBackdrop" class="absolute inset-0 bg-slate-900/40"></div>
  <div class="absolute inset-0 flex items-start justify-center p-4 sm:p-6 overflow-auto">
    <div class="w-full max-w-4xl bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
      <div class="px-5 py-4 border-b border-slate-100 flex items-center justify-between">
        <div class="min-w-0">
          <div class="text-sm font-semibold text-slate-900">Chi tiết tín nhiệm tài khoản</div>
          <div id="dmSubtitle" class="text-xs text-slate-500 mt-0.5">—</div>
        </div>
        <button id="dmClose"
                class="h-9 px-3 rounded-xl border border-slate-300 bg-white text-slate-700 text-sm font-semibold hover:bg-slate-50 inline-flex items-center gap-2">
          <i class="ri-close-line"></i> Đóng
        </button>
      </div>

      <div class="p-5">
        <div id="dmLoading" class="text-sm text-slate-600">Đang tải…</div>
        <div id="dmError" class="hidden text-sm text-rose-700 bg-rose-50 border border-rose-200 rounded-xl p-3"></div>

        <div id="dmBody" class="hidden space-y-5">
          <div class="rounded-2xl border border-slate-200 bg-slate-50/40 p-4">
            <div class="flex items-center justify-between gap-3 flex-wrap">
              <div class="text-sm font-semibold text-slate-900">Tài khoản hoàn hiện tại</div>
              <div class="flex items-center gap-2">
                <span id="dmCurBadge" class="inline-flex items-center px-2 py-0.5 rounded-lg border text-xs font-semibold">—</span>
                <span class="text-xs text-slate-500">score: <b id="dmCurScore" class="text-slate-900">—</b></span>
              </div>
            </div>

            <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
              <div class="p-3 rounded-xl bg-white border border-slate-200">
                <div class="text-xs text-slate-500 font-semibold">Tài khoản</div>
                <div id="dmCurAccount" class="mt-1 font-semibold text-slate-900">—</div>
                <div id="dmCurName" class="text-xs text-slate-500 mt-0.5">—</div>
              </div>
              <div class="p-3 rounded-xl bg-white border border-slate-200">
                <div class="text-xs text-slate-500 font-semibold">Tổng tiền đã chuyển</div>
                <div class="mt-1 font-semibold text-slate-900"><span id="dmCurTotal" class="money" data-value="0">—</span> VND</div>
                <div class="text-xs text-slate-500 mt-0.5">Số lần: <b id="dmCurSeen">—</b></div>
              </div>
              <div class="p-3 rounded-xl bg-white border border-slate-200">
                <div class="text-xs text-slate-500 font-semibold">Lần giao dịch</div>
                <div class="text-xs text-slate-500 mt-1">Xa nhất: <b id="dmCurFirst" class="text-slate-900">—</b></div>
                <div class="text-xs text-slate-500 mt-0.5">Gần nhất: <b id="dmCurLast" class="text-slate-900">—</b></div>
              </div>
            </div>
          </div>

          <div class="rounded-2xl border border-slate-200 bg-white p-4">
            <div class="text-sm font-semibold text-slate-900">Các tài khoản khách đã dùng giao dịch với công ty</div>
            <div class="text-xs text-slate-500 mt-1">Danh sách tham khảo để đối chiếu khi cần xác minh.</div>

            <div class="mt-3 overflow-x-auto">
              <table class="min-w-full text-sm text-slate-700">
                <thead class="bg-slate-50 text-slate-500 border-b">
                  <tr>
                    <th class="px-3 py-2 text-left font-semibold">Tín nhiệm</th>
                    <th class="px-3 py-2 text-left font-semibold">Tài khoản</th>
                    <th class="px-3 py-2 text-right font-semibold">Tổng tiền</th>
                    <th class="px-3 py-2 text-right font-semibold">Số lần</th>
                    <th class="px-3 py-2 text-left font-semibold">Xa nhất</th>
                    <th class="px-3 py-2 text-left font-semibold">Gần nhất</th>
                  </tr>
                </thead>
                <tbody id="dmOtherTbody" class="divide-y divide-slate-100">
                  <tr><td colspan="6" class="px-3 py-3 text-slate-400 text-center">—</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="px-5 py-3 border-t border-slate-100 bg-slate-50/60 text-xs text-slate-500">
        Nếu <b>trùng tên</b> (không dấu) → bôi xanh <b>Họ tên</b> và <b>Tài khoản nhận</b>.
        Nếu <b>không trùng</b> → bôi đỏ <b>Tài khoản nhận</b> (tên KH giữ màu bình thường).
      </div>
    </div>
  </div>
</div>

{% endif %}

{# =========================================================
   TAB 2: AUDIT
   ========================================================= #}
{% if tab == 'audit' %}
<div class="bg-white border rounded-2xl shadow-sm p-4 mb-4">
  <div class="flex flex-wrap items-center gap-3">
    <div class="min-w-0">
      <div class="text-sm font-semibold text-slate-900 flex items-center gap-2">
        <i class="ri-shield-check-line text-indigo-600"></i>
        Check audit hoàn tiền
      </div>
      <div class="text-xs text-slate-500 mt-0.5">
        Dùng API check mới để phát hiện trường hợp cập nhật TK hoàn muộn (&gt; 30 phút) hoặc không có TK.
      </div>
    </div>

    <div class="ml-auto flex items-center gap-2 flex-wrap justify-end">
      <button type="button" id="btnAuditReset"
              class="h-10 px-4 rounded-xl border border-slate-300 text-sm font-semibold text-slate-700 bg-white hover:bg-slate-50 inline-flex items-center gap-2 {% if not project_id %}opacity-40 pointer-events-none{% endif %}">
        <i class="ri-refresh-line"></i> Reset filter
      </button>

      <button type="button" id="btnAuditReload"
              class="h-10 px-4 rounded-xl border border-slate-300 text-sm font-semibold text-slate-700 bg-white hover:bg-slate-50 inline-flex items-center gap-2 {% if not project_id %}opacity-40 pointer-events-none{% endif %}">
        <i class="ri-loop-right-line"></i> Tải lại audit
      </button>
    </div>
  </div>

  <div class="mt-4 flex flex-wrap gap-3 items-center">
    {# ✅ NEW: local eligible filter for audit #}
    <div class="flex flex-col">
      <label class="text-xs font-semibold text-slate-500 mb-1">Loại danh sách</label>
      <select id="auditEligible" class="h-10 rounded-xl border px-3 text-sm w-56">
        <option value="ELIGIBLE">Phải hoàn</option>
        <option value="EXCLUDED">Không hoàn</option>
        <option value="ALL">Tất cả</option>
      </select>
    </div>

    <div class="flex items-center gap-2">
      <input id="auditOnlyRisk" type="checkbox" class="w-4 h-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
      <label for="auditOnlyRisk" class="text-sm text-slate-700 font-medium select-none">
        Chỉ hiện <b>RISK</b>
      </label>
    </div>

    <div class="flex items-center gap-2">
      <input id="auditOnlyChanged" type="checkbox" class="w-4 h-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
      <label for="auditOnlyChanged" class="text-sm text-slate-700 font-medium select-none">
        Chỉ hiện <b>Bank changed</b>
      </label>
    </div>

    <div class="flex items-center gap-2">
      <input id="auditOnlyNoBank" type="checkbox" class="w-4 h-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
      <label for="auditOnlyNoBank" class="text-sm text-slate-700 font-medium select-none">
        Chỉ hiện <b>Không có TK</b>
      </label>
    </div>

    <div class="flex items-center gap-2">
      <input id="auditGroupByCccd" type="checkbox" class="w-4 h-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
      <label for="auditGroupByCccd" class="text-sm text-slate-700 font-medium select-none">
        Group theo <b>CCCD</b> (lọc local)
      </label>
      <span class="text-xs text-slate-500">(mỗi CCCD chỉ giữ 1 dòng)</span>
    </div>

    <div class="flex flex-col min-w-[320px]">
      <label class="text-xs font-semibold text-slate-500 mb-1">Tìm local</label>
      <input id="auditQ" type="text"
             class="h-10 rounded-xl border px-3 text-sm"
             placeholder="CCCD, tên khách, mã lô, STK...">
    </div>

    <div class="text-xs text-slate-500 ml-auto">
      Hiển thị: <b id="auditVisibleCount" class="text-slate-900">—</b> dòng
    </div>
  </div>
</div>

<div id="auditError" class="hidden mb-4 bg-rose-50 border border-rose-200 text-rose-700 rounded-xl p-3 text-sm"></div>

<div id="auditSummaryWrap" class="mb-4 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-3">
  <div class="bg-white border rounded-2xl shadow-sm p-4">
    <div class="text-xs text-slate-500 font-semibold">Tổng giao dịch</div>
    <div class="mt-1 text-2xl font-semibold text-slate-900" id="sTotalTxn">—</div>
    <div class="text-xs text-slate-500 mt-1">Tổng tiền: <b class="money" id="sTotalAmount" data-value="0">—</b> VND</div>
  </div>

  <div class="bg-white border rounded-2xl shadow-sm p-4">
    <div class="text-xs text-slate-500 font-semibold">Phải hoàn / Không hoàn</div>
    <div class="mt-1 flex items-baseline gap-3">
      <div class="text-xl font-semibold text-emerald-700"><span id="sMustRefundTxn">—</span></div>
      <div class="text-slate-300">/</div>
      <div class="text-xl font-semibold text-slate-700"><span id="sExcludedTxn">—</span></div>
    </div>
    <div class="mt-2 text-xs text-slate-500 space-y-1">
    <div class="grid grid-cols-[88px_1fr_auto] items-baseline gap-2">
      <span>Phải hoàn:</span>
      <b class="money font-mono text-slate-900 text-right tabular-nums" id="sMustRefundAmount" data-value="0">—</b>
      <span class="text-slate-400">VND</span>
    </div>

    <div class="grid grid-cols-[88px_1fr_auto] items-baseline gap-2">
      <span>Không hoàn:</span>
      <b class="money font-mono text-slate-900 text-right tabular-nums" id="sExcludedAmount" data-value="0">—</b>
      <span class="text-slate-400">VND</span>
    </div>
  </div>

  </div>

  <div class="bg-white border rounded-2xl shadow-sm p-4">
    <div class="text-xs text-slate-500 font-semibold">TK hoàn</div>
    <div class="mt-1 flex items-baseline gap-3">
      <div class="text-xl font-semibold text-slate-900"><span id="sHasBank">—</span></div>
      <div class="text-slate-300">•</div>
      <div class="text-xl font-semibold text-rose-700"><span id="sNoBank">—</span></div>
    </div>
    <div class="text-xs text-slate-500 mt-1">Bank changed: <b id="sBankChanged" class="text-slate-900">—</b></div>
  </div>

  <div class="bg-white border rounded-2xl shadow-sm p-4">
    <div class="text-xs text-slate-500 font-semibold">Risk breakdown</div>
    <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
      <div class="flex items-center justify-between rounded-xl border bg-emerald-50 px-3 py-2">
        <span class="text-emerald-800 font-semibold">SAFE</span>
        <b id="sSafe" class="text-emerald-900">—</b>
      </div>
      <div class="flex items-center justify-between rounded-xl border bg-rose-50 px-3 py-2">
        <span class="text-rose-800 font-semibold">RISK</span>
        <b id="sRiskLate" class="text-rose-900">—</b>
      </div>
      <div class="flex items-center justify-between rounded-xl border bg-amber-50 px-3 py-2">
        <span class="text-amber-800 font-semibold">NO BANK</span>
        <b id="sRiskNoBank" class="text-amber-900">—</b>
      </div>
      <div class="flex items-center justify-between rounded-xl border bg-slate-50 px-3 py-2">
        <span class="text-slate-700 font-semibold">ANOMALY</span>
        <b id="sAnomaly" class="text-slate-900">—</b>
      </div>
    </div>
  </div>
</div>

<div class="bg-white border rounded-2xl shadow-sm overflow-hidden">
  <div class="overflow-x-auto">
    <table class="min-w-[1600px] w-full text-sm text-slate-700">
      <thead class="bg-slate-50 text-slate-500 border-b">
        <tr>
          <th class="px-4 py-3 text-left font-semibold w-[140px]">Risk</th>
          <th class="px-4 py-3 text-left font-semibold">Họ tên</th>
          <th class="px-4 py-3 text-left font-semibold">CCCD</th>
          <th class="px-4 py-3 text-left font-semibold">Lô</th>
          <th class="px-4 py-3 text-right font-semibold">Số tiền</th>
          <th class="px-4 py-3 text-left font-semibold">TK nhận</th>
          <th class="px-4 py-3 text-right font-semibold w-[120px]">Delay (phút)</th>
          <th class="px-4 py-3 text-left font-semibold w-[140px]">Bank changed</th>
          <th class="px-4 py-3 text-left font-semibold">Customer (c/u)</th>
          <th class="px-4 py-3 text-left font-semibold">Bank (c/u)</th>
        </tr>
      </thead>
      <tbody id="auditTbody" class="divide-y divide-slate-100">
        <tr>
          <td colspan="10" class="px-4 py-6 text-center text-slate-400" id="auditLoadingRow">
            {% if project_id %}Đang tải audit…{% else %}Chọn dự án để xem audit.{% endif %}
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
{% endif %}

<script>
  function currentUrl(){ return new URL(window.location.href); }

  function setParam(u, k, v){
    if(v === null || v === undefined || String(v).trim() === '') u.searchParams.delete(k);
    else u.searchParams.set(k, String(v));
  }

  // Tabs
  function switchTab(nextTab){
    const u = currentUrl();
    setParam(u, "tab", nextTab);
    window.location.assign(u.toString());
  }
  document.getElementById('tabBtnList')?.addEventListener('click', ()=> switchTab('list'));
  document.getElementById('tabBtnAudit')?.addEventListener('click', ()=> switchTab('audit'));

  // Shared project selector -> update URL project
  // IMPORTANT: project change should RESET per your earlier decision.
  document.getElementById('fProjectShared')?.addEventListener('change', ()=>{
    const u = currentUrl();
    const project = (document.getElementById('fProjectShared')?.value || '').trim();

    // reset everything except project + tab
    const tab = (u.searchParams.get('tab') || 'list');
    u.search = '';
    if(project) u.searchParams.set('project', project);
    u.searchParams.set('tab', tab);

    window.location.assign(u.toString());
  });
</script>

{# =========================================================
   LIST SCRIPTS (only when tab==list)
   ========================================================= #}
{% if tab == 'list' %}
<script>
  const DEFAULT_SIZE = 500;

  function debounce(fn, wait){
    let t = null;
    return (...args)=>{
      clearTimeout(t);
      t = setTimeout(()=> fn(...args), wait);
    };
  }

  function currentUrl(){ return new URL(window.location.href); }

  // ✅ Ensure default server filters for LIST if not present:
  // eligible default ELIGIBLE, score_level default LOW
  // (only apply when project chosen; and only when param not set)
  (function ensureListDefaults(){
    const u = currentUrl();
    const hasProject = !!(u.searchParams.get('project') || '').trim();
    if(!hasProject) return;

    let changed = false;

    if(!u.searchParams.has('eligible')){
      u.searchParams.set('eligible','ELIGIBLE'); changed = true;
    }
    if(!u.searchParams.has('score_level')){
      u.searchParams.set('score_level','LOW'); changed = true;
    }

    // keep size default as-is (no forced param)
    if(changed){
      u.searchParams.set('tab','list');
      window.location.replace(u.toString());
    }
  })();

  function applyFilters(pushHistory=true){
    const u = currentUrl();

    const eligible = (document.getElementById('fEligible')?.value || 'ELIGIBLE').trim();
    const scoreLevel = (document.getElementById('fScoreLevel')?.value || 'ALL').trim();
    const q = (document.getElementById('fQ')?.value || '').trim();
    const size = (document.getElementById('fSize')?.value || '').trim();

    u.searchParams.set('page','1');

    // project is controlled by shared selector only
    // do not set/delete 'project' here

    if(eligible && eligible !== 'ELIGIBLE') u.searchParams.set('eligible', eligible);
    else u.searchParams.delete('eligible');

    if(scoreLevel && scoreLevel !== 'ALL') u.searchParams.set('score_level', scoreLevel);
    else u.searchParams.delete('score_level');

    if(q) u.searchParams.set('q', q); else u.searchParams.delete('q');

    const sizeNum = Number(size || DEFAULT_SIZE);
    if(sizeNum && sizeNum !== DEFAULT_SIZE) u.searchParams.set('size', String(sizeNum));
    else u.searchParams.delete('size');

    u.searchParams.set('tab','list');

    if(pushHistory) window.location.assign(u.toString());
    else window.location.replace(u.toString());
  }

  const applyFiltersDebounced = debounce(()=> applyFilters(true), 300);

  document.getElementById('fEligible')?.addEventListener('change', ()=> applyFilters(true));
  document.getElementById('fScoreLevel')?.addEventListener('change', ()=> applyFilters(true));
  document.getElementById('fSize')?.addEventListener('change', ()=> applyFilters(true));
  document.getElementById('fQ')?.addEventListener('input', ()=> applyFiltersDebounced());

  // ✅ Reset (keep project, keep tab)
  document.getElementById('btnResetFilters')?.addEventListener('click', ()=>{
    const u = currentUrl();
    u.searchParams.delete('eligible');
    u.searchParams.delete('score_level');
    u.searchParams.delete('q');
    u.searchParams.delete('size');
    u.searchParams.delete('page');
    u.searchParams.set('tab','list');
    window.location.assign(u.toString());
  });

  function formatVND(value){
    if (value === null || value === undefined || value === '') return '—';
    const s = String(value).trim();
    const n = Number(s.replace(/,/g,''));
    if (!Number.isFinite(n)) return '—';
    const v = Math.round(n);
    return v.toLocaleString('vi-VN');
  }

  document.querySelectorAll('.money').forEach(el=>{
    const v = el.getAttribute('data-value');
    el.textContent = formatVND(v);
  });

  // =========================
  // Name match (no-accent)
  // =========================
  function stripAccents(s){
    s = String(s || '').trim();
    if(!s) return '';
    s = s.replaceAll('Đ','D').replaceAll('đ','d');
    try{
      s = s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').normalize('NFC');
    }catch(e){}
    return s.toLowerCase().replace(/\s+/g,' ').trim();
  }

  function namesMatch(accName, cusName){
    const a = stripAccents(accName);
    const c = stripAccents(cusName);
    if(!a || !c) return false;
    return (a.includes(c) || c.includes(a));
  }

  function applyNameColors(){
    document.querySelectorAll('tr[data-row="1"]').forEach(tr=>{
      const cus = tr.getAttribute('data-customer-name') || '';
      const acc = tr.getAttribute('data-account-name') || '';
      const ok = namesMatch(acc, cus);
      tr.dataset.nameMatch = ok ? "1" : "0";

      const nameEl = tr.querySelector('.row-customer');
      const accBox = tr.querySelector('.row-account');
      const accNameEl = tr.querySelector('.acc-name');

      nameEl?.classList.remove('text-emerald-700','font-semibold');
      accBox?.classList.remove('text-emerald-700','text-rose-700','font-semibold');
      accNameEl?.classList.remove('text-emerald-700','text-rose-700','font-semibold');

      if(ok){
        nameEl?.classList.add('text-emerald-700','font-semibold');
        accBox?.classList.add('text-emerald-700','font-semibold');
        accNameEl?.classList.add('text-emerald-700','font-semibold');
      }else{
        accBox?.classList.add('text-rose-700','font-semibold');
        accNameEl?.classList.add('text-rose-700','font-semibold');
      }
    });
  }

  function updateVisibleCount(){
    const el = document.getElementById('visibleCount');
    if(!el) return;
    const rows = Array.from(document.querySelectorAll('tr[data-row="1"]'));
    const n = rows.filter(tr=> !tr.classList.contains('hidden')).length;
    el.textContent = n.toLocaleString('vi-VN');
  }

  function applyLocalFilter(){
    const onlyMismatch = !!document.getElementById('fMismatchOnly')?.checked;
    const groupByCccd = !!document.getElementById('fGroupByCccd')?.checked;

    const seen = new Set();

    document.querySelectorAll('tr[data-row="1"]').forEach(tr=>{
      const cccd = (tr.getAttribute('data-cccd') || '').trim();
      const isMatch = (tr.dataset.nameMatch === "1");

      let show = true;

      // ✅ mismatch-only: ONLY filters mismatch; NO implicit grouping anymore
      if(onlyMismatch){
        if(isMatch) show = false;
      }

      // ✅ grouping only when groupByCccd is checked
      if(show && groupByCccd){
        const key = cccd || "__NO_CCCD__";
        if(seen.has(key)) show = false;
        else seen.add(key);
      }

      tr.classList.toggle('hidden', !show);
    });

    updateVisibleCount();
  }

  document.getElementById('fMismatchOnly')?.addEventListener('change', ()=> applyLocalFilter());
  document.getElementById('fGroupByCccd')?.addEventListener('change', ()=> applyLocalFilter());

  // ✅ Default local checkbox states for LIST when landing (per your requirement)
  //   - mismatch checked
  //   - group checked
  (function setListLocalDefaultsOnce(){
    const u = currentUrl();
    const hasProject = !!(u.searchParams.get('project') || '').trim();
    if(!hasProject) return;

    // only auto-set if user hasn't interacted in this load (fresh load)
    const mismatch = document.getElementById('fMismatchOnly');
    const group = document.getElementById('fGroupByCccd');
    if(mismatch) mismatch.checked = true;
    if(group) group.checked = true;
  })();

  applyNameColors();
  applyLocalFilter();
  updateVisibleCount();

  // -------------------------
  // Modal helpers (UNCHANGED)
  // -------------------------
  function badgeMeta(level){
    const lvl = String(level || 'LOW').toUpperCase();
    if (lvl === 'HIGH') return { text: 'Cao', cls: 'bg-emerald-100 text-emerald-800 border-emerald-200' };
    if (lvl === 'MEDIUM') return { text: 'TB', cls: 'bg-amber-100 text-amber-800 border-amber-200' };
    return { text: 'Thấp', cls: 'bg-rose-100 text-rose-800 border-rose-200' };
  }

  function fmtTime(s){
    if(!s) return '—';
    try{
      const d = new Date(s);
      if (Number.isNaN(d.getTime())) return String(s);
      return d.toLocaleString('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh' });
    }catch(e){
      return String(s);
    }
  }

  const modal = document.getElementById('detailModal');
  const backdrop = document.getElementById('detailBackdrop');
  const btnClose = document.getElementById('dmClose');

  function openModal(){
    modal?.classList.remove('hidden');
    document.documentElement.classList.add('overflow-hidden');
  }
  function closeModal(){
    modal?.classList.add('hidden');
    document.documentElement.classList.remove('overflow-hidden');
  }

  btnClose?.addEventListener('click', closeModal);
  backdrop?.addEventListener('click', closeModal);
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal(); });

  async function loadDetail(candidateId){
    const loading = document.getElementById('dmLoading');
    const err = document.getElementById('dmError');
    const body = document.getElementById('dmBody');
    const subtitle = document.getElementById('dmSubtitle');

    loading.classList.remove('hidden');
    err.classList.add('hidden');
    body.classList.add('hidden');
    subtitle.textContent = `candidate_id=${candidateId}`;

    try{
      const res = await fetch(`/auction/refunds/detail.json?candidate_id=${encodeURIComponent(candidateId)}`, {
        headers: { 'Accept': 'application/json' }
      });

      const js = await res.json().catch(()=> ({}));
      if(!res.ok || js.ok === false){
        const msg = (js && (js.detail || js.message)) || `HTTP ${res.status}`;
        throw new Error(msg);
      }

      const cand = js.candidate || {};
      const cur  = js.current_refund_account || {};
      const others = js.accounts_used || [];

      const curLvl = String(cur.trust_level || 'LOW').toUpperCase();
      const curScore = (cur.trust_score ?? 0);

      const b = badgeMeta(curLvl);
      const badge = document.getElementById('dmCurBadge');
      badge.className = `inline-flex items-center px-2 py-0.5 rounded-lg border text-xs font-semibold ${b.cls}`;
      badge.textContent = b.text;

      document.getElementById('dmCurScore').textContent = String(curScore);

      const bankCode = cur.bank_code || cand.bank_code || '';
      const accNo = cur.account_number || cand.account_number || '';
      const accName = cur.account_name || cand.account_name || '';
      document.getElementById('dmCurAccount').textContent =
        `${bankCode}${bankCode && accNo ? ' — ' : ''}${accNo}`.trim() || '—';
      document.getElementById('dmCurName').textContent = accName || '—';

      const totalIn = cur.total_in_amount_vnd ?? 0;
      const seen = cur.seen_count ?? 0;
      const firstAt = cur.first_paid_at ?? null;
      const lastAt = cur.last_paid_at ?? null;

      const curTotalEl = document.getElementById('dmCurTotal');
      curTotalEl.setAttribute('data-value', String(totalIn || 0));
      curTotalEl.textContent = formatVND(totalIn || 0);

      document.getElementById('dmCurSeen').textContent = String(seen || 0);
      document.getElementById('dmCurFirst').textContent = fmtTime(firstAt);
      document.getElementById('dmCurLast').textContent = fmtTime(lastAt);

      const cname = cand.customer_name || '';
      const cccd = cand.customer_cccd || '';
      const lot = cand.lot_code || '';
      subtitle.textContent = `${cname}${cname && cccd ? ' • ' : ''}${cccd}${(cname||cccd) && lot ? ' • ' : ''}${lot}`.trim() || `candidate_id=${candidateId}`;

      const tbody = document.getElementById('dmOtherTbody');
      tbody.innerHTML = '';

      if(Array.isArray(others) && others.length){
        for(const a of others){
          const lvl = String(a.trust_level || 'LOW').toUpperCase();
          const score = (a.trust_score ?? 0);
          const bb = badgeMeta(lvl);

          const aBank = a.bank_code || '';
          const aAcc = a.account_number_raw || a.account_number_norm || '';
          const aName = a.account_name_raw || '';
          const aTotal = a.total_in_amount_vnd ?? 0;
          const aSeen  = a.seen_count ?? 0;
          const aFirst = a.first_paid_at ?? null;
          const aLast  = a.last_paid_at ?? null;
          const isCur = !!a.is_current_refund_account;

          const tr = document.createElement('tr');
          tr.className = isCur ? 'bg-indigo-50/60' : '';
          tr.innerHTML = `
            <td class="px-3 py-2 whitespace-nowrap">
              <div class="flex items-center gap-2">
                <span class="inline-flex items-center px-2 py-0.5 rounded-lg border text-xs font-semibold ${bb.cls}">${bb.text}</span>
                <span class="text-xs text-slate-500">(${score})</span>
                ${isCur ? '<span class="text-[10px] px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-800 border border-indigo-200">Đang chọn</span>' : ''}
              </div>
            </td>
            <td class="px-3 py-2">
              <div class="font-semibold text-slate-900">${(aBank && aAcc) ? `${aBank} — ${aAcc}` : (aAcc || '—')}</div>
              <div class="text-xs text-slate-500">${aName || ''}</div>
            </td>
            <td class="px-3 py-2 text-right whitespace-nowrap">${formatVND(aTotal || 0)}</td>
            <td class="px-3 py-2 text-right whitespace-nowrap">${String(aSeen || 0)}</td>
            <td class="px-3 py-2 whitespace-nowrap text-slate-600">${fmtTime(aFirst)}</td>
            <td class="px-3 py-2 whitespace-nowrap text-slate-600">${fmtTime(aLast)}</td>
          `;
          tbody.appendChild(tr);
        }
      }else{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="6" class="px-3 py-3 text-slate-400 text-center">Không có dữ liệu tài khoản tham khảo.</td>`;
        tbody.appendChild(tr);
      }

      loading.classList.add('hidden');
      err.classList.add('hidden');
      body.classList.remove('hidden');
    }catch(e){
      loading.classList.add('hidden');
      body.classList.add('hidden');
      err.classList.remove('hidden');
      err.textContent = `Không tải được chi tiết: ${e?.message || e}`;
    }
  }

  document.querySelectorAll('.btnDetail').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.getAttribute('data-id');
      if(!id) return;
      openModal();
      await loadDetail(id);
    });
  });
</script>
{% endif %}

{# =========================================================
   AUDIT SCRIPT (only when tab==audit)
   ========================================================= #}
{% if tab == 'audit' %}
<script>
  const AUDIT_PROJECT_ID = {{ project_id or 'null' }};

  function debounce(fn, wait){
    let t=null;
    return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); };
  }

  function formatVND(value){
    if (value === null || value === undefined || value === '') return '—';
    const s = String(value).trim();
    const n = Number(s.replace(/,/g,''));
    if (!Number.isFinite(n)) return '—';
    const v = Math.round(n);
    return v.toLocaleString('vi-VN');
  }

  function fmtTime(s){
    if(!s) return '—';
    try{
      const d = new Date(s);
      if (Number.isNaN(d.getTime())) return String(s);
      return d.toLocaleString('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh' });
    }catch(e){
      return String(s);
    }
  }

  function riskBadge(level){
    const lvl = String(level || 'ANOMALY').toUpperCase();
    if(lvl === 'SAFE') return { text:'SAFE', cls:'bg-emerald-100 text-emerald-800 border-emerald-200' };
    if(lvl === 'RISKY_LATE') return { text:'RISK', cls:'bg-rose-100 text-rose-800 border-rose-200' };
    if(lvl === 'RISKY_NO_BANK') return { text:'NO BANK', cls:'bg-amber-100 text-amber-800 border-amber-200' };
    return { text:'ANOMALY', cls:'bg-slate-100 text-slate-800 border-slate-200' };
  }

  function setText(id, v){
    const el = document.getElementById(id);
    if(!el) return;
    el.textContent = (v === null || v === undefined) ? '—' : String(v);
  }

  function setMoney(id, v){
    const el = document.getElementById(id);
    if(!el) return;
    el.setAttribute('data-value', String(v || 0));
    el.textContent = formatVND(v || 0);
  }

  function showAuditError(msg){
    const box = document.getElementById('auditError');
    if(!box) return;
    box.classList.remove('hidden');
    box.textContent = msg || 'Không tải được audit.';
  }
  function hideAuditError(){
    const box = document.getElementById('auditError');
    if(!box) return;
    box.classList.add('hidden');
    box.textContent = '';
  }

  function updateAuditVisibleCount(){
    const el = document.getElementById('auditVisibleCount');
    if(!el) return;
    const rows = Array.from(document.querySelectorAll('tr[data-audit-row="1"]'));
    const n = rows.filter(tr=> !tr.classList.contains('hidden')).length;
    el.textContent = n.toLocaleString('vi-VN');
  }

  function applyAuditLocalFilter(){
    const onlyRisk = !!document.getElementById('auditOnlyRisk')?.checked;
    const onlyChanged = !!document.getElementById('auditOnlyChanged')?.checked;
    const onlyNoBank = !!document.getElementById('auditOnlyNoBank')?.checked;
    const groupBy = !!document.getElementById('auditGroupByCccd')?.checked;
    const q = String(document.getElementById('auditQ')?.value || '').trim().toLowerCase();

    // ✅ NEW: eligible filter (local)
    const eligibleMode = String(document.getElementById('auditEligible')?.value || 'ELIGIBLE').toUpperCase();

    const seen = new Set();

    document.querySelectorAll('tr[data-audit-row="1"]').forEach(tr=>{
      const risk = (tr.getAttribute('data-risk') || '').toUpperCase();
      const changed = (tr.getAttribute('data-changed') || '0') === '1';
      const hasBank = (tr.getAttribute('data-hasbank') || '0') === '1';
      const cccd = (tr.getAttribute('data-cccd') || '').trim();
      const hay = (tr.getAttribute('data-hay') || '').toLowerCase();
      const eligible = (tr.getAttribute('data-eligible') || '').toUpperCase(); // ELIGIBLE|EXCLUDED

      let show = true;

      if(eligibleMode !== 'ALL'){
        if(eligible !== eligibleMode) show = false;
      }

      if(show && onlyRisk){
        if(risk === 'SAFE') show = false;
      }
      if(show && onlyChanged){
        if(!changed) show = false;
      }
      if(show && onlyNoBank){
        if(hasBank) show = false;
      }
      if(show && q){
        if(!hay.includes(q)) show = false;
      }

      if(show && groupBy){
        const key = cccd || "__NO_CCCD__";
        if(seen.has(key)) show = false;
        else seen.add(key);
      }

      tr.classList.toggle('hidden', !show);
    });

    updateAuditVisibleCount();
  }

  document.getElementById('auditEligible')?.addEventListener('change', applyAuditLocalFilter);
  document.getElementById('auditOnlyRisk')?.addEventListener('change', applyAuditLocalFilter);
  document.getElementById('auditOnlyChanged')?.addEventListener('change', applyAuditLocalFilter);
  document.getElementById('auditOnlyNoBank')?.addEventListener('change', applyAuditLocalFilter);
  document.getElementById('auditGroupByCccd')?.addEventListener('change', applyAuditLocalFilter);
  document.getElementById('auditQ')?.addEventListener('input', debounce(applyAuditLocalFilter, 150));

  function setAuditDefaults(){
    const eligibleSel = document.getElementById('auditEligible');
    const onlyRisk = document.getElementById('auditOnlyRisk');
    if(eligibleSel) eligibleSel.value = 'ELIGIBLE';   // ✅ default must refund
    if(onlyRisk) onlyRisk.checked = true;             // ✅ default only risk
    // keep others false by default
    const changed = document.getElementById('auditOnlyChanged'); if(changed) changed.checked = false;
    const nobank = document.getElementById('auditOnlyNoBank'); if(nobank) nobank.checked = false;
    const group = document.getElementById('auditGroupByCccd'); if(group) group.checked = false;
    const q = document.getElementById('auditQ'); if(q) q.value = '';
  }

  document.getElementById('btnAuditReset')?.addEventListener('click', ()=>{
    setAuditDefaults();
    applyAuditLocalFilter();
  });

  async function loadAudit(){
    if(!AUDIT_PROJECT_ID){
      return;
    }
    hideAuditError();

    const tbody = document.getElementById('auditTbody');
    if(tbody){
      tbody.innerHTML = `<tr><td colspan="10" class="px-4 py-6 text-center text-slate-400">Đang tải audit…</td></tr>`;
    }

    try{
      const res = await fetch(`/auction/refunds/check.json?project_id=${encodeURIComponent(String(AUDIT_PROJECT_ID))}`, {
        headers: { 'Accept': 'application/json' }
      });
      const js = await res.json().catch(()=> ({}));
      if(!res.ok || js.ok === false){
        const msg = (js && (js.detail || js.message)) || `HTTP ${res.status}`;
        throw new Error(msg);
      }

      const s = js.summary || {};
      setText('sTotalTxn', (s.total_txn ?? '—'));
      setMoney('sTotalAmount', s.total_amount_vnd ?? 0);

      setText('sMustRefundTxn', (s.must_refund_txn ?? '—'));
      setText('sExcludedTxn', (s.excluded_txn ?? '—'));
      setMoney('sMustRefundAmount', s.must_refund_amount_vnd ?? 0);
      setMoney('sExcludedAmount', s.excluded_amount_vnd ?? 0);

      setText('sHasBank', (s.has_refund_bank_txn ?? '—'));
      setText('sNoBank', (s.no_refund_bank_txn ?? '—'));
      setText('sBankChanged', (s.bank_changed_txn ?? '—'));

      const r = (s.risk || {});
      setText('sSafe', r.safe_txn ?? '—');
      setText('sRiskLate', r.risky_late_txn ?? '—');
      setText('sRiskNoBank', r.risky_no_bank_txn ?? '—');
      setText('sAnomaly', r.anomaly_txn ?? '—');

      const data = Array.isArray(js.data) ? js.data : [];
      if(!tbody) return;

      if(!data.length){
        tbody.innerHTML = `<tr><td colspan="10" class="px-4 py-6 text-center text-slate-400">Không có dữ liệu audit.</td></tr>`;
        updateAuditVisibleCount();
        return;
      }

      tbody.innerHTML = '';
      for(const item of data){
        const a = item.audit || {};
        const risk = String(a.bank_update_risk_level || 'ANOMALY').toUpperCase();
        const b = riskBadge(risk);

        const hasBank = !!a.has_refund_bank;
        const changed = !!a.bank_account_changed;
        const delay = (a.bank_last_after_customer_create_minutes ?? null);

        const name = item.customer_name || '-';
        const cccd = item.customer_cccd || '';
        const lot = item.lot_code || '';
        const amt = (item.refund_amount_vnd ?? item.paid_vnd ?? 0);

        const bankCode = item.bank_code || '';
        const accNo = item.account_number || '';
        const accName = item.account_name || '';

        const cusC = fmtTime(a.customer_created_at);
        const cusU = fmtTime(a.customer_updated_at);
        const bankC = fmtTime(a.bank_account_created_at);
        const bankU = fmtTime(a.bank_account_updated_at);

        const hay = [
          name, cccd, lot, bankCode, accNo, accName, (item.order_code||''), (item.content||'')
        ].filter(Boolean).join(' | ');

        const eligible = (item.eligible === true) ? 'ELIGIBLE' : 'EXCLUDED';

        const tr = document.createElement('tr');
        tr.setAttribute('data-audit-row','1');
        tr.setAttribute('data-risk', risk);
        tr.setAttribute('data-changed', changed ? '1' : '0');
        tr.setAttribute('data-hasbank', hasBank ? '1' : '0');
        tr.setAttribute('data-cccd', cccd);
        tr.setAttribute('data-hay', hay);
        tr.setAttribute('data-eligible', eligible);

        tr.innerHTML = `
          <td class="px-4 py-3 whitespace-nowrap">
            <span class="inline-flex items-center px-2 py-0.5 rounded-lg border text-xs font-semibold ${b.cls}">
              ${b.text}
            </span>
          </td>

          <td class="px-4 py-3">
            <div class="font-semibold text-slate-900">${name}</div>
          </td>

          <td class="px-4 py-3 text-slate-600 whitespace-nowrap">${cccd}</td>

          <td class="px-4 py-3 text-slate-600 whitespace-nowrap">${lot}</td>

          <td class="px-4 py-3 text-right whitespace-nowrap">
            ${formatVND(amt)}
          </td>

          <td class="px-4 py-3 text-slate-700">
            ${(bankCode || accNo) ? `
              <div class="text-xs">
                <div class="font-semibold">${bankCode}${(bankCode && accNo) ? ' — ' : ''}${accNo}</div>
                <div class="text-slate-600">${accName || ''}</div>
              </div>
            ` : `<span class="text-slate-400 text-xs">Chưa có TK hoàn</span>`}
          </td>

          <td class="px-4 py-3 text-right whitespace-nowrap">
            ${(delay === null || delay === undefined) ? '—' : String(delay)}
          </td>

          <td class="px-4 py-3 whitespace-nowrap">
            ${changed
              ? '<span class="inline-flex items-center px-2 py-0.5 rounded-lg border text-xs font-semibold bg-rose-100 text-rose-800 border-rose-200">Có</span>'
              : '<span class="inline-flex items-center px-2 py-0.5 rounded-lg border text-xs font-semibold bg-slate-50 text-slate-700 border-slate-200">Không</span>'
            }
          </td>

          <td class="px-4 py-3 text-xs text-slate-600 whitespace-nowrap">
            <div><span class="text-slate-400">c:</span> <b class="text-slate-900">${cusC}</b></div>
            <div><span class="text-slate-400">u:</span> <b class="text-slate-900">${cusU}</b></div>
          </td>

          <td class="px-4 py-3 text-xs text-slate-600 whitespace-nowrap">
            <div><span class="text-slate-400">c:</span> <b class="text-slate-900">${bankC}</b></div>
            <div><span class="text-slate-400">u:</span> <b class="text-slate-900">${bankU}</b></div>
          </td>
        `;

        tbody.appendChild(tr);
      }

      // ✅ defaults then filter
      setAuditDefaults();
      applyAuditLocalFilter();
      updateAuditVisibleCount();
    }catch(e){
      showAuditError(`Không tải được audit: ${e?.message || e}`);
      const tbody = document.getElementById('auditTbody');
      if(tbody){
        tbody.innerHTML = `<tr><td colspan="10" class="px-4 py-6 text-center text-slate-400">Không tải được audit.</td></tr>`;
      }
    }
  }

  document.getElementById('btnAuditReload')?.addEventListener('click', loadAudit);

  if(AUDIT_PROJECT_ID){
    loadAudit();
  }
</script>
{% endif %}
{% endblock %}
