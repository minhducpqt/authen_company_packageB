{% extends "base.html" %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<style>
  /* --- light utility helpers (không phụ thuộc tailwind) --- */
  .card { background:#fff; border:1px solid #e2e8f0; border-radius:16px; }
  .card-h { padding:14px 16px; border-bottom:1px solid #eef2f7; }
  .card-b { padding:16px; }
  .muted { color:#64748b; }
  .kpi { border:1px solid #e2e8f0; border-radius:14px; padding:12px; }
  .chip { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid #e2e8f0; background:#fff; }
  .chip-ok { border-color:#bbf7d0; background:#f0fdf4; color:#166534; }
  .chip-warn { border-color:#fde68a; background:#fffbeb; color:#92400e; }
  .chip-bad { border-color:#fecaca; background:#fff1f2; color:#9f1239; }

  .doc-mini { border:1px solid #e2e8f0; border-radius:14px; overflow:hidden; background:#fff; cursor:pointer; }
  .doc-mini.active { outline:2px solid #6366f1; outline-offset:2px; }
  .doc-mini .top { padding:10px 12px; display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
  .doc-mini .name { font-weight:700; color:#0f172a; font-size:13px; line-height:1.2; }
  .doc-mini .sub { font-size:12px; color:#64748b; margin-top:3px; }
  .doc-mini .thumb { background:#f8fafc; height:110px; display:flex; align-items:center; justify-content:center; color:#94a3b8; font-size:12px; }
  .doc-mini img { width:100%; height:110px; object-fit:cover; display:block; }
  .doc-mini iframe { width:100%; height:110px; border:0; background:#fff; }

  /* Thumbnail chỉ preview — không cho tương tác để click luôn select được */
  .doc-mini .thumb,
  .doc-mini .thumb *{
    pointer-events: none !important;
    user-select: none;
  }

  /* nếu có iframe/pdf */
  .doc-mini iframe{
    pointer-events: none !important;
  }

  /* (tuỳ chọn) cho cảm giác click rõ hơn */
  .doc-mini{
    cursor: pointer;
  }
  .doc-mini:active{
    transform: scale(0.997);
  }

  .preview-wrap { background:#0b1220; border-radius:16px; overflow:hidden; border:1px solid #1f2a44; }
  .preview-inner { background:#0b1220; height:460px; display:flex; align-items:center; justify-content:center; }
  .preview-inner img { max-width:100%; max-height:100%; object-fit:contain; display:block; }
  .preview-inner iframe { width:100%; height:460px; border:0; background:#fff; }
  .preview-empty { color:#94a3b8; font-size:14px; padding:22px; text-align:center; }

  .btn { display:inline-flex; align-items:center; justify-content:center; gap:8px;
         padding:10px 14px; border-radius:12px; border:1px solid #e2e8f0; background:#fff; cursor:pointer; }
  .btn:hover { background:#f8fafc; }
  .btn-primary { border-color:#c7d2fe; background:#eef2ff; color:#3730a3; }
  .btn-primary:hover { background:#e0e7ff; }
  .btn-danger { border-color:#fecaca; background:#fff1f2; color:#9f1239; }
  .btn:disabled { opacity:.45; cursor:not-allowed; }

  .grid2 { display:grid; grid-template-columns: 380px 1fr; gap:16px; }
  @media (max-width: 1024px){ .grid2 { grid-template-columns: 1fr; } .preview-inner{height:360px} .preview-inner iframe{height:360px} }

  /* modal */
  .backdrop { position:fixed; inset:0; background:rgba(2,6,23,.6); display:none; align-items:center; justify-content:center; z-index:9999; }
  .backdrop.show { display:flex; }
  .modal { width:min(980px, 92vw); background:#fff; border-radius:18px; overflow:hidden; border:1px solid #e2e8f0; box-shadow:0 16px 50px rgba(2,6,23,.25); }
  .modal-h { padding:12px 14px; display:flex; align-items:center; justify-content:space-between; gap:10px; border-bottom:1px solid #eef2f7; }
  .modal-b { padding:0; background:#0b1220; }
  .modal-view { height:min(74vh, 720px); display:flex; align-items:center; justify-content:center; }
  .modal-view img { max-width:100%; max-height:100%; object-fit:contain; }
  .modal-view iframe { width:100%; height:min(74vh, 720px); border:0; background:#fff; }

  /* toast */
  #toast { position:fixed; right:18px; bottom:18px; z-index:10000; display:none; align-items:center; gap:10px;
           background:#0f172a; color:#fff; padding:10px 12px; border-radius:14px; box-shadow:0 10px 28px rgba(2,6,23,.25); font-size:13px; }
  #toast.show{ display:flex; }
</style>

<div class="card" style="padding:16px;">
  <!-- top bar -->
  <div class="flex items-start justify-between gap-3 flex-wrap">
    <div>
      <div class="flex items-center gap-2 flex-wrap">
        <a href="{{ back_url }}" class="muted hover:text-indigo-600 inline-flex items-center gap-1" style="text-decoration:none;">
          <i class="ri-arrow-left-line"></i><span>Quay lại</span>
        </a>
        <span class="muted">/</span>
        <div class="text-lg font-semibold text-slate-800">4.1 Chi tiết giấy tờ</div>
      </div>
      <div class="muted text-sm mt-1">Xem nhanh trạng thái + mở/preview + copy link.</div>
    </div>

    <div class="flex gap-2 items-center">
      <select id="projectSelect" class="rounded-xl border border-slate-200 px-3 py-2 bg-white text-sm">
        {% for p in projects %}
          <option value="{{ p.id }}" {% if project_id == p.id %}selected{% endif %}>
            {{ p.project_code }} — {{ p.name }}
          </option>
        {% endfor %}
      </select>
      <button id="btnReload" class="btn"><i class="ri-refresh-line"></i> Tải lại</button>
    </div>
  </div>

  <div class="mt-4 grid2">

    <!-- LEFT SUMMARY -->
    <div class="space-y-4">
      <div class="card">
        <div class="card-h flex items-center justify-between">
          <div class="font-semibold text-slate-800">Tóm tắt khách</div>
          <span id="docBadge" class="chip">—</span>
        </div>
        <div class="card-b text-sm">
          <div class="space-y-2">
            <div class="flex justify-between gap-3"><span class="muted">Họ tên</span><span id="cName" class="font-semibold text-slate-900 text-right">—</span></div>
            <div class="flex justify-between gap-3"><span class="muted">CCCD</span><span id="cCCCD" class="font-mono text-right">—</span></div>
            <div class="flex justify-between gap-3"><span class="muted">SĐT</span><span id="cPhone" class="text-right">—</span></div>
            <div class="flex justify-between gap-3"><span class="muted">Email</span><span id="cEmail" class="text-right break-all">—</span></div>
            <div class="flex justify-between gap-3"><span class="muted">Ngày sinh</span><span id="cDob" class="text-right">—</span></div>
          </div>

          <div class="mt-4 grid grid-cols-2 gap-3">
            <div class="kpi">
              <div class="muted text-xs">Cọc (PAID)</div>
              <div class="mt-1 text-lg font-semibold text-slate-900"><span id="depCount">0</span> lô</div>
              <div class="mt-1 text-xs muted">Tổng: <span id="depTotal">—</span></div>
              <div class="mt-1 text-xs muted">Gần nhất: <span id="depLast">—</span></div>
            </div>
            <div class="kpi">
              <div class="muted text-xs">Mua hồ sơ (PAID)</div>
              <div class="mt-1 text-lg font-semibold text-slate-900"><span id="dosTotal">—</span></div>
              <div class="mt-1 text-xs muted">Gần nhất: <span id="dosLast">—</span></div>
            </div>
          </div>

          <div class="mt-4">
            <div class="font-semibold text-slate-800">Link đăng ký (private)</div>
            <div class="mt-2 flex gap-2">
              <input id="regLink" class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" readonly />
              <button id="btnCopyReg" class="btn btn-primary"><i class="ri-file-copy-line"></i> Copy</button>
            </div>
            <div class="mt-2 text-xs muted">
              Tạo lúc: <span id="regCreated">—</span> · Trạng thái: <span id="regStatus">—</span>
            </div>
          </div>
        </div>
      </div>

      <!-- LOTS TABLE -->
      <div class="card">
        <div class="card-h flex items-center justify-between">
          <div class="font-semibold text-slate-800">Lô đã cọc (PAID)</div>
          <div class="muted text-sm">Tổng: <b id="lotsTotal">0</b></div>
        </div>
        <div class="card-b overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="border-b text-slate-500">
                <th class="py-2 pr-3 text-left">Lô</th>
                <th class="py-2 pr-3 text-left">Giá</th>
                <th class="py-2 pr-3 text-left">Cọc</th>
                <th class="py-2 pr-3 text-left">Đã nộp</th>
                <th class="py-2 pr-3 text-left">Ngày nộp</th>
              </tr>
            </thead>
            <tbody id="lotsTbody">
              <tr><td colspan="5" class="py-8 text-center text-slate-400">Đang tải…</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- RIGHT DOCS -->
    <div class="space-y-4">
      <div class="card">
        <div class="card-h flex items-center justify-between">
          <div>
            <div class="font-semibold text-slate-800">Giấy tờ</div>
            <div class="muted text-sm mt-1">Chọn 1 giấy tờ để xem lớn. PDF nếu bị chặn nhúng vẫn có nút mở.</div>
          </div>
          <div class="flex gap-2">
            <button id="btnOpenDoc" class="btn btn-primary" disabled><i class="ri-external-link-line"></i> Mở</button>
            <button id="btnCopyDoc" class="btn" disabled><i class="ri-file-copy-line"></i> Copy link</button>
            <button id="btnZoom" class="btn" disabled><i class="ri-zoom-in-line"></i> Xem lớn</button>
          </div>
        </div>

        <div class="card-b">
          <!-- mini cards row -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div id="mini-front" class="doc-mini">
              <div class="top">
                <div>
                  <div class="name">CCCD mặt trước</div>
                  <div class="sub">Upload: <span id="frontAt">—</span></div>
                </div>
                <span id="frontState" class="chip">—</span>
              </div>
              <div id="frontThumb" class="thumb">Chưa có</div>
            </div>

            <div id="mini-back" class="doc-mini">
              <div class="top">
                <div>
                  <div class="name">CCCD mặt sau</div>
                  <div class="sub">Upload: <span id="backAt">—</span></div>
                </div>
                <span id="backState" class="chip">—</span>
              </div>
              <div id="backThumb" class="thumb">Chưa có</div>
            </div>

            <div id="mini-form" class="doc-mini">
              <div class="top">
                <div>
                  <div class="name">Phiếu ĐK đã ký</div>
                  <div class="sub">Upload: <span id="formAt">—</span></div>
                </div>
                <span id="formState" class="chip">—</span>
              </div>
              <div id="formThumb" class="thumb">Chưa có</div>
            </div>
          </div>

          <!-- big preview -->
          <div class="mt-4 preview-wrap">
            <div id="bigPreview" class="preview-inner">
              <div class="preview-empty">Chọn giấy tờ để xem preview</div>
            </div>
          </div>

          <div class="mt-3 flex items-center justify-between gap-3 flex-wrap">
            <div class="muted text-sm">
              Đang chọn: <b id="selectedLabel">—</b>
              <span class="muted"> · </span>
              Loại: <span id="selectedType">—</span>
            </div>
            <div class="muted text-xs">
              Nếu iframe PDF bị chặn (CSP/X-Frame-Options), hãy dùng nút <b>Mở</b>.
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Modal viewer -->
<div id="viewer" class="backdrop" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modal-h">
      <div class="text-sm font-semibold text-slate-800" id="viewerTitle">Xem giấy tờ</div>
      <div class="flex gap-2 items-center">
        <button id="viewerOpen" class="btn btn-primary"><i class="ri-external-link-line"></i> Mở</button>
        <button id="viewerCopy" class="btn"><i class="ri-file-copy-line"></i> Copy</button>
        <button id="viewerClose" class="btn btn-danger"><i class="ri-close-line"></i> Đóng</button>
      </div>
    </div>
    <div class="modal-b">
      <div id="viewerBody" class="modal-view"></div>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast"><i class="ri-checkbox-circle-line" style="color:#34d399;font-size:18px;"></i><span id="toastText">Đã copy</span></div>

<script>
const DATA_URL = "{{ data_url }}";
const BASE_PATH = "{{ base_path }}";
const ORIGIN_BASE = "https://khachhang.daugiathongminh.vn";
const FALLBACK_PUBLIC_BASE = "https://khachhang.daugiathongminh.vn/public/registration/";
const CUSTOMER_ID = {{ customer_id }};
let PROJECT_ID = {{ project_id }};

const esc = (s) => (s ?? "").toString()
  .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
  .replace(/"/g,"&quot;").replace(/'/g,"&#039;");

function showToast(msg="Đã copy"){
  const t = document.getElementById("toast");
  document.getElementById("toastText").textContent = msg;
  t.classList.add("show");
  clearTimeout(window.__t);
  window.__t = setTimeout(()=>t.classList.remove("show"), 1600);
}

async function copyToClipboard(text){
  if(!text) return false;
  try{
    if(navigator.clipboard && window.isSecureContext){
      await navigator.clipboard.writeText(text);
      return true;
    }
  }catch(e){}
  try{
    const tmp = document.createElement("textarea");
    tmp.value = text;
    tmp.style.position = "fixed";
    tmp.style.left = "-9999px";
    tmp.style.top = "-9999px";
    document.body.appendChild(tmp);
    tmp.focus(); tmp.select();
    const ok = document.execCommand("copy");
    document.body.removeChild(tmp);
    return !!ok;
  }catch(e){}
  return false;
}

function fmtMoney(v){
  if(v === null || v === undefined) return "—";
  const n = Number(v);
  if(Number.isFinite(n)) return n.toLocaleString("vi-VN");
  return String(v);
}
function fmtDateTime(v){
  if(!v) return "—";
  const s = String(v).trim();
  if(!s) return "—";
  let m = s.match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2}):(\d{2})/);
  if(m){
    const [_, yy, mm, dd, HH, MI, SS] = m;
    return `${dd}/${mm}/${yy} ${HH}:${MI}:${SS}`;
  }
  const d = new Date(s);
  if(!isNaN(d.getTime())){
    const pad = (n)=> String(n).padStart(2,"0");
    return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }
  return s;
}

function buildRegistrationUrl(r){
  if (r.registration_path) return ORIGIN_BASE + r.registration_path;
  if (r.registration_token) return FALLBACK_PUBLIC_BASE + r.registration_token;
  return "";
}

function chipStatus(ok){
  if(ok) return `<span class="chip chip-ok">OK</span>`;
  return `<span class="chip chip-bad">Thiếu</span>`;
}
function chipComplete(isComplete){
  if(isComplete) return `<span class="chip chip-ok">Đã đủ</span>`;
  return `<span class="chip chip-warn">Thiếu giấy tờ</span>`;
}

/* guess kind */
function _stripQuery(url){ try{ return (url||"").split("#")[0].split("?")[0]; }catch(e){ return url||""; } }
function _extFromUrl(url){
  const u = _stripQuery(url);
  const m = u.match(/\.([a-zA-Z0-9]{2,5})$/);
  return (m && m[1]) ? m[1].toLowerCase() : "";
}
function guessKind(mime, url){
  const m = (mime || "").toLowerCase().trim();
  if(m.includes("pdf")) return "pdf";
  if(m.startsWith("image/")) return "image";
  const ext = _extFromUrl(url);
  if(["jpg","jpeg","png","webp","gif","bmp"].includes(ext)) return "image";
  if(ext === "pdf") return "pdf";
  return "other";
}

/* global state */
let DOCS = {
  front: { label:"CCCD mặt trước", url:null, mime:null, at:null },
  back:  { label:"CCCD mặt sau", url:null, mime:null, at:null },
  form:  { label:"Phiếu ĐK đã ký", url:null, mime:null, at:null },
};
let SELECTED = "front";

function setMini(id, ok, at, url, mime){
  document.getElementById(id+"At").textContent = fmtDateTime(at);
  document.getElementById(id+"State").innerHTML = ok ? `<span class="chip chip-ok">OK</span>` : `<span class="chip chip-bad">Thiếu</span>`;

  const thumb = document.getElementById(id+"Thumb");
  if(!url){
    thumb.innerHTML = "Chưa có";
    return;
  }

  const kind = guessKind(mime, url);
  const safe = esc(url);

  if(kind==="image"){
    thumb.innerHTML = `<img src="${safe}" alt="thumb" onerror="this.remove(); this.parentElement.textContent='Không tải được ảnh';" />`;
    return;
  }
  if(kind==="pdf"){
    thumb.innerHTML = `<iframe src="${safe}" title="pdf thumb"></iframe>`;
    return;
  }
  thumb.innerHTML = `<div class="muted">Có file</div>`;
}

function markActive(){
  ["front","back","form"].forEach(k=>{
    document.getElementById("mini-"+k).classList.toggle("active", k===SELECTED);
  });

  const d = DOCS[SELECTED];
  document.getElementById("selectedLabel").textContent = d.label;
  document.getElementById("selectedType").textContent = d.url ? guessKind(d.mime, d.url).toUpperCase() : "—";

  const has = !!d.url;
  document.getElementById("btnOpenDoc").disabled = !has;
  document.getElementById("btnCopyDoc").disabled = !has;
  document.getElementById("btnZoom").disabled = !has;

  renderBigPreview(d.url, d.mime);
}

function renderBigPreview(url, mime){
  const box = document.getElementById("bigPreview");
  if(!url){
    box.innerHTML = `<div class="preview-empty">Chưa có file</div>`;
    return;
  }
  const kind = guessKind(mime, url);
  const safe = esc(url);

  if(kind==="image"){
    box.innerHTML = `<img src="${safe}" alt="preview" onerror="this.remove(); document.getElementById('bigPreview').innerHTML='<div class=&quot;preview-empty&quot;>Không preview được ảnh. Hãy bấm Mở.</div>';" />`;
    return;
  }
  if(kind==="pdf"){
    box.innerHTML = `<iframe src="${safe}" title="pdf preview"></iframe>`;
    return;
  }
  box.innerHTML = `<div class="preview-empty">Không hỗ trợ preview. Hãy bấm Mở.</div>`;
}

/* modal viewer */
function openViewer(){
  const d = DOCS[SELECTED];
  if(!d.url) return;

  document.getElementById("viewerTitle").textContent = d.label;
  document.getElementById("viewer").classList.add("show");

  const body = document.getElementById("viewerBody");
  const kind = guessKind(d.mime, d.url);
  const safe = esc(d.url);

  if(kind==="image"){
    body.innerHTML = `<img src="${safe}" alt="viewer" />`;
  }else if(kind==="pdf"){
    body.innerHTML = `<iframe src="${safe}" title="viewer pdf"></iframe>`;
  }else{
    body.innerHTML = `<div class="preview-empty" style="color:#cbd5e1;">Không hỗ trợ preview. Bấm Mở để xem.</div>`;
  }

  document.getElementById("viewerOpen").onclick = ()=>window.open(d.url, "_blank", "noopener");
  document.getElementById("viewerCopy").onclick = async ()=>{
    const ok = await copyToClipboard(d.url);
    if(ok) showToast("Đã copy link tài liệu");
  };
}
function closeViewer(){
  document.getElementById("viewer").classList.remove("show");
  document.getElementById("viewerBody").innerHTML = "";
}

/* load data */
async function loadDetail(){
  const qs = new URLSearchParams({
    project: String(PROJECT_ID),
    customer_id: String(CUSTOMER_ID),
    expose_phone: "true",
    expose_docs: "true",
    lots_page: "1",
    lots_size: "200",
    lots_sort: "-deposit_paid_at"
  });

  let js;
  try{
    const r = await fetch(DATA_URL + "?" + qs.toString(), { headers: { "Accept":"application/json" } });
    js = await r.json();
  }catch(e){
    showToast("Lỗi tải dữ liệu");
    return;
  }

  const d = js.detail || {};
  const lots = (js.deposit_lots || {});
  const items = Array.isArray(lots.items) ? lots.items : [];

  // customer
  document.getElementById("cName").textContent = d.customer_full_name || "—";
  document.getElementById("cCCCD").textContent = d.customer_cccd || "—";
  document.getElementById("cPhone").textContent = d.customer_phone || "—";
  document.getElementById("cEmail").textContent = d.customer_email || "—";
  document.getElementById("cDob").textContent = d.customer_dob || "—";

  // summary
  document.getElementById("depCount").textContent = String(d.deposit_lot_count_paid || 0);
  document.getElementById("depTotal").textContent = fmtMoney(d.total_deposit_vnd_paid);
  document.getElementById("depLast").textContent = fmtDateTime(d.last_deposit_paid_at);
  document.getElementById("dosTotal").textContent = fmtMoney(d.total_dossier_vnd_paid);
  document.getElementById("dosLast").textContent = fmtDateTime(d.last_dossier_paid_at);

  // completion
  const isComplete = !!d.docs_completed_3 || !!d.is_complete;
  document.getElementById("docBadge").innerHTML = chipComplete(isComplete);

  // registration
  const regUrl = buildRegistrationUrl(d);
  document.getElementById("regLink").value = regUrl || "";
  document.getElementById("regCreated").textContent = fmtDateTime(d.registration_created_at);
  document.getElementById("regStatus").textContent = d.registration_status || "—";

  // docs (ưu tiên cột mới trong view)
  DOCS.front.url  = d.cccd_front_url  || d.doc_cccd_front_url || null;
  DOCS.back.url   = d.cccd_back_url   || d.doc_cccd_back_url  || null;
  DOCS.form.url   = d.signed_form_url || d.doc_reg_form_url   || null;

  DOCS.front.mime = d.cccd_front_mime_type  || null;
  DOCS.back.mime  = d.cccd_back_mime_type   || null;
  DOCS.form.mime  = d.signed_form_mime_type || null;

  DOCS.front.at   = d.cccd_front_uploaded_at  || d.doc_cccd_front_at || null;
  DOCS.back.at    = d.cccd_back_uploaded_at   || d.doc_cccd_back_at  || null;
  DOCS.form.at    = d.signed_form_uploaded_at || d.doc_reg_form_at   || null;

  // mini cards
  setMini("front", !!DOCS.front.url, DOCS.front.at, DOCS.front.url, DOCS.front.mime);
  setMini("back",  !!DOCS.back.url,  DOCS.back.at,  DOCS.back.url,  DOCS.back.mime);
  setMini("form",  !!DOCS.form.url,  DOCS.form.at,  DOCS.form.url,  DOCS.form.mime);

  // lots
  document.getElementById("lotsTotal").textContent = String(lots.total || items.length || 0);
  const tbody = document.getElementById("lotsTbody");
  if(!items.length){
    tbody.innerHTML = `<tr><td colspan="5" class="py-8 text-center text-slate-400">Chưa có lô cọc</td></tr>`;
  }else{
    tbody.innerHTML = items.map(r=>`
      <tr class="border-b">
        <td class="py-2 pr-3 font-semibold">${esc(r.lot_code || "—")}</td>
        <td class="py-2 pr-3">${esc(fmtMoney(r.starting_price_vnd))}</td>
        <td class="py-2 pr-3">${esc(fmtMoney(r.deposit_vnd))}</td>
        <td class="py-2 pr-3">${esc(fmtMoney(r.deposit_amount_vnd))}</td>
        <td class="py-2 pr-3 text-xs text-slate-600 whitespace-nowrap">${esc(fmtDateTime(r.deposit_paid_at))}</td>
      </tr>
    `).join("");
  }

  // default selected: ưu tiên cái nào có file
  if(DOCS.front.url) SELECTED = "front";
  else if(DOCS.back.url) SELECTED = "back";
  else if(DOCS.form.url) SELECTED = "form";
  else SELECTED = "front";

  markActive();
}

/* events */
document.getElementById("btnReload").addEventListener("click", loadDetail);

document.getElementById("projectSelect").addEventListener("change", (e)=>{
  const v = e.target.value;
  if(!v) return;
  PROJECT_ID = Number(v);
  const qs = new URLSearchParams({ project: String(PROJECT_ID), customer_id: String(CUSTOMER_ID) });
  window.location.href = `${BASE_PATH}/detail?${qs.toString()}`;
});

document.getElementById("btnCopyReg").addEventListener("click", async ()=>{
  const v = document.getElementById("regLink").value || "";
  if(!v) return;
  const ok = await copyToClipboard(v);
  if(ok) showToast("Đã copy link đăng ký");
});

document.getElementById("btnOpenDoc").addEventListener("click", ()=>{
  const d = DOCS[SELECTED];
  if(d.url) window.open(d.url, "_blank", "noopener");
});
document.getElementById("btnCopyDoc").addEventListener("click", async ()=>{
  const d = DOCS[SELECTED];
  if(!d.url) return;
  const ok = await copyToClipboard(d.url);
  if(ok) showToast("Đã copy link tài liệu");
});
document.getElementById("btnZoom").addEventListener("click", openViewer);

document.getElementById("mini-front").addEventListener("click", ()=>{ SELECTED="front"; markActive(); });
document.getElementById("mini-back").addEventListener("click", ()=>{ SELECTED="back"; markActive(); });
document.getElementById("mini-form").addEventListener("click", ()=>{ SELECTED="form"; markActive(); });

document.getElementById("viewerClose").addEventListener("click", closeViewer);
document.getElementById("viewer").addEventListener("click", (e)=>{
  if(e.target && e.target.id === "viewer") closeViewer();
});
document.addEventListener("keydown", (e)=>{
  if(e.key === "Escape") closeViewer();
});

loadDetail();
</script>
{% endblock %}
