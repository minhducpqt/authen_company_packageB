{% extends "base.html" %}
{% block title %}Mua hồ sơ{% endblock %}

{% block content %}
{% if mode == "detail" %}
  <div class="mb-6">
    <h1 class="text-2xl font-semibold text-slate-900">Mua hồ sơ — chi tiết</h1>
    <p class="text-slate-500 text-sm mt-1">
      Danh sách từng dòng hồ sơ đã thanh toán theo dự án và khách hàng.
    </p>
  </div>

  <form method="get" class="bg-white border rounded-2xl shadow-sm p-4 mb-4 flex flex-wrap gap-4 items-end">
    <div class="flex flex-col">
      <label class="text-xs font-semibold text-slate-500 mb-1">Dự án</label>
      <select name="project" class="h-10 rounded-xl border px-3 text-sm min-w-[220px]">
        <option value="">— Chọn dự án —</option>
        {% for p in projects or [] %}
          {% set code = p.project_code or p.code %}
          <option value="{{ code }}" {% if code == project %}selected{% endif %}>
            {{ code }} — {{ p.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="flex flex-col">
      <label class="text-xs font-semibold text-slate-500 mb-1">CCCD khách</label>
      <input
        type="text"
        name="customer_cccd"
        value="{{ customer_cccd }}"
        class="h-10 rounded-xl border px-3 text-sm min-w-[160px]"
        placeholder="Exact CCCD"
      >
    </div>

    <div class="flex flex-col">
      <label class="text-xs font-semibold text-slate-500 mb-1">Số dòng tối đa (limit)</label>
      <input
        type="number"
        name="limit"
        value="{{ limit or '' }}"
        class="h-10 rounded-xl border px-3 text-sm w-28"
        min="1"
        max="10000"
      >
    </div>

    <div class="flex items-center gap-3 ml-auto">
      <button
        type="submit"
        class="h-10 px-4 rounded-xl bg-indigo-600 text-white text-sm font-medium shadow-sm hover:bg-indigo-700"
      >Áp dụng</button>

      <button
        type="submit"
        name="export"
        value="xlsx"
        class="h-10 px-4 rounded-xl border border-slate-300 text-sm font-medium text-slate-700 bg-white hover:bg-slate-50"
      >
        Export XLSX
      </button>
    </div>
  </form>

  {% set rows = (data or {}).get('items') or (data or {}).get('rows') or [] %}
  {% set total = (data or {}).get('count') or rows|length %}

  <div class="mb-3 text-sm text-slate-600">
    <span class="font-semibold text-slate-900">{{ total }}</span>
    dòng hồ sơ đã thanh toán được tìm thấy.
  </div>

  <div class="bg-white border rounded-2xl shadow-sm overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm text-slate-700">
        <thead class="bg-slate-50 text-slate-500 border-b">
          <tr>
            <th class="px-4 py-2 text-left font-semibold">Dự án</th>
            <th class="px-4 py-2 text-left font-semibold">Khách hàng</th>
            <th class="px-4 py-2 text-left font-semibold">CCCD</th>
            <th class="px-4 py-2 text-left font-semibold">SĐT</th>
            <th class="px-4 py-2 text-left font-semibold">Email</th>
            <th class="px-4 py-2 text-left font-semibold">Loại hồ sơ</th>
            <th class="px-4 py-2 text-right font-semibold">Đơn giá</th>
            <th class="px-4 py-2 text-right font-semibold">Số lượng</th>
            <th class="px-4 py-2 text-right font-semibold">Thành tiền</th>
            <th class="px-4 py-2 text-left font-semibold">Mã đơn</th>
            <th class="px-4 py-2 text-left font-semibold">Thời điểm thanh toán</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">
        {% for r in rows %}
          <tr class="hover:bg-slate-50 transition">
            <td class="px-4 py-3 font-medium text-slate-900">{{ r.project_code }}</td>
            <td class="px-4 py-3 font-medium text-slate-900">{{ r.customer_full_name }}</td>
            <td class="px-4 py-3">{{ r.cccd }}</td>
            <td class="px-4 py-3">{{ r.phone }}</td>
            <td class="px-4 py-3">{{ r.email or '-' }}</td>
            <td class="px-4 py-3">{{ r.dossier_type_name }}</td>
            <td class="px-4 py-3 text-right">{{ r.unit_price_vnd }}</td>
            <td class="px-4 py-3 text-right">{{ r.qty }}</td>
            <td class="px-4 py-3 text-right">{{ r.line_total_vnd }}</td>
            <td class="px-4 py-3">{{ r.order_code }}</td>
            <td class="px-4 py-3 text-xs text-slate-500">{{ r.order_created_at or '' }}</td>
          </tr>
        {% endfor %}
        {% if rows|length == 0 %}
          <tr>
            <td colspan="11" class="px-4 py-4 text-center text-slate-400">
              Chọn dự án và bấm "Áp dụng" để xem dữ liệu.
            </td>
          </tr>
        {% endif %}
        </tbody>
      </table>
    </div>
  </div>

{% else %}
  {# ========================= SUMMARY MODE ========================= #}
  <div class="mb-6 flex items-start justify-between gap-4">
    <div>
      <h1 class="text-2xl font-semibold text-slate-900">Mua hồ sơ — tổng hợp</h1>
      <p class="text-slate-500 text-sm mt-1">
        Thống kê tổng hợp theo khách hàng và theo loại hồ sơ trên từng dự án.
      </p>
    </div>
  </div>

  <form method="get" class="bg-white border rounded-2xl shadow-sm p-4 mb-4 flex flex-wrap gap-4 items-end">
    <div class="flex flex-col">
      <label class="text-xs font-semibold text-slate-500 mb-1">Dự án</label>
      <select name="project" class="h-10 rounded-xl border px-3 text-sm min-w-[220px]">
        <option value="">— Chọn dự án —</option>
        {% for p in projects or [] %}
          {% set code = p.project_code or p.code %}
          <option value="{{ code }}" {% if code == project %}selected{% endif %}>
            {{ code }} — {{ p.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="flex items-center gap-3 ml-auto">
      <button
        type="submit"
        class="h-10 px-4 rounded-xl bg-indigo-600 text-white text-sm font-medium shadow-sm hover:bg-indigo-700"
      >Áp dụng</button>

      <button
        type="submit"
        name="export"
        value="summary_customer"
        class="h-10 px-4 rounded-xl border border-slate-300 text-sm font-medium text-slate-700 bg-white hover:bg-slate-50"
      >
        Export theo khách
      </button>

      <button
        type="submit"
        name="export"
        value="totals_by_type"
        class="h-10 px-4 rounded-xl border border-slate-300 text-sm font-medium text-slate-700 bg-white hover:bg-slate-50"
      >
        Export theo loại hồ sơ
      </button>
    </div>
  </form>

  {% set summary_customer = (data or {}).get('summary_customer') or {} %}
  {% set totals_by_type = (data or {}).get('totals_by_type') or {} %}
  {% set rows_cust = summary_customer.get('items') or summary_customer.get('rows') or [] %}
  {% set rows_type = totals_by_type.get('items') or totals_by_type.get('rows') or [] %}

  <div class="grid gap-6 xl:grid-cols-2">
    <!-- Theo khách -->
    <div class="bg-white border rounded-2xl shadow-sm overflow-hidden">
      <div class="px-4 py-3 border-b flex items-center justify-between">
        <div>
          <div class="text-sm font-semibold text-slate-900">Tổng hợp theo khách</div>
          <div class="text-xs text-slate-500">Tổng số lượng &amp; số tiền mua hồ sơ theo từng khách.</div>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-slate-700">
          <thead class="bg-slate-50 text-slate-500 border-b">
            <tr>
              <th class="px-3 py-2 text-left font-semibold">Khách hàng</th>
              <th class="px-3 py-2 text-left font-semibold">CCCD</th>
              <th class="px-3 py-2 text-left font-semibold">SĐT</th>
              <th class="px-3 py-2 text-left font-semibold">Email</th>
              <th class="px-3 py-2 text-right font-semibold">Tổng số lượng</th>
              <th class="px-3 py-2 text-right font-semibold">Tổng số tiền</th>
              <th class="px-3 py-2 text-left font-semibold">Chi tiết theo loại</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
          {% for r in rows_cust %}
            <tr class="hover:bg-slate-50 transition">
              <td class="px-3 py-2 font-medium text-slate-900">{{ r.full_name }}</td>
              <td class="px-3 py-2">{{ r.cccd }}</td>
              <td class="px-3 py-2">{{ r.phone }}</td>
              <td class="px-3 py-2">{{ r.email or '-' }}</td>
              <td class="px-3 py-2 text-right">{{ r.total_qty }}</td>
              <td class="px-3 py-2 text-right">{{ r.total_amount }}</td>
              <td class="px-3 py-2 text-xs text-slate-500 cell-wrap">
                {{ r.type_breakdown }}
              </td>
            </tr>
          {% endfor %}
          {% if rows_cust|length == 0 %}
            <tr>
              <td colspan="7" class="px-3 py-4 text-center text-slate-400">
                Chưa có dữ liệu.
              </td>
            </tr>
          {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Theo loại hồ sơ -->
    <div class="bg-white border rounded-2xl shadow-sm overflow-hidden">
      <div class="px-4 py-3 border-b">
        <div class="text-sm font-semibold text-slate-900">Tổng hợp theo loại hồ sơ</div>
        <div class="text-xs text-slate-500">Số lượng &amp; số tiền cho từng loại hồ sơ.</div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-slate-700">
          <thead class="bg-slate-50 text-slate-500 border-b">
            <tr>
              <th class="px-3 py-2 text-left font-semibold">Loại hồ sơ</th>
              <th class="px-3 py-2 text-right font-semibold">Tổng số lượng</th>
              <th class="px-3 py-2 text-right font-semibold">Tổng số tiền</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
          {% for r in rows_type %}
            <tr class="hover:bg-slate-50 transition">
              <td class="px-3 py-2 font-medium text-slate-900">{{ r.dossier_label }}</td>
              <td class="px-3 py-2 text-right">{{ r.total_qty }}</td>
              <td class="px-3 py-2 text-right">{{ r.total_amount }}</td>
            </tr>
          {% endfor %}
          {% if rows_type|length == 0 %}
            <tr>
              <td colspan="3" class="px-3 py-4 text-center text-slate-400">
                Chưa có dữ liệu.
              </td>
            </tr>
          {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endif %}

<style>
  table th, table td { white-space: nowrap; }
  .cell-wrap { white-space: normal; }
</style>
{% endblock %}
