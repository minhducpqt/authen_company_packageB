{# templates/reports/lots_eligible.html #}
{% extends "base.html" %}
{% block title %}Lô đủ điều kiện{% if is_v2 %} (V2){% endif %}{% endblock %}

{% block content %}
{% set _data = data if data is mapping else {} %}
{% set rows = _data.get("items") or [] %}
{% set row_count = (rows|length) %}

{# ---------- helpers / aggregate (Jinja-safe) ---------- #}
{% set ns = namespace(
  sum_paid_all=0,
  sum_paid_eligible=0,
  sum_paid_diff=0,
  sum_eligible_customers=0,
  sum_paid_customers=0,
  min_deadline=None,
  max_deadline=None,
  project_code="",
  project_name=""
) %}

{% for r in rows %}
  {% set paid_all = (r.get("total_deposit_amount") if (r.get("total_deposit_amount") is not none) else (r.get("total_paid_vnd_all") if (r.get("total_paid_vnd_all") is not none) else (r.get("total_deposit_amount_all") if (r.get("total_deposit_amount_all") is not none) else 0))) %}
  {% set paid_ok  = (r.get("eligible_deposit_amount") if (r.get("eligible_deposit_amount") is not none) else (r.get("total_paid_vnd_eligible") if (r.get("total_paid_vnd_eligible") is not none) else (r.get("total_deposit_amount_eligible") if (r.get("total_deposit_amount_eligible") is not none) else paid_all))) %}
  {% set cnt_paid = (r.get("total_customers_paid") if (r.get("total_customers_paid") is not none) else (r.get("deposit_customer_count") if (r.get("deposit_customer_count") is not none) else (r.get("deposit_customer_count_for_lot") if (r.get("deposit_customer_count_for_lot") is not none) else 0))) %}
  {% set cnt_ok   = (r.get("eligible_customer_count") if (r.get("eligible_customer_count") is not none) else (r.get("eligible_customer_count_for_lot") if (r.get("eligible_customer_count_for_lot") is not none) else 0)) %}

  {% set ns.sum_paid_all = ns.sum_paid_all + (paid_all or 0) %}
  {% set ns.sum_paid_eligible = ns.sum_paid_eligible + (paid_ok or 0) %}
  {% set ns.sum_paid_diff = ns.sum_paid_diff + ((paid_all or 0) - (paid_ok or 0)) %}
  {% set ns.sum_paid_customers = ns.sum_paid_customers + (cnt_paid or 0) %}
  {% set ns.sum_eligible_customers = ns.sum_eligible_customers + (cnt_ok or 0) %}

  {% if not ns.project_code %}
    {% set ns.project_code = (r.get("project_code") or "") %}
  {% endif %}
  {% if not ns.project_name %}
    {% set ns.project_name = (r.get("project_name") or "") %}
  {% endif %}

  {% set dl = r.get("deposit_deadline_at") %}
  {% if dl %}
    {% if ns.min_deadline is none or (dl < ns.min_deadline) %}
      {% set ns.min_deadline = dl %}
    {% endif %}
    {% if ns.max_deadline is none or (dl > ns.max_deadline) %}
      {% set ns.max_deadline = dl %}
    {% endif %}
  {% endif %}
{% endfor %}

<div class="mb-5">
  <div class="flex items-start justify-between gap-4">
    <div class="min-w-0">
      <h1 class="text-2xl font-semibold text-slate-900 flex items-center gap-2">
        <i class="ri-checkbox-circle-line text-indigo-600 text-3xl"></i>
        Lô đủ điều kiện
        {% if is_v2 %}
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-indigo-50 text-indigo-700 border border-indigo-100">V2</span>
        {% endif %}
      </h1>
      <p class="text-slate-500 text-sm mt-1">
        Danh sách lô đủ điều kiện mở đấu giá (≥ 2 khách đủ điều kiện).
      </p>
    </div>

    <div class="shrink-0">
      <span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-white border border-slate-200 text-slate-700 text-sm shadow-sm">
        <span class="h-2 w-2 rounded-full {% if row_count > 0 %}bg-emerald-500{% else %}bg-slate-300{% endif %}"></span>
        <span class="font-semibold" id="pillCount">{{ row_count }} dòng</span>
      </span>
    </div>
  </div>
</div>

{# =======================
   Filters (auto-apply)
   - BỎ nút "Xem"
   - BỎ limit (ẩn hẳn)
   - đổi dự án => điều hướng sang /reports/v2/projects/{id}/lots/eligible
   ======================= #}
<div class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden mb-5">
  <div class="p-4 md:p-5 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
    <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
      <div class="md:col-span-9">
        <label class="text-xs font-semibold text-slate-600">Dự án</label>
        <div class="mt-1">
          <select id="projectSelect"
                  class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2.5 text-sm text-slate-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/30 focus:border-indigo-300">
            {% set _pid = project_id if project_id is not none else 0 %}
            {% for p in (projects or []) %}
              {% set pid = p.get("id") or p.get("project_id") %}
              {% set code = (p.get("project_code") or p.get("code") or "") %}
              {% set name = (p.get("name") or "") %}
              <option value="{{ pid }}"
                      {% if pid == _pid %}selected{% endif %}>
                {{ code }} — {{ name }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="mt-2 text-[12px] text-slate-500 flex items-center gap-2">
          <i class="ri-flashlight-line"></i>
          <span>Đổi dự án sẽ tự tải lại báo cáo.</span>
          {% if ns.project_code %}
            <span class="hidden md:inline text-slate-400">•</span>
            <span class="hidden md:inline">theo project_id = <span class="font-semibold text-slate-700">{{ project_id }}</span></span>
          {% endif %}
        </div>
      </div>

      <div class="md:col-span-3 flex md:justify-end gap-2">
        {# Export V2 #}
        {% if is_v2 %}
          <a href="/reports/v2/projects/{{ project_id }}/lots/eligible/export"
             class="inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-slate-900 text-sm font-semibold shadow-sm">
            <i class="ri-download-2-line"></i>
            Export
          </a>
        {% else %}
          {# back-compat if you ever reuse template for V1 #}
          <a href="/reports/lots/eligible/export?project={{ (project or '')|upper }}"
             class="inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-slate-900 text-sm font-semibold shadow-sm">
            <i class="ri-download-2-line"></i>
            Export
          </a>
        {% endif %}
      </div>
    </div>
  </div>

  {# =======================
     Summary boxes (THÔNG TIN CHUNG)
     - Thứ cần show ở trên, KHÔNG nhét vào danh sách
     ======================= #}
  <div class="p-4 md:p-5">
    <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-3">
      <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
        <div class="flex items-center justify-between">
          <div class="text-xs font-semibold text-slate-500">Tổng lô đủ điều kiện</div>
          <div class="h-9 w-9 rounded-xl bg-indigo-50 flex items-center justify-center">
            <i class="ri-stack-line text-indigo-600"></i>
          </div>
        </div>
        <div class="mt-2 text-2xl font-extrabold text-slate-900">{{ row_count }}</div>
        <div class="mt-1 text-xs text-slate-500">Số dòng từ API</div>
      </div>

      <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
        <div class="flex items-center justify-between">
          <div class="text-xs font-semibold text-slate-500">Tổng khách đủ điều kiện</div>
          <div class="h-9 w-9 rounded-xl bg-emerald-50 flex items-center justify-center">
            <i class="ri-user-star-line text-emerald-600"></i>
          </div>
        </div>
        <div class="mt-2 text-2xl font-extrabold text-slate-900">
          {{ ns.sum_eligible_customers }}
        </div>
        <div class="mt-1 text-xs text-slate-500">Cộng dồn “Số KH đủ” của các lô</div>
      </div>

      <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
        <div class="flex items-center justify-between">
          <div class="text-xs font-semibold text-slate-500">Tổng tiền (đủ điều kiện)</div>
          <div class="h-9 w-9 rounded-xl bg-sky-50 flex items-center justify-center">
            <i class="ri-funds-line text-sky-600"></i>
          </div>
        </div>
        <div class="mt-2 text-2xl font-extrabold text-slate-900 tabular-nums"
             data-money="{{ ns.sum_paid_eligible }}">0</div>
        <div class="mt-1 text-xs text-slate-500">
          Tổng tiền tính theo tập “eligible”
          {% if ns.sum_paid_diff and ns.sum_paid_diff > 0 %}
            <span class="text-slate-400">•</span>
            <span class="text-slate-600">còn lại (không đủ):</span>
            <span class="font-semibold text-slate-700 tabular-nums" data-money="{{ ns.sum_paid_diff }}">0</span>
          {% endif %}
        </div>
      </div>

      <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
        <div class="flex items-center justify-between">
          <div class="text-xs font-semibold text-slate-500">Deadline tiền đặt trước</div>
          <div class="h-9 w-9 rounded-xl bg-amber-50 flex items-center justify-center">
            <i class="ri-timer-line text-amber-600"></i>
          </div>
        </div>

        {% if ns.min_deadline and ns.max_deadline %}
          {% if ns.min_deadline == ns.max_deadline %}
            <div class="mt-2 text-base font-bold text-slate-900 tabular-nums">
              {{ ns.min_deadline }}
            </div>
            <div class="mt-1 text-xs text-slate-500">Áp dụng chung cho dự án</div>
          {% else %}
            <div class="mt-2 text-sm font-bold text-slate-900 tabular-nums">
              {{ ns.min_deadline }} <span class="text-slate-400 font-semibold">→</span> {{ ns.max_deadline }}
            </div>
            <div class="mt-1 text-xs text-slate-500">Có nhiều mốc deadline</div>
          {% endif %}
        {% else %}
          <div class="mt-2 text-base font-bold text-slate-900">—</div>
          <div class="mt-1 text-xs text-slate-500">Không có dữ liệu deadline</div>
        {% endif %}
      </div>
    </div>

    {% if error %}
      <div class="mt-4 rounded-2xl border border-rose-200 bg-rose-50 p-4">
        <div class="flex items-start gap-3">
          <div class="h-10 w-10 rounded-xl bg-rose-100 flex items-center justify-center">
            <i class="ri-error-warning-line text-rose-600 text-xl"></i>
          </div>
          <div class="min-w-0">
            <div class="font-semibold text-rose-900">Không tải được dữ liệu từ Service A</div>
            <div class="text-sm text-rose-700 mt-1">
              Status: <span class="font-semibold">{{ error.status }}</span>
            </div>
            <pre class="mt-2 text-xs text-rose-800 whitespace-pre-wrap break-words">{{ error.body }}</pre>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
</div>

{# =======================
   Table (CHỈ THÔNG TIN RIÊNG TỪNG LÔ)
   - Không show “thông tin chung” ở đây nữa
   - Tiền: format dễ đọc (không thêm VND)
   ======================= #}
<div class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden">
  <div class="px-4 py-3 border-b border-slate-100 bg-gradient-to-r from-white to-slate-50">
    <div class="flex items-center justify-between gap-3">
      <div class="flex items-center gap-2">
        <div class="h-9 w-9 rounded-xl bg-indigo-50 flex items-center justify-center">
          <i class="ri-table-line text-indigo-600"></i>
        </div>
        <div>
          <div class="text-sm font-semibold text-slate-900">Danh sách lô đủ điều kiện</div>
          <div class="text-xs text-slate-500">
            {% if is_v2 %}
              {{ row_count }} dòng • theo project_id = {{ project_id }}
            {% else %}
              {{ row_count }} dòng
            {% endif %}
          </div>
        </div>
      </div>

      <div class="hidden md:flex items-center gap-2">
        <span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100 text-xs font-semibold">
          <i class="ri-shield-check-line"></i>
          Đủ điều kiện
        </span>
      </div>
    </div>
  </div>

  {% if row_count == 0 %}
    <div class="p-8 text-center">
      <div class="mx-auto h-12 w-12 rounded-2xl bg-slate-100 flex items-center justify-center">
        <i class="ri-inbox-2-line text-slate-400 text-2xl"></i>
      </div>
      <div class="mt-3 font-semibold text-slate-900">Không có dữ liệu</div>
      <div class="mt-1 text-sm text-slate-500">
        Dự án hiện tại chưa có lô nào đạt điều kiện (≥ 2 khách đủ điều kiện) hoặc API trả về rỗng.
      </div>
    </div>
  {% else %}
    <div class="overflow-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-50/70 text-slate-600">
          <tr class="text-left">
            <th class="px-4 py-3 font-semibold uppercase tracking-wide text-xs whitespace-nowrap">Mã lô</th>
            <th class="px-4 py-3 font-semibold uppercase tracking-wide text-xs min-w-[220px]">Mô tả</th>
            <th class="px-4 py-3 font-semibold uppercase tracking-wide text-xs whitespace-nowrap">Số KH đặt</th>
            <th class="px-4 py-3 font-semibold uppercase tracking-wide text-xs whitespace-nowrap">Số KH đủ</th>
            <th class="px-4 py-3 font-semibold uppercase tracking-wide text-xs whitespace-nowrap">Tổng tiền</th>
            <th class="px-4 py-3 font-semibold uppercase tracking-wide text-xs whitespace-nowrap">Tổng tiền (đủ)</th>
            <th class="px-4 py-3 font-semibold uppercase tracking-wide text-xs whitespace-nowrap">Trạng thái</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">
          {% for r in rows %}
            {% set lot_code = r.get("lot_code") or "-" %}
            {% set lot_desc = r.get("lot_description") or r.get("lot_name") or r.get("lot_title") or r.get("description") or "-" %}

            {% set cnt_paid = (r.get("total_customers_paid") if (r.get("total_customers_paid") is not none) else (r.get("deposit_customer_count") if (r.get("deposit_customer_count") is not none) else (r.get("deposit_customer_count_for_lot") if (r.get("deposit_customer_count_for_lot") is not none) else 0))) %}
            {% set cnt_ok = (r.get("eligible_customer_count") if (r.get("eligible_customer_count") is not none) else (r.get("eligible_customer_count_for_lot") if (r.get("eligible_customer_count_for_lot") is not none) else 0)) %}

            {% set paid_all = (r.get("total_deposit_amount") if (r.get("total_deposit_amount") is not none) else (r.get("total_paid_vnd_all") if (r.get("total_paid_vnd_all") is not none) else (r.get("total_deposit_amount_all") if (r.get("total_deposit_amount_all") is not none) else 0))) %}
            {% set paid_ok = (r.get("eligible_deposit_amount") if (r.get("eligible_deposit_amount") is not none) else (r.get("total_paid_vnd_eligible") if (r.get("total_paid_vnd_eligible") is not none) else (r.get("total_deposit_amount_eligible") if (r.get("total_deposit_amount_eligible") is not none) else paid_all))) %}

            {% set st = (r.get("lot_status") or r.get("status") or "")|upper %}
            {% set st_label = st if st else "—" %}

            <tr class="hover:bg-slate-50/40">
              <td class="px-4 py-3 whitespace-nowrap">
                <div class="font-extrabold text-slate-900">{{ lot_code }}</div>
                <div class="text-[12px] text-slate-500">ID: {{ r.get("lot_id") or "-" }}</div>
              </td>

              <td class="px-4 py-3">
                <div class="text-slate-900 font-semibold leading-snug">
                  {{ lot_desc }}
                </div>
                <div class="mt-1 text-[12px] text-slate-500 flex flex-wrap gap-x-3 gap-y-1">
                  {% if r.get("area_m2") %}
                    <span class="inline-flex items-center gap-1">
                      <i class="ri-ruler-line"></i>
                      {{ r.get("area_m2") }} m²
                    </span>
                  {% endif %}
                  {% if r.get("deposit_vnd") or r.get("deposit_required_vnd") %}
                    {% set dep_req = r.get("deposit_required_vnd") if r.get("deposit_required_vnd") is not none else r.get("deposit_vnd") %}
                    <span class="inline-flex items-center gap-1">
                      <i class="ri-bank-card-line"></i>
                      Cọc: <span class="font-semibold tabular-nums" data-money="{{ dep_req }}">0</span>
                    </span>
                  {% endif %}
                </div>
              </td>

              <td class="px-4 py-3 whitespace-nowrap">
                <span class="inline-flex items-center justify-center min-w-[44px] px-2.5 py-1 rounded-full bg-slate-100 text-slate-700 font-bold tabular-nums">
                  {{ cnt_paid }}
                </span>
              </td>

              <td class="px-4 py-3 whitespace-nowrap">
                <span class="inline-flex items-center justify-center min-w-[44px] px-2.5 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100 font-extrabold tabular-nums">
                  {{ cnt_ok }}
                </span>
              </td>

              <td class="px-4 py-3 whitespace-nowrap">
                <div class="font-extrabold text-slate-900 tabular-nums" data-money="{{ paid_all }}">0</div>
                {% if r.get("first_paid_at") or r.get("last_paid_at") %}
                  <div class="mt-1 text-[12px] text-slate-500">
                    {% if r.get("first_paid_at") %}<span>Đầu: {{ r.get("first_paid_at") }}</span>{% endif %}
                    {% if r.get("last_paid_at") %}<span class="ml-2">Cuối: {{ r.get("last_paid_at") }}</span>{% endif %}
                  </div>
                {% endif %}
              </td>

              <td class="px-4 py-3 whitespace-nowrap">
                <div class="font-extrabold text-slate-900 tabular-nums" data-money="{{ paid_ok }}">0</div>
                {% if paid_all != paid_ok %}
                  <div class="mt-1 text-[12px] text-slate-500">
                    Không đủ: <span class="font-semibold tabular-nums" data-money="{{ (paid_all or 0) - (paid_ok or 0) }}">0</span>
                  </div>
                {% endif %}
              </td>

              <td class="px-4 py-3 whitespace-nowrap">
                {% if st == "AVAILABLE" %}
                  <span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-amber-50 text-amber-800 border border-amber-100 text-xs font-semibold">
                    <span class="h-2 w-2 rounded-full bg-amber-500"></span>
                    AVAILABLE
                  </span>
                {% elif st %}
                  <span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-100 text-slate-700 border border-slate-200 text-xs font-semibold">
                    <span class="h-2 w-2 rounded-full bg-slate-400"></span>
                    {{ st_label }}
                  </span>
                {% else %}
                  <span class="text-slate-400">—</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}
</div>

<script>
  (function () {
    // -------- money formatter (no "VND") --------
    function fmtMoney(n) {
      try {
        const x = Number(n || 0);
        return new Intl.NumberFormat('en-US').format(Math.round(x));
      } catch (e) {
        return String(n ?? '');
      }
    }
    document.querySelectorAll('[data-money]').forEach(function (el) {
      const v = el.getAttribute('data-money');
      el.textContent = fmtMoney(v);
    });

    // -------- auto-apply project select --------
    const sel = document.getElementById('projectSelect');
    if (sel) {
      sel.addEventListener('change', function () {
        const pid = (sel.value || '').trim();
        if (!pid) return;

        // V2 route
        const base = `/reports/v2/projects/${pid}/lots/eligible`;
        window.location.href = base;
      });
    }
  })();
</script>
{% endblock %}
