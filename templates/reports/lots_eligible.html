{% extends "base.html" %}
{% block title %}Lô đủ điều kiện{% endblock %}

{% block content %}
<style>
  :root{
    --bd: rgba(15,23,42,.10);
    --bd2: rgba(15,23,42,.07);
    --card: #fff;
    --muted: rgba(71,85,105,.88);
    --txt: #0f172a;

    --ok: #16a34a;
    --ok2:#22c55e;
    --warn:#f59e0b;
    --bad:#ef4444;
    --pri:#4f46e5;

    --r: 16px;
    --shadow: 0 14px 36px rgba(2,6,23,.10);
  }

  .rp-wrap{max-width:1280px;margin:0 auto}
  .rp-head{
    background: linear-gradient(135deg, rgba(79,70,229,.10), rgba(34,197,94,.08));
    border:1px solid var(--bd);
    border-radius: 22px;
    padding: 16px 16px 14px;
    box-shadow: 0 10px 28px rgba(2,6,23,.06);
  }
  .rp-title{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
  .rp-title h1{font-size:20px;font-weight:800;color:var(--txt);display:flex;align-items:center;gap:10px;margin:0}
  .rp-title p{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.35}
  .pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:8px 10px;border-radius:999px;
    background: rgba(255,255,255,.72);
    border:1px solid var(--bd2);
    color: rgba(15,23,42,.70);
    font-size:12px;font-weight:800;
    backdrop-filter: blur(8px);
    white-space:nowrap;
  }
  .dot{width:8px;height:8px;border-radius:999px;background: var(--ok2);box-shadow:0 0 0 3px rgba(34,197,94,.14)}
  .rp-controls{
    margin-top: 12px;
    display:flex;flex-wrap:wrap;align-items:center;gap:10px;
  }
  .sel{
    display:flex;align-items:center;gap:10px;
    padding:10px 12px;border-radius: 14px;
    border:1px solid var(--bd);
    background: rgba(255,255,255,.80);
    min-width: 280px;
  }
  .sel label{font-size:12px;color:rgba(15,23,42,.65);font-weight:800}
  .sel select{
    border:0;outline:0;background:transparent;
    font-weight:900;color:var(--txt);
    width:100%;
  }

  .btn{
    display:inline-flex;align-items:center;gap:8px;
    padding:10px 12px;border-radius: 14px;
    border:1px solid var(--bd);
    background: rgba(255,255,255,.85);
    font-size:12px;font-weight:900;color: rgba(15,23,42,.75);
    transition: .15s ease;
    text-decoration:none;
  }
  .btn:hover{transform: translateY(-1px); box-shadow: 0 10px 20px rgba(2,6,23,.10)}
  .btn.primary{
    border-color: rgba(34,197,94,.35);
    background: linear-gradient(180deg, rgba(34,197,94,.18), rgba(34,197,94,.10));
    color: rgba(20,83,45,.95);
  }

  .kpis{
    margin-top: 14px;
    display:grid;
    grid-template-columns: repeat(12, 1fr);
    gap:10px;
  }
  .kpi{
    grid-column: span 3;
    background: rgba(255,255,255,.88);
    border:1px solid var(--bd);
    border-radius: 18px;
    padding: 12px 12px 10px;
    box-shadow: 0 10px 22px rgba(2,6,23,.06);
  }
  @media (max-width: 1024px){ .kpi{grid-column: span 6} }
  @media (max-width: 640px){
    .sel{min-width: 100%}
    .kpi{grid-column: span 12}
  }
  .kpi .t{font-size:12px;color:rgba(15,23,42,.62);font-weight:900}
  .kpi .v{margin-top:6px;font-size:18px;font-weight:950;color:var(--txt);letter-spacing:.2px}
  .kpi .s{margin-top:6px;font-size:11px;color:rgba(71,85,105,.90)}
  .kpi.ok .v{color: rgba(20,83,45,.98)}
  .kpi.money .v{color: rgba(30,64,175,.95)}
  .kpi.deadline .v{color: rgba(124,45,18,.95)}

  .rp-card{
    margin-top: 14px;
    background: var(--card);
    border:1px solid var(--bd);
    border-radius: 22px;
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .rp-card .hd{
    padding: 12px 14px;
    border-bottom:1px solid var(--bd2);
    background: linear-gradient(90deg, rgba(15,23,42,.03), rgba(15,23,42,.00));
    display:flex;align-items:center;justify-content:space-between;gap:12px;
  }
  .rp-card .hd .left{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .badge{
    display:inline-flex;align-items:center;gap:7px;
    padding:6px 10px;border-radius:999px;
    border:1px solid var(--bd2);
    background: rgba(255,255,255,.85);
    font-size:12px;font-weight:900;color:rgba(15,23,42,.72);
  }
  .badge.ok{border-color: rgba(34,197,94,.30); background: rgba(34,197,94,.10); color: rgba(20,83,45,.92)}
  .muted{color: var(--muted);font-size:12px}

  /* ===== Summary (static full list) ===== */
  .sumbar{
    padding: 12px 14px;
    border-bottom:1px solid rgba(15,23,42,.06);
    background: rgba(255,255,255,.92);
    display:grid;
    grid-template-columns: repeat(12, 1fr);
    gap:10px;
  }
  .sumcard{
    grid-column: span 4;
    border:1px solid rgba(15,23,42,.10);
    border-radius: 18px;
    background: linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,255,255,.92));
    box-shadow: 0 10px 18px rgba(2,6,23,.06);
    padding: 12px 12px 10px;
    min-width: 0;
  }
  @media (max-width: 1024px){ .sumcard{grid-column: span 6} }
  @media (max-width: 640px){ .sumcard{grid-column: span 12} }
  .sumtop{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .sumlbl{font-size:12px;font-weight:950;color: rgba(15,23,42,.62)}
  .sumico{
    width:34px;height:34px;border-radius:14px;
    display:flex;align-items:center;justify-content:center;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(15,23,42,.03);
  }
  .sumval{
    margin-top:8px;
    font-size:20px;
    font-weight:1000;
    letter-spacing:.2px;
    color: rgba(15,23,42,.92);
    font-variant-numeric: tabular-nums; font-feature-settings: "tnum";
    overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
  }
  .sumsub{
    margin-top:6px;
    font-size:12px;
    color: rgba(71,85,105,.90);
    line-height:1.35;
  }
  .sumcard.ok .sumval{color: rgba(20,83,45,.98)}
  .sumcard.money .sumval{color: rgba(30,64,175,.95)}
  .sumcard.ticket .sumval{color: rgba(49,46,129,.95)}
  .sumhint{opacity:.9}

  /* ===== controls (local sort/filter) ===== */
  .list-controls{
    padding: 10px 14px;
    border-bottom:1px solid rgba(15,23,42,.06);
    display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;
    background: rgba(255,255,255,.82);
  }
  .lc-left{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .ctl{
    display:flex;align-items:center;gap:8px;
    padding:8px 10px;border-radius:14px;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(15,23,42,.02);
  }
  .ctl label{font-size:12px;font-weight:900;color:rgba(15,23,42,.70)}
  .ctl select{
    border:0;outline:0;background:transparent;
    font-size:12px;font-weight:950;color:rgba(15,23,42,.85);
  }
  .toggle{
    display:inline-flex;align-items:center;gap:8px;
    padding:8px 10px;border-radius:14px;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(255,255,255,.90);
    font-size:12px;font-weight:950;color: rgba(15,23,42,.72);
    cursor:pointer;
    user-select:none;
  }
  .toggle .ico{opacity:.85}
  .toggle:hover{box-shadow:0 10px 18px rgba(2,6,23,.08); transform: translateY(-1px)}
  .chk{
    display:flex;align-items:center;gap:8px;
    padding:8px 10px;border-radius:14px;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(255,255,255,.90);
    font-size:12px;font-weight:950;color: rgba(15,23,42,.72);
  }
  .chk input{width:16px;height:16px}
  .lc-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .mini-kpi{
    font-size:12px;color:rgba(71,85,105,.92);
    padding:8px 10px;border-radius:14px;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(15,23,42,.02);
  }

  /* ===== table ===== */
  .tbl-wrap{overflow:auto}
  .tbl{
    width:100%;
    min-width: 1100px;
    border-collapse:separate;border-spacing:0;
    table-layout: fixed;
  }
  .tbl th, .tbl td{
    padding: 12px 12px;
    border-bottom:1px solid rgba(15,23,42,.06);
    vertical-align:top;
  }
  .tbl th{
    background: #fff;
    font-size:12px;
    color: rgba(15,23,42,.58);
    font-weight:950;
    letter-spacing:.2px;
    position: sticky;
    top: 0;
    z-index: 1;
  }
  /* HARD OVERRIDE (phòng CSS global của base làm table bị co lệch) */
  .tbl{display:table !important;width:100% !important;table-layout:fixed}
  .tbl thead{display:table-header-group !important}
  .tbl tbody{display:table-row-group !important}
  .tbl tr{display:table-row !important}
  .tbl th,.tbl td{display:table-cell !important;box-sizing:border-box}

  .row{transition: .12s ease;background:#fff}
  .row:hover{background: rgba(15,23,42,.02)}
  .lotcode{
    font-weight:950;color: rgba(30,64,175,.98);
    text-decoration:none;
    display:inline-block;
    max-width: 12ch;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
  .lotname{font-size:12px;color: rgba(15,23,42,.78);margin-top:4px;line-height:1.25}
  .mini{font-size:12px;color: rgba(71,85,105,.92);line-height:1.28}
  .mono{font-variant-numeric: tabular-nums; font-feature-settings: "tnum";}
  .chip{
    display:inline-flex;align-items:center;gap:6px;
    padding:6px 10px;border-radius:999px;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(15,23,42,.03);
    font-size:12px;font-weight:900;color: rgba(15,23,42,.74);
    white-space:nowrap;
  }
  .chip.ok{border-color: rgba(34,197,94,.28); background: rgba(34,197,94,.10); color: rgba(20,83,45,.92)}
  .chip.money{border-color: rgba(59,130,246,.24); background: rgba(59,130,246,.10); color: rgba(30,64,175,.92)}
  .chip.deadline{border-color: rgba(245,158,11,.28); background: rgba(245,158,11,.12); color: rgba(124,45,18,.92)}
  .act{
    display:flex;justify-content:flex-end;gap:10px;align-items:center;
  }
  .view-btn{
    display:inline-flex;align-items:center;gap:8px;
    padding:10px 12px;border-radius: 14px;
    border:1px solid rgba(79,70,229,.22);
    background: linear-gradient(180deg, rgba(79,70,229,.10), rgba(79,70,229,.06));
    color: rgba(49,46,129,.92);
    font-size:12px;font-weight:950;
    cursor:pointer;
    user-select:none;
  }
  .view-btn:hover{box-shadow:0 10px 18px rgba(2,6,23,.10); transform: translateY(-1px)}
  .sub-actions a{color:rgba(71,85,105,.90);font-size:12px;font-weight:900;text-decoration:none}
  .sub-actions a:hover{text-decoration:underline}

  .empty-row td{
    padding:18px 14px;
    color:rgba(71,85,105,.88);
    font-size:13px;
    background: rgba(15,23,42,.01);
  }

  /* ===== modal ===== */
  .modal{position: fixed;inset: 0;display: none;z-index: 9999;}
  .modal.show{display:block}
  .modal .bg{
    position:absolute;inset:0;
    background: rgba(15,23,42,.58);
    backdrop-filter: blur(8px);
  }
  .modal .panel{
    position: absolute;
    inset: 18px;
    background: rgba(255,255,255,.96);
    border: 1px solid rgba(255,255,255,.45);
    border-radius: 22px;
    box-shadow: 0 30px 70px rgba(2,6,23,.40);
    overflow: hidden;
    display:flex;
    flex-direction:column;
  }
  @media (max-width: 720px){ .modal .panel{inset: 10px} }

  .m-hd{
    padding: 12px 14px;
    border-bottom:1px solid rgba(15,23,42,.08);
    background: linear-gradient(135deg, rgba(79,70,229,.10), rgba(34,197,94,.08));
    display:flex;align-items:center;justify-content:space-between;gap:12px;
    position: sticky; top: 0; z-index: 2;
  }
  .m-title{display:flex;flex-direction:column;gap:4px;min-width:0;}
  .m-title .t{
    font-size:16px;font-weight:950;color: rgba(15,23,42,.90);
    display:flex;align-items:center;gap:10px;
    min-width:0;
  }
  .m-title .t span{min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .m-title .s{font-size:12px;color: rgba(71,85,105,.92)}
  .m-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
  .m-close{
    width:40px;height:40px;border-radius:14px;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(255,255,255,.90);
    cursor:pointer;
    font-size:18px;font-weight:900;
  }
  .m-close:hover{transform: translateY(-1px); box-shadow:0 10px 18px rgba(2,6,23,.10)}
  .m-body{
    padding: 12px 14px 14px;
    overflow:auto;
    flex: 1;
    background: rgba(15,23,42,.02);
  }
  .m-controls{
    display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;
    margin-bottom: 10px;
  }
  .m-controls .left{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .m-controls .right{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .m-kpis{display:flex;flex-wrap:wrap;gap:10px}
  .m-kpi{
    padding:8px 10px;border-radius:14px;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(255,255,255,.90);
    font-size:12px;font-weight:900;color: rgba(15,23,42,.72);
    white-space:nowrap;
  }

  /* ===== Popup customers (NEW pro layout) ===== */
  .cust-list{display:flex;flex-direction:column;gap:10px}
  .cust2{
    border-radius: 18px;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(255,255,255,.95);
    box-shadow: 0 10px 18px rgba(2,6,23,.06);
    overflow:hidden;
  }
  .cust2-hd{
    padding: 12px 12px 10px;
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
  }
  .cust2-left{min-width:0;display:flex;flex-direction:column;gap:6px}
  .cust2-name{
    font-size:13px;
    font-weight:1000;
    color: rgba(15,23,42,.90);
    line-height:1.25;
    word-break:break-word;
  }
  .cust2-sub{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .cccd-pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:6px 10px;border-radius:999px;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(255,255,255,.90);
    font-size:12px;font-weight:950;color: rgba(15,23,42,.78);
    cursor:pointer;
    user-select:none;
  }
  .cccd-pill:hover{box-shadow:0 10px 18px rgba(2,6,23,.08); transform: translateY(-1px)}
  .pill-st{
    display:inline-flex;align-items:center;gap:7px;
    padding:6px 10px;border-radius:999px;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(15,23,42,.03);
    font-size:12px;font-weight:950;white-space:nowrap;
  }
  .pill-st.ok{border-color: rgba(34,197,94,.30); background: rgba(34,197,94,.12); color: rgba(20,83,45,.92)}
  .pill-st.bad{border-color: rgba(239,68,68,.28); background: rgba(239,68,68,.10); color: rgba(153,27,27,.92)}
  .cust2-right{
    display:flex;
    flex-direction:column;
    align-items:flex-end;
    gap:8px;
    flex: 0 0 auto;
  }
  .amt{
    font-size:14px;
    font-weight:1000;
    color: rgba(30,64,175,.95);
    background: rgba(59,130,246,.10);
    border:1px solid rgba(59,130,246,.22);
    padding:6px 10px;
    border-radius: 999px;
    white-space:nowrap;
  }
  .cust2-meta{
    padding: 0 12px 12px;
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
  }
  .meta-chip{
    display:inline-flex;align-items:center;gap:7px;
    padding:6px 10px;border-radius:999px;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(15,23,42,.02);
    font-size:12px;font-weight:900;
    color: rgba(15,23,42,.74);
    white-space:nowrap;
  }
  .meta-chip.mono{font-variant-numeric: tabular-nums; font-feature-settings: "tnum";}
  .cust2-reason{
    padding: 10px 12px;
    border-top:1px dashed rgba(15,23,42,.10);
    background: rgba(239,68,68,.06);
    color: rgba(153,27,27,.92);
    font-size:12px;
    line-height:1.35;
  }
  .cust2-reason b{font-weight:1000}

  details.tx-acc{
    border-top:1px dashed rgba(15,23,42,.10);
    background: rgba(15,23,42,.012);
  }
  details.tx-acc > summary{
    list-style:none;
    cursor:pointer;
    user-select:none;
    padding: 10px 12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    font-size:12px;
    font-weight:950;
    color: rgba(15,23,42,.75);
  }
  details.tx-acc > summary::-webkit-details-marker{display:none}
  .tx-sum-left{display:flex;align-items:center;gap:10px}
  .tx-sum-right{opacity:.85}
  .tx-body{padding: 0 12px 12px}
  .tx-row{
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    padding:8px 0;
    border-bottom:1px solid rgba(15,23,42,.06);
    font-size:12px;
  }
  .tx-row:last-child{border-bottom:0}
  .tx-left{display:flex;flex-direction:column;gap:2px;min-width:0}
  .tx-time{color: rgba(71,85,105,.92)}
  .tx-amt{font-weight:1000;color: rgba(15,23,42,.88);font-variant-numeric:tabular-nums;font-feature-settings:"tnum"}
  .tx-src{opacity:.75;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width: 64ch}

  .skeleton{
    background: linear-gradient(90deg, rgba(15,23,42,.04), rgba(15,23,42,.02), rgba(15,23,42,.04));
    background-size: 240% 100%;
    animation: sk 1.2s ease infinite;
    border-radius: 12px;
    height: 12px;
  }
  @keyframes sk{ 0%{background-position: 0% 0} 100%{background-position: 240% 0} }
</style>

{% set items = (data.get('items') if data and data.get('items') is not none else []) %}
{% set project_id_val = project_id if project_id is defined else None %}

{# ===== Summary (static full list) ===== #}
{% set ns = namespace(sum_paid=0, sum_tickets=0) %}
{% for r in items %}
  {% set paid_el = r.get("eligible_deposit_amount") if r.get("eligible_deposit_amount") is not none else r.get("total_paid_vnd_eligible") %}
  {% set c_el = r.get("eligible_customer_count") if r.get("eligible_customer_count") is not none else r.get("eligible_customer_count_for_lot") %}
  {% set ns.sum_paid = ns.sum_paid + (paid_el or 0) %}
  {% set ns.sum_tickets = ns.sum_tickets + (c_el or 0) %}
{% endfor %}

<div class="rp-wrap">
  <div class="rp-head">
    <div class="rp-title">
      <div>
        <h1>
          <i class="ri-checkbox-circle-line" style="color: var(--pri);font-size:24px"></i>
          Lô đủ điều kiện
        </h1>
        <p>
          Tổng hợp các lô đạt điều kiện mở đấu giá (>= 2 khách đủ điều kiện). Bấm “Xem khách” để xem chi tiết trong popup.
        </p>
      </div>
      <div class="pill">
        <span class="dot"></span>
        Reports V2
      </div>
    </div>

    <div class="rp-controls">
      <form id="projForm" method="get" action="{{ request.url.path }}">
        <div class="sel">
          <label>Dự án</label>
          <select id="projectSelect">
            <option value="">— Chọn dự án —</option>
            {% for p in (projects or []) %}
              {% set pid = p.get("id") or p.get("project_id") %}
              {% set code = (p.get("project_code") or p.get("code") or "")|upper %}
              <option value="{{ pid }}" {% if pid == project_id_val %}selected{% endif %}>
                {{ code }} — {{ (p.get("name") or "") }}
              </option>
            {% endfor %}
          </select>
        </div>
      </form>

      {% if project_id_val %}
        <a class="btn primary" href="/reports/v2/projects/{{ project_id_val }}/lots/eligible/export">
          <i class="ri-download-2-line"></i> Export XLSX
        </a>
      {% endif %}

      <a class="btn" href="/reports">
        <i class="ri-arrow-left-line"></i> Tổng quan
      </a>
    </div>

    {# KPI giữ nguyên như bạn đang có, không lặp lại để ngắn #}
  </div>

  <div class="rp-card">
    <div class="hd">
      <div class="left">
        <span class="badge ok"><i class="ri-list-check-2"></i> Danh sách lô</span>
        <span class="muted">Sort/Filter chạy local (không gọi API). Popup tải theo yêu cầu.</span>
      </div>
    </div>

    {% if items|length == 0 %}
      <div style="padding:18px 14px;color:rgba(71,85,105,.88);font-size:13px">
        Chưa có dữ liệu. Hãy chọn dự án để xem danh sách.
      </div>
    {% else %}

      {# ===== Summary row (STATIC: full list, không đổi theo sort/filter) ===== #}
      <div class="sumbar">
        <div class="sumcard ok">
          <div class="sumtop">
            <div class="sumlbl">Tổng số lô đủ ĐK</div>
            <div class="sumico" style="border-color:rgba(34,197,94,.22);background:rgba(34,197,94,.10);color:rgba(20,83,45,.92)">
              <i class="ri-layout-grid-line"></i>
            </div>
          </div>
          <div class="sumval"><span class="mono">{{ items|length }}</span></div>
          <div class="sumsub sumhint">Tính từ toàn bộ dữ liệu đã tải về (không đổi theo sort/filter).</div>
        </div>

        <div class="sumcard money">
          <div class="sumtop">
            <div class="sumlbl">Tổng tiền cọc (khách đủ ĐK)</div>
            <div class="sumico" style="border-color:rgba(59,130,246,.22);background:rgba(59,130,246,.10);color:rgba(30,64,175,.92)">
              <i class="ri-coins-line"></i>
            </div>
          </div>
          <div class="sumval mono" data-money="{{ ns.sum_paid }}">{{ ns.sum_paid }}</div>
          <div class="sumsub sumhint">Cộng dồn “eligible_deposit_amount” theo từng lô.</div>
        </div>

        <div class="sumcard ticket">
          <div class="sumtop">
            <div class="sumlbl">Tổng số phiếu trả giá</div>
            <div class="sumico" style="border-color:rgba(79,70,229,.22);background:rgba(79,70,229,.10);color:rgba(49,46,129,.92)">
              <i class="ri-file-list-3-line"></i>
            </div>
          </div>
          <div class="sumval"><span class="mono">{{ ns.sum_tickets }}</span></div>
          <div class="sumsub sumhint">= Tổng số khách đủ ĐK của tất cả lô (sum eligible_customer_count).</div>
        </div>
      </div>

      <div class="list-controls">
        <div class="lc-left">
          <div class="ctl">
            <label>Sắp xếp</label>
            <select id="lotSortKey">
              <option value="default">Mặc định</option>
              <option value="eligible_count">Số KH đủ ĐK</option>
              <option value="starting_price">Giá khởi điểm</option>
            </select>
          </div>

          <div class="toggle" id="lotSortDir" data-dir="desc" title="Đổi chiều tăng/giảm">
            <span class="ico"><i class="ri-sort-desc"></i></span>
            <span>Giảm dần</span>
          </div>

          <label class="chk" title="Chỉ hiện các lô có khách nộp cọc nhưng bị loại (muộn/loại tay/...)">
            <input type="checkbox" id="lotFilterDiff" />
            <span>Chênh lệch KH (tham gia ≠ đủ ĐK)</span>
          </label>

          <button class="btn" type="button" id="lotReset">
            <i class="ri-refresh-line"></i> Reset
          </button>
        </div>

        <div class="lc-right">
          <div class="mini-kpi" id="lotShownKpi">—</div>
        </div>
      </div>

      <div class="tbl-wrap">
        <table class="tbl" id="lotTable">
          <colgroup>
            <col style="width:12%">   {# Lô hẹp lại #}
            <col style="width:26%">
            <col style="width:25%">   {# 2 cột này rộng hơn #}
            <col style="width:25%">
            <col style="width:12%">
          </colgroup>
          <thead>
            <tr>
              <th>Lô</th>
              <th>Thông tin lô</th>
              <th>Tham gia đặt cọc</th>
              <th>Khách đủ điều kiện</th>
              <th style="text-align:right">Chi tiết</th>
            </tr>
          </thead>

          <tbody id="lotTbody">
            {% for r in items %}
              {% set lot_id = r.get("lot_id") %}
              {% set lot_code = r.get("lot_code") %}
              {% set name = r.get("lot_name") or r.get("lot_title") or r.get("lot_description") or "" %}
              {% set area = r.get("area_m2") or r.get("area") %}
              {% set sp = r.get("starting_price_vnd") %}
              {% set step = r.get("bid_step_vnd") %}
              {% set dep_req = r.get("deposit_vnd") or r.get("deposit_required_vnd") %}
              {% set paid_all = r.get("total_deposit_amount") if r.get("total_deposit_amount") is not none else r.get("total_paid_vnd_all") %}
              {% set paid_el = r.get("eligible_deposit_amount") if r.get("eligible_deposit_amount") is not none else r.get("total_paid_vnd_eligible") %}
              {% set c_all = r.get("total_customers_paid") if r.get("total_customers_paid") is not none else r.get("deposit_customer_count") %}
              {% set c_el = r.get("eligible_customer_count") if r.get("eligible_customer_count") is not none else r.get("eligible_customer_count_for_lot") %}
              {% set fp = r.get("first_paid_at") %}
              {% set lp = r.get("last_paid_at") %}
              {% set fp2 = r.get("eligible_first_paid_at") if r.get("eligible_first_paid_at") is not none else r.get("first_paid_at_eligible") %}
              {% set lp2 = r.get("eligible_last_paid_at") if r.get("eligible_last_paid_at") is not none else r.get("last_paid_at_eligible") %}

              <tr class="row"
                  data-lot-id="{{ lot_id }}"
                  data-lot-code="{{ lot_code }}"
                  data-idx="{{ loop.index0 }}"
                  data-total-customers="{{ c_all or 0 }}"
                  data-eligible-customers="{{ c_el or 0 }}"
                  data-starting-price="{{ sp or 0 }}">
                <td>
                  <a class="lotcode mono" href="javascript:void(0)" onclick="openLotModal({{ lot_id }})">{{ lot_code }}</a>
                  {% if name %}<div class="lotname">{{ name }}</div>{% endif %}
                </td>

                <td>
                  <div class="mini">
                    {% if area %}<span class="mono">{{ area }}</span> m²{% else %}—{% endif %}
                    <span style="opacity:.35">•</span>
                    Giá khởi điểm: <b class="mono" data-money="{{ sp or 0 }}">{{ sp or 0 }}</b>
                    <br/>
                    Bước giá: <b class="mono" data-money="{{ step or 0 }}">{{ step or 0 }}</b>
                    <span style="opacity:.35">•</span>
                    Cọc yêu cầu: <b class="mono" data-money="{{ dep_req or 0 }}">{{ dep_req or 0 }}</b>
                  </div>
                </td>

                <td>
                  <div style="display:flex;flex-wrap:wrap;gap:8px">
                    <span class="chip"><i class="ri-user-3-line"></i> <span class="mono">{{ c_all or 0 }}</span> khách</span>
                    <span class="chip money"><i class="ri-coins-line"></i> <span class="mono" data-money="{{ paid_all or 0 }}">{{ paid_all or 0 }}</span></span>
                    {% if (c_all or 0) != (c_el or 0) %}
                      <span class="chip deadline"><i class="ri-error-warning-line"></i> Chênh lệch</span>
                    {% endif %}
                  </div>
                  <div class="mini" style="margin-top:6px">
                    {% if fp or lp %}{{ fp or "—" }} → {{ lp or "—" }}{% else %}—{% endif %}
                  </div>
                </td>

                <td>
                  <div style="display:flex;flex-wrap:wrap;gap:8px">
                    <span class="chip ok"><i class="ri-user-star-line"></i> <span class="mono">{{ c_el or 0 }}</span> khách</span>
                    <span class="chip money"><i class="ri-coins-line"></i> <span class="mono" data-money="{{ paid_el or 0 }}">{{ paid_el or 0 }}</span></span>
                  </div>
                  <div class="mini" style="margin-top:6px">
                    {% if fp2 or lp2 %}{{ fp2 or "—" }} → {{ lp2 or "—" }}{% else %}—{% endif %}
                  </div>
                </td>

                <td style="text-align:right">
                  <div class="act">
                    <button class="view-btn" type="button" onclick="openLotModal({{ lot_id }})">
                      <i class="ri-team-line"></i> Xem khách
                    </button>
                  </div>
                  <div class="sub-actions" style="margin-top:8px">
                    {% if project_id_val %}
                      <a href="/reports/v2/projects/{{ project_id_val }}/lots/{{ lot_id }}" target="_blank" rel="noopener">
                        <i class="ri-external-link-line"></i> Mở trang chi tiết
                      </a>
                    {% endif %}
                  </div>
                </td>
              </tr>
            {% endfor %}

            <tr class="empty-row" id="lotEmptyRow" style="display:none">
              <td colspan="5">
                Không có dữ liệu theo bộ lọc hiện tại. Bấm <b>Reset</b> để quay về mặc định.
              </td>
            </tr>
          </tbody>
        </table>
      </div>

    {% endif %}
  </div>
</div>

<!-- ===== Modal: Lot customers & txns (giữ nguyên API) ===== -->
<div class="modal" id="lotModal" aria-hidden="true">
  <div class="bg" onclick="closeLotModal()"></div>
  <div class="panel" role="dialog" aria-modal="true">
    <div class="m-hd">
      <div class="m-title">
        <div class="t">
          <i class="ri-group-line" style="color:rgba(49,46,129,.95);font-size:20px"></i>
          <span id="mTitle">Khách &amp; giao dịch</span>
          <span class="badge ok" id="mCount" style="margin-left:10px">—</span>
        </div>
        <div class="s" id="mSub">Tải theo yêu cầu từ Reports V2 (lot detail). Sort/Filter trong popup chạy offline.</div>
      </div>
      <div class="m-actions">
        <a class="btn" id="mOpenDetail" href="javascript:void(0)" target="_blank" rel="noopener">
          <i class="ri-external-link-line"></i> Mở trang chi tiết
        </a>
        <button class="m-close" type="button" onclick="closeLotModal()" aria-label="Đóng">×</button>
      </div>
    </div>

    <div class="m-body">
      <div class="m-controls">
        <div class="left">
          <div class="ctl">
            <label>Lọc</label>
            <select id="mFilterKey">
              <option value="all">Tất cả</option>
              <option value="ineligible">Chỉ KHÔNG đủ ĐK</option>
            </select>
          </div>

          <div class="ctl">
            <label>Sắp xếp</label>
            <select id="mSortKey">
              <option value="default">Mặc định</option>
              <option value="paid_time_asc">Time nhận cọc ↑</option>
              <option value="paid_time_desc">Time nhận cọc ↓</option>
              <option value="amount_desc">Số tiền ↓</option>
              <option value="name_asc">Tên A→Z</option>
            </select>
          </div>

          <button class="btn" type="button" id="mReset">
            <i class="ri-refresh-line"></i> Reset
          </button>
        </div>

        <div class="right">
          <div class="m-kpis" id="mKpis"></div>
        </div>
      </div>

      <div id="mBody">
        <div class="skeleton" style="width:42%"></div>
        <div class="skeleton" style="width:66%;margin-top:10px"></div>
        <div class="skeleton" style="width:58%;margin-top:10px"></div>
      </div>
    </div>
  </div>
</div>

<script>
  // ===== helpers =====
  function fmtMoney(n){
    try{ return Number(n || 0).toLocaleString('vi-VN'); }
    catch(e){ return String(n || 0); }
  }
  function applyMoneyFormat(root){
    const nodes = (root || document).querySelectorAll('[data-money]');
    nodes.forEach(el => el.textContent = fmtMoney(el.getAttribute('data-money')));
  }
  applyMoneyFormat(document);

  // ===== project select redirect (V2 path) =====
  (function(){
    const sel = document.getElementById('projectSelect');
    if(!sel) return;
    sel.addEventListener('change', () => {
      const pid = sel.value;
      if(!pid){ window.location.href = '/reports'; return; }
      window.location.href = `/reports/v2/projects/${pid}/lots/eligible`;
    });
  })();

  // =========================
  // MAIN LIST: local sort/filter (SAFE: không xoá tbody)
  // =========================
  const lotTbody = document.getElementById('lotTbody');
  const lotEmptyRow = document.getElementById('lotEmptyRow');
  const lotRows = lotTbody ? Array.from(lotTbody.querySelectorAll('tr.row')) : [];

  function numAttr(el, name){
    const v = el.getAttribute(name);
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }

  function setShownKpi(shown, total){
    const el = document.getElementById('lotShownKpi');
    if(!el) return;
    el.innerHTML = `<b class="mono">${shown}</b> / <span class="mono">${total}</span> lô đang hiển thị`;
  }

  function applyLotView(){
    if(!lotTbody) return;

    const sortKey = document.getElementById('lotSortKey')?.value || 'default';
    const dirEl = document.getElementById('lotSortDir');
    const dir = (dirEl?.getAttribute('data-dir') || 'desc'); // asc/desc
    const filterDiff = !!document.getElementById('lotFilterDiff')?.checked;

    // filter (ẩn/hiện)
    let visible = [];
    for(const tr of lotRows){
      const t = numAttr(tr, 'data-total-customers');
      const e = numAttr(tr, 'data-eligible-customers');
      const ok = !filterDiff || (t !== e);
      tr.style.display = ok ? '' : 'none';
      if(ok) visible.push(tr);
    }

    // sort visible only (append lại theo thứ tự)
    const mul = (dir === 'asc') ? 1 : -1;

    if(sortKey === 'default'){
      visible.sort((a,b) => (numAttr(a,'data-idx') - numAttr(b,'data-idx')));
    } else if(sortKey === 'eligible_count'){
      visible.sort((a,b) =>
        (numAttr(a,'data-eligible-customers') - numAttr(b,'data-eligible-customers')) * mul
        || (numAttr(a,'data-idx') - numAttr(b,'data-idx'))
      );
    } else if(sortKey === 'starting_price'){
      visible.sort((a,b) =>
        (numAttr(a,'data-starting-price') - numAttr(b,'data-starting-price')) * mul
        || (numAttr(a,'data-idx') - numAttr(b,'data-idx'))
      );
    }

    // append visible rows to reorder (hidden rows giữ nguyên vị trí phía sau)
    for(const tr of visible){
      lotTbody.insertBefore(tr, lotEmptyRow); // luôn chèn trước empty row
    }

    const shown = visible.length;
    setShownKpi(shown, lotRows.length);

    if(lotEmptyRow){
      lotEmptyRow.style.display = (shown === 0) ? '' : 'none';
    }
  }

  (function initLotControls(){
    if(!lotTbody) return;

    const sortKey = document.getElementById('lotSortKey');
    const dirEl = document.getElementById('lotSortDir');
    const filterDiff = document.getElementById('lotFilterDiff');
    const resetBtn = document.getElementById('lotReset');

    // ✅ ép default (tránh browser restore state làm list = 0)
    if(sortKey) sortKey.value = 'default';
    if(filterDiff) filterDiff.checked = false;
    if(dirEl){
      dirEl.setAttribute('data-dir','desc');
      dirEl.querySelector('.ico').innerHTML = '<i class="ri-sort-desc"></i>';
      dirEl.querySelector('span:last-child').textContent = 'Giảm dần';
    }

    sortKey?.addEventListener('change', applyLotView);
    filterDiff?.addEventListener('change', applyLotView);

    dirEl?.addEventListener('click', () => {
      const cur = dirEl.getAttribute('data-dir') || 'desc';
      const next = (cur === 'desc') ? 'asc' : 'desc';
      dirEl.setAttribute('data-dir', next);
      dirEl.querySelector('.ico').innerHTML = (next === 'asc') ? '<i class="ri-sort-asc"></i>' : '<i class="ri-sort-desc"></i>';
      dirEl.querySelector('span:last-child').textContent = (next === 'asc') ? 'Tăng dần' : 'Giảm dần';
      applyLotView();
    });

    resetBtn?.addEventListener('click', () => {
      if(sortKey) sortKey.value = 'default';
      if(filterDiff) filterDiff.checked = false;
      if(dirEl){
        dirEl.setAttribute('data-dir','desc');
        dirEl.querySelector('.ico').innerHTML = '<i class="ri-sort-desc"></i>';
        dirEl.querySelector('span:last-child').textContent = 'Giảm dần';
      }
      applyLotView();
    });

    applyLotView();
  })();

  // =========================
  // MODAL: lazy fetch lot detail + offline sort/filter
  // =========================
  const lotCache = new Map();
  let currentLotData = null;

  function escHtml(s){
    return String(s || '')
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#039;");
  }
  function copyText(s){ try{ navigator.clipboard.writeText(s); }catch(e){} }

  function reasonText(elig){
    if(elig && elig.is_eligible) return 'Đủ điều kiện';
    return (elig && (elig.reason_text || elig.reason_code || elig.ineligible_reason)) || 'Không đủ điều kiện';
  }

  function pickPaidTime(c){
    const dep = (c && c.deposit) || {};
    return dep.paid_at || dep.received_at || dep.txn_time || '';
  }
  function parseTime(s){
    const t = Date.parse(s || '');
    return Number.isFinite(t) ? t : 0;
  }

  function renderCustomer(c){
    const cust = (c && c.customer) || {};
    const elig = (c && c.eligibility) || {};
    const dep  = (c && c.deposit) || {};
    const txns = (c && c.txns) || [];

    const ok = !!elig.is_eligible;
    const stClass = ok ? 'ok' : 'bad';
    const stLabel = ok ? 'ĐỦ ĐK' : 'KHÔNG ĐỦ';

    const cccd = cust.cccd || '';
    const paid = dep.paid_vnd || 0;
    const paidAt = dep.paid_at || '';
    const txnCount = (dep.txn_count ?? (txns ? txns.length : 0)) ?? 0;

    let meta = '';
    if(cust.phone) meta += `<span class="meta-chip"><i class="ri-phone-line"></i> <span class="mono">${escHtml(cust.phone)}</span></span>`;
    if(cust.email) meta += `<span class="meta-chip"><i class="ri-mail-line"></i> <span class="mono">${escHtml(cust.email)}</span></span>`;
    if(paidAt) meta += `<span class="meta-chip"><i class="ri-time-line"></i> <span class="mono">${escHtml(paidAt)}</span></span>`;
    meta += `<span class="meta-chip"><i class="ri-repeat-2-line"></i> <span class="mono">${txnCount}</span> giao dịch</span>`;

    let txHtml = '';
    if(txns && txns.length){
      txHtml = txns.map(t => {
        const amt = t.receipt_amount_vnd ?? t.amount_vnd ?? 0;
        const time = t.received_at || t.txn_time || '';
        const src = t.receipt_source || t.source || '';
        return `
          <div class="tx-row">
            <div class="tx-left">
              <div class="tx-time mono">${escHtml(time)}</div>
              <div class="tx-time tx-src">${escHtml(src)}</div>
            </div>
            <div class="tx-amt mono">${fmtMoney(amt)}</div>
          </div>
        `;
      }).join('');
    }else{
      txHtml = `<div style="color:rgba(71,85,105,.90);font-size:12px;padding-top:8px">Không có danh sách giao dịch (receipt).</div>`;
    }

    const reason = escHtml(reasonText(elig));

    return `
      <div class="cust2">
        <div class="cust2-hd">
          <div class="cust2-left">
            <div class="cust2-name">${escHtml(cust.full_name || '')}</div>
            <div class="cust2-sub">
              ${cccd ? `
                <span class="cccd-pill mono" title="Bấm để copy CCCD" onclick="copyText('${escHtml(cccd)}')">
                  <i class="ri-id-card-line"></i> ${escHtml(cccd)} <span style="opacity:.65">• Copy</span>
                </span>
              ` : ``}
              <span class="pill-st ${stClass}">
                ${ok ? '<i class="ri-shield-check-line"></i>' : '<i class="ri-shield-cross-line"></i>'}
                ${stLabel}
              </span>
            </div>
          </div>

          <div class="cust2-right">
            <span class="pill-st ${stClass}">
              ${ok ? '<i class="ri-checkbox-circle-line"></i>' : '<i class="ri-close-circle-line"></i>'}
              ${ok ? 'Đủ điều kiện' : 'Không đủ'}
            </span>
            <div class="amt"><i class="ri-coins-line"></i> <span class="mono">${fmtMoney(paid)}</span></div>
          </div>
        </div>

        <div class="cust2-meta">${meta}</div>

        ${ok ? '' : `
          <div class="cust2-reason"><b>Lý do:</b> ${reason}</div>
        `}

        <details class="tx-acc" ${txns && txns.length ? '' : ''}>
          <summary>
            <div class="tx-sum-left">
              <i class="ri-receipt-line"></i>
              Giao dịch / receipts
            </div>
            <div class="tx-sum-right">
              <span class="mono">${txns ? txns.length : 0}</span> dòng
              <span style="margin-left:8px;opacity:.7"><i class="ri-arrow-down-s-line"></i></span>
            </div>
          </summary>
          <div class="tx-body">${txHtml}</div>
        </details>
      </div>
    `;
  }

  async function loadLotDetail(projectId, lotId){
    if(lotCache.has(lotId)) return lotCache.get(lotId);

    const url = `/reports/v2/projects/${projectId}/lots/${lotId}/json?expose_phone=1`;
    const res = await fetch(url, {credentials: 'same-origin'});
    if(!res.ok){
      const t = await res.text();
      throw new Error(`HTTP ${res.status}: ${t}`);
    }
    const js = await res.json();
    lotCache.set(lotId, js);
    return js;
  }

  function openModal(){
    const m = document.getElementById('lotModal');
    if(!m) return;
    m.classList.add('show');
    m.setAttribute('aria-hidden','false');
    document.documentElement.style.overflow = 'hidden';
  }
  function closeLotModal(){
    const m = document.getElementById('lotModal');
    if(!m) return;
    m.classList.remove('show');
    m.setAttribute('aria-hidden','true');
    document.documentElement.style.overflow = '';
    currentLotData = null;
  }

  function buildModalKpis(customers){
    const el = document.getElementById('mKpis');
    if(!el) return;
    const total = customers.length || 0;
    const inel = customers.filter(x => !((x.eligibility || {}).is_eligible)).length;
    const elg = total - inel;
    const sum = customers.reduce((acc, x) => acc + (Number(((x.deposit||{}).paid_vnd)||0) || 0), 0);
    el.innerHTML = `
      <div class="m-kpi"><i class="ri-team-line"></i> Tổng: <span class="mono">${total}</span></div>
      <div class="m-kpi" style="border-color:rgba(34,197,94,.30);background:rgba(34,197,94,.10);color:rgba(20,83,45,.92)">
        <i class="ri-shield-check-line"></i> Đủ ĐK: <span class="mono">${elg}</span>
      </div>
      <div class="m-kpi" style="border-color:rgba(239,68,68,.25);background:rgba(239,68,68,.08);color:rgba(153,27,27,.92)">
        <i class="ri-error-warning-line"></i> Không đủ: <span class="mono">${inel}</span>
      </div>
      <div class="m-kpi" style="border-color:rgba(59,130,246,.22);background:rgba(59,130,246,.08);color:rgba(30,64,175,.92)">
        <i class="ri-coins-line"></i> Tổng nộp: <span class="mono">${fmtMoney(sum)}</span>
      </div>
    `;
  }

  function applyModalView(){
    if(!currentLotData) return;

    const customers0 = (currentLotData.customers || []).slice();
    const filterKey = document.getElementById('mFilterKey')?.value || 'all';
    const sortKey = document.getElementById('mSortKey')?.value || 'default';

    let customers = customers0;

    if(filterKey === 'ineligible'){
      customers = customers.filter(x => !((x.eligibility || {}).is_eligible));
    }

    if(sortKey === 'paid_time_asc'){
      customers.sort((a,b) => parseTime(pickPaidTime(a)) - parseTime(pickPaidTime(b)));
    } else if(sortKey === 'paid_time_desc'){
      customers.sort((a,b) => parseTime(pickPaidTime(b)) - parseTime(pickPaidTime(a)));
    } else if(sortKey === 'amount_desc'){
      customers.sort((a,b) => (Number(((b.deposit||{}).paid_vnd)||0) - Number(((a.deposit||{}).paid_vnd)||0)));
    } else if(sortKey === 'name_asc'){
      customers.sort((a,b) => String(((a.customer||{}).full_name)||'').localeCompare(String(((b.customer||{}).full_name)||''), 'vi'));
    }

    buildModalKpis(customers0);

    const body = document.getElementById('mBody');
    if(!body) return;

    if(!customers.length){
      body.innerHTML = `<div style="color:rgba(71,85,105,.90);font-size:13px;padding:8px 2px">
        Không có dữ liệu theo bộ lọc hiện tại.
      </div>`;
      return;
    }
    body.innerHTML = `<div class="cust-list">${customers.map(renderCustomer).join('')}</div>`;
  }

  (function initModalControls(){
    const f = document.getElementById('mFilterKey');
    const s = document.getElementById('mSortKey');
    const r = document.getElementById('mReset');

    f?.addEventListener('change', applyModalView);
    s?.addEventListener('change', applyModalView);

    r?.addEventListener('click', () => {
      if(f) f.value = 'all';
      if(s) s.value = 'default';
      applyModalView();
    });
  })();

  async function openLotModal(lotId){
    const projectId = {{ project_id_val or 0 }};

    openModal();

    const mTitle = document.getElementById('mTitle');
    const mCount = document.getElementById('mCount');
    const mBody  = document.getElementById('mBody');
    const mOpenDetail = document.getElementById('mOpenDetail');

    const row = document.querySelector(`tr.row[data-lot-id="${lotId}"]`);
    const code = row?.getAttribute('data-lot-code') || `#${lotId}`;

    if(mTitle) mTitle.innerHTML = `Khách &amp; giao dịch — <span class="mono">${escHtml(code)}</span>`;
    if(mCount) mCount.innerHTML = `—`;
    if(mOpenDetail) mOpenDetail.href = `/reports/v2/projects/${projectId}/lots/${lotId}`;

    // reset popup controls each open
    const f = document.getElementById('mFilterKey');
    const s = document.getElementById('mSortKey');
    if(f) f.value = 'all';
    if(s) s.value = 'default';

    if(mBody){
      mBody.innerHTML = `
        <div class="skeleton" style="width:42%"></div>
        <div class="skeleton" style="width:66%;margin-top:10px"></div>
        <div class="skeleton" style="width:58%;margin-top:10px"></div>
      `;
    }

    try{
      const js = await loadLotDetail(projectId, lotId);
      currentLotData = js;

      const customers = (js && js.customers) || [];
      const total = customers.length || 0;

      if(mCount){
        mCount.className = 'badge ok';
        mCount.innerHTML = `<i class="ri-team-line"></i> <span class="mono">${total}</span> khách`;
      }

      applyModalView();
    }catch(e){
      if(mCount){
        mCount.className = 'badge';
        mCount.innerHTML = `<i class="ri-error-warning-line"></i> Lỗi`;
      }
      if(mBody){
        mBody.innerHTML = `<div style="color:rgba(153,27,27,.92);font-size:13px">
          Không tải được dữ liệu chi tiết. ${escHtml(e && e.message ? e.message : e)}
        </div>`;
      }
    }
  }

  document.addEventListener('keydown', (ev) => {
    if(ev.key === 'Escape'){
      const m = document.getElementById('lotModal');
      if(m && m.classList.contains('show')) closeLotModal();
    }
  });
</script>
{% endblock %}
