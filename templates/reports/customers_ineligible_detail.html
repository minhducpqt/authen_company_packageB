{% extends "base.html" %}
{% block title %}Khách hàng — Lô không đủ điều kiện (Chi tiết){% endblock %}

{% block content %}
<style>
  :root{
    --bd: rgba(15,23,42,.10);
    --bd2: rgba(15,23,42,.07);
    --card: #fff;
    --muted: rgba(71,85,105,.88);
    --txt: #0f172a;

    --bad:#ef4444;
    --warn:#f59e0b;
    --ok:#16a34a;
    --blue:#3b82f6;
    --pri:#4f46e5;

    --shadow: 0 14px 36px rgba(2,6,23,.10);
  }

  .rp-wrap{max-width:1400px;margin:0 auto}
  .rp-head{
    background: linear-gradient(135deg, rgba(79,70,229,.10), rgba(239,68,68,.08));
    border:1px solid var(--bd);
    border-radius: 22px;
    padding: 16px 16px 14px;
    box-shadow: 0 10px 28px rgba(2,6,23,.06);
  }
  .rp-title{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
  .rp-title h1{font-size:20px;font-weight:900;color:var(--txt);display:flex;align-items:center;gap:10px;margin:0}
  .rp-title p{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.35}

  .pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:8px 10px;border-radius:999px;
    background: rgba(255,255,255,.72);
    border:1px solid var(--bd2);
    color: rgba(15,23,42,.70);
    font-size:12px;font-weight:800;
    backdrop-filter: blur(8px);
    white-space:nowrap;
  }
  .dot{width:8px;height:8px;border-radius:999px;background: var(--bad);box-shadow:0 0 0 3px rgba(239,68,68,.14)}

  .rp-controls{
    margin-top: 12px;
    display:flex;flex-wrap:wrap;align-items:center;gap:10px;
  }
  .sel{
    display:flex;align-items:center;gap:10px;
    padding:10px 12px;border-radius: 14px;
    border:1px solid var(--bd);
    background: rgba(255,255,255,.80);
    min-width: 320px;
    flex: 1 1 520px;
  }
  .sel label{font-size:12px;color:rgba(15,23,42,.65);font-weight:900}
  .sel select{
    border:0;outline:0;background:transparent;
    font-weight:950;color:var(--txt);
    width:100%;
  }

  .btn{
    display:inline-flex;align-items:center;gap:8px;
    padding:10px 12px;border-radius: 14px;
    border:1px solid var(--bd);
    background: rgba(255,255,255,.88);
    font-size:12px;font-weight:950;color: rgba(15,23,42,.78);
    transition: .15s ease;
    text-decoration:none;
    cursor:pointer;
    user-select:none;
    white-space:nowrap;
  }
  .btn:hover{transform: translateY(-1px); box-shadow: 0 10px 20px rgba(2,6,23,.10)}
  .btn.primary{
    border-color: rgba(239,68,68,.30);
    background: linear-gradient(180deg, rgba(239,68,68,.14), rgba(239,68,68,.08));
    color: rgba(153,27,27,.95);
  }

  .kpis{
    margin-top: 14px;
    display:grid;
    grid-template-columns: repeat(12, 1fr);
    gap:10px;
  }
  .kpi{
    grid-column: span 3;
    background: rgba(255,255,255,.90);
    border:1px solid var(--bd);
    border-radius: 18px;
    padding: 12px 12px 10px;
    box-shadow: 0 10px 22px rgba(2,6,23,.06);
    min-width:0;
  }
  @media (max-width: 1024px){ .kpi{grid-column: span 6} }
  @media (max-width: 640px){
    .sel{min-width:100%}
    .kpi{grid-column: span 12}
  }
  .kpi .t{font-size:12px;color:rgba(15,23,42,.62);font-weight:900}
  .kpi .v{margin-top:6px;font-size:18px;font-weight:950;color:var(--txt);letter-spacing:.2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .kpi .s{margin-top:6px;font-size:11px;color:rgba(71,85,105,.90);line-height:1.35}
  .mono{font-variant-numeric: tabular-nums; font-feature-settings: "tnum";}

  .rp-card{
    margin-top: 14px;
    background: var(--card);
    border:1px solid var(--bd);
    border-radius: 22px;
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .rp-card .hd{
    padding: 12px 14px;
    border-bottom:1px solid var(--bd2);
    background: linear-gradient(90deg, rgba(15,23,42,.03), rgba(15,23,42,.00));
    display:flex;align-items:center;justify-content:space-between;gap:12px;
  }
  .badge{
    display:inline-flex;align-items:center;gap:7px;
    padding:6px 10px;border-radius:999px;
    border:1px solid var(--bd2);
    background: rgba(255,255,255,.88);
    font-size:12px;font-weight:950;color:rgba(15,23,42,.74);
  }
  .badge.bad{border-color: rgba(239,68,68,.26); background: rgba(239,68,68,.08); color: rgba(153,27,27,.92)}
  .muted{color: var(--muted);font-size:12px}

  .list-controls{
    padding: 10px 14px;
    border-bottom:1px solid rgba(15,23,42,.06);
    display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;
    background: rgba(255,255,255,.84);
  }
  .lc-left{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .ctl{
    display:flex;align-items:center;gap:8px;
    padding:8px 10px;border-radius:14px;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(15,23,42,.02);
  }
  .ctl label{font-size:12px;font-weight:900;color:rgba(15,23,42,.70)}
  .ctl select, .ctl input{
    border:0;outline:0;background:transparent;
    font-size:12px;font-weight:950;color:rgba(15,23,42,.85);
  }
  .lc-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .mini-kpi{
    font-size:12px;color:rgba(71,85,105,.92);
    padding:8px 10px;border-radius:14px;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(15,23,42,.02);
  }

  /* ===== MAIN TABLE ===== */
  .tbl-wrap{padding: 12px 14px 16px;background: rgba(15,23,42,.01)}
  .tbl-scroll{
    overflow-x:auto;
    border-radius: 18px;
    border:1px solid rgba(15,23,42,.08);
    background: rgba(255,255,255,.92);
  }
  table.rp-table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    min-width: 1180px;
  }
  thead th{
    position: sticky;
    top: 0;
    z-index: 2;
    background: rgba(255,255,255,.98);
    font-size:12px;
    font-weight:950;
    color: rgba(15,23,42,.60);
    text-align:left;
    padding: 12px 12px;
    border-bottom:1px solid rgba(15,23,42,.08);
    white-space:nowrap;
  }
  tbody td{
    padding: 14px 12px;
    vertical-align:top;
    border-bottom:1px solid rgba(15,23,42,.06);
    background: rgba(255,255,255,.96);
  }
  tbody tr:hover td{ background: rgba(15,23,42,.015); }

  .cust-name{font-weight:1000;color: rgba(15,23,42,.92);line-height:1.25;word-break:break-word}
  .subline{margin-top:8px;display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .pill2{
    display:inline-flex;align-items:center;gap:8px;
    padding:6px 10px;border-radius:999px;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(255,255,255,.92);
    font-size:12px;font-weight:950;color: rgba(15,23,42,.78);
    user-select:none;
    cursor:pointer;
    white-space:nowrap;
  }
  .pill2:hover{box-shadow:0 10px 18px rgba(2,6,23,.08); transform: translateY(-1px)}
  .pill2.gray{cursor:default;opacity:.8}
  .pill2.gray:hover{box-shadow:none;transform:none}
  .pill2.bad{border-color: rgba(239,68,68,.22); background: rgba(239,68,68,.06); color: rgba(153,27,27,.92)}
  .pill2.money{border-color: rgba(59,130,246,.22); background: rgba(59,130,246,.08); color: rgba(30,64,175,.92)}
  .pill2.warn{border-color: rgba(245,158,11,.22); background: rgba(245,158,11,.10); color: rgba(124,45,18,.92)}
  .pill2.ok{border-color: rgba(22,163,74,.22); background: rgba(22,163,74,.10); color: rgba(20,83,45,.92)}

  .mini{font-size:12px;color: rgba(71,85,105,.92);line-height:1.35}

  /* ===== DETAILS PANEL ===== */
  .details{
    margin-top:10px;
    border:1px solid rgba(15,23,42,.08);
    border-radius: 16px;
    overflow:hidden;
    background: rgba(255,255,255,.92);
  }
  .details .dh{
    padding:10px 12px;
    background: rgba(15,23,42,.02);
    border-bottom:1px solid rgba(15,23,42,.06);
    display:flex;align-items:center;justify-content:space-between;gap:10px;
  }
  .details .db{ padding: 10px 12px; }

  table.lot-table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
  }
  table.lot-table th{
    font-size:11px;
    font-weight:950;
    color: rgba(15,23,42,.62);
    text-align:left;
    padding:10px 10px;
    border-bottom:1px solid rgba(15,23,42,.06);
    background: rgba(255,255,255,.96);
    white-space:nowrap;
  }
  table.lot-table td{
    padding:10px 10px;
    border-bottom:1px solid rgba(15,23,42,.06);
    vertical-align:top;
    background: rgba(255,255,255,.98);
  }

  .kv{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  .raw{
    margin-top:10px;
    border:1px dashed rgba(15,23,42,.16);
    border-radius: 14px;
    padding: 10px 12px;
    background: rgba(15,23,42,.02);
    font-size:12px;
    color: rgba(15,23,42,.78);
    white-space:pre-wrap;
    word-break:break-word;
    display:none;
  }

  .empty{
    margin-top:10px;
    padding: 14px 12px;
    border:1px dashed rgba(15,23,42,.14);
    border-radius: 16px;
    background: rgba(255,255,255,.90);
    color: rgba(71,85,105,.90);
    font-size:13px;
  }
</style>

{% set is_v2 = (is_v2 if is_v2 is defined else true) %}
{% set project_id_val = (project_id if project_id is defined else None) %}
{% set items = (data.get('items') if data and data.get('items') is not none else []) %}

<div class="rp-wrap">
  <div class="rp-head">
    <div class="rp-title">
      <div>
        <h1>
          <i class="ri-shield-cross-line" style="color: var(--bad);font-size:24px"></i>
          Khách hàng — Lô KHÔNG đủ điều kiện (chi tiết)
        </h1>
        <p>
          Trang này trả lời: <b>khách liên quan lô nào</b>, <b>vì sao không đủ điều kiện</b>, và <b>bằng chứng giao dịch</b>.
        </p>
      </div>
      <div class="pill">
        <span class="dot"></span>
        Evidence & lý do
      </div>
    </div>

    <div class="rp-controls">
      <form method="get" action="{{ request.url.path }}" style="flex:1 1 auto">
        <div class="sel">
          <label>Dự án</label>
          <select id="projectSelectV2">
            <option value="">— Chọn dự án —</option>
            {% for p in (projects or []) %}
              {% set pid = p.get("id") or p.get("project_id") %}
              {% set code = (p.get("project_code") or p.get("code") or "")|upper %}
              <option value="{{ pid }}" {% if pid == project_id_val %}selected{% endif %}>
                {{ code }} — {{ (p.get("name") or "") }}
              </option>
            {% endfor %}
          </select>
        </div>
      </form>

      {% if project_id_val %}
        <a class="btn primary" href="/reports/v2/projects/{{ project_id_val }}/customers/ineligible/detail/export?limit={{ limit or 10000 }}&expose_phone=1">
          <i class="ri-download-2-line"></i> Export chi tiết (Excel)
        </a>
      {% endif %}

      <a class="btn" href="/reports">
        <i class="ri-arrow-left-line"></i> Quay lại
      </a>
    </div>

    <div class="kpis">
      <div class="kpi">
        <div class="t">Tổng dòng (customer+lot)</div>
        <div class="v"><span class="mono" id="kpiPairs">—</span></div>
        <div class="s">Số dòng chi tiết theo endpoint.</div>
      </div>

      <div class="kpi">
        <div class="t">Số khách (unique)</div>
        <div class="v"><span class="mono" id="kpiCustomers">—</span></div>
        <div class="s">Đếm theo customer_id / CCCD.</div>
      </div>

      <div class="kpi money">
        <div class="t">Tổng tiền (unique theo khách)</div>
        <div class="v"><span class="mono" id="kpiMoney">—</span></div>
        <div class="s">Cộng theo khách (không cộng trùng theo lô).</div>
      </div>

      <div class="kpi">
        <div class="t">Có bằng chứng giao dịch</div>
        <div class="v"><span class="mono" id="kpiEvi">—</span></div>
        <div class="s">Số khách có ít nhất 1 evidence.</div>
      </div>
    </div>
  </div>

  <div class="rp-card">
    <div class="hd">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <span class="badge bad"><i class="ri-file-search-line"></i> Chi tiết khách + lô</span>
        <span class="muted">Search / sort / expand để xem lý do & evidence.</span>
      </div>
    </div>

    {% if items|length == 0 %}
      <div style="padding:18px 14px;color:rgba(71,85,105,.88);font-size:13px">
        Chưa có dữ liệu. Vui lòng chọn dự án để xem chi tiết.
      </div>
    {% else %}

      <div class="list-controls">
        <div class="lc-left">
          <div class="ctl">
            <label>Sắp xếp</label>
            <select id="sortKey">
              <option value="default">Mặc định</option>
              <option value="money_desc">Tổng tiền (cao → thấp)</option>
              <option value="lots_desc">Số lô (nhiều → ít)</option>
              <option value="name_asc">Tên (A → Z)</option>
              <option value="evi_desc">Có evidence trước</option>
            </select>
          </div>

          <div class="ctl">
            <label>Tìm</label>
            <input id="q" type="text" placeholder="Tên / CCCD / SĐT / Mã lô" style="width:280px"/>
          </div>

          <button class="btn" type="button" id="resetBtn">
            <i class="ri-refresh-line"></i> Reset
          </button>
        </div>

        <div class="lc-right">
          <div class="mini-kpi" id="shownKpi">—</div>
        </div>
      </div>

      <div class="tbl-wrap">
        <div class="tbl-scroll">
          <table class="rp-table">
            <thead>
              <tr>
                <th style="width:34%">Khách hàng</th>
                <th style="width:26%">Liên hệ</th>
                <th style="width:14%">Tổng tiền</th>
                <th style="width:12%">Số lô</th>
                <th style="width:14%">Trạng thái</th>
              </tr>
            </thead>
            <tbody id="list"></tbody>
          </table>
        </div>

        <div class="empty" id="emptyBox" style="display:none">
          Không có kết quả phù hợp. Vui lòng thử lại hoặc bấm <b>Reset</b>.
        </div>
      </div>

    {% endif %}
  </div>
</div>

<script>
  // ===== RAW DATA from SSR =====
  const RAW_ITEMS = {{ items | tojson | safe }};

  function fmtMoney(n){
    try{ return Number(n || 0).toLocaleString('vi-VN'); }
    catch(e){ return String(n || 0); }
  }
  function copyText(s){
    try{ navigator.clipboard.writeText(String(s||"")); }catch(e){}
  }

  // ===== Normalize helpers (chịu mọi key) =====
  function pick(obj, keys, def=null){
    for(const k of keys){
      if(obj && obj[k] !== undefined && obj[k] !== null && obj[k] !== "") return obj[k];
    }
    return def;
  }

  // ===== Build grouped customers =====
  function buildGroups(rows){
    const map = new Map();

    for(const r of (rows||[])){
      const customerId = pick(r, ["customer_id","cid","id"], null);
      const cccd = pick(r, ["cccd","customer_cccd"], "");
      const phone = pick(r, ["phone","customer_phone"], "");
      const email = pick(r, ["email","customer_email"], "");
      const name  = pick(r, ["customer_full_name","full_name","customer_name","name"], "");

      const key = (customerId !== null) ? `cid:${customerId}` : `cccd:${cccd}`;

      if(!map.has(key)){
        map.set(key, {
          key,
          customerId,
          name, cccd, phone, email,
          totalMoney: 0,
          lots: [],
          hasEvidence: false,
          rawCustomer: {}
        });
      }
      const g = map.get(key);

      // total money (unique by customer): lấy field nếu có (fallback 0)
      const money = Number(pick(r, ["total_deposit_amount_project","total_deposit_amount","sum_deposit_amount","customer_total_deposit"], 0) || 0);
      // chỉ set max (tránh cộng trùng theo mỗi dòng lot)
      if(money > g.totalMoney) g.totalMoney = money;

      // lot info
      const lotId   = pick(r, ["lot_id","project_lot_id"], null);
      const lotCode = pick(r, ["lot_code","project_lot_code","code"], "");
      const lotName = pick(r, ["lot_name","name_lot","lot_title"], "");

      // reason info
      const reason = pick(r, ["reason","ineligible_reason","note","message"], "");
      const reasonCode = pick(r, ["reason_code","ineligible_reason_code","code_reason"], "");

      // evidence / txns
      const evidences = pick(r, ["bank_evidences","evidences","txn_evidences","transactions","txns"], null);
      const hasEvi = Array.isArray(evidences) ? evidences.length > 0 : !!evidences;
      if(hasEvi) g.hasEvidence = true;

      g.lots.push({
        lotId, lotCode, lotName,
        reason, reasonCode,
        evidences,
        raw: r
      });
    }

    return Array.from(map.values());
  }

  // ===== Render =====
  const tbody = document.getElementById("list");
  const emptyBox = document.getElementById("emptyBox");

  function rowHTML(g){
    const lotsCount = g.lots.length;
    const moneyText = fmtMoney(g.totalMoney);
    const statusPill = g.hasEvidence
      ? `<span class="pill2 ok" title="Có evidence giao dịch"><i class="ri-shield-check-line"></i> Có evidence</span>`
      : `<span class="pill2 warn" title="Chưa thấy evidence trong payload"><i class="ri-error-warning-line"></i> Chưa thấy evidence</span>`;

    const cccdPill = g.cccd
      ? `<span class="pill2 mono" onclick="copyText('${String(g.cccd).replaceAll("'", "\\'")}')" title="Copy CCCD"><i class="ri-id-card-line"></i> ${g.cccd} <span style="opacity:.6">• Copy</span></span>`
      : `<span class="pill2 gray"><i class="ri-id-card-line"></i> CCCD —</span>`;

    const phonePill = g.phone
      ? `<span class="pill2 mono bad" onclick="copyText('${String(g.phone).replaceAll("'", "\\'")}')" title="Copy SĐT"><i class="ri-phone-line"></i> ${g.phone} <span style="opacity:.6">• Copy</span></span>`
      : `<span class="pill2 gray"><i class="ri-phone-line"></i> SĐT —</span>`;

    const emailPill = g.email
      ? `<span class="pill2 mono" onclick="copyText('${String(g.email).replaceAll("'", "\\'")}')" title="Copy email"><i class="ri-mail-line"></i> ${g.email}</span>`
      : ``;

    const expandId = `exp_${g.key.replaceAll(":","_").replaceAll(".","_")}`;

    return `
      <tr class="rp-row"
          data-key="${g.key}"
          data-name="${(g.name||"").toLowerCase()}"
          data-cccd="${g.cccd||""}"
          data-phone="${g.phone||""}"
          data-money="${g.totalMoney||0}"
          data-lots="${lotsCount}"
          data-evi="${g.hasEvidence ? 1 : 0}">
        <td>
          <div class="cust-name">${g.name || "(Chưa có tên)"}</div>
          <div class="subline">${cccdPill}</div>
          <div class="subline" style="margin-top:10px">
            <button class="btn" type="button" onclick="toggleDetails('${expandId}')">
              <i class="ri-folder-open-line"></i> Xem lô & bằng chứng (${lotsCount})
            </button>
          </div>
        </td>

        <td>
          <div class="subline" style="margin-top:0">${phonePill} ${emailPill}</div>
          <div class="mini" style="margin-top:6px">Chạm pill để copy nhanh.</div>
        </td>

        <td>
          <span class="pill2 money"><i class="ri-coins-line"></i> <span class="mono">${moneyText}</span></span>
          <div class="mini" style="margin-top:6px">Tổng tiền theo khách (unique).</div>
        </td>

        <td>
          <span class="pill2 warn"><i class="ri-stack-line"></i> <span class="mono">${lotsCount}</span> lô</span>
          <div class="mini" style="margin-top:6px">Số dòng lot trong payload.</div>
        </td>

        <td>
          ${statusPill}
          <div class="mini" style="margin-top:6px">Mở chi tiết để xem lý do từng lô.</div>
        </td>
      </tr>

      <tr id="${expandId}" style="display:none">
        <td colspan="5">
          ${detailsHTML(g)}
        </td>
      </tr>
    `;
  }

  function detailsHTML(g){
    const lotsRows = g.lots.map((x, idx) => {
      const lotLabel = (x.lotCode || x.lotName || x.lotId) ? `${x.lotCode || ""} ${x.lotName ? "— "+x.lotName : ""}`.trim() : `(Lot #${idx+1})`;

      const reasonText = (x.reasonCode || x.reason)
        ? `<div class="kv">
             ${x.reasonCode ? `<span class="pill2 warn"><i class="ri-error-warning-line"></i> ${x.reasonCode}</span>` : ``}
             ${x.reason ? `<span class="mini">${escapeHtml(String(x.reason))}</span>` : ``}
           </div>`
        : `<span class="mini">Chưa thấy field reason trong payload dòng này.</span>`;

      const ev = x.evidences;
      const evHtml = renderEvidences(ev);

      const rawId = `raw_${g.key.replaceAll(":","_")}_${idx}`;

      return `
        <tr>
          <td style="white-space:nowrap">
            <span class="pill2"><i class="ri-home-gear-line"></i> ${escapeHtml(lotLabel)}</span>
            ${x.lotId ? `<div class="mini">lot_id: <span class="code">${x.lotId}</span></div>` : ``}
          </td>
          <td>${reasonText}</td>
          <td>${evHtml}</td>
          <td style="white-space:nowrap">
            <button class="btn" type="button" onclick="toggleRaw('${rawId}')"><i class="ri-code-s-slash-line"></i> Raw</button>
            <div id="${rawId}" class="raw">${escapeHtml(JSON.stringify(x.raw, null, 2))}</div>
          </td>
        </tr>
      `;
    }).join("");

    return `
      <div class="details">
        <div class="dh">
          <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
            <span class="badge"><i class="ri-list-check-2"></i> Lô liên quan & lý do</span>
            <span class="muted">Hiển thị theo dữ liệu endpoint /customers/ineligible/detail</span>
          </div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <span class="pill2 money"><i class="ri-coins-line"></i> ${fmtMoney(g.totalMoney)}</span>
            <span class="pill2 warn"><i class="ri-stack-line"></i> ${g.lots.length} lô</span>
            ${g.hasEvidence ? `<span class="pill2 ok"><i class="ri-shield-check-line"></i> Có evidence</span>` : `<span class="pill2 warn"><i class="ri-error-warning-line"></i> Thiếu evidence</span>`}
          </div>
        </div>
        <div class="db">
          <table class="lot-table">
            <thead>
              <tr>
                <th style="width:26%">Lô</th>
                <th style="width:34%">Vì sao không đủ điều kiện</th>
                <th style="width:30%">Bằng chứng giao dịch</th>
                <th style="width:10%">Debug</th>
              </tr>
            </thead>
            <tbody>
              ${lotsRows}
            </tbody>
          </table>
        </div>
      </div>
    `;
  }

  function renderEvidences(ev){
    // Nếu endpoint trả list transaction/evidence: render list nhỏ gọn
    if(Array.isArray(ev)){
      if(ev.length === 0) return `<span class="mini">Không có evidence.</span>`;
      const lines = ev.slice(0, 6).map(e => {
        const bank = pick(e, ["bank_name","bank","bank_code"], "");
        const amt  = pick(e, ["amount","amount_vnd","money"], "");
        const time = pick(e, ["paid_at","txn_time","time","created_at"], "");
        const ref  = pick(e, ["ref","reference","order_code","txn_ref"], "");
        return `
          <div class="kv" style="margin:4px 0">
            <span class="pill2 ok"><i class="ri-bank-line"></i> ${escapeHtml(String(bank||"BANK"))}</span>
            ${amt !== "" ? `<span class="pill2 money"><i class="ri-coins-line"></i> ${fmtMoney(amt)}</span>` : ``}
            ${time ? `<span class="pill2"><i class="ri-time-line"></i> ${escapeHtml(String(time))}</span>` : ``}
            ${ref ? `<span class="pill2 mono" onclick="copyText('${String(ref).replaceAll("'", "\\'")}')" title="Copy ref"><i class="ri-file-copy-line"></i> ${escapeHtml(String(ref))}</span>` : ``}
          </div>
        `;
      }).join("");
      const more = ev.length > 6 ? `<div class="mini" style="margin-top:6px">Còn ${ev.length-6} evidence khác (xem Raw).</div>` : ``;
      return `${lines}${more}`;
    }

    // Nếu endpoint trả object single evidence
    if(ev && typeof ev === "object"){
      const ref = pick(ev, ["ref","reference","order_code","txn_ref"], "");
      const amt = pick(ev, ["amount","amount_vnd","money"], "");
      return `
        <div class="kv">
          <span class="pill2 ok"><i class="ri-file-shield-2-line"></i> Evidence</span>
          ${amt !== "" ? `<span class="pill2 money"><i class="ri-coins-line"></i> ${fmtMoney(amt)}</span>` : ``}
          ${ref ? `<span class="pill2 mono" onclick="copyText('${String(ref).replaceAll("'", "\\'")}')"><i class="ri-file-copy-line"></i> ${escapeHtml(String(ref))}</span>` : ``}
        </div>
      `;
    }

    // Không có key evidence
    return `<span class="mini">Chưa thấy evidence trong payload dòng này.</span>`;
  }

  function escapeHtml(s){
    return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  function toggleDetails(id){
    const tr = document.getElementById(id);
    if(!tr) return;
    tr.style.display = (tr.style.display === "none" || !tr.style.display) ? "" : "none";
  }
  function toggleRaw(id){
    const box = document.getElementById(id);
    if(!box) return;
    box.style.display = (box.style.display === "none" || !box.style.display) ? "block" : "none";
  }

  // ===== Render list to DOM =====
  const groups = buildGroups(RAW_ITEMS);

  function setShownKpi(shown, total){
    const el = document.getElementById('shownKpi');
    if(!el) return;
    el.innerHTML = `<b class="mono">${shown}</b> / <span class="mono">${total}</span> khách đang hiển thị`;
  }

  function refreshKPIs(gs){
    const pairs = (RAW_ITEMS||[]).length;
    const customers = gs.length;
    let moneySum = 0;
    let eviCnt = 0;
    for(const g of gs){
      moneySum += Number(g.totalMoney||0);
      if(g.hasEvidence) eviCnt += 1;
    }
    const elPairs = document.getElementById("kpiPairs");
    const elCus = document.getElementById("kpiCustomers");
    const elMoney = document.getElementById("kpiMoney");
    const elEvi = document.getElementById("kpiEvi");
    if(elPairs) elPairs.textContent = pairs;
    if(elCus) elCus.textContent = customers;
    if(elMoney) elMoney.textContent = fmtMoney(moneySum);
    if(elEvi) elEvi.textContent = `${eviCnt} / ${customers}`;
  }

  function applyView(){
    const sortKey = document.getElementById('sortKey')?.value || 'default';
    const q = (document.getElementById('q')?.value || '').trim().toLowerCase();

    let visible = groups.filter(g => {
      if(!q) return true;
      const hay = [
        g.name||"", g.cccd||"", g.phone||"", g.email||"",
        ...(g.lots||[]).map(x => `${x.lotCode||""} ${x.lotName||""}`.trim())
      ].join(" ").toLowerCase();
      return hay.includes(q);
    });

    if(sortKey === "money_desc"){
      visible.sort((a,b) => (b.totalMoney - a.totalMoney) || (a.name||"").localeCompare(b.name||"", "vi"));
    } else if(sortKey === "lots_desc"){
      visible.sort((a,b) => (b.lots.length - a.lots.length) || (b.totalMoney - a.totalMoney));
    } else if(sortKey === "name_asc"){
      visible.sort((a,b) => (a.name||"").localeCompare(b.name||"", "vi"));
    } else if(sortKey === "evi_desc"){
      visible.sort((a,b) => (Number(b.hasEvidence) - Number(a.hasEvidence)) || (b.totalMoney - a.totalMoney));
    }

    // render
    if(tbody){
      tbody.innerHTML = visible.map(rowHTML).join("");
    }

    setShownKpi(visible.length, groups.length);
    if(emptyBox) emptyBox.style.display = (visible.length === 0) ? '' : 'none';
  }

  (function init(){
    refreshKPIs(groups);
    applyView();

    document.getElementById("sortKey")?.addEventListener("change", applyView);
    document.getElementById("q")?.addEventListener("input", () => {
      clearTimeout(window.__rpq);
      window.__rpq = setTimeout(applyView, 80);
    });
    document.getElementById("resetBtn")?.addEventListener("click", () => {
      const sk = document.getElementById("sortKey");
      const q = document.getElementById("q");
      if(sk) sk.value = "default";
      if(q) q.value = "";
      applyView();
    });

    // project redirect
    const sel = document.getElementById('projectSelectV2');
    if(sel){
      sel.addEventListener('change', () => {
        const pid = sel.value;
        if(!pid){ window.location.href = '/reports'; return; }
        const limit = {{ (limit or 10000) }};
        window.location.href = `/reports/v2/projects/${pid}/customers/ineligible/detail?limit=${limit}&expose_phone=1`;
      });
    }
  })();
</script>
{% endblock %}
