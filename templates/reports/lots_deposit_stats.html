{% extends "base.html" %}
{% block title %}Thống kê tiền đặt trước từng lô{% endblock %}

{% block content %}
{% set projects_list = projects or [] %}
{% set MAX_LIMIT = 10000 %}
{% set MIN_CUSTOMERS = 0 %}

<div class="mb-6">
  <h1 class="text-2xl font-semibold text-slate-900 flex items-center gap-2">
    <i class="ri-funds-line text-sky-600 text-3xl"></i>
    Thống kê tiền đặt trước từng lô
  </h1>
  <p class="text-slate-500 text-sm mt-1">
    Tổng hợp theo từng lô: diện tích, khởi điểm, tiền đặt, số khách, tổng tiền và thời điểm nộp.
  </p>
</div>

<form id="filtersForm" method="get" class="bg-white border rounded-2xl shadow-sm p-4 mb-4">
  <div class="flex flex-col md:flex-row md:items-end gap-3">
    <div class="flex-1 min-w-[260px]">
      <label class="block text-xs font-semibold text-slate-500 mb-1">Dự án</label>
      <select id="projectSelectLocal" name="project" class="w-full h-10 rounded-xl border px-3 text-sm">
        <option value="">— Chọn dự án —</option>
        {% for p in projects_list %}
          {% set code = p.project_code or p.code %}
          {% set st = (p.status or p.project_status or '')|upper %}
          <option value="{{ code }}" {% if code == project %}selected{% endif %}>
            {{ code }} — {{ p.name }}{% if st and st != 'ACTIVE' %} (INACTIVE){% endif %}
          </option>
        {% endfor %}
      </select>
    </div>

    {# defaults: max result #}
    <input type="hidden" name="limit" value="{{ MAX_LIMIT }}">
    <input type="hidden" name="min_customers" value="{{ MIN_CUSTOMERS }}">
    {# max_customers: deliberately omit for "no cap" #}

    <div class="flex items-center gap-2 md:justify-end">
      {% if project %}
        <a
          href="/reports/lots/deposit-stats/export?project={{ project }}&min_customers={{ MIN_CUSTOMERS }}&limit={{ MAX_LIMIT }}"
          class="h-10 px-4 rounded-xl border border-slate-300 text-sm font-medium text-slate-700 bg-white hover:bg-slate-50 inline-flex items-center gap-2"
        >
          <i class="ri-file-excel-2-line"></i>
          Export XLSX
        </a>
      {% endif %}
    </div>
  </div>
</form>

{% set rows = (data or {}).get('items') or (data or {}).get('rows') or [] %}
{% set total = (data or {}).get('count') or rows|length %}

<div class="mb-3 text-sm text-slate-600">
  <span class="font-semibold text-slate-900">{{ total }}</span> dòng thống kê lô.
</div>

<div class="bg-white border rounded-2xl shadow-sm overflow-hidden">
  <div class="overflow-x-auto">
    <table class="min-w-full text-sm text-slate-700">
      <thead class="bg-slate-50 text-slate-500 border-b">
        <tr>
          <th class="px-4 py-2 text-left font-semibold">Mã lô</th>
          <th class="px-4 py-2 text-left font-semibold">Mô tả</th>
          <th class="px-4 py-2 text-right font-semibold">Diện tích (m²)</th>
          <th class="px-4 py-2 text-right font-semibold">Giá khởi điểm</th>
          <th class="px-4 py-2 text-right font-semibold">Tiền đặt trước</th>
          <th class="px-4 py-2 text-left font-semibold">Trạng thái</th>
          <th class="px-4 py-2 text-right font-semibold">Số KH đặt</th>
          <th class="px-4 py-2 text-right font-semibold">Tổng tiền đặt</th>
          <th class="px-4 py-2 text-left font-semibold">Lần đầu đặt</th>
          <th class="px-4 py-2 text-left font-semibold">Lần cuối đặt</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-100">
      {% for r in rows %}
        <tr class="hover:bg-slate-50 transition">
          <td class="px-4 py-3 font-semibold text-slate-900 whitespace-nowrap">{{ r.lot_code }}</td>
          <td class="px-4 py-3 text-xs cell-wrap">{{ r.lot_description or '-' }}</td>
          <td class="px-4 py-3 text-right whitespace-nowrap">{{ r.area_m2 or '' }}</td>
          <td class="px-4 py-3 text-right whitespace-nowrap" data-amount="{{ r.starting_price_vnd or 0 }}"></td>
          <td class="px-4 py-3 text-right whitespace-nowrap" data-amount="{{ r.deposit_amount_vnd or 0 }}"></td>
          <td class="px-4 py-3 text-xs text-slate-600 whitespace-nowrap">{{ r.lot_status or '-' }}</td>
          <td class="px-4 py-3 text-right whitespace-nowrap">{{ r.deposit_customer_count or 0 }}</td>
          <td class="px-4 py-3 text-right whitespace-nowrap" data-amount="{{ r.total_deposit_amount_vnd or 0 }}"></td>
          <td class="px-4 py-3 text-xs text-slate-500 whitespace-nowrap">{{ r.first_paid_at or '' }}</td>
          <td class="px-4 py-3 text-xs text-slate-500 whitespace-nowrap">{{ r.last_paid_at or '' }}</td>
        </tr>
      {% endfor %}
      {% if rows|length == 0 %}
        <tr>
          <td colspan="10" class="px-4 py-10 text-center text-slate-400">
            {% if project %}Chưa có dữ liệu.{% else %}Vui lòng chọn dự án.{% endif %}
          </td>
        </tr>
      {% endif %}
      </tbody>
    </table>
  </div>
</div>

<style>
  table th, table td { white-space: nowrap; }
  .cell-wrap { white-space: normal; }
</style>

<script>
(function () {
  const form = document.getElementById('filtersForm');
  const sel = document.getElementById('projectSelectLocal');
  if (sel && form) sel.addEventListener('change', () => form.submit());

  function formatAmountCell(td) {
    const raw = td && td.getAttribute('data-amount');
    if (!raw) return;
    const n = Number(raw);
    if (!Number.isFinite(n)) return;
    td.textContent = n.toLocaleString('vi-VN', { maximumFractionDigits: 0 });
  }
  document.querySelectorAll('[data-amount]').forEach(formatAmountCell);
})();
</script>
{% endblock %}
