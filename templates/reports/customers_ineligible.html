{% extends "base.html" %}
{% block title %}Khách hàng không đủ điều kiện{% endblock %}

{% block content %}
<style>
  :root{
    --bd: rgba(15,23,42,.10);
    --bd2: rgba(15,23,42,.07);
    --card: #fff;
    --muted: rgba(71,85,105,.88);
    --txt: #0f172a;

    --bad:#ef4444;
    --pri:#4f46e5;
    --blue:#3b82f6;

    --r: 16px;
    --shadow: 0 14px 36px rgba(2,6,23,.10);
  }

  .rp-wrap{max-width:1280px;margin:0 auto}
  .rp-head{
    background: linear-gradient(135deg, rgba(79,70,229,.10), rgba(239,68,68,.08));
    border:1px solid var(--bd);
    border-radius: 22px;
    padding: 16px 16px 14px;
    box-shadow: 0 10px 28px rgba(2,6,23,.06);
  }
  .rp-title{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
  .rp-title h1{font-size:20px;font-weight:900;color:var(--txt);display:flex;align-items:center;gap:10px;margin:0}
  .rp-title p{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.35}

  .pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:8px 10px;border-radius:999px;
    background: rgba(255,255,255,.72);
    border:1px solid var(--bd2);
    color: rgba(15,23,42,.70);
    font-size:12px;font-weight:800;
    backdrop-filter: blur(8px);
    white-space:nowrap;
  }
  .dot{width:8px;height:8px;border-radius:999px;background: var(--bad);box-shadow:0 0 0 3px rgba(239,68,68,.14)}

  .rp-controls{
    margin-top: 12px;
    display:flex;flex-wrap:wrap;align-items:center;gap:10px;
  }
  .sel{
    display:flex;align-items:center;gap:10px;
    padding:10px 12px;border-radius: 14px;
    border:1px solid var(--bd);
    background: rgba(255,255,255,.80);
    min-width: 320px;
    flex: 1 1 420px;
  }
  .sel label{font-size:12px;color:rgba(15,23,42,.65);font-weight:900}
  .sel select{
    border:0;outline:0;background:transparent;
    font-weight:950;color:var(--txt);
    width:100%;
  }

  .btn{
    display:inline-flex;align-items:center;gap:8px;
    padding:10px 12px;border-radius: 14px;
    border:1px solid var(--bd);
    background: rgba(255,255,255,.88);
    font-size:12px;font-weight:950;color: rgba(15,23,42,.78);
    transition: .15s ease;
    text-decoration:none;
    cursor:pointer;
    user-select:none;
    white-space:nowrap;
  }
  .btn:hover{transform: translateY(-1px); box-shadow: 0 10px 20px rgba(2,6,23,.10)}
  .btn.primary{
    border-color: rgba(239,68,68,.30);
    background: linear-gradient(180deg, rgba(239,68,68,.14), rgba(239,68,68,.08));
    color: rgba(153,27,27,.95);
  }

  .kpis{
    margin-top: 14px;
    display:grid;
    grid-template-columns: repeat(12, 1fr);
    gap:10px;
  }
  .kpi{
    grid-column: span 3;
    background: rgba(255,255,255,.90);
    border:1px solid var(--bd);
    border-radius: 18px;
    padding: 12px 12px 10px;
    box-shadow: 0 10px 22px rgba(2,6,23,.06);
    min-width:0;
  }
  @media (max-width: 1024px){ .kpi{grid-column: span 6} }
  @media (max-width: 640px){
    .sel{min-width:100%}
    .kpi{grid-column: span 12}
  }
  .kpi .t{font-size:12px;color:rgba(15,23,42,.62);font-weight:900}
  .kpi .v{margin-top:6px;font-size:18px;font-weight:950;color:var(--txt);letter-spacing:.2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .kpi .s{margin-top:6px;font-size:11px;color:rgba(71,85,105,.90);line-height:1.35}
  .kpi.bad .v{color: rgba(153,27,27,.95)}
  .kpi.money .v{color: rgba(30,64,175,.95)}

  .rp-card{
    margin-top: 14px;
    background: var(--card);
    border:1px solid var(--bd);
    border-radius: 22px;
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .rp-card .hd{
    padding: 12px 14px;
    border-bottom:1px solid var(--bd2);
    background: linear-gradient(90deg, rgba(15,23,42,.03), rgba(15,23,42,.00));
    display:flex;align-items:center;justify-content:space-between;gap:12px;
  }
  .badge{
    display:inline-flex;align-items:center;gap:7px;
    padding:6px 10px;border-radius:999px;
    border:1px solid var(--bd2);
    background: rgba(255,255,255,.88);
    font-size:12px;font-weight:950;color:rgba(15,23,42,.74);
  }
  .badge.bad{border-color: rgba(239,68,68,.26); background: rgba(239,68,68,.08); color: rgba(153,27,27,.92)}
  .muted{color: var(--muted);font-size:12px}

  .list-controls{
    padding: 10px 14px;
    border-bottom:1px solid rgba(15,23,42,.06);
    display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;
    background: rgba(255,255,255,.84);
  }
  .lc-left{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .ctl{
    display:flex;align-items:center;gap:8px;
    padding:8px 10px;border-radius:14px;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(15,23,42,.02);
  }
  .ctl label{font-size:12px;font-weight:900;color:rgba(15,23,42,.70)}
  .ctl select, .ctl input{
    border:0;outline:0;background:transparent;
    font-size:12px;font-weight:950;color:rgba(15,23,42,.85);
  }
  .lc-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .mini-kpi{
    font-size:12px;color:rgba(71,85,105,.92);
    padding:8px 10px;border-radius:14px;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(15,23,42,.02);
  }

  /* ===== TABLE (chuẩn thẳng hàng) ===== */
  .tbl-wrap{
    padding: 12px 14px 16px;
    background: rgba(15,23,42,.01);
  }
  .tbl-scroll{
    overflow-x:auto;
    border-radius: 18px;
    border:1px solid rgba(15,23,42,.08);
    background: rgba(255,255,255,.92);
  }
  table.rp-table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    min-width: 980px; /* để desktop luôn thẳng hàng */
  }
  table.rp-table thead th{
    position: sticky;
    top: 0;
    z-index: 2;
    background: rgba(255,255,255,.98);
    font-size:12px;
    font-weight:950;
    color: rgba(15,23,42,.60);
    text-align:left;
    padding: 12px 12px;
    border-bottom:1px solid rgba(15,23,42,.08);
    white-space:nowrap;
  }
  table.rp-table tbody td{
    padding: 14px 12px;
    vertical-align:top;
    border-bottom:1px solid rgba(15,23,42,.06);
    background: rgba(255,255,255,.96);
  }
  table.rp-table tbody tr:hover td{
    background: rgba(15,23,42,.015);
  }

  .cust-name{font-weight:1000;color: rgba(15,23,42,.92);line-height:1.25;word-break:break-word}
  .subline{margin-top:8px;display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .pill2{
    display:inline-flex;align-items:center;gap:8px;
    padding:6px 10px;border-radius:999px;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(255,255,255,.92);
    font-size:12px;font-weight:950;color: rgba(15,23,42,.78);
    user-select:none;
    cursor:pointer;
    white-space:nowrap;
  }
  .pill2:hover{box-shadow:0 10px 18px rgba(2,6,23,.08); transform: translateY(-1px)}
  .pill2.gray{cursor:default;opacity:.8}
  .pill2.gray:hover{box-shadow:none;transform:none}
  .pill2.bad{border-color: rgba(239,68,68,.22); background: rgba(239,68,68,.06); color: rgba(153,27,27,.92)}
  .pill2.money{border-color: rgba(59,130,246,.22); background: rgba(59,130,246,.08); color: rgba(30,64,175,.92)}
  .pill2.warn{border-color: rgba(245,158,11,.22); background: rgba(245,158,11,.10); color: rgba(124,45,18,.92)}
  .mini{font-size:12px;color: rgba(71,85,105,.92);line-height:1.35}
  .mono{font-variant-numeric: tabular-nums; font-feature-settings: "tnum";}

  .empty{
    margin-top:10px;
    padding: 14px 12px;
    border:1px dashed rgba(15,23,42,.14);
    border-radius: 16px;
    background: rgba(255,255,255,.90);
    color: rgba(71,85,105,.90);
    font-size:13px;
  }

  /* Mobile: cho cuộn ngang table, không phá layout */
  @media (max-width: 980px){
    table.rp-table{min-width: 900px;}
  }
</style>

{% set is_v2 = (is_v2 if is_v2 is defined else false) %}
{% set items = (data.get('items') if data and data.get('items') is not none else []) %}
{% set project_id_val = (project_id if project_id is defined else None) %}

{% set ns = namespace(sum_money=0, sum_lots=0, cnt_phone=0, cnt_cccd=0) %}
{% for r in items %}
  {% set amt = r.get("total_deposit_amount_project") %}
  {% set lots = r.get("ineligible_lot_count") %}
  {% set ns.sum_money = ns.sum_money + (amt or 0) %}
  {% set ns.sum_lots = ns.sum_lots + (lots or 0) %}
  {% if r.get("phone") %}{% set ns.cnt_phone = ns.cnt_phone + 1 %}{% endif %}
  {% if r.get("cccd") %}{% set ns.cnt_cccd = ns.cnt_cccd + 1 %}{% endif %}
{% endfor %}

<div class="rp-wrap">
  <div class="rp-head">
    <div class="rp-title">
      <div>
        <h1>
          <i class="ri-shield-cross-line" style="color: var(--bad);font-size:24px"></i>
          Khách hàng không đủ điều kiện
        </h1>
        <p>
          Bạn có thể tìm nhanh theo <b>tên</b>, <b>CCCD</b> hoặc <b>SĐT</b>. Chạm để copy thông tin liên hệ.
        </p>
      </div>
      <div class="pill">
        <span class="dot"></span>
        Danh sách liên hệ
      </div>
    </div>

    <div class="rp-controls">
      {% if is_v2 %}
        <form id="projFormV2" method="get" action="{{ request.url.path }}" style="flex:1 1 auto">
          <div class="sel">
            <label>Dự án</label>
            <select id="projectSelectV2">
              <option value="">— Chọn dự án —</option>
              {% for p in (projects or []) %}
                {% set pid = p.get("id") or p.get("project_id") %}
                {% set code = (p.get("project_code") or p.get("code") or "")|upper %}
                <option value="{{ pid }}" {% if pid == project_id_val %}selected{% endif %}>
                  {{ code }} — {{ (p.get("name") or "") }}
                </option>
              {% endfor %}
            </select>
          </div>
        </form>

        {% if project_id_val %}
          <a class="btn primary" href="/reports/v2/projects/{{ project_id_val }}/customers/ineligible/export?limit={{ limit or 10000 }}&expose_phone=1">
            <i class="ri-download-2-line"></i> Tải danh sách (Excel)
          </a>
        {% endif %}
      {% endif %}

      <a class="btn" href="/reports">
        <i class="ri-arrow-left-line"></i> Quay lại
      </a>
    </div>

    <div class="kpis">
      <div class="kpi bad">
        <div class="t">Số khách trong danh sách</div>
        <div class="v"><span class="mono">{{ items|length }}</span></div>
        <div class="s">Thống kê theo dự án đang chọn.</div>
      </div>

      <div class="kpi money">
        <div class="t">Tổng tiền đã nộp</div>
        <div class="v mono"><span data-money="{{ ns.sum_money }}">{{ ns.sum_money }}</span></div>
        <div class="s">Tổng tiền của nhóm khách trong danh sách.</div>
      </div>

      <div class="kpi">
        <div class="t">Tổng số lô liên quan</div>
        <div class="v"><span class="mono">{{ ns.sum_lots }}</span></div>
        <div class="s">Cộng dồn theo từng khách.</div>
      </div>

      <div class="kpi">
        <div class="t">Có SĐT / CCCD</div>
        <div class="v"><span class="mono">{{ ns.cnt_phone }}</span> / <span class="mono">{{ ns.cnt_cccd }}</span></div>
        <div class="s">Hỗ trợ copy nhanh để liên hệ.</div>
      </div>
    </div>
  </div>

  <div class="rp-card">
    <div class="hd">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <span class="badge bad"><i class="ri-contacts-line"></i> Danh sách khách</span>
        <span class="muted">Tìm kiếm & sắp xếp ngay trên trang.</span>
      </div>
    </div>

    {% if items|length == 0 %}
      <div style="padding:18px 14px;color:rgba(71,85,105,.88);font-size:13px">
        Chưa có dữ liệu. Vui lòng chọn dự án để xem danh sách.
      </div>
    {% else %}

      <div class="list-controls">
        <div class="lc-left">
          <div class="ctl">
            <label>Sắp xếp</label>
            <select id="sortKey">
              <option value="default">Mặc định</option>
              <option value="money_desc">Tiền đã nộp (cao → thấp)</option>
              <option value="lots_desc">Số lô liên quan (nhiều → ít)</option>
              <option value="name_asc">Tên (A → Z)</option>
            </select>
          </div>

          <div class="ctl">
            <label>Tìm</label>
            <input id="q" type="text" placeholder="Tên / CCCD / SĐT" style="width:240px"/>
          </div>

          <button class="btn" type="button" id="resetBtn">
            <i class="ri-refresh-line"></i> Reset
          </button>
        </div>

        <div class="lc-right">
          <div class="mini-kpi" id="shownKpi">—</div>
        </div>
      </div>

      <div class="tbl-wrap">
        <div class="tbl-scroll">
          <table class="rp-table">
            <thead>
              <tr>
                <th style="width:34%">Khách hàng</th>
                <th style="width:26%">Liên hệ</th>
                <th style="width:16%">Tổng tiền đã nộp</th>
                <th style="width:12%">Số lô liên quan</th>
                <th style="width:12%">Ghi chú</th>
              </tr>
            </thead>

            <tbody id="list">
              {% for r in items %}
                {% set name = r.get("customer_full_name") or r.get("full_name") or "" %}
                {% set cccd = r.get("cccd") or "" %}
                {% set phone = r.get("phone") or "" %}
                {% set email = r.get("email") or "" %}
                {% set money = r.get("total_deposit_amount_project") or 0 %}
                {% set lots = r.get("ineligible_lot_count") or 0 %}

                <tr class="rp-row"
                    data-idx="{{ loop.index0 }}"
                    data-name="{{ (name or '')|lower }}"
                    data-cccd="{{ (cccd or '') }}"
                    data-phone="{{ (phone or '') }}"
                    data-money-sort="{{ money or 0 }}"
                    data-lots-sort="{{ lots or 0 }}">

                  <td>
                    <div class="cust-name">{{ name }}</div>
                    <div class="subline">
                      {% if cccd %}
                        <span class="pill2 mono" title="Copy CCCD" onclick="copyText('{{ cccd }}')">
                          <i class="ri-id-card-line"></i> {{ cccd }} <span style="opacity:.6">• Copy</span>
                        </span>
                      {% else %}
                        <span class="pill2 gray"><i class="ri-id-card-line"></i> CCCD —</span>
                      {% endif %}
                    </div>
                  </td>

                  <td>
                    <div class="subline" style="margin-top:0">
                      {% if phone %}
                        <span class="pill2 mono bad" title="Copy SĐT" onclick="copyText('{{ phone }}')">
                          <i class="ri-phone-line"></i> {{ phone }} <span style="opacity:.6">• Copy</span>
                        </span>
                      {% else %}
                        <span class="pill2 gray"><i class="ri-phone-line"></i> SĐT —</span>
                      {% endif %}

                      {% if email %}
                        <span class="pill2 mono" title="Copy email" onclick="copyText('{{ email }}')">
                          <i class="ri-mail-line"></i> {{ email }}
                        </span>
                      {% endif %}
                    </div>
                    <div class="mini" style="margin-top:6px">Ưu tiên liên hệ theo SĐT.</div>
                  </td>

                  <td>
                    <span class="pill2 money">
                      <i class="ri-coins-line"></i>
                      <span class="mono" data-money="{{ money }}">{{ money }}</span>
                    </span>
                    <div class="mini" style="margin-top:6px">Tổng tiền khách đã nộp trong dự án.</div>
                  </td>

                  <td>
                    <span class="pill2 warn">
                      <i class="ri-stack-line"></i>
                      <span class="mono">{{ lots }}</span> lô
                    </span>
                    <div class="mini" style="margin-top:6px">Số lô có hồ sơ của khách trong dự án.</div>
                  </td>

                  <td>
                    <div class="mini">
                      Có thể liên hệ để hướng dẫn bổ sung hoặc xác nhận thông tin.
                    </div>
                  </td>

                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="empty" id="emptyBox" style="display:none">
          Không có kết quả phù hợp. Vui lòng thử lại hoặc bấm <b>Reset</b>.
        </div>
      </div>
    {% endif %}
  </div>
</div>

<script>
  function fmtMoney(n){
    try{ return Number(n || 0).toLocaleString('vi-VN'); }
    catch(e){ return String(n || 0); }
  }
  function applyMoneyFormat(root){
    const nodes = (root || document).querySelectorAll('span[data-money]');
    nodes.forEach(el => el.textContent = fmtMoney(el.getAttribute('data-money')));
  }

  function copyText(s){
    try{ navigator.clipboard.writeText(String(s||"")); }catch(e){}
  }
  applyMoneyFormat(document);

  // V2 project redirect
  (function(){
    const sel = document.getElementById('projectSelectV2');
    if(!sel) return;
    sel.addEventListener('change', () => {
      const pid = sel.value;
      if(!pid){ window.location.href = '/reports'; return; }
      const limit = {{ (limit or 10000) }};
      window.location.href = `/reports/v2/projects/${pid}/customers/ineligible?limit=${limit}&expose_phone=1`;
    });
  })();

  const list = document.getElementById('list');
  const emptyBox = document.getElementById('emptyBox');
  const rows = list ? Array.from(list.querySelectorAll('tr.rp-row')) : [];

  function setShownKpi(shown, total){
    const el = document.getElementById('shownKpi');
    if(!el) return;
    el.innerHTML = `<b class="mono">${shown}</b> / <span class="mono">${total}</span> khách đang hiển thị`;
  }

  function applyView(){
    if(!list) return;

    const sortKey = document.getElementById('sortKey')?.value || 'default';
    const q = (document.getElementById('q')?.value || '').trim().toLowerCase();

    let visible = [];
    for(const tr of rows){
      const name = (tr.getAttribute('data-name') || '');
      const cccd = (tr.getAttribute('data-cccd') || '');
      const phone = (tr.getAttribute('data-phone') || '');
      const ok = (!q) || name.includes(q) || cccd.includes(q) || phone.includes(q);
      tr.style.display = ok ? '' : 'none';
      if(ok) visible.push(tr);
    }

    if(sortKey === 'default'){
      visible.sort((a,b) => Number(a.getAttribute('data-idx')) - Number(b.getAttribute('data-idx')));
    } else if(sortKey === 'money_desc'){
      visible.sort((a,b) =>
        (Number(b.getAttribute('data-money-sort')) - Number(a.getAttribute('data-money-sort')))
        || (Number(a.getAttribute('data-idx')) - Number(b.getAttribute('data-idx')))
      );
    } else if(sortKey === 'lots_desc'){
      visible.sort((a,b) =>
        (Number(b.getAttribute('data-lots-sort')) - Number(a.getAttribute('data-lots-sort')))
        || (Number(a.getAttribute('data-idx')) - Number(b.getAttribute('data-idx')))
      );
    } else if(sortKey === 'name_asc'){
      visible.sort((a,b) =>
        String(a.getAttribute('data-name')||'').localeCompare(String(b.getAttribute('data-name')||''), 'vi')
        || (Number(a.getAttribute('data-idx')) - Number(b.getAttribute('data-idx')))
      );
    }

    // reorder DOM
    for(const tr of visible){ list.appendChild(tr); }

    setShownKpi(visible.length, rows.length);
    if(emptyBox) emptyBox.style.display = (visible.length === 0) ? '' : 'none';
  }

  (function initControls(){
    if(!list) return;
    const sortKey = document.getElementById('sortKey');
    const q = document.getElementById('q');
    const resetBtn = document.getElementById('resetBtn');

    sortKey?.addEventListener('change', applyView);
    q?.addEventListener('input', () => {
      clearTimeout(window.__rpq);
      window.__rpq = setTimeout(applyView, 60);
    });

    resetBtn?.addEventListener('click', () => {
      if(sortKey) sortKey.value = 'default';
      if(q) q.value = '';
      applyView();
    });

    applyView();
  })();
</script>
{% endblock %}
