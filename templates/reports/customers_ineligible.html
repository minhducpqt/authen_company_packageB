{% extends "base.html" %}
{% block title %}Khách hàng không đủ điều kiện{% endblock %}

{% block content %}
<style>
  :root{
    --bd: rgba(15,23,42,.10);
    --bd2: rgba(15,23,42,.07);
    --card: #fff;
    --muted: rgba(71,85,105,.88);
    --txt: #0f172a;

    --ok: #16a34a;
    --ok2:#22c55e;
    --warn:#f59e0b;
    --bad:#ef4444;
    --pri:#4f46e5;

    --r: 16px;
    --shadow: 0 14px 36px rgba(2,6,23,.10);
  }

  .rp-wrap{max-width:1280px;margin:0 auto}
  .rp-head{
    background: linear-gradient(135deg, rgba(79,70,229,.10), rgba(239,68,68,.08));
    border:1px solid var(--bd);
    border-radius: 22px;
    padding: 16px 16px 14px;
    box-shadow: 0 10px 28px rgba(2,6,23,.06);
  }
  .rp-title{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
  .rp-title h1{font-size:20px;font-weight:900;color:var(--txt);display:flex;align-items:center;gap:10px;margin:0}
  .rp-title p{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.35}
  .pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:8px 10px;border-radius:999px;
    background: rgba(255,255,255,.72);
    border:1px solid var(--bd2);
    color: rgba(15,23,42,.70);
    font-size:12px;font-weight:900;
    backdrop-filter: blur(8px);
    white-space:nowrap;
  }
  .dot{width:8px;height:8px;border-radius:999px;background: var(--bad);box-shadow:0 0 0 3px rgba(239,68,68,.14)}

  .rp-controls{
    margin-top: 12px;
    display:flex;flex-wrap:wrap;align-items:center;gap:10px;
  }
  .sel{
    display:flex;align-items:center;gap:10px;
    padding:10px 12px;border-radius: 14px;
    border:1px solid var(--bd);
    background: rgba(255,255,255,.80);
    min-width: 280px;
  }
  .sel label{font-size:12px;color:rgba(15,23,42,.65);font-weight:900}
  .sel select{
    border:0;outline:0;background:transparent;
    font-weight:900;color:var(--txt);
    width:100%;
  }

  .btn{
    display:inline-flex;align-items:center;gap:8px;
    padding:10px 12px;border-radius: 14px;
    border:1px solid var(--bd);
    background: rgba(255,255,255,.85);
    font-size:12px;font-weight:900;color: rgba(15,23,42,.75);
    transition: .15s ease;
    text-decoration:none;
    cursor:pointer;
  }
  .btn:hover{transform: translateY(-1px); box-shadow: 0 10px 20px rgba(2,6,23,.10)}
  .btn.primary{
    border-color: rgba(239,68,68,.30);
    background: linear-gradient(180deg, rgba(239,68,68,.14), rgba(239,68,68,.08));
    color: rgba(153,27,27,.95);
  }

  .kpis{
    margin-top: 14px;
    display:grid;
    grid-template-columns: repeat(12, 1fr);
    gap:10px;
  }
  .kpi{
    grid-column: span 3;
    background: rgba(255,255,255,.88);
    border:1px solid var(--bd);
    border-radius: 18px;
    padding: 12px 12px 10px;
    box-shadow: 0 10px 22px rgba(2,6,23,.06);
    min-width:0;
  }
  @media (max-width: 1024px){ .kpi{grid-column: span 6} }
  @media (max-width: 640px){
    .sel{min-width: 100%}
    .kpi{grid-column: span 12}
  }
  .kpi .t{font-size:12px;color:rgba(15,23,42,.62);font-weight:900}
  .kpi .v{
    margin-top:6px;font-size:18px;font-weight:950;color:var(--txt);letter-spacing:.2px;
    overflow:hidden;text-overflow:ellipsis;white-space:nowrap
  }
  .kpi .s{margin-top:6px;font-size:11px;color:rgba(71,85,105,.90);line-height:1.35}
  .kpi.bad .v{color: rgba(153,27,27,.95)}
  .kpi.money .v{color: rgba(30,64,175,.95)}
  .kpi.warn .v{color: rgba(124,45,18,.95)}

  .rp-card{
    margin-top: 14px;
    background: var(--card);
    border:1px solid var(--bd);
    border-radius: 22px;
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .rp-card .hd{
    padding: 12px 14px;
    border-bottom:1px solid var(--bd2);
    background: linear-gradient(90deg, rgba(15,23,42,.03), rgba(15,23,42,.00));
    display:flex;align-items:center;justify-content:space-between;gap:12px;
  }
  .badge{
    display:inline-flex;align-items:center;gap:7px;
    padding:6px 10px;border-radius:999px;
    border:1px solid var(--bd2);
    background: rgba(255,255,255,.85);
    font-size:12px;font-weight:900;color:rgba(15,23,42,.72);
  }
  .badge.bad{border-color: rgba(239,68,68,.26); background: rgba(239,68,68,.08); color: rgba(153,27,27,.92)}
  .muted{color: var(--muted);font-size:12px}

  /* Summary row */
  .sumbar{
    padding: 12px 14px;
    border-bottom:1px solid rgba(15,23,42,.06);
    background: rgba(255,255,255,.92);
    display:grid;
    grid-template-columns: repeat(12, 1fr);
    gap:10px;
  }
  .sumcard{
    grid-column: span 4;
    border:1px solid rgba(15,23,42,.10);
    border-radius: 18px;
    background: linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,255,255,.92));
    box-shadow: 0 10px 18px rgba(2,6,23,.06);
    padding: 12px 12px 10px;
    min-width: 0;
  }
  @media (max-width: 1024px){ .sumcard{grid-column: span 6} }
  @media (max-width: 640px){ .sumcard{grid-column: span 12} }
  .sumtop{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .sumlbl{font-size:12px;font-weight:950;color: rgba(15,23,42,.62)}
  .sumico{
    width:34px;height:34px;border-radius:14px;
    display:flex;align-items:center;justify-content:center;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(15,23,42,.03);
  }
  .sumval{
    margin-top:8px;
    font-size:20px;
    font-weight:1000;
    letter-spacing:.2px;
    color: rgba(15,23,42,.92);
    font-variant-numeric: tabular-nums; font-feature-settings: "tnum";
    overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
  }
  .sumsub{margin-top:6px;font-size:12px;color: rgba(71,85,105,.90);line-height:1.35}
  .sumcard.bad .sumval{color: rgba(153,27,27,.95)}
  .sumcard.money .sumval{color: rgba(30,64,175,.95)}
  .mono{font-variant-numeric: tabular-nums; font-feature-settings: "tnum";}

  /* Controls */
  .list-controls{
    padding: 10px 14px;
    border-bottom:1px solid rgba(15,23,42,.06);
    display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;
    background: rgba(255,255,255,.82);
  }
  .lc-left{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .ctl{
    display:flex;align-items:center;gap:8px;
    padding:8px 10px;border-radius:14px;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(15,23,42,.02);
  }
  .ctl label{font-size:12px;font-weight:900;color:rgba(15,23,42,.70)}
  .ctl select, .ctl input{
    border:0;outline:0;background:transparent;
    font-size:12px;font-weight:950;color:rgba(15,23,42,.85);
  }
  .lc-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .mini-kpi{
    font-size:12px;color:rgba(71,85,105,.92);
    padding:8px 10px;border-radius:14px;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(15,23,42,.02);
  }

  /* Table */
  .tbl-wrap{overflow:auto}
  .tbl{
    width:100%;
    min-width: 1180px;
    border-collapse:separate;border-spacing:0;
    table-layout: fixed;
  }
  .tbl th, .tbl td{
    padding: 12px 12px;
    border-bottom:1px solid rgba(15,23,42,.06);
    vertical-align:top;
  }
  .tbl th{
    background: #fff;
    font-size:12px;
    color: rgba(15,23,42,.58);
    font-weight:950;
    letter-spacing:.2px;
    position: sticky;
    top: 0;
    z-index: 2;
  }

  .row{transition: .12s ease;background:#fff}
  .row:hover{background: rgba(15,23,42,.02)}

  .cust-name{
    font-weight:1000;color: rgba(15,23,42,.90);
    line-height:1.25;
    word-break:break-word;
  }
  .subline{margin-top:6px;display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .pill2{
    display:inline-flex;align-items:center;gap:8px;
    padding:6px 10px;border-radius:999px;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(255,255,255,.90);
    font-size:12px;font-weight:950;color: rgba(15,23,42,.78);
    user-select:none;
    cursor:pointer;
  }
  .pill2:hover{box-shadow:0 10px 18px rgba(2,6,23,.08); transform: translateY(-1px)}
  .pill2.gray{cursor:default}
  .pill2.gray:hover{box-shadow:none; transform:none}
  .pill2.bad{border-color: rgba(239,68,68,.22); background: rgba(239,68,68,.06); color: rgba(153,27,27,.92)}
  .pill2.money{border-color: rgba(59,130,246,.22); background: rgba(59,130,246,.08); color: rgba(30,64,175,.92)}
  .pill2.warn{border-color: rgba(245,158,11,.22); background: rgba(245,158,11,.10); color: rgba(124,45,18,.92)}

  .mini{font-size:12px;color: rgba(71,85,105,.92);line-height:1.28}
  .empty-row td{
    padding:18px 14px;
    color:rgba(71,85,105,.88);
    font-size:13px;
    background: rgba(15,23,42,.01);
  }

  /* =========================================================
     ✅ SUPER HARD FIX: Reset table + colgroup/col
     ========================================================= */
  #tbl, #tbl *{ box-sizing:border-box !important; }

  #tbl{
    display: table !important;
    width: 100% !important;
    table-layout: fixed !important;
    border-collapse: separate !important;
    border-spacing: 0 !important;
    float: none !important;
    transform: none !important;
  }
  #tbl colgroup{ display: table-column-group !important; }
  #tbl col{ display: table-column !important; }

  #tbl thead{ display: table-header-group !important; float:none !important; }
  #tbl tbody{ display: table-row-group !important; float:none !important; }
  #tbl tr{ display: table-row !important; float:none !important; width:auto !important; }

  #tbl th, #tbl td{
    display: table-cell !important;
    float: none !important;
    width: auto !important;
    position: static !important;
    clear: none !important;
    vertical-align: top !important;
  }

  #tbl th::before, #tbl td::before,
  #tbl th::after,  #tbl td::after{
    content: none !important;
  }
</style>

{% set is_v2 = (is_v2 if is_v2 is defined else true) %}
{% set items = (data.get('items') if data and data.get('items') is not none else []) %}
{% set project_id_val = (project_id if project_id is defined else None) %}
{% set limit_val = (limit or 10000) %}

{# ========= Summary ========= #}
{% set ns = namespace(sum_money=0, sum_lots=0, cnt_phone=0, cnt_cccd=0) %}
{% for r in items %}
  {% set amt = r.get("total_deposit_amount_project") or 0 %}
  {% set lots = r.get("ineligible_lot_count") or 0 %}
  {% set cust = r.get("customer") or {} %}
  {% set phone0 = r.get("phone") or r.get("customer_phone") or cust.get("phone") or r.get("phone_masked") %}
  {% set cccd0 = r.get("cccd") or r.get("customer_cccd") or cust.get("cccd") or r.get("cccd_masked") %}
  {% set ns.sum_money = ns.sum_money + (amt or 0) %}
  {% set ns.sum_lots = ns.sum_lots + (lots or 0) %}
  {% if phone0 %}{% set ns.cnt_phone = ns.cnt_phone + 1 %}{% endif %}
  {% if cccd0 %}{% set ns.cnt_cccd = ns.cnt_cccd + 1 %}{% endif %}
{% endfor %}

<div class="rp-wrap">
  <div class="rp-head">
    <div class="rp-title">
      <div>
        <h1>
          <i class="ri-shield-cross-line" style="color: var(--bad);font-size:24px"></i>
          Khách hàng không đủ điều kiện
        </h1>
        <p>
          Danh sách khách đã tham gia đặt cọc nhưng chưa đủ điều kiện. Bạn có thể tìm nhanh theo <b>tên</b>, <b>CCCD</b> hoặc <b>SĐT</b> và copy 1 chạm để liên hệ.
        </p>
      </div>
      <div class="pill">
        <span class="dot"></span>
        Danh sách liên hệ
      </div>
    </div>

    <div class="rp-controls">
      <form id="projFormV2" method="get" action="{{ request.url.path }}">
        <div class="sel">
          <label>Dự án</label>
          <select id="projectSelectV2">
            <option value="">— Chọn dự án —</option>
            {% for p in (projects or []) %}
              {% set pid = p.get("id") or p.get("project_id") %}
              {% set code = (p.get("project_code") or p.get("code") or "")|upper %}
              <option value="{{ pid }}" {% if pid == project_id_val %}selected{% endif %}>
                {{ code }} — {{ (p.get("name") or "") }}
              </option>
            {% endfor %}
          </select>
        </div>
      </form>

      {% if project_id_val %}
        <a class="btn primary" href="/reports/v2/projects/{{ project_id_val }}/customers/ineligible/export?limit={{ limit_val }}&expose_phone=1">
          <i class="ri-download-2-line"></i> Tải danh sách (Excel)
        </a>
      {% endif %}

      <a class="btn" href="/reports">
        <i class="ri-arrow-left-line"></i> Quay lại
      </a>
    </div>

    <div class="kpis">
      <div class="kpi bad">
        <div class="t">Số khách trong danh sách</div>
        <div class="v"><span class="mono">{{ items|length }}</span></div>
        <div class="s">Tổng số khách được thống kê theo dự án.</div>
      </div>

      <div class="kpi money">
        <div class="t">Tổng tiền đã nộp</div>
        <div class="v mono" data-money="{{ ns.sum_money }}">{{ ns.sum_money }}</div>
        <div class="s">Tổng tiền khách đã nộp trong dự án.</div>
      </div>

      <div class="kpi warn">
        <div class="t">Tổng số lô liên quan</div>
        <div class="v"><span class="mono">{{ ns.sum_lots }}</span></div>
        <div class="s">Cộng dồn theo từng khách.</div>
      </div>

      <div class="kpi">
        <div class="t">Có SĐT / CCCD</div>
        <div class="v"><span class="mono">{{ ns.cnt_phone }}</span> / <span class="mono">{{ ns.cnt_cccd }}</span></div>
        <div class="s">Hỗ trợ copy nhanh để liên hệ.</div>
      </div>
    </div>
  </div>

  <div class="rp-card">
    <div class="hd">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <span class="badge bad"><i class="ri-contacts-line"></i> Danh sách khách</span>
        <span class="muted">Tìm kiếm và sắp xếp ngay trên trang.</span>
      </div>
    </div>

    {% if items|length == 0 %}
      <div style="padding:18px 14px;color:rgba(71,85,105,.88);font-size:13px">
        Chưa có dữ liệu. Hãy chọn dự án để xem danh sách.
      </div>
    {% else %}

      <div class="sumbar">
        <div class="sumcard bad">
          <div class="sumtop">
            <div class="sumlbl">Số khách</div>
            <div class="sumico" style="border-color:rgba(239,68,68,.22);background:rgba(239,68,68,.08);color:rgba(153,27,27,.92)">
              <i class="ri-user-unfollow-line"></i>
            </div>
          </div>
          <div class="sumval"><span class="mono">{{ items|length }}</span></div>
          <div class="sumsub">Dùng để liên hệ hỗ trợ/nhắc bổ sung.</div>
        </div>

        <div class="sumcard money">
          <div class="sumtop">
            <div class="sumlbl">Tổng tiền đã nộp</div>
            <div class="sumico" style="border-color:rgba(59,130,246,.22);background:rgba(59,130,246,.10);color:rgba(30,64,175,.92)">
              <i class="ri-coins-line"></i>
            </div>
          </div>
          <div class="sumval mono" data-money="{{ ns.sum_money }}">{{ ns.sum_money }}</div>
          <div class="sumsub">Tổng tiền của nhóm khách trong danh sách.</div>
        </div>

        <div class="sumcard">
          <div class="sumtop">
            <div class="sumlbl">Tổng số lô liên quan</div>
            <div class="sumico" style="border-color:rgba(245,158,11,.22);background:rgba(245,158,11,.10);color:rgba(124,45,18,.92)">
              <i class="ri-stack-line"></i>
            </div>
          </div>
          <div class="sumval"><span class="mono">{{ ns.sum_lots }}</span></div>
          <div class="sumsub">Giúp rà soát theo mức độ ảnh hưởng.</div>
        </div>
      </div>

      <div class="list-controls">
        <div class="lc-left">
          <div class="ctl">
            <label>Sắp xếp</label>
            <select id="sortKey">
              <option value="default">Mặc định</option>
              <option value="money_desc">Tiền nộp (cao → thấp)</option>
              <option value="lots_desc">Số lô liên quan (nhiều → ít)</option>
              <option value="name_asc">Tên (A → Z)</option>
            </select>
          </div>

          <div class="ctl">
            <label>Tìm</label>
            <input id="q" type="text" placeholder="Tên / CCCD / SĐT" style="width:220px"/>
          </div>

          <button class="btn" type="button" id="resetBtn">
            <i class="ri-refresh-line"></i> Reset
          </button>
        </div>

        <div class="lc-right">
          <div class="mini-kpi" id="shownKpi">—</div>
        </div>
      </div>

      <div class="tbl-wrap">
        <table class="tbl" id="tbl">
          <colgroup>
            <col style="width:28%">
            <col style="width:22%">
            <col style="width:18%">
            <col style="width:18%">
            <col style="width:14%">
          </colgroup>
          <thead>
            <tr>
              <th>Khách hàng</th>
              <th>Liên hệ</th>
              <th>Tổng tiền đã nộp</th>
              <th>Số lô liên quan</th>
              <th>Ghi chú</th>
            </tr>
          </thead>
          <tbody id="tbody">
            {% for r in items %}
              {% set cust = r.get("customer") or {} %}
              {% set name = r.get("customer_full_name") or r.get("full_name") or cust.get("full_name") or "" %}
              {% set cccd = r.get("cccd") or r.get("customer_cccd") or cust.get("cccd") or r.get("cccd_masked") or "" %}
              {% set phone = r.get("phone") or r.get("customer_phone") or cust.get("phone") or r.get("phone_masked") or "" %}
              {% set email = r.get("email") or r.get("customer_email") or cust.get("email") or r.get("email_masked") or "" %}
              {% set money = r.get("total_deposit_amount_project") or 0 %}
              {% set lots = r.get("ineligible_lot_count") or 0 %}

              <tr class="row"
                  data-idx="{{ loop.index0 }}"
                  data-name="{{ (name or '')|lower }}"
                  data-cccd="{{ (cccd or '') }}"
                  data-phone="{{ (phone or '') }}"
                  data-money="{{ money or 0 }}"
                  data-lots="{{ lots or 0 }}">
                <td>
                  <div class="cust-name">{{ name }}</div>
                  <div class="subline">
                    {% if cccd %}
                      <span class="pill2 mono" title="Bấm để copy CCCD" onclick="copyText('{{ cccd }}')">
                        <i class="ri-id-card-line"></i> {{ cccd }} <span style="opacity:.6">• Copy</span>
                      </span>
                    {% else %}
                      <span class="pill2 gray"><i class="ri-id-card-line"></i> CCCD —</span>
                    {% endif %}
                  </div>
                </td>

                <td>
                  <div class="subline">
                    {% if phone %}
                      <span class="pill2 mono bad" title="Bấm để copy SĐT" onclick="copyText('{{ phone }}')">
                        <i class="ri-phone-line"></i> {{ phone }} <span style="opacity:.6">• Copy</span>
                      </span>
                    {% else %}
                      <span class="pill2 gray"><i class="ri-phone-line"></i> SĐT —</span>
                    {% endif %}

                    {% if email %}
                      <span class="pill2 mono" title="Bấm để copy email" onclick="copyText('{{ email }}')">
                        <i class="ri-mail-line"></i> {{ email }}
                      </span>
                    {% endif %}
                  </div>
                  <div class="mini" style="margin-top:6px">
                    Ưu tiên liên hệ theo SĐT.
                  </div>
                </td>

                <td>
                  <div class="pill2 money">
                    <i class="ri-coins-line"></i>
                    <span class="mono" data-money="{{ money }}">{{ money }}</span>
                  </div>
                  <div class="mini" style="margin-top:6px">
                    Tổng tiền đã nộp trong dự án.
                  </div>
                </td>

                <td>
                  <div class="pill2 warn">
                    <i class="ri-stack-line"></i>
                    <span class="mono">{{ lots }}</span> lô
                  </div>
                  <div class="mini" style="margin-top:6px">
                    Số lô liên quan đến khách này.
                  </div>
                </td>

                <td>
                  <div class="mini">
                    Nếu cần hỗ trợ chi tiết, vui lòng liên hệ bộ phận phụ trách.
                  </div>
                </td>
              </tr>
            {% endfor %}

            <tr class="empty-row" id="emptyRow" style="display:none">
              <td colspan="5">
                Không có kết quả phù hợp. Vui lòng thử lại hoặc bấm <b>Reset</b>.
              </td>
            </tr>
          </tbody>
        </table>
      </div>

    {% endif %}
  </div>
</div>

<script>
  function fmtMoney(n){
    try{ return Number(n || 0).toLocaleString('vi-VN'); }
    catch(e){ return String(n || 0); }
  }
  function applyMoneyFormat(root){
    const nodes = (root || document).querySelectorAll('[data-money]');
    nodes.forEach(el => el.textContent = fmtMoney(el.getAttribute('data-money')));
  }
  function copyText(s){
    const text = String(s || '');
    try{
      navigator.clipboard.writeText(text);
      toastCopy(text);
    }catch(e){}
  }
  function toastCopy(text){
    // toast nhẹ, không kỹ thuật
    try{
      let t = document.getElementById('__copyToast');
      if(!t){
        t = document.createElement('div');
        t.id = '__copyToast';
        t.style.position = 'fixed';
        t.style.left = '50%';
        t.style.bottom = '22px';
        t.style.transform = 'translateX(-50%)';
        t.style.zIndex = '99999';
        t.style.padding = '10px 12px';
        t.style.borderRadius = '14px';
        t.style.border = '1px solid rgba(15,23,42,.10)';
        t.style.background = 'rgba(255,255,255,.92)';
        t.style.boxShadow = '0 14px 30px rgba(2,6,23,.14)';
        t.style.backdropFilter = 'blur(10px)';
        t.style.fontSize = '12px';
        t.style.fontWeight = '900';
        t.style.color = 'rgba(15,23,42,.80)';
        document.body.appendChild(t);
      }
      t.textContent = 'Đã copy';
      t.style.opacity = '1';
      clearTimeout(window.__ctt);
      window.__ctt = setTimeout(()=>{ t.style.opacity='0'; }, 900);
    }catch(e){}
  }

  applyMoneyFormat(document);

  // Project redirect (V2)
  (function(){
    const sel = document.getElementById('projectSelectV2');
    if(!sel) return;
    sel.addEventListener('change', () => {
      const pid = sel.value;
      if(!pid){ window.location.href = '/reports'; return; }
      const limit = {{ limit_val }};
      window.location.href = `/reports/v2/projects/${pid}/customers/ineligible?limit=${limit}&expose_phone=1`;
    });
  })();

  // Local filter/sort
  const tbody = document.getElementById('tbody');
  const emptyRow = document.getElementById('emptyRow');
  const rows = tbody ? Array.from(tbody.querySelectorAll('tr.row')) : [];

  function setShownKpi(shown, total){
    const el = document.getElementById('shownKpi');
    if(!el) return;
    el.innerHTML = `<b class="mono">${shown}</b> / <span class="mono">${total}</span> khách đang hiển thị`;
  }

  function applyView(){
    if(!tbody) return;

    const sortKey = document.getElementById('sortKey')?.value || 'default';
    const q = (document.getElementById('q')?.value || '').trim().toLowerCase();

    let visible = [];
    for(const tr of rows){
      const name = (tr.getAttribute('data-name') || '');
      const cccd = (tr.getAttribute('data-cccd') || '');
      const phone = (tr.getAttribute('data-phone') || '');
      const ok = (!q) || name.includes(q) || cccd.includes(q) || phone.includes(q);
      tr.style.display = ok ? '' : 'none';
      if(ok) visible.push(tr);
    }

    if(sortKey === 'default'){
      visible.sort((a,b) => Number(a.getAttribute('data-idx')) - Number(b.getAttribute('data-idx')));
    } else if(sortKey === 'money_desc'){
      visible.sort((a,b) =>
        (Number(b.getAttribute('data-money')) - Number(a.getAttribute('data-money')))
        || (Number(a.getAttribute('data-idx')) - Number(b.getAttribute('data-idx')))
      );
    } else if(sortKey === 'lots_desc'){
      visible.sort((a,b) =>
        (Number(b.getAttribute('data-lots')) - Number(a.getAttribute('data-lots')))
        || (Number(a.getAttribute('data-idx')) - Number(b.getAttribute('data-idx')))
      );
    } else if(sortKey === 'name_asc'){
      visible.sort((a,b) =>
        String(a.getAttribute('data-name')||'').localeCompare(String(b.getAttribute('data-name')||''), 'vi')
        || (Number(a.getAttribute('data-idx')) - Number(b.getAttribute('data-idx')))
      );
    }

    for(const tr of visible){
      tbody.insertBefore(tr, emptyRow);
    }

    setShownKpi(visible.length, rows.length);
    if(emptyRow) emptyRow.style.display = (visible.length === 0) ? '' : 'none';
  }

  (function initControls(){
    if(!tbody) return;
    const sortKey = document.getElementById('sortKey');
    const q = document.getElementById('q');
    const resetBtn = document.getElementById('resetBtn');

    sortKey?.addEventListener('change', applyView);
    q?.addEventListener('input', () => {
      clearTimeout(window.__rpq);
      window.__rpq = setTimeout(applyView, 60);
    });

    resetBtn?.addEventListener('click', () => {
      if(sortKey) sortKey.value = 'default';
      if(q) q.value = '';
      applyView();
    });

    applyView();
  })();
</script>
{% endblock %}
