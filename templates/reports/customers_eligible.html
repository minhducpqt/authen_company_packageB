{% extends "base.html" %}
{% block title %}Khách hàng đủ điều kiện & các lô{% endblock %}

{% block content %}
<div class="mb-6">
  <h1 class="text-2xl font-semibold text-slate-900 flex items-center gap-2">
    <i class="ri-user-star-line text-emerald-600 text-3xl"></i>
    Khách hàng đủ điều kiện & các lô
  </h1>
  <p class="text-slate-500 text-sm mt-1">
    Mỗi dòng là <span class="font-semibold text-slate-800">1 khách + 1 lô đủ điều kiện</span>,
    dùng để chuẩn bị danh sách tham gia đấu giá. Thời gian hiển thị theo
    <span class="font-semibold">giờ Việt Nam (GMT+7)</span>.
  </p>
</div>

<form method="get"
      class="bg-white border rounded-2xl shadow-sm p-4 mb-4 flex flex-wrap gap-4 items-end">
  <div class="flex flex-col">
    <label class="text-xs font-semibold text-slate-500 mb-1">Dự án</label>
    <select name="project" class="h-10 rounded-xl border px-3 text-sm min-w-[220px]">
      <option value="">— Chọn dự án —</option>
      {% for p in projects or [] %}
        {% set code = p.project_code or p.code %}
        <option value="{{ code }}" {% if code == project %}selected{% endif %}>
          {{ code }} — {{ p.name }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="flex flex-col">
    <label class="text-xs font-semibold text-slate-500 mb-1">CCCD khách</label>
    <input
      type="text"
      name="customer_cccd"
      value="{{ customer_cccd }}"
      class="h-10 rounded-xl border px-3 text-sm min-w-[160px]"
      placeholder="Exact CCCD"
    >
  </div>

  <div class="flex flex-col">
    <label class="text-xs font-semibold text-slate-500 mb-1">Mã lô (prefix)</label>
    <input
      type="text"
      name="lot_code"
      value="{{ lot_code }}"
      class="h-10 rounded-xl border px-3 text-sm min-w-[140px]"
      placeholder="VD: L01"
    >
  </div>

  <div class="flex flex-col">
    <label class="text-xs font-semibold text-slate-500 mb-1">Số dòng tối đa (limit)</label>
    <input
      type="number"
      name="limit"
      value="{{ limit or '' }}"
      class="h-10 rounded-xl border px-3 text-sm w-28"
      min="1"
      max="5000"
    >
  </div>

  <div class="flex items-center gap-3 ml-auto">
    <button
      type="submit"
      class="h-10 px-4 rounded-xl bg-emerald-600 text-white text-sm font-medium shadow-sm hover:bg-emerald-700"
    >Áp dụng</button>

    {% if project %}
      <a
        href="/reports/customers/eligible-lots/export?project={{ project }}&expose_phone=true{% if customer_cccd %}&customer_cccd={{ customer_cccd }}{% endif %}{% if lot_code %}&lot_code={{ lot_code }}{% endif %}{% if limit %}&limit={{ limit }}{% endif %}"
        class="h-10 px-4 rounded-xl border border-slate-300 text-sm font-medium text-slate-700 bg-white hover:bg-slate-50 inline-flex items-center gap-2"
      >
        <i class="ri-file-excel-2-line"></i>
        Export XLSX
      </a>
    {% endif %}
  </div>
</form>

{% set rows = (data or {}).get('items') or (data or {}).get('rows') or [] %}
{% set total = (data or {}).get('count') or rows|length %}

<div class="mb-3 text-sm text-slate-600">
  <span class="font-semibold text-slate-900">{{ total }}</span>
  dòng khách + lô <span class="text-emerald-600 font-semibold">đủ điều kiện</span> được tìm thấy.
</div>

<div class="bg-white border rounded-2xl shadow-sm overflow-hidden">
  <div class="overflow-x-auto">
    <table class="min-w-full text-sm text-slate-700">
      <thead class="bg-slate-50 text-slate-500 border-b">
        <tr>
          <th class="px-4 py-2 text-left font-semibold">Khách hàng</th>
          <th class="px-4 py-2 text-left font-semibold">CCCD</th>
          <th class="px-4 py-2 text-left font-semibold">SĐT</th>
          <th class="px-4 py-2 text-left font-semibold">Email</th>
          <th class="px-4 py-2 text-left font-semibold">Ngân hàng hoàn cọc</th>
          <th class="px-4 py-2 text-left font-semibold">Số TK hoàn cọc</th>
          <th class="px-4 py-2 text-left font-semibold">Chủ TK hoàn cọc</th>
          <th class="px-4 py-2 text-left font-semibold">Mã lô</th>
          <th class="px-4 py-2 text-right font-semibold">Tiền đặt cho lô</th>
          <th class="px-4 py-2 text-right font-semibold">Số KH trên lô</th>
          <th class="px-4 py-2 text-right font-semibold">Tổng tiền trên lô</th>
          <th class="px-4 py-2 text-right font-semibold">Tổng đặt trước theo dự án</th>
          <th class="px-4 py-2 text-left font-semibold">Thời điểm nộp</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-100">
      {% for r in rows %}
        <tr class="hover:bg-slate-50 transition">
          <td class="px-4 py-3 font-medium text-slate-900 whitespace-nowrap">
            {{ r.customer_full_name }}
          </td>
          <td class="px-4 py-3 whitespace-nowrap">{{ r.cccd }}</td>
          <td class="px-4 py-3 whitespace-nowrap">{{ r.phone }}</td>
          <td class="px-4 py-3 whitespace-nowrap">{{ r.email or '-' }}</td>

          {# --- Thông tin TK refund (field từ Service A) --- #}
          <td class="px-4 py-3 whitespace-nowrap">
            {{ r.refund_bank_code and (r.refund_bank_code ~ ' — ' ~ (r.refund_bank_name or '')) or '-' }}
          </td>
          <td class="px-4 py-3 whitespace-nowrap">
            {{ r.refund_account_number or '-' }}
          </td>
          <td class="px-4 py-3 whitespace-nowrap">
            {{ r.refund_account_name or '-' }}
          </td>

          <td class="px-4 py-3 font-semibold text-slate-900 whitespace-nowrap">
            {{ r.lot_code }}
          </td>
          <td class="px-4 py-3 text-right whitespace-nowrap js-money"
              data-value="{{ r.deposit_amount or 0 }}">
            {{ r.deposit_amount or '' }}
          </td>
          <td class="px-4 py-3 text-right whitespace-nowrap">
            {{ r.deposit_customer_count or 0 }}
          </td>
          <td class="px-4 py-3 text-right whitespace-nowrap js-money"
              data-value="{{ r.total_deposit_amount_per_lot or 0 }}">
            {{ r.total_deposit_amount_per_lot or '' }}
          </td>
          <td class="px-4 py-3 text-right whitespace-nowrap js-money"
              data-value="{{ r.total_deposit_amount_per_customer_project or 0 }}">
            {{ r.total_deposit_amount_per_customer_project or '' }}
          </td>
          <td class="px-4 py-3 text-xs text-slate-500 whitespace-nowrap js-datetime"
              data-value="{{ r.paid_at or '' }}">
            {{ r.paid_at or '' }}
          </td>
        </tr>
      {% endfor %}
      {% if rows|length == 0 %}
        <tr>
          <td colspan="13" class="px-4 py-4 text-center text-slate-400">
            Chọn dự án và bấm "Áp dụng" để xem dữ liệu.
          </td>
        </tr>
      {% endif %}
      </tbody>
    </table>
  </div>
</div>

<style>
  table th,
  table td {
    white-space: nowrap;
  }
</style>

<script>
(function () {
  function formatMoney(v) {
    if (v === null || v === undefined) return "";
    const n = Number(v) || 0;
    return n.toLocaleString("vi-VN", {
      maximumFractionDigits: 0,
      minimumFractionDigits: 0
    });
  }

  function formatDateVN(s) {
    if (!s) return "";
    try {
      const d = new Date(s);
      return d.toLocaleString("vi-VN", {
        timeZone: "Asia/Ho_Chi_Minh",
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit"
      });
    } catch (e) {
      console.warn("formatDateVN error", e, s);
      return s;
    }
  }

  document.querySelectorAll(".js-money").forEach(td => {
    const raw = td.getAttribute("data-value");
    if (raw !== null && raw !== "") {
      td.textContent = formatMoney(raw);
    }
  });

  document.querySelectorAll(".js-datetime").forEach(td => {
    const raw = td.getAttribute("data-value");
    if (raw) {
      td.textContent = formatDateVN(raw);
    }
  });
})();
</script>
{% endblock %}
