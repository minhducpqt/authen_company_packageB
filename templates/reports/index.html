{% extends "base.html" %}
{% block title %}Báo cáo thống kê{% endblock %}

{% block content %}
<div class="mb-6">
  <div class="flex items-start justify-between gap-4">
    <div>
      <h1 class="text-2xl font-semibold text-slate-900 flex items-center gap-2">
        <i class="ri-bar-chart-2-line text-indigo-600 text-3xl"></i>
        Bảng điều khiển báo cáo
      </h1>
      <p class="text-slate-500 text-sm mt-1">
        Tổng hợp nhanh các báo cáo về lô, khách hàng và mua hồ sơ trong từng dự án.
      </p>
    </div>

    <div class="hidden md:flex items-center gap-2">
      <span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-white border border-slate-200 text-slate-600 text-xs shadow-sm">
        <span class="h-2 w-2 rounded-full bg-emerald-500"></span>
        Báo cáo hệ thống
      </span>
    </div>
  </div>
</div>

{# ===== TỔNG QUAN (ENTRY) ===== #}
<div class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden mb-8">
  <div class="px-4 py-3 border-b border-slate-200 bg-gradient-to-r from-slate-50 to-white">
    <div class="flex items-center justify-between gap-3">
      <div class="flex items-center gap-2">
        <div class="h-9 w-9 rounded-xl bg-indigo-50 flex items-center justify-center">
          <i class="ri-layout-grid-line text-indigo-600 text-lg"></i>
        </div>
        <div>
          <div class="text-sm font-semibold text-slate-900">Tổng quan</div>
          <div class="text-xs text-slate-500">Truy cập nhanh các báo cáo theo nhóm nghiệp vụ</div>
        </div>
      </div>

      <div class="hidden md:flex items-center gap-2 text-xs text-slate-500">
        <i class="ri-cursor-line"></i>
        <span>Chọn mục để mở báo cáo</span>
      </div>
    </div>
  </div>

  <div class="p-4">
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
      {# ===================== 4 CARD CHUYỂN SANG V2 ===================== #}
      {# NOTE: V2 cần project_id -> dẫn sang hub chọn dự án V2 #}

      <!-- Lô đủ điều kiện (V2) -->
      <a href="/reports/v2"
         class="group relative bg-white border border-slate-200 rounded-2xl p-4 shadow-sm hover:shadow-md hover:border-indigo-200 transition overflow-hidden">
        <div class="absolute inset-x-0 top-0 h-1 bg-indigo-500/80"></div>
        <div class="flex items-start justify-between gap-3 mb-2">
          <div class="min-w-0">
            <div class="text-base font-semibold text-slate-900 mt-0.5">Lô đủ điều kiện</div>
          </div>
          <div class="h-10 w-10 rounded-2xl bg-indigo-50 flex items-center justify-center group-hover:bg-indigo-100 transition">
            <i class="ri-checkbox-circle-line text-indigo-600 text-xl"></i>
          </div>
        </div>
        <p class="text-xs text-slate-500 leading-relaxed">
          Danh sách lô có đủ số khách đặt tiền, kèm số lượng khách và tổng tiền đặt trước.
        </p>
        <div class="mt-3 inline-flex items-center gap-1 text-xs font-semibold text-indigo-700">
          Mở báo cáo <i class="ri-arrow-right-line"></i>
        </div>
      </a>

      <!-- Lô không đủ điều kiện (V2) -->
      <a href="/reports/v2"
         class="group relative bg-white border border-slate-200 rounded-2xl p-4 shadow-sm hover:shadow-md hover:border-rose-200 transition overflow-hidden">
        <div class="absolute inset-x-0 top-0 h-1 bg-rose-500/80"></div>
        <div class="flex items-start justify-between gap-3 mb-2">
          <div class="min-w-0">
            <div class="text-base font-semibold text-slate-900 mt-0.5">Lô không đủ điều kiện</div>
          </div>
          <div class="h-10 w-10 rounded-2xl bg-rose-50 flex items-center justify-center group-hover:bg-rose-100 transition">
            <i class="ri-alert-line text-rose-600 text-xl"></i>
          </div>
        </div>
        <p class="text-xs text-slate-500 leading-relaxed">
          Các lô chưa đạt điều kiện đấu giá (0–1 khách đặt hoặc thiếu điều kiện).
        </p>
        <div class="mt-3 inline-flex items-center gap-1 text-xs font-semibold text-rose-700">
          Mở báo cáo <i class="ri-arrow-right-line"></i>
        </div>
      </a>

      <!-- Thống kê tiền đặt trước (V1 giữ nguyên) -->
      <a href="/reports/lots/deposit-stats"
         class="group relative bg-white border border-slate-200 rounded-2xl p-4 shadow-sm hover:shadow-md hover:border-sky-200 transition overflow-hidden">
        <div class="absolute inset-x-0 top-0 h-1 bg-sky-500/80"></div>
        <div class="flex items-start justify-between gap-3 mb-2">
          <div class="min-w-0">
            <div class="text-base font-semibold text-slate-900 mt-0.5">Thống kê tiền đặt trước</div>
          </div>
          <div class="h-10 w-10 rounded-2xl bg-sky-50 flex items-center justify-center group-hover:bg-sky-100 transition">
            <i class="ri-funds-line text-sky-600 text-xl"></i>
          </div>
        </div>
        <p class="text-xs text-slate-500 leading-relaxed">
          Tổng hợp theo lô: số khách, tổng tiền, thời điểm đặt đầu/cuối và trạng thái.
        </p>
        <div class="mt-3 inline-flex items-center gap-1 text-xs font-semibold text-sky-700">
          Mở báo cáo <i class="ri-arrow-right-line"></i>
        </div>
      </a>

      <!-- KH đủ điều kiện & lô (V2: chuyển sang customers eligible) -->
      <a href="/reports/v2"
         class="group relative bg-white border border-slate-200 rounded-2xl p-4 shadow-sm hover:shadow-md hover:border-emerald-200 transition overflow-hidden">
        <div class="absolute inset-x-0 top-0 h-1 bg-emerald-500/80"></div>
        <div class="flex items-start justify-between gap-3 mb-2">
          <div class="min-w-0">
            <div class="text-base font-semibold text-slate-900 mt-0.5">KH đủ điều kiện &amp; lô</div>
          </div>
          <div class="h-10 w-10 rounded-2xl bg-emerald-50 flex items-center justify-center group-hover:bg-emerald-100 transition">
            <i class="ri-user-star-line text-emerald-600 text-xl"></i>
          </div>
        </div>
        <p class="text-xs text-slate-500 leading-relaxed">
          Mỗi dòng là 1 khách đủ điều kiện trong dự án, kèm thông tin liên hệ theo quyền.
        </p>
        <div class="mt-3 inline-flex items-center gap-1 text-xs font-semibold text-emerald-700">
          Mở báo cáo <i class="ri-arrow-right-line"></i>
        </div>
      </a>
    </div>
  </div>
</div>

{# ===== 3 REPORT CŨ GIỮ NGUYÊN ===== #}
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
  <!-- KH không đủ điều kiện & lô (V2: chuyển sang customers ineligible) -->
  <a href="/reports/v2"
     class="group relative bg-white border border-slate-200 rounded-2xl p-4 shadow-sm hover:shadow-md hover:border-rose-200 transition overflow-hidden">
    <div class="absolute inset-x-0 top-0 h-1 bg-rose-500/80"></div>
    <div class="flex items-start justify-between gap-3 mb-2">
      <div class="min-w-0">
        <div class="text-base font-semibold text-slate-900 mt-0.5">KH không đủ điều kiện &amp; lô</div>
      </div>
      <div class="h-10 w-10 rounded-2xl bg-rose-50 flex items-center justify-center group-hover:bg-rose-100 transition">
        <i class="ri-user-forbid-line text-rose-600 text-xl"></i>
      </div>
    </div>
    <p class="text-xs text-slate-500 leading-relaxed">
      Khách + lô chưa đủ điều kiện, vẫn kèm thông tin để xử lý nghiệp vụ (theo quyền).
    </p>
    <div class="mt-3 inline-flex items-center gap-1 text-xs font-semibold text-rose-700">
      Mở báo cáo <i class="ri-arrow-right-line"></i>
    </div>
  </a>

  <!-- Mua hồ sơ — chi tiết (V1 giữ nguyên) -->
  <a href="/reports/dossiers/paid/detail"
     class="group relative bg-white border border-slate-200 rounded-2xl p-4 shadow-sm hover:shadow-md hover:border-amber-200 transition overflow-hidden">
    <div class="absolute inset-x-0 top-0 h-1 bg-amber-500/80"></div>
    <div class="flex items-start justify-between gap-3 mb-2">
      <div class="min-w-0">
        <div class="text-base font-semibold text-slate-900 mt-0.5">Mua hồ sơ — chi tiết</div>
      </div>
      <div class="h-10 w-10 rounded-2xl bg-amber-50 flex items-center justify-center group-hover:bg-amber-100 transition">
        <i class="ri-file-list-3-line text-amber-600 text-xl"></i>
      </div>
    </div>
    <p class="text-xs text-slate-500 leading-relaxed">
      Chi tiết mua hồ sơ theo khách, đơn và loại hồ sơ, phù hợp đối soát.
    </p>
    <div class="mt-3 inline-flex items-center gap-1 text-xs font-semibold text-amber-700">
      Mở báo cáo <i class="ri-arrow-right-line"></i>
    </div>
  </a>

  <!-- Mua hồ sơ — tổng hợp (V1 giữ nguyên) -->
  <a href="/reports/dossiers/paid/summary"
     class="group relative bg-white border border-slate-200 rounded-2xl p-4 shadow-sm hover:shadow-md hover:border-violet-200 transition overflow-hidden">
    <div class="absolute inset-x-0 top-0 h-1 bg-violet-500/80"></div>
    <div class="flex items-start justify-between gap-3 mb-2">
      <div class="min-w-0">
        <div class="text-base font-semibold text-slate-900 mt-0.5">Mua hồ sơ — tổng hợp</div>
      </div>
      <div class="h-10 w-10 rounded-2xl bg-violet-50 flex items-center justify-center group-hover:bg-violet-100 transition">
        <i class="ri-pie-chart-2-line text-violet-600 text-xl"></i>
      </div>
    </div>
    <p class="text-xs text-slate-500 leading-relaxed">
      Tổng hợp theo khách và theo loại hồ sơ, phục vụ chốt số liệu nhanh.
    </p>
    <div class="mt-3 inline-flex items-center gap-1 text-xs font-semibold text-violet-700">
      Mở báo cáo <i class="ri-arrow-right-line"></i>
    </div>
  </a>
</div>

{# ===== DỰ ÁN ĐANG HOẠT ĐỘNG (CARD VIEW) ===== #}
<div class="bg-white border rounded-2xl shadow-sm p-4">
  <div class="flex items-center justify-between mb-4">
    <div>
      <div class="text-sm font-semibold text-slate-900 flex items-center gap-2">
        <i class="ri-community-line text-sky-500"></i>
        Dự án đang hoạt động
      </div>
      <p class="text-xs text-slate-500 mt-1">
        Danh sách dự án ACTIVE. Chọn nhanh để mở các báo cáo theo dự án.
      </p>
    </div>
  </div>

  {% set projects_list = projects or [] %}
  {% if projects_list|length == 0 %}
    <div class="py-6 text-center text-slate-400 text-sm">
      Chưa có dự án ACTIVE nào hoặc không tải được danh sách dự án.
    </div>
  {% else %}
    <div class="space-y-3">
      {% for p in projects_list %}
        {% set code = p.project_code or p.code %}
        <div class="border border-slate-100 rounded-2xl px-4 py-3 bg-slate-50/60 hover:bg-slate-50 transition">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-indigo-50 text-indigo-700">
                  {{ code }}
                </span>
                <span class="text-[11px] uppercase tracking-wide text-slate-400">
                  {{ p.product_type or 'LAND' }}
                </span>
              </div>
              <div class="text-sm font-semibold text-slate-900 leading-snug break-words">
                {{ p.name }}
              </div>
              <div class="mt-1 text-xs text-slate-500 flex items-center gap-1">
                <i class="ri-map-pin-line"></i>
                <span class="truncate md:whitespace-normal">
                  {{ p.location or '-' }}
                </span>
              </div>
            </div>

            <div class="flex flex-wrap items-center gap-2 text-xs md:justify-end">
              {# ===== 4 PILL CHUYỂN SANG V2 (dùng project_id) ===== #}
              <a href="/reports/v2/projects/{{ p.id }}/lots/eligible"
                 class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-indigo-50 text-indigo-700 hover:bg-indigo-100">
                <i class="ri-checkbox-circle-line"></i>
                <span>Lô đủ</span>
              </a>
              <a href="/reports/v2/projects/{{ p.id }}/lots/ineligible"
                 class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-rose-50 text-rose-700 hover:bg-rose-100">
                <i class="ri-alert-line"></i>
                <span>Lô không đủ</span>
              </a>
              <a href="/reports/v2/projects/{{ p.id }}/customers/eligible"
                 class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 hover:bg-emerald-100">
                <i class="ri-user-star-line"></i>
                <span>KH đủ</span>
              </a>
              <a href="/reports/v2/projects/{{ p.id }}/customers/ineligible"
                 class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-rose-50 text-rose-700 hover:bg-rose-100">
                <i class="ri-user-forbid-line"></i>
                <span>KH không đủ</span>
              </a>

              {# ===== CÁC PILL CÒN LẠI GIỮ NGUYÊN V1 ===== #}
              <a href="/reports/lots/deposit-stats?project={{ code }}"
                 class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-sky-50 text-sky-700 hover:bg-sky-100">
                <i class="ri-funds-line"></i>
                <span>Tiền đặt</span>
              </a>
              <a href="/reports/dossiers/paid/detail?project={{ code }}"
                 class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-amber-50 text-amber-700 hover:bg-amber-100">
                <i class="ri-file-list-3-line"></i>
                <span>Hồ sơ</span>
              </a>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}
</div>
{% endblock %}
