{# templates/reports/_toolbar.html #}
<div class="mb-4 bg-white border rounded-xl p-4 shadow-sm">
  <form id="filtersForm"
        class="flex flex-col md:flex-row gap-3 items-start md:items-end">

    <!-- Ch·ªçn d·ª± √°n -->
    <div class="flex-1 min-w-[200px]">
      <label class="block text-xs text-slate-500 mb-1 font-semibold">D·ª± √°n</label>
      <select id="projectSelect" name="project"
              class="w-full rounded-lg border-slate-300 focus:ring-2 focus:ring-indigo-500">
        <option value="">‚Äî T·∫•t c·∫£ d·ª± √°n ‚Äî</option>
      </select>
    </div>

    <!-- √î t√¨m ki·∫øm -->
    <div class="flex-1 min-w-[200px]">
      <label class="block text-xs text-slate-500 mb-1 font-semibold">T√¨m ki·∫øm</label>
      <input id="qInput" name="q" type="text"
             placeholder="T√™n, CCCD, SƒêT, m√£ l√¥..."
             class="w-full rounded-lg border-slate-300 focus:ring-2 focus:ring-indigo-500"
             value="{{ init_q or '' }}">
    </div>

    <!-- N√∫t -->
    <div class="flex flex-wrap items-center gap-2">
      <button type="submit"
              class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 shadow">√Åp d·ª•ng</button>
      <button type="button" id="btnExportCsv"
              class="px-3 py-2 rounded-lg border border-slate-300 text-slate-700 hover:bg-slate-50">Export CSV</button>
      <button type="button" id="btnExportXlsx"
              class="px-3 py-2 rounded-lg border border-slate-300 text-slate-700 hover:bg-slate-50">Export XLSX</button>
    </div>
  </form>
</div>

<script>
(function () {
  const initProject = "{{ init_project_code or '' }}";
  const selectEl = document.getElementById('projectSelect');
  const qEl = document.getElementById('qInput');
  const formEl = document.getElementById('filtersForm');

  // üîπ L·∫•y danh s√°ch d·ª± √°n ACTIVE t·ª´ Service B (server side ƒë√£ g·ªçi A)
  fetch('/api/projects/options')
    .then(r => r.ok ? r.json() : Promise.reject(r))
    .then(({ options }) => {
      if (!Array.isArray(options)) return;
      let firstActive = null;
      for (const o of options) {
        const code = o.project_code || o.code || o.id || '';
        if (!code) continue;
        const op = document.createElement('option');
        op.value = code;
        op.textContent = `${code} ‚Äî ${o.name || ''}`;
        selectEl.appendChild(op);
        if (!firstActive) firstActive = code; // ƒë√£ l·ªçc ACTIVE n√™n ph·∫ßn t·ª≠ ƒë·∫ßu l√† active
      }
      // ‚úÖ Auto-select n·∫øu URL ch∆∞a c√≥ project
      if (!initProject && firstActive) selectEl.value = firstActive;
      else if (initProject) selectEl.value = initProject;
    })
    .catch(err => console.warn('Project options load error:', err));

  // Submit filters (GET, gi·ªØ URL shareable)
  formEl.addEventListener('submit', function (e) {
    e.preventDefault();
    const u = new URL(window.location.href);
    const project = selectEl.value || '';
    const q = qEl.value || '';
    if (project) u.searchParams.set('project', project); else u.searchParams.delete('project');
    if (q) u.searchParams.set('q', q); else u.searchParams.delete('q');
    window.location.href = u.toString();
  });

  // Export
  function doExport(fmt) {
    const u = new URL('/reports/export', window.location.origin);
    u.searchParams.set('kind', "{{ export_kind }}");
    const project = selectEl.value || "{{ init_project_code or '' }}";
    const q = qEl.value || "{{ init_q or '' }}";
    if (project) u.searchParams.set('project', project);
    if (q) u.searchParams.set('q', q);
    u.searchParams.set('fmt', fmt);
    window.location.href = u.toString();
  }
  document.getElementById('btnExportCsv').addEventListener('click', () => doExport('csv'));
  document.getElementById('btnExportXlsx').addEventListener('click', () => doExport('xlsx'));
})();
</script>
