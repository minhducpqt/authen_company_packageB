{# templates/reports/_toolbar.html — FINAL #}

<script>
(function () {
  // ⛔ KHÓA TOOLBAR trên trang /reports (tổng quan)
  const path = window.location.pathname;
  if (path === "/reports") return;

  const initProject = "{{ init_project_code or '' }}";
  const initQ = "{{ init_q or '' }}";

  const selectEl = document.getElementById('projectSelect');
  const qEl = document.getElementById('qInput');
  const btnExport = document.getElementById('btnExportXlsx');

  if (!selectEl) return;

  const getUrl = () => new URL(window.location.href);

  // ---------- helpers ----------
  const debounce = (fn, d) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), d); }; };

  function readMaxLimit() {
    // page cụ thể có thể set: <select id="projectSelect" data-max-limit="10000">
    const v = Number(selectEl.getAttribute('data-max-limit') || 5000);
    return Number.isFinite(v) && v > 0 ? v : 5000;
  }

  function normalizeForMaxResults(u) {
    // limit -> max
    const maxLimit = readMaxLimit();
    if (u.searchParams.has('limit')) u.searchParams.set('limit', String(maxLimit));

    // min_* -> 0
    for (const [k] of u.searchParams.entries()) {
      if (/^min_/i.test(k)) u.searchParams.set(k, "0");
    }

    // max_* -> remove (no cap => many results)
    for (const k of Array.from(u.searchParams.keys())) {
      if (/^max_/i.test(k)) u.searchParams.delete(k);
    }

    // các filter khác -> để trống (nhiều kết quả nhất)
    const clearKeys = ['customer_cccd','lot_code','q'];
    for (const k of clearKeys) u.searchParams.delete(k);

    return u;
  }

  function applyFilters(next = {}) {
    const u = getUrl();

    const project = (next.project ?? selectEl.value ?? '').trim();
    const q = (next.q ?? (qEl ? qEl.value : '') ?? '').trim();

    // không có project thì thôi
    if (!project) return;

    u.searchParams.set('project', project);

    // q: chỉ set nếu user gõ (không auto set)
    if (q) u.searchParams.set('q', q);
    else u.searchParams.delete('q');

    // đảm bảo default theo hướng "nhiều kết quả nhất"
    normalizeForMaxResults(u);

    if (u.toString() !== window.location.href) {
      window.location.replace(u.toString());
    }
  }

  function pickAutoProject(opts) {
    // ưu tiên ACTIVE xa nhất (cuối danh sách)
    const actives = opts.filter(o => (String(o.status || o.project_status || '')).toUpperCase() === 'ACTIVE');
    if (actives.length > 0) {
      const last = actives[actives.length - 1];
      return (last.project_code || last.code || last.id || '').toString();
    }
    // fallback: lấy item cuối
    if (opts.length > 0) {
      const last = opts[opts.length - 1];
      return (last.project_code || last.code || last.id || '').toString();
    }
    return '';
  }

  // ---------- load project options: ALL projects ----------
  // Yêu cầu: endpoint trả { data: [{project_code,name,status}, ...] }
  fetch('/projects/options/all', { credentials: 'same-origin' })
    .then(r => r.ok ? r.json() : Promise.reject(r))
    .then(({ data }) => {
      const opts = Array.isArray(data) ? data : [];

      // rebuild options
      selectEl.innerHTML = '';
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = '— Chọn dự án —';
      selectEl.appendChild(placeholder);

      for (const o of opts) {
        const code = (o.project_code || o.code || o.id || '').toString();
        if (!code) continue;

        const status = (o.status || o.project_status || '').toString().toUpperCase();
        const isActive = status === 'ACTIVE';

        const op = document.createElement('option');
        op.value = code;
        op.textContent = `${code} — ${o.name || ''}${isActive ? '' : ' (INACTIVE)'}`;
        op.dataset.status = status;

        selectEl.appendChild(op);
      }

      const u = getUrl();
      const urlProject = (u.searchParams.get('project') || '').trim();

      // ưu tiên: URL -> initProject -> auto active last
      let selected = '';
      if (urlProject) selected = urlProject;
      else if (initProject) selected = initProject.trim();
      else selected = pickAutoProject(opts);

      if (selected) {
        selectEl.value = selected;

        // Nếu URL chưa có project, hoặc đang ở trạng thái "không có project" -> auto apply
        if (!urlProject) {
          // áp default max result ngay khi auto chọn
          setTimeout(() => applyFilters({ project: selected, q: initQ }), 50);
        } else {
          // nếu có project rồi: vẫn normalize default filter về max result (tránh trang con thiếu param)
          const nu = normalizeForMaxResults(u);
          if (nu.toString() !== window.location.href) window.location.replace(nu.toString());
        }
      }
    })
    .catch(e => console.warn('Project options load error:', e));

  // ---------- events ----------
  // chọn dự án -> apply ngay
  selectEl.addEventListener('change', () => applyFilters());

  // q: debounce, Enter apply ngay
  if (qEl) {
    const debouncedApply = debounce(() => applyFilters(), 450);
    qEl.addEventListener('input', debouncedApply);
    qEl.addEventListener('keydown', e => {
      if (e.key === 'Enter') { e.preventDefault(); applyFilters(); }
    });
  }

  // export: giữ nguyên kiểu cũ (nếu bạn dùng /reports/export)
  if (btnExport) {
    btnExport.addEventListener('click', () => {
      const project = (selectEl.value || '').trim();
      if (!project) { alert('Vui lòng chọn dự án trước khi export.'); return; }

      const u = new URL('/reports/export', window.location.origin);
      u.searchParams.set('kind', "{{ export_kind }}");
      u.searchParams.set('project', project);

      const q = (qEl ? (qEl.value || '').trim() : '');
      if (q) u.searchParams.set('q', q);

      // export cũng ép về default nhiều kết quả nhất
      u.searchParams.set('fmt', 'xlsx');
      const maxLimit = readMaxLimit();
      u.searchParams.set('limit', String(maxLimit));
      window.location.href = u.toString();
    });
  }

})();
</script>

{# UI toolbar #}
<div class="mb-4 bg-white border rounded-2xl p-4 shadow-sm">
  <form id="filtersForm" class="flex flex-col md:flex-row gap-3 items-start md:items-end" action="" method="get">
    <div class="flex-1 min-w-[240px]">
      <label class="block text-xs text-slate-500 mb-1 font-semibold">Dự án</label>
      <select id="projectSelect" name="project"
              class="w-full h-10 rounded-xl border-slate-300 focus:ring-2 focus:ring-indigo-500"
              data-max-limit="5000">
        <option value="">— Chọn dự án —</option>
      </select>
    </div>

    <div class="flex-1 min-w-[240px]">
      <label class="block text-xs text-slate-500 mb-1 font-semibold">Tìm kiếm</label>
      <input id="qInput" name="q" type="text"
             placeholder="Tên, CCCD, SĐT, mã lô..."
             class="w-full h-10 rounded-xl border-slate-300 focus:ring-2 focus:ring-indigo-500 px-3"
             value="{{ init_q or '' }}">
    </div>

    <div class="flex flex-wrap items-center gap-2">
      <button type="button" id="btnExportXlsx"
              class="h-10 px-4 rounded-xl border border-slate-300 text-slate-700 hover:bg-slate-50 inline-flex items-center gap-2">
        <i class="ri-file-excel-2-line"></i>
        Export XLSX
      </button>
    </div>
  </form>
</div>
