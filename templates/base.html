<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{{ title or "Dashboard" }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css">
  <link rel="stylesheet" href="/static/style.css"/>
</head>
<body class="bg-slate-50">
  {% set logged_in = is_logged_in(request) %}

  {# ===== Role flags ===== #}
  {% set user_role = (request.cookies.get('user_role') or 'VIEWER')|upper %}
  {% set is_admin = (user_role == 'COMPANY_ADMIN') %}
  {% set is_staff = (user_role == 'STAFF') %}
  {% set is_viewer = (user_role == 'VIEWER') %}
  {% set is_accountant = (user_role == 'ACCOUNTANT') %}

  <!-- ===== Header ===== -->
  <div class="bg-indigo-700 text-white">
    <div class="max-w-screen-2xl mx-auto h-14 px-5 flex items-center justify-between">

      <div class="flex items-center gap-3">
        <a href="/reports"
           class="font-semibold text-lg tracking-wide hover:underline cursor-pointer">
          Dashboard
        </a>
      </div>

      <div class="flex items-center gap-4 text-xl">
        <i class="ri-search-line cursor-pointer"></i>
        <i class="ri-settings-3-line cursor-pointer"></i>
        <i class="ri-notification-3-line cursor-pointer"></i>

        <div class="relative">
          <button onclick="toggleUserMenu()" class="avatar focus:outline-none">
            <i class="ri-user-3-fill text-indigo-700"></i>
          </button>

          <div id="userMenu"
               class="hidden absolute right-0 mt-2 w-56 bg-white border border-slate-200 rounded-xl shadow-lg z-50">
            <a href="/account/change-password-form"
               class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50">
              <i class="ri-key-2-line mr-2"></i> Đổi mật khẩu
            </a>

            {# ✅ GIỮ NGUYÊN action cũ /account/logout, nhưng giờ backend đã xoá cookie role ở route này #}
            <form method="post" action="/account/logout" data-confirm="Đăng xuất khỏi thiết bị này?">
              <button type="submit"
                      class="block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50">
                <i class="ri-logout-box-line mr-2"></i> Đăng xuất
              </button>
            </form>

            <form method="post" action="/account/logout_all" data-confirm="Đăng xuất khỏi TẤT CẢ thiết bị?">
              <button type="submit"
                      class="block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50">
                <i class="ri-shut-down-line mr-2"></i> Đăng xuất tất cả
              </button>
            </form>
          </div>
        </div>

        <script>
          function toggleUserMenu() {
            const menu = document.getElementById("userMenu");
            if (!menu) return;
            menu.classList.toggle("hidden");
          }
          window.addEventListener("click", function(e) {
            const menu = document.getElementById("userMenu");
            const btn = document.querySelector(".avatar");
            if (!menu || !btn) return;
            if (!menu.contains(e.target) && !btn.contains(e.target)) {
              menu.classList.add("hidden");
            }
          });
        </script>
      </div>
    </div>
  </div>

  <!-- ===== Layout ===== -->
  <div class="max-w-screen-2xl mx-auto px-5 py-5 app-shell">

    {% if not request.url.path.startswith('/login') %}
    <aside id="appSidebarScroll" class="app-sidebar w-64 bg-white rounded-xl border border-slate-200 h-[84vh] overflow-y-auto">
      <ul class="p-2">

        {# =========================================================
           MENU: ADMIN (GIỮ Y NGUYÊN BẢN GỐC)
           ========================================================= #}
        {% if is_admin %}

          {# ✅ Dashboard/Tổng quan: CHỈ ADMIN #}
          <li class="side-title mt-0">Dashboard</li>
          <li>
            <a class="side-link {% if request.url.path in ['/', '/reports'] %}active{% endif %}"
               href="/reports">
              <i class="ri-bar-chart-2-line"></i> Tổng quan
            </a>
          </li>

          {# ===== 1. Dự án & Giao dịch (Admin full) ===== #}
          <li class="side-title mt-4">1. Dự án & Giao dịch</li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/projects') and not request.url.path.startswith('/projects/payment-accounts') %}active{% endif %}"
               href="/projects">
              <i class="ri-community-line"></i> 1.1 Quản lý dự án
            </a>
          </li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/projects/payment-accounts') %}active{% endif %}"
               href="/projects/payment-accounts">
              <i class="ri-cash-line"></i> 1.2 Cấu hình nhận tiền
            </a>
          </li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/announcements') %}active{% endif %}"
               href="/announcements">
              <i class="ri-megaphone-line"></i> 1.3 Quản lý thông báo
            </a>
          </li>

          {# ===== 2. Giao dịch ===== #}
          <li class="side-title mt-4">2. Giao dịch</li>
          <li>
            <a class="side-link {% if request.url.path == '/transactions/dossiers' %}active{% endif %}"
               href="/transactions/dossiers">
              <i class="ri-file-list-2-line"></i> 2.1 Mua hồ sơ
            </a>
          </li>
          <li>
            <a class="side-link {% if request.url.path == '/transactions/deposits' %}active{% endif %}"
               href="/transactions/deposits">
              <i class="ri-hand-coin-line"></i> 2.2 Đặt cọc
            </a>
          </li>
          <li>
            <a class="side-link {% if request.url.path == '/transactions/summary' %}active{% endif %}"
               href="/transactions/summary">
              <i class="ri-dashboard-line"></i> 2.3 Tổng hợp
            </a>
          </li>

          {# ===== 3. Kế toán & dòng tiền ===== #}
          <li class="side-title mt-4">3. Kế toán & dòng tiền</li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/giao-dich-ngan-hang') %}active{% endif %}"
               href="/giao-dich-ngan-hang">
              <i class="ri-bank-card-line"></i> 3.1 Giao dịch ngân hàng
            </a>
          </li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/invoices/export') %}active{% endif %}"
               href="/invoice-exports">
              <i class="ri-file-paper-2-line"></i> 3.2 Xuất hoá đơn
            </a>
          </li>

          {# ===== 4. Khách hàng ===== #}
          <li class="side-title mt-4">4. Khách hàng</li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/customers') and not request.url.path.startswith('/customers/documents') %}active{% endif %}"
               href="/customers">
              <i class="ri-team-line"></i> 4.0 Danh sách khách
            </a>
          </li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/_admin/customer-documents') %}active{% endif %}"
               href="/_admin/customer-documents">
              <i class="ri-file-shield-2-line"></i> 4.1 Giấy tờ phải nộp
            </a>
          </li>

          {# ===== 5. Phiên Đấu Giá (Admin full) ===== #}
          <li class="side-title mt-4">5. Phiên Đấu Giá</li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/bid-attendance') %}active{% endif %}"
               href="/bid-attendance">
              <i class="ri-user-follow-line"></i> 5.1 Danh sách điểm danh
            </a>
          </li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/bid-tickets') %}active{% endif %}"
               href="/bid-tickets">
              <i class="ri-file-text-line"></i> 5.2 Phiếu trả giá
            </a>
          </li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/auction/sessions') %}active{% endif %}"
               href="/auction/sessions">
              <i class="ri-auction-line"></i> 5.3 Vận hành phiên
            </a>
          </li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/auction/results') %}active{% endif %}"
               href="/auction/results">
              <i class="ri-auction-line"></i> 5.4 Kết quả trúng đấu giá
            </a>
          </li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/auction/refunds') %}active{% endif %}"
               href="/auction/refunds">
              <i class="ri-refund-2-line"></i> 5.5 Hoàn tiền đặt trước
            </a>
          </li>

          {# ===== 6. Thiết lập (Admin full) ===== #}
          <li class="side-title mt-4">6. Thiết lập</li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/settings/company') %}active{% endif %}"
               href="/settings/company">
              <i class="ri-building-4-line"></i> 6.1 Thông tin công ty
            </a>
          </li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/settings/bank-accounts') %}active{% endif %}"
               href="/settings/bank-accounts">
              <i class="ri-bank-line"></i> 6.2 Tài khoản ngân hàng
            </a>
          </li>

        {# =========================================================
           MENU: ACCOUNTANT (GIỮ NGUYÊN)
           ========================================================= #}
        {% elif is_accountant %}

          {# ===== 1. Dự án & Giao dịch (FULL 1.1-1.3) ===== #}
          <li class="side-title mt-0">1. Dự án & Giao dịch</li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/projects') and not request.url.path.startswith('/projects/payment-accounts') %}active{% endif %}"
               href="/projects">
              <i class="ri-community-line"></i> 1.1 Quản lý dự án
            </a>
          </li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/projects/payment-accounts') %}active{% endif %}"
               href="/projects/payment-accounts">
              <i class="ri-cash-line"></i> 1.2 Cấu hình nhận tiền
            </a>
          </li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/announcements') %}active{% endif %}"
               href="/announcements">
              <i class="ri-megaphone-line"></i> 1.3 Quản lý thông báo
            </a>
          </li>

          {# ===== 2. Giao dịch (CHỈ 2.1-2.2) ===== #}
          <li class="side-title mt-4">2. Giao dịch</li>
          <li>
            <a class="side-link {% if request.url.path == '/transactions/dossiers' %}active{% endif %}"
               href="/transactions/dossiers">
              <i class="ri-file-list-2-line"></i> 2.1 Mua hồ sơ
            </a>
          </li>
          <li>
            <a class="side-link {% if request.url.path == '/transactions/deposits' %}active{% endif %}"
               href="/transactions/deposits">
              <i class="ri-hand-coin-line"></i> 2.2 Đặt cọc
            </a>
          </li>

          {# ===== 3. Kế toán & dòng tiền (FULL 3.1-3.2) ===== #}
          <li class="side-title mt-4">3. Kế toán & dòng tiền</li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/giao-dich-ngan-hang') %}active{% endif %}"
               href="/giao-dich-ngan-hang">
              <i class="ri-bank-card-line"></i> 3.1 Giao dịch ngân hàng
            </a>
          </li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/invoices/export') %}active{% endif %}"
               href="/invoice-exports">
              <i class="ri-file-paper-2-line"></i> 3.2 Xuất hoá đơn
            </a>
          </li>

          {# ===== 4. Khách hàng (FULL 4.0-4.1) ===== #}
          <li class="side-title mt-4">4. Khách hàng</li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/customers') and not request.url.path.startswith('/customers/documents') %}active{% endif %}"
               href="/customers">
              <i class="ri-team-line"></i> 4.0 Danh sách khách
            </a>
          </li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/_admin/customer-documents') %}active{% endif %}"
               href="/_admin/customer-documents">
              <i class="ri-file-shield-2-line"></i> 4.1 Giấy tờ phải nộp
            </a>
          </li>

          {# ===== 5. Phiên Đấu Giá (CHỈ 5.3-5.4 + THÊM 5.5) ===== #}
          <li class="side-title mt-4">5. Phiên Đấu Giá</li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/auction/sessions') %}active{% endif %}"
               href="/auction/sessions">
              <i class="ri-auction-line"></i> 5.3 Vận hành phiên
            </a>
          </li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/auction/results') %}active{% endif %}"
               href="/auction/results">
              <i class="ri-auction-line"></i> 5.4 Kết quả trúng đấu giá
            </a>
          </li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/auction/refunds') %}active{% endif %}"
               href="/auction/refunds">
              <i class="ri-refund-2-line"></i> 5.5 Hoàn tiền đặt trước
            </a>
          </li>

        {# =========================================================
           MENU: STAFF (GIỮ NGUYÊN NHƯ HIỆN TẠI)
           ========================================================= #}
        {% elif is_staff %}

          {# ===== 1. Dự án & Giao dịch (FULL 1.1-1.3) ===== #}
          <li class="side-title mt-0">1. Dự án & Giao dịch</li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/projects') and not request.url.path.startswith('/projects/payment-accounts') %}active{% endif %}"
               href="/projects">
              <i class="ri-community-line"></i> 1.1 Quản lý dự án
            </a>
          </li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/projects/payment-accounts') %}active{% endif %}"
               href="/projects/payment-accounts">
              <i class="ri-cash-line"></i> 1.2 Cấu hình nhận tiền
            </a>
          </li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/announcements') %}active{% endif %}"
               href="/announcements">
              <i class="ri-megaphone-line"></i> 1.3 Quản lý thông báo
            </a>
          </li>

          {# ===== 2. Giao dịch (CHỈ 2.1-2.2) ===== #}
          <li class="side-title mt-4">2. Giao dịch</li>
          <li>
            <a class="side-link {% if request.url.path == '/transactions/dossiers' %}active{% endif %}"
               href="/transactions/dossiers">
              <i class="ri-file-list-2-line"></i> 2.1 Mua hồ sơ
            </a>
          </li>
          <li>
            <a class="side-link {% if request.url.path == '/transactions/deposits' %}active{% endif %}"
               href="/transactions/deposits">
              <i class="ri-hand-coin-line"></i> 2.2 Đặt cọc
            </a>
          </li>

          {# ===== 4. Khách hàng (FULL 4.0-4.1) ===== #}
          <li class="side-title mt-4">4. Khách hàng</li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/customers') and not request.url.path.startswith('/customers/documents') %}active{% endif %}"
               href="/customers">
              <i class="ri-team-line"></i> 4.0 Danh sách khách
            </a>
          </li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/_admin/customer-documents') %}active{% endif %}"
               href="/_admin/customer-documents">
              <i class="ri-file-shield-2-line"></i> 4.1 Giấy tờ phải nộp
            </a>
          </li>

          {# ===== 5. Phiên Đấu Giá (CHỈ 5.3-5.4) ===== #}
          <li class="side-title mt-4">5. Phiên Đấu Giá</li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/auction/sessions') %}active{% endif %}"
               href="/auction/sessions">
              <i class="ri-auction-line"></i> 5.3 Vận hành phiên
            </a>
          </li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/auction/results') %}active{% endif %}"
               href="/auction/results">
              <i class="ri-auction-line"></i> 5.4 Kết quả trúng đấu giá
            </a>
          </li>

        {# =========================================================
           MENU: VIEWER (CHỈ HIỆN 2.1, 2.2, 4.0, 4.1) - YÊU CẦU MỚI
           ========================================================= #}
        {% elif is_viewer %}

          {# ===== 2. Giao dịch (CHỈ 2.1-2.2) ===== #}
          <li class="side-title mt-0">2. Giao dịch</li>
          <li>
            <a class="side-link {% if request.url.path == '/transactions/dossiers' %}active{% endif %}"
               href="/transactions/dossiers">
              <i class="ri-file-list-2-line"></i> 2.1 Mua hồ sơ
            </a>
          </li>
          <li>
            <a class="side-link {% if request.url.path == '/transactions/deposits' %}active{% endif %}"
               href="/transactions/deposits">
              <i class="ri-hand-coin-line"></i> 2.2 Đặt cọc
            </a>
          </li>

          {# ===== 4. Khách hàng (CHỈ 4.0-4.1) ===== #}
          <li class="side-title mt-4">4. Khách hàng</li>
          <li>
            <a class="side-link {% if request.url.path.startswith('/customers') and not request.url.path.startswith('/customers/documents') %}active{% endif %}"
               href="/customers">
              <i class="ri-team-line"></i> 4.0 Danh sách khách
            </a>
          </li>

        {% endif %}

        {# ===== Tài khoản (mọi role) ===== #}
        <li class="side-title mt-4"></li>
        <li>
          <a class="side-link {% if request.url.path.startswith('/account') %}active{% endif %}"
             href="/account">
            <i class="ri-user-settings-line"></i> Tài khoản
          </a>
        </li>

      </ul>
    </aside>
    {% endif %}

    <main class="app-main flex-1">
      {% block content %}{% endblock %}
    </main>
  </div>

  <!-- ===== Confirm Modal ===== -->
  <div id="app-confirm" class="hidden fixed inset-0 z-[100]">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-xl w-full max-w-md">
        <div class="px-6 py-4 border-b border-slate-100">
          <h3 id="confirm-title" class="text-lg font-semibold text-slate-800">Xác nhận</h3>
        </div>
        <div class="px-6 py-5">
          <p id="confirm-message" class="text-slate-600">Bạn có chắc chắn?</p>
        </div>
        <div class="px-6 py-4 border-t border-slate-100 flex justify-end gap-3">
          <button id="confirm-cancel"
                  class="px-4 py-2 rounded-lg border border-slate-300 text-slate-700 hover:bg-slate-100">
            Cancel
          </button>
          <button id="confirm-ok"
                  class="px-4 py-2 rounded-lg bg-rose-600 text-white hover:bg-rose-700">
            OK
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    window.confirmModal = function ({title = "Xác nhận", message = "Bạn có chắc chắn?"} = {}) {
      return new Promise((resolve) => {
        const wrap = document.getElementById("app-confirm");
        const elTitle = document.getElementById("confirm-title");
        const elMsg = document.getElementById("confirm-message");
        const btnOk = document.getElementById("confirm-ok");
        const btnCancel = document.getElementById("confirm-cancel");

        elTitle.textContent = title;
        elMsg.textContent = message;

        function close() {
          wrap.classList.add("hidden");
          btnOk.removeEventListener("click", onOk);
          btnCancel.removeEventListener("click", onCancel);
          wrap.removeEventListener("click", onBackdrop);
          document.removeEventListener("keydown", onEsc);
        }
        function onOk() { close(); resolve(true); }
        function onCancel() { close(); resolve(false); }
        function onBackdrop(e) { if (e.target === wrap) onCancel(); }
        function onEsc(e) { if (e.key === "Escape") onCancel(); }

        btnOk.addEventListener("click", onOk);
        btnCancel.addEventListener("click", onCancel);
        wrap.addEventListener("click", onBackdrop);
        document.addEventListener("keydown", onEsc);

        wrap.classList.remove("hidden");
      });
    };

    (function bindConfirm() {
      document.querySelectorAll('form[data-confirm]').forEach(function (f) {
        f.addEventListener('submit', async function (e) {
          const msg = f.getAttribute('data-confirm') || 'Bạn có chắc chắn?';
          e.preventDefault();
          const ok = await window.confirmModal({ title: 'Xác nhận', message: msg });
          if (ok) f.submit();
        });
      });
      document.querySelectorAll('[data-confirm-click]').forEach(function (el) {
        el.addEventListener('click', async function (e) {
          const msg = el.getAttribute('data-confirm-click') || 'Bạn có chắc chắn?';
          e.preventDefault();
          const ok = await window.confirmModal({ title: 'Xác nhận', message: msg });
          if (ok) {
            const target = el.getAttribute('data-target-form');
            if (target) document.getElementById(target)?.submit();
          }
        });
      });
    })();
  </script>

  <script>
(function () {
  var el = document.getElementById("appSidebarScroll");
  if (!el) return;

  // role từ cookie (đồng bộ với Jinja)
  var role = (document.cookie.match(/(?:^|;\s*)user_role=([^;]+)/)?.[1] || "VIEWER").toUpperCase();

  // key theo role + pathname + project_code (nếu có)
  var project = (new URLSearchParams(location.search)).get("project_code") || "";
  var pathKey = (location.pathname || "/").replace(/\/+$/, "");
  var key = "SIDEBAR_SCROLL:" + role + ":" + pathKey + ":" + project;

  function restore() {
    try {
      var v = sessionStorage.getItem(key);
      if (v != null) {
        var n = parseInt(v, 10);
        if (!isNaN(n)) el.scrollTop = n;
      }
    } catch (e) {}
  }

  function save() {
    try { sessionStorage.setItem(key, String(el.scrollTop || 0)); } catch (e) {}
  }

  function scrollActiveIntoView() {
    // đảm bảo item active luôn nằm trong vùng nhìn thấy (tránh “nhảy” xuống 2.1)
    var active = el.querySelector("a.side-link.active");
    if (!active) return;
    try {
      active.scrollIntoView({ block: "nearest" });
    } catch (e) {}
  }

  if (history.scrollRestoration) history.scrollRestoration = "manual";

  document.addEventListener("DOMContentLoaded", function () {
    restore();
    // sau khi restore, kéo active vào view để tránh cảm giác nhảy menu
    requestAnimationFrame(function () {
      scrollActiveIntoView();
    });
    setTimeout(function () {
      scrollActiveIntoView();
    }, 50);
  });

  var t = null;
  el.addEventListener("scroll", function () {
    if (t) return;
    t = setTimeout(function () {
      save();
      t = null;
    }, 120);
  }, { passive: true });

  window.addEventListener("beforeunload", save);
})();
</script>

  <style>
    .app-shell {
      display: flex !important;
      gap: 1.25rem;
      align-items: flex-start;
    }
    .app-shell .app-sidebar {
      display: block !important;
      flex: 0 0 16rem;
    }
    .app-shell .app-main {
      flex: 1 1 auto;
      min-width: 0;
    }
  </style>
</body>
</html>