{% extends "base.html" %}
{% block content %}
<style>
  /* ===== Row highlight (matched / unmatched) ===== */
  .txn-row { transition: background-color .12s ease; }
  .txn-row.is-matched { background: #ecfdf5; }     /* emerald-50 */
  .txn-row.is-unmatched { background: #fffbeb; }   /* amber-50 */
  /* ✅ Remove hover gray effect */
  .txn-row:hover { background: inherit; }

  /* ===== Small detail button ===== */
  .btn-mini{
    height: 30px;
    padding: 0 10px;
    border-radius: 10px;
    border: 1px solid #e2e8f0;
    background: #fff;
    color:#0f172a;
    display:inline-flex;
    align-items:center;
    gap:6px;
    font-size:12px;
    white-space:nowrap;
  }
  .btn-mini:hover{ background:#f8fafc; }
  .btn-mini i{ font-size:14px; }

  /* ===== Modal ===== */
  .modal-backdrop{
    position:fixed; inset:0;
    background: rgba(15,23,42,.55);
    display:none;
    align-items:center;
    justify-content:center;
    padding: 18px;
    z-index: 60;
  }
  .modal{
    width: min(980px, 100%);
    background:#fff;
    border-radius:16px;
    overflow:hidden;
    box-shadow: 0 24px 60px rgba(0,0,0,.22);
    border:1px solid #e2e8f0;
  }
  .modal-header{
    padding:14px 16px;
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
    border-bottom:1px solid #eef2f7;
    background: linear-gradient(180deg, #ffffff, #fbfdff);
  }
  .modal-title{
    font-size: 16px;
    font-weight: 700;
    color:#0f172a;
    line-height:1.2;
  }
  .modal-sub{
    font-size:12px;
    color:#64748b;
    margin-top:4px;
  }
  .modal-body{ padding: 16px; }
  .modal-footer{
    padding: 12px 16px;
    border-top:1px solid #eef2f7;
    display:flex;
    justify-content:flex-end;
    gap:10px;
    background:#fff;
  }
  .btn-close{
    height: 36px;
    padding: 0 14px;
    border-radius: 10px;
    border: 1px solid #e2e8f0;
    background:#fff;
  }
  .btn-close:hover{ background:#f8fafc; }

  .kv{
    display:grid;
    grid-template-columns: 160px 1fr;
    gap: 10px 14px;
    font-size: 13px;
  }
  .kv .k{ color:#64748b; }
  .kv .v{ color:#0f172a; font-weight:600; overflow-wrap:anywhere; }
  .chip{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding: 3px 10px;
    border-radius: 999px;
    font-size: 12px;
    border: 1px solid #e2e8f0;
    background:#f8fafc;
    color:#0f172a;
    white-space:nowrap;
  }
  .chip.matched{ background:#ecfdf5; border-color:#bbf7d0; color:#065f46; }
  .chip.unmatched{ background:#fffbeb; border-color:#fde68a; color:#92400e; }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  .grid2{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
  }
  .card{
    border:1px solid #e2e8f0;
    border-radius:14px;
    padding:12px;
    background:#ffffff;
  }
  .card-title{
    font-size:12px;
    color:#64748b;
    margin-bottom:8px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }

  /* ===== Table widths + clamps ===== */
  /* ✅ widen description */
  th.col-desc, td.col-desc{ width: 520px; max-width: 520px; }
  th.col-counter, td.col-counter{ width: 220px; max-width: 220px; }
  th.col-counterinfo, td.col-counterinfo{ width: 260px; max-width: 260px; }

  /* ✅ 3-line clamp for description (show more) */
  .desc-clamp{
    display:-webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow:hidden;
    text-overflow: ellipsis;
    white-space: normal;
    line-height: 1.35;
    max-height: calc(1.35em * 3);
    overflow-wrap:anywhere;
    word-break: break-word;
  }

  /* keep counterinfo 2 lines (clean) */
  .counterinfo-clamp{
    display:-webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow:hidden;
    text-overflow: ellipsis;
    white-space: normal;
    line-height: 1.35;
    max-height: calc(1.35em * 2);
    overflow-wrap:anywhere;
    word-break: break-word;
  }

  /* For long technical strings */
  .mono-wrap{ overflow-wrap:anywhere; word-break: break-word; }

  @media (max-width: 1280px){
    th.col-desc, td.col-desc{ width: 460px; max-width: 460px; }
    th.col-counter, td.col-counter{ width: 210px; max-width: 210px; }
    th.col-counterinfo, td.col-counterinfo{ width: 240px; max-width: 240px; }
  }
  @media (max-width: 1024px){
    th.col-desc, td.col-desc{ width: 380px; max-width: 380px; }
    th.col-counter, td.col-counter{ width: 210px; max-width: 210px; }
    th.col-counterinfo, td.col-counterinfo{ width: 230px; max-width: 230px; }
  }
  @media (max-width: 720px){
    .kv{ grid-template-columns: 120px 1fr; }
    .grid2{ grid-template-columns: 1fr; }
    th.col-desc, td.col-desc{ width: 320px; max-width: 320px; }
    th.col-counter, td.col-counter{ width: 200px; max-width: 200px; }
    th.col-counterinfo, td.col-counterinfo{ width: 230px; max-width: 230px; }
  }
</style>

<div class="bg-white rounded-xl border border-slate-200 p-5">
  <div class="flex items-center justify-between mb-4">
    <div>
      <h2 class="text-xl font-semibold text-slate-800">3.1 Giao dịch ngân hàng</h2>
      <p class="text-slate-500 text-sm">Xem, lọc và tìm kiếm giao dịch theo tài khoản công ty.</p>
    </div>
    <a href="/giao-dich-ngan-hang/import" class="h-10 px-4 rounded-lg bg-emerald-600 text-white flex items-center gap-2">
      <i class="ri-upload-2-line"></i> Import sao kê
    </a>
  </div>

  <!-- Form lọc (không submit, JS sẽ tự fetch) -->
  <form id="filtersForm" class="grid grid-cols-12 gap-3 items-end" onsubmit="return false;">
    <!-- Tài khoản -->
    <div class="col-span-12 md:col-span-4">
      <label class="block text-xs text-slate-500 mb-1">Tài khoản</label>
      <select name="account_id" class="h-10 w-full rounded-lg border border-slate-300 px-3">
        <option value="">— Tất cả tài khoản —</option>
        {% for a in accounts %}
          <option value="{{ a.id }}"
            {% if filters.account_id and (a.id|string) == (filters.account_id|string) %}selected{% endif %}>
            {{ (a.bank_code or '—') }} — {{ a.account_number }} ({{ a.holder_name or a.display_name or '—' }})
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Tìm kiếm -->
    <div class="col-span-12 md:col-span-8">
      <label class="block text-xs text-slate-500 mb-1">Tìm kiếm</label>
      <input name="q" value="{{ filters.q }}"
             placeholder="mô tả / TK đối ứng / TK công ty / counter_name / provider_uid / statement_uid / ref_extracted / ref_no"
             class="h-10 w-full rounded-lg border border-slate-300 px-3"/>
    </div>

    <!-- Từ ngày -->
    <div class="col-span-6 md:col-span-3">
      <label class="block text-xs text-slate-500 mb-1">Từ ngày</label>
      <input type="date" name="date_from" value="{{ filters.date_from }}"
             class="h-10 w-full rounded-lg border border-slate-300 px-3"/>
    </div>

    <!-- Đến ngày -->
    <div class="col-span-6 md:col-span-3">
      <label class="block text-xs text-slate-500 mb-1">Đến ngày</label>
      <input type="date" name="date_to" value="{{ filters.date_to }}"
             class="h-10 w-full rounded-lg border border-slate-300 px-3"/>
    </div>

    <!-- Matched filter -->
    <div class="col-span-6 md:col-span-2">
      <label class="block text-xs text-slate-500 mb-1">Matched</label>
      <select name="matched" class="h-10 w-full rounded-lg border border-slate-300 px-3">
        <option value="ALL" {% if filters.matched == 'ALL' %}selected{% endif %}>— Tất cả —</option>
        <option value="MATCHED" {% if filters.matched == 'MATCHED' %}selected{% endif %}>Đã matched</option>
        <option value="UNMATCHED" {% if filters.matched == 'UNMATCHED' %}selected{% endif %}>Chưa matched</option>
      </select>
    </div>

    <!-- Only no ref_extracted -->
    <div class="col-span-6 md:col-span-3">
      <label class="block text-xs text-slate-500 mb-1">Ref bóc tách</label>
      <div class="h-10 flex items-center gap-2 rounded-lg border border-slate-300 px-3">
        <input type="checkbox" id="no_ref_only" name="no_ref_only" {% if filters.no_ref_only %}checked{% endif %}/>
        <label for="no_ref_only" class="text-sm">Giao dịch trôi nổi</label>
      </div>
    </div>

    <!-- Sort -->
    <div class="col-span-6 md:col-span-2">
      <label class="block text-xs text-slate-500 mb-1">Sắp xếp</label>
      <select name="sort" class="h-10 w-full rounded-lg border border-slate-300 px-3">
        <option value="-txn_time" {% if filters.sort == '-txn_time' %}selected{% endif %}>-txn_time</option>
        <option value="txn_time"  {% if filters.sort == 'txn_time' %}selected{% endif %}>txn_time</option>
        <option value="-amount"   {% if filters.sort == '-amount' %}selected{% endif %}>-amount</option>
        <option value="amount"    {% if filters.sort == 'amount' %}selected{% endif %}>amount</option>
      </select>
    </div>

    <!-- Actions -->
    <div class="col-span-12 md:col-span-2 flex gap-2">
      <a href="/giao-dich-ngan-hang" class="h-10 px-4 rounded-lg border border-slate-300">Reset</a>
    </div>
  </form>

  <!-- Summary -->
  <div id="summary" class="text-sm text-slate-500 mt-3">
    Tổng: {{ page.total }}, Trang: {{ page.page }}/{{ (page.total // page.size) + (1 if page.total % page.size > 0 else 0) }}
  </div>

  <div class="overflow-x-auto border border-slate-200 rounded-lg mt-3">
    <table class="min-w-full text-sm">
      <thead class="bg-slate-50">
        <tr class="text-left text-slate-600">
          <th class="px-3 py-2 border-b w-12">#</th>
          <th class="px-3 py-2 border-b">Thời gian</th>
          <th class="px-3 py-2 border-b text-right">Số tiền</th>
          <th class="px-3 py-2 border-b text-right">Số dư (sau GD)</th>
          <th class="px-3 py-2 border-b col-desc">Mô tả</th>
          <th class="px-3 py-2 border-b">TK công ty</th>
          <th class="px-3 py-2 border-b col-counter">TK đối ứng</th>
          <th class="px-3 py-2 border-b col-counterinfo">Thông tin tài khoản chuyển</th>
          <th class="px-3 py-2 border-b w-24">Chi tiết</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        {% for t in page.data %}
        {% set is_matched = (t.status == 'MATCHED') or (t.matched_receipt_id is not none) %}
        <tr class="txn-row {{ 'is-matched' if is_matched else 'is-unmatched' }}"
            data-txn='{{ t|tojson|safe }}'>
          <td class="px-3 py-2 border-b">{{ loop.index + ((page.page-1) * page.size) }}</td>
          <td class="px-3 py-2 border-b font-mono js-txn-time" data-txntime="{{ t.txn_time or '' }}">{{ t.txn_time or '—' }}</td>

          <!-- Số tiền (SSR) -->
          <td class="px-3 py-2 border-b text-right font-mono js-money-amount"
              data-raw="{{ t.amount }}">{{ t.amount }}</td>

          <!-- Số dư sau GD (SSR) -->
          <td class="px-3 py-2 border-b text-right font-mono js-money-balance"
              data-raw="{{ t.balance_after if t.balance_after is not none else '' }}">
            {{ t.balance_after if t.balance_after is not none else '—' }}
          </td>

          <td class="px-3 py-2 border-b col-desc">
            <div class="desc-clamp" title="{{ t.description or '' }}">{{ t.description or '—' }}</div>
          </td>

          <td class="px-3 py-2 border-b font-mono">
            {{ t.bank_code or '—' }} — {{ t.account_number or '—' }}
          </td>

          <td class="px-3 py-2 border-b font-mono col-counter">
            {% if t.counter_bank_code or t.counter_account %}
              {{ t.counter_bank_code or '—' }} — {{ t.counter_account or '—' }}
              {% if t.counter_bank_short_name %}
                <div class="text-xs text-slate-500 mt-0.5">{{ t.counter_bank_short_name }}</div>
              {% endif %}
            {% else %}
              —
            {% endif %}
          </td>

          <!-- counter_name in list -->
          <td class="px-3 py-2 border-b col-counterinfo">
            <div class="counterinfo-clamp" title="{{ t.counter_name or '' }}">
              {{ t.counter_name or '—' }}
            </div>
          </td>

          <td class="px-3 py-2 border-b">
            <button type="button" class="btn-mini js-detail-btn">
              <i class="ri-information-line"></i> Xem
            </button>
          </td>
        </tr>
        {% endfor %}

        {% if page.data|length == 0 %}
        <tr>
          <td colspan="9" class="px-3 py-6 text-center text-slate-500">Không có giao dịch.</td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  {% set total_pages = (page.total // page.size) + (1 if page.total % page.size > 0 else 0) %}
  <div id="pagination" class="flex justify-end items-center gap-2 mt-4" {% if total_pages <= 1 %}style="display:none"{% endif %}>
    {% set start = page.page - 2 %}
    {% if start < 1 %}{% set start = 1 %}{% endif %}
    {% set end = page.page + 2 %}
    {% if end > total_pages %}{% set end = total_pages %}{% endif %}

    {% if page.page > 1 %}
      <a data-page="{{ page.page-1 }}" class="page-link px-3 h-9 rounded-lg border border-slate-300 bg-white" href="#">←</a>
    {% endif %}

    {% for p in range(start, end + 1) %}
      <a data-page="{{ p }}" class="page-link px-3 h-9 rounded-lg border {{ 'bg-indigo-600 text-white border-indigo-600' if p == page.page else 'bg-white' }}" href="#">
        {{ p }}
      </a>
    {% endfor %}

    {% if page.page < total_pages %}
      <a data-page="{{ page.page+1 }}" class="page-link px-3 h-9 rounded-lg border border-slate-300 bg-white" href="#">→</a>
    {% endif %}
  </div>
</div>

<!-- ======================= DETAIL MODAL ======================= -->
<div id="detailModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="detailTitle">
    <div class="modal-header">
      <div class="min-w-0">
        <div id="detailTitle" class="modal-title">Chi tiết giao dịch</div>
        <div id="detailSub" class="modal-sub">—</div>
      </div>
      <button type="button" class="btn-close js-modal-close"><i class="ri-close-line"></i></button>
    </div>

    <div class="modal-body">
      <div class="grid2">
        <div class="card">
          <div class="card-title">
            <span>Trạng thái & thời gian</span>
            <span id="detailChip" class="chip">—</span>
          </div>
          <div class="kv">
            <div class="k">Thời gian</div>
            <div class="v mono" id="d_txn_time">—</div>

            <div class="k">Số tiền</div>
            <div class="v mono" id="d_amount">—</div>

            <div class="k">Số dư trước</div>
            <div class="v mono" id="d_balance_before">—</div>

            <div class="k">Số dư sau</div>
            <div class="v mono" id="d_balance_after">—</div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">
            <span>Tham chiếu</span>
            <span class="chip mono" id="d_ref_extracted">ref_extracted: —</span>
          </div>
          <div class="kv">
            <div class="k">ref_no</div>
            <div class="v mono mono-wrap" id="d_ref_no">—</div>

            <div class="k">Mô tả</div>
            <div class="v" id="d_desc">—</div>
          </div>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-title">
          <span>Thông tin tài khoản chuyển (đối ứng)</span>
          <span class="text-xs text-slate-500">Nguồn → Đích</span>
        </div>

        <div class="grid2">
          <div class="card" style="border-radius:12px; padding:12px; background:#f8fafc;">
            <div class="kv" style="grid-template-columns: 150px 1fr;">
              <div class="k">TK đối ứng</div>
              <div class="v mono mono-wrap" id="d_from_acc">—</div>

              <div class="k">Tên/Thông tin</div>
              <div class="v mono-wrap" id="d_counter_name">—</div>

              <div class="k">Ngân hàng</div>
              <div class="v mono-wrap" id="d_from_bank">—</div>

              <div class="k">BIN</div>
              <div class="v mono" id="d_counter_bin">—</div>
            </div>
          </div>

          <div class="card" style="border-radius:12px; padding:12px; background:#f8fafc;">
            <div class="kv" style="grid-template-columns: 150px 1fr;">
              <div class="k">TK công ty</div>
              <div class="v mono mono-wrap" id="d_to_acc">—</div>

              <div class="k">Bank code</div>
              <div class="v mono" id="d_to_bank_code">—</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn-close js-modal-close">Đóng</button>
    </div>
  </div>
</div>

<script>
(function() {
  const form = document.getElementById('filtersForm');
  const tableBody = document.getElementById('tableBody');
  const summary = document.getElementById('summary');
  const pagination = document.getElementById('pagination');

  const modalBackdrop = document.getElementById('detailModal');
  const modalCloseBtns = document.querySelectorAll('.js-modal-close');

  let state = {
    page: {{ page.page }},
    size: {{ page.size }},
    q: "{{ filters.q or '' }}",
    account_id: "{{ filters.account_id or '' }}",
    date_from: "{{ filters.date_from or '' }}",
    date_to: "{{ filters.date_to or '' }}",
    matched: "{{ filters.matched or 'ALL' }}",
    no_ref_only: {{ 'true' if filters.no_ref_only else 'false' }},
    sort: "{{ filters.sort or '-txn_time' }}"
  };

  // Formatter (Asia/Bangkok)
  let vnTimeFormatter;
  try {
    vnTimeFormatter = new Intl.DateTimeFormat('en-GB', {
      timeZone: 'Asia/Bangkok',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: false
    });
  } catch (e) {
    vnTimeFormatter = null;
  }

  function formatTxnTime(value) {
    if (!value) return '—';
    const d = new Date(value);
    if (!Number.isFinite(d.getTime())) return value;

    if (!vnTimeFormatter) return value;

    const parts = vnTimeFormatter.formatToParts(d);
    let year='0000', month='00', day='00', hour='00', minute='00', second='00';
    for (const p of parts) {
      if (p.type === 'year') year = p.value;
      else if (p.type === 'month') month = p.value;
      else if (p.type === 'day') day = p.value;
      else if (p.type === 'hour') hour = p.value;
      else if (p.type === 'minute') minute = p.value;
      else if (p.type === 'second') second = p.value;
    }
    return `${year}/${month}/${day} ${hour}:${minute}:${second}`;
  }

  function formatMoneyInt(value) {
    if (value === null || value === undefined) return '—';
    if (value === '—' || value === '') return '—';

    const n = Number(value);
    if (!Number.isFinite(n)) return value;

    const rounded = Math.round(n);
    try {
      return rounded.toLocaleString('vi-VN');
    } catch (e) {
      return String(rounded).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }
  }

  function safeJsonParse(s) {
    try { return JSON.parse(s); } catch (e) { return null; }
  }

  const debounce = (fn, ms=300) => {
    let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
  };

  function buildParams(overrides={}) {
    const p = {
      page: state.page,
      size: state.size,
      sort: state.sort
    };
    if (state.account_id) p.account_id = state.account_id;
    if (state.q) p.q = state.q;

    if (state.date_from) p.date_from = state.date_from;
    if (state.date_to) p.date_to = state.date_to;

    if (state.matched && state.matched !== 'ALL') p.matched = state.matched;
    if (state.no_ref_only) p.no_ref_only = 'true';

    Object.assign(p, overrides);
    return new URLSearchParams(p);
  }

  function rowClass(t){
    const isMatched = (t.status === 'MATCHED') || (t.matched_receipt_id !== null && t.matched_receipt_id !== undefined);
    return isMatched ? 'txn-row is-matched' : 'txn-row is-unmatched';
  }

  function escHtml(s){
    const str = (s === null || s === undefined) ? '' : String(s);
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function renderCounterAccount(t){
    const bankCode = t.counter_bank_code || '—';
    const acc = t.counter_account || '—';
    const shortName = t.counter_bank_short_name || '';
    const line1 = `<span class="mono">${escHtml(bankCode)} — ${escHtml(acc)}</span>`;
    const line2 = shortName ? `<div class="text-xs text-slate-500 mt-0.5">${escHtml(shortName)}</div>` : '';
    return (t.counter_bank_code || t.counter_account) ? (line1 + line2) : '—';
  }

  function renderCounterInfo(t){
    const v = (t.counter_name || '').trim();
    if (!v) return '—';
    return `<div class="counterinfo-clamp" title="${escHtml(v)}">${escHtml(v)}</div>`;
  }

  function renderDesc(t){
    const v = (t.description || '').trim();
    if (!v) return '—';
    return `<div class="desc-clamp" title="${escHtml(v)}">${escHtml(v)}</div>`;
  }

  function render(data) {
    if (!data.data || data.data.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="9" class="px-3 py-6 text-center text-slate-500">Không có giao dịch.</td></tr>`;
    } else {
      tableBody.innerHTML = data.data.map((t, idx) => {
        const rowNo = (data.page - 1) * data.size + idx + 1;

        const time = formatTxnTime(t.txn_time || '');
        const amt  = formatMoneyInt(t.amount);
        const bal  = formatMoneyInt(t.balance_after);

        const bank = t.bank_code || '—';
        const acc  = t.account_number || '—';

        const counterHtml = renderCounterAccount(t);
        const counterInfoHtml = renderCounterInfo(t);
        const descHtml = renderDesc(t);

        const dataJson = (() => {
          try { return JSON.stringify(t).replace(/</g, '\\u003c'); } catch(e){ return '{}'; }
        })();

        return `
          <tr class="${rowClass(t)}" data-txn='${dataJson}'>
            <td class="px-3 py-2 border-b">${rowNo}</td>
            <td class="px-3 py-2 border-b mono">${escHtml(time)}</td>
            <td class="px-3 py-2 border-b text-right mono">${escHtml(amt)}</td>
            <td class="px-3 py-2 border-b text-right mono">${escHtml(bal)}</td>
            <td class="px-3 py-2 border-b col-desc">${descHtml}</td>
            <td class="px-3 py-2 border-b mono">${escHtml(bank)} — ${escHtml(acc)}</td>
            <td class="px-3 py-2 border-b col-counter">${counterHtml}</td>
            <td class="px-3 py-2 border-b col-counterinfo">${counterInfoHtml}</td>
            <td class="px-3 py-2 border-b">
              <button type="button" class="btn-mini js-detail-btn"><i class="ri-information-line"></i> Xem</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    const totalPages = Math.floor(data.total / data.size) + (data.total % data.size > 0 ? 1 : 0);
    summary.textContent = `Tổng: ${data.total}, Trang: ${data.page}/${totalPages}`;
    renderPagination(data.page, totalPages);
    bindDetailButtons();
  }

  function renderPagination(current, totalPages) {
    if (totalPages <= 1) {
      pagination.style.display = 'none';
      pagination.innerHTML = '';
      return;
    }
    pagination.style.display = '';
    const links = [];
    const start = Math.max(1, current - 2);
    const end = Math.min(totalPages, current + 2);

    if (current > 1) {
      links.push(`<a data-page="${current-1}" class="page-link px-3 h-9 rounded-lg border border-slate-300 bg-white" href="#">←</a>`);
    }
    for (let p = start; p <= end; p++) {
      const active = p === current ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white';
      links.push(`<a data-page="${p}" class="page-link px-3 h-9 rounded-lg border ${active}" href="#">${p}</a>`);
    }
    if (current < totalPages) {
      links.push(`<a data-page="${current+1}" class="page-link px-3 h-9 rounded-lg border border-slate-300 bg-white" href="#">→</a>`);
    }
    pagination.innerHTML = links.join('');

    pagination.querySelectorAll('.page-link').forEach(a => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        const p = parseInt(a.getAttribute('data-page'), 10);
        if (Number.isFinite(p)) {
          state.page = p;
          fetchData();
        }
      });
    });
  }

  async function fetchData(overrides = {}) {
    if (overrides.resetPage) {
      state.page = 1;
      delete overrides.resetPage;
    }
    const params = buildParams(overrides);
    const url = `/giao-dich-ngan-hang/data?${params.toString()}`;

    tableBody.innerHTML = `<tr><td colspan="9" class="px-3 py-6 text-center text-slate-500">Đang tải...</td></tr>`;

    try {
      const res = await fetch(url, { credentials: 'same-origin' });
      if (!res.ok) {
        tableBody.innerHTML = `<tr><td colspan="9" class="px-3 py-6 text-center text-rose-600">Lỗi tải dữ liệu (${res.status}).</td></tr>`;
        return;
      }
      const data = await res.json();
      render(data);

      const pageUrl = new URL(window.location.href);
      pageUrl.search = buildParams().toString();
      window.history.replaceState({}, '', pageUrl.toString());
    } catch (e) {
      tableBody.innerHTML = `<tr><td colspan="9" class="px-3 py-6 text-center text-rose-600">Lỗi kết nối.</td></tr>`;
    }
  }

  // ===== Modal helpers =====
  function openModal() {
    modalBackdrop.style.display = 'flex';
    modalBackdrop.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    modalBackdrop.style.display = 'none';
    modalBackdrop.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
  }

  function badgeFor(t){
    const isMatched = (t.status === 'MATCHED') || (t.matched_receipt_id !== null && t.matched_receipt_id !== undefined);
    const chip = document.getElementById('detailChip');
    chip.className = 'chip ' + (isMatched ? 'matched' : 'unmatched');
    chip.textContent = isMatched ? 'Đã matched' : 'Chưa matched';
    return isMatched;
  }

  function setText(id, value){
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = (value === null || value === undefined || value === '') ? '—' : String(value);
  }

  function showTxnDetail(t){
    const time = formatTxnTime(t.txn_time || '');
    const amt = formatMoneyInt(t.amount);
    const after = (t.balance_after === null || t.balance_after === undefined) ? '—' : formatMoneyInt(t.balance_after);

    let before = '—';
    const nAfter = Number(t.balance_after);
    const nAmt = Number(t.amount);
    if (Number.isFinite(nAfter) && Number.isFinite(nAmt)) {
      before = formatMoneyInt(nAfter - nAmt);
    }

    const bankTo = `${t.bank_code || '—'} — ${t.account_number || '—'}`;
    const fromAcc = `${t.counter_bank_code || '—'} — ${t.counter_account || '—'}`;

    const bankNameBits = [];
    if (t.counter_bank_short_name) bankNameBits.push(t.counter_bank_short_name);
    if (t.counter_bank_name) bankNameBits.push(t.counter_bank_name);
    const fromBankLine = [
      (t.counter_bank_code || '—'),
      (bankNameBits.length ? `— ${bankNameBits.join(' / ')}` : ''),
    ].filter(Boolean).join(' ');

    document.getElementById('detailTitle').textContent = 'Chi tiết giao dịch';
    document.getElementById('detailSub').innerHTML = `<span class="mono">${escHtml(bankTo)}</span> • <span class="mono">${escHtml(time)}</span>`;

    badgeFor(t);

    setText('d_txn_time', time);
    setText('d_amount', amt);
    setText('d_balance_before', before);
    setText('d_balance_after', after);

    const refEx = (t.ref_extracted && String(t.ref_extracted).trim()) ? String(t.ref_extracted).trim() : '—';
    document.getElementById('d_ref_extracted').textContent = `ref_extracted: ${refEx}`;

    setText('d_ref_no', t.ref_no || '—');
    setText('d_desc', t.description || '—');

    setText('d_from_acc', fromAcc);
    setText('d_counter_name', (t.counter_name || '').trim() || '—');
    setText('d_from_bank', fromBankLine || '—');
    setText('d_counter_bin', t.counter_bank_bin || '—');

    setText('d_to_acc', bankTo);
    setText('d_to_bank_code', t.bank_code || '—');

    openModal();
  }

  function bindDetailButtons(){
    tableBody.querySelectorAll('.js-detail-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tr = btn.closest('tr');
        if (!tr) return;
        const raw = tr.getAttribute('data-txn') || '{}';
        const t = safeJsonParse(raw);
        if (!t) return;
        showTxnDetail(t);
      });
    });
  }

  // Close modal events
  modalCloseBtns.forEach(b => b.addEventListener('click', closeModal));
  modalBackdrop.addEventListener('click', (e) => {
    if (e.target === modalBackdrop) closeModal();
  });
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modalBackdrop.style.display === 'flex') closeModal();
  });

  // ===== Filters wiring =====
  const onQuickChange = debounce(() => fetchData({ resetPage: true }), 300);

  ['q', 'date_from', 'date_to'].forEach(name => {
    const el = form.querySelector(`[name="${name}"]`);
    if (el) {
      el.addEventListener('input', () => {
        state[name] = el.value || '';
        onQuickChange();
      });
    }
  });

  ['account_id', 'matched', 'sort'].forEach(name => {
    const el = form.querySelector(`[name="${name}"]`);
    if (el) {
      el.addEventListener('change', () => {
        state[name] = el.value || '';
        fetchData({ resetPage: true });
      });
    }
  });

  const elNoRef = form.querySelector('#no_ref_only');
  if (elNoRef) {
    elNoRef.addEventListener('change', () => {
      state.no_ref_only = !!elNoRef.checked;
      fetchData({ resetPage: true });
    });
  }

  // ===== Initial SSR formatting =====
  function applyInitialTimeFormat() {
    const cells = document.querySelectorAll('.js-txn-time');
    cells.forEach(el => {
      const raw = el.getAttribute('data-txntime');
      el.textContent = formatTxnTime(raw);
    });
  }

  function applyInitialMoneyFormat() {
    document.querySelectorAll('.js-money-amount').forEach(el => {
      const raw = el.getAttribute('data-raw') ?? el.textContent;
      el.textContent = formatMoneyInt(raw);
    });
    document.querySelectorAll('.js-money-balance').forEach(el => {
      const raw = el.getAttribute('data-raw') ?? el.textContent;
      el.textContent = formatMoneyInt(raw);
    });
  }

  function bindInitialPagination() {
    if (!pagination) return;
    pagination.querySelectorAll('.page-link').forEach(a => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        const p = parseInt(a.getAttribute('data-page'), 10);
        if (Number.isFinite(p)) {
          state.page = p;
          fetchData();
        }
      });
    });
  }

  applyInitialTimeFormat();
  applyInitialMoneyFormat();
  bindInitialPagination();
  bindDetailButtons(); // SSR rows

})();
</script>
{% endblock %}
