{% extends "base.html" %}
{% block content %}
<div class="bg-white rounded-xl border border-slate-200 p-5">
  <div class="flex items-center justify-between mb-4">
    <div>
      <h2 class="text-xl font-semibold text-slate-800">3.1 Giao dịch ngân hàng</h2>
      <p class="text-slate-500 text-sm">Xem, lọc và tìm kiếm giao dịch theo tài khoản công ty.</p>
    </div>
    <a href="/giao-dich-ngan-hang/import" class="h-10 px-4 rounded-lg bg-emerald-600 text-white flex items-center gap-2">
      <i class="ri-upload-2-line"></i> Import sao kê
    </a>
  </div>

  <!-- Form lọc (không submit, JS sẽ tự fetch) -->
  <form id="filtersForm" class="grid grid-cols-12 gap-3 items-end" onsubmit="return false;">
    <!-- Tài khoản -->
    <div class="col-span-12 md:col-span-5">
      <label class="block text-xs text-slate-500 mb-1">Tài khoản</label>
      <select name="account_id" class="h-10 w-full rounded-lg border border-slate-300 px-3">
        <option value="">— Tất cả tài khoản —</option>
        {% for a in accounts %}
          <option value="{{ a.id }}"
            {% if filters.account_id and (a.id|string) == (filters.account_id|string) %}selected{% endif %}>
            {{ (a.bank_code or '—') }} — {{ a.account_number }} ({{ a.holder_name or a.display_name or '—' }})
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Tìm kiếm -->
    <div class="col-span-12 md:col-span-7">
      <label class="block text-xs text-slate-500 mb-1">Tìm kiếm</label>
      <input name="q" value="{{ filters.q }}"
             placeholder="mô tả / số TK đối ứng / số TK / ref_no / statement_uid"
             class="h-10 w-full rounded-lg border border-slate-300 px-3"/>
    </div>

    <!-- Từ ngày -->
    <div class="col-span-6 md:col-span-3">
      <label class="block text-xs text-slate-500 mb-1">Từ ngày</label>
      <input type="date" name="date_from" value="{{ filters.date_from }}"
             class="h-10 w-full rounded-lg border border-slate-300 px-3"/>
    </div>

    <!-- Đến ngày -->
    <div class="col-span-6 md:col-span-3">
      <label class="block text-xs text-slate-500 mb-1">Đến ngày</label>
      <input type="date" name="date_to" value="{{ filters.date_to }}"
             class="h-10 w-full rounded-lg border border-slate-300 px-3"/>
    </div>

    <!-- Trạng thái -->
    <div class="col-span-6 md:col-span-2">
      <label class="block text-xs text-slate-500 mb-1">Trạng thái</label>
      <select name="status" class="h-10 w-full rounded-lg border border-slate-300 px-3">
        <option value="ALL"  {% if filters.status == 'ALL' %}selected{% endif %}>— Tất cả —</option>
        <option value="OK"   {% if filters.status == 'OK' %}selected{% endif %}>OK</option>
        <option value="PEND" {% if filters.status == 'PEND' %}selected{% endif %}>Chờ đối soát</option>
        <option value="ERR"  {% if filters.status == 'ERR' %}selected{% endif %}>Lỗi</option>
      </select>
    </div>

    <!-- Sort -->
    <div class="col-span-6 md:col-span-2">
      <label class="block text-xs text-slate-500 mb-1">Sắp xếp</label>
      <select name="sort" class="h-10 w-full rounded-lg border border-slate-300 px-3">
        <option value="-txn_time" {% if filters.sort == '-txn_time' %}selected{% endif %}>-txn_time</option>
        <option value="txn_time"  {% if filters.sort == 'txn_time' %}selected{% endif %}>txn_time</option>
        <option value="-amount"   {% if filters.sort == '-amount' %}selected{% endif %}>-amount</option>
        <option value="amount"    {% if filters.sort == 'amount' %}selected{% endif %}>amount</option>
      </select>
    </div>

    <!-- Actions -->
    <div class="col-span-12 md:col-span-2 flex gap-2">
      <a href="/giao-dich-ngan-hang" class="h-10 px-4 rounded-lg border border-slate-300">Reset</a>
    </div>
  </form>

  <!-- Summary -->
  <div id="summary" class="text-sm text-slate-500 mt-3">
    Tổng: {{ page.total }}, Trang: {{ page.page }}/{{ (page.total // page.size) + (1 if page.total % page.size > 0 else 0) }}
  </div>

  <div class="overflow-x-auto border border-slate-200 rounded-lg mt-3">
    <table class="min-w-full text-sm">
      <thead class="bg-slate-50">
        <tr class="text-left text-slate-600">
          <th class="px-3 py-2 border-b w-12">#</th>
          <th class="px-3 py-2 border-b">Thời gian</th>
          <th class="px-3 py-2 border-b text-right">Số tiền</th>
          <th class="px-3 py-2 border-b text-right">Số dư (sau GD)</th> <!-- NEW -->
          <th class="px-3 py-2 border-b">Mô tả</th>
          <th class="px-3 py-2 border-b">TK công ty</th>
          <th class="px-3 py-2 border-b">TK đối ứng</th>
          <th class="px-3 py-2 border-b">Ref</th>
          <!-- ĐÃ BỎ ProviderUID & StatementUID -->
          <th class="px-3 py-2 border-b">Trạng thái</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        {% for t in page.data %}
        <tr>
          <td class="px-3 py-2 border-b">{{ loop.index + ((page.page-1) * page.size) }}</td>
          <td class="px-3 py-2 border-b font-mono">{{ t.txn_time or '—' }}</td>
          <td class="px-3 py-2 border-b text-right font-mono">{{ t.amount }}</td>
          <td class="px-3 py-2 border-b text-right font-mono">{{ t.balance_after if t.balance_after is not none else '—' }}</td> <!-- NEW -->
          <td class="px-3 py-2 border-b">{{ t.description or '—' }}</td>
          <td class="px-3 py-2 border-b font-mono">{{ t.bank_code or '—' }} — {{ t.account_number or '—' }}</td>
          <td class="px-3 py-2 border-b font-mono">{{ t.counter_account or '—' }}</td>
          <td class="px-3 py-2 border-b font-mono">{{ t.ref_no or '—' }}</td>
          <td class="px-3 py-2 border-b">{{ t.status or '—' }}</td>
        </tr>
        {% endfor %}
        {% if page.data|length == 0 %}
        <tr>
          <td colspan="9" class="px-3 py-6 text-center text-slate-500">Không có giao dịch.</td> <!-- colspan 9 -->
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Pagination (AJAX) -->
  {% set total_pages = (page.total // page.size) + (1 if page.total % page.size > 0 else 0) %}
  <div id="pagination" class="flex justify-end items-center gap-2 mt-4" {% if total_pages <= 1 %}style="display:none"{% endif %}>
    {% set start = page.page - 2 %}
    {% if start < 1 %}{% set start = 1 %}{% endif %}
    {% set end = page.page + 2 %}
    {% if end > total_pages %}{% set end = total_pages %}{% endif %}

    {% if page.page > 1 %}
      <a data-page="{{ page.page-1 }}" class="page-link px-3 h-9 rounded-lg border border-slate-300 bg-white" href="#">←</a>
    {% endif %}

    {% for p in range(start, end + 1) %}
      <a data-page="{{ p }}" class="page-link px-3 h-9 rounded-lg border {{ 'bg-indigo-600 text-white border-indigo-600' if p == page.page else 'bg-white' }}" href="#">
        {{ p }}
      </a>
    {% endfor %}

    {% if page.page < total_pages %}
      <a data-page="{{ page.page+1 }}" class="page-link px-3 h-9 rounded-lg border border-slate-300 bg-white" href="#">→</a>
    {% endif %}
  </div>
</div>

<script>
(function() {
  const form = document.getElementById('filtersForm');
  const tableBody = document.getElementById('tableBody');
  const summary = document.getElementById('summary');
  const pagination = document.getElementById('pagination');

  let state = {
    page: {{ page.page }},
    size: {{ page.size }},      // mặc định 50 từ backend
    q: "{{ filters.q or '' }}",
    account_id: "{{ filters.account_id or '' }}",
    date_from: "{{ filters.date_from or '' }}",
    date_to: "{{ filters.date_to or '' }}",
    status: "{{ filters.status or 'ALL' }}",
    sort: "{{ filters.sort or '-txn_time' }}"
  };

  const debounce = (fn, ms=300) => {
    let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
  };

  function buildParams(overrides={}) {
    const p = {
      page: state.page,
      size: state.size,
      sort: state.sort
    };
    if (state.account_id) p.account_id = state.account_id;
    if (state.q) p.q = state.q;
    if (state.date_from) p.date_from = state.date_from;
    if (state.date_to) p.date_to = state.date_to;
    if (state.status && state.status !== 'ALL') p.status = state.status;

    Object.assign(p, overrides);
    return new URLSearchParams(p);
  }

  async function fetchData(overrides = {}) {
    if (overrides.resetPage) {
      state.page = 1;
      delete overrides.resetPage;
    }
    const params = buildParams(overrides);
    const url = `/giao-dich-ngan-hang/data?${params.toString()}`;

    tableBody.innerHTML = `<tr><td colspan="9" class="px-3 py-6 text-center text-slate-500">Đang tải...</td></tr>`; // colspan 9

    try {
      const res = await fetch(url, { credentials: 'same-origin' });
      if (!res.ok) {
        tableBody.innerHTML = `<tr><td colspan="9" class="px-3 py-6 text-center text-rose-600">Lỗi tải dữ liệu (${res.status}).</td></tr>`;
        return;
      }
      const data = await res.json();
      render(data);

      // cập nhật URL hiện tại (để back/forward + share link)
      const pageUrl = new URL(window.location.href);
      pageUrl.search = buildParams().toString();
      window.history.replaceState({}, '', pageUrl.toString());
    } catch (e) {
      tableBody.innerHTML = `<tr><td colspan="9" class="px-3 py-6 text-center text-rose-600">Lỗi kết nối.</td></tr>`;
    }
  }

  function render(data) {
    if (!data.data || data.data.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="9" class="px-3 py-6 text-center text-slate-500">Không có giao dịch.</td></tr>`;
    } else {
      tableBody.innerHTML = data.data.map((t, idx) => {
        const rowNo = (data.page - 1) * data.size + idx + 1;
        const bank = t.bank_code || '—';
        const acc  = t.account_number || '—';
        const counter = t.counter_account || t.counter_account_no || '—';
        const amt  = (t.amount ?? '—');
        const bal  = (t.balance_after ?? '—');   // NEW
        const time = t.txn_time || '—';
        const desc = t.description || '—';
        const ref  = t.ref_no || '—';
        const st   = t.status || '—';
        return `
          <tr>
            <td class="px-3 py-2 border-b">${rowNo}</td>
            <td class="px-3 py-2 border-b font-mono">${time}</td>
            <td class="px-3 py-2 border-b text-right font-mono">${amt}</td>
            <td class="px-3 py-2 border-b text-right font-mono">${bal}</td>
            <td class="px-3 py-2 border-b">${desc}</td>
            <td class="px-3 py-2 border-b font-mono">${bank} — ${acc}</td>
            <td class="px-3 py-2 border-b font-mono">${counter}</td>
            <td class="px-3 py-2 border-b font-mono">${ref}</td>
            <td class="px-3 py-2 border-b">${st}</td>
          </tr>
        `;
      }).join('');
    }

    const totalPages = Math.floor(data.total / data.size) + (data.total % data.size > 0 ? 1 : 0);
    summary.textContent = `Tổng: ${data.total}, Trang: ${data.page}/${totalPages}`;

    renderPagination(data.page, totalPages);
  }

  function renderPagination(current, totalPages) {
    if (totalPages <= 1) {
      pagination.style.display = 'none';
    } else {
      pagination.style.display = '';
    }
    const links = [];
    const start = Math.max(1, current - 2);
    const end = Math.min(totalPages, current + 2);

    if (current > 1) {
      links.push(`<a data-page="${current-1}" class="page-link px-3 h-9 rounded-lg border border-slate-300 bg-white" href="#">←</a>`);
    }
    for (let p = start; p <= end; p++) {
      const active = p === current ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white';
      links.push(`<a data-page="${p}" class="page-link px-3 h-9 rounded-lg border ${active}" href="#">${p}</a>`);
    }
    if (current < totalPages) {
      links.push(`<a data-page="${current+1}" class="page-link px-3 h-9 rounded-lg border border-slate-300 bg-white" href="#">→</a>`);
    }
    pagination.innerHTML = links.join('');

    pagination.querySelectorAll('.page-link').forEach(a => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        const p = parseInt(a.getAttribute('data-page'), 10);
        if (Number.isFinite(p)) {
          fetchData({ page: p });
          // giữ state.page đồng bộ
          state.page = p;
        }
      });
    });
  }

  // Lắng nghe thay đổi bộ lọc (auto update)
  const onQuickChange = debounce(() => fetchData({ resetPage: true }), 300);

  ['q', 'date_from', 'date_to'].forEach(name => {
    const el = form.querySelector(`[name="${name}"]`);
    if (el) {
      el.addEventListener('input', () => {
        state[name] = el.value || '';
        onQuickChange();
      });
    }
  });

  ['account_id', 'status', 'sort'].forEach(name => {
    const el = form.querySelector(`[name="${name}"]`);
    if (el) {
      el.addEventListener('change', () => {
        state[name] = el.value || '';
        fetchData({ resetPage: true });
      });
    }
  });

  // Trang đã SSR sẵn; không auto fetch lại khi load.
})();
</script>
{% endblock %}
