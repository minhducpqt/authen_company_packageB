{% extends "base.html" %}
{% block content %}
<div class="bg-white rounded-xl border border-slate-200 p-5">
  <div class="flex items-center justify-between mb-4">
    <div>
      <h2 class="text-xl font-semibold text-slate-800">3.1 Giao dịch ngân hàng</h2>
      <p class="text-slate-500 text-sm">Xem, lọc và tìm kiếm giao dịch theo tài khoản công ty.</p>
    </div>
    <a href="/giao-dich-ngan-hang/import" class="h-10 px-4 rounded-lg bg-emerald-600 text-white flex items-center gap-2">
      <i class="ri-upload-2-line"></i> Import sao kê
    </a>
  </div>

  <!-- Form lọc (không submit, JS sẽ tự fetch) -->
  <form id="filtersForm" class="grid grid-cols-12 gap-3 items-end" onsubmit="return false;">
    <!-- Tài khoản -->
    <div class="col-span-12 md:col-span-4">
      <label class="block text-xs text-slate-500 mb-1">Tài khoản</label>
      <select name="account_id" class="h-10 w-full rounded-lg border border-slate-300 px-3">
        <option value="">— Tất cả tài khoản —</option>
        {% for a in accounts %}
          <option value="{{ a.id }}"
            {% if filters.account_id and (a.id|string) == (filters.account_id|string) %}selected{% endif %}>
            {{ (a.bank_code or '—') }} — {{ a.account_number }} ({{ a.holder_name or a.display_name or '—' }})
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Tìm kiếm -->
    <div class="col-span-12 md:col-span-8">
      <label class="block text-xs text-slate-500 mb-1">Tìm kiếm</label>
      <input name="q" value="{{ filters.q }}"
             placeholder="mô tả / số TK đối ứng / số TK / ref_no / statement_uid / ref_extracted"
             class="h-10 w-full rounded-lg border border-slate-300 px-3"/>
    </div>

    <!-- Từ ngày -->
    <div class="col-span-6 md:col-span-3">
      <label class="block text-xs text-slate-500 mb-1">Từ ngày</label>
      <input type="date" name="date_from" value="{{ filters.date_from }}"
             class="h-10 w-full rounded-lg border border-slate-300 px-3"/>
    </div>

    <!-- Đến ngày -->
    <div class="col-span-6 md:col-span-3">
      <label class="block text-xs text-slate-500 mb-1">Đến ngày</label>
      <input type="date" name="date_to" value="{{ filters.date_to }}"
             class="h-10 w-full rounded-lg border border-slate-300 px-3"/>
    </div>

    <!-- Trạng thái (legacy) -->
    <div class="col-span-6 md:col-span-2">
      <label class="block text-xs text-slate-500 mb-1">Trạng thái</label>
      <select name="status" class="h-10 w-full rounded-lg border border-slate-300 px-3">
        <option value="ALL"  {% if filters.status == 'ALL' %}selected{% endif %}>— Tất cả —</option>
        <option value="OK"   {% if filters.status == 'OK' %}selected{% endif %}>OK</option>
        <option value="PEND" {% if filters.status == 'PEND' %}selected{% endif %}>Chờ đối soát</option>
        <option value="ERR"  {% if filters.status == 'ERR' %}selected{% endif %}>Lỗi</option>
      </select>
    </div>

    <!-- NEW: Matched filter -->
    <div class="col-span-6 md:col-span-2">
      <label class="block text-xs text-slate-500 mb-1">Matched</label>
      <select name="matched" class="h-10 w-full rounded-lg border border-slate-300 px-3">
        <option value="ALL" {% if filters.matched == 'ALL' %}selected{% endif %}>— Tất cả —</option>
        <option value="MATCHED" {% if filters.matched == 'MATCHED' %}selected{% endif %}>Đã matched</option>
        <option value="UNMATCHED" {% if filters.matched == 'UNMATCHED' %}selected{% endif %}>Chưa matched</option>
      </select>
    </div>

    <!-- NEW: Only no ref_extracted -->
    <div class="col-span-6 md:col-span-2">
      <label class="block text-xs text-slate-500 mb-1">Ref bóc tách</label>
      <div class="h-10 flex items-center gap-2 rounded-lg border border-slate-300 px-3">
        <input type="checkbox" id="no_ref_only" name="no_ref_only" {% if filters.no_ref_only %}checked{% endif %}/>
        <label for="no_ref_only" class="text-sm">Chỉ giao dịch không có ref_extracted</label>
      </div>
    </div>

    <!-- Sort -->
    <div class="col-span-6 md:col-span-2">
      <label class="block text-xs text-slate-500 mb-1">Sắp xếp</label>
      <select name="sort" class="h-10 w-full rounded-lg border border-slate-300 px-3">
        <option value="-txn_time" {% if filters.sort == '-txn_time' %}selected{% endif %}>-txn_time</option>
        <option value="txn_time"  {% if filters.sort == 'txn_time' %}selected{% endif %}>txn_time</option>
        <option value="-amount"   {% if filters.sort == '-amount' %}selected{% endif %}>-amount</option>
        <option value="amount"    {% if filters.sort == 'amount' %}selected{% endif %}>amount</option>
      </select>
    </div>

    <!-- Actions -->
    <div class="col-span-12 md:col-span-2 flex gap-2">
      <a href="/giao-dich-ngan-hang" class="h-10 px-4 rounded-lg border border-slate-300">Reset</a>
    </div>
  </form>

  <!-- Summary -->
  <div id="summary" class="text-sm text-slate-500 mt-3">
    Tổng: {{ page.total }}, Trang: {{ page.page }}/{{ (page.total // page.size) + (1 if page.total % page.size > 0 else 0) }}
  </div>

  <div class="overflow-x-auto border border-slate-200 rounded-lg mt-3">
    <table class="min-w-full text-sm">
      <thead class="bg-slate-50">
        <tr class="text-left text-slate-600">
          <th class="px-3 py-2 border-b w-12">#</th>
          <th class="px-3 py-2 border-b">Thời gian</th>
          <th class="px-3 py-2 border-b text-right">Số tiền</th>
          <th class="px-3 py-2 border-b text-right">Số dư (sau GD)</th>
          <th class="px-3 py-2 border-b">Mô tả</th>
          <th class="px-3 py-2 border-b">TK công ty</th>
          <th class="px-3 py-2 border-b">TK đối ứng</th>
          <th class="px-3 py-2 border-b">Ref</th>
          <th class="px-3 py-2 border-b">Trạng thái</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        {% for t in page.data %}
        <tr>
          <td class="px-3 py-2 border-b">{{ loop.index + ((page.page-1) * page.size) }}</td>
          <td class="px-3 py-2 border-b font-mono js-txn-time" data-txntime="{{ t.txn_time or '' }}">{{ t.txn_time or '—' }}</td>
          <!-- Số tiền (SSR) -->
          <td class="px-3 py-2 border-b text-right font-mono js-money-amount"
              data-raw="{{ t.amount }}">{{ t.amount }}</td>
          <!-- Số dư sau GD (SSR) -->
          <td class="px-3 py-2 border-b text-right font-mono js-money-balance"
              data-raw="{{ t.balance_after if t.balance_after is not none else '' }}">
            {{ t.balance_after if t.balance_after is not none else '—' }}
          </td>
          <td class="px-3 py-2 border-b">{{ t.description or '—' }}</td>
          <td class="px-3 py-2 border-b font-mono">{{ t.bank_code or '—' }} — {{ t.account_number or '—' }}</td>
          <td class="px-3 py-2 border-b font-mono">{{ t.counter_account or '—' }}</td>
          <td class="px-3 py-2 border-b font-mono">{{ t.ref_no or '—' }}</td>
          <td class="px-3 py-2 border-b">{{ t.status or '—' }}</td>
        </tr>
        {% endfor %}
        {% if page.data|length == 0 %}
        <tr>
          <td colspan="9" class="px-3 py-6 text-center text-slate-500">Không có giao dịch.</td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  {% set total_pages = (page.total // page.size) + (1 if page.total % page.size > 0 else 0) %}
  <div id="pagination" class="flex justify-end items-center gap-2 mt-4" {% if total_pages <= 1 %}style="display:none"{% endif %}>
    {% set start = page.page - 2 %}
    {% if start < 1 %}{% set start = 1 %}{% endif %}
    {% set end = page.page + 2 %}
    {% if end > total_pages %}{% set end = total_pages %}{% endif %}

    {% if page.page > 1 %}
      <a data-page="{{ page.page-1 }}" class="page-link px-3 h-9 rounded-lg border border-slate-300 bg-white" href="#">←</a>
    {% endif %}

    {% for p in range(start, end + 1) %}
      <a data-page="{{ p }}" class="page-link px-3 h-9 rounded-lg border {{ 'bg-indigo-600 text-white border-indigo-600' if p == page.page else 'bg-white' }}" href="#">
        {{ p }}
      </a>
    {% endfor %}

    {% if page.page < total_pages %}
      <a data-page="{{ page.page+1 }}" class="page-link px-3 h-9 rounded-lg border border-slate-300 bg-white" href="#">→</a>
    {% endif %}
  </div>
</div>

<script>
(function() {
  const form = document.getElementById('filtersForm');
  const tableBody = document.getElementById('tableBody');
  const summary = document.getElementById('summary');
  const pagination = document.getElementById('pagination');

  let state = {
    page: {{ page.page }},
    size: {{ page.size }},
    q: "{{ filters.q or '' }}",
    account_id: "{{ filters.account_id or '' }}",
    date_from: "{{ filters.date_from or '' }}",
    date_to: "{{ filters.date_to or '' }}",
    status: "{{ filters.status or 'ALL' }}",
    matched: "{{ filters.matched or 'ALL' }}",
    no_ref_only: {{ 'true' if filters.no_ref_only else 'false' }},
    sort: "{{ filters.sort or '-txn_time' }}"
  };

  // Formatter cho múi giờ Việt Nam (Asia/Bangkok)
  let vnTimeFormatter;
  try {
    vnTimeFormatter = new Intl.DateTimeFormat('en-GB', {
      timeZone: 'Asia/Bangkok',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: false
    });
  } catch (e) {
    vnTimeFormatter = null;
  }

  function formatTxnTime(value) {
    if (!value) return '—';
    const d = new Date(value);
    if (!Number.isFinite(d.getTime())) return value;

    if (!vnTimeFormatter) {
      // Fallback nếu Intl/timeZone không hỗ trợ
      return value;
    }

    const parts = vnTimeFormatter.formatToParts(d);
    let year = '0000', month = '00', day = '00', hour = '00', minute = '00', second = '00';

    for (const p of parts) {
      if (p.type === 'year') year = p.value;
      else if (p.type === 'month') month = p.value;
      else if (p.type === 'day') day = p.value;
      else if (p.type === 'hour') hour = p.value;
      else if (p.type === 'minute') minute = p.value;
      else if (p.type === 'second') second = p.value;
    }
    return `${year}/${month}/${day} ${hour}:${minute}:${second}`;
  }

  // ===== FORMAT SỐ TIỀN: số nguyên + ngăn cách hàng nghìn =====
  function formatMoneyInt(value) {
    if (value === null || value === undefined) return '—';
    if (value === '—' || value === '') return '—';

    const n = Number(value);
    if (!Number.isFinite(n)) return value;

    const rounded = Math.round(n); // đảm bảo không có phần thập phân
    try {
      return rounded.toLocaleString('vi-VN'); // 1.234.567.890
    } catch (e) {
      // Fallback nếu môi trường không hỗ trợ locale
      return String(rounded).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }
  }

  const debounce = (fn, ms=300) => {
    let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
  };

  function buildParams(overrides={}) {
    const p = {
      page: state.page,
      size: state.size,
      sort: state.sort
    };
    if (state.account_id) p.account_id = state.account_id;
    if (state.q) p.q = state.q;
    if (state.date_from) p.date_from = state.date_from;
    if (state.date_to) p.date_to = state.date_to;
    if (state.status && state.status !== 'ALL') p.status = state.status;

    // NEW filters
    if (state.matched && state.matched !== 'ALL') p.matched = state.matched;
    if (state.no_ref_only) p.no_ref_only = 'true';

    Object.assign(p, overrides);
    return new URLSearchParams(p);
  }

  async function fetchData(overrides = {}) {
    if (overrides.resetPage) {
      state.page = 1;
      delete overrides.resetPage;
    }
    const params = buildParams(overrides);
    const url = `/giao-dich-ngan-hang/data?${params.toString()}`;

    tableBody.innerHTML = `<tr><td colspan="9" class="px-3 py-6 text-center text-slate-500">Đang tải...</td></tr>`;

    try {
      const res = await fetch(url, { credentials: 'same-origin' });
      if (!res.ok) {
        tableBody.innerHTML = `<tr><td colspan="9" class="px-3 py-6 text-center text-rose-600">Lỗi tải dữ liệu (${res.status}).</td></tr>`;
        return;
      }
      const data = await res.json();
      render(data);

      const pageUrl = new URL(window.location.href);
      pageUrl.search = buildParams().toString();
      window.history.replaceState({}, '', pageUrl.toString());
    } catch (e) {
      tableBody.innerHTML = `<tr><td colspan="9" class="px-3 py-6 text-center text-rose-600">Lỗi kết nối.</td></tr>`;
    }
  }

  function render(data) {
    if (!data.data || data.data.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="9" class="px-3 py-6 text-center text-slate-500">Không có giao dịch.</td></tr>`;
    } else {
      tableBody.innerHTML = data.data.map((t, idx) => {
        const rowNo = (data.page - 1) * data.size + idx + 1;
        const bank = t.bank_code || '—';
        const acc  = t.account_number || '—';
        const counter = t.counter_account || t.counter_account_no || '—';
        const amt  = formatMoneyInt(t.amount);
        const bal  = formatMoneyInt(t.balance_after);
        const timeRaw = t.txn_time || '';
        const time = formatTxnTime(timeRaw);
        const desc = t.description || '—';
        const ref  = t.ref_no || '—';
        const st   = t.status || '—';
        return `
          <tr>
            <td class="px-3 py-2 border-b">${rowNo}</td>
            <td class="px-3 py-2 border-b font-mono">${time}</td>
            <td class="px-3 py-2 border-b text-right font-mono">${amt}</td>
            <td class="px-3 py-2 border-b text-right font-mono">${bal}</td>
            <td class="px-3 py-2 border-b">${desc}</td>
            <td class="px-3 py-2 border-b font-mono">${bank} — ${acc}</td>
            <td class="px-3 py-2 border-b font-mono">${counter}</td>
            <td class="px-3 py-2 border-b font-mono">${ref}</td>
            <td class="px-3 py-2 border-b">${st}</td>
          </tr>
        `;
      }).join('');
    }

    const totalPages = Math.floor(data.total / data.size) + (data.total % data.size > 0 ? 1 : 0);
    summary.textContent = `Tổng: ${data.total}, Trang: ${data.page}/${totalPages}`;
    renderPagination(data.page, totalPages);
  }

  function renderPagination(current, totalPages) {
    if (totalPages <= 1) {
      pagination.style.display = 'none';
      pagination.innerHTML = '';
      return;
    }
    pagination.style.display = '';
    const links = [];
    const start = Math.max(1, current - 2);
    const end = Math.min(totalPages, current + 2);

    if (current > 1) {
      links.push(`<a data-page="${current-1}" class="page-link px-3 h-9 rounded-lg border border-slate-300 bg-white" href="#">←</a>`);
    }
    for (let p = start; p <= end; p++) {
      const active = p === current ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white';
      links.push(`<a data-page="${p}" class="page-link px-3 h-9 rounded-lg border ${active}" href="#">${p}</a>`);
    }
    if (current < totalPages) {
      links.push(`<a data-page="${current+1}" class="page-link px-3 h-9 rounded-lg border border-slate-300 bg-white" href="#">→</a>`);
    }
    pagination.innerHTML = links.join('');

    pagination.querySelectorAll('.page-link').forEach(a => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        const p = parseInt(a.getAttribute('data-page'), 10);
        if (Number.isFinite(p)) {
          state.page = p;
          fetchData();
        }
      });
    });
  }

  // ✅ FIX: bind click cho pagination SSR ban đầu (page 1 2 3 ... render sẵn)
  function bindInitialPagination() {
    if (!pagination) return;
    pagination.querySelectorAll('.page-link').forEach(a => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        const p = parseInt(a.getAttribute('data-page'), 10);
        if (Number.isFinite(p)) {
          state.page = p;
          fetchData();
        }
      });
    });
  }

  // Lắng nghe thay đổi bộ lọc (auto update)
  const onQuickChange = debounce(() => fetchData({ resetPage: true }), 300);

  ['q', 'date_from', 'date_to'].forEach(name => {
    const el = form.querySelector(`[name="${name}"]`);
    if (el) {
      el.addEventListener('input', () => {
        state[name] = el.value || '';
        onQuickChange();
      });
    }
  });

  // Selects
  ['account_id', 'status', 'matched', 'sort'].forEach(name => {
    const el = form.querySelector(`[name="${name}"]`);
    if (el) {
      el.addEventListener('change', () => {
        state[name] = el.value || '';
        fetchData({ resetPage: true });
      });
    }
  });

  // Checkbox: no_ref_only
  const elNoRef = form.querySelector('#no_ref_only');
  if (elNoRef) {
    elNoRef.addEventListener('change', () => {
      state.no_ref_only = !!elNoRef.checked;
      fetchData({ resetPage: true });
    });
  }

  // Áp dụng format thời gian cho các dòng SSR ban đầu
  function applyInitialTimeFormat() {
    const cells = document.querySelectorAll('.js-txn-time');
    cells.forEach(el => {
      const raw = el.getAttribute('data-txntime');
      el.textContent = formatTxnTime(raw);
    });
  }

  // Áp dụng format tiền cho các dòng SSR ban đầu
  function applyInitialMoneyFormat() {
    const amountCells = document.querySelectorAll('.js-money-amount');
    amountCells.forEach(el => {
      const raw = el.getAttribute('data-raw') ?? el.textContent;
      el.textContent = formatMoneyInt(raw);
    });

    const balanceCells = document.querySelectorAll('.js-money-balance');
    balanceCells.forEach(el => {
      const raw = el.getAttribute('data-raw') ?? el.textContent;
      el.textContent = formatMoneyInt(raw);
    });
  }

  applyInitialTimeFormat();
  applyInitialMoneyFormat();

  // ✅ FIX: gọi bind cho pagination SSR ban đầu
  bindInitialPagination();

  // Trang đã SSR sẵn; không auto fetch lại khi load.
})();
</script>
{% endblock %}
