{# pages/bid_attendance/detail.html #}
{% extends "base.html" %}
{% block content %}
<div class="bg-white rounded-xl border border-slate-200 p-5">
  <div class="flex items-center justify-between mb-4">
    <div>
      <h2 class="text-xl font-semibold text-slate-800">Chi tiết điểm danh</h2>
      <p class="text-slate-500 text-sm">
        Quản lý loại theo <b>lô</b> hoặc <b>toàn bộ lô</b> của khách. Thao tác “Loại” là hiếm gặp và yêu cầu xác nhận nhiều bước.
      </p>
    </div>
    <div class="flex items-center gap-2">
      <a
        href="/bid-attendance?project_code={{ project_code }}"
        class="topbtn border border-slate-300 bg-white text-slate-700"
      >
        ← Quay lại danh sách
      </a>
      <a href="/projects" class="topbtn border border-slate-300 bg-white text-slate-700">
        Quản lý dự án
      </a>
    </div>
  </div>

  {# NOTE: Service B router dùng err/ok query param #}
  {% if err %}
    <div class="mb-4 p-3 rounded-lg bg-amber-50 border border-amber-200 text-amber-800 text-sm">
      <i class="ri-alert-line mr-1"></i>{{ err }}
    </div>
  {% endif %}

  {% if ok %}
    <div class="mb-4 p-3 rounded-lg bg-emerald-50 border border-emerald-200 text-emerald-800 text-sm">
      <i class="ri-checkbox-circle-line mr-1"></i>{{ ok }}
    </div>
  {% endif %}

  {% if load_err %}
    <div class="mb-4 p-3 rounded-lg bg-rose-50 border border-rose-200 text-rose-700 text-sm">
      <i class="ri-error-warning-line mr-1"></i>{{ load_err }}
    </div>
  {% endif %}

  {% if not load_err %}
    {# ============================================================
       IMPORTANT:
       - lots: danh sách AUTO gốc (bao gồm cả lô đã bị loại để đối soát)
       - excluded_lot_ids: danh sách lot_id đang bị loại (hiệu lực)
       => count nên tính theo lots + excluded_lot_ids để luôn đúng
       ============================================================ #}

    {# ---------- counts ---------- #}
    {% set _auto_count = (lots|length) %}
    {% set _excluded_count = (excluded_lot_ids|length) %}
    {% set _remaining_count = (_auto_count - _excluded_count) %}
    {% set _is_customer_excluded = (_auto_count > 0 and _remaining_count <= 0) %}

    {# ---------- map exclusions by lot_id (for inline reason display) ---------- #}
    {% set ns = namespace(ex_by_lot_id={}) %}
    {% if summary and summary.exclusions %}
      {% for ex in summary.exclusions %}
        {% if ex and ex.lot_id is not none %}
          {% set _ = ns.ex_by_lot_id.update({ (ex.lot_id|string): ex }) %}
        {% endif %}
      {% endfor %}
    {% endif %}

    <!-- SUMMARY CARD -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <!-- Left: customer -->
      <div class="lg:col-span-2 border border-slate-200 rounded-xl p-4">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-xs text-slate-500">Khách hàng</div>
            <div class="text-lg font-semibold text-slate-900">
              {{ customer.customer_full_name or "—" }}
            </div>
            <div class="mt-1 text-sm text-slate-600 flex flex-wrap gap-x-4 gap-y-1">
              <div><span class="text-slate-500">CCCD:</span> <span class="font-mono">{{ customer.cccd or "—" }}</span></div>
              <div><span class="text-slate-500">SĐT:</span> <span class="font-mono">{{ customer.phone or "—" }}</span></div>
              <div><span class="text-slate-500">Email:</span> <span class="font-mono">{{ customer.email or "—" }}</span></div>
            </div>
            <div class="mt-2 text-sm text-slate-600">
              <span class="text-slate-500">Địa chỉ:</span> {{ customer.address or "—" }}
            </div>
          </div>

          <!-- Badge -->
          <div class="shrink-0 text-right">
            {% if _is_customer_excluded %}
              <div class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-rose-50 border border-rose-200 text-rose-700 text-xs font-semibold">
                <i class="ri-forbid-2-line"></i> ĐÃ BỊ LOẠI (HẾT LÔ HỢP LỆ)
              </div>
            {% else %}
              <div class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-emerald-50 border border-emerald-200 text-emerald-700 text-xs font-semibold">
                <i class="ri-checkbox-circle-line"></i> CÒN LÔ HỢP LỆ
              </div>
            {% endif %}
            <div class="mt-1 text-[11px] text-slate-500">
              STT: <span class="font-mono">{{ customer.stt_padded or customer.stt or "—" }}</span>
            </div>
          </div>
        </div>

        <!-- project -->
        <div class="mt-4 border-t border-slate-200 pt-3 text-sm text-slate-600">
          <div class="flex flex-wrap gap-x-6 gap-y-1">
            <div>
              <span class="text-slate-500">Dự án:</span>
              <span class="font-mono">{{ customer.project_code or project_code }}</span>
              — {{ customer.project_name or "—" }}
            </div>

            <div>
              <span class="text-slate-500">Tổng lô đủ điều kiện (auto):</span>
              <span class="font-semibold">{{ _auto_count }}</span>
            </div>

            <div>
              <span class="text-slate-500">Đã loại:</span>
              <span class="font-semibold text-rose-700">{{ _excluded_count }}</span>
            </div>

            <div>
              <span class="text-slate-500">Còn hợp lệ:</span>
              <span class="font-semibold text-emerald-700">{{ _remaining_count }}</span>
            </div>
          </div>

          <div class="mt-3 p-3 rounded-lg bg-slate-50 border border-slate-200 text-slate-700 text-sm">
            <div class="font-semibold flex items-center gap-2">
              <i class="ri-information-line"></i>
              Ghi chú nghiệp vụ
            </div>
            <div class="mt-1 text-[13px] leading-6 text-slate-600">
              - Loại theo <b>lô</b>: chỉ loại lô đó, các lô khác vẫn hợp lệ.<br/>
              - Loại <b>khách</b>: loại <b>toàn bộ</b> các lô hợp lệ hiện tại của khách trong dự án.<br/>
              - Thao tác này <b>không thay đổi dữ liệu thanh toán</b>, chỉ ảnh hưởng danh sách điểm danh thực tế.
            </div>
          </div>

          {% if summary and summary.exclusions and (summary.exclusions|length > 0) %}
            <div class="mt-3 p-3 rounded-lg bg-rose-50 border border-rose-200 text-rose-800 text-sm">
              <div class="font-semibold flex items-center gap-2">
                <i class="ri-shield-cross-line"></i>
                Lịch sử loại đang hiệu lực (theo lô)
              </div>
              <div class="mt-2 text-[12px] text-rose-900/80">
                {% for ex in summary.exclusions %}
                  <div class="flex flex-wrap gap-x-4 gap-y-1 border-t border-rose-200/60 pt-2 mt-2 first:border-t-0 first:pt-0 first:mt-0">
                    <div>
                      <span class="text-rose-700">lot_id:</span>
                      <span class="font-mono">{{ ex.lot_id }}</span>
                    </div>
                    <div>
                      <span class="text-rose-700">lý do:</span>
                      <span class="font-medium">{{ ex.reason or "—" }}</span>
                    </div>
                    <div class="text-rose-700/90">
                      bởi <span class="font-mono">{{ ex.set_by or "—" }}</span>
                      · lúc <span class="font-mono">{{ ex.set_at or "—" }}</span>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Right: actions -->
      <div class="border border-slate-200 rounded-xl p-4">
        <div class="text-sm font-semibold text-slate-800 mb-2">Thao tác nhanh</div>

        {% if _auto_count == 0 %}
          <div class="p-3 rounded-lg bg-slate-50 border border-slate-200 text-slate-600 text-sm">
            Không có lô auto đủ điều kiện cho khách này (không có gì để thao tác).
          </div>
        {% else %}
          {% if _is_customer_excluded %}
            <button
              type="button"
              class="w-full px-4 py-2 rounded-lg bg-slate-900 text-white text-sm font-medium hover:bg-slate-800 inline-flex items-center justify-center gap-2"
              onclick="openModalClearCustomer()"
            >
              <i class="ri-refresh-line"></i> Gỡ loại khách (mở lại toàn bộ lô)
            </button>
            <div class="mt-2 text-xs text-slate-500">
              Thao tác này sẽ gỡ loại cho <b>tất cả lô</b> của khách trong dự án.
            </div>
          {% else %}
            <button
              type="button"
              class="w-full px-4 py-2 rounded-lg bg-rose-600 text-white text-sm font-medium hover:bg-rose-700 inline-flex items-center justify-center gap-2"
              onclick="openModalExcludeCustomer()"
            >
              <i class="ri-forbid-2-line"></i> Loại khách khỏi danh sách (loại tất cả lô)
            </button>
            <div class="mt-2 text-xs text-slate-500">
              Thao tác hiếm gặp. Sẽ loại <b>toàn bộ</b> lô hợp lệ của khách trong dự án.
            </div>
          {% endif %}
        {% endif %}

        <div class="mt-4 border-t border-slate-200 pt-3">
          <a
            href="/bid-attendance?project_code={{ project_code }}"
            class="w-full px-4 py-2 rounded-lg border border-slate-300 text-slate-700 text-sm hover:bg-slate-50 inline-flex items-center justify-center gap-2"
          >
            <i class="ri-list-check-2"></i> Về danh sách điểm danh
          </a>
        </div>
      </div>
    </div>

    <!-- LOTS TABLE -->
    <div class="mt-4 border border-slate-200 rounded-xl">
      <div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between">
        <div>
          <div class="text-sm font-semibold text-slate-800">Các lô khách tham gia</div>
          <div class="text-xs text-slate-500">
            Danh sách <b>AUTO</b> gốc. Lô đã loại vẫn hiển thị để đối soát.
          </div>
        </div>
        <div class="text-xs text-slate-500">
          Tổng auto: <span class="font-semibold text-slate-700">{{ _auto_count }}</span>
          · Đã loại: <span class="font-semibold text-rose-700">{{ _excluded_count }}</span>
          · Còn hợp lệ: <span class="font-semibold text-emerald-700">{{ _remaining_count }}</span>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-xs">
          <thead class="bg-slate-50">
            <tr class="text-left text-slate-600">
              <th class="px-3 py-2 border-b">Mã lô</th>
              <th class="px-3 py-2 border-b">Mô tả</th>
              <th class="px-3 py-2 border-b text-right">Diện tích</th>
              <th class="px-3 py-2 border-b text-right">Tiền đặt trước</th>
              <th class="px-3 py-2 border-b text-right">Giá khởi điểm</th>
              <th class="px-3 py-2 border-b">Mã đơn</th>
              <th class="px-3 py-2 border-b">Thanh toán</th>
              <th class="px-3 py-2 border-b">Trạng thái</th>
              <th class="px-3 py-2 border-b text-right">Thao tác</th>
            </tr>
          </thead>
          <tbody>
            {% for r in lots %}
              {% set _lot_id = r.lot_id %}
              {% set _is_excluded = (_lot_id in excluded_lot_ids) %}
              {% set _ex = ns.ex_by_lot_id.get(_lot_id|string) %}
              <tr class="hover:bg-slate-50 {% if _is_excluded %}bg-rose-50/40{% endif %}">
                <td class="px-3 py-2 border-b font-mono text-[11px]">
                  <div class="flex items-center gap-2">
                    <span>{{ r.lot_code or "—" }}</span>
                    {% if _is_excluded %}
                      <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-rose-50 border border-rose-200 text-rose-700 text-[10px] font-semibold">
                        <i class="ri-forbid-2-line"></i> ĐÃ LOẠI
                      </span>
                    {% else %}
                      <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-emerald-50 border border-emerald-200 text-emerald-700 text-[10px] font-semibold">
                        <i class="ri-checkbox-circle-line"></i> HỢP LỆ
                      </span>
                    {% endif %}
                  </div>

                  {% if _is_excluded and _ex %}
                    <div class="mt-1 text-[10px] text-rose-800/80 leading-5">
                      <span class="font-semibold">Lý do:</span> {{ _ex.reason or "—" }}<br/>
                      <span class="text-rose-700/90">bởi</span> <span class="font-mono">{{ _ex.set_by or "—" }}</span>
                      · <span class="text-rose-700/90">lúc</span> <span class="font-mono">{{ _ex.set_at or "—" }}</span>
                    </div>
                  {% endif %}
                </td>

                <td class="px-3 py-2 border-b text-[11px]">{{ r.lot_description or "—" }}</td>

                <td class="px-3 py-2 border-b text-right font-mono text-[11px]">
                  {% if r.area_m2 is not none %}{{ r.area_m2 }}{% else %}—{% endif %}
                </td>

                <td class="px-3 py-2 border-b text-right font-mono text-[11px]">
                  {% if r.deposit_amount_vnd is not none %}{{ "{:,.0f}".format(r.deposit_amount_vnd) }}{% else %}—{% endif %}
                </td>

                <td class="px-3 py-2 border-b text-right font-mono text-[11px]">
                  {% if r.starting_price_vnd is not none %}{{ "{:,.0f}".format(r.starting_price_vnd) }}{% else %}—{% endif %}
                </td>

                <td class="px-3 py-2 border-b font-mono text-[11px]">{{ r.order_code or "—" }}</td>

                <td class="px-3 py-2 border-b text-[11px]">
                  {% if r.paid_at %}
                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-emerald-50 border border-emerald-200 text-emerald-700 text-[11px] font-semibold">
                      <i class="ri-checkbox-circle-line"></i> PAID
                    </span>
                    <span class="ml-2 font-mono text-[10px] text-slate-500">{{ r.paid_at }}</span>
                  {% else %}
                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-slate-50 border border-slate-200 text-slate-600 text-[11px] font-semibold">
                      <i class="ri-time-line"></i> —
                    </span>
                  {% endif %}
                </td>

                <td class="px-3 py-2 border-b">
                  {% if _is_excluded %}
                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-rose-50 border border-rose-200 text-rose-700 text-[11px] font-semibold">
                      <i class="ri-forbid-2-line"></i> ĐÃ LOẠI
                    </span>
                  {% else %}
                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-emerald-50 border border-emerald-200 text-emerald-700 text-[11px] font-semibold">
                      <i class="ri-checkbox-circle-line"></i> HỢP LỆ
                    </span>
                  {% endif %}
                </td>

                <td class="px-3 py-2 border-b text-right">
                  {% if _is_excluded %}
                    <button
                      type="button"
                      class="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-[11px] font-semibold hover:bg-slate-800 inline-flex items-center gap-1"
                      onclick="openModalClearLot('{{ r.lot_id }}','{{ r.lot_code|e }}')"
                      title="Gỡ loại lô này"
                    >
                      <i class="ri-refresh-line"></i> Gỡ
                    </button>
                  {% else %}
                    <button
                      type="button"
                      class="px-3 py-1.5 rounded-lg bg-rose-600 text-white text-[11px] font-semibold hover:bg-rose-700 inline-flex items-center gap-1"
                      onclick="openModalExcludeLot('{{ r.lot_id }}','{{ r.lot_code|e }}')"
                      title="Loại lô này"
                    >
                      <i class="ri-forbid-2-line"></i> Loại
                    </button>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}

            {% if not lots or lots|length == 0 %}
              <tr>
                <td colspan="9" class="px-3 py-8 text-center text-slate-500">
                  Không có dữ liệu lô cho khách này.
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

  {% endif %}
</div>

<!-- ============ Modal: confirm + reason + typed confirmation ============ -->
<div id="actionModal" class="fixed inset-0 z-[200] hidden">
  <div class="absolute inset-0 bg-slate-900/50"></div>
  <div class="absolute inset-0 flex items-center justify-center p-3">
    <div class="w-full max-w-xl rounded-2xl bg-white shadow-xl border border-slate-200 overflow-hidden">
      <div class="px-5 py-4 border-b border-slate-200">
        <div id="mTitle" class="text-base font-semibold text-slate-900">—</div>
        <div id="mDesc" class="mt-1 text-sm text-slate-500">—</div>
      </div>

      <div class="px-5 py-4">
        <div id="mReasonWrap" class="mb-4">
          <label class="block text-xs font-medium text-slate-600 mb-1">Lý do (bắt buộc)</label>
          <textarea
            id="mReason"
            rows="3"
            class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm"
            placeholder="Nhập lý do (bắt buộc)"
          ></textarea>
          <div id="mReasonErr" class="mt-1 text-xs text-rose-600 hidden">
            Vui lòng nhập lý do.
          </div>
        </div>

        <div class="mb-3 p-3 rounded-lg bg-amber-50 border border-amber-200 text-amber-800 text-sm">
          <div class="font-semibold flex items-center gap-2">
            <i class="ri-shield-keyhole-line"></i>
            Xác nhận bổ sung (bắt buộc)
          </div>
          <div class="mt-1 text-[13px] text-amber-900/80">
            Để tránh thao tác nhầm, vui lòng nhập chính xác cụm từ:
            <span class="font-mono font-semibold">tôi xác nhận</span>
          </div>
          <input
            id="mConfirmText"
            type="text"
            class="mt-2 w-full rounded-lg border border-amber-300 px-3 py-2 text-sm"
            placeholder="Nhập: tôi xác nhận"
            autocomplete="off"
          />
          <div id="mConfirmErr" class="mt-1 text-xs text-rose-600 hidden">
            Bạn phải nhập đúng: <span class="font-mono">tôi xác nhận</span>
          </div>
        </div>

        <div class="text-xs text-slate-500">
          * Thao tác này <b>không thay đổi dữ liệu thanh toán</b>, chỉ áp dụng cho danh sách điểm danh thực tế.
        </div>
      </div>

      <div class="px-5 py-4 border-t border-slate-200 flex items-center justify-between gap-2">
        <button
          type="button"
          class="px-4 py-2 rounded-lg border border-slate-300 text-slate-700 text-sm hover:bg-slate-50"
          onclick="closeModal()"
        >
          Huỷ
        </button>

        <button
          id="mSubmitBtn"
          type="button"
          class="px-4 py-2 rounded-lg bg-rose-600 text-white text-sm font-medium hover:bg-rose-700 inline-flex items-center gap-2"
          onclick="submitModal()"
        >
          <i class="ri-check-line"></i> Xác nhận
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Hidden forms (Service B endpoints) -->
<form id="fExcludeLot" method="post" action="/bid-attendance/detail/exclude-lot" class="hidden">
  <input type="hidden" name="project_id" value="{{ customer.project_id }}">
  <input type="hidden" name="project_code" value="{{ project_code }}">
  <input type="hidden" name="customer_id" value="{{ customer.customer_id }}">
  <input type="hidden" name="lot_id" id="fExcludeLot_lot_id" value="">
  <input type="hidden" name="reason" id="fExcludeLot_reason" value="">
  <input type="hidden" name="confirm_text" id="fExcludeLot_confirm_text" value="">
</form>

<form id="fClearLot" method="post" action="/bid-attendance/detail/clear-lot" class="hidden">
  <input type="hidden" name="project_id" value="{{ customer.project_id }}">
  <input type="hidden" name="project_code" value="{{ project_code }}">
  <input type="hidden" name="customer_id" value="{{ customer.customer_id }}">
  <input type="hidden" name="lot_id" id="fClearLot_lot_id" value="">
  <input type="hidden" name="confirm_text" id="fClearLot_confirm_text" value="">
</form>

<form id="fExcludeCustomer" method="post" action="/bid-attendance/detail/exclude-customer" class="hidden">
  <input type="hidden" name="project_id" value="{{ customer.project_id }}">
  <input type="hidden" name="project_code" value="{{ project_code }}">
  <input type="hidden" name="customer_id" value="{{ customer.customer_id }}">
  <input type="hidden" name="reason" id="fExcludeCustomer_reason" value="">
  <input type="hidden" name="confirm_text" id="fExcludeCustomer_confirm_text" value="">
</form>

<form id="fClearCustomer" method="post" action="/bid-attendance/detail/clear-customer" class="hidden">
  <input type="hidden" name="project_id" value="{{ customer.project_id }}">
  <input type="hidden" name="project_code" value="{{ project_code }}">
  <input type="hidden" name="customer_id" value="{{ customer.customer_id }}">
  <input type="hidden" name="confirm_text" id="fClearCustomer_confirm_text" value="">
</form>

<script>
  const modal = document.getElementById("actionModal");
  const mTitle = document.getElementById("mTitle");
  const mDesc  = document.getElementById("mDesc");
  const mReasonWrap = document.getElementById("mReasonWrap");
  const mReason = document.getElementById("mReason");
  const mReasonErr = document.getElementById("mReasonErr");
  const mConfirmText = document.getElementById("mConfirmText");
  const mConfirmErr  = document.getElementById("mConfirmErr");
  const mSubmitBtn = document.getElementById("mSubmitBtn");

  let __action = null;  // "exclude_customer" | "clear_customer" | "exclude_lot" | "clear_lot"
  let __lotId = null;
  let __lotCode = null;

  function showModal() {
    modal.classList.remove("hidden");
    document.body.classList.add("overflow-hidden");
  }

  function closeModal() {
    modal.classList.add("hidden");
    document.body.classList.remove("overflow-hidden");
    __action = null;
    __lotId = null;
    __lotCode = null;
    mSubmitBtn.disabled = false;
    mSubmitBtn.classList.remove("opacity-70");
  }

  function resetModalInputs() {
    mReason.value = "";
    mConfirmText.value = "";
    mReasonErr.classList.add("hidden");
    mConfirmErr.classList.add("hidden");
  }

  function requireReason(isRequired) {
    if (isRequired) {
      mReasonWrap.classList.remove("hidden");
    } else {
      mReasonWrap.classList.add("hidden");
      mReasonErr.classList.add("hidden");
    }
  }

  function setButtonDanger(isDanger) {
    if (isDanger) {
      mSubmitBtn.classList.remove("bg-slate-900");
      mSubmitBtn.classList.add("bg-rose-600");
      mSubmitBtn.classList.add("hover:bg-rose-700");
      mSubmitBtn.classList.remove("hover:bg-slate-800");
    } else {
      mSubmitBtn.classList.remove("bg-rose-600");
      mSubmitBtn.classList.add("bg-slate-900");
      mSubmitBtn.classList.add("hover:bg-slate-800");
      mSubmitBtn.classList.remove("hover:bg-rose-700");
    }
  }

  function openModalExcludeCustomer() {
    __action = "exclude_customer";
    resetModalInputs();
    requireReason(true);
    setButtonDanger(true);
    mTitle.textContent = "Loại khách khỏi danh sách (loại tất cả lô)";
    mDesc.textContent = "Sẽ loại TOÀN BỘ các lô hợp lệ của khách trong dự án này. Thao tác không được phép nhầm.";
    mSubmitBtn.innerHTML = '<i class="ri-forbid-2-line"></i> Xác nhận loại';
    showModal();
    setTimeout(() => mReason.focus(), 50);
  }

  function openModalClearCustomer() {
    __action = "clear_customer";
    resetModalInputs();
    requireReason(false);
    setButtonDanger(false);
    mTitle.textContent = "Gỡ loại khách (mở lại toàn bộ lô)";
    mDesc.textContent = "Khách sẽ được mở lại danh sách lô hợp lệ theo dữ liệu tự động. Thao tác không được phép nhầm.";
    mSubmitBtn.innerHTML = '<i class="ri-refresh-line"></i> Xác nhận gỡ';
    showModal();
    setTimeout(() => mConfirmText.focus(), 50);
  }

  function openModalExcludeLot(lotId, lotCode) {
    __action = "exclude_lot";
    __lotId = lotId;
    __lotCode = lotCode;
    resetModalInputs();
    requireReason(true);
    setButtonDanger(true);
    mTitle.textContent = "Loại 1 lô của khách";
    mDesc.textContent = `Sẽ loại lô ${lotCode} của khách trong dự án này. Các lô khác vẫn giữ nguyên. Thao tác không được phép nhầm.`;
    mSubmitBtn.innerHTML = '<i class="ri-forbid-2-line"></i> Xác nhận loại lô';
    showModal();
    setTimeout(() => mReason.focus(), 50);
  }

  function openModalClearLot(lotId, lotCode) {
    __action = "clear_lot";
    __lotId = lotId;
    __lotCode = lotCode;
    resetModalInputs();
    requireReason(false);
    setButtonDanger(false);
    mTitle.textContent = "Gỡ loại 1 lô";
    mDesc.textContent = `Sẽ gỡ loại cho lô ${lotCode}. Thao tác không được phép nhầm.`;
    mSubmitBtn.innerHTML = '<i class="ri-refresh-line"></i> Xác nhận gỡ lô';
    showModal();
    setTimeout(() => mConfirmText.focus(), 50);
  }

  function _normalizeConfirmText(s) {
    return (s || "")
      .trim()
      .toLowerCase()
      .replace(/\s+/g, " ");
  }

  function _lockSubmitBtn() {
    mSubmitBtn.disabled = true;
    mSubmitBtn.classList.add("opacity-70");
    mSubmitBtn.innerHTML = '<i class="ri-loader-4-line animate-spin"></i> Đang xử lý...';
  }

  function submitModal() {
    const confirmValue = _normalizeConfirmText(mConfirmText.value);
    if (confirmValue !== "tôi xác nhận") {
      mConfirmErr.classList.remove("hidden");
      mConfirmText.focus();
      return;
    } else {
      mConfirmErr.classList.add("hidden");
    }

    if (__action === "exclude_customer" || __action === "exclude_lot") {
      const v = (mReason.value || "").trim();
      if (!v) {
        mReasonErr.classList.remove("hidden");
        mReason.focus();
        return;
      }
      mReasonErr.classList.add("hidden");

      if (__action === "exclude_customer") {
        document.getElementById("fExcludeCustomer_reason").value = v;
        document.getElementById("fExcludeCustomer_confirm_text").value = "tôi xác nhận";
        _lockSubmitBtn();
        document.getElementById("fExcludeCustomer").submit();
        return;
      }

      if (__action === "exclude_lot") {
        document.getElementById("fExcludeLot_lot_id").value = __lotId;
        document.getElementById("fExcludeLot_reason").value = v;
        document.getElementById("fExcludeLot_confirm_text").value = "tôi xác nhận";
        _lockSubmitBtn();
        document.getElementById("fExcludeLot").submit();
        return;
      }
    }

    if (__action === "clear_customer") {
      document.getElementById("fClearCustomer_confirm_text").value = "tôi xác nhận";
      _lockSubmitBtn();
      document.getElementById("fClearCustomer").submit();
      return;
    }

    if (__action === "clear_lot") {
      document.getElementById("fClearLot_lot_id").value = __lotId;
      document.getElementById("fClearLot_confirm_text").value = "tôi xác nhận";
      _lockSubmitBtn();
      document.getElementById("fClearLot").submit();
      return;
    }
  }

  modal.addEventListener("click", function (e) {
    const card = modal.querySelector(".max-w-xl");
    if (card && !card.contains(e.target)) closeModal();
  });

  document.addEventListener("keydown", function (e) {
    if (e.key === "Escape" && !modal.classList.contains("hidden")) {
      closeModal();
    }
  });

  mConfirmText.addEventListener("input", function () {
    if (!mConfirmErr.classList.contains("hidden")) mConfirmErr.classList.add("hidden");
  });
  mReason.addEventListener("input", function () {
    if (!mReasonErr.classList.contains("hidden")) mReasonErr.classList.add("hidden");
  });
</script>
{% endblock %}
