{% extends "base.html" %}
{% block content %}

<a href="/account" class="text-sm text-indigo-600 hover:text-indigo-700">&larr; Quay lại danh sách công ty</a>

<div class="mt-3 mb-6 flex items-start justify-between gap-3">
  <div>
    <h2 class="text-xl font-semibold text-slate-800">Công ty: {{ company_code }}</h2>
    {% if company %}
      <p class="text-slate-500 text-sm">
        Tên: <b class="text-slate-700">{{ company.name }}</b>
        {% if company.is_active %}
          <span class="ml-2 inline-flex items-center text-green-700">
            <span class="h-2 w-2 rounded-full bg-green-500 mr-1"></span> Active
          </span>
        {% else %}
          <span class="ml-2 inline-flex items-center text-slate-500">
            <span class="h-2 w-2 rounded-full bg-slate-400 mr-1"></span> Disabled
          </span>
        {% endif %}
      </p>
    {% endif %}
  </div>

  <!-- NEW: Cấu hình email -->
  <div class="shrink-0">
    <a href="/account/company/{{ company_code }}/email"
       class="btn-primary inline-flex items-center gap-2">
      <!-- simple envelope icon -->
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8m-18 8h18a2 2 0 002-2V8a2 2 0 00-2-2H3a2 2 0 00-2 2v6a2 2 0 002 2z"/>
      </svg>
      Cấu hình email
    </a>
  </div>
</div>

{% if load_err %}
  <div class="p-3 rounded bg-red-50 text-red-700 text-sm mb-6">{{ load_err }}</div>
{% endif %}

{# Form tạo user cho công ty này #}
<div class="mb-4">
  <form id="createUserForm" action="/account/admin/user/create" method="post" class="flex flex-wrap items-end gap-2">
    <input type="hidden" name="company_code" value="{{ company_code }}">
    <input type="hidden" name="next" value="/account/company/{{ company_code }}">

    <label class="block">
      <span class="sr-only">Username</span>
      <input id="usernameInput" name="username" placeholder="username (a-z0-9_)" class="input" required>
    </label>

    <label class="block">
      <span class="sr-only">Password</span>
      <input name="password" placeholder="password" type="password" class="input" required>
    </label>

    <label class="block">
      <span class="sr-only">Role</span>
      <select name="role" class="input">
        <option value="STAFF">STAFF</option>
        <option value="VIEWER">VIEWER</option>
        <option value="ACCOUNTANT">ACCOUNTANT</option>
        <option value="COMPANY_ADMIN">COMPANY_ADMIN</option>
      </select>
    </label>

    <button class="btn-primary" type="submit">Thêm tài khoản</button>

    {# ✅ Hint: chỉ nhập suffix, hệ thống tự prefix company_code #}
    <div class="w-full">
      <div id="usernameHint" class="text-xs text-slate-500 mt-1">
        Gợi ý: Hệ thống tự thêm tiền tố <b class="text-slate-700"><span id="ccPrefix">{{ company_code }}</span>.</b>
        Ví dụ muốn tạo <b class="text-slate-700"><span id="ccExample">{{ company_code }}</span>.AnhNV</b> → bạn chỉ cần nhập <b class="text-slate-700">AnhNV</b>.
      </div>
    </div>
  </form>
</div>

{# Danh sách user của công ty #}
{% if users and users|length > 0 %}
  <div class="overflow-x-auto border rounded bg-white">
    <table class="min-w-full text-sm">
      <thead class="bg-slate-50 text-slate-600">
        <tr>
          <th class="px-3 py-2 text-left font-medium">ID</th>
          <th class="px-3 py-2 text-left font-medium">Username</th>
          <th class="px-3 py-2 text-left font-medium">Role</th>
          <th class="px-3 py-2 text-left font-medium">Trạng thái</th>
          <th class="px-3 py-2 text-left font-medium">Hành động</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-100" id="usersTbody">
        {% for u in users %}
        <tr class="hover:bg-slate-50">
          <td class="px-3 py-2">{{ u.id }}</td>
          <td class="px-3 py-2 font-mono text-slate-800 js-username">{{ u.username }}</td>
          <td class="px-3 py-2">{{ u.role }}</td>
          <td class="px-3 py-2">
            {% if u.is_active %}
              <span class="inline-flex items-center text-green-700">
                <span class="h-2 w-2 rounded-full bg-green-500 mr-1"></span> Active
              </span>
            {% else %}
              <span class="inline-flex items-center text-slate-500">
                <span class="h-2 w-2 rounded-full bg-slate-400 mr-1"></span> Disabled
              </span>
            {% endif %}
          </td>
          <td class="px-3 py-2">
            {% if u.is_active %}
              <form action="/account/admin/user/toggle" method="post" class="inline js-confirm-form"
                    data-confirm-title="Xác nhận"
                    data-confirm-message="Disable user {{ u.username }} ?">
                <input type="hidden" name="user_id" value="{{ u.id }}">
                <input type="hidden" name="action" value="disable">
                <input type="hidden" name="next" value="/account/company/{{ company_code }}">
                <button class="btn-secondary" type="submit">Disable</button>
              </form>
            {% else %}
              <form action="/account/admin/user/toggle" method="post" class="inline js-confirm-form"
                    data-confirm-title="Xác nhận"
                    data-confirm-message="Enable user {{ u.username }} ?">
                <input type="hidden" name="user_id" value="{{ u.id }}">
                <input type="hidden" name="action" value="enable">
                <input type="hidden" name="next" value="/account/company/{{ company_code }}">
                <button class="btn-primary" type="submit">Enable</button>
              </form>
            {% endif %}

            {# ✅ Set password: bỏ input inline, dùng popup; endpoint giữ nguyên #}
            <form action="/account/admin/user/set-password" method="post"
                  class="inline ml-2 js-setpass-form"
                  data-username="{{ u.username }}">
              <input type="hidden" name="user_id" value="{{ u.id }}">
              <input type="hidden" name="next" value="/account/company/{{ company_code }}">
              <input type="hidden" name="new_password" value="">
              <button class="btn-primary" type="submit">Set password</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <div class="text-slate-500 text-sm">Chưa có tài khoản nào cho công ty này.</div>
{% endif %}

{# =========================
   CUSTOM MODAL (replaces browser confirm/alert + set password popup)
   ========================= #}
<style>
  #appModal{ position:fixed; inset:0; z-index:60; display:none; }
  #appModal.show{ display:block; }
  #appModal .m-backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.50); }
  #appModal .m-card{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:min(560px, calc(100vw - 32px));
    background:#fff; border-radius:14px; box-shadow:0 30px 80px rgba(2,6,23,.35);
    overflow:hidden; border:1px solid rgba(15,23,42,.12);
  }
  #appModal .m-head{ padding:14px 16px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid rgba(15,23,42,.08); }
  #appModal .m-title{ font-weight:700; color:#0f172a; display:flex; align-items:center; gap:10px; }
  #appModal .m-close{ width:36px; height:36px; border-radius:999px; display:flex; align-items:center; justify-content:center; cursor:pointer; background:transparent; border:0; }
  #appModal .m-close:hover{ background:rgba(15,23,42,.06); }
  #appModal .m-body{ padding:14px 16px; color:#0f172a; }
  #appModal .m-desc{ color:rgba(71,85,105,.92); font-size:14px; line-height:1.45; white-space:pre-line; }
  #appModal .m-foot{ padding:12px 16px; display:flex; justify-content:flex-end; gap:10px; border-top:1px solid rgba(15,23,42,.08); background:#f8fafc; }
  #appModal .m-btn{ padding:9px 14px; border-radius:10px; font-weight:600; font-size:14px; border:1px solid rgba(15,23,42,.16); background:#fff; }
  #appModal .m-btn:hover{ background:#f1f5f9; }
  #appModal .m-btn.primary{ background:#4f46e5; border-color:#4f46e5; color:#fff; }
  #appModal .m-btn.primary:hover{ filter:brightness(.95); }
  #appModal .m-btn:disabled{ opacity:.55; cursor:not-allowed; }
  #appModal .m-ico{ width:30px; height:30px; border-radius:10px; display:flex; align-items:center; justify-content:center; }
  #appModal .m-ico.info{ background:rgba(79,70,229,.12); color:#4f46e5; }
  #appModal .m-ico.warn{ background:rgba(245,158,11,.16); color:#b45309; }
  #appModal .m-ico.bad{ background:rgba(239,68,68,.14); color:#b91c1c; }

  /* Set password form inside modal */
  .m-field{ margin-top:10px; }
  .m-label{ display:block; font-size:12px; color:rgba(71,85,105,.92); margin-bottom:6px; }
  .m-input{
    width:100%; border:1px solid rgba(15,23,42,.16); border-radius:10px;
    padding:10px 12px; font-size:14px; outline:none;
  }
  .m-input:focus{ border-color:rgba(79,70,229,.65); box-shadow:0 0 0 3px rgba(79,70,229,.12); }
  .m-hint{ margin-top:8px; font-size:12px; color:rgba(71,85,105,.92); }
  .m-hint.ok{ color:#16a34a; }
  .m-hint.bad{ color:#b91c1c; }
</style>

<div id="appModal" aria-hidden="true">
  <div class="m-backdrop" id="appModalBackdrop"></div>
  <div class="m-card" role="dialog" aria-modal="true" aria-labelledby="appModalTitle">
    <div class="m-head">
      <div class="m-title" id="appModalTitle">
        <span class="m-ico info" id="appModalIcon"><i class="ri-information-line"></i></span>
        <span id="appModalTitleText">Thông báo</span>
      </div>
      <button class="m-close" id="appModalClose" aria-label="Đóng">
        <i class="ri-close-line text-xl"></i>
      </button>
    </div>
    <div class="m-body" id="appModalBody">
      <div class="m-desc" id="appModalDesc">—</div>
    </div>
    <div class="m-foot" id="appModalFooter">
      <button class="m-btn" id="appModalCancel" style="display:none">Hủy</button>
      <button class="m-btn primary" id="appModalOk">OK</button>
    </div>
  </div>
</div>

<script>
(function(){
  // ===== Modal helpers =====
  const appModal = document.getElementById("appModal");
  const appModalBackdrop = document.getElementById("appModalBackdrop");
  const appModalClose = document.getElementById("appModalClose");
  const appModalOk = document.getElementById("appModalOk");
  const appModalCancel = document.getElementById("appModalCancel");
  const appModalDesc = document.getElementById("appModalDesc");
  const appModalBody = document.getElementById("appModalBody");
  const appModalTitleText = document.getElementById("appModalTitleText");
  const appModalIcon = document.getElementById("appModalIcon");

  let __modalResolve = null;
  let __modalMode = "alert"; // alert | confirm | setpass

  function setModalVariant(variant){
    appModalIcon.classList.remove("info","warn","bad");
    const v = variant || "info";
    appModalIcon.classList.add(v);
    const ico = (v==="warn") ? "ri-error-warning-line" : (v==="bad" ? "ri-close-circle-line" : "ri-information-line");
    appModalIcon.innerHTML = `<i class="${ico}"></i>`;
  }

  function openModal(){
    appModal.classList.add("show");
    appModal.setAttribute("aria-hidden","false");
  }
  function closeModal(result){
    appModal.classList.remove("show");
    appModal.setAttribute("aria-hidden","true");
    const r = __modalResolve;
    __modalResolve = null;
    __modalMode = "alert";
    if (typeof r === "function") r(result);
  }

  function _clearBodyExtras(){
    const nodes = Array.from(appModalBody.children);
    nodes.forEach((n, idx)=>{ if (idx>0) n.remove(); });
  }

  function showAlert({title, message, variant, okText}){
    __modalMode = "alert";
    appModalTitleText.textContent = title || "Thông báo";
    setModalVariant(variant || "info");
    _clearBodyExtras();
    appModalDesc.textContent = message || "";
    appModalDesc.style.display = "";

    appModalCancel.style.display = "none";
    appModalOk.textContent = okText || "OK";
    appModalOk.disabled = false;

    openModal();
    setTimeout(()=>{ try{ appModalOk.focus(); }catch(e){} }, 0);
    return new Promise((resolve)=>{ __modalResolve = resolve; });
  }

  function showConfirm({title, message, variant, okText, cancelText}){
    __modalMode = "confirm";
    appModalTitleText.textContent = title || "Xác nhận";
    setModalVariant(variant || "warn");
    _clearBodyExtras();
    appModalDesc.textContent = message || "";
    appModalDesc.style.display = "";

    appModalCancel.style.display = "";
    appModalCancel.textContent = cancelText || "Hủy";
    appModalOk.textContent = okText || "Xác nhận";
    appModalOk.disabled = false;

    openModal();
    setTimeout(()=>{ try{ appModalOk.focus(); }catch(e){} }, 0);
    return new Promise((resolve)=>{ __modalResolve = resolve; });
  }

  function showSetPassword({username}){
    __modalMode = "setpass";
    appModalTitleText.textContent = "Đặt lại mật khẩu";
    setModalVariant("info");
    _clearBodyExtras();

    appModalDesc.textContent = username ? `Tài khoản: ${username}` : `Nhập mật khẩu mới`;
    appModalDesc.style.display = "";

    const wrap = document.createElement("div");
    wrap.innerHTML = `
      <div class="m-field">
        <label class="m-label">Mật khẩu mới</label>
        <input id="spPass1" type="password" class="m-input" placeholder="Nhập mật khẩu mới" autocomplete="new-password">
      </div>
      <div class="m-field">
        <label class="m-label">Xác nhận mật khẩu mới</label>
        <input id="spPass2" type="password" class="m-input" placeholder="Nhập lại mật khẩu mới" autocomplete="new-password">
      </div>
      <div id="spHint" class="m-hint">Vui lòng nhập đủ 2 ô và trùng khớp.</div>
    `;
    appModalBody.appendChild(wrap);

    appModalCancel.style.display = "";
    appModalCancel.textContent = "Hủy";
    appModalOk.textContent = "Xác nhận";
    appModalOk.disabled = true;

    openModal();

    const p1 = document.getElementById("spPass1");
    const p2 = document.getElementById("spPass2");
    const hint = document.getElementById("spHint");

    function validate(){
      const a = (p1.value || "");
      const b = (p2.value || "");
      const ok = (a.length > 0) && (b.length > 0) && (a === b);
      appModalOk.disabled = !ok;

      if (!a && !b){
        hint.textContent = "Vui lòng nhập đủ 2 ô và trùng khớp.";
        hint.classList.remove("ok","bad");
      } else if (a && b && a !== b){
        hint.textContent = "Mật khẩu xác nhận chưa khớp.";
        hint.classList.remove("ok"); hint.classList.add("bad");
      } else if (a && !b){
        hint.textContent = "Vui lòng nhập ô xác nhận mật khẩu.";
        hint.classList.remove("ok","bad");
      } else if (!a && b){
        hint.textContent = "Vui lòng nhập mật khẩu mới.";
        hint.classList.remove("ok","bad");
      } else if (ok){
        hint.textContent = "Hợp lệ ✓";
        hint.classList.remove("bad"); hint.classList.add("ok");
      }
      return ok;
    }

    p1.addEventListener("input", validate);
    p2.addEventListener("input", validate);

    setTimeout(()=>{ try{ p1.focus(); }catch(e){} }, 0);
    return new Promise((resolve)=>{ __modalResolve = resolve; });
  }

  // modal events
  appModalOk.onclick = ()=>{
    if (__modalMode === "setpass"){
      const p1 = document.getElementById("spPass1");
      const p2 = document.getElementById("spPass2");
      const a = (p1?.value || "");
      const b = (p2?.value || "");
      if (a && b && a === b){
        closeModal({ok:true, password:a});
      }
      return;
    }
    closeModal(true);
  };
  appModalCancel.onclick = ()=> closeModal(false);
  appModalBackdrop.onclick = ()=> closeModal(false);
  appModalClose.onclick = ()=> closeModal(false);

  document.addEventListener("keydown", (e)=>{
    if (!appModal.classList.contains("show")) return;
    if (e.key === "Escape"){ e.preventDefault(); closeModal(false); }
    if (e.key === "Enter"){
      if (!appModalOk.disabled){
        e.preventDefault();
        appModalOk.click();
      }
    }
  });

  // ===== Confirm forms (disable/enable) =====
  document.querySelectorAll("form.js-confirm-form").forEach(form=>{
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const title = form.dataset.confirmTitle || "Xác nhận";
      const msg = form.dataset.confirmMessage || "Bạn có chắc chắn?";
      const ok = await showConfirm({title, message: msg, variant:"warn", okText:"Xác nhận", cancelText:"Hủy"});
      if (ok) form.submit();
    });
  });

  // ===== Set password forms =====
  document.querySelectorAll("form.js-setpass-form").forEach(form=>{
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const username = form.dataset.username || "";
      const rs = await showSetPassword({username});
      if (rs && rs.ok && rs.password){
        const hidden = form.querySelector('input[name="new_password"]');
        if (hidden) hidden.value = rs.password;
        form.submit(); // endpoint giữ nguyên
      }
    });
  });

  // ===== Username hint + auto-strip prefix =====
  const usernameInput = document.getElementById("usernameInput");
  const createForm = document.getElementById("createUserForm");

  function detectCompanyCode(){
    let cc = ("{{ company_code or '' }}").trim();
    if (cc) return cc;
    // fallback: lấy prefix từ bất kỳ username trong list
    const cells = document.querySelectorAll(".js-username");
    for (const c of cells){
      const v = (c.textContent || "").trim();
      const idx = v.indexOf(".");
      if (idx > 0) return v.slice(0, idx);
    }
    return "";
  }

  const ccDetected = detectCompanyCode();
  const ccPrefixEl = document.getElementById("ccPrefix");
  const ccExampleEl = document.getElementById("ccExample");
  if (ccDetected){
    if (ccPrefixEl) ccPrefixEl.textContent = ccDetected;
    if (ccExampleEl) ccExampleEl.textContent = ccDetected;
  }

  if (createForm && usernameInput){
    createForm.addEventListener("submit", async (e)=>{
      const cc = detectCompanyCode();
      const v0 = (usernameInput.value || "").trim();
      if (!v0) return;

      // auto-strip nếu nhập đúng prefix company_code.
      if (cc){
        const lower = v0.toLowerCase();
        const pref = (cc + ".").toLowerCase();
        if (lower.startsWith(pref)){
          usernameInput.value = v0.slice(cc.length + 1);
          return; // tiếp tục submit bình thường
        }
      }

      // Nếu có dấu chấm nhưng không đúng prefix => cảnh báo (không chặn submit)
      if (v0.includes(".")){
        // khuyên người dùng chỉ nhập suffix
        await showAlert({
          title: "Gợi ý nhập username",
          message: cc
            ? `Bạn chỉ cần nhập phần sau dấu chấm.\nHệ thống sẽ tự thêm tiền tố: ${cc}.\nVí dụ: muốn tạo ${cc}.AnhNV → chỉ nhập AnhNV.`
            : `Bạn chỉ cần nhập phần sau dấu chấm.\nHệ thống sẽ tự thêm tiền tố company_code.\nVí dụ: muốn tạo {company}.AnhNV → chỉ nhập AnhNV.`,
          variant: "info",
          okText: "Đã hiểu"
        });
        // không prevent submit, để họ vẫn tạo nếu họ muốn
      }
    });
  }

  // expose if later needed
  window.__appAlert = showAlert;
})();
</script>

{% endblock %}
