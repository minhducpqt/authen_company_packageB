{% extends "base.html" %}
{% block title %}Cấu hình email — {{ company_code|upper }}{% endblock %}
{% block content %}
<style>
:root{--b:#e5e7eb;--muted:#64748b;--txt:#0f172a;--ok:#10b981;--warn:#f59e0b;--err:#ef4444}
.page-wrap{max-width:980px;margin:0 auto}
.h1{font-size:22px;font-weight:800;margin:10px 0 14px}
.card{background:#fff;border:1px solid var(--b);border-radius:14px;padding:14px;box-shadow:0 8px 24px rgba(2,6,23,.06)}
.tbl{width:100%;border-collapse:collapse}
.tbl th,.tbl td{border-bottom:1px solid var(--b);padding:10px 8px;text-align:left;font-size:14px;vertical-align:top}
.badge{font-size:12px;border-radius:999px;padding:2px 8px;display:inline-block}
.badge.ok{background:rgba(16,185,129,.12);color:#065f46;border:1px solid rgba(16,185,129,.3)}
.badge.off{background:rgba(100,116,139,.12);color:#334155;border:1px solid rgba(100,116,139,.3)}
.btn{display:inline-flex;align-items:center;padding:8px 12px;border-radius:10px;border:1px solid var(--b);background:#0f172a;color:#fff;cursor:pointer}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-ghost{background:#fff;color:#0f172a}
.input{width:100%;border:1px solid var(--b);border-radius:10px;padding:8px 10px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:820px){.grid{grid-template-columns:1fr}}
.help{font-size:12px;color:var(--muted)}

/* Modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
.modal{width:100%;max-width:680px;background:#fff;border:1px solid var(--b);border-radius:16px;box-shadow:0 20px 48px rgba(2,6,23,.2);overflow:hidden}
.modal-hd{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--b)}
.modal-tt{font-weight:800;color:#0f172a}
.modal-bd{padding:16px}
.modal-ft{display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--b);background:#f8fafc}
.close-x{background:transparent;border:none;font-size:20px;line-height:1;cursor:pointer;color:#475569}
</style>

<div class="page-wrap">
  <a href="/account/company/{{ company_code }}" class="text-sm text-indigo-600">&larr; Quay lại chi tiết công ty</a>
  <h1 class="h1">Cấu hình email — <b>{{ company_code|upper }}</b></h1>

  <div class="card" style="margin-bottom:14px">
    <h3 style="margin:0 0 10px;font-weight:800">Danh sách cấu hình</h3>
    <div class="help" style="margin-bottom:8px">
      Hệ thống cho phép nhiều cấu hình; chọn <i>Kích hoạt</i> để đánh dấu cấu hình đang dùng.
      <br>
      <b>From name</b> là tên hiển thị (ví dụ: <i>Đấu giá Kinh Đô</i>) để email hiện “Đấu giá Kinh Đô &lt;cskh@...&gt;”.
    </div>
    <div id="list-wrap">
      <table class="tbl" id="mailer-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>From</th>
            <th>Host</th>
            <th>Port</th>
            <th>User</th>
            <th>STARTTLS</th>
            <th>SSL</th>
            <th>Trạng thái</th>
            <th style="width:220px">Hành động</th>
          </tr>
        </thead>
        <tbody id="mailer-tbody"><tr><td colspan="9">Đang tải...</td></tr></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px;font-weight:800">Thêm cấu hình</h3>
    <form id="create-form" onsubmit="return submitCreate(event)">
      <div class="grid">
        <div>
          <label>From email</label>
          <input class="input" name="from_email" required placeholder="cskh@daugiathongminh.vn">
        </div>
        <div>
          <label>From name (tên hiển thị)</label>
          <input class="input" name="from_name" placeholder="Đấu giá Kinh Đô">
          <div class="help">Tên hiển thị ở Gmail. Để trống thì Gmail thường hiện phần trước dấu @ (ví dụ: <b>cskh</b>).</div>
        </div>

        <div>
          <label>Reply-To (tuỳ chọn)</label>
          <input class="input" name="reply_to" placeholder="support@company.com">
        </div>
        <div>
          <label>Ghi chú</label>
          <input class="input" name="notes" placeholder="Gmail SMTP / SMTP Relay">
        </div>

        <div>
          <label>SMTP Host</label>
          <input class="input" name="host" required placeholder="smtp.gmail.com">
        </div>
        <div>
          <label>Port</label>
          <input class="input" name="port" type="number" value="587" required>
        </div>

        <div>
          <label>Username</label>
          <input class="input" name="username" required placeholder="cskh@daugiathongminh.vn">
        </div>
        <div>
          <label>App Password</label>
          <input class="input" name="app_password" required placeholder="16 ký tự App Password">
          <div class="help">Gmail SMTP thường: bật 2FA & tạo App password. (SMTP Relay thì thường không cần, tuỳ cấu hình).</div>
        </div>

        <div>
          <label>STARTTLS</label>
          <select class="input" name="use_starttls">
            <option value="true" selected>Có</option>
            <option value="false">Không</option>
          </select>
        </div>
        <div>
          <label>SSL</label>
          <select class="input" name="use_ssl">
            <option value="false" selected>Không</option>
            <option value="true">Có</option>
          </select>
        </div>

        <div>
          <label>Kích hoạt ngay</label>
          <select class="input" name="is_active">
            <option value="true" selected>Có</option>
            <option value="false">Không</option>
          </select>
        </div>
        <div>
          <div class="help" style="margin-top:22px">
            Tip: nếu dùng Gmail SMTP Relay thì <b>From name</b> vẫn lấy theo cấu hình trong hệ thống gửi mail (header From).
          </div>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn" type="submit">Tạo cấu hình</button>
        <button class="btn btn-ghost" type="reset">Xoá</button>
      </div>
    </form>
  </div>
</div>

<!-- EDIT MODAL -->
<div id="edit-modal" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="edit-title">
    <div class="modal-hd">
      <div id="edit-title" class="modal-tt">Sửa cấu hình email</div>
      <button class="close-x" type="button" onclick="closeEdit()">×</button>
    </div>
    <form id="edit-form" onsubmit="return submitEdit(event)">
      <div class="modal-bd">
        <input type="hidden" name="id">
        <div class="grid">
          <div>
            <label>From email</label>
            <input class="input" name="from_email" required>
          </div>
          <div>
            <label>From name (tên hiển thị)</label>
            <input class="input" name="from_name" placeholder="Đấu giá Kinh Đô">
            <div class="help">Nếu để trống, Gmail có thể hiện “cskh”.</div>
          </div>

          <div>
            <label>Reply-To (tuỳ chọn)</label>
            <input class="input" name="reply_to" placeholder="support@company.com">
          </div>
          <div>
            <label>Ghi chú</label>
            <input class="input" name="notes" placeholder="Gmail SMTP / SMTP Relay">
          </div>

          <div>
            <label>SMTP Host</label>
            <input class="input" name="host" required>
          </div>
          <div>
            <label>Port</label>
            <input class="input" name="port" type="number" required>
          </div>

          <div>
            <label>Username</label>
            <input class="input" name="username" required>
          </div>
          <div>
            <label>App Password</label>
            <input class="input" name="app_password" placeholder="(để trống nếu không đổi)">
            <div class="help">Để trống nếu giữ nguyên app password hiện tại.</div>
          </div>

          <div>
            <label>STARTTLS</label>
            <select class="input" name="use_starttls">
              <option value="true">Có</option>
              <option value="false">Không</option>
            </select>
          </div>
          <div>
            <label>SSL</label>
            <select class="input" name="use_ssl">
              <option value="false">Không</option>
              <option value="true">Có</option>
            </select>
          </div>

          <div>
            <label>Kích hoạt</label>
            <select class="input" name="is_active">
              <option value="true">Có</option>
              <option value="false">Không</option>
            </select>
          </div>
          <div>
            <div class="help" style="margin-top:22px">Khi bật Kích hoạt, cấu hình này sẽ trở thành cấu hình đang dùng.</div>
          </div>
        </div>
      </div>
      <div class="modal-ft">
        <button type="button" class="btn btn-ghost" onclick="closeEdit()">Huỷ</button>
        <button type="submit" class="btn">Lưu thay đổi</button>
      </div>
    </form>
  </div>
</div>

<script>
const COMPANY_CODE = "{{ company_code }}";

async function fetchJSON(url, opts={}){
  const res = await fetch(url, Object.assign({credentials:'include'}, opts));
  if(!res.ok){
    const text = await res.text();
    throw new Error(text || (res.status + " " + res.statusText));
  }
  return res.json();
}

let ITEMS = [];   // cache danh sách để phục vụ popup edit

async function loadList(){
  const tb = document.getElementById('mailer-tbody');
  tb.innerHTML = '<tr><td colspan="9">Đang tải...</td></tr>';
  try{
    const data = await fetchJSON(`/api/v1/company-mailers?company_code=${encodeURIComponent(COMPANY_CODE)}`);
    const items = data.items || [];
    ITEMS = items;
    if(items.length === 0){
      tb.innerHTML = '<tr><td colspan="9">Chưa có cấu hình.</td></tr>';
      return;
    }
    tb.innerHTML = items.map(it => `
      <tr>
        <td>${it.id}</td>
        <td>
          <div style="font-weight:700">${escapeHtml(it.from_name || '')}</div>
          <div>${escapeHtml(it.from_email || '')}</div>
          ${it.reply_to ? `<div class="help">Reply-To: ${escapeHtml(it.reply_to)}</div>`:''}
        </td>
        <td>${escapeHtml(it.host || '')}</td>
        <td>${it.port ?? ''}</td>
        <td>${escapeHtml(it.username || '')}</td>
        <td>${it.use_starttls ? '✓' : '—'}</td>
        <td>${it.use_ssl ? '✓' : '—'}</td>
        <td>${it.is_active ? '<span class="badge ok">Đang dùng</span>' : '<span class="badge off">Tắt</span>'}</td>
        <td style="display:flex;gap:6px;flex-wrap:wrap">
          <button class="btn btn-ghost" onclick="activate(${it.id})">Kích hoạt</button>
          <button class="btn btn-ghost" onclick="openEdit(${it.id})">Sửa</button>
          <button class="btn btn-ghost" onclick="removeItem(${it.id})" style="color:var(--err);border-color:#fecaca">Xoá</button>
        </td>
      </tr>
    `).join('');
  }catch(e){
    tb.innerHTML = `<tr><td colspan="9" style="color:var(--err)">${escapeHtml(e.message)}</td></tr>`;
  }
}

function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

async function submitCreate(e){
  e.preventDefault();
  const f = e.target;
  const payload = {
    company_code: COMPANY_CODE,
    from_email: f.from_email.value.trim(),
    from_name: f.from_name.value.trim() || null,     // NEW
    reply_to: f.reply_to.value.trim() || null,
    host: f.host.value.trim(),
    port: Number(f.port.value),
    username: f.username.value.trim(),
    app_password: f.app_password.value.trim(),
    use_ssl: f.use_ssl.value === 'true',
    use_starttls: f.use_starttls.value === 'true',
    is_active: f.is_active.value === 'true',
    notes: f.notes.value.trim() || null
  };
  await fetchJSON('/api/v1/company-mailers', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  f.reset();
  await loadList();
}

async function activate(id){
  await fetchJSON(`/api/v1/company-mailers/${id}/activate`, {method:'POST'});
  await loadList();
}

/* ===== Modal Edit ===== */
const modal = document.getElementById('edit-modal');
const editForm = document.getElementById('edit-form');

function openEdit(id){
  const it = ITEMS.find(x => x.id === id);
  if(!it) return;

  editForm.id.value = it.id;
  editForm.from_email.value = it.from_email || '';
  editForm.from_name.value  = it.from_name || '';   // NEW
  editForm.reply_to.value   = it.reply_to || '';
  editForm.host.value       = it.host || '';
  editForm.port.value       = it.port || 587;
  editForm.username.value   = it.username || '';
  editForm.app_password.value = ''; // để trống nếu không đổi
  editForm.use_starttls.value = it.use_starttls ? 'true' : 'false';
  editForm.use_ssl.value      = it.use_ssl ? 'true' : 'false';
  editForm.is_active.value    = it.is_active ? 'true' : 'false';
  editForm.notes.value        = it.notes || '';

  modal.style.display = 'flex';
  document.body.classList.add('vk-open');
}

function closeEdit(){
  modal.style.display = 'none';
  document.body.classList.remove('vk-open');
}

async function submitEdit(e){
  e.preventDefault();
  const f = e.target;
  const id = f.id.value;

  const payload = {
    from_email: f.from_email.value.trim(),
    from_name: f.from_name.value.trim() || null,   // NEW
    reply_to: f.reply_to.value.trim() || null,
    host: f.host.value.trim(),
    port: Number(f.port.value),
    username: f.username.value.trim(),
    use_ssl: f.use_ssl.value === 'true',
    use_starttls: f.use_starttls.value === 'true',
    is_active: f.is_active.value === 'true',
    notes: f.notes.value.trim() || null
  };

  // chỉ gửi app_password nếu người dùng nhập
  const pw = f.app_password.value.trim();
  if(pw) payload.app_password = pw;

  await fetchJSON(`/api/v1/company-mailers/${id}`, {
    method:'PUT',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  closeEdit();
  await loadList();
}

/* ===== Delete ===== */
async function removeItem(id){
  if(!confirm('Xoá cấu hình này?')) return;
  await fetch(`/api/v1/company-mailers/${id}`, {method:'DELETE', credentials:'include'});
  await loadList();
}

/* Init */
document.addEventListener('DOMContentLoaded', loadList);
/* đóng modal khi click backdrop */
modal.addEventListener('click', (e)=>{ if(e.target === modal) closeEdit(); });
document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && modal.style.display==='flex') closeEdit(); });
</script>
{% endblock %}
