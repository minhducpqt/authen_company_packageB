{% extends "base.html" %}
{% block content %}

<div class="mb-6">
  <h2 class="text-lg font-semibold text-slate-700 mb-2">Tài khoản</h2>
  <div class="text-sm text-slate-600">
    <div><b>Username:</b> {{ profile.username }}</div>
    <div><b>Role:</b> {{ role }}</div>
    <div><b>Company:</b> {{ profile.company_code or "-" }}</div>
  </div>
</div>

{% if load_err %}
  <div class="p-3 rounded bg-red-50 text-red-700 text-sm mb-6">{{ load_err }}</div>
{% endif %}

{# ===== SUPER_ADMIN: danh sách công ty + nút Chi tiết ===== #}
{% if role == "SUPER_ADMIN" %}
  <div class="mb-8">
    <h2 class="text-lg font-semibold text-slate-700 mb-3">Danh sách công ty</h2>

    <form action="/account/super/company/create" method="post" class="flex gap-2 mb-4">
      <input name="company_code" placeholder="Company code" class="input" required>
      <input name="name" placeholder="Tên công ty" class="input" required>
      <button class="btn-primary" type="submit">Thêm công ty</button>
    </form>

    {% if super_companies and super_companies|length > 0 %}
      <div class="overflow-x-auto border rounded">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100">
            <tr>
              <th class="px-3 py-2 text-left">ID</th>
              <th class="px-3 py-2 text-left">Code</th>
              <th class="px-3 py-2 text-left">Tên</th>
              <th class="px-3 py-2 text-left">Trạng thái</th>
              <th class="px-3 py-2 text-left">Hành động</th>
            </tr>
          </thead>
          <tbody>
            {% for c in super_companies %}
            <tr class="border-t">
              <td class="px-3 py-2">{{ c.id }}</td>

              {# Click vào code cũng sang trang chi tiết #}
              <td class="px-3 py-2 font-mono">
                <a class="text-indigo-600 hover:underline" href="/account/company/{{ c.company_code }}">{{ c.company_code }}</a>
              </td>

              <td class="px-3 py-2">{{ c.name }}</td>

              <td class="px-3 py-2">
                {% if c.is_active %}<span class="text-green-600">Active</span>
                {% else %}<span class="text-slate-500">Disabled</span>{% endif %}
              </td>

              <td class="px-3 py-2 flex items-center gap-2">
                {# Nút CHI TIẾT / QUẢN TRỊ #}
                <a class="btn-primary" href="/account/company/{{ c.company_code }}">Chi tiết</a>

                {% if c.is_active %}
                  <form action="/account/super/company/disable" method="post"
                        onsubmit="return confirm('Tắt công ty {{ c.company_code }} ?');">
                    <input type="hidden" name="company_code" value="{{ c.company_code }}">
                    <button class="btn-secondary" type="submit">Disable</button>
                  </form>
                {% else %}
                  <form action="/account/super/company/enable" method="post"
                        onsubmit="return confirm('Bật công ty {{ c.company_code }} ?');">
                    <input type="hidden" name="company_code" value="{{ c.company_code }}">
                    <button class="btn-primary" type="submit">Enable</button>
                  </form>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-slate-500 text-sm">Chưa có công ty nào.</div>
    {% endif %}
  </div>
{% endif %}

{# ===== COMPANY_ADMIN: quản lý user công ty mình ===== #}
{% if role == "COMPANY_ADMIN" %}
  <div class="mb-8">
    <h2 class="text-lg font-semibold text-slate-700 mb-3">Tài khoản công ty</h2>

    <form action="/account/admin/user/create" method="post" class="flex gap-2 mb-4">
      <input name="username" placeholder="username (a-z0-9_)" class="input" required>
      <input name="password" placeholder="password" type="password" class="input" required>
      <select name="role" class="input">
        <option value="STAFF">STAFF</option>
        <option value="VIEWER">VIEWER</option>
        <option value="ACCOUNTANT">ACCOUNTANT</option>
        <option value="COMPANY_ADMIN">COMPANY_ADMIN</option>
      </select>
      <button class="btn-primary" type="submit">Thêm tài khoản</button>
    </form>

    {% if admin_users and admin_users|length > 0 %}
      <div class="overflow-x-auto border rounded">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100">
            <tr>
              <th class="px-3 py-2 text-left">ID</th>
              <th class="px-3 py-2 text-left">Username</th>
              <th class="px-3 py-2 text-left">Role</th>
              <th class="px-3 py-2 text-left">Trạng thái</th>
              <th class="px-3 py-2 text-left">Hành động</th>
            </tr>
          </thead>
          <tbody>
            {% for u in admin_users %}
            <tr class="border-t">
              <td class="px-3 py-2">{{ u.id }}</td>
              <td class="px-3 py-2 font-mono">{{ u.username }}</td>
              <td class="px-3 py-2">{{ u.role }}</td>
              <td class="px-3 py-2">
                {% if u.is_active %}<span class="text-green-600">Active</span>
                {% else %}<span class="text-slate-500">Disabled</span>{% endif %}
              </td>
              <td class="px-3 py-2">
                {% if u.is_active %}
                  <form action="/account/admin/user/toggle" method="post" class="inline"
                        onsubmit="return confirm('Disable user {{ u.username }} ?');">
                    <input type="hidden" name="user_id" value="{{ u.id }}">
                    <input type="hidden" name="action" value="disable">
                    <button class="btn-secondary" type="submit">Disable</button>
                  </form>
                {% else %}
                  <form action="/account/admin/user/toggle" method="post" class="inline"
                        onsubmit="return confirm('Enable user {{ u.username }} ?');">
                    <input type="hidden" name="user_id" value="{{ u.id }}">
                    <input type="hidden" name="action" value="enable">
                    <button class="btn-primary" type="submit">Enable</button>
                  </form>
                {% endif %}

                <form action="/account/admin/user/set-password" method="post" class="inline ml-2"
                      onsubmit="return confirm('Đặt lại mật khẩu cho {{ u.username }} ?');">
                  <input type="hidden" name="user_id" value="{{ u.id }}">
                  <input type="password" name="new_password" placeholder="new password" class="input" required>
                  <button class="btn-primary" type="submit">Set password</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-slate-500 text-sm">Chưa có tài khoản nào.</div>
    {% endif %}
  </div>
{% endif %}

{% endblock %}
