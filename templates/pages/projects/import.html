{% extends "base.html" %}
{% block content %}
<div class="bg-white rounded-xl border border-slate-200 p-5">
  <div class="flex items-center justify-between mb-4">
    <div>
      <h2 class="text-xl font-semibold text-slate-800">Xem trước dữ liệu import</h2>
      <p class="text-slate-500 text-sm">Kiểm tra kỹ trước khi ghi vào hệ thống.</p>
    </div>
    <div class="flex gap-2">
      <a href="/projects/import" class="btn btn-secondary">← Chọn file khác</a>
      <a href="/projects" class="btn btn-secondary">Danh sách dự án</a>
    </div>
  </div>

  {% if err %}
    <div class="mb-4 p-3 rounded-lg bg-rose-50 border border-rose-200 text-rose-700">
      <i class="ri-error-warning-line mr-1"></i> {{ err }}
    </div>
  {% endif %}

  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="p-4 rounded-lg bg-slate-50 border"><div class="text-sm text-slate-500">Số dự án</div><div class="text-2xl font-semibold">{{ preview.projects|length }}</div></div>
    <div class="p-4 rounded-lg bg-slate-50 border"><div class="text-sm text-slate-500">Số lô</div><div class="text-2xl font-semibold">{{ preview.lots|length }}</div></div>
    <div class="p-4 rounded-lg bg-slate-50 border"><div class="text-sm text-slate-500">Sẽ ghi đè (INACTIVE)</div><div class="text-2xl font-semibold text-amber-600">{{ preview.will_replace|length }}</div></div>
    <div class="p-4 rounded-lg bg-slate-50 border"><div class="text-sm text-slate-500">Lỗi</div><div class="text-2xl font-semibold text-rose-600">{{ preview.errors|length }}</div></div>
  </div>

  {% if preview.errors and preview.errors|length > 0 %}
  <div class="mb-6 p-4 rounded-lg border border-rose-200 bg-rose-50">
    <div class="font-medium text-rose-700 mb-2"><i class="ri-alert-line mr-1"></i> Lỗi cần sửa trước khi import</div>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-white">
          <tr class="text-left text-slate-600">
            <th class="px-3 py-2 border-b">Sheet</th>
            <th class="px-3 py-2 border-b">Dòng</th>
            <th class="px-3 py-2 border-b">Trường</th>
            <th class="px-3 py-2 border-b">Thông báo</th>
          </tr>
        </thead>
        <tbody>
          {% for e in preview.errors %}
          <tr>
            <td class="px-3 py-2 border-b">{{ e.sheet }}</td>
            <td class="px-3 py-2 border-b">{{ e.row }}</td>
            <td class="px-3 py-2 border-b">{{ e.field }}</td>
            <td class="px-3 py-2 border-b text-rose-700">{{ e.msg }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  <form method="post" action="/projects/import/apply" class="mb-8">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
      <div class="md:col-span-2">
        <label class="block text-sm text-slate-600 mb-1">Company code</label>
        <input type="text" name="company_code" value="{{ company_code }}" class="form-input" required>
        <p class="text-xs text-slate-400 mt-1">SUPER_ADMIN cần nhập company_code đích.</p>
      </div>
      <div>
        <label class="inline-flex items-center gap-2">
          <input type="checkbox" name="force_replace" class="rounded border-slate-300">
          <span class="text-sm text-slate-600">Cho phép ghi đè (INACTIVE)</span>
        </label>
      </div>
      <div class="text-right">
        <input type="hidden" name="payload" value='{{ payload_json|tojson|safe }}'>
        {% set has_errors = preview.errors and preview.errors|length > 0 %}
        <button type="submit"
                class="px-4 py-2 rounded-lg {{ 'bg-slate-300 cursor-not-allowed' if has_errors else 'bg-indigo-600 hover:bg-indigo-700 text-white' }}"
                {{ 'disabled' if has_errors }}>
          <i class="ri-upload-2-line mr-1"></i> Áp dụng import
        </button>
      </div>
    </div>
  </form>

  <details class="mb-6">
    <summary class="cursor-pointer font-medium text-slate-700">Xem danh sách dự án</summary>
    <div class="overflow-x-auto mt-2 border rounded-lg">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-50"><tr class="text-left"><th class="px-3 py-2 border-b">#</th><th class="px-3 py-2 border-b">project_code</th><th class="px-3 py-2 border-b">name</th><th class="px-3 py-2 border-b">description</th><th class="px-3 py-2 border-b">location</th></tr></thead>
        <tbody>
          {% for p in preview.projects[:200] %}
          <tr class="{{ 'bg-amber-50' if p.project_code in preview.will_replace else '' }}">
            <td class="px-3 py-2 border-b">{{ loop.index }}</td>
            <td class="px-3 py-2 border-b font-mono">{{ p.project_code }}</td>
            <td class="px-3 py-2 border-b">{{ p.name }}</td>
            <td class="px-3 py-2 border-b text-slate-600">{{ p.description }}</td>
            <td class="px-3 py-2 border-b">{{ p.location }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </details>

  <details>
    <summary class="cursor-pointer font-medium text-slate-700">Xem danh sách lô</summary>
    <div class="overflow-x-auto mt-2 border rounded-lg">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-50">
          <tr class="text-left">
            <th class="px-3 py-2 border-b">#</th>
            <th class="px-3 py-2 border-b">project_code</th>
            <th class="px-3 py-2 border-b">lot_code</th>
            <th class="px-3 py-2 border-b">name</th>
            <th class="px-3 py-2 border-b">description</th>
            <th class="px-3 py-2 border-b text-right">starting_price</th>
            <th class="px-3 py-2 border-b text-right">deposit_amount</th>
            <th class="px-3 py-2 border-b text-right">area</th>
          </tr>
        </thead>
        <tbody>
          {% for l in preview.lots[:200] %}
          <tr>
            <td class="px-3 py-2 border-b">{{ loop.index }}</td>
            <td class="px-3 py-2 border-b font-mono">{{ l.project_code }}</td>
            <td class="px-3 py-2 border-b font-mono">{{ l.lot_code }}</td>
            <td class="px-3 py-2 border-b">{{ l.name }}</td>
            <td class="px-3 py-2 border-b text-slate-600">{{ l.description }}</td>
            <td class="px-3 py-2 border-b text-right">{{ "{:,.0f}".format(l.starting_price) if l.starting_price is not none else "" }}</td>
            <td class="px-3 py-2 border-b text-right">{{ "{:,.0f}".format(l.deposit_amount) if l.deposit_amount is not none else "" }}</td>
            <td class="px-3 py-2 border-b text-right">{{ "{:,.2f}".format(l.area) if l.area is not none else "" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </details>
</div>
{% endblock %}
