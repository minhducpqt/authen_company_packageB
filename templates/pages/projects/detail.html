{% extends "base.html" %}
{% block content %}
<div class="bg-white rounded-xl border border-slate-200 p-5">
  <div class="flex items-center justify-between mb-4">
    <div>
      <h2 class="text-xl font-semibold text-slate-800">
        Chi tiết dự án
        {% if project %}
          <span class="font-mono text-slate-500">— {{ project.project_code }}</span>
        {% endif %}
      </h2>
      <p class="text-slate-500 text-sm">Thông tin tổng quan và danh sách lô thuộc dự án.</p>
    </div>
    <div class="flex gap-2">
      <a href="/projects" class="topbtn border border-slate-300 bg-white text-slate-700">
        ← Danh sách dự án
      </a>
    </div>
  </div>

  {% if load_err %}
    <div class="mb-4 p-3 rounded-lg bg-rose-50 border border-rose-200 text-rose-700">
      <i class="ri-error-warning-line mr-1"></i> {{ load_err }}
    </div>
  {% endif %}

  {% if not project %}
    <div class="p-4 rounded-lg bg-amber-50 border border-amber-200 text-amber-800">
      Không tìm thấy dự án.
    </div>
  {% else %}

  {# ================== THẺ THÔNG TIN DỰ ÁN ================== #}
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="p-4 rounded-lg bg-slate-50 border border-slate-200">
      <div class="text-slate-500 text-sm">Mã dự án</div>
      <div class="text-lg font-mono">{{ project.project_code }}</div>
    </div>
    <div class="p-4 rounded-lg bg-slate-50 border border-slate-200">
      <div class="text-slate-500 text-sm">Tên dự án</div>
      <div class="text-lg font-semibold">{{ project.name }}</div>
    </div>
    <div class="p-4 rounded-lg bg-slate-50 border border-slate-200">
      <div class="text-slate-500 text-sm">Trạng thái</div>
      {% set st = (project.status or '') %}
      <span class="inline-flex items-center px-2 py-1 rounded text-xs
        {% if st=='ACTIVE' %} bg-emerald-100 text-emerald-700 border border-emerald-200
        {% elif st=='INACTIVE' %} bg-amber-100 text-amber-700 border border-amber-200
        {% elif st=='CLOSED' %} bg-slate-200 text-slate-700 border border-slate-300
        {% else %} bg-slate-100 text-slate-600 border border-slate-200 {% endif %}">
        {{ st or 'UNKNOWN' }}
      </span>
    </div>

    <div class="md:col-span-3 p-4 rounded-lg bg-slate-50 border border-slate-200">
      <div class="text-slate-500 text-sm mb-1">Vị trí</div>
      <div>{{ project.location or '—' }}</div>
    </div>

    <div class="md:col-span-3 p-4 rounded-lg bg-slate-50 border border-slate-200">
      <div class="text-slate-500 text-sm mb-1">Mô tả</div>
      <div class="whitespace-pre-wrap">{{ project.description or '—' }}</div>
    </div>
  </div>

  {# ================== CẤU HÌNH TÀI KHOẢN NHẬN TIỀN ================== #}
  <div class="mb-8 p-5 rounded-xl border border-slate-200 bg-white">
    <div class="flex items-center justify-between mb-4">
      <h3 class="font-semibold text-slate-800">Cấu hình tài khoản nhận tiền</h3>
      {% if not can_edit %}
        <button id="btn-open-no-perm"
                type="button"
                class="px-3 h-9 rounded-lg border border-slate-300 bg-white text-slate-700 hover:bg-slate-50">
          Chỉnh sửa
        </button>
      {% endif %}
    </div>

    {% set sel_app = project.cba_application_id or (project.payment_accounts.cba_application_id if project.payment_accounts is defined else None) %}
    {% set sel_dep = project.cba_deposit_id     or (project.payment_accounts.cba_deposit_id     if project.payment_accounts is defined else None) %}

    <form method="post"
          action="/projects/{{ project.id }}/payment-accounts"
          class="grid grid-cols-1 md:grid-cols-2 gap-5">
      <div>
        <label class="text-sm text-slate-600 mb-2 block">Tài khoản nhận tiền mua hồ sơ</label>
        <select name="cba_application_id"
                class="w-full h-11 rounded-lg border border-slate-300 bg-white px-3 disabled:bg-slate-50"
                {% if not can_edit %}disabled{% endif %}>
          <option value="">— Chọn tài khoản —</option>
          {% for acc in company_accounts %}
            {% set b = acc.bank or {} %}
            {% set label = (b.short_name or b.name or b.code or '') ~
                           ((' — ' ~ (acc.account_number or '')) if acc.account_number else '') ~
                           ((' · ' ~ (acc.account_name or '')) if acc.account_name else '') %}
            <option value="{{ acc.id }}"
                    {% if sel_app and acc.id == sel_app %}selected{% endif %}>
              {{ label }}
            </option>
          {% endfor %}
        </select>
        <p class="text-xs text-slate-500 mt-1">Khoản người mua nộp khi mua hồ sơ.</p>
      </div>

      <div>
        <label class="text-sm text-slate-600 mb-2 block">Tài khoản nhận tiền đặt cọc</label>
        <select name="cba_deposit_id"
                class="w-full h-11 rounded-lg border border-slate-300 bg-white px-3 disabled:bg-slate-50"
                {% if not can_edit %}disabled{% endif %}>
          <option value="">— Chọn tài khoản —</option>
          {% for acc in company_accounts %}
            {% set b = acc.bank or {} %}
            {% set label = (b.short_name or b.name or b.code or '') ~
                           ((' — ' ~ (acc.account_number or '')) if acc.account_number else '') ~
                           ((' · ' ~ (acc.account_name or '')) if acc.account_name else '') %}
            <option value="{{ acc.id }}"
                    {% if sel_dep and acc.id == sel_dep %}selected{% endif %}>
              {{ label }}
            </option>
          {% endfor %}
        </select>
        <p class="text-xs text-slate-500 mt-1">Tiền đặt cọc khi tham gia đấu giá.</p>
      </div>

      <div class="md:col-span-2 mt-2">
        {% if can_edit %}
          <button type="submit"
                  class="px-5 h-11 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 shadow-sm">
            Lưu cấu hình
          </button>
        {% else %}
          <button type="button" id="btn-open-no-perm-2"
                  class="px-5 h-11 rounded-xl bg-indigo-600 text-white/70 cursor-not-allowed"
                  disabled>
            Lưu cấu hình
          </button>
        {% endif %}
      </div>
    </form>
  </div>

  {# ================== DANH SÁCH LÔ ================== #}
  <div class="flex items-center justify-between mb-2">
    <h3 class="font-semibold text-slate-800">Danh sách lô ({{ lots_page.total }})</h3>
  </div>
  <div class="overflow-x-auto border border-slate-200 rounded-lg">
    <table class="min-w-full text-sm">
      <thead class="bg-slate-50">
        <tr class="text-left text-slate-600">
          <th class="px-3 py-2 border-b">#</th>
          <th class="px-3 py-2 border-b">Mã lô</th>
          <th class="px-3 py-2 border-b">Tên lô</th>
          <th class="px-3 py-2 border-b text-right">Diện tích</th>
          <th class="px-3 py-2 border-b text-right">Giá khởi điểm</th>
          <th class="px-3 py-2 border-b text-right">Tiền cọc</th>
          <th class="px-3 py-2 border-b">Trạng thái</th>
        </tr>
      </thead>
      <tbody>
      {% for l in lots_page.data %}
        <tr>
          <td class="px-3 py-2 border-b">{{ loop.index }}</td>
          <td class="px-3 py-2 border-b font-mono">{{ l.lot_code }}</td>
          <td class="px-3 py-2 border-b">{{ l.name or '' }}</td>
          <td class="px-3 py-2 border-b text-right">
            {{ "{:,.2f}".format(l.area) if l.area is number else "" }}
          </td>
          <td class="px-3 py-2 border-b text-right">
            {{ "{:,.0f}".format(l.starting_price) if l.starting_price is number else "" }}
          </td>
          <td class="px-3 py-2 border-b text-right">
            {{ "{:,.0f}".format(l.deposit_amount) if l.deposit_amount is number else "" }}
          </td>
          <td class="px-3 py-2 border-b">
            {% set ls = (l.status or '') %}
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs
              {% if ls=='AVAILABLE' %} bg-emerald-100 text-emerald-700 border border-emerald-200
              {% elif ls=='LOCKED' %} bg-amber-100 text-amber-700 border border-amber-200
              {% elif ls=='SOLD' %} bg-slate-200 text-slate-700 border border-slate-300
              {% else %} bg-slate-100 text-slate-600 border border-slate-200 {% endif %}">
              {{ ls or '—' }}
            </span>
          </td>
        </tr>
      {% endfor %}
      {% if not lots_page.data or lots_page.data|length == 0 %}
        <tr>
          <td colspan="7" class="px-3 py-6 text-center text-slate-500">Chưa có lô nào trong dự án này.</td>
        </tr>
      {% endif %}
      </tbody>
    </table>
  </div>

  {% endif %}
</div>

{# ================== MODAL: KHÔNG CÓ QUYỀN ================== #}
<div id="modal-no-perm"
     class="hidden fixed inset-0 z-[60] flex items-center justify-center">
  <div class="absolute inset-0 bg-black/30"></div>
  <div class="relative w-[92%] max-w-md bg-white rounded-2xl shadow-2xl border border-slate-200 p-5">
    <div class="flex items-start gap-3">
      <i class="ri-error-warning-line text-amber-500 text-2xl"></i>
      <div>
        <h4 class="font-semibold text-slate-800">Bạn không có quyền chỉnh sửa</h4>
        <p class="text-slate-600 mt-1 text-sm">
          Chỉ <span class="font-medium">quản trị viên công ty</span> (hoặc SUPER/ADMIN) mới được cập nhật cấu hình tài khoản nhận tiền của dự án.
        </p>
      </div>
    </div>
    <div class="mt-4 flex justify-end">
      <button id="btn-close-no-perm"
              class="px-4 h-10 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">
        Đã hiểu
      </button>
    </div>
  </div>
</div>

<script>
  (function () {
    const $modal = document.getElementById('modal-no-perm');
    const $open1 = document.getElementById('btn-open-no-perm');
    const $open2 = document.getElementById('btn-open-no-perm-2');
    const $close = document.getElementById('btn-close-no-perm');
    function open() { $modal.classList.remove('hidden'); }
    function close() { $modal.classList.add('hidden'); }
    if ($open1) $open1.addEventListener('click', open);
    if ($open2) $open2.addEventListener('click', open);
    if ($close)  $close.addEventListener('click', close);
    $modal?.addEventListener('click', (e) => { if (e.target === $modal) close(); });
  })();
</script>
{% endblock %}
