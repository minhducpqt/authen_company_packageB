{% extends "base.html" %}
{% block content %}
<div class="bg-white rounded-xl border border-slate-200 p-5">
  <div class="flex items-center justify-between mb-4">
    <div>
      <h2 class="text-xl font-semibold text-slate-800">
        Chi tiết dự án
        {% if project %}
          <span class="font-mono text-slate-500">— {{ project.project_code }}</span>
        {% endif %}
      </h2>
      <p class="text-slate-500 text-sm">Thông tin tổng quan và danh sách lô thuộc dự án.</p>
    </div>
    <div class="flex gap-2">
      <a href="/projects" class="topbtn border border-slate-300 bg-white text-slate-700">
        ← Danh sách dự án
      </a>
    </div>
  </div>

  {% if load_err %}
    <div class="mb-4 p-3 rounded-lg bg-rose-50 border border-rose-200 text-rose-700">
      <i class="ri-error-warning-line mr-1"></i> {{ load_err }}
    </div>
  {% endif %}

  {% if not project %}
    <div class="p-4 rounded-lg bg-amber-50 border border-amber-200 text-amber-800">
      Không tìm thấy dự án.
    </div>
  {% else %}

  {% set auction_mode = (project.auction_mode or 'PER_LOT') %}
  {% set is_per_sqm = (auction_mode == 'PER_SQM') %}

  <!-- Thông tin dự án -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="p-4 rounded-lg bg-slate-50 border border-slate-200">
      <div class="text-slate-500 text-sm">Mã dự án</div>
      <div class="text-lg font-mono">{{ project.project_code }}</div>
    </div>

    <div class="p-4 rounded-lg bg-slate-50 border border-slate-200">
      <div class="text-slate-500 text-sm">Tên dự án</div>
      <div class="text-lg font-semibold">{{ project.name }}</div>
    </div>

    <!-- Trạng thái + chế độ đấu giá -->
    <div class="p-4 rounded-lg bg-slate-50 border border-slate-200">
      <div class="text-slate-500 text-sm mb-1">Trạng thái</div>
      <div class="flex items-center justify-between gap-2">

        <div>
          {% set st = (project.status or '') %}
          <span class="inline-flex items-center px-2 py-1 rounded text-xs
            {% if st=='ACTIVE' %} bg-emerald-100 text-emerald-700 border border-emerald-200
            {% elif st=='INACTIVE' %} bg-amber-100 text-amber-700 border border-amber-200
            {% elif st=='CLOSED' %} bg-slate-200 text-slate-700 border border-slate-300
            {% else %} bg-slate-100 text-slate-600 border border-slate-200 {% endif %}">
            {{ st or 'UNKNOWN' }}
          </span>
        </div>

        <form method="post" action="/projects/{{ project.id }}/auction-mode"
              class="flex items-center gap-1 text-xs text-slate-600">
          <label class="inline-flex items-center gap-1 cursor-pointer">
            <input
              type="checkbox"
              name="auction_mode_per_sqm"
              value="1"
              class="h-3 w-3 rounded border-slate-300 text-emerald-600 focus:ring-0"
              {% if is_per_sqm %}checked{% endif %}
              onchange="confirmAuctionMode(this)"
            >
            <span>Đấu theo <span class="font-semibold">m²</span></span>
          </label>
        </form>

      </div>

      <div class="mt-1 text-[11px] text-slate-500">
        Đang: <span class="font-semibold">
          {% if is_per_sqm %}TÍNH THEO M²{% else %}TÍNH THEO CẢ LÔ{% endif %}
        </span>
      </div>
    </div>

    <div class="md:col-span-3 p-4 rounded-lg bg-slate-50 border border-slate-200">
      <div class="text-slate-500 text-sm mb-1">Vị trí</div>
      <div>{{ project.location or '—' }}</div>
    </div>

    <div class="md:col-span-3 p-4 rounded-lg bg-slate-50 border border-slate-200">
      <div class="text-slate-500 text-sm mb-1">Mô tả</div>
      <div class="whitespace-pre-wrap">{{ project.description or '—' }}</div>
    </div>
  </div>

  <!-- Deadlines -->
  <form method="post" action="/projects/{{ project.id }}/deadlines" class="mb-6">
    <div class="p-4 rounded-lg bg-indigo-50 border border-indigo-200">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold text-slate-800">Mốc thời gian (deadline)</h3>
        <button
          type="submit"
          class="inline-flex items-center px-3 py-1.5 rounded-lg text-sm font-medium bg-indigo-600 text-white hover:bg-indigo-700">
          <i class="ri-save-3-line mr-1"></i> Lưu deadline
        </button>
      </div>

      <p class="text-xs text-slate-500 mb-3">
        Hiển thị theo giờ Việt Nam (UTC+7) dạng <code>dd/mm/yyyy HH:MM:SS</code>. Để trống nếu không giới hạn.
      </p>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

        <!-- Hạn bán hồ sơ -->
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">
            Hạn bán hồ sơ
          </label>

          <button
            type="button"
            id="dossier_deadline_at_display"
            class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm bg-white text-left hover:border-indigo-500 hover:ring-2 hover:ring-indigo-200 transition js-deadline-btn"
            data-field="dossier_deadline_at"
            data-raw="{{ project.application_deadline_at or '' }}"
          >
            —
          </button>

          <input
            type="hidden"
            id="dossier_deadline_at"
            name="dossier_deadline_at"
            value="{{ project.application_deadline_at or '' }}"
          >

          <p class="mt-1 text-xs text-slate-500">
            Giá trị hiện tại:
            <span class="deadline-summary" data-field="dossier_deadline_at">—</span>
          </p>
        </div>

        <!-- Hạn nhận tiền đặt trước -->
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">
            Hạn nhận tiền đặt trước
          </label>

          <button
            type="button"
            id="deposit_deadline_at_display"
            class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm bg-white text-left hover:border-indigo-500 hover:ring-2 hover:ring-indigo-200 transition js-deadline-btn"
            data-field="deposit_deadline_at"
            data-raw="{{ project.deposit_deadline_at or '' }}"
          >
            —
          </button>

          <input
            type="hidden"
            id="deposit_deadline_at"
            name="deposit_deadline_at"
            value="{{ project.deposit_deadline_at or '' }}"
          >

          <p class="mt-1 text-xs text-slate-500">
            Giá trị hiện tại:
            <span class="deadline-summary" data-field="deposit_deadline_at">—</span>
          </p>
        </div>

      </div>
    </div>
  </form>

  <!-- Auction config -->
  <form method="post" action="/projects/{{ project.id }}/auction-config" class="mb-6">
    <div class="p-4 rounded-lg bg-indigo-50 border border-indigo-200">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold text-slate-800">Thông tin phiên đấu giá</h3>
        <button
          type="submit"
          class="inline-flex items-center px-3 py-1.5 rounded-lg text-sm font-medium bg-indigo-600 text-white hover:bg-indigo-700">
          <i class="ri-save-3-line mr-1"></i> Lưu phiên đấu giá
        </button>
      </div>

      <p class="text-xs text-slate-500 mb-3">
        Dùng để in phiếu trúng đấu giá. Ngày giờ theo UTC+7 dạng <code>dd/mm/yyyy HH:MM:SS</code>.
      </p>

      {% set ac = auction_cfg or {} %}
      {% set ac_at = ac.auction_at or '' %}
      {% set ac_pc = ac.province_city or '' %}
      {% set ac_venue = ac.venue or '' %}

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

        <!-- Ngày đấu giá -->
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">
            Ngày đấu giá
          </label>

          <button
            type="button"
            id="auction_at_display"
            class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm bg-white text-left hover:border-indigo-500 hover:ring-2 hover:ring-indigo-200 transition js-deadline-btn"
            data-field="auction_at"
            data-raw="{{ ac_at }}"
          >
            —
          </button>

          <input
            type="hidden"
            id="auction_at"
            name="auction_at"
            value="{{ ac_at }}"
          >

          <p class="mt-1 text-xs text-slate-500">
            Giá trị hiện tại:
            <span class="deadline-summary" data-field="auction_at">—</span>
          </p>
        </div>

        <!-- Tỉnh/Thành tổ chức -->
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">
            Tỉnh/Thành tổ chức
          </label>
          <input
            type="text"
            name="province_city"
            value="{{ ac_pc }}"
            placeholder="Ví dụ: Hà Nội / Ninh Bình"
            class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition"
          >
          <p class="mt-1 text-xs text-slate-500">
            Dùng để in dòng: <span class="font-semibold">“Tỉnh/TP, ngày …”</span>
          </p>
        </div>

        <!-- Địa điểm đấu giá -->
        <div class="md:col-span-2">
          <label class="block text-xs font-medium text-slate-600 mb-1">
            Địa điểm đấu giá (cụ thể)
          </label>
          <textarea
            name="venue"
            rows="3"
            placeholder="Ví dụ: Hội trường UBND xã..., huyện..., tỉnh..."
            class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition whitespace-pre-wrap"
          >{{ ac_venue }}</textarea>
          <p class="mt-1 text-xs text-slate-500">
            Dùng để in câu “tại: …”. Có thể ghi dài.
          </p>
        </div>

      </div>
    </div>
  </form>

  <!-- DANH SÁCH LÔ -->
  <div class="flex items-center justify-between mb-2">
    <h3 class="font-semibold text-slate-800">Danh sách lô ({{ lots_page.total }})</h3>
  </div>

  <div class="overflow-x-auto border border-slate-200 rounded-lg">
    <table class="min-w-full text-sm">
      <thead class="bg-slate-50">
        <tr class="text-left text-slate-600">
          <th class="px-3 py-2 border-b">#</th>
          <th class="px-3 py-2 border-b">Mã lô</th>
          <th class="px-3 py-2 border-b">Tên lô</th>
          <th class="px-3 py-2 border-b text-right">Diện tích</th>
          <th class="px-3 py-2 border-b text-right">Giá khởi điểm</th>
          <th class="px-3 py-2 border-b text-right">Tiền cọc</th>
          <th class="px-3 py-2 border-b text-right">Bước giá (VND)</th>
          <th class="px-3 py-2 border-b">Trạng thái</th>
        </tr>
      </thead>
      <tbody>
        {% for l in lots_page.data %}
        <tr>
          <td class="px-3 py-2 border-b">{{ loop.index }}</td>
          <td class="px-3 py-2 border-b font-mono">{{ l.lot_code }}</td>
          <td class="px-3 py-2 border-b">{{ l.name or '' }}</td>
          <td class="px-3 py-2 border-b text-right">
            {{ "{:,.2f}".format(l.area) if l.area is number else "" }}
          </td>
          <td class="px-3 py-2 border-b text-right">
            {{ "{:,.0f}".format(l.starting_price) if l.starting_price is number else "" }}
          </td>
          <td class="px-3 py-2 border-b text-right">
            {{ "{:,.0f}".format(l.deposit_amount) if l.deposit_amount is number else "" }}
          </td>
          <td class="px-3 py-2 border-b text-right">
            {{ "{:,.0f}".format(l.bid_step_vnd) if l.bid_step_vnd is number else "" }}
          </td>
          <td class="px-3 py-2 border-b">
            {% set ls = (l.status or '') %}
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs
              {% if ls=='AVAILABLE' %} bg-emerald-100 text-emerald-700 border border-emerald-200
              {% elif ls=='LOCKED' %} bg-amber-100 text-amber-700 border border-amber-200
              {% elif ls=='SOLD' %} bg-slate-200 text-slate-700 border border-slate-300
              {% else %} bg-slate-100 text-slate-600 border border-slate-200 {% endif %}">
              {{ ls or '—' }}
            </span>
          </td>
        </tr>
        {% endfor %}

        {% if not lots_page.data %}
        <tr>
          <td colspan="8" class="px-3 py-6 text-center text-slate-500">
            Chưa có lô nào trong dự án này.
          </td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  {% endif %}
</div>

<!-- Modal confirm đổi chế độ đấu giá -->
<div id="auctionModeModal"
     class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl p-5 w-80 shadow-xl">
    <h3 class="font-semibold text-slate-800 mb-3">Xác nhận thay đổi chế độ đấu giá</h3>
    <p class="text-sm text-slate-600 mb-5">
      Bạn có chắc chắn muốn chuyển sang
      <span id="auctionModeLabel" class="font-semibold text-slate-800"></span>?
    </p>

    <div class="flex justify-end gap-2">
      <button type="button"
              class="px-3 py-1.5 rounded bg-slate-200 text-slate-700"
              onclick="closeAuctionModeModal()">Hủy</button>

      <button type="button"
              class="px-3 py-1.5 rounded bg-indigo-600 text-white"
              onclick="applyAuctionMode()">Xác nhận</button>
    </div>
  </div>
</div>

<!-- Overlay chọn datetime -->
<div id="dt_overlay" class="fixed inset-0 bg-black/40 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-xl p-5 w-80 shadow-xl">
    <h3 class="font-semibold text-slate-800 mb-3">Chọn ngày giờ</h3>

    <input id="dt_picker_input" type="datetime-local"
           class="w-full border border-slate-300 rounded-lg px-3 py-2 mb-4">

    <div class="flex justify-end gap-2">
      <button type="button"
              class="px-3 py-1.5 rounded bg-slate-200 text-slate-700"
              onclick="closePicker()">Hủy</button>
      <button type="button"
              class="px-3 py-1.5 rounded bg-indigo-600 text-white"
              onclick="applyPicker()">Áp dụng</button>
    </div>
  </div>
</div>

<script>
  /* -------------------------
     CONFIRM THAY ĐỔI AUCTION MODE
  ------------------------- */
  let auctionModePending = null;

  function confirmAuctionMode(checkbox) {
    auctionModePending = checkbox;
    const label = document.getElementById("auctionModeLabel");
    label.textContent = checkbox.checked ? "TÍNH THEO M²" : "TÍNH THEO CẢ LÔ";
    document.getElementById("auctionModeModal").classList.remove("hidden");
  }

  function closeAuctionModeModal() {
    if (auctionModePending) {
      auctionModePending.checked = !auctionModePending.checked;
    }
    auctionModePending = null;
    document.getElementById("auctionModeModal").classList.add("hidden");
  }

  function applyAuctionMode() {
    if (!auctionModePending) return;
    auctionModePending.form.submit();
    auctionModePending = null;
    document.getElementById("auctionModeModal").classList.add("hidden");
  }

  /* -------------------------
     DEADLINE PICKER (dùng chung cho deadline + auction_at)
  ------------------------- */
  let currentField = null;

  function parseRaw(raw) {
    if (!raw) return null;
    let s = String(raw).trim();
    if (!s) return null;

    const tzPosPlus = s.indexOf("+", 10);
    const tzPosMinus = s.indexOf("-", 10);
    const tzPosZ = s.indexOf("Z");
    let cut = s;

    if (tzPosPlus > 10) cut = s.slice(0, tzPosPlus);
    else if (tzPosMinus > 10) cut = s.slice(0, tzPosMinus);
    else if (tzPosZ > 0) cut = s.slice(0, tzPosZ);

    cut = cut.replace(" ", "T");
    const parts = cut.split("T");
    if (parts.length < 1) return null;

    const datePart = parts[0];
    const timePart = parts[1] || "00:00:00";

    const dArr = datePart.split("-");
    if (dArr.length !== 3) return null;
    const [year, month, day] = dArr;

    const tArr = timePart.split(":");
    const hh = tArr[0] || "00";
    const mm = tArr[1] || "00";
    const ss = tArr[2] || "00";

    return {year, month, day, hh, mm, ss};
  }

  function formatVN(raw) {
    const p = parseRaw(raw);
    if (!p) return "—";
    return `${p.day}/${p.month}/${p.year} ${p.hh}:${p.mm}:${p.ss} (giờ VN)`;
  }

  function toPickerValue(raw) {
    const p = parseRaw(raw);
    if (!p) return "";
    return `${p.year}-${p.month}-${p.day}T${p.hh}:${p.mm}`;
  }

  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".js-deadline-btn").forEach(function (btn) {
      const field = btn.getAttribute("data-field");
      const rawAttr = btn.getAttribute("data-raw") || "";
      const hidden = document.getElementById(field);
      const raw = (hidden && hidden.value) || rawAttr || "";

      const text = raw ? formatVN(raw) : "—";
      btn.textContent = text;

      const summary = document.querySelector(`.deadline-summary[data-field="${field}"]`);
      if (summary) summary.textContent = text;

      btn.addEventListener("click", function () {
        openPicker(field);
      });
    });
  });

  function openPicker(fieldName) {
    currentField = fieldName;
    const hiddenInput = document.getElementById(fieldName);
    const raw = hiddenInput ? hiddenInput.value : "";
    document.getElementById("dt_picker_input").value = toPickerValue(raw);
    document.getElementById("dt_overlay").classList.remove("hidden");
  }

  function closePicker() {
    document.getElementById("dt_overlay").classList.add("hidden");
    currentField = null;
  }

  function applyPicker() {
    if (!currentField) return;

    const val = document.getElementById("dt_picker_input").value;
    const hiddenInput = document.getElementById(currentField);
    const btn = document.getElementById(currentField + "_display");
    const summary = document.querySelector(
      `.deadline-summary[data-field="${currentField}"]`
    );

    if (val) {
      if (hiddenInput) hiddenInput.value = val;

      const displayText = formatVN(val);
      if (btn) btn.textContent = displayText;
      if (summary) summary.textContent = displayText;
    } else {
      if (hiddenInput) hiddenInput.value = "";
      if (btn) btn.textContent = "—";
      if (summary) summary.textContent = "—";
    }

    closePicker();
  }
</script>

{% endblock %}
