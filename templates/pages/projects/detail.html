{% extends "base.html" %}
{% block content %}
<div class="bg-white rounded-xl border border-slate-200 p-5">
  <div class="flex items-center justify-between mb-4">
    <div>
      <h2 class="text-xl font-semibold text-slate-800">
        Chi tiết dự án
        {% if project %}
          <span class="font-mono text-slate-500">— {{ project.project_code }}</span>
        {% endif %}
      </h2>
      <p class="text-slate-500 text-sm">Thông tin tổng quan và danh sách lô thuộc dự án.</p>
    </div>
    <div class="flex gap-2">
      <a href="/projects" class="topbtn border border-slate-300 bg-white text-slate-700">
        ← Danh sách dự án
      </a>
    </div>
  </div>

  {% if load_err %}
    <div class="mb-4 p-3 rounded-lg bg-rose-50 border border-rose-200 text-rose-700">
      <i class="ri-error-warning-line mr-1"></i> {{ load_err }}
    </div>
  {% endif %}

  {% if not project %}
    <div class="p-4 rounded-lg bg-amber-50 border border-amber-200 text-amber-800">
      Không tìm thấy dự án.
    </div>
  {% else %}

  {% set auction_mode = (project.auction_mode or 'PER_LOT') %}
  {% set is_per_sqm = (auction_mode == 'PER_SQM') %}

  {# NEW: bid ticket config default = true nếu không có key #}
  {% set btc = bid_ticket_cfg or {} %}
  {% set show_price_step = (btc.show_price_step if (btc.show_price_step is not none) else true) %}

  {# NEW: product_type #}
  {% set pj_pt = (project.product_type or '') %}

  <style>
    /* ===== Project inline edit icon (small + discreet) ===== */
    .pj-edit-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height:28px;
      width:28px;
      border-radius:10px;
      border:1px solid rgba(148,163,184,.8);
      color: rgba(71,85,105,.85);
      background: #fff;
      transition: .15s ease;
    }
    .pj-edit-btn:hover{
      color:#0f172a;
      border-color: rgba(99,102,241,.55);
      box-shadow: 0 0 0 3px rgba(99,102,241,.18);
    }
    .pj-edit-btn i{ font-size: 14px; }

    /* ===== Lot edit buttons: hidden by default, only show when enabled ===== */
    .lot-edit-btn{ display:none; }
    .lot-edit-enabled .lot-edit-btn{ display:inline-flex; }

    /* Tiny toggle at bottom */
    .lot-edit-toggle{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height:30px;
      width:30px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.55);
      background:#fff;
      color: rgba(100,116,139,.85);
      transition:.15s ease;
    }
    .lot-edit-toggle:hover{
      color:#0f172a;
      border-color: rgba(148,163,184,.85);
      box-shadow: 0 0 0 3px rgba(15,23,42,.06);
    }
    .lot-edit-toggle i{ font-size: 14px; }
    .lot-edit-toggle.is-on{
      color:#4f46e5;
      border-color: rgba(79,70,229,.35);
      box-shadow: 0 0 0 3px rgba(79,70,229,.15);
    }

    /* Project edit modal */
    #projectEditModal .pe-card{
      width: 96vw;
      max-width: 560px;
    }

    /* Product type modal */
    #productTypeModal .pt-card{
      width: 96vw;
      max-width: 640px;
    }
    #productTypeHintModal .pth-card{
      width: 96vw;
      max-width: 860px;
    }
  </style>

  <!-- Thông tin dự án -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="p-4 rounded-lg bg-slate-50 border border-slate-200">
      <div class="text-slate-500 text-sm">Mã dự án</div>
      <div class="text-lg font-mono">{{ project.project_code }}</div>
    </div>

    <div class="p-4 rounded-lg bg-slate-50 border border-slate-200">
      <div class="flex items-center justify-between gap-2">
        <div class="text-slate-500 text-sm">Tên dự án</div>
        <button
          type="button"
          class="pj-edit-btn"
          title="Sửa tên dự án"
          onclick="openProjectEdit('name')"
        >
          <i class="ri-edit-2-line"></i>
        </button>
      </div>
      <div class="text-lg font-semibold" id="pj_name_text">{{ project.name }}</div>
    </div>

    <!-- Trạng thái + chế độ đấu giá -->
    <div class="p-4 rounded-lg bg-slate-50 border border-slate-200">
      <div class="text-slate-500 text-sm mb-1">Trạng thái</div>
      <div class="flex items-center justify-between gap-2">

        <div>
          {% set st = (project.status or '') %}
          <span class="inline-flex items-center px-2 py-1 rounded text-xs
            {% if st=='ACTIVE' %} bg-emerald-100 text-emerald-700 border border-emerald-200
            {% elif st=='INACTIVE' %} bg-amber-100 text-amber-700 border border-amber-200
            {% elif st=='CLOSED' %} bg-slate-200 text-slate-700 border border-slate-300
            {% else %} bg-slate-100 text-slate-600 border border-slate-200 {% endif %}">
            {{ st or 'UNKNOWN' }}
          </span>
        </div>

        <form method="post" action="/projects/{{ project.id }}/auction-mode"
              class="flex items-center gap-1 text-xs text-slate-600">
          <label class="inline-flex items-center gap-1 cursor-pointer">
            <input
              id="auction_mode_checkbox"
              type="checkbox"
              name="auction_mode_per_sqm"
              value="1"
              class="h-3 w-3 rounded border-slate-300 text-emerald-600 focus:ring-0"
              {% if is_per_sqm %}checked{% endif %}
              onchange="confirmWithPhrase(this, {
                title: 'Xác nhận thay đổi chế độ đấu giá',
                descHtml: 'Bạn sắp chuyển chế độ tính tiền sang <b>' + (this.checked ? 'TÍNH THEO M²' : 'TÍNH THEO CẢ LÔ') + '</b>. Việc này ảnh hưởng tới cách nhập/hiển thị giá và báo cáo.',
                confirmText: 'Xác nhận',
                cancelText: 'Hủy',
                phrase: 'tôi xác nhận',
              })"
            >
            <span>Đấu theo <span class="font-semibold">m²</span></span>
          </label>
        </form>

      </div>

      <div class="mt-1 text-[11px] text-slate-500">
        Đang: <span class="font-semibold">
          {% if is_per_sqm %}TÍNH THEO M²{% else %}TÍNH THEO CẢ LÔ{% endif %}
        </span>
      </div>
    </div>

    <!-- ✅ NEW: Product type (hiển thị + edit + hint) -->
    <div class="md:col-span-3 p-4 rounded-lg bg-slate-50 border border-slate-200">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-slate-500 text-sm">Loại dự án (product type)</div>
          <div class="mt-1 flex items-center gap-2 flex-wrap">
            <span id="pj_product_type_badge"
              class="inline-flex items-center px-2 py-1 rounded text-xs border
              {% if pj_pt %} bg-indigo-50 text-indigo-700 border-indigo-200
              {% else %} bg-slate-100 text-slate-600 border-slate-200 {% endif %}">
              <span class="font-mono" id="pj_product_type_text">{{ pj_pt or '—' }}</span>
            </span>

            <span id="pj_product_type_label" class="text-sm text-slate-700">
              <!-- label sẽ được fill từ API khi mở modal (nếu có) -->
            </span>
          </div>

          <div class="mt-2 text-[11px] text-slate-500">
            Dùng để cấu hình luồng nghiệp vụ/hiển thị theo từng loại dự án.
          </div>
        </div>

        <div class="flex items-center gap-2">
          <button
            type="button"
            class="pj-edit-btn"
            title="Xem mô tả/bảng giá các loại type"
            onclick="openProductTypeHint()"
          >
            <i class="ri-information-line"></i>
          </button>

          <button
            type="button"
            class="pj-edit-btn"
            title="Chỉnh sửa loại dự án"
            onclick="openProductTypeEdit()"
          >
            <i class="ri-edit-2-line"></i>
          </button>
        </div>
      </div>
    </div>

    <div class="md:col-span-3 p-4 rounded-lg bg-slate-50 border border-slate-200">
      <div class="flex items-center justify-between gap-2 mb-1">
        <div class="text-slate-500 text-sm">Vị trí</div>
        <button
          type="button"
          class="pj-edit-btn"
          title="Sửa vị trí dự án"
          onclick="openProjectEdit('location')"
        >
          <i class="ri-edit-2-line"></i>
        </button>
      </div>
      <div id="pj_location_text">{{ project.location or '—' }}</div>
    </div>

    <div class="md:col-span-3 p-4 rounded-lg bg-slate-50 border border-slate-200">
      <div class="flex items-center justify-between gap-2 mb-1">
        <div class="text-slate-500 text-sm">Mô tả</div>
        <button
          type="button"
          class="pj-edit-btn"
          title="Sửa mô tả dự án"
          onclick="openProjectEdit('description')"
        >
          <i class="ri-edit-2-line"></i>
        </button>
      </div>
      <div class="whitespace-pre-wrap" id="pj_description_text">{{ project.description or '—' }}</div>
    </div>
  </div>

  <!-- NEW: Bid ticket config (toggle) -->
  <form method="post" action="/projects/{{ project.id }}/bid-ticket-config" class="mb-6">
    <div class="p-4 rounded-lg bg-indigo-50 border border-indigo-200">
      <div class="flex items-center justify-between gap-3">
        <div>
          <h3 class="font-semibold text-slate-800">Cấu hình phiếu trả giá</h3>
          <p class="text-xs text-slate-500 mt-1">
            Áp dụng khi in phiếu trả giá theo dự án.
          </p>
        </div>

        <label class="inline-flex items-center gap-2 text-sm text-slate-700 cursor-pointer select-none">
          <input
            id="show_price_step_checkbox"
            type="checkbox"
            name="show_price_step_raw"
            value="1"
            class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-0"
            {% if show_price_step %}checked{% endif %}
            onchange="confirmWithPhrase(this, {
              title: 'Xác nhận thay đổi cấu hình phiếu trả giá',
              descHtml: 'Bạn sắp <b>' + (this.checked ? 'BẬT' : 'TẮT') + '</b> cấu hình: <b>Có in bước giá trong phiếu trả giá</b>.',
              confirmText: 'Xác nhận',
              cancelText: 'Hủy',
              phrase: 'tôi xác nhận',
            })"
          >
          <span>Có in bước giá trong phiếu trả giá</span>
        </label>
      </div>

      <div class="mt-2 text-[11px] text-slate-500">
        Trạng thái hiện tại:
        <span class="font-semibold">
          {% if show_price_step %}ĐANG IN BƯỚC GIÁ{% else %}KHÔNG IN BƯỚC GIÁ{% endif %}
        </span>
      </div>
    </div>
  </form>

  <!-- Deadlines -->
  <form method="post" action="/projects/{{ project.id }}/deadlines" class="mb-6">
    <div class="p-4 rounded-lg bg-indigo-50 border border-indigo-200">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold text-slate-800">Mốc thời gian (deadline)</h3>
        <button
          type="submit"
          class="inline-flex items-center px-3 py-1.5 rounded-lg text-sm font-medium bg-indigo-600 text-white hover:bg-indigo-700">
          <i class="ri-save-3-line mr-1"></i> Lưu deadline
        </button>
      </div>

      <p class="text-xs text-slate-500 mb-3">
        Hiển thị theo giờ Việt Nam (UTC+7) dạng <code>dd/mm/yyyy HH:MM:SS</code>. Để trống nếu không giới hạn.
      </p>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

        <!-- Hạn bán hồ sơ -->
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">
            Hạn bán hồ sơ
          </label>

          <button
            type="button"
            id="dossier_deadline_at_display"
            class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm bg-white text-left hover:border-indigo-500 hover:ring-2 hover:ring-indigo-200 transition js-deadline-btn"
            data-field="dossier_deadline_at"
            data-raw="{{ project.application_deadline_at or '' }}"
          >
            —
          </button>

          <input
            type="hidden"
            id="dossier_deadline_at"
            name="dossier_deadline_at"
            value="{{ project.application_deadline_at or '' }}"
          >

          <p class="mt-1 text-xs text-slate-500">
            Giá trị hiện tại:
            <span class="deadline-summary" data-field="dossier_deadline_at">—</span>
          </p>
        </div>

        <!-- Hạn nhận tiền đặt trước -->
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">
            Hạn nhận tiền đặt trước
          </label>

          <button
            type="button"
            id="deposit_deadline_at_display"
            class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm bg-white text-left hover:border-indigo-500 hover:ring-2 hover:ring-indigo-200 transition js-deadline-btn"
            data-field="deposit_deadline_at"
            data-raw="{{ project.deposit_deadline_at or '' }}"
          >
            —
          </button>

          <input
            type="hidden"
            id="deposit_deadline_at"
            name="deposit_deadline_at"
            value="{{ project.deposit_deadline_at or '' }}"
          >

          <p class="mt-1 text-xs text-slate-500">
            Giá trị hiện tại:
            <span class="deadline-summary" data-field="deposit_deadline_at">—</span>
          </p>
        </div>

      </div>
    </div>
  </form>

  <!-- Auction config -->
  <form method="post" action="/projects/{{ project.id }}/auction-config" class="mb-6">
    <div class="p-4 rounded-lg bg-indigo-50 border border-indigo-200">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold text-slate-800">Thông tin phiên đấu giá</h3>
        <button
          type="submit"
          class="inline-flex items-center px-3 py-1.5 rounded-lg text-sm font-medium bg-indigo-600 text-white hover:bg-indigo-700">
          <i class="ri-save-3-line mr-1"></i> Lưu phiên đấu giá
        </button>
      </div>

      <p class="text-xs text-slate-500 mb-3">
        Dùng để in phiếu trúng đấu giá. Ngày giờ theo UTC+7 dạng <code>dd/mm/yyyy HH:MM:SS</code>.
      </p>

      {% set ac = auction_cfg or {} %}
      {% set ac_at = ac.auction_at or '' %}
      {% set ac_pc = ac.province_city or '' %}
      {% set ac_venue = ac.venue or '' %}

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

        <!-- Ngày đấu giá -->
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">
            Ngày đấu giá
          </label>

          <button
            type="button"
            id="auction_at_display"
            class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm bg-white text-left hover:border-indigo-500 hover:ring-2 hover:ring-indigo-200 transition js-deadline-btn"
            data-field="auction_at"
            data-raw="{{ ac_at }}"
          >
            —
          </button>

          <input
            type="hidden"
            id="auction_at"
            name="auction_at"
            value="{{ ac_at }}"
          >

          <p class="mt-1 text-xs text-slate-500">
            Giá trị hiện tại:
            <span class="deadline-summary" data-field="auction_at">—</span>
          </p>
        </div>
      </div>
    </div>
  </form>

  <!-- DANH SÁCH LÔ -->
  <div class="flex items-center justify-between mb-2">
    <h3 class="font-semibold text-slate-800">Danh sách lô ({{ lots_page.total }})</h3>
  </div>

  <div class="overflow-x-auto border border-slate-200 rounded-lg">
    <table class="min-w-full text-sm">
      <thead class="bg-slate-50">
        <tr class="text-left text-slate-600">
          <th class="px-3 py-2 border-b">#</th>
          <th class="px-3 py-2 border-b">Mã lô</th>
          <th class="px-3 py-2 border-b">Tên lô</th>
          <th class="px-3 py-2 border-b text-right">Diện tích</th>
          <th class="px-3 py-2 border-b text-right">Giá khởi điểm</th>
          <th class="px-3 py-2 border-b text-right">Tiền cọc</th>
          <th class="px-3 py-2 border-b text-right">Bước giá (VND)</th>
          <th class="px-3 py-2 border-b">Trạng thái</th>
          <th class="px-2 py-2 border-b text-right w-[44px]"></th>
        </tr>
      </thead>
      <tbody>
        {% for l in lots_page.data %}
        <tr data-lot-id="{{ l.id }}">
          <td class="px-3 py-2 border-b">{{ loop.index }}</td>

          <td class="px-3 py-2 border-b font-mono js-lot-code">{{ l.lot_code }}</td>
          <td class="px-3 py-2 border-b js-lot-name">{{ l.name or '' }}</td>
          <td class="px-3 py-2 border-b text-right js-lot-area">
            {{ "{:,.2f}".format(l.area) if l.area is number else "" }}
          </td>
          <td class="px-3 py-2 border-b text-right js-lot-starting-price">
            {{ "{:,.0f}".format(l.starting_price) if l.starting_price is number else "" }}
          </td>
          <td class="px-3 py-2 border-b text-right js-lot-deposit-amount">
            {{ "{:,.0f}".format(l.deposit_amount) if l.deposit_amount is number else "" }}
          </td>
          <td class="px-3 py-2 border-b text-right js-lot-bid-step">
            {{ "{:,.0f}".format(l.bid_step_vnd) if l.bid_step_vnd is number else "" }}
          </td>
          <td class="px-3 py-2 border-b js-lot-status">
            {% set ls = (l.status or '') %}
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs js-lot-status-badge
              {% if ls=='AVAILABLE' %} bg-emerald-100 text-emerald-700 border border-emerald-200
              {% elif ls=='LOCKED' %} bg-amber-100 text-amber-700 border border-amber-200
              {% elif ls=='SOLD' %} bg-slate-200 text-slate-700 border border-slate-300
              {% else %} bg-slate-100 text-slate-600 border border-slate-200 {% endif %}">
              {{ ls or '—' }}
            </span>
          </td>

          <!-- Lot edit button (hidden by default; enabled via tiny toggle at bottom) -->
          <td class="px-2 py-2 border-b text-right">
            <button
              type="button"
              class="lot-edit-btn inline-flex items-center justify-center h-8 w-8 rounded-lg text-slate-500 hover:text-slate-800 hover:bg-slate-100 transition"
              title="Sửa lô"
              onclick="openLotEditModal({{ l.id }})"
            >
              <i class="ri-edit-2-line text-[15px]"></i>
            </button>
          </td>
        </tr>
        {% endfor %}

        {% if not lots_page.data %}
        <tr>
          <td colspan="9" class="px-3 py-6 text-center text-slate-500">
            Chưa có lô nào trong dự án này.
          </td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Tiny toggle to show lot edit buttons (discreet) -->
  <div class="mt-3 flex items-center justify-end">
    <button
      type="button"
      id="lotEditToggle"
      class="lot-edit-toggle"
      title="Bật/Tắt nút sửa lô"
      onclick="toggleLotEditButtons()"
      aria-label="Bật/Tắt nút sửa lô"
    >
      <i class="ri-settings-3-line"></i>
    </button>
  </div>

  {% endif %}
</div>

{# =========================================================
   ✅ NEW: PRODUCT TYPE EDIT MODAL (fetch list -> select -> save -> confirm phrase -> call API update)
   ========================================================= #}
<div id="productTypeModal" class="fixed inset-0 bg-black/40 hidden z-50">
  <div class="absolute inset-0 flex items-center justify-center p-3">
    <div class="pt-card bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
      <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
        <div class="flex items-center gap-2">
          <div class="h-8 w-8 rounded-lg bg-indigo-50 flex items-center justify-center text-indigo-700 border border-indigo-200">
            <i class="ri-shape-line"></i>
          </div>
          <div>
            <div class="text-sm font-semibold text-slate-800">Chỉnh sửa loại dự án (product type)</div>
            <div class="text-xs text-slate-500">Chọn type trong danh sách, rồi bấm Lưu</div>
          </div>
        </div>

        <button type="button"
                class="h-9 w-9 inline-flex items-center justify-center rounded-lg text-slate-500 hover:text-slate-800 hover:bg-slate-100"
                onclick="closeProductTypeEdit()"
                title="Đóng">
          <i class="ri-close-line text-xl"></i>
        </button>
      </div>

      <div class="p-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="block text-xs font-medium text-slate-600 mb-1">Loại dự án hiện tại</label>
            <div class="rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-sm">
              <span class="font-mono" id="pt_current_code">{{ pj_pt or '—' }}</span>
              <span class="text-slate-500" id="pt_current_label"></span>
            </div>
          </div>

          <div>
            <label class="block text-xs font-medium text-slate-600 mb-1">Chọn loại dự án mới</label>
            <select id="pt_select"
              class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition"
              onchange="onProductTypeChanged()">
              <option value="">— Đang tải danh sách…</option>
            </select>
            <p class="mt-1 text-xs text-slate-500" id="pt_help">
              Danh sách được lấy từ API product types.
            </p>
          </div>
        </div>

        <div class="mt-3 p-3 rounded-lg bg-amber-50 border border-amber-200 text-amber-800 text-sm hidden" id="pt_err_box">
          <i class="ri-error-warning-line mr-1"></i> <span id="pt_err_text"></span>
        </div>

        <div class="flex justify-end gap-2 mt-4">
          <button type="button"
                  class="px-3 py-1.5 rounded-lg bg-slate-200 text-slate-700"
                  onclick="closeProductTypeEdit()">
            Hủy
          </button>

          <button id="ptSaveBtn"
                  type="button"
                  class="px-3 py-1.5 rounded-lg bg-indigo-600 text-white opacity-50 cursor-not-allowed"
                  onclick="saveProductType()"
                  disabled>
            Lưu
          </button>
        </div>

        <div class="mt-3 text-[11px] text-slate-500">
          Khi bấm <b>Lưu</b>, hệ thống sẽ yêu cầu nhập “<b>tôi xác nhận</b>” để tránh thao tác nhầm.
        </div>
      </div>
    </div>
  </div>
</div>

{# =========================================================
   ✅ NEW: PRODUCT TYPE HINT MODAL (bảng mô tả type)
   ========================================================= #}
<div id="productTypeHintModal" class="fixed inset-0 bg-black/40 hidden z-50">
  <div class="absolute inset-0 flex items-center justify-center p-3">
    <div class="pth-card bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
      <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
        <div class="flex items-center gap-2">
          <div class="h-8 w-8 rounded-lg bg-slate-100 flex items-center justify-center text-slate-600">
            <i class="ri-file-list-3-line"></i>
          </div>
          <div>
            <div class="text-sm font-semibold text-slate-800">Bảng mô tả các loại dự án (product type)</div>
            <div class="text-xs text-slate-500">Giúp người dùng chọn đúng type khi cấu hình</div>
          </div>
        </div>

        <button type="button"
                class="h-9 w-9 inline-flex items-center justify-center rounded-lg text-slate-500 hover:text-slate-800 hover:bg-slate-100"
                onclick="closeProductTypeHint()"
                title="Đóng">
          <i class="ri-close-line text-xl"></i>
        </button>
      </div>

      <div class="p-4">
        <div class="text-sm text-slate-600 mb-3">
          Bảng dưới sẽ ưu tiên lấy từ API (nếu API trả về mô tả). Nếu API không có mô tả, vẫn hiển thị code + tên.
        </div>

        <div class="overflow-x-auto border border-slate-200 rounded-lg">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50">
              <tr class="text-left text-slate-600">
                <th class="px-3 py-2 border-b w-[180px]">Code</th>
                <th class="px-3 py-2 border-b w-[240px]">Tên/Label</th>
                <th class="px-3 py-2 border-b">Mô tả / Gợi ý cấu hình</th>
              </tr>
            </thead>
            <tbody id="pth_tbody">
              <tr>
                <td colspan="3" class="px-3 py-6 text-center text-slate-500">
                  Đang tải danh sách…
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="mt-3 text-[11px] text-slate-500">
          Gợi ý: nếu cần “bảng giá” chi tiết theo nghiệp vụ, bạn có thể bổ sung mô tả/fee/notes vào API product types để UI hiển thị đầy đủ.
        </div>

        <div class="flex justify-end mt-4">
          <button type="button" class="px-3 py-1.5 rounded-lg bg-slate-200 text-slate-700" onclick="closeProductTypeHint()">
            Đóng
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

{# =========================================================
   ✅ NEW: PROJECT EDIT MODAL (name/location/description) with phrase confirm
   ========================================================= #}
<div id="projectEditModal" class="fixed inset-0 bg-black/40 hidden z-50">
  <div class="absolute inset-0 flex items-center justify-center p-3">
    <div class="pe-card bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
      <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
        <div class="flex items-center gap-2">
          <div class="h-8 w-8 rounded-lg bg-slate-100 flex items-center justify-center text-slate-600">
            <i class="ri-edit-2-line"></i>
          </div>
          <div>
            <div id="peTitle" class="text-sm font-semibold text-slate-800">Chỉnh sửa</div>
            <div class="text-xs text-slate-500">Nhập “tôi xác nhận” để bật nút lưu</div>
          </div>
        </div>

        <button type="button"
                class="h-9 w-9 inline-flex items-center justify-center rounded-lg text-slate-500 hover:text-slate-800 hover:bg-slate-100"
                onclick="closeProjectEdit()"
                title="Đóng">
          <i class="ri-close-line text-xl"></i>
        </button>
      </div>

      <form id="projectEditForm" method="post" action="/projects/{{ project.id }}/update" class="p-4">
        <input type="hidden" id="peField" value="">
        <div class="space-y-2">
          <label id="peLabel" class="block text-xs font-medium text-slate-600">Giá trị</label>

          <!-- single editor: will switch between input/textarea -->
          <input
            id="peInput"
            type="text"
            class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition hidden"
            value=""
          >

          <textarea
            id="peTextarea"
            rows="4"
            class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition whitespace-pre-wrap hidden"
          ></textarea>

          <div class="pt-2">
            <label class="block text-xs font-medium text-slate-600 mb-1">
              Nhập đúng: <span class="font-semibold text-slate-800">tôi xác nhận</span>
            </label>
            <input
              id="pePhrase"
              type="text"
              class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition"
              placeholder="Gõ: tôi xác nhận"
              autocomplete="off"
              oninput="onPePhraseInput()"
            >
            <p class="mt-1 text-xs text-slate-500">
              Mục đích: tránh bấm nhầm khi sửa thông tin dự án.
            </p>
          </div>
        </div>

        <div class="flex justify-end gap-2 mt-4">
          <button type="button"
                  class="px-3 py-1.5 rounded-lg bg-slate-200 text-slate-700"
                  onclick="closeProjectEdit()">
            Hủy
          </button>

          <button id="peSaveBtn"
                  type="button"
                  class="px-3 py-1.5 rounded-lg bg-indigo-600 text-white opacity-50 cursor-not-allowed"
                  onclick="submitProjectEdit()"
                  disabled>
            Lưu
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{# =========================================================
   ✅ NEW: LOT EDIT MODAL (iframe) - isolated, does not change existing flows
   ========================================================= #}
<div id="lotEditModal"
     class="fixed inset-0 bg-black/40 hidden z-50">
  <div class="absolute inset-0 flex items-center justify-center p-3">
    <div class="bg-white rounded-2xl shadow-xl border border-slate-200 w-[96vw] max-w-3xl h-[90vh] overflow-hidden">
      <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
        <div class="flex items-center gap-2">
          <div class="h-8 w-8 rounded-lg bg-slate-100 flex items-center justify-center text-slate-600">
            <i class="ri-edit-2-line"></i>
          </div>
          <div>
            <div class="text-sm font-semibold text-slate-800">Chỉnh sửa lô</div>
            <div id="lotEditSub" class="text-xs text-slate-500">—</div>
          </div>
        </div>

        <button type="button"
                class="h-9 w-9 inline-flex items-center justify-center rounded-lg text-slate-500 hover:text-slate-800 hover:bg-slate-100"
                onclick="closeLotEditModal()"
                title="Đóng">
          <i class="ri-close-line text-xl"></i>
        </button>
      </div>

      <iframe
        id="lotEditFrame"
        src="about:blank"
        class="w-full h-[calc(90vh-56px)]"
        style="border:0"
        referrerpolicy="no-referrer"
      ></iframe>
    </div>
  </div>
</div>

<!-- GLOBAL CONFIRM MODAL (phrase required) -->
<div id="confirmPhraseModal"
     class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl p-5 w-[92vw] max-w-md shadow-xl border border-slate-200">
    <div class="flex items-start justify-between gap-3">
      <h3 id="cpmTitle" class="font-semibold text-slate-900 text-base">Xác nhận</h3>
      <button type="button" class="text-slate-400 hover:text-slate-600" onclick="closeConfirmPhrase(false)">
        <i class="ri-close-line text-xl"></i>
      </button>
    </div>

    <div id="cpmDesc" class="text-sm text-slate-600 mt-2"></div>

    <div class="mt-4">
      <label class="block text-xs font-medium text-slate-600 mb-1">
        Nhập đúng: <span id="cpmPhraseLabel" class="font-semibold text-slate-800">tôi xác nhận</span>
      </label>
      <input id="cpmInput" type="text"
             class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition"
             placeholder='Gõ: tôi xác nhận'
             autocomplete="off"
             oninput="onCpmInput()">
      <p id="cpmHint" class="mt-1 text-xs text-slate-500">
        Để tránh bấm nhầm, bạn cần gõ đúng cụm từ xác nhận.
      </p>
    </div>

    <div class="flex justify-end gap-2 mt-5">
      <button type="button"
              class="px-3 py-1.5 rounded-lg bg-slate-200 text-slate-700"
              onclick="closeConfirmPhrase(false)">
        Hủy
      </button>

      <button id="cpmOkBtn" type="button"
              class="px-3 py-1.5 rounded-lg bg-indigo-600 text-white opacity-50 cursor-not-allowed"
              onclick="closeConfirmPhrase(true)" disabled>
        Xác nhận
      </button>
    </div>
  </div>
</div>

<!-- Overlay chọn datetime -->
<div id="dt_overlay" class="fixed inset-0 bg-black/40 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-xl p-5 w-80 shadow-xl">
    <h3 class="font-semibold text-slate-800 mb-3">Chọn ngày giờ</h3>

    <input id="dt_picker_input" type="datetime-local"
           class="w-full border border-slate-300 rounded-lg px-3 py-2 mb-4">

    <div class="flex justify-end gap-2">
      <button type="button"
              class="px-3 py-1.5 rounded bg-slate-200 text-slate-700"
              onclick="closePicker()">Hủy</button>
      <button type="button"
              class="px-3 py-1.5 rounded bg-indigo-600 text-white"
              onclick="applyPicker()">Áp dụng</button>
    </div>
  </div>
</div>

<script>
  /* =========================================================
     Product type endpoints (Service B proxy)
     NOTE: Nếu route của bạn khác, chỉ cần đổi 2 URL này.
     ========================================================= */
  const PRODUCT_TYPES_LIST_URL = `/projects/api/product_types`;
  const PRODUCT_TYPE_UPDATE_URL = `/projects/{{ project.id }}/product-type`;          // POST/PUT -> {product_type:"..."}

  /* =========================================================
     Shared helpers
     ========================================================= */
  function _norm(s){ return String(s || "").trim().toLowerCase(); }
  function _byId(id){ return document.getElementById(id); }

  function _safeJsonParse(txt){
    try{ return JSON.parse(txt); }catch(e){ return null; }
  }

  function _extractTypes(payload){
    // chấp nhận nhiều shape: array | {data:[]} | {items:[]} | {types:[]}
    if (!payload) return [];
    if (Array.isArray(payload)) return payload;
    if (Array.isArray(payload.data)) return payload.data;
    if (Array.isArray(payload.items)) return payload.items;
    if (Array.isArray(payload.types)) return payload.types;
    return [];
  }

  function _pickTypeFields(x){
    // normalize fields: code, label, description, note/fee
    const code = x.code || x.product_type || x.key || x.value || "";
    const label = x.label || x.name || x.title || "";
    const desc = x.description || x.desc || x.note || "";
    return {code:String(code||""), label:String(label||""), description:String(desc||"")};
  }

  /* =========================================================
     #A: Product type UI
     ========================================================= */
  const _pt = {
    modal: null,
    hintModal: null,
    select: null,
    saveBtn: null,
    errBox: null,
    errText: null,
    currentCode: "{{ pj_pt or '' }}",
    typesCache: null,
    selected: null,
  };

  function ptInit(){
    if (_pt.modal) return;
    _pt.modal = _byId("productTypeModal");
    _pt.hintModal = _byId("productTypeHintModal");
    _pt.select = _byId("pt_select");
    _pt.saveBtn = _byId("ptSaveBtn");
    _pt.errBox = _byId("pt_err_box");
    _pt.errText = _byId("pt_err_text");
  }

  function ptSetError(msg){
    ptInit();
    if (!msg){
      _pt.errBox.classList.add("hidden");
      _pt.errText.textContent = "";
      return;
    }
    _pt.errText.textContent = msg;
    _pt.errBox.classList.remove("hidden");
  }

  async function fetchProductTypesIfNeeded(){
    ptInit();
    if (_pt.typesCache) return _pt.typesCache;

    const res = await fetch(PRODUCT_TYPES_LIST_URL, {method:"GET", credentials:"same-origin"});
    if (!res.ok){
      const t = await res.text();
      throw new Error(`Không lấy được danh sách type (HTTP ${res.status}). ${t || ""}`.trim());
    }
    const txt = await res.text();
    const payload = _safeJsonParse(txt) || txt;
    const arr = _extractTypes(payload).map(_pickTypeFields).filter(x => x.code);
    _pt.typesCache = arr;
    return arr;
  }

  function fillProductTypeLabelsIfPossible(){
    // fill label cạnh badge (nếu API có)
    if (!_pt.typesCache) return;
    const cur = _pt.currentCode || "";
    const hit = _pt.typesCache.find(x => _norm(x.code) === _norm(cur));
    const labelEl = _byId("pj_product_type_label");
    if (!labelEl) return;
    labelEl.textContent = hit && hit.label ? ("— " + hit.label) : "";
  }

  function openProductTypeEdit(){
    ptInit();
    ptSetError(null);

    _pt.selected = null;
    _pt.saveBtn.disabled = true;
    _pt.saveBtn.classList.add("opacity-50","cursor-not-allowed");

    // show modal
    _pt.modal.classList.remove("hidden");

    // set current
    _byId("pt_current_code").textContent = (_pt.currentCode || "—");

    // load list
    _pt.select.innerHTML = `<option value="">— Đang tải danh sách…</option>`;
    (async ()=>{
      try{
        const types = await fetchProductTypesIfNeeded();

        // update current label in modal
        const curHit = types.find(x => _norm(x.code) === _norm(_pt.currentCode));
        _byId("pt_current_label").textContent = (curHit && curHit.label) ? ("— " + curHit.label) : "";

        // build options
        const opts = [];
        opts.push(`<option value="">— Chọn loại dự án —</option>`);
        for (const t of types){
          const selected = (_norm(t.code) === _norm(_pt.currentCode)) ? "selected" : "";
          const suffix = t.label ? ` — ${escapeHtml(t.label)}` : "";
          opts.push(`<option value="${escapeHtml(t.code)}" ${selected}>${escapeHtml(t.code)}${suffix}</option>`);
        }
        _pt.select.innerHTML = opts.join("");

        fillProductTypeLabelsIfPossible();
      }catch(e){
        ptSetError(String(e && e.message ? e.message : e));
        _pt.select.innerHTML = `<option value="">— Lỗi tải danh sách —</option>`;
      }
    })();
  }

  function closeProductTypeEdit(){
    ptInit();
    _pt.modal.classList.add("hidden");
  }

  function onProductTypeChanged(){
    ptInit();
    ptSetError(null);

    const v = String(_pt.select.value || "").trim();
    _pt.selected = v || null;

    const ok = !!_pt.selected && _norm(_pt.selected) !== _norm(_pt.currentCode || "");
    _pt.saveBtn.disabled = !ok;
    if (ok){
      _pt.saveBtn.classList.remove("opacity-50","cursor-not-allowed");
    }else{
      _pt.saveBtn.classList.add("opacity-50","cursor-not-allowed");
    }
  }

  async function doUpdateProductType(){
    ptInit();
    if (!_pt.selected) return;

    const payload = { product_type: _pt.selected };

    const res = await fetch(PRODUCT_TYPE_UPDATE_URL, {
      method: "POST", // nếu bạn dùng PUT thì đổi ở đây
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload),
      credentials: "same-origin",
    });

    if (!res.ok){
      const t = await res.text();
      throw new Error(`Cập nhật type thất bại (HTTP ${res.status}). ${t || ""}`.trim());
    }

    // Update UI locally (không reload để mượt)
    _pt.currentCode = _pt.selected;
    const codeEl = _byId("pj_product_type_text");
    if (codeEl) codeEl.textContent = _pt.currentCode || "—";

    const badge = _byId("pj_product_type_badge");
    if (badge){
      // set style like "has value"
      badge.className = "inline-flex items-center px-2 py-1 rounded text-xs border bg-indigo-50 text-indigo-700 border-indigo-200";
    }

    // update label next to badge (if we have)
    if (_pt.typesCache){
      const hit = _pt.typesCache.find(x => _norm(x.code) === _norm(_pt.currentCode));
      const labelEl = _byId("pj_product_type_label");
      if (labelEl) labelEl.textContent = (hit && hit.label) ? ("— " + hit.label) : "";
    }

    closeProductTypeEdit();
  }

  function saveProductType(){
    ptInit();
    if (_pt.saveBtn.disabled) return;

    // show phrase confirm modal, and on confirm -> call API update
    const selected = _pt.selected;
    let label = "";
    try{
      if (_pt.typesCache){
        const hit = _pt.typesCache.find(x => _norm(x.code) === _norm(selected));
        label = hit && hit.label ? hit.label : "";
      }
    }catch(e){}

    confirmWithPhrase(null, {
      title: "Xác nhận thay đổi loại dự án",
      descHtml:
        "Bạn sắp đổi <b>loại dự án</b> sang: " +
        `<b class="font-mono">${escapeHtml(selected)}</b>` +
        (label ? ` — <b>${escapeHtml(label)}</b>` : "") +
        ".<br><span class='text-slate-500 text-sm'>Thao tác này có thể ảnh hưởng các luồng nghiệp vụ theo dự án.</span>",
      confirmText: "Xác nhận",
      cancelText: "Hủy",
      phrase: "tôi xác nhận",
      onConfirm: async function(){
        try{
          await doUpdateProductType();
        }catch(e){
          ptSetError(String(e && e.message ? e.message : e));
          // reopen modal if user closed it
          try{ _pt.modal.classList.remove("hidden"); }catch(err){}
        }
      }
    });
  }

  /* Hint modal */
  function openProductTypeHint(){
    ptInit();
    _pt.hintModal.classList.remove("hidden");
    renderProductTypeHintTable();
  }
  function closeProductTypeHint(){
    ptInit();
    _pt.hintModal.classList.add("hidden");
  }

  async function renderProductTypeHintTable(){
    const tbody = _byId("pth_tbody");
    if (!tbody) return;

    tbody.innerHTML = `<tr><td colspan="3" class="px-3 py-6 text-center text-slate-500">Đang tải danh sách…</td></tr>`;

    try{
      const types = await fetchProductTypesIfNeeded();
      if (!types.length){
        tbody.innerHTML = `<tr><td colspan="3" class="px-3 py-6 text-center text-slate-500">Không có dữ liệu type.</td></tr>`;
        return;
      }

      const rows = types.map(t => {
        const desc = t.description ? escapeHtml(t.description) : "<span class='text-slate-400'>—</span>";
        const label = t.label ? escapeHtml(t.label) : "<span class='text-slate-400'>—</span>";
        return `
          <tr>
            <td class="px-3 py-2 border-b font-mono">${escapeHtml(t.code)}</td>
            <td class="px-3 py-2 border-b">${label}</td>
            <td class="px-3 py-2 border-b text-slate-700">${desc}</td>
          </tr>
        `;
      });
      tbody.innerHTML = rows.join("");
      fillProductTypeLabelsIfPossible();
    }catch(e){
      tbody.innerHTML = `<tr><td colspan="3" class="px-3 py-6 text-center text-rose-600">Lỗi tải danh sách: ${escapeHtml(String(e && e.message ? e.message : e))}</td></tr>`;
    }
  }

  /* Escape HTML for safe innerHTML */
  function escapeHtml(s){
    return String(s || "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  /* click outside closes product modals */
  document.addEventListener("click", function(e){
    const m1 = _byId("productTypeModal");
    if (m1 && !m1.classList.contains("hidden") && e.target === m1) closeProductTypeEdit();

    const m2 = _byId("productTypeHintModal");
    if (m2 && !m2.classList.contains("hidden") && e.target === m2) closeProductTypeHint();
  });

  /* =========================================================
     #1: Project edit modal (name/location/description) with phrase confirm
     ========================================================= */
  const _pe = {
    el: null,
    titleEl: null,
    labelEl: null,
    fieldEl: null,
    inputEl: null,
    taEl: null,
    phraseEl: null,
    saveBtn: null,
    formEl: null,
  };

  function peInit(){
    if (_pe.el) return;
    _pe.el = document.getElementById("projectEditModal");
    _pe.titleEl = document.getElementById("peTitle");
    _pe.labelEl = document.getElementById("peLabel");
    _pe.fieldEl = document.getElementById("peField");
    _pe.inputEl = document.getElementById("peInput");
    _pe.taEl = document.getElementById("peTextarea");
    _pe.phraseEl = document.getElementById("pePhrase");
    _pe.saveBtn = document.getElementById("peSaveBtn");
    _pe.formEl = document.getElementById("projectEditForm");
  }

  function openProjectEdit(field){
    peInit();
    _pe.fieldEl.value = field;

    // reset phrase
    _pe.phraseEl.value = "";
    _pe.saveBtn.disabled = true;
    _pe.saveBtn.classList.add("opacity-50","cursor-not-allowed");

    // swap editor types
    _pe.inputEl.classList.add("hidden");
    _pe.taEl.classList.add("hidden");

    if (field === "name"){
      _pe.titleEl.textContent = "Sửa tên dự án";
      _pe.labelEl.textContent = "Tên dự án";
      _pe.inputEl.value = (document.getElementById("pj_name_text")?.textContent || "").trim();
      _pe.inputEl.classList.remove("hidden");
      _pe.inputEl.focus();
    }else if (field === "location"){
      _pe.titleEl.textContent = "Sửa vị trí dự án";
      _pe.labelEl.textContent = "Vị trí";
      const cur = (document.getElementById("pj_location_text")?.textContent || "").trim();
      _pe.inputEl.value = (cur === "—" ? "" : cur);
      _pe.inputEl.classList.remove("hidden");
      _pe.inputEl.focus();
    }else if (field === "description"){
      _pe.titleEl.textContent = "Sửa mô tả dự án";
      _pe.labelEl.textContent = "Mô tả";
      const cur = (document.getElementById("pj_description_text")?.textContent || "");
      _pe.taEl.value = (cur.trim() === "—" ? "" : cur);
      _pe.taEl.classList.remove("hidden");
      _pe.taEl.focus();
    }else{
      return;
    }

    _pe.el.classList.remove("hidden");
  }

  function closeProjectEdit(){
    peInit();
    _pe.el.classList.add("hidden");
  }

  function onPePhraseInput(){
    peInit();
    const ok = _norm(_pe.phraseEl.value) === "tôi xác nhận";
    _pe.saveBtn.disabled = !ok;
    if (ok){
      _pe.saveBtn.classList.remove("opacity-50","cursor-not-allowed");
    }else{
      _pe.saveBtn.classList.add("opacity-50","cursor-not-allowed");
    }
  }

  function submitProjectEdit(){
    peInit();
    if (_pe.saveBtn.disabled) return;

    const field = _pe.fieldEl.value;
    let value = "";

    if (field === "description"){
      value = _pe.taEl.value;
    }else{
      value = _pe.inputEl.value;
    }

    // Remove existing dynamic field inputs (if any)
    try{
      _pe.formEl.querySelectorAll("input[data-pe-dyn], textarea[data-pe-dyn]").forEach(x => x.remove());
    }catch(e){}

    // Create a hidden field with the exact name expected by Service B endpoint: name/location/description
    const h = document.createElement("input");
    h.type = "hidden";
    h.name = field;
    h.value = (value || "").trim();
    h.setAttribute("data-pe-dyn","1");
    _pe.formEl.appendChild(h);

    _pe.formEl.submit();
  }

  // click outside closes project edit modal
  document.addEventListener("click", function(e){
    const m = document.getElementById("projectEditModal");
    if (!m || m.classList.contains("hidden")) return;
    if (e.target === m) closeProjectEdit();
  });

  // ESC closes project edit modal (but not interfere confirm modal)
  document.addEventListener("keydown", function(e){
    if (e.key === "Escape"){
      const cpm = document.getElementById("confirmPhraseModal");
      if (cpm && !cpm.classList.contains("hidden")) return;
      const lotm = document.getElementById("lotEditModal");
      if (lotm && !lotm.classList.contains("hidden")) return;
      const pem = document.getElementById("projectEditModal");
      if (pem && !pem.classList.contains("hidden")){
        closeProjectEdit();
      }
    }
  });

  /* =========================================================
     #2: Lot edit buttons - hidden by default; toggle to reveal
     ========================================================= */
  function toggleLotEditButtons(){
    const btn = document.getElementById("lotEditToggle");
    const on = document.documentElement.classList.toggle("lot-edit-enabled");
    try{
      if (btn){
        btn.classList.toggle("is-on", on);
        btn.title = on ? "Đang bật nút sửa lô" : "Bật/Tắt nút sửa lô";
      }
    }catch(e){}
  }

  /* =========================================================
     Existing: Lot edit modal (iframe) - unchanged logic
     ========================================================= */
  function openLotEditModal(lotId){
    const m = document.getElementById("lotEditModal");
    const f = document.getElementById("lotEditFrame");
    const sub = document.getElementById("lotEditSub");

    if (!m || !f) return;

    try{
      const row = document.querySelector(`tr[data-lot-id="${lotId}"]`);
      const code = row ? (row.querySelector(".js-lot-code")?.textContent || "").trim() : "";
      sub.textContent = code ? ("Lô: " + code) : "—";
    }catch(e){}

    f.src = `/lots/${lotId}/edit?embed=1`;
    m.classList.remove("hidden");
  }

  function closeLotEditModal(){
    const m = document.getElementById("lotEditModal");
    const f = document.getElementById("lotEditFrame");
    if (!m) return;
    m.classList.add("hidden");
    if (f) f.src = "about:blank";
  }

  document.addEventListener("click", function(e){
    const m = document.getElementById("lotEditModal");
    if (!m || m.classList.contains("hidden")) return;
    if (e.target === m) closeLotEditModal();
  });

  document.addEventListener("keydown", function(e){
    if (e.key === "Escape"){
      const cpm = document.getElementById("confirmPhraseModal");
      if (cpm && !cpm.classList.contains("hidden")) return;
      const pem = document.getElementById("projectEditModal");
      if (pem && !pem.classList.contains("hidden")) return;
      const ptm = document.getElementById("productTypeModal");
      if (ptm && !ptm.classList.contains("hidden")) return;
      const pth = document.getElementById("productTypeHintModal");
      if (pth && !pth.classList.contains("hidden")) return;

      const m = document.getElementById("lotEditModal");
      if (m && !m.classList.contains("hidden")){
        closeLotEditModal();
      }
    }
  });

  window.addEventListener("message", function(event){
    const msg = event && event.data ? event.data : null;
    if (!msg || typeof msg !== "object") return;
    if (msg.type !== "LOT_UPDATED") return;

    const lotId = msg.lot_id;
    const lot = msg.lot;

    if (!lotId || !lot) return;

    try{
      const row = document.querySelector(`tr[data-lot-id="${lotId}"]`);
      if (!row) return;

      function fmt0(v){
        if (v === null || v === undefined || v === "") return "";
        const n = Number(v);
        if (!isFinite(n)) return "";
        return n.toLocaleString("en-US", {maximumFractionDigits:0});
      }
      function fmt2(v){
        if (v === null || v === undefined || v === "") return "";
        const n = Number(v);
        if (!isFinite(n)) return "";
        return n.toLocaleString("en-US", {minimumFractionDigits:2, maximumFractionDigits:2});
      }

      if (lot.lot_code !== undefined){
        const el = row.querySelector(".js-lot-code");
        if (el) el.textContent = (lot.lot_code || "");
      }
      if (lot.name !== undefined){
        const el = row.querySelector(".js-lot-name");
        if (el) el.textContent = (lot.name || "");
      }
      if (lot.area !== undefined){
        const el = row.querySelector(".js-lot-area");
        if (el) el.textContent = (lot.area === null ? "" : fmt2(lot.area));
      }
      if (lot.starting_price !== undefined){
        const el = row.querySelector(".js-lot-starting-price");
        if (el) el.textContent = (lot.starting_price === null ? "" : fmt0(lot.starting_price));
      }
      if (lot.deposit_amount !== undefined){
        const el = row.querySelector(".js-lot-deposit-amount");
        if (el) el.textContent = (lot.deposit_amount === null ? "" : fmt0(lot.deposit_amount));
      }
      if (lot.bid_step_vnd !== undefined){
        const el = row.querySelector(".js-lot-bid-step");
        if (el) el.textContent = (lot.bid_step_vnd === null ? "" : fmt0(lot.bid_step_vnd));
      }
      if (lot.status !== undefined){
        const badge = row.querySelector(".js-lot-status-badge");
        if (badge){
          const ls = (lot.status || "");
          badge.textContent = ls || "—";

          badge.className = "inline-flex items-center px-2 py-0.5 rounded text-xs js-lot-status-badge";
          if (ls === "AVAILABLE"){
            badge.className += " bg-emerald-100 text-emerald-700 border border-emerald-200";
          }else if (ls === "LOCKED"){
            badge.className += " bg-amber-100 text-amber-700 border border-amber-200";
          }else if (ls === "SOLD"){
            badge.className += " bg-slate-200 text-slate-700 border border-slate-300";
          }else{
            badge.className += " bg-slate-100 text-slate-600 border border-slate-200";
          }
        }
      }

      try{
        const sub = document.getElementById("lotEditSub");
        if (sub && lot.lot_code) sub.textContent = "Lô: " + lot.lot_code;
      }catch(e){}

    }catch(e){}

    closeLotEditModal();
  });

  /* -------------------------
     PHRASE CONFIRM MODAL (custom)
     ✅ UPDATED: hỗ trợ opts.onConfirm để dùng cho fetch API (product type)
  ------------------------- */
  let _cpm = {
    el: null,
    titleEl: null,
    descEl: null,
    inputEl: null,
    okBtn: null,
    phraseLabelEl: null,
    pendingEl: null,
    pendingPrev: null,
    phrase: "tôi xác nhận",
    onConfirm: null,
  };

  function ensureCpmInit(){
    if (_cpm.el) return;
    _cpm.el = document.getElementById("confirmPhraseModal");
    _cpm.titleEl = document.getElementById("cpmTitle");
    _cpm.descEl = document.getElementById("cpmDesc");
    _cpm.inputEl = document.getElementById("cpmInput");
    _cpm.okBtn = document.getElementById("cpmOkBtn");
    _cpm.phraseLabelEl = document.getElementById("cpmPhraseLabel");
  }

  function confirmWithPhrase(el, opts){
    ensureCpmInit();

    _cpm.pendingEl = el;
    _cpm.pendingPrev = (el && typeof el.checked === "boolean") ? (!el.checked) : null;

    _cpm.phrase = (opts && opts.phrase) ? String(opts.phrase) : "tôi xác nhận";

    // ✅ NEW: allow custom onConfirm callback (e.g., fetch API)
    if (opts && typeof opts.onConfirm === "function"){
      _cpm.onConfirm = opts.onConfirm;
    }else{
      _cpm.onConfirm = function(){
        if (el && el.form) el.form.submit();
      };
    }

    _cpm.titleEl.textContent = (opts && opts.title) ? opts.title : "Xác nhận";
    _cpm.descEl.innerHTML = (opts && opts.descHtml) ? opts.descHtml : "";
    _cpm.phraseLabelEl.textContent = _cpm.phrase;

    _cpm.inputEl.value = "";
    _cpm.okBtn.disabled = true;
    _cpm.okBtn.classList.add("opacity-50","cursor-not-allowed");

    _cpm.el.classList.remove("hidden");

    setTimeout(()=>{ try{ _cpm.inputEl.focus(); }catch(e){} }, 0);
  }

  function onCpmInput(){
    ensureCpmInit();
    const ok = _norm(_cpm.inputEl.value) === _norm(_cpm.phrase);
    _cpm.okBtn.disabled = !ok;
    if (ok){
      _cpm.okBtn.classList.remove("opacity-50","cursor-not-allowed");
    }else{
      _cpm.okBtn.classList.add("opacity-50","cursor-not-allowed");
    }
  }

  function closeConfirmPhrase(confirmed){
    ensureCpmInit();

    _cpm.el.classList.add("hidden");

    if (!confirmed){
      if (_cpm.pendingEl && typeof _cpm.pendingEl.checked === "boolean" && _cpm.pendingPrev !== null){
        _cpm.pendingEl.checked = _cpm.pendingPrev;
      }
      _cpm.pendingEl = null;
      _cpm.pendingPrev = null;
      _cpm.onConfirm = null;
      return;
    }

    try{
      if (typeof _cpm.onConfirm === "function") _cpm.onConfirm();
    }finally{
      _cpm.pendingEl = null;
      _cpm.pendingPrev = null;
      _cpm.onConfirm = null;
    }
  }

  document.addEventListener("keydown", function(e){
    if (e.key === "Escape"){
      const m = document.getElementById("confirmPhraseModal");
      if (m && !m.classList.contains("hidden")){
        closeConfirmPhrase(false);
      }
    }
  });

  /* =========================================================
     DEADLINE PICKER (dùng chung cho deadline + auction_at) - unchanged
  ========================================================= */
  let currentField = null;

  function parseRaw(raw) {
    if (!raw) return null;
    let s = String(raw).trim();
    if (!s) return null;

    const tzPosPlus = s.indexOf("+", 10);
    const tzPosMinus = s.indexOf("-", 10);
    const tzPosZ = s.indexOf("Z");
    let cut = s;

    if (tzPosPlus > 10) cut = s.slice(0, tzPosPlus);
    else if (tzPosMinus > 10) cut = s.slice(0, tzPosMinus);
    else if (tzPosZ > 0) cut = s.slice(0, tzPosZ);

    cut = cut.replace(" ", "T");
    const parts = cut.split("T");
    if (parts.length < 1) return null;

    const datePart = parts[0];
    const timePart = parts[1] || "00:00:00";

    const dArr = datePart.split("-");
    if (dArr.length !== 3) return null;
    const [year, month, day] = dArr;

    const tArr = timePart.split(":");
    const hh = tArr[0] || "00";
    const mm = tArr[1] || "00";
    const ss = tArr[2] || "00";

    return {year, month, day, hh, mm, ss};
  }

  function formatVN(raw) {
    const p = parseRaw(raw);
    if (!p) return "—";
    return `${p.day}/${p.month}/${p.year} ${p.hh}:${p.mm}:${p.ss} (giờ VN)`;
  }

  function toPickerValue(raw) {
    const p = parseRaw(raw);
    if (!p) return "";
    return `${p.year}-${p.month}-${p.day}T${p.hh}:${p.mm}`;
  }

  document.addEventListener("DOMContentLoaded", function () {
    // deadlines init
    document.querySelectorAll(".js-deadline-btn").forEach(function (btn) {
      const field = btn.getAttribute("data-field");
      const rawAttr = btn.getAttribute("data-raw") || "";
      const hidden = document.getElementById(field);
      const raw = (hidden && hidden.value) || rawAttr || "";

      const text = raw ? formatVN(raw) : "—";
      btn.textContent = text;

      const summary = document.querySelector(`.deadline-summary[data-field="${field}"]`);
      if (summary) summary.textContent = text;

      btn.addEventListener("click", function () {
        openPicker(field);
      });
    });

    // best-effort: load types once to show label near badge
    (async ()=>{
      try{
        await fetchProductTypesIfNeeded();
        fillProductTypeLabelsIfPossible();
      }catch(e){}
    })();
  });

  function openPicker(fieldName) {
    currentField = fieldName;
    const hiddenInput = document.getElementById(fieldName);
    const raw = hiddenInput ? hiddenInput.value : "";
    document.getElementById("dt_picker_input").value = toPickerValue(raw);
    document.getElementById("dt_overlay").classList.remove("hidden");
  }

  function closePicker() {
    document.getElementById("dt_overlay").classList.add("hidden");
    currentField = null;
  }

  function applyPicker() {
    if (!currentField) return;

    const val = document.getElementById("dt_picker_input").value;
    const hiddenInput = document.getElementById(currentField);
    const btn = document.getElementById(currentField + "_display");
    const summary = document.querySelector(
      `.deadline-summary[data-field="${currentField}"]`
    );

    if (val) {
      if (hiddenInput) hiddenInput.value = val;

      const displayText = formatVN(val);
      if (btn) btn.textContent = displayText;
      if (summary) summary.textContent = displayText;
    } else {
      if (hiddenInput) hiddenInput.value = "";
      if (btn) btn.textContent = "—";
      if (summary) summary.textContent = "—";
    }

    closePicker();
  }
</script>

{% endblock %}