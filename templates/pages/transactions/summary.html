{% extends "base.html" %}
{% block content %}
<div class="bg-white rounded-xl border border-slate-200">
  <!-- FILTER BAR -->
  <div class="p-4 flex flex-wrap gap-4 items-center">
    <div class="w-72">
      <label class="block text-sm text-slate-500 mb-1">Dự án</label>
      <select id="projectSelect" class="w-full border rounded-lg px-3 py-2">
        <option value="">Tất cả dự án</option>
      </select>
    </div>
    <div class="flex-1 min-w-[280px]">
      <label class="block text-sm text-slate-500 mb-1">Tìm khách (Tên/CCCD/SDT)</label>
      <input id="searchInput" type="text" placeholder="Gõ để tìm..." class="w-full border rounded-lg px-3 py-2">
    </div>
    <div class="w-28">
      <label class="block text-sm text-slate-500 mb-1">Trang</label>
      <input id="pageInput" type="number" min="1" value="{{ init_page or 1 }}" class="w-full border rounded-lg px-3 py-2">
    </div>
    <div class="w-28">
      <label class="block text-sm text-slate-500 mb-1">Size</label>
      <select id="sizeSelect" class="w-full border rounded-lg px-3 py-2">
        {% for n in [25,50,100] %}
        <option value="{{n}}" {% if (init_size or 50) == n %}selected{% endif %}>{{n}}</option>
        {% endfor %}
      </select>
    </div>
    <button id="refreshBtn" class="h-10 px-4 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">
      <i class="ri-refresh-line"></i> Nạp
    </button>
  </div>

  <!-- TABLE -->
  <div class="border-t border-slate-100">
    <table class="w-full text-sm">
      <thead class="bg-slate-50">
        <tr class="text-left text-slate-600">
          <th class="py-3 px-4">Họ tên</th>
          <th class="py-3 px-4">CCCD</th>
          <th class="py-3 px-4">SĐT</th>
          <th class="py-3 px-4 text-right">Hồ sơ (mua/đã dùng/còn)</th>
          <th class="py-3 px-4">Lô đã cọc</th>
          <th class="py-3 px-4">QR chờ chuyển</th>
        </tr>
      </thead>
      <tbody id="dataBody">
        <tr><td class="py-6 px-4 text-slate-400" colspan="6">Đang tải...</td></tr>
      </tbody>
    </table>
  </div>

  <div class="p-4 flex items-center justify-between text-sm text-slate-500">
    <div id="totalInfo">Tổng: 0</div>
    <div class="flex items-center gap-2">
      <button id="prevBtn" class="px-3 py-1 rounded border">Trước</button>
      <button id="nextBtn" class="px-3 py-1 rounded border">Sau</button>
    </div>
  </div>
</div>

<script>
(function() {
  const DATA_URL = "/transactions/summary/data";
  const PROJECTS_URL = "/projects/options/active";

  const elProject = document.getElementById("projectSelect");
  const elSearch  = document.getElementById("searchInput");
  const elPage    = document.getElementById("pageInput");
  const elSize    = document.getElementById("sizeSelect");
  const elBody    = document.getElementById("dataBody");
  const elTotal   = document.getElementById("totalInfo");
  const btnPrev   = document.getElementById("prevBtn");
  const btnNext   = document.getElementById("nextBtn");
  const btnRefresh= document.getElementById("refreshBtn");

  elSearch.value = "{{ init_q or '' }}";
  elProject.dataset.init = "{{ init_project_code or '' }}";

  let t; function debounce(fn, ms=400){ clearTimeout(t); t=setTimeout(fn, ms); }

  function statsCompact(list) {
    // list item: {label, purchased, used, available}
    if (!Array.isArray(list) || !list.length) return "-";
    return list.map(x => {
      const label = x.label ?? x.dossier_type_id ?? "?";
      const p = Number(x.purchased ?? 0);
      const u = Number(x.used ?? 0);
      const a = Number(x.available ?? 0);
      return `${label}: ${p}/${u}/${a}`;
    }).join("; ");
  }

  function chipList(list, field) {
    if (!Array.isArray(list) || !list.length) return "-";
    return list.slice(0,3).map(x => {
      const code = x[field] ?? "-";
      return `<span class="inline-block px-2 py-0.5 rounded bg-slate-100 text-slate-700 mr-1">${code}</span>`;
    }).join("") + (list.length>3 ? ` +${list.length-3}` : "");
  }

  function rowHtml(r) {
    const full = r.full_name ?? "-";
    const cccd = r.cccd ?? "-";
    const phone = r.phone ?? "-";
    const ds = statsCompact(r.dossier_stats);
    const lotsPaid = chipList(r.lots_paid, "lot_code");
    const lotsPending = chipList(r.lots_pending_qr, "lot_code");
    return `
      <tr class="border-t align-top">
        <td class="py-3 px-4">${full}</td>
        <td class="py-3 px-4">${cccd}</td>
        <td class="py-3 px-4">${phone}</td>
        <td class="py-3 px-4 text-right">${ds}</td>
        <td class="py-3 px-4">${lotsPaid}</td>
        <td class="py-3 px-4">${lotsPending}</td>
      </tr>
    `;
  }

  async function loadProjects() {
    try {
      const r = await fetch(PROJECTS_URL, {headers: {"X-Requested-With":"fetch"}});
      const js = await r.json();
      const list = js.data ?? js.items ?? [];
      elProject.innerHTML = `<option value="">Tất cả dự án</option>`;
      for (const p of list) {
        const code = p.project_code ?? p.code ?? "";
        const name = p.name ?? code;
        const opt = document.createElement("option");
        opt.value = code;
        opt.textContent = `${code} — ${name}`;
        elProject.appendChild(opt);
      }
      const initCode = elProject.dataset.init;
      if (initCode) elProject.value = initCode;
    } catch (e) { console.warn(e); }
  }

  async function loadData() {
    const q = (elSearch.value || "").trim();
    const page = parseInt(elPage.value || "1", 10) || 1;
    const size = parseInt(elSize.value || "50", 10) || 50;
    const project_code = elProject.value || "";

    const params = new URLSearchParams({ page, size });
    if (q) params.set("q", q);
    if (project_code) params.set("project_code", project_code);

    elBody.innerHTML = `<tr><td class="py-6 px-4 text-slate-400" colspan="6">Đang tải...</td></tr>`;
    const r = await fetch(`${DATA_URL}?${params.toString()}`, {headers: {"X-Requested-With":"fetch"}});
    const js = await r.json();
    const rows = js.data ?? js.items ?? [];
    const total = js.total ?? 0;

    if (!rows.length) {
      elBody.innerHTML = `<tr><td class="py-6 px-4 text-slate-400" colspan="6">Không có dữ liệu</td></tr>`;
    } else {
      elBody.innerHTML = rows.map(rowHtml).join("");
    }
    elTotal.textContent = `Tổng: ${total.toLocaleString()}`;
  }

  elProject.addEventListener("change", () => { elPage.value = "1"; loadData(); });
  elSize.addEventListener("change", () => { elPage.value = "1"; loadData(); });
  elPage.addEventListener("change", loadData);
  btnPrev.addEventListener("click", () => { elPage.value = Math.max(1, (parseInt(elPage.value||"1")-1)); loadData(); });
  btnNext.addEventListener("click", () => { elPage.value = (parseInt(elPage.value||"1")+1); loadData(); });
  btnRefresh.addEventListener("click", loadData);
  elSearch.addEventListener("input", () => debounce(() => { elPage.value="1"; loadData(); }, 350));

  loadProjects().then(loadData);
})();
</script>
{% endblock %}
