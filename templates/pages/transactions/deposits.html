{% extends "base.html" %}
{% block content %}
<div class="bg-white rounded-xl border border-slate-200 p-4">
  <form id="filterForm" class="flex flex-wrap items-end gap-3">
    <div>
      <label class="form-label">Dự án</label>
      <input id="project_code" name="project_code" class="form-input" placeholder="Mã dự án" value="{{ init_project_code }}">
    </div>
    <div>
      <label class="form-label">Tìm khách</label>
      <input id="q" name="q" class="form-input" placeholder="Tên/CCCD/SDT" value="{{ init_q }}">
    </div>
    <div>
      <label class="form-label">Trang</label>
      <input id="page" name="page" type="number" class="form-input w-28" value="{{ init_page }}">
    </div>
    <div>
      <label class="form-label">Size</label>
      <input id="size" name="size" type="number" class="form-input w-28" value="{{ init_size }}">
    </div>
    <button type="submit" class="btn-primary"><i class="ri-search-line mr-1"></i>Lọc</button>
  </form>
</div>

<div id="result" class="mt-4"></div>

<script>
async function fetchData() {
  const pc = document.getElementById("project_code").value.trim();
  const q  = document.getElementById("q").value.trim();
  const page = document.getElementById("page").value || 1;
  const size = document.getElementById("size").value || 50;

  const params = new URLSearchParams({ page, size });
  if (pc) params.append("project_code", pc);
  if (q)  params.append("q", q);

  const r = await fetch(`/transactions/deposits/data?${params.toString()}`);
  const el = document.getElementById("result");
  if (!r.ok) {
    el.innerHTML = `<div class="alert-error">Lỗi tải dữ liệu (${r.status}).</div>`;
    return;
  }
  const data = await r.json();
  renderList(el, data);
}

function renderList(el, payload) {
  const rows = (payload.data || []).map((it) => {
    const customer = it.customer || {};
    const paidLots = it.paid_lots || 0;
    const pendingLots = it.pending_qr_lots || 0;
    const totalAmount = it.total_amount_vnd || 0;
    return `
      <tr class="border-b">
        <td class="px-3 py-2">${customer.full_name || "-"}</td>
        <td class="px-3 py-2">${customer.cccd || "-"}</td>
        <td class="px-3 py-2">${customer.phone || "-"}</td>
        <td class="px-3 py-2 text-right">${paidLots}</td>
        <td class="px-3 py-2 text-right">${pendingLots}</td>
        <td class="px-3 py-2 text-right">${totalAmount.toLocaleString('vi-VN')}</td>
      </tr>
    `;
  }).join("");

  el.innerHTML = `
    <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
      <table class="w-full text-sm">
        <thead class="bg-slate-50 text-slate-600">
          <tr>
            <th class="px-3 py-2 text-left">Họ tên</th>
            <th class="px-3 py-2 text-left">CCCD</th>
            <th class="px-3 py-2 text-left">SĐT</th>
            <th class="px-3 py-2 text-right">Lô đã cọc</th>
            <th class="px-3 py-2 text-right">Lô chờ chuyển</th>
            <th class="px-3 py-2 text-right">Tổng tiền (VND)</th>
          </tr>
        </thead>
        <tbody>${rows || `<tr><td colspan="6" class="px-3 py-6 text-center text-slate-400">Không có dữ liệu</td></tr>`}</tbody>
      </table>
    </div>
  `;
}

document.getElementById("filterForm").addEventListener("submit", function (e) {
  e.preventDefault();
  fetchData();
});

fetchData();
</script>
{% endblock %}
