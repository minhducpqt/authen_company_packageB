{% extends "base.html" %}
{% block content %}
<div class="bg-white rounded-xl border border-slate-200" id="pageRoot" data-company="{{ company_code or '' }}">
  <!-- FILTER BAR -->
  <div class="p-4 flex flex-wrap gap-4 items-center">
    <div class="w-72">
      <label class="block text-sm text-slate-500 mb-1">Dự án</label>
      <select id="projectSelect" class="w-full border rounded-lg px-3 py-2">
        <option value="">Tất cả dự án</option>
      </select>
    </div>

    <div class="flex-1 min-w-[280px]">
      <label class="block text-sm text-slate-500 mb-1">Tìm khách (Tên/CCCD/SDT)</label>
      <input id="searchInput" type="text" placeholder="Gõ để tìm..." class="w-full border rounded-lg px-3 py-2">
    </div>

    <div class="w-28">
      <label class="block text-sm text-slate-500 mb-1">Trang</label>
      <input id="pageInput" type="number" min="1" value="{{ init_page or 1 }}" class="w-full border rounded-lg px-3 py-2">
    </div>
    <div class="w-28">
      <label class="block text-sm text-slate-500 mb-1">Size</label>
      <select id="sizeSelect" class="w-full border rounded-lg px-3 py-2">
        {% for n in [25,50,100] %}
        <option value="{{n}}" {% if (init_size or 50) == n %}selected{% endif %}>{{n}}</option>
        {% endfor %}
      </select>
    </div>

    <button id="refreshBtn" class="h-10 px-4 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">
      <i class="ri-refresh-line"></i> Nạp
    </button>
  </div>

  <!-- TABLE -->
  <div class="border-t border-slate-100 overflow-x-auto">
    <table class="w-full text-sm">
      <thead class="bg-slate-50">
        <tr class="text-left text-slate-600">
          <th class="py-3 px-4">Khách</th>
          <th class="py-3 px-4">CCCD</th>
          <th class="py-3 px-4">SĐT</th>
          <th class="py-3 px-4 text-right">Đã trả</th>
          <th class="py-3 px-4 text-right">Pending</th>
          <th class="py-3 px-4 text-right">QR chờ TT</th>
          <th class="py-3 px-4 text-right">Đơn</th>
        </tr>
      </thead>
      <tbody id="dataBody">
        <tr><td class="py-6 px-4 text-slate-400" colspan="7">Đang tải...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- FOOTER -->
  <div class="p-4 flex items-center justify-between text-sm text-slate-500">
    <div id="totalInfo">Tổng: 0</div>
    <div class="flex items-center gap-2">
      <button id="prevBtn" class="px-3 py-1 rounded border">Trước</button>
      <button id="nextBtn" class="px-3 py-1 rounded border">Sau</button>
    </div>
  </div>
</div>

<!-- SLIDE-OVER DETAIL (giữ nguyên) -->
<div id="drawer" class="fixed inset-0 hidden z-40">
  <div class="absolute inset-0 bg-black/40" id="drawerBackdrop"></div>
  <div class="absolute right-0 top-0 h-full w-full sm:w-[560px] bg-white shadow-2xl flex flex-col">
    <div class="px-5 py-4 border-b flex items-center justify-between">
      <div class="space-y-0.5">
        <div class="text-xs text-slate-500">Chi tiết khách hàng</div>
        <div id="drawerTitle" class="font-semibold">—</div>
      </div>
      <button id="drawerClose" class="h-8 w-8 rounded-full hover:bg-slate-100 flex items-center justify-center">
        <i class="ri-close-line text-xl"></i>
      </button>
    </div>

    <div id="drawerHeaderStats" class="px-5 py-3 grid grid-cols-3 gap-3 border-b"></div>

    <div class="px-5 pt-3">
      <div class="flex gap-2">
        <button data-tab="paid" class="tab px-3 py-1.5 rounded-lg border text-sm">Đã trả</button>
        <button data-tab="pending" class="tab px-3 py-1.5 rounded-lg border text-sm">Pending</button>
        <button data-tab="qr" class="tab px-3 py-1.5 rounded-lg border text-sm">QR active</button>
        <button data-tab="all" class="tab px-3 py-1.5 rounded-lg border text-sm">Tất cả đơn</button>
      </div>
    </div>

    <div class="flex-1 overflow-auto p-5 space-y-4" id="tabContent"></div>
  </div>
</div>

<!-- DOC MODAL -->
<div id="docModal" class="fixed inset-0 hidden z-50">
  <div class="absolute inset-0 bg-black/50" id="docBackdrop"></div>
  <div class="absolute inset-4 sm:inset-10 bg-white rounded-xl shadow-2xl flex flex-col overflow-hidden">
    <div class="px-4 py-3 border-b flex items-center justify-between">
      <div class="font-semibold">Đơn đăng ký tham gia đấu giá</div>
      <div class="flex items-center gap-2">
        <button id="btnDocDownload" class="px-3 py-1.5 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">
          <i class="ri-download-2-line"></i> Tải PDF
        </button>
        <button id="btnDocClose" class="h-9 w-9 rounded-full hover:bg-slate-100 flex items-center justify-center">
          <i class="ri-close-line text-xl"></i>
        </button>
      </div>
    </div>
    <iframe id="docFrame" class="flex-1 w-full" style="border:0"></iframe>
  </div>
</div>

<script>
(function(){
  const DATA_URL = "/transactions/deposits/data";
  const PROJ_URL = "/projects/options/active";
  const DETAIL_URL = (cid) => `/transactions/customers/${cid}/orders?type=DEPOSIT`;
  const DOC_URL = (company_code, project_code, cccd) => {
    const p = new URLSearchParams();
    if (company_code) p.set("company_code", company_code);
    p.set("project_code", project_code);
    p.set("cccd", cccd);
    return `/documents/auction/registration?${p.toString()}`;
  };

  const root     = document.getElementById("pageRoot");
  const COMPANY  = root.dataset.company || "";
  const elProject= document.getElementById("projectSelect");
  const elSearch = document.getElementById("searchInput");
  const elPage   = document.getElementById("pageInput");
  const elSize   = document.getElementById("sizeSelect");
  const elBody   = document.getElementById("dataBody");
  const elTotal  = document.getElementById("totalInfo");
  const btnPrev  = document.getElementById("prevBtn");
  const btnNext  = document.getElementById("nextBtn");
  const btnRefresh = document.getElementById("refreshBtn");

  // drawer
  const drawer = document.getElementById("drawer");
  const drawerBackdrop = document.getElementById("drawerBackdrop");
  const drawerClose = document.getElementById("drawerClose");
  const drawerTitle = document.getElementById("drawerTitle");
  const headerStats = document.getElementById("drawerHeaderStats");
  const tabContent = document.getElementById("tabContent");

  // doc modal
  const docModal = document.getElementById("docModal");
  const docBackdrop = document.getElementById("docBackdrop");
  const btnDocClose = document.getElementById("btnDocClose");
  const btnDocDownload = document.getElementById("btnDocDownload");
  const docFrame = document.getElementById("docFrame");

  // init server defaults
  elSearch.value = "{{ init_q or '' }}";
  elProject.dataset.init = "{{ init_project_code or '' }}";

  let t; const debounce=(fn,ms=350)=>{ clearTimeout(t); t=setTimeout(fn,ms); };

  function chip(number,label){
    return `<div class="rounded-xl border p-3">
      <div class="text-2xl font-semibold">${(number||0).toLocaleString()}</div>
      <div class="text-xs text-slate-500 mt-0.5">${label}</div>
    </div>`;
  }

  function orderItemsTable(items){
    if (!items?.length) return `<div class="text-slate-500">Không có item</div>`;
    const rows = items.map(i=>{
      const lot = i.lot_code ?? i.ref_id ?? '-';
      const depo = i.deposit_amount ?? i.total_vnd ?? 0;
      return `<tr>
        <td class="px-3 py-2">Lô ${lot}</td>
        <td class="px-3 py-2 text-right" colspan="2">—</td>
        <td class="px-3 py-2 text-right">${depo.toLocaleString()}</td>
      </tr>`;
    }).join("");
    return `<div class="overflow-x-auto border rounded-lg">
      <table class="w-full text-sm">
        <thead class="bg-slate-50">
          <tr><th class="px-3 py-2 text-left">Hạng mục</th><th class="px-3 py-2 text-right" colspan="2">SL/Đơn giá</th><th class="px-3 py-2 text-right">Thành tiền</th></tr>
        </thead><tbody>${rows}</tbody>
      </table></div>`;
  }

  function ordersSection(title, orders, itemsByOrder, qrByOrder){
    if (!orders?.length) return '';
    return `<div class="rounded-xl border">
      <div class="px-4 py-3 border-b font-medium">${title}</div>
      <div class="p-4 space-y-4">
        ${orders.map(o=>{
          const its = itemsByOrder[o.order_id] || [];
          const qrs = qrByOrder[o.order_id] || [];
          const tag = o.status ? `<span class="ml-2 text-xs px-2 py-0.5 rounded-full border">${o.status}</span>` : '';
          const qrHtml = qrs?.length ? `<div class="mt-2 text-xs text-slate-600">
            ${qrs.map(q=>`QR ${q.qr_id ?? ''} • ${(q.amount_vnd??0).toLocaleString()}đ • HSD: ${q.expires_at ?? '-'}`).join('<br/>')}
          </div>` : '';
          return `<div class="rounded-lg border p-3">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-medium">Đơn ${o.order_code ?? o.reference ?? '#'} ${tag}</div>
                <div class="text-xs text-slate-500">Tạo lúc: ${o.created_at ?? '-'}</div>
              </div>
              <div class="text-right text-xs">
                <div>Tổng: ${(o.total_vnd??0).toLocaleString()} đ</div>
                <div>Đã trả: ${(o.paid_amount ?? o.paid_vnd ?? 0).toLocaleString()} đ</div>
              </div>
            </div>
            <div class="mt-2">${orderItemsTable(its)}</div>
            ${qrHtml}
          </div>`;
        }).join("")}
      </div>
    </div>`;
  }

  function groupBy(arr, key){ const m={}; (arr||[]).forEach(x=>{ (m[x[key]] ||= []).push(x); }); return m; }
  function setActiveTab(name){
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('bg-indigo-600','text-white','border-indigo-600'));
    const btn = document.querySelector(`.tab[data-tab="${name}"]`);
    if (btn){ btn.classList.add('bg-indigo-600','text-white','border-indigo-600'); }
    document.querySelectorAll('[data-pane]').forEach(p=>p.classList.add('hidden'));
    const pane=document.querySelector(`[data-pane="${name}"]`);
    if (pane) pane.classList.remove('hidden');
  }
  function openDrawer(){ drawer.classList.remove('hidden'); }
  function closeDrawer(){ drawer.classList.add('hidden'); }

  async function renderDetail(cid, name){
    drawerTitle.textContent = name || '—';
    tabContent.innerHTML = `<div class="text-slate-500">Đang tải...</div>`;
    headerStats.innerHTML = '';
    openDrawer();

    const r = await fetch(DETAIL_URL(cid), {headers:{'X-Requested-With':'fetch'}});
    const js = await r.json();

    const orders = js.orders || [];
    const itemsByOrder = groupBy(js.items || [], 'order_id');
    const qrByOrder = groupBy(js.qr_active || [], 'order_id');

    const paidOrders = orders.filter(o => (o.status||'').toUpperCase()==='PAID');
    const pendingOrders = orders.filter(o => (o.status||'').toUpperCase()==='PENDING');

    headerStats.innerHTML = [
      chip(paidOrders.length, 'Đơn đã trả'),
      chip(pendingOrders.length, 'Đơn pending'),
      chip((js.qr_active||[]).length, 'QR đang chờ')
    ].join('');

    tabContent.innerHTML = `
      <div data-pane="paid"></div>
      <div data-pane="pending" class="hidden"></div>
      <div data-pane="qr" class="hidden"></div>
      <div data-pane="all" class="hidden"></div>
    `;

    document.querySelector('[data-pane="paid"]').innerHTML =
      ordersSection("Đơn đã trả", paidOrders, itemsByOrder, qrByOrder) || `<div class="text-slate-500">Không có đơn đã trả</div>`;
    document.querySelector('[data-pane="pending"]').innerHTML =
      ordersSection("Đơn pending", pendingOrders, itemsByOrder, qrByOrder) || `<div class="text-slate-500">Không có đơn pending</div>`;
    document.querySelector('[data-pane="qr"]').innerHTML = `
      <div class="rounded-xl border">
        <div class="px-4 py-3 border-b font-medium">QR đang active</div>
        <div class="p-4 text-sm">${(js.qr_active||[]).length
          ? (js.qr_active||[]).map(q=>`<div class="border rounded-lg p-2 mb-2">
              <div class="font-medium text-slate-700">QR ${q.qr_id ?? ''}</div>
              <div class="text-xs text-slate-500">Số tiền: ${(q.amount_vnd??0).toLocaleString()} đ • HSD: ${q.expires_at ?? '-'}</div>
            </div>`).join('')
          : 'Không có QR đang active'}</div>
      </div>`;
    document.querySelector('[data-pane="all"]').innerHTML =
      ordersSection("Tất cả đơn", orders, itemsByOrder, qrByOrder);

    document.querySelectorAll('.tab').forEach(b=>{ b.onclick = ()=> setActiveTab(b.dataset.tab); });
    setActiveTab('paid');
  }

  // ===== DOC MODAL =====
  function openDoc(cccd, project_code){
    if (!project_code){
      alert("Vui lòng chọn dự án trước khi xem đơn.");
      return;
    }
    const url = DOC_URL(COMPANY, project_code, cccd);
    docFrame.src = url;
    docModal.classList.remove("hidden");

    docFrame.onload = () => {
      try {
        const filename = `${(COMPANY||'COMPANY')}_${cccd}_${project_code}.pdf`;
        docFrame.contentDocument.title = filename;
      } catch (e) {}
    };
  }
  function closeDoc(){ docModal.classList.add("hidden"); docFrame.src = "about:blank"; }
  btnDocClose.onclick = closeDoc;
  docBackdrop.onclick = closeDoc;
  btnDocDownload.onclick = () => {
    try {
      docFrame.contentWindow.focus();
      docFrame.contentWindow.print();
    } catch (e) {
      alert("Không thể mở hộp thoại in. Vui lòng kiểm tra popup blocker.");
    }
  };

  // ===== TABLE LIST =====
  function rowHtml(r){
    const full = r.full_name ?? "-";
    const cccd = r.cccd ?? "-";
    const phone= r.phone ?? "-";
    const paid = Number(r.orders_paid ?? 0);
    const pending = Number(r.orders_pending ?? 0);
    const qr = Number(r.unpaid_qr_count ?? 0);
    const cid = r.customer_id;

    const canViewDoc = paid > 0;
    const viewBtn = canViewDoc
      ? `<button class="ml-2 px-2.5 py-1 rounded border text-xs hover:bg-slate-50"
            data-view-doc="${cccd}" title="Xem đơn">
           <i class="ri-file-text-line"></i> Xem đơn
         </button>`
      : `<span class="text-slate-400 text-xs">—</span>`;

    return `<tr class="border-t">
      <td class="py-3 px-4">
        <button class="text-indigo-600 hover:underline" data-cid="${cid}" data-name="${full}">${full}</button>
      </td>
      <td class="py-3 px-4">${cccd}</td>
      <td class="py-3 px-4">${phone}</td>
      <td class="py-3 px-4 text-right">${paid}</td>
      <td class="py-3 px-4 text-right">${pending}</td>
      <td class="py-3 px-4 text-right">${qr}</td>
      <td class="py-3 px-4 text-right">${viewBtn}</td>
    </tr>`;
  }

  async function loadProjects(){
    const r = await fetch(PROJ_URL, {headers:{'X-Requested-With':'fetch'}});
    const js = await r.json();
    const list = js.data ?? js.items ?? [];

    elProject.innerHTML = `<option value="">Tất cả dự án</option>`;

    let onlyCode = null;
    for (const p of list){
      const code = p.project_code ?? p.code ?? "";
      const name = p.name ?? code;
      const opt = document.createElement('option');
      opt.value = code;
      opt.textContent = `${code} — ${name}`;
      elProject.appendChild(opt);
      if (!onlyCode) {
        onlyCode = code;
      } else {
        // đã có >1 project
        onlyCode = null;
      }
    }

    const initCode = elProject.dataset.init;
    if (initCode) {
      elProject.value = initCode;
    } else if (onlyCode) {
      // chỉ có đúng 1 dự án active → auto select
      elProject.value = onlyCode;
    }
  }

  async function loadData(){
    const q=(elSearch.value||'').trim();
    const page=+elPage.value||1;
    const size=+elSize.value||50;
    const project_code = elProject.value||'';
    const params = new URLSearchParams({page,size});
    if(q) params.set('q',q);
    if(project_code) params.set('project_code',project_code);

    elBody.innerHTML = `<tr><td class="py-6 px-4 text-slate-400" colspan="7">Đang tải...</td></tr>`;
    const r = await fetch(`${DATA_URL}?${params.toString()}`, {headers:{'X-Requested-With':'fetch'}});
    const js = await r.json();
    const rows = js.data ?? js.items ?? [];
    const total = js.total ?? 0;

    if(!rows.length){
      elBody.innerHTML = `<tr><td class="py-6 px-4 text-slate-400" colspan="7">Không có dữ liệu</td></tr>`;
    }else{
      elBody.innerHTML = rows.map(rowHtml).join('');

      elBody.querySelectorAll('button[data-cid]').forEach(b=>{
        b.onclick = ()=> renderDetail(b.dataset.cid, b.dataset.name);
      });
      elBody.querySelectorAll('button[data-view-doc]').forEach(b=>{
        b.onclick = ()=> openDoc(b.dataset.viewDoc, elProject.value || '');
      });
    }
    elTotal.textContent = `Tổng: ${total.toLocaleString()}`;
  }

  // events
  elProject.onchange = loadData;
  elSize.onchange = ()=>{ elPage.value=1; loadData(); };
  elPage.onchange = loadData;
  btnPrev.onclick = ()=>{ elPage.value = Math.max(1,(+elPage.value||1)-1); loadData(); };
  btnNext.onclick = ()=>{ elPage.value = (+elPage.value||1)+1; loadData(); };
  btnRefresh.onclick = loadData;
  elSearch.addEventListener('input', ()=> debounce(()=>{ elPage.value=1; loadData(); }, 350));

  drawerBackdrop.onclick = closeDrawer;
  drawerClose.onclick = closeDrawer;

  loadProjects().then(loadData);
})();
</script>
{% endblock %}
