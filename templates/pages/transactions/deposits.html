{% extends "base.html" %}
{% block content %}

{# ✅ #1: Title trang (thêm, không ảnh hưởng logic) #}
<div class="mb-4">
  <h1 class="text-2xl font-semibold text-slate-900 flex items-center gap-2">
    <i class="ri-bank-card-line text-indigo-600"></i>
    Giao dịch đặt cọc
  </h1>
  <div class="text-sm text-slate-500 mt-1">Tra cứu theo dự án/khách hàng và xem chi tiết đơn đặt cọc.</div>
</div>

<div class="bg-white rounded-xl border border-slate-200" id="pageRoot" data-company="{{ company_code or '' }}">
  <!-- ✅ FILTER BAR: layout giống 2.1 -->
  <div class="p-4">
    <div class="grid grid-cols-12 gap-4 items-end">
      <!-- Row 1: Trạng thái -->
      <div class="col-span-12 md:col-span-3">
        <label class="block text-sm text-slate-500 mb-1">Trạng thái</label>
        <select id="projectStatusSelect" class="w-full border rounded-lg px-3 py-2">
          <option value="ALL">Tất cả</option>
          <option value="ACTIVE" selected>ACTIVE</option>
          <option value="INACTIVE">INACTIVE</option>
        </select>
      </div>

      <!-- Row 1: Dự án -->
      <div class="col-span-12 md:col-span-9">
        <label class="block text-sm text-slate-500 mb-1">Dự án</label>
        <select id="projectSelect" class="w-full border rounded-lg px-3 py-2" title="">
          <option value="">Tất cả dự án</option>
        </select>
      </div>

      <!-- Row 2: Search -->
      <div class="col-span-12 md:col-span-8">
        <label class="block text-sm text-slate-500 mb-1">Tìm khách (Tên/CCCD/SDT)</label>
        <input id="searchInput" type="text" placeholder="Gõ để tìm..." class="w-full border rounded-lg px-3 py-2">
      </div>

      <!-- Row 2: Trang -->
      <div class="col-span-6 md:col-span-1">
        <label class="block text-sm text-slate-500 mb-1">Trang</label>
        <input id="pageInput" type="number" min="1" value="{{ init_page or 1 }}" class="w-full border rounded-lg px-3 py-2">
      </div>

      <!-- Row 2: Size -->
      <div class="col-span-6 md:col-span-1">
        <label class="block text-sm text-slate-500 mb-1">Size</label>
        <select id="sizeSelect" class="w-full border rounded-lg px-3 py-2">
          {% for n in [25,50,100] %}
          <option value="{{n}}" {% if (init_size or 50) == n %}selected{% endif %}>{{n}}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Row 2: Refresh -->
      <div class="col-span-12 md:col-span-2 flex md:justify-end">
        <button id="refreshBtn" class="h-10 w-full md:w-auto px-5 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">
          <i class="ri-refresh-line"></i> Nạp
        </button>
      </div>
    </div>
  </div>

  <!-- TABLE -->
  <div class="border-t border-slate-100 overflow-x-auto">
    <table class="w-full text-sm">
      <thead class="bg-slate-50">
        <tr class="text-left text-slate-600">
          <th class="py-3 px-4">Khách</th>
          <th class="py-3 px-4">CCCD</th>
          <th class="py-3 px-4">SĐT</th>

          <!-- ✅ NEW: tổng tiền cọc đã trả -->
          <th class="py-3 px-4 text-right whitespace-nowrap">Tổng tiền cọc đã trả (VND)</th>

          <th class="py-3 px-4 text-right">Đã trả</th>
          <th class="py-3 px-4 text-right">Pending</th>

          {# ✅ CHỈ ĐỔI CỘT NÀY: bỏ QR chờ TT -> thay "Cọc gần nhất" #}
          <th class="py-3 px-4 text-right whitespace-nowrap">Cọc gần nhất</th>

          <th class="py-3 px-4 text-right">Đơn</th>
        </tr>
      </thead>
      <tbody id="dataBody">
        <tr><td class="py-6 px-4 text-slate-400" colspan="8">Đang tải...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- FOOTER -->
  <div class="p-4 flex items-center justify-between text-sm text-slate-500">
    <div id="totalInfo">Tổng: 0</div>
    <div class="flex items-center gap-2">
      <button id="prevBtn" class="px-3 py-1 rounded border">Trước</button>
      <button id="nextBtn" class="px-3 py-1 rounded border">Sau</button>
    </div>
  </div>
</div>

<!-- SLIDE-OVER DETAIL (giữ nguyên) -->
<div id="drawer" class="fixed inset-0 hidden z-40">
  <div class="absolute inset-0 bg-black/40" id="drawerBackdrop"></div>
  <div class="absolute right-0 top-0 h-full w-full sm:w-[560px] bg-white shadow-2xl flex flex-col">
    <div class="px-5 py-4 border-b flex items-center justify-between">
      <div class="space-y-0.5">
        <div class="text-xs text-slate-500">Chi tiết khách hàng</div>
        <div id="drawerTitle" class="font-semibold">—</div>
      </div>
      <button id="drawerClose" class="h-8 w-8 rounded-full hover:bg-slate-100 flex items-center justify-center">
        <i class="ri-close-line text-xl"></i>
      </button>
    </div>

    <div id="drawerHeaderStats" class="px-5 py-3 grid grid-cols-3 gap-3 border-b"></div>

    <div class="px-5 pt-3">
      <div class="flex gap-2">
        <button data-tab="paid" class="tab px-3 py-1.5 rounded-lg border text-sm">Đã trả</button>
        <button data-tab="pending" class="tab px-3 py-1.5 rounded-lg border text-sm">Pending</button>
        <button data-tab="qr" class="tab px-3 py-1.5 rounded-lg border text-sm">QR active</button>
        <button data-tab="all" class="tab px-3 py-1.5 rounded-lg border text-sm">Tất cả đơn</button>
      </div>
    </div>

    <div class="flex-1 overflow-auto p-5 space-y-4" id="tabContent"></div>
  </div>
</div>

<!-- DOC MODAL (giữ nguyên) -->
<div id="docModal" class="fixed inset-0 hidden z-50">
  <div class="absolute inset-0 bg-black/50" id="docBackdrop"></div>
  <div class="absolute inset-4 sm:inset-10 bg-white rounded-xl shadow-2xl flex flex-col overflow-hidden">
    <div class="px-4 py-3 border-b flex items-center justify-between">
      <div class="font-semibold">Đơn đăng ký tham gia đấu giá</div>
      <div class="flex items-center gap-2">
        <button id="btnDocDownload" class="px-3 py-1.5 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">
          <i class="ri-download-2-line"></i> Tải PDF
        </button>
        <button id="btnDocClose" class="h-9 w-9 rounded-full hover:bg-slate-100 flex items-center justify-center">
          <i class="ri-close-line text-xl"></i>
        </button>
      </div>
    </div>
    <iframe id="docFrame" class="flex-1 w-full" style="border:0"></iframe>
  </div>
</div>

{# ✅ #2: Custom popup (không dùng alert/confirm mặc định) #}
<style>
  /* Minimal, scoped modal style - không đụng phần khác */
  #appModal{ position:fixed; inset:0; z-index:60; display:none; }
  #appModal.show{ display:block; }
  #appModal .m-backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.50); }
  #appModal .m-card{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:min(520px, calc(100vw - 32px));
    background:#fff; border-radius:14px; box-shadow:0 30px 80px rgba(2,6,23,.35);
    overflow:hidden; border:1px solid rgba(15,23,42,.12);
  }
  #appModal .m-head{ padding:14px 16px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid rgba(15,23,42,.08); }
  #appModal .m-title{ font-weight:700; color:#0f172a; display:flex; align-items:center; gap:8px; }
  #appModal .m-close{ width:36px; height:36px; border-radius:999px; display:flex; align-items:center; justify-content:center; cursor:pointer; }
  #appModal .m-close:hover{ background:rgba(15,23,42,.06); }
  #appModal .m-body{ padding:14px 16px; color:#0f172a; }
  #appModal .m-desc{ color:rgba(71,85,105,.9); font-size:14px; line-height:1.4; white-space:pre-line; }
  #appModal .m-foot{ padding:12px 16px; display:flex; justify-content:flex-end; gap:10px; border-top:1px solid rgba(15,23,42,.08); background:#f8fafc; }
  #appModal .m-btn{ padding:9px 14px; border-radius:10px; font-weight:600; font-size:14px; border:1px solid rgba(15,23,42,.16); background:#fff; }
  #appModal .m-btn:hover{ background:#f1f5f9; }
  #appModal .m-btn.primary{ background:#4f46e5; border-color:#4f46e5; color:#fff; }
  #appModal .m-btn.primary:hover{ filter:brightness(.95); }
  #appModal .m-ico{ width:28px; height:28px; border-radius:10px; display:flex; align-items:center; justify-content:center; }
  #appModal .m-ico.info{ background:rgba(79,70,229,.12); color:#4f46e5; }
  #appModal .m-ico.warn{ background:rgba(245,158,11,.16); color:#b45309; }
  #appModal .m-ico.bad{ background:rgba(239,68,68,.14); color:#b91c1c; }

  /* ✅ NEW (scoped): last-paid cell small 2 lines, stay inside 1 row height */
  .last-paid{
    display:inline-block;
    text-align:right;
    line-height:1.15;
    font-size:12px;
    white-space:nowrap;
  }
  .last-paid .d{ color:#0f172a; font-weight:600; }
  .last-paid .t{ color:#64748b; font-weight:500; margin-top:2px; }
</style>

<div id="appModal" aria-hidden="true">
  <div class="m-backdrop" id="appModalBackdrop"></div>
  <div class="m-card" role="dialog" aria-modal="true" aria-labelledby="appModalTitle">
    <div class="m-head">
      <div class="m-title" id="appModalTitle">
        <span class="m-ico info" id="appModalIcon"><i class="ri-information-line"></i></span>
        <span id="appModalTitleText">Thông báo</span>
      </div>
      <button class="m-close" id="appModalClose" aria-label="Đóng">
        <i class="ri-close-line text-xl"></i>
      </button>
    </div>
    <div class="m-body">
      <div class="m-desc" id="appModalDesc">—</div>
    </div>
    <div class="m-foot" id="appModalFooter">
      <button class="m-btn" id="appModalCancel" style="display:none">Đóng</button>
      <button class="m-btn primary" id="appModalOk">OK</button>
    </div>
  </div>
</div>

<script>
(function(){
  const DATA_URL = "/transactions/deposits/data";

  // ✅ giống 2.1: dùng listing_projects + có param status
  const PROJ_URL = "/projects/options/listing_projects";

  const DETAIL_URL = (cid) => `/transactions/customers/${cid}/orders?type=DEPOSIT`;
  const DOC_URL = (company_code, project_code, cccd) => {
    const p = new URLSearchParams();
    if (company_code) p.set("company_code", company_code);
    p.set("project_code", project_code);
    p.set("cccd", cccd);
    return `/documents/auction/registration?${p.toString()}`;
  };

  const root     = document.getElementById("pageRoot");
  const COMPANY  = root.dataset.company || "";

  const elProjectStatus = document.getElementById("projectStatusSelect");
  const elProject= document.getElementById("projectSelect");
  const elSearch = document.getElementById("searchInput");
  const elPage   = document.getElementById("pageInput");
  const elSize   = document.getElementById("sizeSelect");
  const elBody   = document.getElementById("dataBody");
  const elTotal  = document.getElementById("totalInfo");
  const btnPrev  = document.getElementById("prevBtn");
  const btnNext  = document.getElementById("nextBtn");
  const btnRefresh = document.getElementById("refreshBtn");

  // drawer
  const drawer = document.getElementById("drawer");
  const drawerBackdrop = document.getElementById("drawerBackdrop");
  const drawerClose = document.getElementById("drawerClose");
  const drawerTitle = document.getElementById("drawerTitle");
  const headerStats = document.getElementById("drawerHeaderStats");
  const tabContent = document.getElementById("tabContent");

  // doc modal
  const docModal = document.getElementById("docModal");
  const docBackdrop = document.getElementById("docBackdrop");
  const btnDocClose = document.getElementById("btnDocClose");
  const btnDocDownload = document.getElementById("btnDocDownload");
  const docFrame = document.getElementById("docFrame");

  // ===== CUSTOM MODAL (replaces alert/confirm) =====
  const appModal = document.getElementById("appModal");
  const appModalBackdrop = document.getElementById("appModalBackdrop");
  const appModalClose = document.getElementById("appModalClose");
  const appModalOk = document.getElementById("appModalOk");
  const appModalCancel = document.getElementById("appModalCancel");
  const appModalDesc = document.getElementById("appModalDesc");
  const appModalTitleText = document.getElementById("appModalTitleText");
  const appModalIcon = document.getElementById("appModalIcon");

  let __modalResolve = null;

  function setModalVariant(variant){
    // variant: info | warn | bad
    appModalIcon.classList.remove("info","warn","bad");
    const v = variant || "info";
    appModalIcon.classList.add(v);
    const ico = (v==="warn") ? "ri-error-warning-line" : (v==="bad" ? "ri-close-circle-line" : "ri-information-line");
    appModalIcon.innerHTML = `<i class="${ico}"></i>`;
  }

  function showModal({title, message, variant, okText, cancelText, showCancel}){
    appModalTitleText.textContent = title || "Thông báo";
    appModalDesc.textContent = message || "";
    setModalVariant(variant || "info");

    appModalOk.textContent = okText || "OK";
    if (showCancel){
      appModalCancel.style.display = "";
      appModalCancel.textContent = cancelText || "Đóng";
    } else {
      appModalCancel.style.display = "none";
    }

    appModal.classList.add("show");
    appModal.setAttribute("aria-hidden","false");

    // focus for accessibility
    setTimeout(()=>{ try{ appModalOk.focus(); }catch(e){} }, 0);

    return new Promise((resolve)=>{
      __modalResolve = resolve;
    });
  }
  function hideModal(result){
    appModal.classList.remove("show");
    appModal.setAttribute("aria-hidden","true");
    const r = __modalResolve;
    __modalResolve = null;
    if (typeof r === "function") r(!!result);
  }

  function bindModalEvents(){
    if (!appModal) return;

    appModalOk.onclick = ()=> hideModal(true);
    appModalCancel.onclick = ()=> hideModal(false);
    appModalBackdrop.onclick = ()=> hideModal(false);
    appModalClose.onclick = ()=> hideModal(false);

    document.addEventListener("keydown", (e)=>{
      if (!appModal.classList.contains("show")) return;
      if (e.key === "Escape"){ e.preventDefault(); hideModal(false); }
      if (e.key === "Enter"){
        // tránh Enter bấm lung tung ở trang: chỉ khi modal đang mở
        e.preventDefault();
        hideModal(true);
      }
    });
  }
  bindModalEvents();

  // init server defaults
  elSearch.value = "{{ init_q or '' }}";
  elProject.dataset.init = "{{ init_project_code or '' }}";

  // ✅ mặc định ACTIVE (giống yêu cầu 2.1)
  elProjectStatus.value = "ACTIVE";

  let t; const debounce=(fn,ms=350)=>{ clearTimeout(t); t=setTimeout(fn,ms); };

  function chip(number,label){
    return `<div class="rounded-xl border p-3">
      <div class="text-2xl font-semibold">${(number||0).toLocaleString()}</div>
      <div class="text-xs text-slate-500 mt-0.5">${label}</div>
    </div>`;
  }

  function orderItemsTable(items){
    if (!items?.length) return `<div class="text-slate-500">Không có item</div>`;
    const rows = items.map(i=>{
      const lot = i.lot_code ?? i.ref_id ?? '-';
      const depo = i.deposit_amount ?? i.total_vnd ?? 0;
      return `<tr>
        <td class="px-3 py-2">Lô ${lot}</td>
        <td class="px-3 py-2 text-right" colspan="2">—</td>
        <td class="px-3 py-2 text-right">${Number(depo||0).toLocaleString()}</td>
      </tr>`;
    }).join("");
    return `<div class="overflow-x-auto border rounded-lg">
      <table class="w-full text-sm">
        <thead class="bg-slate-50">
          <tr><th class="px-3 py-2 text-left">Hạng mục</th><th class="px-3 py-2 text-right" colspan="2">SL/Đơn giá</th><th class="px-3 py-2 text-right">Thành tiền</th></tr>
        </thead><tbody>${rows}</tbody>
      </table></div>`;
  }

  function ordersSection(title, orders, itemsByOrder, qrByOrder){
    if (!orders?.length) return '';
    return `<div class="rounded-xl border">
      <div class="px-4 py-3 border-b font-medium">${title}</div>
      <div class="p-4 space-y-4">
        ${orders.map(o=>{
          const its = itemsByOrder[o.order_id] || [];
          const qrs = qrByOrder[o.order_id] || [];
          const tag = o.status ? `<span class="ml-2 text-xs px-2 py-0.5 rounded-full border">${o.status}</span>` : '';
          const qrHtml = qrs?.length ? `<div class="mt-2 text-xs text-slate-600">
            ${qrs.map(q=>`QR ${q.qr_id ?? ''} • ${(q.amount_vnd??0).toLocaleString()}đ • HSD: ${q.expires_at ?? '-'}`).join('<br/>')}
          </div>` : '';
          return `<div class="rounded-lg border p-3">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-medium">Đơn ${o.order_code ?? o.reference ?? '#'} ${tag}</div>
                <div class="text-xs text-slate-500">Tạo lúc: ${o.created_at ?? '-'}</div>
              </div>
              <div class="text-right text-xs">
                <div>Tổng: ${(o.total_vnd??0).toLocaleString()} đ</div>
                <div>Đã trả: ${(o.paid_amount ?? o.paid_vnd ?? 0).toLocaleString()} đ</div>
              </div>
            </div>
            <div class="mt-2">${orderItemsTable(its)}</div>
            ${qrHtml}
          </div>`;
        }).join("")}
      </div>
    </div>`;
  }

  function groupBy(arr, key){ const m={}; (arr||[]).forEach(x=>{ (m[x[key]] ||= []).push(x); }); return m; }
  function setActiveTab(name){
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('bg-indigo-600','text-white','border-indigo-600'));
    const btn = document.querySelector(`.tab[data-tab="${name}"]`);
    if (btn){ btn.classList.add('bg-indigo-600','text-white','border-indigo-600'); }
    document.querySelectorAll('[data-pane]').forEach(p=>p.classList.add('hidden'));
    const pane=document.querySelector(`[data-pane="${name}"]`);
    if (pane) pane.classList.remove('hidden');
  }
  function openDrawer(){ drawer.classList.remove('hidden'); }
  function closeDrawer(){ drawer.classList.add('hidden'); }

  async function renderDetail(cid, name){
    drawerTitle.textContent = name || '—';
    tabContent.innerHTML = `<div class="text-slate-500">Đang tải...</div>`;
    headerStats.innerHTML = '';
    openDrawer();

    const r = await fetch(DETAIL_URL(cid), {headers:{'X-Requested-With':'fetch'}});
    const js = await r.json();

    const orders = js.orders || [];
    const itemsByOrder = groupBy(js.items || [], 'order_id');
    const qrByOrder = groupBy(js.qr_active || [], 'order_id');

    const paidOrders = orders.filter(o => (o.status||'').toUpperCase()==='PAID');
    const pendingOrders = orders.filter(o => (o.status||'').toUpperCase()==='PENDING');

    headerStats.innerHTML = [
      chip(paidOrders.length, 'Đơn đã trả'),
      chip(pendingOrders.length, 'Đơn pending'),
      chip((js.qr_active||[]).length, 'QR đang chờ')
    ].join('');

    tabContent.innerHTML = `
      <div data-pane="paid"></div>
      <div data-pane="pending" class="hidden"></div>
      <div data-pane="qr" class="hidden"></div>
      <div data-pane="all" class="hidden"></div>
    `;

    document.querySelector('[data-pane="paid"]').innerHTML =
      ordersSection("Đơn đã trả", paidOrders, itemsByOrder, qrByOrder) || `<div class="text-slate-500">Không có đơn đã trả</div>`;
    document.querySelector('[data-pane="pending"]').innerHTML =
      ordersSection("Đơn pending", pendingOrders, itemsByOrder, qrByOrder) || `<div class="text-slate-500">Không có đơn pending</div>`;
    document.querySelector('[data-pane="qr"]').innerHTML = `
      <div class="rounded-xl border">
        <div class="px-4 py-3 border-b font-medium">QR đang active</div>
        <div class="p-4 text-sm">${(js.qr_active||[]).length
          ? (js.qr_active||[]).map(q=>`<div class="border rounded-lg p-2 mb-2">
              <div class="font-medium text-slate-700">QR ${q.qr_id ?? ''}</div>
              <div class="text-xs text-slate-500">Số tiền: ${(q.amount_vnd??0).toLocaleString()} đ • HSD: ${q.expires_at ?? '-'}</div>
            </div>`).join('')
          : 'Không có QR đang active'}</div>
      </div>`;
    document.querySelector('[data-pane="all"]').innerHTML =
      ordersSection("Tất cả đơn", orders, itemsByOrder, qrByOrder);

    document.querySelectorAll('.tab').forEach(b=>{ b.onclick = ()=> setActiveTab(b.dataset.tab); });
    setActiveTab('paid');
  }

  // ===== DOC MODAL =====
  function openDoc(cccd, project_code){
    if (!project_code){
      // ✅ replace alert with custom modal
      showModal({
        title: "Thiếu thông tin",
        message: "Vui lòng chọn dự án trước khi xem đơn.",
        variant: "warn",
        okText: "Đã hiểu",
        showCancel: false
      });
      return;
    }
    const url = DOC_URL(COMPANY, project_code, cccd);
    docFrame.src = url;
    docModal.classList.remove("hidden");

    docFrame.onload = () => {
      try {
        const filename = `${(COMPANY||'COMPANY')}_${cccd}_${project_code}.pdf`;
        docFrame.contentDocument.title = filename;
      } catch (e) {}
    };
  }
  function closeDoc(){ docModal.classList.add("hidden"); docFrame.src = "about:blank"; }
  btnDocClose.onclick = closeDoc;
  docBackdrop.onclick = closeDoc;
  btnDocDownload.onclick = async () => {
    try {
      docFrame.contentWindow.focus();
      docFrame.contentWindow.print();
    } catch (e) {
      // ✅ replace alert with custom modal
      await showModal({
        title: "Không thể in",
        message: "Không thể mở hộp thoại in. Vui lòng kiểm tra popup blocker.",
        variant: "bad",
        okText: "Đóng",
        showCancel: false
      });
    }
  };

  function money(v){
    const n = Number(v || 0);
    return isFinite(n) ? n.toLocaleString() : '0';
  }

  // ✅ NEW: format last_paid_at -> 2 lines (dd/mm/yyyy + HH:MM:SS)
  function fmtLastPaid2Lines(v){
    if (!v) return `<span class="text-slate-400 text-xs">—</span>`;

    // robust parse (ISO string)
    const d = new Date(v);
    if (!isFinite(d.getTime())) return `<span class="text-slate-400 text-xs">—</span>`;

    // keep it simple + deterministic for VN style (no timezone conversion logic changes elsewhere)
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yy = String(d.getFullYear());
    const hh = String(d.getHours()).padStart(2,'0');
    const mi = String(d.getMinutes()).padStart(2,'0');
    const ss = String(d.getSeconds()).padStart(2,'0');

    return `
      <span class="last-paid">
        <div class="d">${dd}/${mm}/${yy}</div>
        <div class="t">${hh}:${mi}:${ss}</div>
      </span>
    `;
  }

  // ===== TABLE LIST =====
  function rowHtml(r){
    const full = r.full_name ?? "-";
    const cccd = r.cccd ?? "-";
    const phone= r.phone ?? "-";
    const paidCount = Number(r.orders_paid ?? 0);
    const pending = Number(r.orders_pending ?? 0);

    // ✅ giữ nguyên biến để không ảnh hưởng logic (dù không render cột QR nữa)
    const qr = Number(r.unpaid_qr_count ?? 0);

    const cid = r.customer_id;

    // ✅ tổng tiền cọc đã paid (API A trả agg.total_paid)
    const totalPaidVnd = Number(r.total_paid ?? 0);

    // ✅ NEW: last paid at (API A trả agg.last_paid_at)
    const lastPaidAt = r.last_paid_at ?? null;

    const canViewDoc = paidCount > 0;
    const viewBtn = canViewDoc
      ? `<button class="ml-2 px-2.5 py-1 rounded border text-xs hover:bg-slate-50"
            data-view-doc="${cccd}" title="Xem đơn">
           <i class="ri-file-text-line"></i> Xem đơn
         </button>`
      : `<span class="text-slate-400 text-xs">—</span>`;

    return `<tr class="border-t">
      <td class="py-3 px-4">
        <button class="text-indigo-600 hover:underline" data-cid="${cid}" data-name="${full}">${full}</button>
      </td>
      <td class="py-3 px-4">${cccd}</td>
      <td class="py-3 px-4">${phone}</td>

      <td class="py-3 px-4 text-right font-medium whitespace-nowrap">${money(totalPaidVnd)}</td>

      <td class="py-3 px-4 text-right">${paidCount}</td>
      <td class="py-3 px-4 text-right">${pending}</td>

      {# ✅ CHỈ ĐỔI CELL NÀY: show last_paid_at thay cho QR #}
      <td class="py-3 px-4 text-right align-middle">${fmtLastPaid2Lines(lastPaidAt)}</td>

      <td class="py-3 px-4 text-right">${viewBtn}</td>
    </tr>`;
  }

  function syncSelectTitle(){
    const sel = elProject.selectedOptions?.[0];
    elProject.title = sel ? (sel.title || sel.textContent || '') : '';
  }

  async function loadProjects(){
    const status = (elProjectStatus.value || 'ACTIVE').toUpperCase();
    const params = new URLSearchParams();
    if (status) params.set('status', status);

    const r = await fetch(`${PROJ_URL}?${params.toString()}`, {headers:{'X-Requested-With':'fetch'}});
    const js = await r.json();
    const list = js.data ?? js.items ?? [];

    elProject.innerHTML = `<option value="">Tất cả dự án</option>`;

    for (const p of list){
      const code = (p.project_code ?? p.code ?? "").trim();
      const name = (p.name ?? "").trim();
      if (!code) continue;

      const label = name ? `${code} — ${name}` : `${code}`;
      const opt = document.createElement('option');
      opt.value = code;
      opt.textContent = label;
      opt.title = label;
      elProject.appendChild(opt);
    }

    const initCode = (elProject.dataset.init || "").trim();
    if (initCode) {
      elProject.value = initCode;
    } else if ((list || []).length === 1) {
      const only = list[0] || {};
      const onlyCode = (only.project_code || only.code || "").trim();
      if (onlyCode) elProject.value = onlyCode;
    }

    syncSelectTitle();
  }

  async function loadData(){
    const q=(elSearch.value||'').trim();
    const page=+elPage.value||1;
    const size=+elSize.value||50;
    const project_code = elProject.value||'';
    const params = new URLSearchParams({page,size});
    if(q) params.set('q',q);
    if(project_code) params.set('project_code',project_code);

    elBody.innerHTML = `<tr><td class="py-6 px-4 text-slate-400" colspan="8">Đang tải...</td></tr>`;
    const r = await fetch(`${DATA_URL}?${params.toString()}`, {headers:{'X-Requested-With':'fetch'}});
    const js = await r.json();
    const rows = js.data ?? js.items ?? [];
    const total = js.total ?? 0;

    if(!rows.length){
      elBody.innerHTML = `<tr><td class="py-6 px-4 text-slate-400" colspan="8">Không có dữ liệu</td></tr>`;
    }else{
      elBody.innerHTML = rows.map(rowHtml).join('');

      elBody.querySelectorAll('button[data-cid]').forEach(b=>{
        b.onclick = ()=> renderDetail(b.dataset.cid, b.dataset.name);
      });
      elBody.querySelectorAll('button[data-view-doc]').forEach(b=>{
        b.onclick = ()=> openDoc(b.dataset.viewDoc, elProject.value || '');
      });
    }
    elTotal.textContent = `Tổng: ${total.toLocaleString()}`;
  }

  // events (giữ nguyên; thêm status reload như 2.1)
  elProject.onchange = ()=>{ syncSelectTitle(); loadData(); };

  elProjectStatus.onchange = async ()=>{
    elProject.dataset.init = "";
    elProject.value = "";
    syncSelectTitle();
    await loadProjects();
    elPage.value = 1;
    loadData();
  };

  elSize.onchange = ()=>{ elPage.value=1; loadData(); };
  elPage.onchange = loadData;
  btnPrev.onclick = ()=>{ elPage.value = Math.max(1,(+elPage.value||1)-1); loadData(); };
  btnNext.onclick = ()=>{ elPage.value = (+elPage.value||1)+1; loadData(); };
  btnRefresh.onclick = loadData;
  elSearch.addEventListener('input', ()=> debounce(()=>{ elPage.value=1; loadData(); }, 350));

  drawerBackdrop.onclick = closeDrawer;
  drawerClose.onclick = closeDrawer;

  loadProjects().then(loadData);
})();
</script>
{% endblock %}
