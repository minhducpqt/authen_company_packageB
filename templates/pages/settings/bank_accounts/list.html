{% extends "base.html" %}
{% block content %}

{# =========================
   Toasts / Alerts (server-driven)
   - load_err: lỗi load trang hoặc lỗi form redirect về (create/edit)
   - toast_msg / toast_err: từ router list_accounts (nếu bạn đã pass)
   ========================= #}

{% if toast_msg %}
  <div class="mb-4 p-3 rounded-xl bg-emerald-50 text-emerald-700 text-sm border border-emerald-100 flex items-start gap-2">
    <i class="ri-checkbox-circle-line text-lg mt-0.5"></i>
    <div class="min-w-0">{{ toast_msg }}</div>
  </div>
{% endif %}

{% if toast_err %}
  <div class="mb-4 p-3 rounded-xl bg-rose-50 text-rose-700 text-sm border border-rose-100 flex items-start gap-2">
    <i class="ri-error-warning-line text-lg mt-0.5"></i>
    <div class="min-w-0">{{ toast_err }}</div>
  </div>
{% endif %}

{% if load_err %}
  <div class="mb-4 p-3 rounded-xl bg-rose-50 text-rose-700 text-sm border border-rose-100 flex items-start gap-2">
    <i class="ri-error-warning-line text-lg mt-0.5"></i>
    <div class="min-w-0">{{ load_err }}</div>
  </div>
{% endif %}

<div class="flex items-center justify-between mb-4">
  <div>
    <h2 class="text-2xl font-semibold text-slate-800">Tài khoản ngân hàng</h2>
    <p class="text-slate-500 text-sm">Quản lý danh sách tài khoản ngân hàng gắn với công ty của bạn.</p>
  </div>
  <a href="/settings/bank-accounts/create"
     class="inline-flex items-center gap-2 h-10 px-4 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 shadow-sm">
    <i class="ri-add-line text-lg"></i> Thêm tài khoản
  </a>
</div>

{# =========================
   Search (optional)
   ========================= #}
<form method="get" class="mb-3">
  <div class="flex items-center gap-2">
    <div class="relative flex-1">
      <i class="ri-search-line absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
      <input
        name="q"
        value="{{ (filters.q if filters else '') }}"
        placeholder="Tìm theo số TK hoặc tên TK..."
        class="w-full h-10 pl-9 pr-3 rounded-xl border border-slate-200 bg-white focus:outline-none focus:ring-2 focus:ring-indigo-200 focus:border-indigo-300 text-sm"
      />
    </div>
    <button
      class="h-10 px-4 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm text-slate-700"
      type="submit"
    >
      Lọc
    </button>
    <a
      href="/settings/bank-accounts"
      class="h-10 px-4 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm text-slate-600 inline-flex items-center"
      title="Xóa bộ lọc"
    >
      Reset
    </a>
  </div>
</form>

<div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
  <table class="min-w-full">
    <thead class="bg-slate-50/70 text-slate-600">
      <tr>
        <th class="text-left text-sm font-medium px-5 py-3 w-72">Ngân hàng</th>
        <th class="text-left text-sm font-medium px-5 py-3 w-56">Số TK</th>
        <th class="text-left text-sm font-medium px-5 py-3">Tên TK</th>
        <th class="text-left text-sm font-medium px-5 py-3 w-32">Trạng thái</th>
        <th class="text-right text-sm font-medium px-5 py-3 w-40">Hành động</th>
      </tr>
    </thead>

    <tbody class="divide-y divide-slate-100">
      {% if page.data and page.data|length > 0 %}
        {% for r in page.data %}
          {% set code = (r.bank_code or '')|upper %}
          {% set name = bank_name_map.get(code, code) %}
          <tr class="hover:bg-slate-50/50">
            <td class="px-5 py-3">
              <div class="flex items-center gap-3">
                {# Prefer bank.logo from r.bank if Service A already packed it #}
                {% if r.bank and r.bank.logo %}
                  <img src="{{ r.bank.logo }}" alt="{{ name }}" class="w-9 h-9 rounded object-contain bg-white border border-slate-200"/>
                {% else %}
                  <i class="ri-bank-line text-slate-400 text-xl"></i>
                {% endif %}

                <div class="min-w-0">
                  <div class="text-slate-800 font-medium leading-5">{{ code }}</div>
                  <div class="text-slate-500 text-sm truncate max-w-[240px]">{{ name }}</div>
                </div>
              </div>
            </td>

            <td class="px-5 py-3">
              <div class="font-mono text-slate-800">{{ r.account_number }}</div>
            </td>

            <td class="px-5 py-3">
              <div class="text-slate-800 truncate max-w-[520px]">
                {{ r.account_name or '' }}
              </div>
            </td>

            <td class="px-5 py-3">
              {% if r.is_active %}
                <span class="inline-flex items-center gap-1.5 px-2.5 h-7 rounded-full bg-emerald-50 text-emerald-700 text-xs font-medium border border-emerald-200">
                  <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span> Active
                </span>
              {% else %}
                <span class="inline-flex items-center gap-1.5 px-2.5 h-7 rounded-full bg-slate-50 text-slate-600 text-xs font-medium border border-slate-200">
                  <span class="w-1.5 h-1.5 rounded-full bg-slate-400"></span> Inactive
                </span>
              {% endif %}
            </td>

            <td class="px-5 py-3">
              <div class="flex items-center justify-end gap-2">
                {# === Sửa === #}
                <a href="/settings/bank-accounts/{{ r.id }}/edit"
                   class="inline-flex items-center justify-center px-3 h-9 rounded-lg border border-slate-300 text-slate-700 text-sm hover:bg-slate-50">
                  Sửa
                </a>

                {# === Xoá: vẫn khoá như yêu cầu hiện tại === #}
                <span
                  class="inline-flex items-center justify-center px-3 h-9 rounded-lg bg-rose-300 text-white text-sm cursor-not-allowed opacity-60"
                  title="Chức năng xoá bị khóa để tránh rủi ro"
                >
                  Xoá
                </span>
              </div>
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="5" class="px-5 py-10 text-center text-slate-500">
            Chưa có tài khoản nào.
          </td>
        </tr>
      {% endif %}
    </tbody>
  </table>

  {# =========================
     Pagination (optional)
     ========================= #}
  {% if page.total and page.size and page.total > page.size %}
    {% set cur = page.page %}
    {% set size = page.size %}
    {% set total = page.total %}
    {% set pages = (total // size) + (1 if (total % size) else 0) %}
    {% set qv = (filters.q if filters and filters.q else '') %}

    <div class="px-5 py-4 border-t border-slate-100 flex items-center justify-between text-sm">
      <div class="text-slate-500">
        Tổng: <b class="text-slate-700">{{ total }}</b> | Trang <b class="text-slate-700">{{ cur }}</b>/<b class="text-slate-700">{{ pages }}</b>
      </div>

      <div class="flex items-center gap-2">
        {% if cur > 1 %}
          <a
            class="h-9 px-3 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 inline-flex items-center"
            href="/settings/bank-accounts?{{ urlencode({'q': qv, 'page': cur-1, 'size': size}) }}"
          >
            <i class="ri-arrow-left-s-line"></i> Trước
          </a>
        {% else %}
          <span class="h-9 px-3 rounded-lg border border-slate-200 bg-white inline-flex items-center text-slate-300 cursor-not-allowed">
            <i class="ri-arrow-left-s-line"></i> Trước
          </span>
        {% endif %}

        {% if cur < pages %}
          <a
            class="h-9 px-3 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 inline-flex items-center"
            href="/settings/bank-accounts?{{ urlencode({'q': qv, 'page': cur+1, 'size': size}) }}"
          >
            Sau <i class="ri-arrow-right-s-line"></i>
          </a>
        {% else %}
          <span class="h-9 px-3 rounded-lg border border-slate-200 bg-white inline-flex items-center text-slate-300 cursor-not-allowed">
            Sau <i class="ri-arrow-right-s-line"></i>
          </span>
        {% endif %}
      </div>
    </div>
  {% endif %}
</div>

{% endblock %}
