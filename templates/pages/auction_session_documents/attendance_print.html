{# templates/pages/auction_session_documents/attendance_print.html #}
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{{ title or "Danh sách điểm danh" }}</title>

  <style>
    /* =========================
       A4 PRINT SETUP
       ========================= */
    @page{
      size: A4;
      margin: 10mm 10mm 12mm 10mm; /* top right bottom left */
    }
    *{ box-sizing: border-box; }
    html, body{
      margin: 0;
      padding: 0;
      color: #111;
      font-family: "Times New Roman", Times, serif;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    /* Screen toolbar (optional) */
    .toolbar{
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
      padding: 10px;
      background: #f6f7f9;
      border-bottom: 1px solid #e5e7eb;
    }
    .btn{
      appearance: none;
      border: 1px solid #111;
      background: #fff;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      border-radius: 6px;
    }
    @media print{
      .toolbar{ display: none !important; }
    }

    /* =========================
       PAGE CONTENT
       ========================= */
    .page{ width: 100%; }

    /* Center national header */
    .top-center{
      text-align: center;
      line-height: 1.15;
      margin-top: 2px;
    }
    .top-center .line1{
      font-weight: 700;
      font-size: 13px;
      text-transform: uppercase;
    }
    .top-center .line2{
      font-size: 12px;
      margin-top: 2px;
    }
    .hr{
      margin: 6px auto 0;
      width: 44%;
      height: 1px;
      background: #111;
    }

    .doc-title{
      margin-top: 10px;
      text-align: center;
      font-weight: 800;
      font-size: 16px;
      text-transform: uppercase;
      letter-spacing: .2px;
    }

    .meta{
      margin-top: 8px;
      font-size: 12px;
      line-height: 1.25;
    }
    .meta-grid{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2px 14px;
    }
    .meta-row{
      display: flex;
      gap: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .meta-row .k{
      font-weight: 700;
      flex: 0 0 auto;
    }
    .meta-row .v{
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .meta-row.full{ grid-column: 1 / -1; }

    /* =========================
       TABLE
       ========================= */
    table{
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      table-layout: fixed;
    }
    thead{ display: table-header-group; }
    th, td{
      border: 1px solid #111;
      padding: 5px 6px;
      vertical-align: top;
      font-size: 11.5px;
      line-height: 1.15;
    }
    th{
      text-align: center;
      font-weight: 800;
      font-size: 11.5px;
      padding: 6px 6px;
    }

    /* Column widths (more room for signature; SL narrower) */
    .col-sbd{  width: 7%;  text-align:center; }
    .col-name{ width: 27%; }
    .col-id{   width: 16%; }
    .col-bank{ width: 26%; }
    .col-qty{  width: 5%;  text-align:center; }
    .col-sign{ width: 19%; }

    /* Force row to be ~3 lines */
    .row3 td{ padding-top: 6px; padding-bottom: 6px; }

    /* Name & address */
    .name{
      font-weight: 800; /* ✅ name bold */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 2px;
    }
    .addr{
      color: #333;
      white-space: normal;      /* allow wrap */
      overflow: hidden;
      word-break: break-word;
      max-height: 2.4em;        /* ~2 lines */
      line-height: 1.2;
    }

    /* CCCD/SDT (values only) */
    .numcell{ font-variant-numeric: tabular-nums; }
    .idval{
      white-space: nowrap;
      overflow: hidden;
      text-overflow: clip;
      letter-spacing: .2px;
    }
    .idval.cccd{ font-weight: 800; }  /* ✅ CCCD bold */
    .idval.phone{ margin-top: 2px; }

    /* Bank (labels NOT bold, values bold where required) */
    .bankline{
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .bankline.wrap{
      white-space: normal;
      max-height: 2.4em;
      line-height: 1.2;
      word-break: break-word;
    }
    .banklbl{ font-weight: 400; }     /* ✅ labels not bold */
    .bankval{ font-weight: 800; }     /* ✅ values bold (STK, CTK; and bank name ok) */
    .bankline .bankval.stk,
    .bankline .bankval.ctk{ font-weight: 800; } /* explicit */

    /* Signature box */
    .signbox{ min-height: 44px; }

    tr{ page-break-inside: avoid; }

    .footnote{
      margin-top: 6px;
      font-size: 11px;
      line-height: 1.2;
    }

    .err{
      margin-top: 10px;
      border: 1px solid #111;
      padding: 8px 10px;
      font-size: 12px;
    }
  </style>
</head>

<body>
  <div class="toolbar">
    <button class="btn" onclick="window.print()">In / Lưu PDF</button>
    <button class="btn" onclick="history.back()">Quay lại</button>
  </div>

  {# =========
     Payload from router:
       - session: dict
       - rows: list
       - attendance: full payload {ok, session, data}
       - error: optional
     ========= #}

  {% set s = session or {} %}
  {% set items = rows or (attendance.data if attendance and attendance.data is defined else []) %}

  {% set stats_total_lots = s.lot_count if s and s.lot_count is defined else 0 %}
  {% set stats_total_customers = s.customer_count if s and s.customer_count is defined else (items|length) %}

  <div class="page">
    <!-- Quốc hiệu (CENTER) -->
    <div class="top-center">
      <div class="line1">CỘNG HOÀ XÃ HỘI CHỦ NGHĨA VIỆT NAM</div>
      <div class="line2">Độc lập - Tự do - Hạnh phúc</div>
      <div class="hr"></div>
    </div>

    <div class="doc-title">DANH SÁCH ĐIỂM DANH THAM DỰ ĐẤU GIÁ</div>

    {% if error %}
      <div class="err">
        <strong>Lỗi tải dữ liệu:</strong> {{ error.message or error.detail or error }}
      </div>
    {% endif %}

    <!-- Meta session -->
    <div class="meta">
      <div class="meta-grid">
        <div class="meta-row full">
          <div class="k">Phiên đấu:</div>
          <div class="v">{{ s.name or ("Phiên #" ~ (s.id or session_id or "")) }}</div>
        </div>

        <div class="meta-row">
          <div class="k">Dự án:</div>
          <div class="v">{{ s.project_name or s.project_code or "" }}</div>
        </div>

        <div class="meta-row">
          <div class="k">Ngày đấu:</div>
          <div class="v">{{ s.auction_date or "" }}</div>
        </div>

        <div class="meta-row">
          <div class="k">Địa điểm:</div>
          <div class="v">{{ s.venue or s.location or "" }}</div>
        </div>

        <div class="meta-row">
          <div class="k">Số lô:</div>
          <div class="v">{{ stats_total_lots or 0 }}</div>
        </div>

        <div class="meta-row">
          <div class="k">Số khách:</div>
          <div class="v">{{ stats_total_customers or 0 }}</div>
        </div>
      </div>

      {% if s.note %}
        <div class="footnote"><span style="font-weight:700;">Ghi chú:</span> {{ s.note }}</div>
      {% endif %}
    </div>

    <!-- Table -->
    <table>
      <thead>
        <tr>
          <th class="col-sbd">SBD</th>
          <th class="col-name">Họ và tên / Địa chỉ</th>
          <th class="col-id">CCCD / SĐT</th>
          <th class="col-bank">TK nhận hoàn (Ngân hàng / Số TK / Chủ TK)</th>
          <th class="col-qty">SL</th>
          <th class="col-sign">Ký nhận<br/><span style="font-weight:400; font-style:italic;">(Ký, ghi rõ họ tên)</span></th>
        </tr>
      </thead>

      <tbody>
        {% for r in items %}
          {% set c = r.customer if r and r.customer is defined else {} %}
          {% set b = r.refund_bank_accounts if r and r.refund_bank_accounts is defined else {} %}

          <tr class="row3">
            <td class="col-sbd">
              <div style="font-weight:800;">{{ r.stt or "" }}</div>
            </td>

            <td class="col-name">
              <div class="name" title="{{ c.customer_full_name or '' }}">{{ c.customer_full_name or "" }}</div>
              <div class="addr" title="{{ c.address or '' }}">{{ c.address or "" }}</div>
            </td>

            <td class="col-id numcell">
              <div class="idval cccd">{{ c.cccd or "" }}</div>
              <div class="idval phone">{{ c.phone or "" }}</div>
            </td>

            <td class="col-bank">
              <div class="bankline wrap" title="{{ (b.bank_shortname or b.bank_name or '') }}">
                <span class="banklbl">NH:</span>
                <span class="bankval">{{ b.bank_shortname or b.bank_name or "" }}</span>
              </div>
              <div class="bankline" title="{{ b.account_number or '' }}">
                <span class="banklbl">STK:</span>
                <span class="bankval stk">{{ b.account_number or "" }}</span>
              </div>
              <div class="bankline" title="{{ b.account_name or '' }}">
                <span class="banklbl">CTK:</span>
                <span class="bankval ctk">{{ b.account_name or "" }}</span>
              </div>
            </td>

            <td class="col-qty">
              <div style="font-weight:800;">{{ r.lot_count or 0 }}</div>
            </td>

            <td class="col-sign">
              <div class="signbox"></div>
            </td>
          </tr>
        {% endfor %}

        {% if not items or (items|length == 0) %}
          <tr>
            <td colspan="6" style="text-align:center; padding: 14px; font-style: italic;">
              Chưa có dữ liệu điểm danh.
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>

    <div class="footnote" style="margin-top:8px;">
      <span style="font-weight:700;">Lưu ý:</span>
      Khách hàng kiểm tra đúng thông tin tài khoản nhận hoàn trước khi ký nhận.
    </div>
  </div>
  <script>
  (function(){
    function shouldAutoPrint(){
      try{
        const sp = new URLSearchParams(location.search);
        return sp.get("autoprint") === "1";
      }catch(e){
        return false;
      }
    }

    function doPrint(){
      try{ window.focus(); }catch(e){}
      try{ window.print(); }catch(e){}
    }

    if(!shouldAutoPrint()) return;

    // Cách ổn định nhất: đợi load xong hẳn
    window.addEventListener("load", function(){
      // delay 1 nhịp để layout/font settle
      setTimeout(doPrint, 250);

      // retry 1 lần (Chrome đôi khi bỏ qua lần đầu)
      setTimeout(doPrint, 900);
    });
  })();
</script>

</body>
</html>
