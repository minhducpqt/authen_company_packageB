{# templates/pages/auction_session_documents/attendance_print.html #}
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{{ title or "Danh sách điểm danh" }}</title>

  <style>
    @page{
      size: A4;
      margin: 10mm 10mm 12mm 10mm;
    }
    *{ box-sizing: border-box; }
    html, body{
      margin: 0;
      padding: 0;
      color: #111;
      font-family: "Times New Roman", Times, serif;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    /* Toolbar (screen) */
    .toolbar{
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
      padding: 10px;
      background: #f6f7f9;
      border-bottom: 1px solid #e5e7eb;
    }
    .btn{
      appearance: none;
      border: 1px solid #111;
      background: #fff;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      border-radius: 6px;
    }
    @media print{ .toolbar{ display:none !important; } }

    /* A4 preview (screen) */
    @media screen{
      body{ background:#e9edf3; }
      .toolbar{
        width: 210mm;
        margin: 10px auto 0;
        border-radius: 10px 10px 0 0;
      }
      .sheet{
        width: 210mm;
        min-height: 297mm;
        margin: 0 auto 28px;
        background: #fff;
        box-shadow: 0 10px 30px rgba(0,0,0,.18);
        border: 1px solid rgba(0,0,0,.12);
      }
      .page{ padding: 10mm 10mm 12mm 10mm; }
    }

    .page{ width:100%; }

    /* National header */
    .top-center{
      text-align: center;
      line-height: 1.15;
      margin-top: 2px;
    }
    .top-center .line1{
      font-weight: 700;
      font-size: 13px;
      text-transform: uppercase;
    }
    .top-center .line2{
      font-size: 12px;
      margin-top: 2px;
    }
    .hr{
      margin: 6px auto 0;
      width: 44%;
      height: 1px;
      background: #111;
    }

    .doc-title{
      margin-top: 10px;
      text-align: center;
      font-weight: 800;
      font-size: 16px;
      text-transform: uppercase;
      letter-spacing: .2px;
    }

    /* Meta (slightly larger) */
    .meta{
      margin-top: 9px;
      font-size: 13px;
      line-height: 1.3;
    }
    .meta-grid{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px 14px;
    }
    .meta-row{
      display: flex;
      gap: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      align-items: baseline;
    }
    .meta-row .k{
      font-weight: 700;
      flex: 0 0 auto;
    }
    .meta-row .v{
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .meta-row.full{ grid-column: 1 / -1; }

    /* ✅ Dự án: viết ngay sau nhãn, nhưng vẫn cho phép wrap nhiều dòng */
    .meta-row.project{
      grid-column: 1 / -1;
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
    }
    .meta-row.project .v{
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
      word-break: break-word;
      line-height: 1.3;
    }

    /* Table */
    table{
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      table-layout: fixed;
    }
    thead{ display: table-header-group; }
    th, td{
      border: 1px solid #111;
      padding: 6px 7px;
      vertical-align: top;
      font-size: 12.5px;
      line-height: 1.2;
    }
    th{
      text-align: center;
      font-weight: 800;
      font-size: 12.5px;
      padding: 7px 7px;
    }

    /* Columns (no SL) */
    .col-sbd{  width: 7%;  text-align:center; }
    .col-name{ width: 27%; }
    .col-id{   width: 16%; }
    .col-bank{ width: 28.5%; }
    .col-sign{ width: 21.5%; }

    .row3 td{ padding-top: 7px; padding-bottom: 7px; }

    .name{
      font-weight: 800;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 3px;
    }
    .addr{
      color: #333;
      white-space: normal;
      overflow: hidden;
      word-break: break-word;
      max-height: 2.6em;
      line-height: 1.25;
    }

    .numcell{ font-variant-numeric: tabular-nums; }
    .idval{
      white-space: nowrap;
      overflow: hidden;
      text-overflow: clip;
      letter-spacing: .2px;
    }
    .idval.cccd{ font-weight: 800; }
    .idval.phone{ margin-top: 3px; }

    .bankline{
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .bankline.wrap{
      white-space: normal;
      max-height: 2.6em;
      line-height: 1.25;
      word-break: break-word;
    }
    .banklbl{ font-weight: 400; }
    .bankval{ font-weight: 800; }
    .bankline .bankval.stk,
    .bankline .bankval.ctk{ font-weight: 800; }

    .signbox{ min-height: 46px; }

    tr{ page-break-inside: avoid; }

    .footnote{
      margin-top: 8px;
      font-size: 12px;
      line-height: 1.25;
    }

    .err{
      margin-top: 10px;
      border: 1px solid #111;
      padding: 8px 10px;
      font-size: 12px;
    }

    /* ✅ ONLY CHANGE: Zebra background for consecutive rows (white/gray alternating) */
    tbody tr.row3:nth-child(odd) td{ background: #fff; }
    tbody tr.row3:nth-child(even) td{ background: #f4f6f9; } /* very light gray for print */

    /* Print safety: preserve zebra colors */
    @media print{
      tbody tr.row3:nth-child(odd) td{ background:#fff !important; }
      tbody tr.row3:nth-child(even) td{ background:#f4f6f9 !important; }
    }
  </style>
</head>

<body>
  <div class="toolbar">
    <button class="btn" onclick="window.print()">In / Lưu PDF</button>
    <button class="btn" onclick="history.back()">Quay lại</button>
  </div>

  {% set s = session or {} %}
  {% set items = rows or (attendance.data if attendance and attendance.data is defined else []) %}

  <div class="sheet">
    <div class="page">
      <div class="top-center">
        <div class="line1">CỘNG HOÀ XÃ HỘI CHỦ NGHĨA VIỆT NAM</div>
        <div class="line2">Độc lập - Tự do - Hạnh phúc</div>
        <div class="hr"></div>
      </div>

      <div class="doc-title">DANH SÁCH ĐIỂM DANH THAM DỰ ĐẤU GIÁ</div>

      {% if error %}
        <div class="err">
          <strong>Lỗi tải dữ liệu:</strong> {{ error.message or error.detail or error }}
        </div>
      {% endif %}

      <div class="meta">
        <div class="meta-grid">
          <div class="meta-row full">
            <div class="k">Phiên đấu:</div>
            <div class="v">{{ s.name or ("Phiên #" ~ (s.id or session_id or "")) }}</div>
          </div>

          <div class="meta-row project">
            <span class="k">Dự án:</span>
            <span class="v">{{ s.project_name or s.project_code or "" }}</span>
          </div>

          {# ✅ Ngày đấu trước, Địa điểm ngay sau ngày đấu (cùng hàng 2 cột) #}
          <div class="meta-row">
            <div class="k">Ngày đấu:</div>
            <div class="v">
              {% set _ad = (s.auction_date or '')|string %}
              {% if _ad and (_ad|length) >= 10 and ('-' in _ad) %}
                {{ _ad[8:10] }}/{{ _ad[5:7] }}/{{ _ad[0:4] }}
              {% else %}
                {{ s.auction_date or "" }}
              {% endif %}
            </div>
          </div>

          <div class="meta-row">
            <div class="k">Địa điểm:</div>
            <div class="v">{{ s.venue or s.location or "" }}</div>
          </div>
        </div>

        {# ✅ Không hiển thị ghi chú #}
      </div>

      <table>
        <thead>
          <tr>
            <th class="col-sbd">STT</th>
            <th class="col-name">Họ và tên / Địa chỉ</th>
            <th class="col-id">CCCD / SĐT</th>
            <th class="col-bank">TK nhận hoàn (Ngân hàng / Số TK / Chủ TK)</th>
            <th class="col-sign">Ký nhận<br/><span style="font-weight:400; font-style:italic;">(Ký, ghi rõ họ tên)</span></th>
          </tr>
        </thead>

        <tbody>
          {% for r in items %}
            {% set c = r.customer if r and r.customer is defined else {} %}
            {% set b = r.refund_bank_accounts if r and r.refund_bank_accounts is defined else {} %}

            <tr class="row3">
              <td class="col-sbd">
                <div style="font-weight:800;">{{ r.stt or "" }}</div>
              </td>

              <td class="col-name">
                <div class="name" title="{{ c.customer_full_name or '' }}">{{ c.customer_full_name or "" }}</div>
                <div class="addr" title="{{ c.address or '' }}">{{ c.address or "" }}</div>
              </td>

              <td class="col-id numcell">
                <div class="idval cccd">{{ c.cccd or "" }}</div>
                <div class="idval phone">{{ c.phone or "" }}</div>
              </td>

              <td class="col-bank">
                <div class="bankline wrap" title="{{ (b.bank_shortname or b.bank_name or '') }}">
                  <span class="banklbl">NH:</span>
                  <span class="bankval">{{ b.bank_shortname or b.bank_name or "" }}</span>
                </div>
                <div class="bankline" title="{{ b.account_number or '' }}">
                  <span class="banklbl">STK:</span>
                  <span class="bankval stk">{{ b.account_number or "" }}</span>
                </div>
                <div class="bankline" title="{{ b.account_name or '' }}">
                  <span class="banklbl">CTK:</span>
                  <span class="bankval ctk">{{ b.account_name or "" }}</span>
                </div>
              </td>

              <td class="col-sign">
                <div class="signbox"></div>
              </td>
            </tr>
          {% endfor %}

          {% if not items or (items|length == 0) %}
            <tr>
              <td colspan="5" style="text-align:center; padding: 14px; font-style: italic;">
                Chưa có dữ liệu điểm danh.
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>

      <div class="footnote" style="margin-top:8px;">
        <span style="font-weight:700;">Lưu ý:</span>
        Khách hàng kiểm tra đúng thông tin tài khoản nhận hoàn trước khi ký nhận.
      </div>
    </div>
  </div>

  <script>
  (function(){
    function shouldAutoPrint(){
      try{
        const sp = new URLSearchParams(location.search);
        return sp.get("autoprint") === "1";
      }catch(e){
        return false;
      }
    }

    if(!shouldAutoPrint()) return;

    const key = "attendance_autoprint_done:" + location.pathname + location.search;
    if(sessionStorage.getItem(key) === "1") return;
    sessionStorage.setItem(key, "1");

    window.addEventListener("load", function(){
      setTimeout(function(){
        try{ window.focus(); }catch(e){}
        try{ window.print(); }catch(e){}
      }, 150);
    });
  })();
  </script>
</body>
</html>
