{# templates/pages/auction_session_documents/attendance_public_notice.html #}
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{{ title or "Danh sách STT tham dự đấu giá" }}</title>

  <style>
    @page{
      size: A4;
      margin: 10mm 10mm 12mm 10mm;
    }
    *{ box-sizing: border-box; }
    html, body{
      margin: 0;
      padding: 0;
      color: #111;
      font-family: "Times New Roman", Times, serif;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    /* Toolbar (screen) */
    .toolbar{
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
      padding: 10px;
      background: #f6f7f9;
      border-bottom: 1px solid #e5e7eb;
    }
    .btn{
      appearance: none;
      border: 1px solid #111;
      background: #fff;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      border-radius: 6px;
    }
    @media print{ .toolbar{ display:none !important; } }

    /* A4 preview (screen) */
    @media screen{
      body{ background:#e9edf3; }
      .toolbar{
        width: 210mm;
        margin: 10px auto 0;
        border-radius: 10px 10px 0 0;
      }
      .sheet{
        width: 210mm;
        min-height: 297mm;
        margin: 0 auto 28px;
        background: #fff;
        box-shadow: 0 10px 30px rgba(0,0,0,.18);
        border: 1px solid rgba(0,0,0,.12);
      }
      .page{ padding: 10mm 10mm 12mm 10mm; }
    }

    .page{ width:100%; }

    /* National header */
    .top-center{
      text-align: center;
      line-height: 1.15;
      margin-top: 2px;
    }
    .top-center .line1{
      font-weight: 700;
      font-size: 13px;
      text-transform: uppercase;
    }
    .top-center .line2{
      font-size: 12px;
      margin-top: 2px;
    }
    .hr{
      margin: 6px auto 0;
      width: 44%;
      height: 1px;
      background: #111;
    }

    .doc-title{
      margin-top: 10px;
      text-align: center;
      font-weight: 800;
      font-size: 16px;
      text-transform: uppercase;
      letter-spacing: .2px;
    }
    .subtitle{
      margin-top: 4px;
      text-align: center;
      font-size: 12.5px;
      font-style: italic;
    }

    /* Meta */
    .meta{
      margin-top: 9px;
      font-size: 13px;
      line-height: 1.3;
    }
    .meta-grid{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px 14px;
    }
    .meta-row{
      display: flex;
      gap: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      align-items: baseline;
    }
    .meta-row .k{
      font-weight: 700;
      flex: 0 0 auto;
    }
    .meta-row .v{
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .meta-row.full{ grid-column: 1 / -1; }

    .meta-row.project{
      grid-column: 1 / -1;
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
    }
    .meta-row.project .v{
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
      word-break: break-word;
      line-height: 1.3;
    }

    /* Table */
    table{
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      table-layout: fixed;
    }
    thead{ display: table-header-group; }
    th, td{
      border: 1px solid #111;
      padding: 6px 7px;
      vertical-align: top;
      font-size: 12.5px;
      line-height: 1.2;
    }
    th{
      text-align: center;
      font-weight: 800;
      font-size: 12.5px;
      padding: 7px 7px;
    }

    /* Columns */
    .col-stt{   width: 7%;  text-align:center; }
    .col-hodem{ width: 26%; }
    .col-ten{   width: 14%; }
    .col-yob{   width: 11%; text-align:center; }
    .col-cccd{  width: 20%; }
    .col-sdt{   width: 22%; }

    .row3 td{ padding-top: 7px; padding-bottom: 7px; }
    .numcell{ font-variant-numeric: tabular-nums; }
    .strong{ font-weight: 800; }
    .muted{ color:#333; }

    /* Zebra rows for public board readability */
    tbody tr.row3:nth-child(odd) td{ background: #fff; }
    tbody tr.row3:nth-child(even) td{ background: #f4f6f9; }

    tr{ page-break-inside: avoid; }

    .footnote{
      margin-top: 8px;
      font-size: 12px;
      line-height: 1.25;
    }

    .err{
      margin-top: 10px;
      border: 1px solid #111;
      padding: 8px 10px;
      font-size: 12px;
    }

    @media print{
      tbody tr.row3:nth-child(odd) td{ background:#fff !important; }
      tbody tr.row3:nth-child(even) td{ background:#f4f6f9 !important; }
    }
  </style>
</head>

<body>
  <div class="toolbar">
    <button class="btn" onclick="window.print()">In / Lưu PDF</button>
    <button class="btn" onclick="history.back()">Quay lại</button>
  </div>

  {% set s = session or {} %}
  {% set items = rows or (attendance.data if attendance and attendance.data is defined else []) %}

  {# =========================
     Helpers (Jinja-only)
     ========================= #}
  {% macro mask_num(val) -%}
    {%- set t = (val or '')|string|trim -%}
    {%- if t and (t|length) > 3 -%}
      {{ ('*' * ((t|length) - 3)) ~ t[-3:] }}
    {%- else -%}
      {{ t }}
    {%- endif -%}
  {%- endmacro %}

  {% macro split_name(full) -%}
    {# returns: hodem|||ten #}
    {%- set fn = (full or '')|string|trim -%}
    {%- set parts = fn.split() -%}
    {%- if parts and (parts|length) > 0 -%}
      {%- set ten = parts[-1] -%}
      {%- set hodem = (parts[0:(parts|length-1)]|join(' ')) if (parts|length) > 1 else '' -%}
      {{ hodem }}|||{{ ten }}
    {%- else -%}
      |||
    {%- endif -%}
  {%- endmacro %}

  {% macro yob_from_cccd(cccd) -%}
    {# CCCD 12 số: ký tự thứ 4 (index 3) mã thế kỷ+giới tính; 2 số tiếp theo (index 4-5) là năm sinh (YY) #}
    {%- set t = (cccd or '')|string|trim -%}
    {%- if t and (t|length) >= 6 and t.isdigit() -%}
      {%- set g = t[3] -%}
      {%- set yy = t[4:6] -%}
      {%- set base = 1900 -%}
      {%- if g in ['0','1'] -%}
        {%- set base = 1900 -%}
      {%- elif g in ['2','3'] -%}
        {%- set base = 2000 -%}
      {%- elif g in ['4','5'] -%}
        {%- set base = 2100 -%}
      {%- elif g in ['6','7'] -%}
        {%- set base = 2200 -%}
      {%- elif g in ['8','9'] -%}
        {%- set base = 2300 -%}
      {%- endif -%}
      {{ base + (yy|int) }}
    {%- else -%}
      {{ "" }}
    {%- endif -%}
  {%- endmacro %}

  <div class="sheet">
    <div class="page">
      <div class="top-center">
        <div class="line1">CỘNG HOÀ XÃ HỘI CHỦ NGHĨA VIỆT NAM</div>
        <div class="line2">Độc lập - Tự do - Hạnh phúc</div>
        <div class="hr"></div>
      </div>

      <div class="doc-title">DANH SÁCH STT THAM DỰ ĐẤU GIÁ</div>
      <div class="subtitle">(Danh sách công khai để khách tra cứu STT)</div>

      {% if error %}
        <div class="err">
          <strong>Lỗi tải dữ liệu:</strong> {{ error.message or error.detail or error }}
        </div>
      {% endif %}

      <div class="meta">
        <div class="meta-grid">
          <div class="meta-row full">
            <div class="k">Phiên đấu:</div>
            <div class="v">{{ s.name or ("Phiên #" ~ (s.id or session_id or "")) }}</div>
          </div>

          <div class="meta-row project">
            <span class="k">Dự án:</span>
            <span class="v">{{ s.project_name or s.project_code or "" }}</span>
          </div>

          <div class="meta-row">
            <div class="k">Ngày đấu:</div>
            <div class="v">
              {% set _ad = (s.auction_date or '')|string %}
              {% if _ad and (_ad|length) >= 10 and ('-' in _ad) %}
                {{ _ad[8:10] }}/{{ _ad[5:7] }}/{{ _ad[0:4] }}
              {% else %}
                {{ s.auction_date or "" }}
              {% endif %}
            </div>
          </div>

          <div class="meta-row">
            <div class="k">Địa điểm:</div>
            <div class="v">{{ s.venue or s.location or "" }}</div>
          </div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th class="col-stt">STT</th>
            <th class="col-hodem">Họ đệm</th>
            <th class="col-ten">Tên</th>
            <th class="col-yob">Năm sinh</th>
            <th class="col-cccd">CCCD</th>
            <th class="col-sdt">SĐT</th>
          </tr>
        </thead>

        <tbody>
          {% for r in items %}
            {% set c = r.customer if r and r.customer is defined else {} %}
            {% set full = c.customer_full_name or "" %}
            {% set sn = split_name(full) %}
            {% set hodem = (sn.split('|||')[0] if sn else '') %}
            {% set ten = (sn.split('|||')[1] if sn else '') %}

            <tr class="row3">
              <td class="col-stt"><div class="strong">{{ r.stt or "" }}</div></td>
              <td class="col-hodem"><div class="strong" title="{{ hodem }}">{{ hodem }}</div></td>
              <td class="col-ten"><div class="strong" title="{{ ten }}">{{ ten }}</div></td>
              <td class="col-yob numcell"><div class="strong">{{ yob_from_cccd(c.cccd) }}</div></td>
              <td class="col-cccd numcell"><div class="strong">{{ mask_num(c.cccd) }}</div></td>
              <td class="col-sdt numcell"><div class="strong">{{ mask_num(c.phone) }}</div></td>
            </tr>
          {% endfor %}

          {% if not items or (items|length == 0) %}
            <tr>
              <td colspan="6" style="text-align:center; padding: 14px; font-style: italic;">
                Chưa có dữ liệu.
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>

      <div class="footnote">
        <span style="font-weight:700;">Lưu ý:</span>
        CCCD và SĐT đã được ẩn bớt để bảo mật. Vui lòng đối chiếu tại bàn hướng dẫn nếu cần hỗ trợ.
      </div>
    </div>
  </div>

  <script>
  (function(){
    function shouldAutoPrint(){
      try{
        const sp = new URLSearchParams(location.search);
        return sp.get("autoprint") === "1";
      }catch(e){
        return false;
      }
    }

    if(!shouldAutoPrint()) return;

    const key = "attendance_autoprint_done:" + location.pathname + location.search;
    if(sessionStorage.getItem(key) === "1") return;
    sessionStorage.setItem(key, "1");

    window.addEventListener("load", function(){
      setTimeout(function(){
        try{ window.focus(); }catch(e){}
        try{ window.print(); }catch(e){}
      }, 150);
    });
  })();
  </script>
</body>
</html>
