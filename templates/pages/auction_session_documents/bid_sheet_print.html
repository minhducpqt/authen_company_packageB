<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <title>Phiếu trả giá</title>
  <style>
    @page{
      size: A4;
      margin: 14mm 14mm; /* lề gọn để tiêu ngữ lên cao */
    }

    html, body{
      margin:0;
      padding:0;
      background:#e5e7eb;
      font-family:"Times New Roman", Times, serif;
      font-size:13.5pt; /* tăng chữ toàn trang */
      color:#000;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    .page{
      width:210mm;
      margin:10px auto;
      background:#fff;
      box-shadow:0 0 6px rgba(0,0,0,0.18);
      box-sizing:border-box;
      position:relative;
      page-break-after:always;
      padding:0; /* dùng @page margin */
    }

    @media print{
      html, body{ background:#fff; }
      .page{ margin:0; box-shadow:none; padding:0; }
    }

    .center { text-align:center; }
    .bold { font-weight:700; }

    .title { font-size:20pt; font-weight:900; text-transform:uppercase; }
    .gov   { font-size:16pt; font-weight:900; text-transform:uppercase; }

    .mt-1  { margin-top:2.5mm; }
    .mt-2  { margin-top:3.5mm; }
    .mt-3  { margin-top:5mm; }
    .mb-2  { margin-bottom:3.5mm; }

    .small { font-size:12pt; }
    .note  { font-size:11.2pt; }

    .divider{
      text-align:center;
      margin:1.5mm 0 4mm;
    }

    /* Box mã nhận dạng góc trái trên */
    .flag-box{
      position:absolute;
      top:0mm;
      left:0mm;
      font-size:10pt;
      border:1px solid #444;
      padding:2px 7px;
      line-height:1.18;
      background:#f9fafb;
      text-align:center;
    }
    .flag-lot{
      font-size:17pt;
      font-weight:900;
      line-height:1.02;
      margin-bottom:1px;
      white-space:nowrap;
    }

    .info-table{
      width:100%;
      border-collapse:collapse;
      margin-top:1.6mm;
      margin-bottom:1.6mm;
    }
    .info-table td{
      padding:0.75mm 0;
      vertical-align:top;
    }
    .info-label{
      width:44mm;
      white-space:nowrap;
      font-weight:800;
    }
    .info-sep{ width:4mm; }

    /* =============================
       ✅ CHỈ CHỈNH LINE THEO YÊU CẦU MỚI
       - Giá trả (số): GIỮ NGUYÊN như hiện tại
       - Uỷ quyền: ĐẬM HƠN (dễ nhìn)
       - Giá trả (chữ): ĐẬM HƠN (vì nằm trên nền xám)
       ============================= */
    :root{
      --line-dots: "................................................................................................................................................................................";
      --line-fs: 9.2pt;          /* nhỏ, mịn */
      --line-ls: 0.55mm;         /* mịn */
      --line-num: rgba(0,0,0,0.14);  /* ✅ GIỮ NGUYÊN cho giá trả (số) */
      --line-auth: rgba(0,0,0,0.22); /* ✅ uỷ quyền: đậm hơn */
      --line-text: rgba(0,0,0,0.22); /* ✅ giá trả (chữ): đậm hơn vì nền xám */
    }

    /* Giá bằng chữ: 2 dòng line */
    .line-dotted{
      height:10mm;
      position:relative;
    }
    .line-dotted::before{
      content: var(--line-dots);
      position:absolute;
      left:0;
      right:0;
      bottom:2.1mm;
      font-size:var(--line-fs);
      letter-spacing:var(--line-ls);
      color:var(--line-text); /* ✅ đậm hơn */
      white-space:nowrap;
      overflow:hidden;
      pointer-events:none;
    }
    .line-dotted + .line-dotted{
      margin-top:2.6mm;
    }

    /* Uỷ quyền: dùng line rõ hơn */
    .dotline{
      display:block;
      position:relative;
      height:9mm;
      min-width:45mm;
      line-height:1.55;
    }
    .dotline.long{ min-width:120mm; }
    .dotline::before{
      content: var(--line-dots);
      position:absolute;
      left:0;
      right:0;
      bottom:1.9mm;
      font-size:var(--line-fs);
      letter-spacing:var(--line-ls);
      color:var(--line-auth); /* ✅ dễ nhìn hơn */
      white-space:nowrap;
      overflow:hidden;
      pointer-events:none;
    }

    .signature-block{
      width:60%;
      margin-left:auto;
      text-align:center;
      margin-top:9mm;
      page-break-inside:avoid;
    }

    /* =============================
       BOX GIÁ TRẢ (SỐ + MÃ LÔ + CHỮ TRONG 1 KHUNG)
       ============================= */
    .price-wrap{
      border:1.6pt solid #111;
      background:#f3f4f6;
      border-radius:2.4mm;
      padding:4.2mm 4.2mm;
      box-sizing:border-box;
    }

    .price-grid{
      display:grid;
      grid-template-columns: 42mm 1fr;
      column-gap:4mm;
      row-gap:2.8mm;
      align-items:start;
    }

    .price-k{
      font-weight:900;
      text-transform:uppercase;
      font-size:12.5pt;
      line-height:1.15;
      padding-top:0.6mm;
      white-space:nowrap;
    }

    /* Hàng giá bằng số: chia 70/30 */
    .price-number-row{
      display:grid;
      grid-template-columns: 70% 30%;
      gap:3mm;
      align-items:stretch;
    }

    .price-number-left{
      display:flex;
      align-items:flex-end;
      gap:6mm;
      min-height:12mm;
      padding:1mm 1mm 0.6mm 1mm;
      border:1.2pt solid rgba(0,0,0,0.22);
      background:#fff;
      border-radius:2mm;
      box-sizing:border-box;
    }

    /* ✅ GIỮ NGUYÊN line giá trả (số) như hiện tại (mịn, nhỏ, mờ) */
    .price-number-write{
      flex:1;
      position:relative;
      font-size:22pt;
      font-weight:900;
      letter-spacing:0.15mm;
      line-height:1.05;
      min-height:11mm;
    }
    .price-number-write::before{
      content: var(--line-dots);
      position:absolute;
      left:0;
      right:0;
      bottom:1.05mm;
      font-size:var(--line-fs);
      letter-spacing:var(--line-ls);
      color:var(--line-num); /* ✅ giữ nguyên */
      white-space:nowrap;
      overflow:hidden;
      pointer-events:none;
    }

    .price-unit{
      font-size:13pt;
      font-weight:900;
      white-space:nowrap;
      padding-bottom:1mm;
    }

    /* Ô mã lô (label nhạt + value to đậm) */
    .lot-badge{
      border:1.2pt solid rgba(0,0,0,0.22);
      background:#ffffff;
      border-radius:2mm;
      box-sizing:border-box;
      padding:1.2mm 1mm;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      text-align:center;
      min-height:12mm;
    }
    .lot-badge .lot-label{
      font-size:10.5pt;
      font-weight:600;
      color:rgba(0,0,0,0.55); /* ✅ nhạt */
      letter-spacing:0.2mm;
      text-transform:uppercase;
      line-height:1.05;
      margin-bottom:0.6mm;
    }
    .lot-badge .lot-value{
      font-size:20pt;  /* ✅ to rõ */
      font-weight:900; /* ✅ đậm */
      line-height:1.0;
      white-space:nowrap;
    }

    .price-hint{
      margin-top:1.2mm;
      font-size:10.8pt;
      font-weight:400;
      color:#111;
    }

    /* Giá bằng chữ: 2 dòng "......" mờ */
    .price-text-lines{
      margin-top:0.3mm;
    }

    @media print{
      body { -webkit-print-color-adjust: exact; }
    }
  </style>
</head>
<body>

{% for t in tickets %}
  {% set auction_mode = t.auction_mode or 'PER_LOT' %}
  {% set is_per_sqm = (auction_mode == 'PER_SQM') %}
  {% set unit_label = is_per_sqm and 'VND/m²' or 'VND/lô' %}
  {% set price_unit = unit_label %}
  {% set bid_unit = unit_label %}
  {% set qty_lots = t.customer_lot_count or 1 %}
  {% set lot_short = (t.lot_code or '').replace('-', '.') %}
  {% set stt_code = t.stt_padded or (t.stt or '') %}
  {% set show_price_step = (t.show_price_step if (t.show_price_step is not none) else true) %}

  <div class="page">

    <div class="flag-box">
      <div class="flag-lot">Lô: {{ t.lot_code }}</div>
      {{ stt_code }}-C{{ t.customer_id }}-S{{ qty_lots }}-{{ lot_short }}
    </div>

    <div class="center gov">CỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM</div>
    <div class="center bold">Độc lập – Tự do – Hạnh phúc</div>
    <div class="divider">-----------------o0o-----------------</div>

    <div class="center title">PHIẾU TRẢ GIÁ (VÒNG {{ t.round_no }})</div>

    <div class="mt-2">
      <span class="bold">Tài sản đấu giá:</span>
      Quyền sử dụng đất thuộc dự án
      "<span class="bold">{{ t.project_name }}</span>",
      lô đất số <span class="bold">{{ t.lot_code }}</span>
      {% if t.area_m2 is number %}
        , diện tích <span class="bold">{{ "{:,.2f}".format(t.area_m2|float) }}</span> m².
      {% else %}
        .
      {% endif %}
    </div>

    <div class="mt-2">
      <span class="bold">Kính gửi:</span>
      {{ t.company_name or 'Công ty Đấu giá Hợp danh Kinh Đô' }}
    </div>

    <table class="info-table mt-2">
      <tr><td class="info-label">Khách hàng</td><td class="info-sep">:</td><td>{{ t.customer_full_name }}</td></tr>
      <tr><td class="info-label">Mã khách</td><td class="info-sep">:</td><td>C{{ t.customer_id }}</td></tr>
      <tr><td class="info-label">CCCD</td><td class="info-sep">:</td><td>{{ t.cccd }}</td></tr>
      <tr><td class="info-label">Địa chỉ</td><td class="info-sep">:</td><td>{{ t.address }}</td></tr>
      <tr><td class="info-label">Điện thoại</td><td class="info-sep">:</td><td>{{ t.phone }}</td></tr>
      <tr>
        <td class="info-label">Uỷ quyền</td>
        <td class="info-sep">:</td>
        <td>
          <span class="small">(Chỉ ghi họ tên & CCCD nếu có)</span><br/>
          <span class="dotline long">&nbsp;</span>
        </td>
      </tr>
    </table>

    <div class="mt-2 small" style="text-align: justify;">
      Sau khi nghiên cứu kỹ hồ sơ mời tham gia đấu giá và xem tài sản đấu giá nêu trên,
      tôi quyết định trả giá như sau:
    </div>

    <div class="center bold mt-2">NỘI DUNG TRẢ GIÁ</div>

    <table class="info-table mt-1">
      <tr>
        <td class="info-label">Lô đăng ký</td><td class="info-sep">:</td>
        <td class="bold">{{ t.lot_code }}</td>
      </tr>

      <tr>
        <td class="info-label">Giá khởi điểm ({{ price_unit }})</td>
        <td class="info-sep">:</td>
        <td class="bold">
          {% if t.starting_price_vnd is number %}
            {{ "{:,.0f}".format(t.starting_price_vnd|float) }}
          {% else %}
            0
          {% endif %}
        </td>
      </tr>

      {% if show_price_step %}
      <tr>
        <td class="info-label">Bước giá ({{ bid_unit }})</td>
        <td class="info-sep">:</td>
        <td class="bold">
          {% if t.bid_step_vnd is number %}
            {{ "{:,.0f}".format(t.bid_step_vnd|float) }}
          {% endif %}
        </td>
      </tr>
      {% endif %}
    </table>

    <!-- BOX CHUNG -->
    <div class="mt-2 price-wrap">
      <div class="price-grid">

        <div class="price-k">Giá trả (số)</div>
        <div>
          <div class="price-number-row">
            <!-- 70%: chỗ viết giá -->
            <div class="price-number-left">
              <div class="price-number-write">&nbsp;</div>
              <div class="price-unit">{{ unit_label }}</div>
            </div>

            <!-- 30%: mã lô -->
            <div class="lot-badge">
              <div class="lot-label">Mã lô</div>
              <div class="lot-value">{{ t.lot_code }}</div>
            </div>
          </div>
        </div>

        <div class="price-k">Giá trả (chữ)</div>
        <div class="price-text-lines">
          <div class="line-dotted"></div>
          <div class="line-dotted"></div>
        </div>

      </div>
    </div>

    <div class="mt-2 small" style="text-align: justify;">
      Tôi cam kết hoàn toàn chịu trách nhiệm về mức giá đã trả trên Phiếu trả giá này
      và thực hiện nghiêm túc Quy chế đấu giá tài sản cùng các quy định pháp luật có liên quan.
    </div>

    <div class="mt-2 note">
      <span class="bold">Ghi chú:</span><br/>
      - Phiếu hợp lệ là phiếu phát hành bởi {{ t.company_name or 'Công ty Đấu giá Hợp danh Kinh Đô' }};<br/>
      - Phiếu không rách, nát; điền đầy đủ thông tin;<br/>
      - Nếu sai lệch giữa giá bằng số và bằng chữ, lấy giá bằng chữ.
    </div>

    <div class="signature-block">
      ................................, ngày ...... tháng ...... năm ......<br/><br/>
      <span class="bold">Khách hàng tham gia đấu giá</span><br/>
      <span class="note">(Ký và ghi rõ họ tên)</span>
    </div>

  </div>
{% endfor %}

<script>
  window.addEventListener("load", function () {
    window.print();
  });
</script>

</body>
</html>
