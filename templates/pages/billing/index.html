{% extends "base.html" %}
{% block content %}
<div class="space-y-5">

  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-xl font-semibold text-slate-800">3.3 Billing</h1>
      <p class="text-sm text-slate-500">Theo dõi công nợ và hóa đơn hàng tháng.</p>
    </div>
    <div class="flex gap-2">
      <a href="/billing/invoices"
         class="px-3 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 text-sm">
        <i class="ri-file-list-2-line mr-1"></i> Danh sách hóa đơn
      </a>
      <button id="btnRefresh"
              class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-sm">
        <i class="ri-refresh-line mr-1"></i> Làm mới
      </button>
    </div>
  </div>

  <!-- STATUS -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
    <div class="bg-white border border-slate-200 rounded-xl p-4">
      <div class="text-xs text-slate-500">Trạng thái</div>
      <div id="stStatus" class="text-lg font-semibold text-slate-800 mt-1">—</div>
      <div id="stLockUntil" class="text-xs text-slate-500 mt-1"></div>
    </div>
    <div class="bg-white border border-slate-200 rounded-xl p-4">
      <div class="text-xs text-slate-500">Công nợ hiện tại</div>
      <div id="stOutstanding" class="text-lg font-semibold text-slate-800 mt-1">—</div>
    </div>
    <div class="bg-white border border-slate-200 rounded-xl p-4">
      <div class="text-xs text-slate-500">Hạn gần nhất</div>
      <div id="stNextDue" class="text-lg font-semibold text-slate-800 mt-1">—</div>
    </div>
    <div class="bg-white border border-slate-200 rounded-xl p-4">
      <div class="text-xs text-slate-500">Tháng hóa đơn mới nhất</div>
      <div id="stLatestMonth" class="text-lg font-semibold text-slate-800 mt-1">—</div>
    </div>
  </div>

  <!-- RECENT INVOICES -->
  <div class="bg-white border border-slate-200 rounded-xl overflow-hidden">
    <div class="px-4 py-3 border-b border-slate-100 flex items-center justify-between">
      <div class="font-semibold text-slate-800">Hóa đơn gần đây</div>
      <div id="loading" class="text-xs text-slate-500 hidden">
        <i class="ri-loader-2-line animate-spin mr-1"></i> Đang tải...
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-50 text-slate-600">
          <tr>
            <th class="text-left px-4 py-2">Tháng</th>
            <th class="text-right px-4 py-2">Phí dự án</th>
            <th class="text-right px-4 py-2">Hạ tầng</th>
            <th class="text-right px-4 py-2">Tổng</th>
            <th class="text-right px-4 py-2">Đã trả</th>
            <th class="text-right px-4 py-2">Còn nợ</th>
            <th class="text-left px-4 py-2">Trạng thái</th>
            <th class="text-left px-4 py-2">Hạn</th>
            <th class="text-right px-4 py-2">Chi tiết</th>
          </tr>
        </thead>
        <tbody id="tbody" class="divide-y divide-slate-100"></tbody>
      </table>
    </div>

    <div id="empty" class="p-6 text-center text-slate-500 hidden">
      Chưa có hóa đơn.
    </div>
  </div>
</div>

<script>
  const pad2 = (n) => String(n).padStart(2, '0');

  function fmtDateTime(s) {
    if (!s) return '—';
    const d = new Date(s);
    if (isNaN(d.getTime())) return String(s);
    return `${pad2(d.getDate())}-${pad2(d.getMonth()+1)}-${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }

  function fmtMonth(s) {
    if (!s) return '—';
    const str = String(s);
    const y = str.slice(0, 4);
    const m = str.slice(5, 7);
    if (y && m) return `${m}-${y}`;
    return str;
  }

  const money = (v) => {
    const n = Math.round(Number(v || 0));
    return n.toLocaleString('vi-VN') + ' đ';
  };

  function setLoading(on) {
    document.getElementById('loading')?.classList.toggle('hidden', !on);
  }

  async function fetchJSON(url) {
    const r = await fetch(url, { headers: { "Accept": "application/json" }});
    const j = await r.json().catch(() => ({}));
    if (!r.ok) throw new Error(j?.error || 'error');
    return j;
  }

  function badge(status) {
    const s = String(status || '').toUpperCase();
    if (s === 'PAID') return `<span class="px-2 py-1 rounded-full text-xs bg-emerald-50 text-emerald-700 border border-emerald-200">PAID</span>`;
    if (s === 'PARTIAL') return `<span class="px-2 py-1 rounded-full text-xs bg-amber-50 text-amber-700 border border-amber-200">PARTIAL</span>`;
    return `<span class="px-2 py-1 rounded-full text-xs bg-slate-50 text-slate-700 border border-slate-200">UNPAID</span>`;
  }

  async function loadAll() {
    setLoading(true);
    try {
      const st = await fetchJSON('/billing/status/data');
      document.getElementById('stStatus').textContent = st?.billing_status || '—';
      document.getElementById('stLockUntil').textContent = st?.lock_until ? ('Lock đến: ' + fmtDateTime(st.lock_until)) : '';
      document.getElementById('stOutstanding').textContent = money(st?.current_outstanding || 0);
      document.getElementById('stNextDue').textContent = st?.next_due_date ? fmtDateTime(st.next_due_date) : '—';

      const inv = await fetchJSON('/billing/invoices/data?page=1&size=10');
      const rows = inv?.data || [];
      const tbody = document.getElementById('tbody');
      const empty = document.getElementById('empty');

      tbody.innerHTML = '';
      if (!rows.length) {
        empty.classList.remove('hidden');
        document.getElementById('stLatestMonth').textContent = '—';
      } else {
        empty.classList.add('hidden');
        document.getElementById('stLatestMonth').textContent = fmtMonth(rows[0]?.billing_month);

        for (const r of rows) {
          tbody.insertAdjacentHTML('beforeend', `
            <tr class="hover:bg-slate-50">
              <td class="px-4 py-2 font-medium text-slate-800">${fmtMonth(r.billing_month)}</td>
              <td class="px-4 py-2 text-right">${money(r.total_project_fee)}</td>
              <td class="px-4 py-2 text-right">${money(r.monthly_fixed_fee)}</td>
              <td class="px-4 py-2 text-right font-semibold">${money(r.total_fee_month)}</td>
              <td class="px-4 py-2 text-right">${money(r.amount_paid)}</td>
              <td class="px-4 py-2 text-right">${money(r.amount_outstanding)}</td>
              <td class="px-4 py-2">${badge(r.status)}</td>
              <td class="px-4 py-2">${fmtDateTime(r.due_date)}</td>
              <td class="px-4 py-2 text-right">
                <a class="text-indigo-600 hover:underline"
                   href="/billing/invoices/view/${r.id}">
                   Xem
                </a>
              </td>
            </tr>
          `);
        }
      }
    } catch (e) {
      console.error(e);
      alert('Không tải được dữ liệu billing. Vui lòng thử lại.');
    } finally {
      setLoading(false);
    }
  }

  document.getElementById('btnRefresh')?.addEventListener('click', loadAll);
  loadAll();
</script>
{% endblock %}