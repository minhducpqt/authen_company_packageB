{% extends "base.html" %}
{% block content %}
<div class="space-y-5">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-xl font-semibold text-slate-800">Billing — Công ty (SUPER)</h1>
      <p class="text-sm text-slate-500">Company: <span class="font-semibold">{{ company_code }}</span></p>
    </div>
    <div class="flex gap-2">
      <a href="/billing/admin/companies"
         class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-sm">
        <i class="ri-arrow-left-line mr-1"></i> Quay lại danh sách
      </a>
      <button id="btnRefresh"
              class="px-3 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 text-sm">
        <i class="ri-refresh-line mr-1"></i> Làm mới
      </button>
    </div>
  </div>

  <div class="bg-white border border-slate-200 rounded-xl overflow-hidden">
    <div class="px-4 py-3 border-b border-slate-100 flex items-center justify-between">
      <div class="font-semibold text-slate-800">Hóa đơn</div>
      <div id="loading" class="text-xs text-slate-500 hidden">
        <i class="ri-loader-2-line animate-spin mr-1"></i> Đang tải...
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-50 text-slate-600">
          <tr>
            <th class="text-left px-4 py-2">Tháng</th>
            <th class="text-right px-4 py-2">Tổng</th>
            <th class="text-right px-4 py-2">Đã trả</th>
            <th class="text-right px-4 py-2">Còn nợ</th>
            <th class="text-left px-4 py-2">Trạng thái</th>
            <th class="text-right px-4 py-2">Chi tiết</th>
          </tr>
        </thead>
        <tbody id="tbody" class="divide-y divide-slate-100"></tbody>
      </table>
    </div>

    <div id="empty" class="p-6 text-center text-slate-500 hidden">Không có dữ liệu.</div>
  </div>
</div>

<script>
  const companyCode = {{ company_code | tojson }};
  const pad2 = (n) => String(n).padStart(2, '0');

  function fmtMonth(s) {
    if (!s) return '—';
    const str = String(s);
    const y = str.slice(0, 4);
    const m = str.slice(5, 7);
    if (y && m) return `${m}-${y}`;
    return str;
  }
  const money = (v) => {
    const n = Math.round(Number(v || 0));
    return n.toLocaleString('vi-VN') + ' đ';
  };
  function badge(status) {
    const s = String(status || '').toUpperCase();
    if (s === 'PAID') return `<span class="px-2 py-1 rounded-full text-xs bg-emerald-50 text-emerald-700 border border-emerald-200">PAID</span>`;
    if (s === 'PARTIAL') return `<span class="px-2 py-1 rounded-full text-xs bg-amber-50 text-amber-700 border border-amber-200">PARTIAL</span>`;
    return `<span class="px-2 py-1 rounded-full text-xs bg-slate-50 text-slate-700 border border-slate-200">UNPAID</span>`;
  }
  function setLoading(on) {
    document.getElementById('loading')?.classList.toggle('hidden', !on);
  }
  async function fetchJSON(url) {
    const r = await fetch(url, { headers: { "Accept": "application/json" }});
    const j = await r.json().catch(() => ({}));
    if (!r.ok) throw new Error(j?.error || j?.msg || 'error');
    return j;
  }

  async function load() {
    setLoading(true);
    try {
      const res = await fetchJSON(`/billing/invoices/data?company_code=${encodeURIComponent(companyCode)}&page=1&size=50`);
      const rows = res?.data || [];
      const tbody = document.getElementById('tbody');
      const empty = document.getElementById('empty');
      tbody.innerHTML = '';

      if (!rows.length) {
        empty.classList.remove('hidden');
      } else {
        empty.classList.add('hidden');
        for (const r of rows) {
          tbody.insertAdjacentHTML('beforeend', `
            <tr class="hover:bg-slate-50">
              <td class="px-4 py-2 font-medium text-slate-800">${fmtMonth(r.billing_month)}</td>
              <td class="px-4 py-2 text-right font-semibold">${money(r.total_fee_month)}</td>
              <td class="px-4 py-2 text-right">${money(r.amount_paid)}</td>
              <td class="px-4 py-2 text-right">${money(r.amount_outstanding)}</td>
              <td class="px-4 py-2">${badge(r.status)}</td>
              <td class="px-4 py-2 text-right">
                <a class="text-indigo-600 hover:underline"
                   href="/billing/admin/invoices/view/${r.id}?company_code=${encodeURIComponent(companyCode)}">
                  Xem (SUPER)
                </a>
              </td>
            </tr>
          `);
        }
      }
    } catch (e) {
      console.error(e);
      alert('Không tải được invoices của công ty.');
    } finally {
      setLoading(false);
    }
  }

  document.getElementById('btnRefresh')?.addEventListener('click', load);
  load();
</script>
{% endblock %}