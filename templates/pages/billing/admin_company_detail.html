{% extends "base.html" %}
{% block content %}
<div class="space-y-5">

  <!-- Header -->
  <div class="flex items-start justify-between gap-4">
    <div class="min-w-0">
      <div class="flex items-center gap-2">
        <a href="/billing/admin/companies" class="text-sm text-slate-500 hover:underline">← Quay lại</a>
      </div>
      <h1 class="text-xl font-semibold text-slate-800">
        Billing (SUPER) — Công ty: <span class="text-indigo-700">{{ company_code }}</span>
      </h1>
      <p class="text-sm text-slate-500">Xem công nợ, hóa đơn, giao dịch và thao tác trạng thái billing.</p>
    </div>
    <div class="flex items-center gap-2 shrink-0">
      <button id="btnRefresh" class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm hover:bg-slate-50">
        <i class="ri-refresh-line mr-1"></i> Làm mới
      </button>
    </div>
  </div>

  <!-- Status (FULL WIDTH) -->
  <div class="bg-white border border-slate-200 rounded-xl p-4">
    <div class="flex flex-col lg:flex-row lg:items-start gap-4">
      <div class="flex-1 min-w-0">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-sm text-slate-600">Trạng thái billing</div>
            <div class="mt-1 flex items-center gap-2">
              <div class="text-lg font-semibold text-slate-800" id="statusText">—</div>
              <div id="statusBadge">—</div>
            </div>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-3">
          <div class="bg-slate-50 border border-slate-200 rounded-xl p-3">
            <div class="text-xs text-slate-500">Lock đến</div>
            <div class="mt-1 font-medium text-slate-800" id="lockUntil">—</div>
          </div>
          <div class="bg-slate-50 border border-slate-200 rounded-xl p-3">
            <div class="text-xs text-slate-500">Công nợ hiện tại</div>
            <div class="mt-1 font-semibold text-slate-900" id="currentOutstanding">—</div>
          </div>
          <div class="bg-slate-50 border border-slate-200 rounded-xl p-3">
            <div class="text-xs text-slate-500">Hạn thanh toán</div>
            <div class="mt-1 font-medium text-slate-800" id="nextDueDate">—</div>
          </div>
          <div class="bg-slate-50 border border-slate-200 rounded-xl p-3">
            <div class="text-xs text-slate-500">Cập nhật</div>
            <div class="mt-1 text-slate-600" id="updatedAt">—</div>
          </div>
        </div>
      </div>

      <!-- Patch status -->
      <div class="w-full lg:w-[420px]">
        <div class="bg-white border border-slate-200 rounded-xl p-4">
          <div class="font-semibold text-slate-800">Cập nhật trạng thái</div>
          <div class="mt-3 grid grid-cols-1 gap-2">
            <select id="billingStatusSelect" class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm">
              <option value="">— Không đổi status —</option>
              <option value="RUNNING">RUNNING</option>
              <option value="LOCKED">LOCKED</option>
            </select>
            <input id="lockUntilInput" type="datetime-local"
                   class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm"
                   placeholder="Lock until"/>
            <button id="btnPatchStatus"
                    class="px-3 py-2 rounded-lg bg-indigo-600 text-white text-sm hover:bg-indigo-700">
              Cập nhật trạng thái
            </button>
            <div class="text-xs text-slate-500">
              * Nếu để trống “Lock until” thì hệ thống chỉ đổi status. Định dạng thời gian theo máy.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters + Quick range (FULL WIDTH) -->
  <div class="bg-white border border-slate-200 rounded-xl p-4">
    <div class="flex flex-col lg:flex-row lg:items-end gap-3">
      <div class="flex-1 min-w-0">
        <div class="flex items-center justify-between gap-2">
          <label class="text-sm font-semibold text-slate-800">Bộ lọc</label>
          <div class="text-xs text-slate-500">Chọn nhanh 24 tháng gần nhất (tối thiểu từ 01-2026)</div>
        </div>

        <!-- Quick dropdowns (hide manual inputs) -->
        <div class="mt-3 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-3">
          <div class="xl:col-span-2">
            <label class="text-xs text-slate-500">Từ tháng</label>
            <select id="fromMonthSelect" class="mt-1 w-full px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm"></select>
          </div>
          <div class="xl:col-span-2">
            <label class="text-xs text-slate-500">Đến tháng</label>
            <select id="toMonthSelect" class="mt-1 w-full px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm"></select>
          </div>
        </div>

        <!-- Keep old inputs for API params, but hidden -->
        <input id="fromMonth" value="{{ init_from_month or '' }}" class="hidden" />
        <input id="toMonth" value="{{ init_to_month or '' }}" class="hidden" />
      </div>

      <div class="flex items-center gap-2 shrink-0">
        <button id="btnApplyFilter" class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm hover:bg-slate-50">
          Áp dụng
        </button>
        <button id="btnResetFilter" class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm hover:bg-slate-50">
          Reset
        </button>
      </div>
    </div>
  </div>

  <!-- Invoices (FULL WIDTH) -->
  <div class="bg-slate-50 border border-slate-200 rounded-xl overflow-hidden">
    <div class="px-4 py-3 border-b border-slate-200 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
      <div class="font-semibold text-slate-800">Hóa đơn</div>
      <div class="text-xs text-slate-500" id="invoiceMeta">—</div>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-white text-slate-600">
          <tr>
            <th class="text-left px-4 py-3 whitespace-nowrap">Tháng</th>
            <th class="text-right px-4 py-3 whitespace-nowrap">Phí</th>
            <th class="text-right px-4 py-3 whitespace-nowrap">Đã trả</th>
            <th class="text-right px-4 py-3 whitespace-nowrap">Còn nợ</th>
            <th class="text-right px-4 py-3 whitespace-nowrap">Chi tiết</th>
          </tr>
        </thead>
        <tbody id="invoiceBody" class="divide-y divide-slate-200">
          <tr><td colspan="5" class="px-4 py-6 text-center text-slate-500">Đang tải...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Payments (FULL WIDTH) -->
  <div class="bg-slate-50 border border-slate-200 rounded-xl overflow-hidden">
    <div class="px-4 py-3 border-b border-slate-200 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
      <div class="font-semibold text-slate-800">Giao dịch thanh toán</div>
      <div class="text-xs text-slate-500" id="paymentMeta">—</div>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-white text-slate-600">
          <tr>
            <th class="text-left px-4 py-3 whitespace-nowrap">Paid at</th>
            <th class="text-right px-4 py-3 whitespace-nowrap">Số tiền</th>
            <th class="text-left px-4 py-3 whitespace-nowrap">Invoice</th>
            <th class="text-left px-4 py-3">Ghi chú</th>
          </tr>
        </thead>
        <tbody id="paymentBody" class="divide-y divide-slate-200">
          <tr><td colspan="4" class="px-4 py-6 text-center text-slate-500">Đang tải...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- NOTE: Removed "Ghi nhận thanh toán" block as requested -->

  <div id="toast" class="hidden fixed bottom-6 right-6 z-[120]">
    <div class="bg-slate-900 text-white px-4 py-3 rounded-xl shadow-lg text-sm" id="toastText">—</div>
  </div>

</div>

<script>
(function(){
  const companyCode = "{{ company_code }}";

  const elStatusText = document.getElementById("statusText");
  const elStatusBadge = document.getElementById("statusBadge");
  const elLockUntil = document.getElementById("lockUntil");
  const elOutstanding = document.getElementById("currentOutstanding");
  const elNextDue = document.getElementById("nextDueDate");
  const elUpdatedAt = document.getElementById("updatedAt");

  // hidden inputs (API params)
  const elFrom = document.getElementById("fromMonth");
  const elTo = document.getElementById("toMonth");

  // dropdowns
  const elFromSel = document.getElementById("fromMonthSelect");
  const elToSel = document.getElementById("toMonthSelect");

  function showToast(msg){
    const wrap = document.getElementById("toast");
    const text = document.getElementById("toastText");
    text.textContent = msg;
    wrap.classList.remove("hidden");
    setTimeout(()=>wrap.classList.add("hidden"), 2600);
  }

  function moneyInt(v){
    const n = Math.round(Number(v||0));
    return n.toLocaleString("vi-VN");
  }

  function fmtDateTime(v){
    if(!v) return "";
    const d = new Date(v);
    if(isNaN(d.getTime())) return String(v);
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yyyy = d.getFullYear();
    const hh = String(d.getHours()).padStart(2,'0');
    const mi = String(d.getMinutes()).padStart(2,'0');
    const ss = String(d.getSeconds()).padStart(2,'0');
    return `${dd}-${mm}-${yyyy} ${hh}:${mi}:${ss}`;
  }

  function fmtMonth(v){
    if(!v) return "";
    const d = new Date(v);
    if(isNaN(d.getTime())) return String(v);
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yyyy = d.getFullYear();
    return `${mm}-${yyyy}`;
  }

  function badgeStatus(s){
    const st = String(s||"").toUpperCase();
    if(st === "LOCKED") return `<span class="px-2 py-1 rounded-full text-xs bg-rose-100 text-rose-700">LOCKED</span>`;
    return `<span class="px-2 py-1 rounded-full text-xs bg-emerald-100 text-emerald-700">RUNNING</span>`;
  }

  function monthToValue(y, m){
    // YYYY-MM-01
    const mm = String(m).padStart(2,'0');
    return `${y}-${mm}-01`;
  }

  function monthLabel(y, m){
    const mm = String(m).padStart(2,'0');
    return `${mm}-${y}`;
  }

  function parseMonthValue(v){
    // expects YYYY-MM-01
    const s = String(v||"").trim();
    const m = s.match(/^(\d{4})-(\d{2})-\d{2}$/);
    if(!m) return null;
    return { y: Number(m[1]), mo: Number(m[2]) };
  }

  function getNowYM(){
    const d = new Date();
    return { y: d.getFullYear(), mo: d.getMonth()+1 };
  }

  function ymToIndex(y, mo){ return y*12 + (mo-1); }
  function indexToYM(idx){
    const y = Math.floor(idx/12);
    const mo = (idx % 12) + 1;
    return { y, mo };
  }

  function buildMonthOptions(){
    // rule: 24 months gần nhất, nhưng không sớm hơn 01-2026
    const min = { y: 2026, mo: 1 };
    const now = getNowYM();

    const nowIdx = ymToIndex(now.y, now.mo);
    const minIdx = ymToIndex(min.y, min.mo);
    const startIdx = Math.max(minIdx, nowIdx - 23); // include current month => 24 items

    const opts = [];
    for(let idx = nowIdx; idx >= startIdx; idx--){
      const ym = indexToYM(idx);
      const val = monthToValue(ym.y, ym.mo);
      opts.push({ value: val, label: monthLabel(ym.y, ym.mo) });
    }
    return opts;
  }

  function fillSelectOptions(sel, opts){
    sel.innerHTML = opts.map(o=>`<option value="${o.value}">${o.label}</option>`).join("");
  }

  function clampSelectRange(){
    // ensure from <= to
    const f = elFromSel.value;
    const t = elToSel.value;
    const fm = parseMonthValue(f);
    const tm = parseMonthValue(t);
    if(!fm || !tm) return;

    const fi = ymToIndex(fm.y, fm.mo);
    const ti = ymToIndex(tm.y, tm.mo);
    if(fi > ti){
      // auto move "to" = from
      elToSel.value = f;
    }
  }

  function syncHiddenInputs(){
    elFrom.value = elFromSel.value || "";
    elTo.value = elToSel.value || "";
  }

  function setDefaultFilter(){
    // default: from 01-2026 to current month
    const now = getNowYM();
    const defFrom = "2026-01-01";
    const defTo = monthToValue(now.y, now.mo);

    elFromSel.value = defFrom;
    elToSel.value = defTo;
    clampSelectRange();
    syncHiddenInputs();
  }

  function applyInitFromServerOrDefault(){
    const opts = buildMonthOptions();
    fillSelectOptions(elFromSel, opts);
    fillSelectOptions(elToSel, opts);

    // Prefer server-provided init values if valid & in options
    const initFrom = (elFrom.value || "").trim();
    const initTo = (elTo.value || "").trim();

    const hasFrom = opts.some(o=>o.value === initFrom);
    const hasTo = opts.some(o=>o.value === initTo);

    if(hasFrom) elFromSel.value = initFrom;
    if(hasTo) elToSel.value = initTo;

    if(!hasFrom || !hasTo){
      setDefaultFilter();
    }else{
      clampSelectRange();
      syncHiddenInputs();
    }
  }

  async function loadStatus(){
    const r = await fetch(`/billing/admin/companies/${encodeURIComponent(companyCode)}/status/data`, {
      headers: { "Accept":"application/json" }
    });
    const j = await r.json().catch(()=>({error:"bad_json"}));
    if(!r.ok){
      showToast(`Lỗi status: ${j.msg || j.error || r.status}`);
      return;
    }
    elStatusText.textContent = String(j.billing_status || "RUNNING");
    elStatusBadge.innerHTML = badgeStatus(j.billing_status);
    elLockUntil.textContent = fmtDateTime(j.lock_until) || "—";
    elOutstanding.textContent = moneyInt(j.current_outstanding || 0);
    elNextDue.textContent = fmtDateTime(j.next_due_date) || "—";
    elUpdatedAt.textContent = fmtDateTime(j.updated_at) || "—";
  }

  async function loadInvoices(){
    const params = new URLSearchParams();
    if((elFrom.value||"").trim()) params.set("from_month", elFrom.value.trim());
    if((elTo.value||"").trim()) params.set("to_month", elTo.value.trim());
    params.set("page","1");
    params.set("size","200");

    const r = await fetch(`/billing/admin/companies/${encodeURIComponent(companyCode)}/invoices/data?`+params.toString(), {
      headers: { "Accept":"application/json" }
    });
    const j = await r.json().catch(()=>({error:"bad_json"}));
    const body = document.getElementById("invoiceBody");
    const meta = document.getElementById("invoiceMeta");

    if(!r.ok){
      body.innerHTML = `<tr><td colspan="5" class="px-4 py-6 text-center text-rose-600">Lỗi: ${j.msg||j.error||r.status}</td></tr>`;
      meta.textContent = "—";
      return;
    }

    const rows = (j.data||[]);
    meta.textContent = `Tổng: ${Number(j.total||0).toLocaleString("vi-VN")}`;

    if(rows.length === 0){
      body.innerHTML = `<tr><td colspan="5" class="px-4 py-6 text-center text-slate-500">Không có hóa đơn</td></tr>`;
      return;
    }

    body.innerHTML = rows.map(x=>{
      const invId = x.id;
      const link = `/billing/admin/invoices/view/${invId}?company_code=${encodeURIComponent(companyCode)}`;
      return `
        <tr class="hover:bg-white">
          <td class="px-4 py-3 text-slate-700 whitespace-nowrap">${fmtMonth(x.billing_month)}</td>
          <td class="px-4 py-3 text-right font-semibold text-slate-800 whitespace-nowrap">${moneyInt(x.total_fee_month || 0)}</td>
          <td class="px-4 py-3 text-right text-slate-700 whitespace-nowrap">${moneyInt(x.amount_paid || 0)}</td>
          <td class="px-4 py-3 text-right whitespace-nowrap ${Number(x.amount_outstanding||0)>0 ? 'text-rose-700 font-semibold' : 'text-emerald-700'}">${moneyInt(x.amount_outstanding || 0)}</td>
          <td class="px-4 py-3 text-right whitespace-nowrap">
            <a class="text-indigo-600 hover:underline" href="${link}">Xem</a>
          </td>
        </tr>
      `;
    }).join("");
  }

  async function loadPayments(){
    const params = new URLSearchParams();
    params.set("page","1");
    params.set("size","200");
    const r = await fetch(`/billing/admin/companies/${encodeURIComponent(companyCode)}/payments/data?`+params.toString(), {
      headers: { "Accept":"application/json" }
    });
    const j = await r.json().catch(()=>({error:"bad_json"}));
    const body = document.getElementById("paymentBody");
    const meta = document.getElementById("paymentMeta");

    if(!r.ok){
      body.innerHTML = `<tr><td colspan="4" class="px-4 py-6 text-center text-rose-600">Lỗi: ${j.msg||j.error||r.status}</td></tr>`;
      meta.textContent = "—";
      return;
    }

    const rows = (j.data||[]);
    meta.textContent = `Tổng: ${Number(j.total||0).toLocaleString("vi-VN")}`;

    if(rows.length === 0){
      body.innerHTML = `<tr><td colspan="4" class="px-4 py-6 text-center text-slate-500">Chưa có giao dịch</td></tr>`;
      return;
    }

    body.innerHTML = rows.map(x=>{
      return `
        <tr class="hover:bg-white">
          <td class="px-4 py-3 text-slate-700 whitespace-nowrap">${fmtDateTime(x.paid_at)}</td>
          <td class="px-4 py-3 text-right font-semibold text-slate-800 whitespace-nowrap">${moneyInt(x.amount || 0)}</td>
          <td class="px-4 py-3 text-slate-700 whitespace-nowrap">#${x.invoice_id || ""}</td>
          <td class="px-4 py-3 text-slate-600">${x.note || ""}</td>
        </tr>
      `;
    }).join("");
  }

  async function patchStatus(){
    const billingStatus = (document.getElementById("billingStatusSelect").value||"").trim();
    const lockLocal = (document.getElementById("lockUntilInput").value||"").trim();

    if(!billingStatus && !lockLocal){
      showToast("Không có thay đổi để cập nhật");
      return;
    }

    // datetime-local -> ISO string
    let lockUntil = null;
    if(lockLocal){
      const d = new Date(lockLocal);
      if(!isNaN(d.getTime())) lockUntil = d.toISOString();
      else lockUntil = lockLocal;
    }

    const payload = {};
    if(billingStatus) payload["billing_status"] = billingStatus;
    if(lockLocal) payload["lock_until"] = lockUntil;

    const ok = await window.confirmModal({ title:"Xác nhận", message:"Cập nhật trạng thái billing cho công ty này?" });
    if(!ok) return;

    const r = await fetch(`/billing/admin/status/patch?company_code=${encodeURIComponent(companyCode)}`, {
      method: "POST",
      headers: { "Content-Type":"application/json", "Accept":"application/json" },
      body: JSON.stringify(payload)
    });
    const j = await r.json().catch(()=>({error:"bad_json"}));
    if(!r.ok){
      showToast(`Lỗi: ${j.msg||j.error||r.status}`);
      return;
    }
    showToast("OK: Đã cập nhật");
    await loadStatus();
  }

  async function loadAll(){
    await Promise.all([loadStatus(), loadInvoices(), loadPayments()]);
  }

  // UI events
  elFromSel.addEventListener("change", ()=>{
    clampSelectRange();
    syncHiddenInputs();
  });
  elToSel.addEventListener("change", ()=>{
    clampSelectRange();
    syncHiddenInputs();
  });

  document.getElementById("btnApplyFilter").addEventListener("click", ()=>{
    syncHiddenInputs();
    loadInvoices();
  });

  document.getElementById("btnResetFilter").addEventListener("click", ()=>{
    setDefaultFilter();
    loadInvoices();
  });

  document.getElementById("btnPatchStatus").addEventListener("click", patchStatus);
  document.getElementById("btnRefresh").addEventListener("click", loadAll);

  // init dropdowns + defaults
  applyInitFromServerOrDefault();

  loadAll();
})();
</script>
{% endblock %}