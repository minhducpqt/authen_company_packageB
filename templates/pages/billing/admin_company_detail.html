{% extends "base.html" %}
{% block content %}
<div class="space-y-5">

  <div class="flex items-center justify-between">
    <div>
      <div class="flex items-center gap-2">
        <a href="/billing/admin/companies" class="text-sm text-slate-500 hover:underline">← Quay lại</a>
      </div>
      <h1 class="text-xl font-semibold text-slate-800">
        Billing (SUPER) — Công ty: <span class="text-indigo-700">{{ company_code }}</span>
      </h1>
      <p class="text-sm text-slate-500">Xem công nợ, hóa đơn, giao dịch và thao tác xác nhận thanh toán.</p>
    </div>
    <div class="flex items-center gap-2">
      <button id="btnRefresh" class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm hover:bg-slate-50">
        <i class="ri-refresh-line mr-1"></i> Làm mới
      </button>
    </div>
  </div>

  <!-- Status -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
    <div class="bg-white border border-slate-200 rounded-xl p-4">
      <div class="text-sm text-slate-600 mb-2">Trạng thái billing</div>
      <div class="flex items-center justify-between">
        <div class="text-lg font-semibold" id="statusText">—</div>
        <div id="statusBadge">—</div>
      </div>
      <div class="mt-3 text-sm text-slate-600 space-y-1">
        <div>Lock đến: <span class="font-medium" id="lockUntil">—</span></div>
        <div>Công nợ hiện tại: <span class="font-semibold text-slate-800" id="currentOutstanding">—</span></div>
        <div>Hạn thanh toán: <span class="font-medium" id="nextDueDate">—</span></div>
        <div>Cập nhật: <span class="text-slate-500" id="updatedAt">—</span></div>
      </div>

      <div class="mt-4 pt-4 border-t border-slate-100 space-y-2">
        <div class="grid grid-cols-1 gap-2">
          <select id="billingStatusSelect" class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm">
            <option value="">— Không đổi status —</option>
            <option value="RUNNING">RUNNING</option>
            <option value="LOCKED">LOCKED</option>
          </select>
          <input id="lockUntilInput" type="datetime-local"
                 class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm"
                 placeholder="Lock until"/>
          <button id="btnPatchStatus"
                  class="px-3 py-2 rounded-lg bg-indigo-600 text-white text-sm hover:bg-indigo-700">
            Cập nhật trạng thái
          </button>
          <div class="text-xs text-slate-500">
            * Nếu để trống “Lock until” thì hệ thống chỉ đổi status. Định dạng thời gian theo máy.
          </div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="bg-white border border-slate-200 rounded-xl p-4 lg:col-span-2">
      <div class="flex flex-col md:flex-row md:items-end gap-3">
        <div class="flex-1">
          <label class="text-xs text-slate-500">Từ tháng (YYYY-MM-01)</label>
          <input id="fromMonth" value="{{ init_from_month or '' }}"
                 placeholder="2026-01-01"
                 class="mt-1 w-full px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm"/>
        </div>
        <div class="flex-1">
          <label class="text-xs text-slate-500">Đến tháng (YYYY-MM-01)</label>
          <input id="toMonth" value="{{ init_to_month or '' }}"
                 placeholder="2026-02-01"
                 class="mt-1 w-full px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm"/>
        </div>
        <div class="flex items-center gap-2">
          <button id="btnApplyFilter" class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm hover:bg-slate-50">
            Áp dụng
          </button>
          <button id="btnResetFilter" class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm hover:bg-slate-50">
            Reset
          </button>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Invoices -->
        <div class="bg-slate-50 border border-slate-200 rounded-xl overflow-hidden">
          <div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between">
            <div class="font-semibold text-slate-800">Hóa đơn</div>
            <div class="text-xs text-slate-500" id="invoiceMeta">—</div>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-white text-slate-600">
                <tr>
                  <th class="text-left px-4 py-3">Tháng</th>
                  <th class="text-right px-4 py-3">Phí</th>
                  <th class="text-right px-4 py-3">Đã trả</th>
                  <th class="text-right px-4 py-3">Còn nợ</th>
                  <th class="text-right px-4 py-3">Chi tiết</th>
                </tr>
              </thead>
              <tbody id="invoiceBody" class="divide-y divide-slate-200">
                <tr><td colspan="5" class="px-4 py-6 text-center text-slate-500">Đang tải...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Payments -->
        <div class="bg-slate-50 border border-slate-200 rounded-xl overflow-hidden">
          <div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between">
            <div class="font-semibold text-slate-800">Giao dịch thanh toán</div>
            <div class="text-xs text-slate-500" id="paymentMeta">—</div>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-white text-slate-600">
                <tr>
                  <th class="text-left px-4 py-3">Paid at</th>
                  <th class="text-right px-4 py-3">Số tiền</th>
                  <th class="text-left px-4 py-3">Invoice</th>
                  <th class="text-left px-4 py-3">Ghi chú</th>
                </tr>
              </thead>
              <tbody id="paymentBody" class="divide-y divide-slate-200">
                <tr><td colspan="4" class="px-4 py-6 text-center text-slate-500">Đang tải...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Create payment -->
      <div class="mt-4 bg-white border border-slate-200 rounded-xl p-4">
        <div class="font-semibold text-slate-800 mb-2">Ghi nhận thanh toán</div>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
          <div>
            <label class="text-xs text-slate-500">Invoice ID</label>
            <input id="payInvoiceId" type="number" min="1"
                   class="mt-1 w-full px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm"
                   placeholder="VD: 123"/>
          </div>
          <div>
            <label class="text-xs text-slate-500">Số tiền (VND)</label>
            <input id="payAmount" type="number" min="1"
                   class="mt-1 w-full px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm"
                   placeholder="VD: 5000000"/>
          </div>
          <div>
            <label class="text-xs text-slate-500">Paid at</label>
            <input id="payAt" type="datetime-local"
                   class="mt-1 w-full px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm"/>
          </div>
          <div>
            <label class="text-xs text-slate-500">Ghi chú</label>
            <input id="payNote" type="text"
                   class="mt-1 w-full px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm"
                   placeholder="VD: CK ngày ..."/>
          </div>
        </div>
        <div class="mt-3 flex justify-end">
          <button id="btnCreatePayment"
                  class="px-3 py-2 rounded-lg bg-emerald-600 text-white text-sm hover:bg-emerald-700">
            Tạo giao dịch thanh toán
          </button>
        </div>
      </div>

    </div>
  </div>

  <div id="toast" class="hidden fixed bottom-6 right-6 z-[120]">
    <div class="bg-slate-900 text-white px-4 py-3 rounded-xl shadow-lg text-sm" id="toastText">—</div>
  </div>

</div>

<script>
(function(){
  const companyCode = "{{ company_code }}";

  const elStatusText = document.getElementById("statusText");
  const elStatusBadge = document.getElementById("statusBadge");
  const elLockUntil = document.getElementById("lockUntil");
  const elOutstanding = document.getElementById("currentOutstanding");
  const elNextDue = document.getElementById("nextDueDate");
  const elUpdatedAt = document.getElementById("updatedAt");

  const elFrom = document.getElementById("fromMonth");
  const elTo = document.getElementById("toMonth");

  function showToast(msg){
    const wrap = document.getElementById("toast");
    const text = document.getElementById("toastText");
    text.textContent = msg;
    wrap.classList.remove("hidden");
    setTimeout(()=>wrap.classList.add("hidden"), 2600);
  }

  function moneyInt(v){
    const n = Math.round(Number(v||0));
    return n.toLocaleString("vi-VN");
  }

  function fmtDateTime(v){
    if(!v) return "";
    const d = new Date(v);
    if(isNaN(d.getTime())) return String(v);
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yyyy = d.getFullYear();
    const hh = String(d.getHours()).padStart(2,'0');
    const mi = String(d.getMinutes()).padStart(2,'0');
    const ss = String(d.getSeconds()).padStart(2,'0');
    return `${dd}-${mm}-${yyyy} ${hh}:${mi}:${ss}`;
  }

  function fmtMonth(v){
    if(!v) return "";
    const d = new Date(v);
    if(isNaN(d.getTime())) return String(v);
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yyyy = d.getFullYear();
    return `${mm}-${yyyy}`;
  }

  function badgeStatus(s){
    const st = String(s||"").toUpperCase();
    if(st === "LOCKED") return `<span class="px-2 py-1 rounded-full text-xs bg-rose-100 text-rose-700">LOCKED</span>`;
    return `<span class="px-2 py-1 rounded-full text-xs bg-emerald-100 text-emerald-700">RUNNING</span>`;
  }

  async function loadStatus(){
    const r = await fetch(`/billing/admin/companies/${encodeURIComponent(companyCode)}/status/data`, {
      headers: { "Accept":"application/json" }
    });
    const j = await r.json().catch(()=>({error:"bad_json"}));
    if(!r.ok){
      showToast(`Lỗi status: ${j.msg || j.error || r.status}`);
      return;
    }
    elStatusText.textContent = String(j.billing_status || "RUNNING");
    elStatusBadge.innerHTML = badgeStatus(j.billing_status);
    elLockUntil.textContent = fmtDateTime(j.lock_until) || "—";
    elOutstanding.textContent = moneyInt(j.current_outstanding || 0);
    elNextDue.textContent = fmtDateTime(j.next_due_date) || "—";
    elUpdatedAt.textContent = fmtDateTime(j.updated_at) || "—";
  }

  async function loadInvoices(){
    const params = new URLSearchParams();
    if((elFrom.value||"").trim()) params.set("from_month", elFrom.value.trim());
    if((elTo.value||"").trim()) params.set("to_month", elTo.value.trim());
    params.set("page","1");
    params.set("size","200");

    const r = await fetch(`/billing/admin/companies/${encodeURIComponent(companyCode)}/invoices/data?`+params.toString(), {
      headers: { "Accept":"application/json" }
    });
    const j = await r.json().catch(()=>({error:"bad_json"}));
    const body = document.getElementById("invoiceBody");
    const meta = document.getElementById("invoiceMeta");

    if(!r.ok){
      body.innerHTML = `<tr><td colspan="5" class="px-4 py-6 text-center text-rose-600">Lỗi: ${j.msg||j.error||r.status}</td></tr>`;
      meta.textContent = "—";
      return;
    }

    const rows = (j.data||[]);
    meta.textContent = `Tổng: ${Number(j.total||0).toLocaleString("vi-VN")}`;

    if(rows.length === 0){
      body.innerHTML = `<tr><td colspan="5" class="px-4 py-6 text-center text-slate-500">Không có hóa đơn</td></tr>`;
      return;
    }

    body.innerHTML = rows.map(x=>{
      const invId = x.id;
      const link = `/billing/admin/invoices/view/${invId}?company_code=${encodeURIComponent(companyCode)}`;
      return `
        <tr class="hover:bg-white">
          <td class="px-4 py-3 text-slate-700">${fmtMonth(x.billing_month)}</td>
          <td class="px-4 py-3 text-right font-semibold text-slate-800">${moneyInt(x.total_fee_month || 0)}</td>
          <td class="px-4 py-3 text-right text-slate-700">${moneyInt(x.amount_paid || 0)}</td>
          <td class="px-4 py-3 text-right ${Number(x.amount_outstanding||0)>0 ? 'text-rose-700 font-semibold' : 'text-emerald-700'}">${moneyInt(x.amount_outstanding || 0)}</td>
          <td class="px-4 py-3 text-right">
            <a class="text-indigo-600 hover:underline" href="${link}">Xem</a>
          </td>
        </tr>
      `;
    }).join("");
  }

  async function loadPayments(){
    const params = new URLSearchParams();
    params.set("page","1");
    params.set("size","200");
    const r = await fetch(`/billing/admin/companies/${encodeURIComponent(companyCode)}/payments/data?`+params.toString(), {
      headers: { "Accept":"application/json" }
    });
    const j = await r.json().catch(()=>({error:"bad_json"}));
    const body = document.getElementById("paymentBody");
    const meta = document.getElementById("paymentMeta");

    if(!r.ok){
      body.innerHTML = `<tr><td colspan="4" class="px-4 py-6 text-center text-rose-600">Lỗi: ${j.msg||j.error||r.status}</td></tr>`;
      meta.textContent = "—";
      return;
    }

    const rows = (j.data||[]);
    meta.textContent = `Tổng: ${Number(j.total||0).toLocaleString("vi-VN")}`;

    if(rows.length === 0){
      body.innerHTML = `<tr><td colspan="4" class="px-4 py-6 text-center text-slate-500">Chưa có giao dịch</td></tr>`;
      return;
    }

    body.innerHTML = rows.map(x=>{
      return `
        <tr class="hover:bg-white">
          <td class="px-4 py-3 text-slate-700">${fmtDateTime(x.paid_at)}</td>
          <td class="px-4 py-3 text-right font-semibold text-slate-800">${moneyInt(x.amount || 0)}</td>
          <td class="px-4 py-3 text-slate-700">#${x.invoice_id || ""}</td>
          <td class="px-4 py-3 text-slate-600">${x.note || ""}</td>
        </tr>
      `;
    }).join("");
  }

  async function patchStatus(){
    const billingStatus = (document.getElementById("billingStatusSelect").value||"").trim();
    const lockLocal = (document.getElementById("lockUntilInput").value||"").trim();

    if(!billingStatus && !lockLocal){
      showToast("Không có thay đổi để cập nhật");
      return;
    }

    // datetime-local -> ISO string
    let lockUntil = null;
    if(lockLocal){
      const d = new Date(lockLocal);
      if(!isNaN(d.getTime())) lockUntil = d.toISOString();
      else lockUntil = lockLocal;
    }

    const payload = {};
    if(billingStatus) payload["billing_status"] = billingStatus;
    if(lockLocal) payload["lock_until"] = lockUntil;

    const ok = await window.confirmModal({ title:"Xác nhận", message:"Cập nhật trạng thái billing cho công ty này?" });
    if(!ok) return;

    const r = await fetch(`/billing/admin/status/patch?company_code=${encodeURIComponent(companyCode)}`, {
      method: "POST",
      headers: { "Content-Type":"application/json", "Accept":"application/json" },
      body: JSON.stringify(payload)
    });
    const j = await r.json().catch(()=>({error:"bad_json"}));
    if(!r.ok){
      showToast(`Lỗi: ${j.msg||j.error||r.status}`);
      return;
    }
    showToast("OK: Đã cập nhật");
    await loadStatus();
  }

  async function createPayment(){
    const invoiceId = Number(document.getElementById("payInvoiceId").value || 0);
    const amount = Number(document.getElementById("payAmount").value || 0);
    const payAtLocal = (document.getElementById("payAt").value || "").trim();
    const note = (document.getElementById("payNote").value || "").trim();

    if(invoiceId <= 0){ showToast("Invoice ID không hợp lệ"); return; }
    if(amount <= 0){ showToast("Số tiền phải > 0"); return; }
    if(!payAtLocal){ showToast("Thiếu Paid at"); return; }

    const d = new Date(payAtLocal);
    const paidAt = isNaN(d.getTime()) ? payAtLocal : d.toISOString();

    const payload = {
      company_code: companyCode,
      invoice_id: invoiceId,
      amount: amount,
      paid_at: paidAt,
      note: note || null
    };

    const ok = await window.confirmModal({
      title:"Xác nhận",
      message:`Tạo giao dịch thanh toán cho invoice #${invoiceId} (${moneyInt(amount)} VND)?`
    });
    if(!ok) return;

    const r = await fetch(`/billing/admin/payments/create`, {
      method: "POST",
      headers: { "Content-Type":"application/json", "Accept":"application/json" },
      body: JSON.stringify(payload)
    });
    const j = await r.json().catch(()=>({error:"bad_json"}));
    if(!r.ok){
      showToast(`Lỗi: ${j.msg||j.error||r.status}`);
      return;
    }

    showToast("OK: Đã tạo giao dịch");
    await loadInvoices();
    await loadPayments();
    await loadStatus();
  }

  async function loadAll(){
    await Promise.all([loadStatus(), loadInvoices(), loadPayments()]);
  }

  document.getElementById("btnApplyFilter").addEventListener("click", loadInvoices);
  document.getElementById("btnResetFilter").addEventListener("click", ()=>{
    elFrom.value = "";
    elTo.value = "";
    loadInvoices();
  });

  document.getElementById("btnPatchStatus").addEventListener("click", patchStatus);
  document.getElementById("btnCreatePayment").addEventListener("click", createPayment);
  document.getElementById("btnRefresh").addEventListener("click", loadAll);

  // default paid_at = now
  try{
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth()+1).padStart(2,'0');
    const dd = String(now.getDate()).padStart(2,'0');
    const hh = String(now.getHours()).padStart(2,'0');
    const mi = String(now.getMinutes()).padStart(2,'0');
    document.getElementById("payAt").value = `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
  }catch(e){}

  loadAll();
})();
</script>
{% endblock %}