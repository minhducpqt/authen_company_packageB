{% extends "base.html" %}
{% block content %}
<div class="space-y-5">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-xl font-semibold text-slate-800">3.3 Billing — Chi tiết hóa đơn</h1>
      <p class="text-sm text-slate-500">Invoice ID: <span class="font-semibold">{{ invoice_id }}</span></p>
    </div>
    <div class="flex gap-2">
      <a href="/billing/invoices"
         class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-sm">
        <i class="ri-arrow-left-line mr-1"></i> Danh sách
      </a>
      <button id="btnRefresh"
              class="px-3 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 text-sm">
        <i class="ri-refresh-line mr-1"></i> Làm mới
      </button>
    </div>
  </div>

  <!-- SUMMARY -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
    <div class="bg-white border border-slate-200 rounded-xl p-4">
      <div class="text-xs text-slate-500">Tháng</div>
      <div id="sMonth" class="text-lg font-semibold text-slate-800 mt-1">—</div>
    </div>
    <div class="bg-white border border-slate-200 rounded-xl p-4">
      <div class="text-xs text-slate-500">Tổng phí</div>
      <div id="sTotal" class="text-lg font-semibold text-slate-800 mt-1">—</div>
      <div class="text-xs text-slate-500 mt-1">Hạn: <span id="sDue">—</span></div>
    </div>
    <div class="bg-white border border-slate-200 rounded-xl p-4">
      <div class="text-xs text-slate-500">Đã trả</div>
      <div id="sPaid" class="text-lg font-semibold text-slate-800 mt-1">—</div>
    </div>
    <div class="bg-white border border-slate-200 rounded-xl p-4">
      <div class="text-xs text-slate-500">Còn nợ</div>
      <div id="sOut" class="text-lg font-semibold text-slate-800 mt-1">—</div>
      <div id="sStatus" class="text-xs text-slate-600 mt-2"></div>
    </div>
  </div>

  <!-- PROJECTS -->
  <div class="bg-white border border-slate-200 rounded-xl overflow-hidden">
    <div class="px-4 py-3 border-b border-slate-100 flex items-center justify-between">
      <div class="font-semibold text-slate-800">Chi tiết theo dự án</div>
      <div id="loading1" class="text-xs text-slate-500 hidden">
        <i class="ri-loader-2-line animate-spin mr-1"></i> Đang tải...
      </div>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-50 text-slate-600">
          <tr>
            <th class="text-left px-4 py-2">Dự án</th>
            <th class="text-left px-4 py-2">Ngày đấu giá</th>
            <th class="text-right px-4 py-2">Tiền hồ sơ</th>
            <th class="text-right px-4 py-2">Chênh lệch</th>
            <th class="text-right px-4 py-2">Base</th>
            <th class="text-right px-4 py-2">Final fee</th>
          </tr>
        </thead>
        <tbody id="tbProjects" class="divide-y divide-slate-100"></tbody>
      </table>
    </div>
    <div id="emptyP" class="p-6 text-center text-slate-500 hidden">Không có dòng dự án.</div>
  </div>

  <!-- PAYMENTS -->
  <div class="bg-white border border-slate-200 rounded-xl overflow-hidden">
    <div class="px-4 py-3 border-b border-slate-100 flex items-center justify-between">
      <div class="font-semibold text-slate-800">Thanh toán</div>
      <div id="loading2" class="text-xs text-slate-500 hidden">
        <i class="ri-loader-2-line animate-spin mr-1"></i> Đang tải...
      </div>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-50 text-slate-600">
          <tr>
            <th class="text-left px-4 py-2">Thời gian</th>
            <th class="text-right px-4 py-2">Số tiền</th>
            <th class="text-left px-4 py-2">Ghi chú</th>
          </tr>
        </thead>
        <tbody id="tbPayments" class="divide-y divide-slate-100"></tbody>
      </table>
    </div>
    <div id="emptyPay" class="p-6 text-center text-slate-500 hidden">Chưa có thanh toán.</div>
  </div>
</div>

<script>
  const invoiceId = {{ invoice_id }};
  const pad2 = (n) => String(n).padStart(2, '0');

  function fmtDateTime(s) {
    if (!s) return '—';
    const d = new Date(s);
    if (isNaN(d.getTime())) return String(s);
    return `${pad2(d.getDate())}-${pad2(d.getMonth()+1)}-${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }

  function fmtMonth(s) {
    if (!s) return '—';
    const str = String(s);
    const y = str.slice(0, 4);
    const m = str.slice(5, 7);
    if (y && m) return `${m}-${y}`;
    return str;
  }

  const money = (v) => {
    const n = Math.round(Number(v || 0));
    return n.toLocaleString('vi-VN') + ' đ';
  };

  function setLoading(id, on) { document.getElementById(id)?.classList.toggle('hidden', !on); }

  async function fetchJSON(url) {
    const r = await fetch(url, { headers: { "Accept": "application/json" }});
    const j = await r.json().catch(() => ({}));
    if (!r.ok) throw new Error(j?.error || 'error');
    return j;
  }

  function badge(status) {
    const s = String(status || '').toUpperCase();
    if (s === 'PAID') return `<span class="px-2 py-1 rounded-full text-xs bg-emerald-50 text-emerald-700 border border-emerald-200">PAID</span>`;
    if (s === 'PARTIAL') return `<span class="px-2 py-1 rounded-full text-xs bg-amber-50 text-amber-700 border border-amber-200">PARTIAL</span>`;
    return `<span class="px-2 py-1 rounded-full text-xs bg-slate-50 text-slate-700 border border-slate-200">UNPAID</span>`;
  }

  async function loadAll() {
    setLoading('loading1', true);
    setLoading('loading2', true);

    try {
      const inv = await fetchJSON(`/billing/invoices/${invoiceId}/data`);
      document.getElementById('sMonth').textContent = fmtMonth(inv?.billing_month);
      document.getElementById('sTotal').textContent = money(inv?.total_fee_month);
      document.getElementById('sPaid').textContent  = money(inv?.amount_paid);
      document.getElementById('sOut').textContent   = money(inv?.amount_outstanding);
      document.getElementById('sDue').textContent   = fmtDateTime(inv?.due_date);
      document.getElementById('sStatus').innerHTML  = badge(inv?.status);

      const projects = await fetchJSON(`/billing/invoices/${invoiceId}/projects/data`);
      const rowsP = projects?.data || [];
      const tbP = document.getElementById('tbProjects');
      const emptyP = document.getElementById('emptyP');
      tbP.innerHTML = '';

      if (!rowsP.length) {
        emptyP.classList.remove('hidden');
      } else {
        emptyP.classList.add('hidden');
        for (const r of rowsP) {
          tbP.insertAdjacentHTML('beforeend', `
            <tr class="hover:bg-slate-50">
              <td class="px-4 py-2">
                <div class="font-medium text-slate-800">${r.project_code || ''}</div>
                <div class="text-xs text-slate-500">ID: ${r.project_id}</div>
              </td>
              <td class="px-4 py-2">${r.auction_at ? fmtDateTime(r.auction_at) : '—'}</td>
              <td class="px-4 py-2 text-right">${money(r.total_dossier_amount)}</td>
              <td class="px-4 py-2 text-right">${money(r.total_price_gap_amount)}</td>
              <td class="px-4 py-2 text-right">${money(r.base_value)}</td>
              <td class="px-4 py-2 text-right font-semibold">${money(r.final_fee)}</td>
            </tr>
          `);
        }
      }

      const pays = await fetchJSON(`/billing/payments/data?invoice_id=${invoiceId}&page=1&size=200`);
      const rowsPay = pays?.data || [];
      const tbPay = document.getElementById('tbPayments');
      const emptyPay = document.getElementById('emptyPay');
      tbPay.innerHTML = '';

      if (!rowsPay.length) {
        emptyPay.classList.remove('hidden');
      } else {
        emptyPay.classList.add('hidden');
        for (const r of rowsPay) {
          tbPay.insertAdjacentHTML('beforeend', `
            <tr class="hover:bg-slate-50">
              <td class="px-4 py-2">${r.paid_at ? fmtDateTime(r.paid_at) : '—'}</td>
              <td class="px-4 py-2 text-right font-semibold">${money(r.amount)}</td>
              <td class="px-4 py-2 text-slate-700">${r.note || ''}</td>
            </tr>
          `);
        }
      }
    } catch (e) {
      console.error(e);
      alert('Không tải được dữ liệu invoice.');
    } finally {
      setLoading('loading1', false);
      setLoading('loading2', false);
    }
  }

  document.getElementById('btnRefresh')?.addEventListener('click', loadAll);
  loadAll();
</script>
{% endblock %}